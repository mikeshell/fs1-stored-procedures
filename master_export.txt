USE [KatomDev]
GO
/****** Object:  StoredProcedure [dbo].[InvUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Beau Dierman>
-- Create date: <12/06/10>
-- Description:	<Insert inventory information into ProductInventory table>
-- =============================================
CREATE PROCEDURE [dbo].[InvUpdate]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here


declare @cmd varchar(4000)
select @cmd = 'osql -Q"select mivaProdID, qtyOnHand from products" -o"c:\SqlJobs\prodinv.txt" -w500 -Uwebsite -PW3b5iTe -SFS1\WEBSQL -dKatomDev'
exec master..xp_cmdshell @cmd
 
 END
GO
/****** Object:  StoredProcedure [dbo].[NAVSalesOrderUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[NAVSalesOrderUpdate]
AS
BEGIN
	-- INSERT SALES HEADER TABLE
	TRUNCATE TABLE NAVSalesHeader

	INSERT INTO NAVSalesHeader
	SELECT 
		CASE [Document Type]
			WHEN 0 THEN 'Quote'
			WHEN 1 THEN 'Open Order'
			WHEN 2 THEN 'Open Invoice'
			WHEN 3 THEN 'Open Blanket Order'
		END docType, 
		[No_] orderID, [Sell-to Customer No_] selltoCustomerID, 
		[Name], [Address] [address], [Address 2] address2, [City], [Contact], [Your Reference] reference, 
		[Ship-to Name] shiptoName, [Ship-to Address] shiptoAddress, [Ship-to Address 2] shiptoAddress2, 
		[Ship-to City] shiptoCity, [Ship-to Contact] shiptoContact, [Order Date] orderDT, 
		[Posting Date] postingDT, [Shipment Date] shipmentDT, 
		[Posting Description] postingDesc, [Payment Terms Code] paymentTermsCode, 
		[Due Date] dueDT, [Shipment Method Code] shipmentMethod, [Cust__Item Disc_ Gr_] custDiscGroup, 
		[Salesperson Code] salesperson, [Sell-to Customer Name] selltoCustomerName, 
		[Sell-to Address] selltoAddress, [Sell-to Address 2] selltoAddress2, [Sell-to City] selltoCity, 
		[Sell-to Contact] selltoContact, [ZIP Code] zipcode, [State] states, [Sell-to ZIP Code] selltoZipcode, 
		[Sell-to State] selltoState, [Ship-to ZIP Code] shiptoZipcode, [Ship-to State] shiptoState, 
		[Document Date] documentDT, [Shipping Agent Code] shippingType, [Package Tracking No_] trackingNum, 
		[Tax Area Code] taxAreaCode, [Ship-to UPS Zone] upsZone, [New Customer] newCustomer, 
		[Phone No_] phoneNum, [E-Mail], 
		CASE [Order Medium]
			WHEN 'FAX' THEN 'Fax'
			WHEN 'W' THEN 'Walk-In'
			WHEN 'E' THEN 'Email'
			WHEN 'F' THEN 'Fax'
			WHEN 'P' THEN 'Phone'
			WHEN 'G' THEN 'GSA'
			WHEN 'B' THEN 'Bid'
			WHEN 'I' THEN 'Miva'
			WHEN 'NA' THEN ''
		END orderMedium
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Header] WITH(NOLOCK)
	ORDER BY [Order Date] DESC

	--INSERT SALES LINE TABLE
	TRUNCATE TABLE NAVSalesLine

	INSERT INTO NAVSalesLine
	SELECT 
		CASE [Document Type]
			WHEN 0 THEN 'Quote'
			WHEN 1 THEN 'Open Order'
			WHEN 2 THEN 'Open Invoice'
			WHEN 3 THEN 'Open Blanket Order'
		END docType,
		[Document No_], [Line No_], [Sell-to Customer No_], [No_], 
		[Shipment Date], [Description], [Unit of Measure], 
		[Quantity], [Unit Price], [Unit Cost ($)], [Tax %], 
		[Amount], [Amount Including Tax], [Gross Weight], 
		[Net Weight], [Project Code], [Est_ Freight]
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Line] WITH(NOLOCK)
	ORDER BY [Shipment Date] DESC
END
GO
/****** Object:  StoredProcedure [dbo].[NAVCustomerProfileUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[NAVCustomerProfileUpdate]
AS
BEGIN
	-- INSERT CUSTOMER TABLE
	INSERT INTO NAVCustomer
	SELECT 
		[No_], [Name], [Search Name],  [Address], [Address 2], [City], [Contact], 
		[Phone No_], [Project Code], [Cust__Item Disc_ Gr_], [Blocked], [Last Date Modified], 
		[Fax No_], [ZIP Code], [State], [E-Mail], [Tax Area Code], [Ship-to Name], [Ship-to Address], 
		[Ship-to Address 2], [Ship-to City], [Ship-to Contact], [Ship-to ZIP Code], [Ship-to State], 
		[Search Phone], [Bill-to Name], [Bill-to Address], [Bill-to Address 2], [Bill-to City], 
		[Bill-to State], [Bill-to ZIP Code], getdate()
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Customer] WITH(NOLOCK)
	WHERE DATEDIFF(DAY, [Last Date Modified], GETDATE()) < 31
		  AND [No_] not in (SELECT customerID FROM NVCustomer)

	UPDATE c
	SET c.name = n.[Name], 
		c.searchName = n.[Search Name],
		c.Address = n.[Address],
		c.address2 = n.[Address 2], 
		c.City = n.[City], 
		c.Contact = n.[Contact], 
		c.phoneNum = n.[Phone No_], 
		c.customerOf = n.[Project Code], 
		c.priceStructure = n.[Cust__Item Disc_ Gr_], 
		c.Blocked = n.[Blocked], 
		c.lastModifiedDT = n.[Last Date Modified], 
		c.faxNo = n.[Fax No_], 
		c.zipCode = n.[ZIP Code], 
		c.State = n.[State], 
		c.email = n.[E-Mail],
		c.taxAreaCode = n.[Tax Area Code],
		c.shiptoName = n.[Ship-to Name],
		c.shiptoAddress = n.[Ship-to Address], 
		c.shiptoAddress2 = n.[Ship-to Address 2],
		c.shiptoCity = n.[Ship-to City],
		c.shiptoContact = n.[Ship-to Contact],
		c.shiptoZipcode = n.[Ship-to ZIP Code],
		c.shiptoState = n.[Ship-to State], 
		c.searchPhone = n.[Search Phone],
		c.billtoName = n.[Bill-to Name],
		c.billtoAddress = n.[Bill-to Address],
		c.billtoAddress2 = n.[Bill-to Address 2],
		c.billtoCity = n.[Bill-to City], 
		c.billtoState = n.[Bill-to State],
		c.billtoZipcode  = n.[Bill-to ZIP Code]
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Customer] n WITH(NOLOCK) JOIN NAVCustomer c on n.[No_] = c.customerID
	WHERE DATEDIFF(DAY, [Last Date Modified], GETDATE()) =0
END
GO
/****** Object:  StoredProcedure [dbo].[downloadMIVAtables]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[downloadMIVAtables]
AS
BEGIN

/** Update products - Temporarily here until the full synch is created */
drop table ProductsMIVA
select * into ProductsMIVA from openquery(MYSQL, 'select * from katom_mm5.s01_Products')


-- IMPORTING CATEGOGY'S INFO, RELATED PRODUCT & CUSTOM FIELD FROM MIVA - DAVID LU 02/16/2010
DROP TABLE mivaCategories
SELECT * INTO mivaCategories FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_Categories')
DROP TABLE MIVACatXProd
SELECT * INTO MIVACatXProd FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_CategoryXProduct')
DROP TABLE MIVARelProd
SELECT * INTO MIVARelProd FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_RelatedProducts')
DROP TABLE MivaprodFields
SELECT * INTO MivaprodFields FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_CFM_ProdFields')
DROP TABLE MivaprodFieldsValue
SELECT * INTO MivaprodFieldsValue FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_CFM_ProdValues')
DROP TABLE MIVAVirtualCat
SELECT * INTO MIVAVirtualCat FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_NBVIRTCAT_cats')
DROP TABLE mivaProductExtendedDesc
SELECT * INTO mivaProductExtendedDesc FROM OPENQUERY(MYSQL, 'select * from katom_mm5.ProductExtendedDescription')

DROP TABLE MivaAttributes
SELECT * INTO MivaAttributes FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_Attributes')
DROP TABLE mivaAttributesTemplates
SELECT * INTO mivaAttributesTemplates FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_AttributeTemplates')
DROP TABLE mivaAttributesTemplateOptions
SELECT * INTO mivaAttributesTemplateOptions FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_AttributeTemplateOptions')
DROP TABLE mivaAttributesTemplateAttrs
SELECT * INTO mivaAttributesTemplateAttrs FROM OPENQUERY(MYSQL, 'select * from katom_mm5.s01_AttributeTemplateAttrs')


END
GO
/****** Object:  StoredProcedure [dbo].[InsertGenerator]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROC [dbo].[InsertGenerator]
(@tableName varchar(100)) as

--Declare a cursor to retrieve column specific information for the specified table
DECLARE cursCol CURSOR FAST_FORWARD FOR 
SELECT column_name,data_type FROM information_schema.columns WHERE table_name = @tableName
OPEN cursCol
DECLARE @string nvarchar(3000) --for storing the first half of INSERT statement
DECLARE @stringData nvarchar(3000) --for storing the data (VALUES) related statement
DECLARE @dataType nvarchar(1000) --data types returned for respective columns
SET @string='INSERT '+@tableName+'('
SET @stringData=''

DECLARE @colName nvarchar(50)

FETCH NEXT FROM cursCol INTO @colName,@dataType

IF @@fetch_status<>0
	begin
	print 'Table '+@tableName+' not found, processing skipped.'
	close curscol
	deallocate curscol
	return
END

WHILE @@FETCH_STATUS=0
BEGIN
IF @dataType in ('varchar','char','nchar','nvarchar')
BEGIN
	--SET @stringData=@stringData+'''''''''+isnull('+@colName+','''')+'''''',''+'
	SET @stringData=@stringData+''''+'''+isnull('''''+'''''+'+@colName+'+'''''+''''',''NULL'')+'',''+'
END
ELSE
if @dataType in ('text','ntext') --if the datatype is text or something else 
BEGIN
	SET @stringData=@stringData+'''''''''+isnull(cast('+@colName+' as varchar(2000)),'''')+'''''',''+'
END
ELSE
IF @dataType = 'money' --because money doesn't get converted from varchar implicitly
BEGIN
	SET @stringData=@stringData+'''convert(money,''''''+isnull(cast('+@colName+' as varchar(200)),''0.0000'')+''''''),''+'
END
ELSE 
IF @dataType='datetime'
BEGIN
	--SET @stringData=@stringData+'''convert(datetime,''''''+isnull(cast('+@colName+' as varchar(200)),''0'')+''''''),''+'
	--SELECT 'INSERT Authorizations(StatusDate) VALUES('+'convert(datetime,'+isnull(''''+convert(varchar(200),StatusDate,121)+'''','NULL')+',121),)' FROM Authorizations
	--SET @stringData=@stringData+'''convert(money,''''''+isnull(cast('+@colName+' as varchar(200)),''0.0000'')+''''''),''+'
	SET @stringData=@stringData+'''convert(datetime,'+'''+isnull('''''+'''''+convert(varchar(200),'+@colName+',121)+'''''+''''',''NULL'')+'',121),''+'
  --                             'convert(datetime,'+isnull(''''+convert(varchar(200),StatusDate,121)+'''','NULL')+',121),)' FROM Authorizations
END
ELSE 
IF @dataType='image' 
BEGIN
	SET @stringData=@stringData+'''''''''+isnull(cast(convert(varbinary,'+@colName+') as varchar(6)),''0'')+'''''',''+'
END
ELSE --presuming the data type is int,bit,numeric,decimal 
BEGIN
	--SET @stringData=@stringData+'''''''''+isnull(cast('+@colName+' as varchar(200)),''0'')+'''''',''+'
	--SET @stringData=@stringData+'''convert(datetime,'+'''+isnull('''''+'''''+convert(varchar(200),'+@colName+',121)+'''''+''''',''NULL'')+'',121),''+'
	SET @stringData=@stringData+''''+'''+isnull('''''+'''''+convert(varchar(200),'+@colName+')+'''''+''''',''NULL'')+'',''+'
END

SET @string=@string+@colName+','

FETCH NEXT FROM cursCol INTO @colName,@dataType
END
DECLARE @Query nvarchar(4000)

SET @query ='SELECT '''+substring(@string,0,len(@string)) + ') VALUES(''+ ' + substring(@stringData,0,len(@stringData)-2)+'''+'')'' FROM '+@tableName
exec sp_executesql @query
--select @query

CLOSE cursCol
DEALLOCATE cursCol
GO
/****** Object:  StoredProcedure [dbo].[errorRPT_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[errorRPT_SP]
	@filterBy VARCHAR(50), @orderType varchar(10), @part INT
AS
BEGIN
	DECLARE @startRowIndex INT, @recTT INT, @query VARCHAR(MAX), @queryToAdd VARCHAR(MAX)
	
	SET @query = 'SELECT [Code], ICDiscountGrp priceGroup,
					CASE 
						WHEN [NAME] IS NULL THEN ''X''
						WHEN LEN([NAME]) = 0 THEN ''X''
						ELSE ''''
					END [NAME],
					CASE 
						WHEN [IMAGE] IS NULL THEN ''X''
						WHEN LEN([IMAGE]) = 0 THEN ''X''
						ELSE ''''
					END [IMAGE],
					CASE 
						WHEN [mpn] IS NULL THEN ''X''
						WHEN LEN([mpn]) = 0 THEN ''X''
						ELSE ''''
					END [mpn],
					CASE 
						WHEN [price] IS NULL THEN ''X''
						WHEN LEN([price]) = 0 THEN ''X''
						WHEN [price] = 0 THEN ''X''
						ELSE ''''
					END [price],
					CASE 
						WHEN [listPrice] IS NULL THEN ''X''
						WHEN LEN([listPrice]) = 0 THEN ''X''
						WHEN [listPrice] = 0 THEN ''X''
						ELSE ''''
					END [listPrice],
					CASE 
						WHEN [prodDesc] IS NULL THEN ''X''
						WHEN LEN(CAST([prodDesc] AS VARCHAR(MAX))) = 0 THEN ''X''
						ELSE ''''
					END [prodDesc],
					CASE 
						WHEN [UOM] IS NULL THEN ''X''
						WHEN LEN([UOM]) = 0 THEN ''X''
						ELSE ''''
					END [UOM],
					CASE 
						WHEN [WEIGHT] IS NULL THEN ''X''
						WHEN LEN([WEIGHT]) = 0 THEN ''X''
						WHEN [WEIGHT] = 0 THEN ''X''
						ELSE ''''
					END [WEIGHT],
					CASE 
						WHEN vendorID IS NULL THEN ''X''
						WHEN LEN(vendorID) = 0 THEN ''X''
						ELSE ''''
					END vendorID,
					CASE 
						WHEN ICDiscountGrp IS NULL THEN ''X''
						WHEN LEN(ICDiscountGrp) = 0 THEN ''X''
						ELSE ''''
					END ICDiscountGrp
				FROM products
				WHERE active = 1 AND isweb=1 AND 
					(LEN(ISNULL([IMAGE] , '''')) = 0 OR
						LEN(ISNULL([listPrice] , '''')) = 0 OR
						[listPrice] = 0 OR
						LEN(ISNULL([mpn] , '''')) = 0 OR
						LEN(ISNULL([NAME] , '''')) = 0 OR
						LEN(ISNULL([price] , '''')) = 0 OR
						[price] = 0 OR
						LEN(ISNULL(CAST([prodDesc] AS VARCHAR(MAX)), '''')) = 0 OR
						LEN(ISNULL([UOM] , '''')) = 0 OR
						LEN(ISNULL([WEIGHT] , '''')) = 0 OR
						[WEIGHT] = 0 OR
						LEN(ISNULL(vendorID, '''')) = 0 OR
						LEN(ISNULL(ICDiscountGrp, '''')) = 0) ' +
				CASE @part
					WHEN 1 THEN ''
					ELSE 'AND CHARINDEX(''-PART'', ICDiscountGrp) = 0 '
				END +
				'ORDER BY ' +
				CASE @orderType
					WHEN 1 THEN '[NAME] DESC, code' 
					WHEN 2 THEN '[IMAGE] DESC, code' 
					WHEN 3 THEN '[mpn] DESC, code' 
					WHEN 4 THEN '[price] DESC, code' 
					WHEN 5 THEN '[listprice] DESC, code' 
					WHEN 6 THEN '[prodDesc] DESC, code' 
					WHEN 7 THEN '[UOM] DESC, code' 
					WHEN 8 THEN '[WEIGHT] DESC, code' 
					WHEN 9 THEN 'vendorID DESC, code' 
					WHEN 10 THEN 'ICDiscountGrp DESC, code' 
					ELSE 'code'
				END			
					
	EXEC(@query)
END
GO
/****** Object:  StoredProcedure [dbo].[shippingBill_Rpt]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[shippingBill_Rpt]
	@ups TINYINT, @fb VARCHAR(5), @p SMALLINT, @ot VARCHAR(30)
AS
BEGIN
	DECLARE @sql VARCHAR(MAX)	
	
	IF @p = 0 
	   BEGIN
		SET @p = 31
	   END
	
	SET @sql = 'SELECT upsDT, orderType, 
					CASE orderType
						WHEN ''kt'' THEN ''KaTom Web''
						WHEN ''ph'' THEN ''Phone''
						WHEN ''bb'' THEN ''B&B''
						WHEN ''eb'' THEN ''Ebay''
						WHEN ''fa'' THEN ''Frosty Acres''
						ELSE ''Pilot''
					END orderTypeName,
					COUNT(*) rcCount
				FROM upsBill_RPT
				WHERE DATEDIFF(DAY, [Order Date], GETDATE()) < ' + CAST(@p AS VARCHAR(5)) + '  
						AND orderType in (''' + REPLACE(@ot, ', ', ''', ''') + ''') '
	IF @ups = 1 OR LEN(@fb) > 0
	   BEGIN
		SET @sql = 	@sql + 'AND BilledFromUPS > 0 '
	   END	
	   
	IF @fb = 'a'
	   BEGIN
		SET @sql = 	@sql + 'AND chargedInNAV < estimatedFromWeb '
	   END
	ELSE IF @fb = 'b'
	   BEGIN
		SET @sql = 	@sql + 'AND BilledFromUPS > chargedInNAV '
	   END
	ELSE IF @fb = 'c'
	   BEGIN
		SET @sql = 	@sql + 'AND BilledFromUPS > estimatedFromWeb '
	   END 
	SET @sql = 	@sql + 'GROUP BY upsDT, orderType, 
							CASE orderType
								WHEN ''kt'' THEN ''KaTom Web''
								WHEN ''ph'' THEN ''Phone''
								WHEN ''bb'' THEN ''B&B''
								WHEN ''eb'' THEN ''Ebay''
								WHEN ''fa'' THEN ''Frosty Acres''
								ELSE ''Pilot''
							END
						 ORDER BY 4 DESC; 
						'
	
	
	SET @sql = 	@sql + '
				SELECT * 
				FROM upsBill_RPT
				WHERE DATEDIFF(DAY, [Order Date], GETDATE()) < ' + CAST(@p AS VARCHAR(5)) + ' 
						AND orderType in (''' + REPLACE(@ot, ', ', ''', ''') + ''') '
	
	IF @ups = 1 OR LEN(@fb) > 0
	   BEGIN
		SET @sql = 	@sql + 'AND BilledFromUPS > 0 '
	   END	
	   
	IF @fb = 'a'
	   BEGIN
		SET @sql = 	@sql + 'AND chargedInNAV < estimatedFromWeb '
	   END
	ELSE IF @fb = 'b'
	   BEGIN
		SET @sql = 	@sql + 'AND BilledFromUPS > chargedInNAV '
	   END
	ELSE IF @fb = 'c'
	   BEGIN
		SET @sql = 	@sql + 'AND BilledFromUPS > estimatedFromWeb '
	   END
	
	SET @sql = 	@sql + 'ORDER BY 5 DESC;
					'			
					
	SET @sql = 	@sql + ' 
						SELECT 30 period, orderType, SUM(chargedInNAV) chargedInNAV, SUM(estimatedFromWeb) estimatedFromWeb, SUM(BilledFromUPS) BilledFromUPS
						FROM upsBill_RPT
						WHERE DATEDIFF(day, [Posting Date], GETDATE()) < 31
								AND BilledFromUPS > 0 
						GROUP BY orderType
						UNION
						SELECT 60 period, orderType, SUM(chargedInNAV) chargedInNAV, SUM(estimatedFromWeb) estimatedFromWeb, SUM(BilledFromUPS) BilledFromUPS
						FROM upsBill_RPT
						WHERE DATEDIFF(day, [Posting Date], GETDATE()) BETWEEN 30 AND 60
								AND BilledFromUPS > 0 
						GROUP BY orderType
						UNION
						SELECT 90 period, orderType, SUM(chargedInNAV) chargedInNAV, SUM(estimatedFromWeb) estimatedFromWeb, SUM(BilledFromUPS) BilledFromUPS
						FROM upsBill_RPT
						WHERE DATEDIFF(day, [Posting Date], GETDATE()) BETWEEN 60 AND 90
								AND BilledFromUPS > 0 
						GROUP BY orderType
						ORDER BY orderType, period'
	exec(@sql)
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SQLNotify]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[sp_SQLNotify] 
   @From varchar(100) ,
   @To varchar(100) ,
   @Subject varchar(100)=" ",
   @Body varchar(4000) = "Motley Fool Inc."
/*********************************************************************

This stored procedure takes the above parameters and sends an e-mail. 
All of the mail configurations are hard-coded in the stored procedure. 
Comments are added to the stored procedure where necessary.
Reference to the CDOSYS objects are at the following MSDN Web site:
http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cdosys/html/_cdosys_messaging.asp

***********************************************************************/ 
   AS
   Declare @iMsg int
   Declare @hr int
   Declare @source varchar(255)
   Declare @description varchar(500)
   Declare @output varchar(1000)

--************* Create the CDO.Message Object ************************
   EXEC @hr = sp_OACreate 'CDO.Message', @iMsg OUT

--***************Configuring the Message Object ******************
-- This is to configure a remote SMTP server.
-- http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cdosys/html/_cdosys_schema_configuration_sendusing.asp
   EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/sendusing").Value','2'
-- This is to configure the Server Name or IP address. 
-- Replace MailServerName by the name or IP of your SMTP Server.
   EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields("http://schemas.microsoft.com/cdo/configuration/smtpserver").Value', '63.246.244.9' 

-- Save the configurations to the message object.
   EXEC @hr = sp_OAMethod @iMsg, 'Configuration.Fields.Update', null

-- Set the e-mail parameters.
   EXEC @hr = sp_OASetProperty @iMsg, 'To', @To
   EXEC @hr = sp_OASetProperty @iMsg, 'From', @From
   EXEC @hr = sp_OASetProperty @iMsg, 'Subject', @Subject

-- If you are using HTML e-mail, use 'HTMLBody' instead of 'TextBody'.
   EXEC @hr = sp_OASetProperty @iMsg, 'TextBody', @Body
   EXEC @hr = sp_OAMethod @iMsg, 'Send', NULL

-- Sample error handling.
   IF @hr <>0 
     select @hr
     BEGIN
       EXEC @hr = sp_OAGetErrorInfo NULL, @source OUT, @description OUT
       IF @hr = 0
         BEGIN
           SELECT @output = '  Source: ' + @source
           PRINT  @output
           SELECT @output = '  Description: ' + @description
           PRINT  @output
         END
       ELSE
         BEGIN
           PRINT '  sp_OAGetErrorInfo failed.'
           RETURN
         END
     END

-- Do some error handling after each step if you need to.
-- Clean up the objects created.
   EXEC @hr = sp_OADestroy @iMsg
   
   PRINT 'Mail Sent!'
GO
/****** Object:  StoredProcedure [dbo].[sp_Mail]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create Procedure [dbo].[sp_Mail]
	@SenderName varchar(100),
	@SenderAddress varchar(100),
	@RecipientName varchar(100),
	@RecipientAddress varchar(100),
	@Subject varchar(200),
	@Body varchar(8000),
	@MailServer varchar(100) = 'mail.bnbequip.com'

	AS	
	
	SET nocount on
GO
/****** Object:  StoredProcedure [dbo].[webtolocaldatasynch]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[webtolocaldatasynch]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	--Drop and Copy paypalresponse, orderError, katomCoupon

	drop table orderError
	
	select * 
	into orderError
	from openquery(KRACK, 'select * from orderError')
	
	drop table paypalresponse
	
	select * 
	into paypalresponse
	from openquery(KRACK, 'select * from paypalresponse')

	drop table katomCoupon
	
	select * 
	into katomCoupon
	from openquery(KRACK, 'select * from katomCoupon')

	drop table trueTracker
	
	select * 
	into trueTracker
	from openquery(KRACK, 'select * from trueTracker')

END
GO
/****** Object:  StoredProcedure [dbo].[NAVInvoiceUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[NAVInvoiceUpdate]
AS
BEGIN
	--INSERT MISSING INVOICE 
	INSERT INTO NAVInvoiceHeader
	SELECT
		[No_], [Sell-to Customer No_], 
		[Name], [Address], [City], [Contact],  
		[Ship-to Name], [Ship-to Address], [Ship-to Address 2], [Ship-to City], [Ship-to Contact], 
		[Order Date], [Posting Date], [Shipment Date], 
		[Posting Description], [Payment Terms Code], 
		[Due Date], [Shipment Method Code], 
		[Project Code], [Cust__Item Disc_ Gr_], [Salesperson Code], 
		[Order No_], [No_ Printed], 
		[Sell-to Customer Name], [Sell-to Address], [Sell-to Address 2], [Sell-to City], [Sell-to Contact], 
		[ZIP Code], [State], [Country Code], 
		[Sell-to ZIP Code], [Sell-to State], [Sell-to Country Code], [Ship-to ZIP Code], 
		[Ship-to State], [Document Date], [Shipping Agent Code], [Package Tracking No_],  
		[User ID], [Source Code], [Ship-to UPS Zone], [Phone No_], [Fax No_], [E-Mail]
		[Customer Source], getdate()
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] WITH(NOLOCK)
	WHERE DATEDIFF(DAY, [Order Date], GETDATE()) < 31
			AND [No_] NOT IN (SELECT [InvoiceID] from NAVInvoiceHeader)

	--UPDATE TRACKING INFORMATION
	UPDATE i
	SET i.trackingCode = i2.[Package Tracking No_]
	FROM NAVInvoiceHeader i join fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i2 WITH(NOLOCK)
							on i.invoiceID = i2.[No_]
	WHERE LEN(ISNULL([Package Tracking No_], '')) > 0
			AND i.trackingCode <> i2.[Package Tracking No_]

	-- INSERT INVOICE LINE
	SELECT
		[Document No_] invoiceID, [Line No_] lineID, [Sell-to Customer No_] selltoCustomerID, 
		[Type], [No_] prodID, [Quantity Disc_ Code] qtyDiscCode, [Shipment Date] shipmentDT, 
		[Unit of Measure] uom, [Quantity] qty, [Unit Price] unitPrice, [Unit Cost ($)] unitCost, 
		[Tax %] tax, [Amount] subtotal, [Amount Including Tax] subtotalWithTax, [Gross Weight] grossWeight, 
		[Net Weight] netWeight, [Project Code] porjectCode, [Price Group Code] priceGroupCode, 
		[Drop Shipment] dropship, [Tax Area Code] taxAreaCode, [Tax Base Amount] taxAmount,
		[Quantity Ordered] qtyOrdered, [Quantity Back Ordered] qtyBackOrdered
	INTO #tmp
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] WITH(NOLOCK)
	WHERE DATEDIFF(DAY, [Shipment Date], GETDATE()) < 31
	ORDER BY [Shipment Date] DESC

	DELETE FROM t
	FROM #tmp t join NAVInvoiceLine i on t.invoiceID = i.invoiceID
									  and t.lineID = i.lineID
									  and t.selltoCustomerID = i.selltoCustomerID

	INSERT INTO NAVInvoiceLine
	SELECT * FROM #tmp

	DROP TABLE #tmp
END
GO
/****** Object:  StoredProcedure [dbo].[NAVCreditMemoUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[NAVCreditMemoUpdate]
AS
BEGIN
	--INSERT CREDIT MEMO HEADER
	INSERT INTO NAVCreditMemoHeader
	SELECT
		[No_], [Sell-to Customer No_], [Name], [Address], [Address 2], [City], 
		[Contact], [Your Reference], [Ship-to Code], [Ship-to Name], [Ship-to Address], 
		[Ship-to Address 2], [Ship-to City], [Ship-to Contact], [Posting Date], 
		[Shipment Date], [Posting Description], [Payment Terms Code], [Due Date], 
		[Shipment Method Code], [Project Code], [Invoice Disc_ Code], [Cust__Item Disc_ Gr_],
		[Salesperson Code], [On Hold], [Applies-to Doc_ Type], [Applies-to Doc_ No_], 
		[Sell-to Customer Name], [Sell-to Address], [Sell-to City], [Sell-to Contact], 
		[ZIP Code], [State], [Sell-to ZIP Code], [Sell-to State], [Ship-to ZIP Code], 
		[Ship-to State], [Document Date], [User ID] userID, [Source Code], [Tax Area Code], 
		[Ship-to UPS Zone], [Phone No_], [E-Mail], [Credit Approval Obtained]
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Cr_Memo Header] WITH(NOLOCK)
	WHERE DATEDIFF(DAY, [Document Date], GETDATE()) < 31 
		  AND [No_] NOT IN (SELECT creditMemoID FROM NAVCreditMemoHeader)
	ORDER BY [No_] DESC

	--INSERT CREDIT MEMO LINE
	SELECT
		[Document No_] creditMemoID, [Line No_] lineID, [Sell-to Customer No_] selltoCustoemerID, 
		[Type], [No_] prodID, [Shipment Date] shipmentDT, [Description] prodDesc, [Unit of Measure] uom, 
		[Quantity] qty, [Unit Price] unitPrice, [Unit Cost ($)] unitCost, [Tax %] tax, [Quantity Disc_ %], 
		[Amount] subtotal, [Amount Including Tax] subtotalwithTax, [Gross Weight] grossWeight, 
		[Net Weight] netWeight, [Project Code] projectCode, [Tax Area Code] taxAreaCode,
		[Tax Group Code] taxGroupCode, [Tax Base Amount] taxValue
	INTO #tmp
	FROM fs1.z_SANDBOX.dbo.[B&B Equipment & Supply Inc_$Sales Cr_Memo Line] WITH(NOLOCK)
	WHERE DATEDIFF(DAY, [Shipment Date], GETDATE()) < 31

	DELETE FROM t
	FROM #tmp t JOIN NAVCreditMemoLine c ON t.creditMemoID = c.creditMemoID
										 AND t.lineID = c.lineID 
										 AND t.selltoCustoemerID = c.selltoCustoemerID

	INSERT INTO NAVCreditMemoLine SELECT * FROM #tmp

	DROP TABLE #tmp
END
GO
/****** Object:  StoredProcedure [dbo].[trackingImport_VOLLRATH]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[trackingImport_VOLLRATH]
AS
BEGIN
	UPDATE vollrathtracking
	SET PONumber = LTRIM(REPLACE(PONumber, 'N/CHG:', ''))
	WHERE CHARINDEX('N/CHG:', PONumber) > 0

	UPDATE v
	SET v.katomOrderID = p.[Sales Order No_]
	FROM vollrathtracking v JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p
					ON v.ponumber = p.[No_] COLLATE Latin1_General_CS_AS
	WHERE LEN(ISNULL(trackingno, '')) > 0

	UPDATE v
	SET v.katomOrderID = p.[Sales Order No_]
	FROM vollrathtracking v JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p
					ON v.ponumber = p.[Order No_] COLLATE Latin1_General_CS_AS
	WHERE LEN(ISNULL(trackingno, '')) > 0

	UPDATE f
	SET [PO Number] = v.PONumber
	FROM vollrathtracking v JOIN fedexTracking f ON v.trackingNo = f.[Tracking Number] 	
	WHERE LEN(ISNULL(trackingno, '')) > 0
		AND f.katomorderID IS NULL
		
	INSERT INTO trackinginfo([Tracking Number], [katomOrderID], [carrier], [Ship Date], [Service Type], lastupdateDT, NAVImported, sendToWEB)	
	select trackingNo, katomorderID, carrier, GETDATE()-1, 'GROUND', GETDATE(), 1, 0
	from vollrathtracking
	WHERE LEN(ISNULL(trackingno, '')) > 0
		AND LEN(ISNULL(katomOrderID, '')) > 0
		AND trackingNo NOT IN (SELECT [Tracking Number] FROM trackinginfo)
	
	--UPDATE THE NEW MATCHED FEDEX NUM WITH NAV DATA	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f 
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p 
				ON f.[PO Number]= p.[Order No_] COLLATE Latin1_General_CS_AS
							AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]
	WHERE f.KatomOrderID IS NULL AND LEN(P.[Sales Order No_]) > 0 and toKatom = 0

	UPDATE f
	SET f.KatomOrderID = i.[Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i 
		ON f.[PO Number] = i.[Order No_] COLLATE Latin1_General_CS_AS
				AND LEFT(f.[Zip], 5) = LEFT(i.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
	WHERE f.KatomOrderID IS NULL and toKatom = 0
		
END
GO
/****** Object:  StoredProcedure [dbo].[tracking_Export]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[tracking_Export]
AS
BEGIN

SELECT katomOrderID, ltrim(rtrim([Tracking Number])) [Tracking Number],
    CASE 
        WHEN CHARINDEX('overnight', [Service Type]) > 0 THEN 'OVERNIGHT'
        WHEN [Service Type] = 'FedEx Home Delivery' THEN 'GROUND'
        WHEN [Service Type] = 'FEDEX EXPRESS SAVER' THEN 'EXPRESS'  
        WHEN [Service Type] = 'ROADRUNNER' THEN 'OUR TRUCK'                                                        
        ELSE LTRIM(UPPER(REPLACE([Service Type], 'FEDEX', '')))
    END [SERVICE TYPE], 
    CASE
		WHEN CHARINDEX('FEDEX', [CARRIER]) > 0 THEN 'FXGROUND'
		WHEN CHARINDEX('UPS', [CARRIER]) > 0 THEN 'UPS'
		WHEN CHARINDEX('VOLLRATH % S.E. ', [CARRIER]) > 0 THEN 'SOUTH'
		ELSE [CARRIER]
	END [CARRIER]    
FROM trackinginfo
WHERE NAVimported = 0 AND LEN(ISNULL(katomOrderID, '')) > 0
END
GO
/****** Object:  StoredProcedure [dbo].[SuperSaverUpdate_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[SuperSaverUpdate_SP] 

AS
BEGIN
	
	delete from openquery(MySQL, 'select * from TrueSuperSaver')

	insert openquery(MySQL, 'select MPN, listprice, sellingprice, code, mapprice from TrueSuperSaver')
	select MPN, listprice, sellingprice, code, displayprice from trueSuperTrailer
	
	
		BEGIN

				DECLARE @code varchar(30)
				DECLARE @price varchar(MAX)


				DECLARE trueCursor CURSOR FOR 

						SELECT code, [sellingprice]
						FROM [KatomDev].[dbo].[trueSuperTrailer]
						
				OPEN trueCursor

				FETCH NEXT FROM trueCursor INTO @code, @price
					

					WHILE @@FETCH_STATUS = 0

					BEGIN
					
						update openquery (mysql, 'select price, code from s01_Products')
						set price = @price
						where code = @code

					FETCH NEXT FROM trueCursor INTO @code, @price
					
					END

					CLOSE trueCursor

					DEALLOCATE trueCursor

		END

		---

END
GO
/****** Object:  StoredProcedure [dbo].[trackingNum_w_no_ref]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[trackingNum_w_no_ref]
AS
BEGIN
	
	DECLARE @trackingNum VARCHAR(100), @DT VARCHAR(100)		
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150)

	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>E-Mail</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT TrackingNumber, updatedt 
	FROM UPSTracking 
	WHERE Reference1 IS NULL
		AND DATEDIFF(day, updateDT, GETDATE()) = 1

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @trackingNum, @DT

	WHILE @@FETCH_STATUS = 0
	   BEGIN
				
		SET @body1 = @body1 + @trackingNum + ' (' + @DT + ')<BR />'
				
		FETCH NEXT FROM sCursor INTO @trackingNum, @DT
	   END


	CLOSE sCursor
	DEALLOCATE sCursor
	
	SET @body1 = @body1 + '</table></td></tr></table>'
	
	SET @body1 = @body1 + '	</body>
	</html>'
	
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'charley@katom.com; tamara@katom.com'
	SET @subject1 = 'Tracking Number with no Reference Information'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportBBold]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImportBBold]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdr_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdr
*/

--SELECT * FROM order_hdr_bkp
--DELETE FROM order_hdr_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdr

UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount, selltocountry, selltophone, CustomerPO2)

SELECT * FROM openquery(MYSQL, '
		SELECT  id as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		ship_email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		ship_fax as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		upper(bill_email) as selltoemail,
		left(upper(concat(bill_fname,'' '',bill_lname)),50) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM katom_mm5.s01_OrderCharges where order_id = customerpo
         and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as method,
		(SELECT amount FROM katom_mm5.s01_OrderCharges where order_id = customerpo
		 and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as amount,
		 bill_cntry,
		 bill_phone,
		(select purchaseordernum from cxmlxref where orderid = o.id limit 1) as po2
		FROM katom_mm5.s01_Orders o where batch_id = 2')

  
  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
   
  UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		upsold,
		quantity	
		FROM katom_mm5.s01_OrderItems
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount,
		disp_amt,
		tax_exempt
		FROM katom_mm5.s01_OrderCharges
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM katom_mm5.s01_OrderOptions
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(MYSQL, '
		SELECT order_id,
		charge_id as line_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount
		FROM katom_mm5.s01_OrderCharges
		where module_id in (1001, 186)
		and order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')
	

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 2') 
	SET batch_id = '1';

/*Begins the loop to pull down and parse payment information
	DECLARE @Order varchar(10)
	DECLARE @Country varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo, shiptocountry FROM order_hdr WHERE exported = 0 and shiptocountry <> 'XX'

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @Country

	WHILE @@FETCH_STATUS = 0
	BEGIN
		--exec paymentparse @Order
		
		/* International Order Handling */		
		IF @Country NOT IN ('CA', 'US', 'XX')
			BEGIN
				Update order_hdr
				set shiptocity = (shiptocity+', '+shiptostate),
					shiptostate = shiptocountry,
					selltocity = (selltocity+', '+selltostate),
					selltostate = shiptocountry,
					shiptocountry = 'XX'
				where customerpo = @Order
			
				/*insert into order_items([order_id], [line_id], [product_id], [code],[name], [price], [weight], [taxable], [upsold], [quantity])
				values (@Order, 1, 999999, '', 'INTERNATIONAL ORDER', '0.00', '0', 1, 0, 0)*/
			END
							
		FETCH NEXT FROM DemoCursor INTO @Order, @Country
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor
*/
/*Display the gathered header information*/
SELECT * FROM order_hdr

/*Display the gathered line item information with customer info*/
SELECT * FROM order_hdr
join order_items
ON order_id = customerpo
order by order_id

select name, attr_code, opt_code from order_options o
join order_items i 
on i.order_id = o.order_id and i.line_id = o.line_id

--exec CvcImport

UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)

--Pilot specifications update
update order_hdr
set orderplacedby = 'PI',
paymenttermscode = 'NET 30',
CustomerSource = 'S',
selltoemail = 'NA'
where ccname = 'Pilot'

END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportBB]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[RemoteOrderImportBB]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdr_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdr
*/

--SELECT * FROM order_hdr_bkp
--DELETE FROM order_hdr_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdr

UPDATE OPENQUERY (RDN, 'SELECT * FROM orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount, selltocountry, selltophone, CustomerPO2, pnref, respcode, ccnum, AmountSubmitted)

SELECT * FROM openquery(RDN, '
		SELECT  concat(''BB'',cast(id as char)) as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		(SELECT email FROM customers WHERE cust_id = id
		  LIMIT 1) AS shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		'' '' as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		(SELECT email FROM customers WHERE cust_id = id
		  LIMIT 1) as selltoemail,
		left(upper(concat(bill_fname,'' '',bill_lname)),50) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM orderCharges where order_id = id
         and type = ''SHIPPING'' limit 1) as method,
		(SELECT amount FROM orderCharges where order_id = id
		  limit 1) as amount,
		 bill_cntry,
		 bill_phone,
		 ponumber as po2,
		 /*,
		(select purchaseordernum from cxmlxref where orderid = o.id limit 1) as po2*/
		pay_secdat,
		resp_code,
		card_num as ccnum,
		total
		FROM rdn_mm5.orders o 
		where batch_id = 2')

  update order_hdr
  set paymenttermscode = 'NET 30'
  where customerpo like 'BB%'  and CustomerPO2 is not null
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
   
  UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(RDN, '
		SELECT
		concat(''BB'',cast(order_id as char)) as order_id,
		lineID,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		0 as upsold,
		quantity	
		FROM orderItems
		where order_id in (SELECT id FROM orders where batch_id = 2)')
		


/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(RDN, '
		SELECT
		concat(''BB'',cast(order_id as char)) as order_id,
		0 as charge_id,
		0 as module_id,
		type,
		descrip,
		amount,
		amount as disp_amt,
		tax_exempt
		FROM orderCharges
		where order_id in (SELECT id FROM orders where batch_id = 2)')
		


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(RDN, '
		SELECT
		concat(''BB'',cast(order_id as char)) as order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM orderOptions
		where order_id in (SELECT id FROM orders where batch_id = 2 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(RDN, '
		SELECT concat(''BB'',cast(order_id as char)) as order_id,
		0 as line_id,
		999 as option_id,
		charge_id as attr_id,
		type,
		concat(''Shipping: '',descrip),
		amount
		FROM orderCharges
		where type <> ''TAX'' and order_id in (SELECT id FROM orders where batch_id = 2)')
		
	update order_options
	set option_id = 420
	where opt_code like 'Shipping:%'		

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (RDN, 'SELECT * FROM orders s where batch_id = 2') 
	SET batch_id = '1';

/*Begins the loop to pull down and parse payment information
	DECLARE @Order varchar(10)
	DECLARE @Country varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo, shiptocountry FROM order_hdr WHERE exported = 0 and shiptocountry <> 'XX'

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @Country

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparse @Order
		
		/* International Order Handling */		
		IF @Country NOT IN ('CA', 'US', 'XX')
			BEGIN
				Update order_hdr
				set shiptocity = (shiptocity+', '+shiptostate),
					shiptostate = shiptocountry,
					selltocity = (selltocity+', '+selltostate),
					selltostate = shiptocountry,
					shiptocountry = 'XX'
				where customerpo = @Order
			
				/*insert into order_items([order_id], [line_id], [product_id], [code],[name], [price], [weight], [taxable], [upsold], [quantity])
				values (@Order, 1, 999999, '', 'INTERNATIONAL ORDER', '0.00', '0', 1, 0, 0)*/
			END
							
		FETCH NEXT FROM DemoCursor INTO @Order, @Country
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor

exec CvcImport*/

UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)

--Pilot specifications update
update order_hdr
set orderplacedby = 'PI',
paymenttermscode = 'NET 30',
CustomerSource = 'S',
selltoemail = 'NA'
where ccname = 'Pilot'

END
GO
/****** Object:  StoredProcedure [dbo].[stockCloseout_BK_12162011]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[stockCloseout_BK_12162011]
AS
BEGIN
	--IDENTIFYING ALL STOCKED PRODUCTS NOT SOLD IN THE LAST 18 MONTHS
	insert into closeout
	select [Item No_], SUM([Quantity]) qtyOnHand, MAX([Posting Date]) lastSoldDT,
			CASE 
				WHEN cost < 10 THEN CAST(cost/.9 as decimal(10, 2))
				WHEN cost BETWEEN 10 AND 100 THEN CAST(cost/.94 as decimal(10, 2))
				ELSE CAST(cost/.3 as decimal(10, 2))
			END sellingPrice
	from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] i
			JOIN products p ON p.CODE = i.[Item No_] collate Latin1_General_CS_AS
	WHERE CODE NOT LIKE '%-cat%'
	group by [Item No_], cost
	Having SUM([Quantity]) > 0 and DATEDIFF(MONTH, MAX([Posting Date]), GETDATE()) > 17

	--UPDATE PRODUCTS TABLE AND MARK THEM TO CLEARANCE
	update p
	set p.clearance = 1,
		p.qtyOnHand = c.qtyOnHand,
		p.lastSold = c.lastSoldDT,
		p.salesPrice = 
			CASE
				WHEN p.price > c.sellingPrice THEN c.sellingPrice
				ELSE p.price
			END
	from products p join closeout c on p.CODE = c.code COLLATE Latin1_General_CS_AS
	where ISNULL(p.clearance, 0) = 0

	--UPDATE PRODUCTS TABLE WITH CORRECT INVENTORY COUNT
	update p
	set p.qtyOnHand = c.qtyOnHand
	from products p join closeout c on p.CODE = c.code COLLATE Latin1_General_CS_AS
	where p.qtyOnHand <> c.qtyOnHand AND ISNULL(p.clearance, 0) = 1

	--REMOVE FROM CLEARANCE IF INVENTORY IS DEPLETED
	update products 
	set clearance = 0, lastSold = NULL, salesPrice = NULL
	WHERE clearance = 1 AND qtyOnHand = 0

	--EMAIL PATRICIA A LIST OF CLEARANCE ITEMS WITH MAX AND MIN
	exec dbo.email_StockCloseout
END
GO
/****** Object:  StoredProcedure [dbo].[upsBill_processFile]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[upsBill_processFile]
AS
BEGIN	
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Product Name], [Shipping Length], [Shipping Width], [UnitPrice], [UnitPrice2]) 
	SELECT [COLUMN 20], MAX(CAST([COLUMN 26] AS DECIMAL(10, 2))) submittedWeight, 
		MAX(CAST([COLUMN 28] AS DECIMAL(10, 2))) billedWeight,
		SUM(CAST([COLUMN 52] AS DECIMAL(10, 2))) costTT, COUNT([COLUMN 52]) chargeLine
	FROM upsBillFile
	WHERE ISNUMERIC([COLUMN 26]) = 1
		AND LEFT([COLUMN 20], 2) = '1Z'	
	GROUP BY [COLUMN 20]

	--REMOVE ALL TRACKING STAT WITH BAD DATA
	DELETE FROM prodTemp
	WHERE [Product Name] IN (SELECT [COLUMN 20] FROM upsBillFile WHERE ISNUMERIC([COLUMN 26]) = 0)
		
	UPDATE u
	SET u.shippingCost = p.[UnitPrice],
		u.enteredWeight = p.[Shipping Length],
		u.billedWeight = p.[Shipping Width],
		u.numCharges = p.[UnitPrice2]
	FROM trackingInfo u JOIN prodTemp p ON p.[Product Name] = u.[Tracking Number]
	WHERE u.shippingCost IS NULL

	INSERT INTO upsbill
	SELECT uf.* 
	FROM upsbillFile uf LEFT JOIN upsbill u ON uf.[COLUMN 20] = u.[COLUMN 20] 
									AND uf.[COLUMN 44] = u.[COLUMN 44] 
									AND uf.[COLUMN 45] = u.[COLUMN 45] 
									AND uf.[COLUMN 52] = u.[COLUMN 52] 
	WHERE u.[COLUMN 20] IS NULL

	TRUNCATE TABLE prodTemp
	TRUNCATE TABLE upsBillFile
END
GO
/****** Object:  StoredProcedure [dbo].[trackingRPT_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[trackingRPT_SP]
AS
BEGIN

truncate table trackingRpt

--COUNTING THE NUMBER OF PO OVER THE LAST 30 DAYS
INSERT INTO trackingRpt(vendorID, vendor, numPO)
SELECT [Buy-from Vendor No_], [Buy-from Vendor Name], count(*)
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header]
WHERE [Ship-to Name] NOT IN ('WAREHOUSE FACILITY', 'B & B Equipment & Supply, Inc.')
	AND DATEDIFF(DAY, [Order Date], GETDATE()) BETWEEN 3 AND 30 AND LEN([Buy-from Vendor No_]) = 3
GROUP BY [Buy-from Vendor No_], [Buy-from Vendor Name]

truncate table trackingRptWorktable

INSERT INTO trackingRptWorktable(vendorID, vendor, numPO)
SELECT [Buy-from Vendor No_], [Buy-from Vendor Name], count(*) 			
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header]
WHERE [Ship-to Name] NOT IN ('WAREHOUSE FACILITY', 'B & B Equipment & Supply, Inc.')
	AND DATEDIFF(DAY, [Order Date], GETDATE()) BETWEEN 3 AND 30 AND LEN([Buy-from Vendor No_]) = 3
GROUP BY [Buy-from Vendor No_], [Buy-from Vendor Name]

UPDATE t
SET t.numPO = t.numPO + w.numPO
FROM trackingRpt t JOIN trackingRptWorktable w ON t.vendorID = w.vendorID

INSERT INTO trackingRpt(vendorID, vendor, numPO)
SELECT * FROM trackingRptWorktable WHERE vendorID NOT IN (SELECT vendorID FROM trackingRpt)

--COUNTING THE NUMBER OF TRACKING IN THE UPSWORLDSHIP TABLE THAT IS NOT SHIPPING FROM HERE 
truncate table trackingRptWorktable

INSERT INTO trackingRptWorktable(vendorID, numPO)
SELECT m.mfgid, count(*)
FROM upsworldship u left join mfgupscode m on u.[shipper number] = m.upscode
WHERE u.[shipper number] <> '307417'
group by m.mfgid

UPDATE t
SET t.numTracking = w.numPO
FROM trackingRpt t JOIN trackingRptWorktable w ON t.vendorID = w.vendorID

INSERT INTO trackingRpt(vendorID, vendor, numTracking)
SELECT * FROM trackingRptWorktable WHERE vendorID NOT IN (SELECT vendorID FROM trackingRpt)

--CALCULATING THE NUMBER OF MATCHED TRACKING WITH ALL AVAILABLE TRACKING NUMBER FROM UPSWORLDSHIP TBL
truncate table trackingRptWorktable

INSERT INTO trackingRptWorktable(vendorID, numPO)
SELECT m.mfgid, count(*)
FROM upsworldship u left join mfgupscode m on u.[shipper number] = m.upscode
WHERE u.[shipper number] <> '307417' and len(isnull(u.katomOrderID, '')) > 0
group by m.mfgid

UPDATE t
SET t.[matched] = w.numPO
FROM trackingRpt t JOIN trackingRptWorktable w ON t.vendorID = w.vendorID

--CALCULATE THE NUMBER OF PO WITH TRACKING
truncate table trackingRptWorktable

INSERT INTO trackingRptWorktable(vendorID, numPO)
SELECT p.[Buy-from Vendor No_], COUNT(distinct p.[No_])
FROM trackingInfo t join fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p
						ON t.KatomOrderID = p.[Sales Order No_] collate Latin1_General_CS_AS
					join upsWorldShip u on u.[Tracking Number] = t.[Tracking Number] 
					join mfgUPSCode m on m.upsCode = u.[shipper number] and m.mfgID = p.[Buy-from Vendor No_] collate Latin1_General_CS_AS
WHERE [Ship-to Name] NOT IN ('WAREHOUSE FACILITY', 'B & B Equipment & Supply, Inc.')
	AND DATEDIFF(DAY, [Order Date], GETDATE()) BETWEEN 3 AND 30 AND LEN([Buy-from Vendor No_]) = 3
group by p.[Buy-from Vendor No_]

UPDATE t
SET t.[missingTrackingPO] = w.numPO
FROM trackingRpt t JOIN trackingRptWorktable w ON t.vendorID = w.vendorID

truncate table trackingRptWorktable
INSERT INTO trackingRptWorktable(vendorID, numPO)
SELECT p.[Buy-from Vendor No_], COUNT(distinct p.[No_])
FROM trackingInfo t join fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p
						ON t.KatomOrderID = p.[Sales Order No_] collate Latin1_General_CS_AS
					join upsWorldShip u on u.[Tracking Number] = t.[Tracking Number] 
					join mfgUPSCode m on m.upsCode = u.[shipper number]
WHERE [Ship-to Name] NOT IN ('WAREHOUSE FACILITY', 'B & B Equipment & Supply, Inc.')
	AND DATEDIFF(DAY, [Order Date], GETDATE()) BETWEEN 3 AND 30 AND LEN([Buy-from Vendor No_]) = 3
group by p.[Buy-from Vendor No_]

UPDATE t
SET t.[missingTrackingPO] = t.[missingTrackingPO] + w.numPO
FROM trackingRpt t JOIN trackingRptWorktable w ON t.vendorID = w.vendorID

truncate table trackingRptWorktable

update t
set t.[vendor] = v.[Name]
from trackingRpt t join fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v ON t.vendorID = v.[No_] collate Latin1_General_CS_AS
WHERE LEN(ISNULL(t.[vendor], '')) = 0

update trackingRpt set vendor = 'UNKNOWN' WHERE LEN(VENDORID) = 0


END
GO
/****** Object:  StoredProcedure [dbo].[shippingBill_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[shippingBill_SP]
AS
BEGIN
	DECLARE @sql VARCHAR(MAX), @upsLastUpdate DATETIME
	
	SELECT @upsLastUpdate = MAX([Column 4]) FROM UPSBILL
	TRUNCATE TABLE upsBill_RPT
	
	INSERT INTO upsBill_RPT
	SELECT @upsLastUpdate upsDT, i.[No_], i.[Web Order No_],  
		   CASE
			WHEN LEN(i.[Web Order No_]) = 0 THEN 'ph'
			WHEN LEFT(i.[Web Order No_], 2) = 'KT' THEN 'kt'
			WHEN LEFT(i.[Web Order No_], 2) = 'FA' THEN 'fa'
			WHEN LEFT(i.[Web Order No_], 2) = 'BB' THEN 'bb'
			WHEN LEFT(i.[Web Order No_], 2) = 'PI' THEN 'pi'
			ELSE 'eb'
		   END orderType, 
		   i.[Order Date], i.[Posting Date], 
		   CAST(CAST(t.[Ship Date] AS VARCHAR(11)) AS DATETIME) [Ship Date], 
		   MAX(l.[Description]) [Description], o.shipMethod, 
		   CAST(SUM(distinct l.[Unit Price]) AS DECIMAL(10, 2)) chargedInNAV, 
		   CAST(ISNULL(o.shipamount, 0) AS DECIMAL(10, 2)) estimatedFromWeb, 
		   CAST(SUM(ISNULL(t.shippingCost, 0)) AS DECIMAL(10, 2)) BilledFromUPS, 
		   MAX(CAST(ISNULL(t.enteredWeight, 0) AS DECIMAL(10, 2))) enteredWeight, 
		   MAX(CAST(ISNULL(t.billedWeight, 0) AS DECIMAL(10, 2))) billedWeight,
		   COUNT(t.[Tracking Number]) numOfPackage
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i 
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
			LEFT JOIN order_hdr o ON o.customerpo = i.[Web Order No_] COLLATE Latin1_General_CS_AS
			LEFT JOIN trackingInfo t ON t.KatomOrderID = i.[Order No_] COLLATE Latin1_General_CS_AS
	WHERE l.[No_] = '420'
		AND DATEDIFF(DAY, i.[Order Date], GETDATE()) < 91 
	GROUP BY i.[No_], i.[Web Order No_], i.[Order Date], i.[Posting Date], CAST(CAST(t.[Ship Date] AS VARCHAR(11)) AS DATETIME), 
		o.shipMethod, o.shipamount 
	ORDER BY 5 DESC
END
GO
/****** Object:  StoredProcedure [dbo].[webtrackinginfo]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Mike Shell
-- Create date: 3-4-11
-- Description:	Tracking Info Push to Web
-- =============================================
CREATE PROCEDURE [dbo].[webtrackinginfo]
AS
BEGIN
INSERT OPENQUERY(MYSQL, 'select trackingnum, 
								delivered, 
								shipdate, 
								deliverdate, 
								servicetype, 
								signby, 
								company, 
								contact, 
								address1, 
								address2, 
								city, 
								state, 
								zip, 
								country, 
								phone, 
								email, 
								carrier,
								trackingscan, 
								katomorderid, 
								katominvoiceid, 
								lastupdate,
								weborderID,
								selltoname,
								selltoaddress,
								selltoaddress2,
								selltocity,
								selltostate,
								selltozip,
								selltocountry
								FROM katom_mm5.tracking_fedex')

select [Tracking Number]
      ,[Delivered]
      ,[Ship Date]
      ,[Delivered Date]
      ,[Service Type]
      ,[Sign by]
      ,[Company]
      ,[Contact]
      ,[Address 1]
      ,[Address 2]
      ,[City]
      ,[State]
      ,[Zip]
      ,[Country]
      ,[Phone]
      ,[E-Mail]
      ,[carrier]
      ,[Tracking Scan]
      ,[KatomOrderID]
      ,[katomInvoiceID]
      ,[lastUpdateDT]
      ,[weborderid]
      ,[selltoname]
      ,[selltoaddress]
      ,[selltoaddress2]
      ,[selltocity]
      ,[selltostate]
      ,[selltozip]
      ,[selltocountry]
from trackingInfo
where sendToWEB = 1
--or [tracking number] in (select * from openquery(MYSQL,'select trackingnum from katom_mm5.tracking_fedex'))
and lastUpdateDT > (select * from openquery(MYSQL,'select date_add(max(lastupdate), interval 1 second) from katom_mm5.tracking_fedex'))

END
GO
/****** Object:  StoredProcedure [dbo].[updateSalesRank]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[updateSalesRank]
AS
BEGIN
--Ran once a week on Saturday

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_SALESRANK_UPD_FULL', GETDATE())
SET @jobID = @@identity

--UPDATE SALESRANK WITH NUM OF PROD. SOLD WITHIN 90 DAYS
TRUNCATE TABLE prodTemp

INSERT INTO prodTemp([No_], [UnitPrice])
SELECT code, sum(quantity) numSold
FROM order_items
WHERE order_id IN (SELECT customerpo FROM order_hdr WHERE DATEDIFF(DAY, ISNULL(ordertimestamp, '1/1/2009'), GETDATE()) < 91)
GROUP BY code

UPDATE products SET salesRank = NULL

UPDATE p
SET p.salesRank = t.[UnitPrice]
FROM products p JOIN prodTemp t on p.code = t.[No_] COLLATE Latin1_General_CS_AS

TRUNCATE TABLE prodTemp

INSERT INTO prodTemp([No_], [UnitPrice])
SELECT [No_] code, SUM([Quantity]) numsold
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line]
WHERE [Document No_] in 
			(SELECT [No_]
			FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
			WHERE DATEDIFF(DAY, [Order Date], GETDATE()) < 91
				AND [Customer Source] = 'I')
GROUP BY [No_]

UPDATE p
SET p.salesRank = ISNULL(p.salesRank, 0) + t.[UnitPrice]
FROM products p JOIN prodTemp t on p.code = t.[No_] COLLATE Latin1_General_CS_AS

TRUNCATE TABLE prodTemp

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[updateCatInfo_incremental]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[updateCatInfo_incremental]
AS
BEGIN

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_CAT_UPD_INCR', GETDATE())
SET @jobID = @@identity

UPDATE products SET categories = NULL, catCode = NULL, primaryCatID = NULL 
WHERE DATEDIFF(DAY, GETDATE(), updateDT) = 0

UPDATE p
SET p.primaryCatID = c.id
from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		join fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Category Codes] cc
			on ic.[Category Code] = cc.[code]
		join mivacategories c on c.code = cc.Description COLLATE Latin1_General_CS_AS
		join products p on p.code = ic.[Item No_] COLLATE Latin1_General_CS_AS
where [Primary Category] = 1 AND DATEDIFF(DAY, GETDATE(), p.updateDT) = 0

DECLARE @prodID varchar(200), @catCode varchar(200), @catName varchar(200)

DECLARE pCursor CURSOR FOR 
SELECT ic.[Item No_], c.code, c.[NAME] 
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Category Codes] cc
			ON ic.[Category Code] = cc.[code]
		JOIN mivacategories c ON c.code = cc.Description COLLATE Latin1_General_CS_AS
		JOIN products p ON p.code = ic.[Item No_] COLLATE Latin1_General_CS_AS
WHERE DATEDIFF(DAY, GETDATE(), p.updateDT) = 0
ORDER BY 1

OPEN pCursor
FETCH NEXT FROM pCursor INTO @prodID, @catCode, @catName

WHILE @@FETCH_STATUS = 0
   BEGIN
		UPDATE products
		SET categories = 
				CASE 
					WHEN categories IS NULL THEN @catName
					ELSE categories + ' | ' + @catName
				END,
			catCode = 
				CASE 
					WHEN catCode IS NULL THEN @catCode
					ELSE catCode + ', ' + @catCode
				END
		WHERE code = @prodID
	FETCH NEXT FROM pCursor INTO @prodID, @catCode, @catName
   END

CLOSE pCursor
DEALLOCATE pCursor

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[updateCatInfo]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[updateCatInfo]
AS
BEGIN

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_CAT_UPD_FULL', GETDATE())
SET @jobID = @@identity

--Run once a week on Saturday
UPDATE products SET categories = NULL, catCode = NULL, primaryCatID = NULL

UPDATE p
SET p.primaryCatID = c.id
from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		join fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Category Codes] cc
			on ic.[Category Code] = cc.[code]
		join mivacategories c on LOWER(LTRIM(RTRIM(c.code))) = LOWER(LTRIM(RTRIM(cc.[Description]))) COLLATE Latin1_General_CS_AS
		join products p on p.code = ic.[Item No_] COLLATE Latin1_General_CS_AS
where [Primary Category] = 1

UPDATE p
SET p.categories = c.[Name],
	p.catCode = c.[code]
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Category Codes] cc
			ON ic.[Category Code] = cc.[code]
		JOIN mivacategories c ON LOWER(LTRIM(RTRIM(c.code))) = LOWER(LTRIM(RTRIM(cc.[Description]))) COLLATE Latin1_General_CS_AS
		JOIN products p ON p.code = ic.[Item No_] COLLATE Latin1_General_CS_AS
WHERE ic.[Item No_] in 
	(SELECT [Item No_] 
	 FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes]
	 WHERE LEN([Item No_]) > 0	
	 GROUP BY [Item No_]
	 HAVING COUNT(*) = 1)

DECLARE @prodID varchar(200), @catCode varchar(200), @catName varchar(200)

DECLARE pCursor CURSOR FOR 
SELECT ic.[Item No_], c.code, c.[NAME] 
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Category Codes] cc
			ON ic.[Category Code] = cc.[code]
		JOIN mivacategories c ON LOWER(LTRIM(RTRIM(c.code))) = LOWER(LTRIM(RTRIM(cc.[Description]))) COLLATE Latin1_General_CS_AS
WHERE ic.[Item No_] in 
	(SELECT [Item No_] 
	 FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes]
	 WHERE LEN([Item No_]) > 0	
	 GROUP BY [Item No_]
	 HAVING COUNT(*) > 1)
	 and ic.[Item No_] IN (SELECT CODE COLLATE SQL_Latin1_General_CP1_CI_AS FROM productsmiva WHERE active = 1)
ORDER BY 1

OPEN pCursor
FETCH NEXT FROM pCursor INTO @prodID, @catCode, @catName

WHILE @@FETCH_STATUS = 0
   BEGIN
		UPDATE products
		SET categories = 
				CASE 
					WHEN categories IS NULL THEN @catName
					ELSE categories + ' | ' + @catName
				END,
			catCode = 
				CASE 
					WHEN catCode IS NULL THEN @catCode
					ELSE catCode + ', ' + @catCode
				END
		WHERE code = @prodID
	FETCH NEXT FROM pCursor INTO @prodID, @catCode, @catName
   END

CLOSE pCursor
DEALLOCATE pCursor

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[validateOrderImport]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[validateOrderImport]
AS
BEGIN


	UPDATE order_Hdr
	SET importValidated = 1
	WHERE customerpo COLLATE Latin1_General_CS_AS in 
				(SELECT [Web Order No_]
				FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] 
				WHERE charindex('Order ', [Posting Description]) > 0 and len([Web Order No_]) > 0)

	UPDATE order_Hdr
	SET importValidated = 1
	WHERE customerpo COLLATE Latin1_General_CS_AS in 
				(SELECT [Web Order No_]
				FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] 
				WHERE charindex('Order ', [Posting Description]) > 0 and len([Web Order No_]) > 0)
	
	
	---Notification
	BEGIN

		DECLARE @customerpo varchar(30)
		DECLARE @name varchar(MAX)
		DECLARE @age varchar(20)
		DECLARE @body varchar(MAX)

		SET @body = 'The following orders have failed to import in the past 3 hours:</br>'
		
		DECLARE valCursor CURSOR FOR 

			select customerpo, shiptocustomername, DATEDIFF(hh, batchtimestamp, GETDATE()) from order_hdr
			where  DATEDIFF(hh, batchtimestamp, GETDATE()) > 3
			and importValidated = 0
			order by batchtimestamp desc

		OPEN valCursor

		FETCH NEXT FROM valCursor INTO @customerpo, @name, @age
			

			WHILE @@FETCH_STATUS = 0

			BEGIN
			/*
			IF @pilotOrders <> '' 
				BEGIN 
					SET @pilotOrders = @pilotOrders+','+@pilotOrder 
				END
			ELSE 
				BEGIN
					SET @pilotOrders = @pilotOrder
				END
			*/

			SET @body = @body+@customerpo+'</br>'
			
			print @body
				
			FETCH NEXT FROM valCursor INTO @customerpo, @name, @age
			
			END

			CLOSE valCursor

			DEALLOCATE valCursor
						

			IF @customerpo <> '' 
				BEGIN
					EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients='navision@katom.com', @copy_recipients='paula@katom.com; david@katom.com; mike@katom.com', @subject='Orders Failed to Import', @body=@body, @body_format ='HTML'
				END
		END
		
		--Order History Process
			insert into order_hdr_history ([customerpo],[shiptocontact],[shiptoemail],[shiptocustomername],[phoneno],[faxno],[shiptoaddress],[shiptoaddress2],[shiptocity],[shiptostate],[shiptozip],[shiptocountry],[selltocustomername],[selltoemail],[selltocontact],[selltoaddress],[selltoaddress2],[selltocity],[selltostate],[selltozip],[ccnum],[ccname],[ccexpmo],[ccexpyr],[cvc],[exported],[shipmethod],[shipamount],[ordertimestamp],[batchtimestamp],[importValidated],[avsaddr],[avszip],[cvv2match],[pnref],[respcode],[selltocountry],[sellto1],[selltophone],[orderplacedby],[paymenttermscode],[CustomerPO2],[CustomerSource],[AmountSubmitted])			
			select [customerpo],[shiptocontact],[shiptoemail],[shiptocustomername],[phoneno],[faxno],[shiptoaddress],[shiptoaddress2],[shiptocity],[shiptostate],[shiptozip],[shiptocountry],[selltocustomername],[selltoemail],[selltocontact],[selltoaddress],[selltoaddress2],[selltocity],[selltostate],[selltozip],[ccnum],[ccname],[ccexpmo],[ccexpyr],[cvc],[exported],[shipmethod],[shipamount],[ordertimestamp],[batchtimestamp],[importValidated],[avsaddr],[avszip],[cvv2match],[pnref],[respcode],[selltocountry],[sellto1],[selltophone],[orderplacedby],[paymenttermscode],[CustomerPO2],[CustomerSource],[AmountSubmitted] 
			from order_hdr
			where importValidated = 1
			
			delete from order_hdr
			where importValidated = 1
			
			insert into order_items_history([order_id],[line_id],[product_id],[code],[name],[price],[weight],[taxable],[upsold],[quantity])
			select [order_id],[line_id],[product_id],[code],[name],[price],[weight],[taxable],[upsold],[quantity] 
			from order_items
			where order_id in (select customerpo from order_hdr_history)
			
			delete from order_items
			where order_id in (select order_id from order_items_history)
			
			insert into order_options_history([order_id],[line_id],[attr_id],[attr_code],[option_id],[attmpat_id],[opt_code],[price],[weight],[data],[data_long])
			select [order_id],[line_id],[attr_id],[attr_code],[option_id],[attmpat_id],[opt_code],[price],[weight],[data],[data_long] 
			from order_options
			where order_id in (select customerpo from order_hdr_history)
			
			delete from order_options
			where order_id in (select order_id from order_options_history)

END
GO
/****** Object:  StoredProcedure [dbo].[SLIFeed_SP2]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[SLIFeed_SP2]
AS
BEGIN

	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('SEARCH_FEED', GETDATE())
	SET @jobID = @@identity

	TRUNCATE TABLE SLIFeed

	INSERT INTO SLIFeed (prodID, [Product Number], [Product Name], [Product URL], [Description], [Product Image],[Product Thumbnail Image], [Price], [Accessory], lastProcessed)
	SELECT
		mivaProdid,
		code,
		[Name],
		'http://www.katom.com/' + code + '.html',
		CASE
			WHEN extendedDescription IS NULL THEN dbo.cleaner(prodDesc)
			ELSE dbo.cleaner(extendedDescription)
		END,
		'http://www.katom.com/largeproducts/' + LEFT(CODE, 3) + '/' + LOWER([image]) + '.jpg',
		'http://www.katom.com/products/' + LEFT(CODE, 3) + '/' + LOWER([image]) + '.jpg',
		CAST(Price as decimal(10, 2)),
		0,
		updateDT
	FROM products
	WHERE active = 1

	DECLARE @SQL VARCHAR(500), @sli VARCHAR(100), @refineable INT

	SET @sql = ''

	DECLARE aCursor CURSOR FOR 
	SELECT SLIColumn FROM sliColDef

	OPEN aCursor
	FETCH NEXT FROM aCursor INTO @sli

	WHILE @@FETCH_STATUS = 0
	   BEGIN
			IF (@refineable = 31)
			   BEGIN
				SET @sql = 'UPDATE s ' +
							'SET s.[' + @sli + '] = r.[Refinable Value] ' +
							'FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r ' + 
										' ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS ' +
							'WHERE LOWER([Refinable No_]) = LOWER(''' + CAST(@sli AS VARCHAR(100)) + ''') AND ' +
								'LOWER([Refinable No_]) NOT LIKE ''%related-items%'' AND LOWER([Refinable No_]) NOT LIKE ''%Accessories%'''
			   END
			ELSE
			   BEGIN
				SET @sql = 'UPDATE s ' +
							'SET s.[' + @sli + '] = r.[Refinable Value] ' +
							'FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r ' + 
										' ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS ' +
							'WHERE LOWER([Refinable No_]) = LOWER(''' + CAST(@sli AS VARCHAR(100)) + ''')'
			   END

			EXEC(@sql)
		FETCH NEXT FROM aCursor INTO @sli
	   END

	CLOSE aCursor
	DEALLOCATE aCursor

	--SETTING FREE SHIPPING FLAG
	UPDATE s
	SET s.freeshipping = p.FreeShipping
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.CODE
	
	--SETTING UOM
	UPDATE s
	SET s.[Priced Per:] = p.uom
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.CODE
	
	--MARKING SPECIAL PRICING FOR MAP PRICING PRODUCTS
	UPDATE SLIFeed
	SET specialPrice = 1
	WHERE [Product Number] IN (SELECT Code FROM products WHERE ISNULL(MAP, 0) = 1)
	
	UPDATE SLIFeed
	SET specialPrice = 1				 
	WHERE LEFT([Product Number], 3) ='599'
	
	--ENSURING PRICE IS CORRECT
	UPDATE s
	SET s.[Price] = CAST(p.[Price] as decimal(10, 2))
	FROM products p JOIN sliFeed s on p.code = s.[Product Number]
	WHERE CAST(p.[Price] as decimal(10, 2)) <> CAST(s.[Price] as decimal(10, 2))
	
	
	--CORRECTING PRICING AND SPECIAL PROGRAM MARKING
	UPDATE s
	SET s.specialPrice = 0
	FROM SLIFeed s join products p on s.[Product Number] = p.CODE
	WHERE ISNULL(p.MAP_Program, 'K') = 'K'  

	--MARKING onSale product		
	UPDATE f
	SET onSale = 1 
	FROM SLIFeed f JOIN products p on f.[Product Number] = p.CODE
	WHERE onSale = 0 AND p.clearance = 1
	

	--POPULATING CATEGORIES INFO, MARKING IF IT'S A NEW PRODUCT, SALESRANK AND FREE LIFTGATE
	UPDATE s
	SET s.prodCat = p.categories,
		s.salesRank = p.salesRank,
		s.newProduct = 
			CASE
				WHEN DATEDIFF(DAY, p.addeddt, GETDATE()) < 31 THEN 1
				ELSE 0	
			END,
		s.freeLiftgate = 0
		/**
			CASE p.mfgID
				WHEN '598' THEN 1
				WHEN '599' THEN 1
				ELSE 0
			END			
		**/	
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code

	--UPDATE THE CATEGORY FIELD WITH PRIMARYCAT IF IT IS NULL AND THEN NULL IT OUT IF IT IS A RELATED PRODUCT

	UPDATE s
	SET s.Category = c.catName
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.id = p.primaryCatID
	WHERE s.Category IS NULL
			AND c.catname NOT LIKE '%Related Items%' AND catname NOT LIKE '%Accessories%'

	UPDATE s
	SET s.navCategory = p.categories,
		s.catID = REPLACE(p.catCODE, ', ', '|')
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
--	WHERE p.categories NOT LIKE '%Related Items%'

	UPDATE s
	SET s.primarycatcode = c.CODE,
		s.sisterCat = c.sisterCat,
		s.sisterCatID = c.sisterCatID		
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.id = p.primaryCatID
--	WHERE c.catname NOT LIKE '%Related Items%' AND catname NOT LIKE '%Accessories%' 

	--REMOVE ALL RELATED ITEMS CAT FROM CATEGORIZATION
	UPDATE SLIFeed SET navCategory = NULL, catID = NULL WHERE navCategory = 'Related Items'
	
	UPDATE SLIFeed 
	SET navCategory = REPLACE(navCategory, '|Related Items', ''), 
		catID = REPLACE(navCategory, '|related-items', '') 
	WHERE CHARINDEX('|Related Items', navCategory) > 0
	
	UPDATE SLIFeed 
	SET navCategory = REPLACE(navCategory, 'Related Items|', ''), 
		catID = REPLACE(navCategory, 'related-items|', '') 
	WHERE CHARINDEX('Related Items|', navCategory) > 0
	
	--ASSIGNING THE CLEARANCE CATEGORY ONLY, IF THE ITEM IS ALSO MARKED AS RELATED ITEM	
	UPDATE s
	SET s.primarycatcode = replace(p.catCode, 'related-items, ', ''),
		s.sisterCat = c.sisterCat,
		s.sisterCatID = c.sisterCatID,
		s.navCategory = p.categories,
		s.catID = REPLACE(p.catCODE, ', ', '|')
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.code = replace(p.catCode, 'related-items, ', '')
	WHERE p.primaryCatCode = 'related-items' and p.catCode like '%clearance%'
	
	
	--MARKING ACCESSORIES WITH THE CORRECT CATNAME
	UPDATE s
	SET s.[Accessories] = c.[catName],
		s.[Accessory] = 1
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.id = p.primaryCatID
	WHERE c.catname LIKE '%Accessories%' and s.accessories is null

	UPDATE s
	SET s.[Accessories] = [Refinable No_],
		s.[Accessory] = 1
	FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r
				ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS
	WHERE LOWER([Refinable No_]) = 'category' AND LOWER([Refinable Value]) LIKE '%accessories%' and s.accessories is null

	--MARK A PRODUCT IF IT IS ECO FRIENDLY
	UPDATE s
	SET s.[GoGreen] = 'Go Green! Products'	
	FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r
				ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS
	WHERE [Refinable No_] = 'ADDINFO' AND s.[GoGreen] IS NULL AND
		([Refinable Value] LIKE '%Energy Efficient Product%' OR [Refinable Value] LIKE '%Eco Friendly%')
		
	
	--UPDATING WITH CORRECT MFGNAME
	UPDATE s
	SET s.[Manufacturer] = m.mfgShortName 
	FROM SLIFeed s join mfg m on LEFT(s.[Product Number], 3) = m.mfgID
	WHERE m.Active = 1 and m.mfgShortName <> s.[Manufacturer] 
	
	--MARKING ONSALE FOR ITEMS MARKED AS SALES ITEM
	UPDATE SLIFeed SET OnSale = 1 WHERE [Product Number] in (SELECT code From onSale WHERE DATEDIFF(DAY, endDT, GETDATE()) < 1 AND DATEDIFF(DAY, startDT, GETDATE()) > -1) and onSale = 0
	
	/**
	--MARKING ONSALE TO ALL TRUE SUPER TRAILER 
	UPDATE SLIFeed SET onSale = 1 WHERE [Product Number] in (SELECT code FROM trueSuperTrailer)
		
	--MARKING ONSALE TO ALL CLEARANCE ITEMS
	UPDATE SLIFeed SET onSale = 1 WHERE [Product Number] in (SELECT code FROM products WHERE catCode LIKE '%clearance%')
	
	--SETTING ALL TRUE TO BE ONSALE AND SPECIAL PRICING
	UPDATE SLIFeed SET onSale = 1, specialPrice = 1
	WHERE Manufacturer = 'TRUE' AND FreeShipping = 1 
	**/
	
	
	--SETTING CORRECT SALES PRICE
	--UPDATE s
	--SET s.[Price] = CAST(p.[salesPrice] as decimal(10, 2))
	--FROM products p JOIN sliFeed s on p.code = s.[Product Number]
	--WHERE p.clearance = 1
	
	--CORRECTING THE MPN INFO	
	UPDATE s
	SET s.mpn = p.mpn
	FROM SLIFeed s join products p on s.[Product Number] = p.CODE
	
	--CORRECTING THE MFG INFO
	UPDATE s
	SET s.Manufacturer = p.mfgName 
	FROM SLIFeed s join products p on s.[Product Number] = p.CODE
		
	DELETE FROM sliFeed WHERE [Product Number] like '599-%'
	
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[SLIFeed_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[SLIFeed_SP]
AS
BEGIN

	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('SEARCH_FEED', GETDATE())
	SET @jobID = @@identity

	TRUNCATE TABLE SLIFeed

	INSERT INTO SLIFeed (prodID, [Product Number], [Product Name], [Product URL], [Description], [Product Image],[Product Thumbnail Image], [Price], [Accessory], lastProcessed, inventoryCount, contactus)
	SELECT
		mivaProdid,
		code,
		[Name],
		'http://www.katom.com/' + code + '.html',
		CASE
			WHEN extendedDescription IS NULL THEN dbo.cleaner(prodDesc)
			ELSE dbo.cleaner(extendedDescription)
		END,
		'http://' + mfgid + '.katomcdn.com/' + LOWER([image]) + '_large.jpg',
		'http://' + mfgid + '.katomcdn.com/' + LOWER([image]) + '.jpg',
		CAST(Price as decimal(10, 2)),
		0,
		updateDT,
		qtyOnHand, 0	
	FROM products
	WHERE active = 1 and isWeb =1 

	DECLARE @SQL VARCHAR(500), @sli VARCHAR(100), @refineable INT

	SET @sql = ''

	DECLARE aCursor CURSOR FOR 
	SELECT SLIColumn FROM sliColDef

	OPEN aCursor
	FETCH NEXT FROM aCursor INTO @sli

	WHILE @@FETCH_STATUS = 0
	   BEGIN
			IF (@refineable = 31)
			   BEGIN
				SET @sql = 'UPDATE s ' +
							'SET s.[' + @sli + '] = r.[Refinable Value] ' +
							'FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r ' + 
										' ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS ' +
							'WHERE LOWER([Refinable No_]) = LOWER(''' + CAST(@sli AS VARCHAR(100)) + ''') AND ' +
								'LOWER([Refinable No_]) NOT LIKE ''%related-items%'' AND LOWER([Refinable No_]) NOT LIKE ''%Accessories%'''
			   END
			ELSE
			   BEGIN
				SET @sql = 'UPDATE s ' +
							'SET s.[' + @sli + '] = r.[Refinable Value] ' +
							'FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r ' + 
										' ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS ' +
							'WHERE LOWER([Refinable No_]) = LOWER(''' + CAST(@sli AS VARCHAR(100)) + ''')'
			   END

			EXEC(@sql)
		FETCH NEXT FROM aCursor INTO @sli
	   END

	CLOSE aCursor
	DEALLOCATE aCursor

	--SETTING FREE SHIPPING FLAG
	UPDATE s
	SET s.freeshipping = p.FreeShipping
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.CODE
	
	--SETTING UOM
	UPDATE s
	SET s.[Priced Per:] = p.uom
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.CODE
	
	--MARKING SPECIAL PRICING FOR MAP PRICING PRODUCTS
	UPDATE SLIFeed
	SET specialPrice = 1
	WHERE [Product Number] IN (SELECT Code FROM products WHERE ISNULL(MAP, 0) = 1)
	
	UPDATE SLIFeed
	SET specialPrice = 1				 
	WHERE LEFT([Product Number], 3) ='599'
	
	--ENSURING PRICE IS CORRECT
	UPDATE s
	SET s.[Price] = CAST(p.[Price] as decimal(10, 2))
	FROM products p JOIN sliFeed s on p.code = s.[Product Number]
	WHERE CAST(p.[Price] as decimal(10, 2)) <> CAST(s.[Price] as decimal(10, 2))
	
	
	--CORRECTING PRICING AND SPECIAL PROGRAM MARKING
	UPDATE s
	SET s.specialPrice = 0
	FROM SLIFeed s join products p on s.[Product Number] = p.CODE
	WHERE ISNULL(p.MAP_Program, 'K') = 'K'  

	--MARKING onSale product		
	UPDATE f
	SET onSale = 1 
	FROM SLIFeed f JOIN products p on f.[Product Number] = p.CODE
	WHERE onSale = 0 AND p.clearance = 1
	

	--POPULATING CATEGORIES INFO, MARKING IF IT'S A NEW PRODUCT, SALESRANK AND FREE LIFTGATE
	UPDATE s
	SET s.prodCat = p.categories,
		s.salesRank = p.salesRank,
		s.newProduct = 
			CASE
				WHEN DATEDIFF(DAY, p.addeddt, GETDATE()) < 31 THEN 1
				ELSE 0	
			END,
		s.freeLiftgate = 0
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code

	UPDATE s
	SET s.navCategory = p.categories,
		s.catID = REPLACE(p.catCODE, ', ', '|')
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
--	WHERE p.categories NOT LIKE '%Related Items%'

	UPDATE s
	SET s.primarycatcode = c.CODE,
		s.sisterCat = c.sisterCat,
		s.sisterCatID = c.sisterCatID		
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.id = p.primaryCatID
--	WHERE c.catname NOT LIKE '%Related Items%' AND catname NOT LIKE '%Accessories%' 

	--REMOVE ALL RELATED ITEMS CAT FROM CATEGORIZATION
	UPDATE SLIFeed SET navCategory = NULL, catID = NULL WHERE navCategory = 'Related Items'
	
	UPDATE SLIFeed 
	SET navCategory = REPLACE(navCategory, '|Related Items', ''), 
		catID = REPLACE(navCategory, '|related-items', '') 
	WHERE CHARINDEX('|Related Items', navCategory) > 0
	
	UPDATE SLIFeed 
	SET navCategory = REPLACE(navCategory, 'Related Items|', ''), 
		catID = REPLACE(navCategory, 'related-items|', '') 
	WHERE CHARINDEX('Related Items|', navCategory) > 0
	
	--ASSIGNING THE CLEARANCE CATEGORY ONLY, IF THE ITEM IS ALSO MARKED AS RELATED ITEM	
	UPDATE s
	SET s.primarycatcode = replace(p.catCode, 'related-items, ', ''),
		s.sisterCat = c.sisterCat,
		s.sisterCatID = c.sisterCatID,
		s.navCategory = p.categories,
		s.catID = REPLACE(p.catCODE, ', ', '|')
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.code = replace(p.catCode, 'related-items, ', '')
	WHERE p.primaryCatCode = 'related-items' and p.catCode like '%clearance%'
	
	
	--MARKING ACCESSORIES WITH THE CORRECT CATNAME
	UPDATE s
	SET s.[Accessories] = c.[catName],
		s.[Accessory] = 1
	FROM SLIFeed s JOIN products p ON s.[Product Number] = p.code
				   JOIN categories c ON c.id = p.primaryCatID
	WHERE c.catname LIKE '%Accessories%' and s.accessories is null

	UPDATE s
	SET s.[Accessories] = [Refinable No_],
		s.[Accessory] = 1
	FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r
				ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS
	WHERE LOWER([Refinable No_]) = 'category' AND LOWER([Refinable Value]) LIKE '%accessories%' and s.accessories is null

	--MARK A PRODUCT IF IT IS ECO FRIENDLY
	UPDATE s
	SET s.[GoGreen] = 'Go Green! Products'	
	FROM SLIFeed s JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r
				ON s.[Product Number] = r.[Item No_] COLLATE Latin1_General_CS_AS
	WHERE [Refinable No_] = 'ADDINFO' AND s.[GoGreen] IS NULL AND
		([Refinable Value] LIKE '%Energy Efficient Product%' OR [Refinable Value] LIKE '%Eco Friendly%')
		
	
	--UPDATING WITH CORRECT MFGNAME
	UPDATE s
	SET s.[Manufacturer] = m.mfgShortName 
	FROM SLIFeed s join mfg m on LEFT(s.[Product Number], 3) = m.mfgID
	WHERE m.Active = 1 and m.mfgShortName <> s.[Manufacturer] 
	
	--MARKING ONSALE FOR ITEMS MARKED AS SALES ITEM
	UPDATE SLIFeed SET OnSale = 1 WHERE [Product Number] in (SELECT code From onSale WHERE DATEDIFF(DAY, endDT, GETDATE()) < 1 AND DATEDIFF(DAY, startDT, GETDATE()) > -1) and onSale = 0
		
	--CORRECTING THE MPN INFO	
	UPDATE s
	SET s.mpn = p.mpn
	FROM SLIFeed s join products p on s.[Product Number] = p.CODE
	
	--CORRECTING THE MFG INFO
	UPDATE s
	SET s.Manufacturer = p.mfgName 
	FROM SLIFeed s join products p on s.[Product Number] = p.CODE
		
	DELETE FROM sliFeed WHERE [Product Number] like '599-%'
	
	--TESTING SOLUTION FOR REFINABLE CATEGORY VALUE
	UPDATE slifeed set Category = null

	UPDATE s
	SET s.Category = c.CATNAME
	FROM catxProd cx join categories c on cx.catCode = c.CODE
					 join SLIFeed s on s.[Product Number] = cx.prodcode				  
	WHERE cx.primaryCat = 1 and PARENT_ID = 0 and s.Category is null

	UPDATE s
	SET s.Category = c.CATNAME
	FROM catxProd cx join categories c on cx.catCode = c.CODE
					 join SLIFeed s on s.[Product Number] = cx.prodcode	
	WHERE cx.primaryCat = 1 and PARENT_ID = superCatid and s.Category is null AND c.primaryCat = 1

	UPDATE s
	SET s.Category =(SELECT CATNAME FROM categories WHERE id = c.PARENT_ID and primaryCat = 1)
	FROM catxProd cx join categories c on cx.catCode = c.CODE
					 join SLIFeed s on s.[Product Number] = cx.prodcode	
	WHERE cx.primaryCat = 1 
		AND c.primaryCat = 1
		and c.superCatid NOT IN (5844, 5612) and s.Category is null
		
	UPDATE s
	SET s.Category = 
			   CASE 
				WHEN CHARINDEX('RESIDENTIAL', CATNAME) = 0 THEN 'Residential ' + CATNAME
				ELSE CATNAME
			   END 
	FROM catxProd cx JOIN categories c ON cx.catCode = c.CODE
							  JOIN SLIFeed s on s.[Product Number] = cx.prodCode
	where superCatID = 5612 and cx.primaryCat = 1 and c.primaryCat = 1 and s.Category is null
	
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[shareASaleFeed_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[shareASaleFeed_SP]
AS
BEGIN

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('shareASale', GETDATE())
SET @jobID = @@identity

TRUNCATE TABLE feed_shareAsale

INSERT INTO feed_shareAsale(sku, name, url, price, retailPrice, fullImage, thumbnailImage, [description], searchterms,
		custom1, Manufacturer, partNumber,MerchantCategory, MerchantSubCategory)
SELECT 
	p.code,		
	dbo.cleaner(p.NAVDesc) [NAME],
	'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '.html',
	CAST(p.price as decimal(10, 2))[PRICE],
	CAST(p.listprice as decimal(10, 2)) [RETAILPRICE],
	/**
	'http://www.katom.com/largeproducts/' + p.mfgid + '/' + LOWER(p.image) + '.jpg',		
	'http://www.katom.com/products/' + p.mfgid + '/' + LOWER(p.image) + '.jpg',
	**/
	NULL, NULL,
	dbo.cleaner(p.NAVDesc),		
	NULL,		
	CASE p.freeShipping
		WHEN 1 THEN 'FREE SHIPPING'
		ELSE ''
	END,
	m.mfgName,
	p.mpn,
	CASE c.superCat
		WHEN 'Shop By Vendor' THEN
			CASE
				WHEN P.PRICE < 500 THEN 'Kitchen Supplies'
				ELSE 'Restaurant Equipment'
			END
		WHEN 'Related Items' THEN
			CASE
				WHEN P.PRICE < 500 THEN 'Kitchen Supplies'
				ELSE 'Restaurant Equipment'
			END
		WHEN 'Go Green! Shop to Save Energy and Money.' THEN
			CASE
				WHEN P.PRICE < 500 THEN 'Kitchen Supplies'
				ELSE 'Restaurant Equipment'
			END
		WHEN 'Go Green! Shop to Save Energy and Money.' THEN
			CASE
				WHEN P.PRICE < 500 THEN 'Kitchen Supplies'
				ELSE 'Restaurant Equipment'
			END
		WHEN 'Catering / Buffet' THEN
			CASE
				WHEN P.PRICE < 500 THEN 'Kitchen Supplies'
				ELSE 'Restaurant Equipment'
			END
		WHEN 'Pizza Equipment' THEN 'Restaurant Equipment'
		ELSE ISNULL(c.superCat, 'Restaurant Equipment')
	END,
	c.catname
FROM products p LEFT JOIN mfg m on p.mfgID = m.mfgID 
				LEFT JOIN categories c on p.primaryCatID = c.ID
WHERE p.ACTIVE = 1
	
UPDATE feed_shareAsale
SET commission = 
		CASE MerchantCategory
			WHEN 'Restaurant Equipment' THEN CAST(.03*price AS DECIMAL(10, 2))
			WHEN 'Furniture' THEN CAST(.03*price AS DECIMAL(10, 2))
			ELSE CAST(.07*price AS DECIMAL(10, 2))
		END,
		[ReservedForFuture Use] = 
		CASE MerchantCategory
			WHEN 'Restaurant Equipment' THEN 3.00
			WHEN 'Furniture' THEN 3.00
			ELSE 7.00
		END

--MAP POLICY
UPDATE f
SET f.price = 		
		CASE
			WHEN ISNULL(p.map, 0) = 1 THEN 
				CASE 
					WHEN ISNULL(p.feedMap, 0) = 1 THEN 
						CASE
							WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN cast(p.price as decimal(10, 2))
							ELSE CAST(p.map_price AS DECIMAL(10, 2))
						END
					ELSE cast(p.price as decimal(10, 2))
				END
			--WHEN ISNULL(P.clearance, 0) = 1 THEN cast(p.salesPrice as decimal(10, 2))
			ELSE cast(p.price as decimal(10, 2))
		END
FROM feed_shareAsale f JOIN products p ON f.sku = p.code

--REMOVING ALL PRODUCTS WITH FEEDMAP = 3
DELETE FROM feed_shareAsale
WHERE sku IN
	(SELECT code FROM products WHERE active = 1 AND feedMAP = 3)

DELETE FROM feed_shareAsale WHERE sku LIKE '%599-%'

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[salesStat30DaysPopulationWarehouse_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[salesStat30DaysPopulationWarehouse_SP]
AS
BEGIN
DECLARE @Source varchar(1), @SQL varchar(1000), @NumDate smallint

SET @NumDate = 100


--RESET salesStat30Days TBL
TRUNCATE TABLE salesStat30Days
TRUNCATE TABLE SalesStatWorktable

INSERT INTO salesStat30Days([Date])
SELECT DISTINCT [Posting Date] 
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] 
WHERE DATEDIFF(DAY, [Posting Date], GETDATE()) < @NumDate
	AND [Source Code] = 'SALES'
ORDER BY [Posting Date] DESC

SET @SQL = ''

DECLARE myCursor CURSOR FOR
SELECT DISTINCT [Customer Source] 
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
WHERE DATEDIFF(DAY, [Posting Date], GETDATE()) < @NumDate
	AND [Source Code] = 'SALES'

OPEN myCursor
FETCH NEXT FROM myCursor INTO @Source

WHILE @@FETCH_STATUS = 0
   BEGIN
	--PROCESSING INVOICED DATA
	INSERT INTO SalesStatWorktable
	SELECT
		ih.[Posting Date],
		CAST(SUM(ISNULL(il.[Amount], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < @NumDate
		AND ih.[Source Code] = 'SALES'
		AND ih.[Customer Source] = @Source
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND il.[Drop Shipment] = 0
	GROUP BY ih.[Posting Date]
	ORDER BY ih.[Posting Date] DESC

	SET @SQL = 'UPDATE s SET ' + 
				CASE @Source
					WHEN 'G' THEN ' s.GSAInvoiced = '
					WHEN 'I' THEN ' s.InternetInvoiced = '
					WHEN 'S' THEN ' s.salesmenInvoiced = '
					WHEN 'C' THEN ' s.catalogInvoiced = '
					WHEN 'B' THEN ' s.BidInvoiced = '
					WHEN 'U' THEN ' s.unknownInvoiced = '
				END + 
				'CAST(w.sales as varchar(20)) + '' ('' + CAST(w.orderCount as varchar(5)) + '')'' 
				 FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]'
	EXEC(@SQL)
	SET @SQL = ''
	TRUNCATE TABLE SalesStatWorktable

	--PROCESSING SALES DATA
	INSERT INTO SalesStatWorktable
	SELECT
		ih.[Posting Date],
		CAST(SUM(ISNULL(il.[Amount], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < @NumDate
		AND ih.[Customer Source] = @Source
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND il.[Drop Shipment] = 0
	GROUP BY ih.[Posting Date]
	ORDER BY ih.[Posting Date] DESC

	SET @SQL = 'UPDATE s SET ' + 
				CASE @Source
					WHEN 'G' THEN ' s.GSASales = '
					WHEN 'I' THEN ' s.InternetSales = '
					WHEN 'S' THEN ' s.salesmenSales = '
					WHEN 'C' THEN ' s.catalogSales = '
					WHEN 'B' THEN ' s.BidSales = '
					WHEN 'U' THEN ' s.unknownSales = '
				END + 
				'CAST(w.sales as varchar(20)) + '' ('' + CAST(w.orderCount as varchar(5)) + '')'' 
				 FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]'
	EXEC(@SQL)
	SET @SQL = ''
	TRUNCATE TABLE SalesStatWorktable

	FETCH NEXT FROM myCursor INTO @Source
   END

CLOSE myCursor
DEALLOCATE myCursor


--PROCESSING TOTAL INVOICED DATA
INSERT INTO SalesStatWorktable
SELECT
	ih.[Posting Date],
	CAST(SUM(il.[Amount]) as decimal(10, 2)),
	COUNT(distinct x.[No_]) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < @NumDate
	AND ih.[Source Code] = 'SALES'
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND il.[Drop Shipment] = 0
GROUP BY ih.[Posting Date]
ORDER BY ih.[Posting Date] DESC

UPDATE s 
SET s.TotalInvoiced = CAST(w.sales as varchar(20)) + ' (' + CAST(w.orderCount as varchar(5)) + ')'
FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]

TRUNCATE TABLE SalesStatWorktable

--PROCESSING TOTAL SALES DATA
INSERT INTO SalesStatWorktable
SELECT
	ih.[Posting Date],
	CAST(SUM(il.[Amount]) as decimal(10, 2)),
	COUNT(distinct x.[No_]) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < @NumDate
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND il.[Drop Shipment] = 0
GROUP BY ih.[Posting Date]
ORDER BY ih.[Posting Date] DESC

UPDATE s 
SET s.TotalSales = CAST(w.sales as varchar(20)) + ' (' + CAST(w.orderCount as varchar(5)) + ')'
FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]

TRUNCATE TABLE SalesStatWorktable

END
GO
/****** Object:  StoredProcedure [dbo].[salesStat30DaysPopulation_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[salesStat30DaysPopulation_SP]
AS
BEGIN
DECLARE @Source varchar(1), @SQL varchar(1000), @NumDate smallint

SET @NumDate = 180


--RESET salesStat30Days TBL
TRUNCATE TABLE salesStat30Days
TRUNCATE TABLE SalesStatWorktable

INSERT INTO salesStat30Days([Date])
SELECT DISTINCT [Posting Date] 
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] 
WHERE DATEDIFF(DAY, [Posting Date], GETDATE()) < @NumDate
	AND [Source Code] = 'SALES'
ORDER BY [Posting Date] DESC

SET @SQL = ''

DECLARE myCursor CURSOR FOR
SELECT DISTINCT [Customer Source] 
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
WHERE DATEDIFF(DAY, [Posting Date], GETDATE()) < @NumDate
	AND [Source Code] = 'SALES'

OPEN myCursor
FETCH NEXT FROM myCursor INTO @Source

WHILE @@FETCH_STATUS = 0
   BEGIN
	--PROCESSING INVOICED DATA
	INSERT INTO SalesStatWorktable
	SELECT
		ih.[Posting Date],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < @NumDate
		AND ih.[Source Code] = 'SALES'
		AND ih.[Customer Source] = @Source
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Posting Date]
	ORDER BY ih.[Posting Date] DESC

	SET @SQL = 'UPDATE s SET ' + 
				CASE @Source
					WHEN 'G' THEN ' s.GSAInvoiced = '
					WHEN 'I' THEN ' s.InternetInvoiced = '
					WHEN 'S' THEN ' s.salesmenInvoiced = '
					WHEN 'C' THEN ' s.catalogInvoiced = '
					WHEN 'B' THEN ' s.BidInvoiced = '
					WHEN 'U' THEN ' s.unknownInvoiced = '
				END + 
				'CAST(w.sales as varchar(20)) + '' ('' + CAST(w.orderCount as varchar(5)) + '')'' 
				 FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]'
	EXEC(@SQL)
	SET @SQL = ''
	TRUNCATE TABLE SalesStatWorktable

	--PROCESSING SALES DATA
	INSERT INTO SalesStatWorktable
	SELECT
		ih.[Order Date],
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, ih.[Order Date], GETDATE()) < @NumDate
		and ih.[Document Type] = 1
		AND ih.[Customer Source] = @Source
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Order Date]
	ORDER BY ih.[Order Date] DESC

	SET @SQL = 'UPDATE s SET ' + 
				CASE @Source
					WHEN 'G' THEN ' s.GSASales = '
					WHEN 'I' THEN ' s.InternetSales = '
					WHEN 'S' THEN ' s.salesmenSales = '
					WHEN 'C' THEN ' s.catalogSales = '
					WHEN 'B' THEN ' s.BidSales = '
					WHEN 'U' THEN ' s.unknownSales = '
				END + 
				'CAST(w.sales as varchar(20)) + '' ('' + CAST(w.orderCount as varchar(5)) + '')'' 
				 FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]'
	EXEC(@SQL)
	SET @SQL = ''
	TRUNCATE TABLE SalesStatWorktable

	FETCH NEXT FROM myCursor INTO @Source
   END

CLOSE myCursor
DEALLOCATE myCursor


--PROCESSING TOTAL INVOICED DATA
INSERT INTO SalesStatWorktable
SELECT
	ih.[Posting Date],
	CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
	COUNT(distinct x.[No_]) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < @NumDate
	AND ih.[Source Code] = 'SALES'
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
GROUP BY ih.[Posting Date]
ORDER BY ih.[Posting Date] DESC

UPDATE s 
SET s.TotalInvoiced = CAST(w.sales as varchar(20)) + ' (' + CAST(w.orderCount as varchar(5)) + ')'
FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]

TRUNCATE TABLE SalesStatWorktable

--PROCESSING TOTAL SALES DATA
INSERT INTO SalesStatWorktable
SELECT
	ih.[Order Date],
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct x.[No_]) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE DATEDIFF(DAY, ih.[Order Date], GETDATE()) < @NumDate
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND ih.[Document Type] = 1
GROUP BY ih.[Order Date]
ORDER BY ih.[Order Date] DESC

UPDATE s 
SET s.TotalSales = CAST(w.sales as varchar(20)) + ' (' + CAST(w.orderCount as varchar(5)) + ')'
FROM salesStat30Days s JOIN SalesStatWorktable w ON s.[Date] = w.[Date]

TRUNCATE TABLE SalesStatWorktable

--PROCESSING OPEN TICKETS 
TRUNCATE TABLE dailyStat_openOrder

INSERT INTO dailyStat_openOrder(orderDT, salesTT, countTT)
SELECT Top 10
	ih.[Order Date],
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE ih.[Document Type] = 1
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
GROUP BY ih.[Order Date]
ORDER BY ih.[Order Date] DESC

TRUNCATE TABLE prodTemp
INSERT INTO prodTemp([Product Name], UnitPrice2, UnitPrice)
SELECT Top 10
	ih.[Order Date],
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE ih.[Document Type] = 1
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	AND [No_ Printed] = 0
GROUP BY ih.[Order Date]
ORDER BY ih.[Order Date] DESC

UPDATE s
SET s.unprintCount = p.UnitPrice,
	s.unprintSales = p.UnitPrice2
FROM prodTemp p JOIN dailyStat_openOrder s on p.[Product Name] = s.orderDT


TRUNCATE TABLE prodTemp
INSERT INTO prodTemp([Product Name], UnitPrice2, UnitPrice)
SELECT Top 10
	ih.[Order Date],
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE ih.[Document Type] = 1
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	AND [No_ Printed] > 0
GROUP BY ih.[Order Date]
ORDER BY ih.[Order Date] DESC

UPDATE s
SET s.printCount = p.UnitPrice,
	s.printSales = p.UnitPrice2
FROM prodTemp p JOIN dailyStat_openOrder s on p.[Product Name] = s.orderDT

DECLARE @ORDERDT DATETIME

SELECT @ORDERDT=MIN(orderDT) FROM dailyStat_openOrder

INSERT INTO dailyStat_openOrder(orderDT, salesTT, countTT)
SELECT 
	'Over 10 days',
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE ih.[Document Type] = 1
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	AND DATEDIFF(DAY, ih.[Order Date], @ORDERDT) > 0
	

TRUNCATE TABLE prodTemp
INSERT INTO prodTemp([Product Name], UnitPrice2, UnitPrice)
SELECT Top 10
	'Over 10 days',
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE ih.[Document Type] = 1
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	AND DATEDIFF(DAY, ih.[Order Date], @ORDERDT) > 0
	AND [No_ Printed] = 0

UPDATE s
SET s.unprintCount = p.UnitPrice,
	s.unprintSales = p.UnitPrice2
FROM prodTemp p JOIN dailyStat_openOrder s on p.[Product Name] = s.orderDT
WHERE p.[Product Name] = 'Over 10 days'

TRUNCATE TABLE prodTemp
INSERT INTO prodTemp([Product Name], UnitPrice2, UnitPrice)
SELECT Top 10
	'Over 10 days',
	CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
	COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
	JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
		ON ih.[No_]  = il.[Document No_]
	JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
		ON X.[No_] = ih.[No_]
WHERE ih.[Document Type] = 1
	AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	AND DATEDIFF(DAY, ih.[Order Date], @ORDERDT) > 0
	AND [No_ Printed] > 0

UPDATE s
SET s.printCount = p.UnitPrice,
	s.printSales = p.UnitPrice2
FROM prodTemp p JOIN dailyStat_openOrder s on p.[Product Name] = s.orderDT
WHERE p.[Product Name] = 'Over 10 days'

END
GO
/****** Object:  StoredProcedure [dbo].[salesByMediumMM_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMediumMM_SP]
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @endingWeek tinyint
		
	TRUNCATE TABLE salesRptByMedium_MM
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('Phone')
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('Ebay')
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('Web')
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('Frosty Acres')
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('Pilot')
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('Cancelled')
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('B&B')

	DECLARE @wk INT, @oMedium VARCHAR(255), @order INT, @Sales DECIMAL(10, 2), @sql VARCHAR(MAX)

	-- POPULATING SALES INVOICES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT MONTH([Order Date]),
		CASE 
			WHEN LEN(LEFT([Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT([Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT([Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT([Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT([Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END, 
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE YEAR([Order Date]) = 2012
		AND [Source code] = 'SALES'
		AND l.[Unit Price] > 0
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY MONTH([Order Date]),
		CASE 
			WHEN LEN(LEFT([Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT([Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT([Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT([Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT([Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END
	UNION
	SELECT MONTH([Order Date]), 'Cancelled',
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE YEAR([Order Date]) = 2012
		AND [Source code] = 'DELETE'
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY MONTH([Order Date])
	ORDER BY 2, 1

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
	    
		SET @sql = 'UPDATE salesRptByMedium_MM SET M' + 
			CAST(@wk AS VARCHAR(10)) + 'io = ' + CAST(@order AS VARCHAR(10)) + ',  M' + 
			CAST(@wk AS VARCHAR(10)) + 'is = ' + CAST(@Sales AS VARCHAR(100)) + 
			' WHERE orderMedium = ''' + @oMedium + ''''		   
	       
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	-- POPULATING OPEN SALES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT MONTH([Order Date]),
		CASE 
			WHEN LEN(LEFT(ih.[Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT(ih.[Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT(ih.[Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT(ih.[Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT(ih.[Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END,
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT	, 
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2))
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE YEAR([Order Date]) = 2012
		AND ih.[Document Type] = 1
		AND il.[Unit Price] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY MONTH([Order Date]),
		CASE 
			WHEN LEN(LEFT(ih.[Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT(ih.[Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT(ih.[Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT(ih.[Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT(ih.[Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END
	ORDER BY 2

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @sql = 'UPDATE salesRptByMedium_MM SET M' + 
				CAST(@wk AS VARCHAR(10)) + 'oo = ' + CAST(@order AS VARCHAR(10)) + ',  M' + 
				CAST(@wk AS VARCHAR(10)) + 'os = ' + CAST(@Sales AS VARCHAR(100)) + 
				' WHERE orderMedium = ''' + @oMedium + ''''
		
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor		
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMediumMM_RPT]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMediumMM_RPT]
AS
BEGIN	
	-- SALES BY MEDIUM	
	SELECT orderMedium, 
		ISNULL([M1os], 0) [M1os], ISNULL([M1oo], 0) [M1oo], ISNULL([M1is], 0) [M1is], ISNULL([M1io], 0) [M1io],
		ISNULL([M2os], 0) [M2os], ISNULL([M2oo], 0) [M2oo], ISNULL([M2is], 0) [M2is], ISNULL([M2io], 0) [M2io],
		ISNULL([M3os], 0) [M3os], ISNULL([M3oo], 0) [M3oo], ISNULL([M3is], 0) [M3is], ISNULL([M3io], 0) [M3io],
		ISNULL([M4os], 0) [M4os], ISNULL([M4oo], 0) [M4oo], ISNULL([M4is], 0) [M4is], ISNULL([M4io], 0) [M4io],
		ISNULL([M5os], 0) [M5os], ISNULL([M5oo], 0) [M5oo], ISNULL([M5is], 0) [M5is], ISNULL([M5io], 0) [M5io],
		ISNULL([M6os], 0) [M6os], ISNULL([M6oo], 0) [M6oo],	ISNULL([M6is], 0) [M6is], ISNULL([M6io], 0) [M6io],
		ISNULL([M7os], 0) [M7os], ISNULL([M7oo], 0) [M7oo],	ISNULL([M7is], 0) [M7is], ISNULL([M7io], 0) [M7io],
		ISNULL([M8os], 0) [M8os], ISNULL([M8oo], 0) [M8oo],	ISNULL([M8is], 0) [M8is], ISNULL([M8io], 0) [M8io],
		ISNULL([M9os], 0) [M9os], ISNULL([M9oo], 0) [M9oo],	ISNULL([M9is], 0) [M9is], ISNULL([M9io], 0) [M9io],
		ISNULL([M10os], 0) [M10os], ISNULL([M10oo], 0) [M10oo],	ISNULL([M10is], 0) [M10is], ISNULL([M10io], 0) [M10io],
		ISNULL([M11os], 0) [M11os], ISNULL([M11oo], 0) [M11oo],	ISNULL([M11is], 0) [M11is], ISNULL([M11io], 0) [M11io],
		ISNULL([M12os], 0) [M12os], ISNULL([M12oo], 0) [M12oo],	ISNULL([M12is], 0) [M12is], ISNULL([M12io], 0) [M12io],
		ISNULL([M1os], 0) + ISNULL([M2os], 0) + ISNULL([M3os], 0) + ISNULL([M4os], 0) + ISNULL([M5os], 0) + ISNULL([M6os], 0)
		+ ISNULL([M7os], 0) + ISNULL([M8os], 0) + ISNULL([M9os], 0) + ISNULL([M10os], 0) + ISNULL([M11os], 0) + ISNULL([M12os], 0) [osalesTT],
		ISNULL([M1is], 0) + ISNULL([M2is], 0) + ISNULL([M3is], 0) + ISNULL([M4is], 0) + ISNULL([M5is], 0) + ISNULL([M6is], 0) 
		+ ISNULL([M7is], 0) + ISNULL([M8is], 0) + ISNULL([M9is], 0) + ISNULL([M10is], 0) + ISNULL([M11is], 0) + ISNULL([M12is], 0) [isalesTT],
		ISNULL([M1oo], 0) + ISNULL([M2oo], 0) + ISNULL([M3oo], 0) + ISNULL([M4oo], 0) + ISNULL([M5oo], 0) + ISNULL([M6oo], 0) 
		+ ISNULL([M7oo], 0) + ISNULL([M8oo], 0) + ISNULL([M9oo], 0) + ISNULL([M10oo], 0) + ISNULL([M11oo], 0) + ISNULL([M12oo], 0) [oorderTT],
		ISNULL([M1io], 0) + ISNULL([M2io], 0) + ISNULL([M3io], 0) + ISNULL([M4io], 0) + ISNULL([M5io], 0) + ISNULL([M6io], 0) 
		+ ISNULL([M7io], 0) + ISNULL([M8io], 0) + ISNULL([M9io], 0) + ISNULL([M10io], 0) + ISNULL([M11io], 0) + ISNULL([M12io], 0) [iorderTT]
	FROM salesRptByMedium_MM
	
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMediumMM_cat_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMediumMM_cat_SP]
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @endingWeek tinyint
		
	TRUNCATE TABLE salesRptByMedium_MM
	INSERT INTO salesRptByMedium_MM(orderMedium) VALUES('UNCAT')
	INSERT INTO salesRptByMedium_MM(orderMedium) 
	SELECT DISTINCT SUPERCAT
	FROM categories
	WHERE ACTIVE  = 1

	DECLARE @wk INT, @oMedium VARCHAR(255), @order INT, @Sales DECIMAL(10, 2), @sql VARCHAR(MAX)

	-- POPULATING SALES INVOICES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT MONTH([Order Date]),
		isnull(c.SUPERCAT, 'UNCAT'), 
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
		LEFT JOIN products p on p.CODE = l.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatCode = c.CODE AND c.primaryCat = 1
	WHERE YEAR([Order Date]) = 2012
		AND [Source code] = 'SALES'
		AND l.[Unit Price] > 0
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEFT(i.[Web Order No_], 2) = 'KT'
	GROUP BY MONTH([Order Date]), isnull(c.SUPERCAT, 'UNCAT')
	order by 2, 1

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
	    
		SET @sql = 'UPDATE salesRptByMedium_MM SET M' + 
			CAST(@wk AS VARCHAR(10)) + 'io = ' + CAST(@order AS VARCHAR(10)) + ',  M' + 
			CAST(@wk AS VARCHAR(10)) + 'is = ' + CAST(@Sales AS VARCHAR(100)) + 
			' WHERE orderMedium = ''' + @oMedium + ''''		   
	       
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	-- POPULATING OPEN SALES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT MONTH([Order Date]),	isnull(c.SUPERCAT, 'UNCAT'),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT	, 
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2))
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il ON ih.[No_]  = il.[Document No_]
		LEFT JOIN products p on p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatCode = c.CODE AND c.primaryCat = 1
	WHERE YEAR([Order Date]) = 2012
		AND ih.[Document Type] = 1
		AND il.[Unit Price] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEFT(ih.[Web Order No_], 2) = 'KT'
	GROUP BY MONTH([Order Date]), isnull(c.SUPERCAT, 'UNCAT')
	ORDER BY 2

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @sql = 'UPDATE salesRptByMedium_MM SET M' + 
				CAST(@wk AS VARCHAR(10)) + 'oo = ' + CAST(@order AS VARCHAR(10)) + ',  M' + 
				CAST(@wk AS VARCHAR(10)) + 'os = ' + CAST(@Sales AS VARCHAR(100)) + 
				' WHERE orderMedium = ''' + @oMedium + ''''
		
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor		
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMedium_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMedium_SP]
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @endingWeek tinyint

	SET @today = GETDATE()
	SET @weekDay = DATEPART(WEEKDAY, @today)
	SET @endDT = DATEADD(DAY, -@weekday, @today)
	SET @startDT = DATEADD(DAY, -7, DATEADD(WEEK, -5, @endDT))
	SET @startingWeek = DATEPART(WEEK, @startDT)
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @day = DAY(@today)
		
	TRUNCATE TABLE salesRptByMedium
	INSERT INTO salesRptByMedium(orderMedium) VALUES('Phone')
	INSERT INTO salesRptByMedium(orderMedium) VALUES('Ebay')
	INSERT INTO salesRptByMedium(orderMedium) VALUES('Web')
	INSERT INTO salesRptByMedium(orderMedium) VALUES('Frosty Acres')
	INSERT INTO salesRptByMedium(orderMedium) VALUES('Pilot')
	INSERT INTO salesRptByMedium(orderMedium) VALUES('Cancelled')
	INSERT INTO salesRptByMedium(orderMedium) VALUES('B&B')

	DECLARE @wk INT, @oMedium VARCHAR(255), @order INT, @Sales DECIMAL(10, 2), @sql VARCHAR(MAX)

	-- POPULATING SALES INVOICES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT 
		CASE DATEDIFF(WEEK, [Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END,
		CASE 
			WHEN LEN(LEFT([Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT([Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT([Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT([Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT([Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END, 
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND [Source code] = 'SALES'
		AND l.[Unit Price] > 0
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY 
		CASE DATEDIFF(WEEK, [Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END,
		CASE 
			WHEN LEN(LEFT([Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT([Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT([Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT([Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT([Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END
	UNION
	SELECT 
		CASE DATEDIFF(WEEK, [Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END, 'Cancelled',
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND [Source code] = 'DELETE'
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY 
		CASE DATEDIFF(WEEK, [Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END
	ORDER BY 2, 1 DESC

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
	    
		IF @wk = 7
		   BEGIN
			SET @sql = 'UPDATE salesRptByMedium SET WTDio = ' + CAST(@order AS VARCHAR(10)) + 
				',  WTDis = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		ELSE
		   BEGIN
			SET @sql = 'UPDATE salesRptByMedium SET W' + 
				CAST(@wk AS VARCHAR(10)) + 'io = ' + CAST(@order AS VARCHAR(10)) + ',  W' + 
				CAST(@wk AS VARCHAR(10)) + 'is = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
	       
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	-- POPULATING OPEN SALES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT
		CASE DATEDIFF(WEEK, ih.[Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END,
		CASE 
			WHEN LEN(LEFT(ih.[Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT(ih.[Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT(ih.[Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT(ih.[Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT(ih.[Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END,
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT	, 
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2))
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND ih.[Document Type] = 1
		AND il.[Unit Price] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY CASE DATEDIFF(WEEK, ih.[Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END,
		CASE 
			WHEN LEN(LEFT(ih.[Web Order No_], 2)) = 0 THEN 'Phone'
			WHEN ISNUMERIC(LEFT(ih.[Web Order No_], 2)) = 1 THEN 'Ebay'
			WHEN LEFT(ih.[Web Order No_], 2) = 'KT' THEN 'Web'
			WHEN LEFT(ih.[Web Order No_], 2) = 'FA' THEN 'Frosty Acres'
			WHEN LEFT(ih.[Web Order No_], 2) = 'PI' THEN 'Pilot'
			WHEN LEFT([Web Order No_], 2) = 'BB' THEN 'B&B'
		END
	ORDER BY 2

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF @wk = 7
		   BEGIN
			SET @sql = 'UPDATE salesRptByMedium SET WTDoo = ' + CAST(@order AS VARCHAR(10)) + 
				',  WTDos = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		ELSE
		   BEGIN
			SET @sql = 'UPDATE salesRptByMedium SET W' + 
				CAST(@wk AS VARCHAR(10)) + 'oo = ' + CAST(@order AS VARCHAR(10)) + ',  W' + 
				CAST(@wk AS VARCHAR(10)) + 'os = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
		
	TRUNCATE TABLE salesRptBySalesmen
	INSERT INTO salesRptBySalesmen(orderMedium)
	SELECT distinct [Salesperson Code]
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND [Source code] = 'SALES'
		AND [Salesperson Code] <> 'WEBIMPORT'
	UNION
	SELECT distinct [Salesperson Code]
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND [Document Type] = 1
		AND [Salesperson Code] <> 'WEBIMPORT'


	-- SALES BY SALESMEN
	-- POPULATING SALES INVOICES DATA
	DECLARE catCursor CURSOR FOR 
	SELECT 
		CASE DATEDIFF(WEEK, [Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END, [Salesperson Code], 
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND [Source code] = 'SALES'
		AND [Salesperson Code] <> 'WEBIMPORT'
		AND l.[Unit Price] > 0
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY 
		CASE DATEDIFF(WEEK, [Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END,[Salesperson Code]

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF @wk = 7
		   BEGIN
			SET @sql = 'UPDATE salesRptBySalesmen SET WTDio = ' + CAST(@order AS VARCHAR(10)) + 
				',  WTDis = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		ELSE
		   BEGIN
			SET @sql = 'UPDATE salesRptBySalesmen SET W' + 
				CAST(@wk AS VARCHAR(10)) + 'io = ' + CAST(@order AS VARCHAR(10)) + ',  W' + 
				CAST(@wk AS VARCHAR(10)) + 'is = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		
		
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	-- POPULATING OPEN SALES DATA
	DECLARE catCursor CURSOR FOR
	SELECT
		CASE DATEDIFF(WEEK, ih.[Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END, [Salesperson Code], 
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT	, 
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2))
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE [Order Date] BETWEEN @startDT AND @today
		AND ih.[Document Type] = 1
		AND ih.[Salesperson Code] <> 'WEBIMPORT'
		AND il.[Unit Price] > 0
		AND il.[Unit Price] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY CASE DATEDIFF(WEEK, ih.[Order Date], getdate())
			WHEN 6 THEN 1
			WHEN 5 THEN 2
			WHEN 4 THEN 3
			WHEN 3 THEN 4
			WHEN 2 THEN 5
			WHEN 1 THEN 6
			ELSE 7
		END, [Salesperson Code]
	ORDER BY 2

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF @wk = 7
		   BEGIN
			SET @sql = 'UPDATE salesRptBySalesmen SET WTDoo = ' + CAST(@order AS VARCHAR(10)) + 
				',  WTDos = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		ELSE
		   BEGIN
			SET @sql = 'UPDATE salesRptBySalesmen SET W' + 
				CAST(@wk AS VARCHAR(10)) + 'oo = ' + CAST(@order AS VARCHAR(10)) + ',  W' + 
				CAST(@wk AS VARCHAR(10)) + 'os = ' + CAST(@Sales AS VARCHAR(100)) + ' WHERE orderMedium = ''' + @oMedium + ''''
		   END
		
		
		EXEC(@sql)
			   
		FETCH NEXT FROM catCursor INTO @wk, @oMedium, @order, @Sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMedium_RPT]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMedium_RPT]
	@salesGroup varchar(50)
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @endingWeek tinyint,
			@sql VARCHAR(MAX)

	SET @today = GETDATE()
	SET @weekDay = DATEPART(WEEKDAY, @today)
	SET @endDT = DATEADD(DAY, -@weekday, @today)
	SET @startDT = DATEADD(DAY, -7, DATEADD(WEEK, -5, @endDT))
	SET @startingWeek = DATEPART(WEEK, @startDT)
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @day = DAY(@today)
		
	SELECT CAST(dbo.getfirstDateOfWeek2([Posting Date]) AS VARCHAR(11)) dt
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
	WHERE [Posting Date] BETWEEN @startDT AND @today
			AND [Source Code] = 'SALES'
			AND LEN(ISNULL([Customer Source], '')) > 0
			AND [Customer Source] = 'I'
	GROUP BY dbo.getfirstDateOfWeek2([Posting Date])
	
	-- SALES BY MEDIUM	
	SELECT orderMedium, ISNULL([W1os], 0) [W1os], ISNULL([W1oo], 0) [W1oo], ISNULL([W1is], 0) [W1is], ISNULL([W1io], 0) [W1io],
				ISNULL([W2os], 0) [W2os], ISNULL([W2oo], 0) [W2oo], ISNULL([W2is], 0) [W2is], ISNULL([W2io], 0) [W2io],
				ISNULL([W3os], 0) [W3os], ISNULL([W3oo], 0) [W3oo], ISNULL([W3is], 0) [W3is], ISNULL([W3io], 0) [W3io],
				ISNULL([W4os], 0) [W4os], ISNULL([W4oo], 0) [W4oo], ISNULL([W4is], 0) [W4is], ISNULL([W4io], 0) [W4io],
				ISNULL([W5os], 0) [W5os], ISNULL([W5oo], 0) [W5oo], ISNULL([W5is], 0) [W5is], ISNULL([W5io], 0) [W5io],
				ISNULL([W6os], 0) [W6os], ISNULL([W6oo], 0) [W6oo],	ISNULL([W6is], 0) [W6is], ISNULL([W6io], 0) [W6io],
				ISNULL([WTDos], 0) [WTDos], ISNULL([WTDoo], 0) [WTDoo],	ISNULL([WTDis], 0) [WTDis], ISNULL([WTDio], 0) [WTDio],
				ISNULL([W1os], 0) + ISNULL([W2os], 0) + ISNULL([W3os], 0) + ISNULL([W4os], 0) + ISNULL([W5os], 0) + ISNULL([W6os], 0) [osalesTT],
				ISNULL([W1is], 0) + ISNULL([W2is], 0) + ISNULL([W3is], 0) + ISNULL([W4is], 0) + ISNULL([W5is], 0) + ISNULL([W6is], 0) [isalesTT],
				ISNULL([W1oo], 0) + ISNULL([W2oo], 0) + ISNULL([W3oo], 0) + ISNULL([W4oo], 0) + ISNULL([W5oo], 0) + ISNULL([W6oo], 0) [oorderTT],
				ISNULL([W1io], 0) + ISNULL([W2io], 0) + ISNULL([W3io], 0) + ISNULL([W4io], 0) + ISNULL([W5io], 0) + ISNULL([W6io], 0) [iorderTT]
	FROM salesRptByMedium
	
	-- SALES BY SALESMEN	
	SET @sql = 'SELECT CASE 
						WHEN e.employeeName IS NULL THEN orderMedium
						ELSE e.employeeName
					   END orderMedium, e.department, 
					   ISNULL([W1os], 0) [W1os], ISNULL([W1oo], 0) [W1oo], ISNULL([W1is], 0) [W1is], ISNULL([W1io], 0) [W1io],
						ISNULL([W2os], 0) [W2os], ISNULL([W2oo], 0) [W2oo], ISNULL([W2is], 0) [W2is], ISNULL([W2io], 0) [W2io],
						ISNULL([W3os], 0) [W3os], ISNULL([W3oo], 0) [W3oo], ISNULL([W3is], 0) [W3is], ISNULL([W3io], 0) [W3io],
						ISNULL([W4os], 0) [W4os], ISNULL([W4oo], 0) [W4oo], ISNULL([W4is], 0) [W4is], ISNULL([W4io], 0) [W4io],
						ISNULL([W5os], 0) [W5os], ISNULL([W5oo], 0) [W5oo], ISNULL([W5is], 0) [W5is], ISNULL([W5io], 0) [W5io],
						ISNULL([W6os], 0) [W6os], ISNULL([W6oo], 0) [W6oo],	ISNULL([W6is], 0) [W6is], ISNULL([W6io], 0) [W6io],
						ISNULL([WTDos], 0) [WTDos], ISNULL([WTDoo], 0) [WTDoo],	ISNULL([WTDis], 0) [WTDis], ISNULL([WTDio], 0) [WTDio],
						ISNULL([W1os], 0) + ISNULL([W2os], 0) + ISNULL([W3os], 0) + ISNULL([W4os], 0) + ISNULL([W5os], 0) + ISNULL([W6os], 0) [osalesTT],
						ISNULL([W1is], 0) + ISNULL([W2is], 0) + ISNULL([W3is], 0) + ISNULL([W4is], 0) + ISNULL([W5is], 0) + ISNULL([W6is], 0) [isalesTT],
						ISNULL([W1oo], 0) + ISNULL([W2oo], 0) + ISNULL([W3oo], 0) + ISNULL([W4oo], 0) + ISNULL([W5oo], 0) + ISNULL([W6oo], 0) [oorderTT],
						ISNULL([W1io], 0) + ISNULL([W2io], 0) + ISNULL([W3io], 0) + ISNULL([W4io], 0) + ISNULL([W5io], 0) + ISNULL([W6io], 0) [iorderTT]
				FROM salesRptBySalesmen s left join employee e on LOWER(s.orderMedium) = LOWER(e.empid)
				WHERE e.department IN (''' + REPLACE(@salesGroup, ', ', ''', ''') + ''')
				ORDER BY ISNULL([WTDis], 0) + ISNULL([WTDos], 0) DESC'
	EXEC(@sql)
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMedium_email]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[salesByMedium_email]
AS
BEGIN
	DECLARE @medium VARCHAR(100), @WTDos DECIMAL(10, 2), @WTDoo INT, @WTDis DECIMAL(10, 2), @WTDio INT, @counter INT
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150), @bgcolor VARCHAR(500)
		
	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Sales By Medium</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 12px; vertical-align: top; }
	</style>

	</head>
	<body>
	<p>	
	<a href="http://www.katom.local/salesByMedium.asp">Click here for complete report - THIS IS ONLY AVAILABLE AT KATOM FACILITY</a>
	</p>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="text-align:center; width: 100px;">Order Medium</td>
		<td style="text-align:center; width: 120px;">Week To Date<br />Open Sales</td>
		<td style="text-align:center; width: 120px;">Week To Date<br />Invoiced Sales</td>
		<td style="text-align:center; width: 120px;">Week To Date<br />Total Sales</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT orderMedium, ISNULL([WTDos], 0) [WTDos], ISNULL([WTDoo], 0) [WTDoo],	ISNULL([WTDis], 0) [WTDis], ISNULL([WTDio], 0) [WTDio]
	FROM salesRptByMedium
	WHERE orderMedium <> 'Cancelled'

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @medium, @WTDos, @WTDoo, @WTDis, @WTDio

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @medium + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@WTDos AS MONEY), 1) + ' (' + CAST(@WTDoo AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@WTDis AS MONEY), 1) + ' (' + CAST(@WTDio AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@WTDos+@WTDis AS MONEY), 1) + ' (' + CAST(@WTDoo+@WTDio AS VARCHAR(100)) + ')</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @medium, @WTDos, @WTDoo, @WTDis, @WTDio
	   END

	CLOSE sCursor
	DEALLOCATE sCursor

	SET @body1 = @body1 + '</table><br /><br />
		<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
		  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
			<td colspan="4">CSR Sales Performer</td>
		  </tr>
		  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
			<td style="width: 100px;">Employee</td>
			<td style="text-align:center; width: 120px;">Week To Date<br />Open Sales</td>
			<td style="text-align:center; width: 120px;">Week To Date<br />Invoiced Sales</td>
			<td style="text-align:center; width: 120px;">Week To Date<br />Total Sales</td>
		  </tr>'

	DECLARE sCursor CURSOR FOR 
	SELECT CASE 
		WHEN e.employeeName IS NULL THEN orderMedium
		ELSE e.employeeName
	   END orderMedium,
		ISNULL([WTDos], 0) [WTDos], ISNULL([WTDoo], 0) [WTDoo],	ISNULL([WTDis], 0) [WTDis], ISNULL([WTDio], 0) [WTDio]
	FROM salesRptBySalesmen s left join employee e on LOWER(s.orderMedium) = LOWER(e.empid)
	WHERE e.department IN ('CSR')
	ORDER BY ISNULL([WTDis], 0) + ISNULL([WTDos], 0) DESC
	
	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @medium, @WTDos, @WTDoo, @WTDis, @WTDio

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @medium + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@WTDos AS MONEY), 1) + ' (' + CAST(@WTDoo AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@WTDis AS MONEY), 1) + ' (' + CAST(@WTDio AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@WTDos+@WTDis AS MONEY), 1) + ' (' + CAST(@WTDoo+@WTDio AS VARCHAR(100)) + ')</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @medium, @WTDos, @WTDoo, @WTDis, @WTDio
	   END

	CLOSE sCursor
	DEALLOCATE sCursor


	SET @body1 = @body1 + '</table>'

	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'pbible@katom.com; cbible@katom.com; dlu@katom.com; pchesworth@katom.com; jchesworth@katom.com; mharville@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Sales By Medium as of ' + CAST(GETDATE() AS VARCHAR(11))

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[salesByCat2]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[salesByCat2]
	@fromDT DATETIME, @toDT DATETIME, @cat VARCHAR(100), @orderBy INT
AS
BEGIN
	DECLARE @sSQL VARCHAR(2000)
		
	--PULL THE SUPERCAT NAME FOR THE CATEGORY DROP DOWN LIST	
	SELECT SUPERCAT FROM categories WHERE ACTIVE = 1  GROUP BY superCat HAVING COUNT(*) > 5 ORDER BY 1

	IF LEN(ISNULL(@fromDT, '')) = 0 
	  BEGIN
		SET @fromDT = GETDATE()
		SET @toDT = DATEADD(DAY, -30, @fromDT)
	  END

	IF @orderBy = 0 
	  BEGIN
		SET @orderBy = 9
	  END	  
	  
	SET @sSQL = ''
	
	SET @sSQL = 'SELECT TOP 100 p.CODE, p.name, p.mfgname, qtyOnHand,
					CASE 
						WHEN c.superCat IS NULL THEN ''Not Categorized''
						ELSE c.superCat
					END category, p.price, 
					CASE
						WHEN p.price > 0 THEN (p.price - p.cost)/p.price
						ELSE 0
					END margin, 
					SUM(ISNULL(il.[Quantity], 0)) qtySold,
					CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)) salesTT,
					COUNT(DISTINCT ih.[No_]) ordercount
				FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
				JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il ON ih.[No_]  = il.[Document No_]
				JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
				LEFT JOIN categories c on p.primaryCatCode = c.CODE AND c.primaryCat = 1
				WHERE ih.[Source Code] = ''SALES''
					AND LEN(ISNULL(ih.[Customer Source], '''')) > 0
					AND p.ACTIVE = 1 and p.isWeb = 1
					AND LEN(ih.[Web Order No_]) > 0
					AND ih.[Order Date] BETWEEN ''' + CAST(@fromDT AS VARCHAR(11)) + ''' AND ''' + CAST(@toDT AS VARCHAR(11)) + '''' +
					CASE
						WHEN LEN(ISNULL(@cat, '')) = 0 THEN ''
						WHEN @cat = 'Not Categorized' THEN ' AND c.superCat IS NULL'
						ELSE ' AND c.superCat = ''' + @cat + ''''
					END + '
				GROUP BY p.CODE, p.name, p.mfgname, qtyOnHand,
					CASE 
						WHEN c.superCat IS NULL THEN ''Not Categorized''
						ELSE c.superCat
					END, p.price,
					CASE
						WHEN p.price > 0 THEN (p.price - p.cost)/p.price
						ELSE 0
					END 
				ORDER BY ' + CAST(@orderBy AS VARCHAR(2)) + ' DESC'

	exec(@sSQL)
	
END
GO
/****** Object:  StoredProcedure [dbo].[salesByCat_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByCat_SP]
	@cat varchar(255)
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @endingWeek tinyint

	SET @today = GETDATE()
	SET @weekDay = DATEPART(WEEKDAY, @today)
	SET @endDT = DATEADD(DAY, -@weekday, @today)
	SET @startDT = DATEADD(DAY, -7, DATEADD(WEEK, -8, @endDT))
	SET @startingWeek = DATEPART(WEEK, @startDT)
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @day = DAY(@today)
	
	IF LEN(@cat) > 0
	   BEGIN		
		SELECT ISNULL(c.superCat, 'Not Categorized') category
		FROM products p LEFT JOIN categories c ON p.primaryCatCode = c.CODE
		WHERE p.active = 1
		GROUP BY c.superCat
	   END
	
	SELECT YEAR([Posting Date]) yyyy, DATEPART(WEEK, [Posting Date]) weekOfYear, CAST(dbo.getfirstDateOfWeek2([Posting Date]) AS VARCHAR(11)) dt
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
	WHERE [Posting Date] BETWEEN @startDT AND @endDT
			AND [Source Code] = 'SALES'
			AND LEN(ISNULL([Customer Source], '')) > 0
			AND [Customer Source] = 'I'
	GROUP BY YEAR([Posting Date]), DATEPART(WEEK, [Posting Date]),CAST(dbo.getfirstDateOfWeek2([Posting Date]) AS VARCHAR(11))
	ORDER BY 1, 2
		
	IF LEN(@cat) = 0
	   BEGIN
		SELECT ISNULL(c.superCat, 'Not Categorized') category,
				DATEPART(WEEK, h.[Posting Date]) weekOfYear,
				CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2)) salesTT
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
			LEFT JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
			LEFT JOIN categories c ON p.primaryCatCode = c.CODE
		WHERE h.[Posting Date] BETWEEN @startDT AND @endDT
				AND h.[Source Code] = 'SALES'
				AND LEN(ISNULL(h.[Customer Source], '')) > 0
				AND h.[Customer Source] = 'I'
				AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING', '100-REFUNDS')
		GROUP BY DATEPART(WEEK, h.[Posting Date]), dbo.getfirstDateOfWeek(DATEPART(WEEK, h.[Posting Date])), c.superCat
		UNION
		SELECT ISNULL(c.superCat, 'Not Categorized') category,
				@year,
				CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2))
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
			LEFT JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
			LEFT JOIN categories c ON p.primaryCatCode = c.CODE
		WHERE h.[Posting Date] BETWEEN '1/1/' + CAST(@year as varchar(4)) AND DATEADD(DAY, -1, @today)
				AND h.[Source Code] = 'SALES'
				AND LEN(ISNULL(h.[Customer Source], '')) > 0
				AND h.[Customer Source] = 'I'
				AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING', '100-REFUNDS')
		GROUP BY c.superCat
		UNION
		SELECT ISNULL(c.superCat, 'Not Categorized') category,
				@year-1,
				CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2))
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
			LEFT JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
			LEFT JOIN categories c ON p.primaryCatCode = c.CODE
		WHERE h.[Posting Date] BETWEEN '1/1/' + CAST((@year-1) as varchar(4)) AND DATEADD(YEAR, -1, DATEADD(DAY, -1, @today))
				AND h.[Source Code] = 'SALES'
				AND LEN(ISNULL(h.[Customer Source], '')) > 0
				AND h.[Customer Source] = 'I'
				AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING', '100-REFUNDS')
		GROUP BY c.superCat
		ORDER BY 1, 2 ASC
			
		SELECT ISNULL(c.superCat, 'Not Categorized') category, COUNT(*) prodCount
		FROM products p LEFT JOIN categories c ON p.primaryCatCode = c.CODE
		WHERE p.active = 1
		GROUP BY c.superCat
	   END
	 ELSE		
	   BEGIN		
		SELECT isnull(m.mfgName, 'NO  MFG INFO') mfgName,
				DATEPART(WEEK, h.[Posting Date]) weekOfYear,
				CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2)) salesTT
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
			LEFT JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
			LEFT JOIN categories c ON p.primaryCatCode = c.CODE
			LEFT JOIN mfg m ON m.mfgID = LEFT(l.[No_], 3) collate Latin1_General_CS_AS
		WHERE h.[Posting Date] BETWEEN @startDT AND @endDT
				AND h.[Source Code] = 'SALES'
				AND LEN(ISNULL(h.[Customer Source], '')) > 0
				AND h.[Customer Source] = 'I'
				AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING', '100-REFUNDS', 'B3')
				AND LEN(l.[No_]) > 0
				AND ISNULL(c.superCat, 'Not Categorized')  = @cat
		GROUP BY DATEPART(WEEK, h.[Posting Date]), dbo.getfirstDateOfWeek(DATEPART(WEEK, h.[Posting Date])), m.mfgName		
		ORDER BY 1, 2 ASC
	   END
END
GO
/****** Object:  StoredProcedure [dbo].[returns_synch_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Michael Shell
-- Create date: 1-31-2013
-- Description:	Pull for returns data from web to local
-- =============================================
CREATE PROCEDURE [dbo].[returns_synch_SP]
AS
BEGIN
	--Selects all new header information from remote and inserts to local
	insert into web_return_requests ([return_id]
      ,[order_id]
      ,[cust_id]
      ,[first_name]
      ,[last_name]
      ,[phone]
      ,[email]
      ,[created_on])
	select [id]
      ,[order_id]
      ,[cust_id]
      ,[first_name]
      ,[last_name]
      ,[phone]
      ,[email]
      ,[created_on] 
    from openquery(KRACK, 'select * from ci_return_request r')
	where id not in (select return_id from web_return_requests)
	
	--Selects all new item information from remote and inserts to local
	insert into web_return_requests_items
	select * from openquery(KRACK, 'select * from ci_return_request_items')
	where return_id not in (select return_id from web_return_requests_items)

END

select * from [web_return_requests]
GO
/****** Object:  StoredProcedure [dbo].[prod_Suggestion_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[prod_Suggestion_SP]
AS
BEGIN
	--Delete all inactive products
	TRUNCATE TABLE prodSuggestionToRemove

	INSERT INTO prodSuggestionToRemove
	SELECT id FROM prod_suggestion WHERE suggested_Prod not in (SELECT code FROM ProductsMIVA WHERE active = 1)

	INSERT INTO prodSuggestionToRemove
	SELECT id FROM prod_suggestion 
	WHERE code not in (SELECT code FROM ProductsMIVA WHERE active = 1) 
			AND id not in (SELECT PSID FROM prodSuggestionToRemove)

	--Clearing out current suggested products for fresh index
	TRUNCATE TABLE prod_suggestionWorktable

	INSERT INTO prod_suggestionWorktable
	SELECT DISTINCT TOP 2500 code, updatedt FROM prod_suggestion 
	ORDER BY updateDT ASC

	insert into prodSuggestionToRemove
	select id from prod_suggestion 
	WHERE code in (select code from prod_suggestionWorktable)
		and id NOT IN (select psid from prodSuggestionToRemove)

	delete from prod_suggestion WHERE id in (select PSID from prodSuggestionToRemove)
	
	UPDATE products
	SET prodSuggestionDT = NULL
	WHERE CODE IN (SELECT TOP 500 code FROM products
	WHERE prodSuggestionDT is not null
	ORDER BY prodSuggestionDT ASC)

	DECLARE @Code varchar(50), @mpn varchar(50), @mfgid varchar(3), @mfgName varchar(100), 
			@prodName varchar(250), @count smallint, @primaryCat varchar(100), @sSQL varchar(1000)
		
	DECLARE catCursor CURSOR FOR 
	SELECT code, mfgID, CASE 
			WHEN LEN(ISNULL(mpn, '')) = 0 THEN RIGHT(CODE, LEN(CODE)-4)
			ELSE MPN
		   END [MPN], mfgname, [Name], primaryCatCode
	FROM PRODUCTS 
	WHERE CODE IN (SELECT CODE FROM PRODUCTSMIVA WHERE ACTIVE = 1)
			AND code NOT IN (select distinct code from prod_suggestion)
	ORDER BY mfgid

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @Code, @mfgid, @mpn, @mfgName, @prodName, @primaryCat

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @sSQL = 'INSERT INTO prod_suggestion
			SELECT TOP 20 ''' + @Code + ''', CODE, mpn, mfgname, NAME, price, BBPrice, [image], GETDATE(), 1
			FROM products '
	    
		IF (SELECT COUNT(*) FROM products WHERE FREETEXT(mpn, @mpn) AND mfgID = @mfgid AND CODE IN (SELECT CODE FROM ProductsMIVA WHERE active = 1) AND MPN <> @mpn) > 3
		   BEGIN
			SET @sSQL = @sSQL + 'WHERE FREETEXT(mpn, ''' + @mpn + ''')'				
		   END
		ELSE	
		   BEGIN
			SET @sSQL = @sSQL + 'WHERE FREETEXT(*, ''' + replace(@prodName, '''', '''''') + ''')'
		   END
		   
		SET @sSQL = @sSQL + ' AND mfgID = ''' + @mfgid + ''' 
					AND CODE IN (SELECT CODE FROM ProductsMIVA WHERE active = 1) 
					AND MPN <> ''' + @mpn + ''' 
					AND CODE NOT IN (SELECT CODE FROM products WHERE catCode like ''%' + @primaryCat + '%'')'
		exec(@sSQL)
					
		FETCH NEXT FROM catCursor INTO @Code, @mfgid, @mpn, @mfgName, @prodName, @primaryCat
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	UPDATE products
	SET prodSuggestionDT = GETDATE()
	WHERE prodSuggestionDT IS NULL AND CODE NOT IN (SELECT DISTINCT CODE FROM prod_suggestion)
END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportTest]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImportTest]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdr_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdr
*/

--SELECT * FROM order_hdr_bkp
--DELETE FROM order_hdr_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdr



/*--COMMENTED FOR TEST PURPOSES
UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 0') 
	SET batch_id = '2';
*/
/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdrtst (customerpo, shiptocontact, shiptoemail,shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount)

SELECT * FROM openquery(MYSQLdev, '
		SELECT  id as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		ship_email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		ship_fax as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		upper(bill_email) as selltoemail,
		upper(concat(bill_fname,'' '',bill_lname)) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM katom_mm5dev.s01_OrderCharges where order_id = customerpo
         and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as method,
		(SELECT amount FROM katom_mm5dev.s01_OrderCharges where order_id = customerpo
		 and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as amount		
		FROM katom_mm5dev.s01_Orders
		order by ordertimestamp desc
		limit 4
		')

  
  UPDATE [KatomDev].[dbo].[order_hdrtst] SET phoneNo = RIGHT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdrtst] SET ccnum = dbo.StripNonNumeric(ccnum)
  
  UPDATE [KatomDev].[dbo].[order_hdrtst] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdrtst] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])

/*-- COMMENTED FOR TEST PURPOSES		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		upsold,
		quantity	
		FROM katom_mm5.s01_OrderItems
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount,
		disp_amt,
		tax_exempt
		FROM katom_mm5.s01_OrderCharges
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM katom_mm5.s01_OrderOptions
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(MYSQL, '
		SELECT order_id,
		charge_id as line_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount
		FROM katom_mm5.s01_OrderCharges
		where module_id in (1001, 186)
		and order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')
	

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 2') 
	SET batch_id = '1';

Begins the loop to pull down and parse payment information*/
	/*DECLARE @Order varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo FROM order_hdrtst --WHERE exported = 0

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparsetest @Order	
		FETCH NEXT FROM DemoCursor INTO @Order
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor*/

/*Display the gathered header information*/
SELECT * FROM order_hdrtst
/*
/*Display the gathered line item information with customer info*/
SELECT * FROM order_hdr
join order_items
ON order_id = customerpo
order by order_id

select name, attr_code, opt_code from order_options o
join order_items i 
on i.order_id = o.order_id and i.line_id = o.line_id

exec CvcImport
*/

END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportKatomRack]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImportKatomRack]
AS
BEGIN

declare @lenstring int
declare @orderid varchar(50)
declare @start int
declare @line int
declare @subcomment varchar(50)
declare @comment varchar(2000)	
declare @price decimal(10,2)

--SELECT * FROM OPENQUERY (KRACK, 'SELECT * FROM orders s where batch_id = 0') 

--Duplicate checker
DECLARE @duplicatebillphone varchar(100)
DECLARE @body varchar(1000)
SET @body = 'Potential Duplicate Orders = '
SET @duplicatebillphone = ''

DECLARE duplicateCursor CURSOR FOR 

SELECT 'KT'+cast(id as varchar) FROM OPENQUERY (KRACK, 'SELECT * FROM orders s where batch_id = 0') 
where bill_phone in (
SELECT bill_phone FROM OPENQUERY (KRACK, 'SELECT * FROM orders s where batch_id = 0') 
where bill_phone <> ''
group by bill_phone
having COUNT(*) > 1
)

OPEN duplicateCursor

FETCH NEXT FROM duplicateCursor INTO @duplicatebillphone
	
	WHILE @@FETCH_STATUS = 0
		BEGIN
		
		SET @body = @body+' '+@duplicatebillphone
	
		FETCH NEXT FROM duplicateCursor INTO @duplicatebillphone

		END

CLOSE duplicateCursor
DEALLOCATE duplicateCursor

IF @body != 'Potential Duplicate Orders = ' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients='pchesworth@katom.com; jeslinger@katom.com',	@subject='Potential Duplicate Order',	@body=@body, @body_format ='HTML', @blind_copy_recipients='katom.archive@gmail.com' END

--Fix for LL expiration year
UPDATE OPENQUERY (KRACK, 'SELECT exp_date FROM orders s where exp_date like ''%ll%''') 
		SET exp_date = replace(exp_date, 'll', '11');


UPDATE OPENQUERY (KRACK, 'SELECT * FROM orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, shiptoaddress, shiptoaddress2, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltoaddress2, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, selltocountry, selltophone, CustomerPO2, shipmethod, shipamount, pnref, respcode, ccnum, AmountSubmitted,avsaddr, avszip, cvv2match, ccexpmo, ccexpyr)

--shipmethod, shipamount,
/*		(SELECT descrip FROM orderCharges where order_id = o.id
         and type = ''SHIPPING'' limit 1) as method,
		(SELECT amount FROM orderCharges where order_id = o.id
		  limit 1) as amount,*/

SELECT * FROM openquery(KRACK, '
		SELECT  concat(''KT'',cast(o.id as char)) as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		'' '' as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_addr2) as shiptoaddress2,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (o.bill_comp <> '''', upper(o.bill_comp), upper(concat(o.bill_fname,'' '',o.bill_lname)))  as selltocustomername,
		email as selltoemail,
		left(upper(concat(o.bill_fname,'' '',o.bill_lname)),50) as selltocontact,
		upper(o.bill_addr) as selltoaddress,
		upper(o.bill_addr2) as selltoaddress2,
		upper(o.bill_city) as selltocity,
		upper(o.bill_state) as selltostate,
		o.bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		 o.bill_cntry,
		 o.bill_phone,
		 '''' as po2,
		 (SELECT descrip FROM orderCharges where order_id = o.id
         and type = ''SHIPPING'' limit 1) as method,
		(SELECT amount FROM orderCharges where order_id = o.id
		  limit 1) as amount,
		 /*,
		(select purchaseordernum from cxmlxref where orderid = o.id limit 1) as po2*/
		pay_secdat,
		resp_code,
		REPLACE(card_num, ''*'', '''') as ccnum,
		total,
		avsaddr, 
		avszip, 
		cvv2match,
		LEFT(exp_date, 2) AS expmo, 
		CONCAT(''20'', RIGHT(exp_date, 2)) AS expyear
		FROM rdn_mm5.orders o 
		where batch_id = 2')
  
--  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
  
--  UPDATE [KatomDev].[dbo].[order_hdr] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
   
UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

SELECT * FROM openquery(KRACK, '
		SELECT
		concat(''KT'',cast(order_id as char)) as order_id,
		lineID,
		product_id,
		code,
		name,
		price,
		weight,
		1 as taxable,
		0 as upsold,
		quantity	
		FROM orderItems
		where order_id in (SELECT id FROM orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

SELECT * FROM openquery(KRACK, '
		SELECT
		concat(''KT'',cast(order_id as char)) as order_id,
		charge_id as charge_id,
		0 as module_id,
		descrip as type,
		descrip,
		amount,
		amount as disp_amt,
		tax_exempt
		FROM orderCharges
		where order_id in (SELECT id FROM orders where batch_id = 2)
		and type <> ''SHIPPING''')
		


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(KRACK, '
		SELECT
		CONCAT(''KT'',cast(orderid as char)) as orderid,
		lineid,
		attrid,
		a.code as attr_code,
		cast(ifnull(s.id, o.attrid) as char) as option_id,
		0 as attmpat_id,
		left(ifnull(LEFT(CAST(CONCAT(a.prompt, '': '' ,s.code, '' $'',s.price) AS CHAR),50),concat(a.prompt, '': '' ,value)), 50) AS opt_code,
		s.price as price,
		0 as weight,
		'''' as data,
		'''' as data_long	
		FROM orderOptions o
		LEFT OUTER JOIN s01_Options s
		ON o.value = s.id
		LEFT OUTER JOIN s01_Attributes a
		ON a.id = attrid
		where orderid in (SELECT id FROM orders where batch_id = 2)
		')
		
	UPDATE
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(KRACK, '
		SELECT concat(''KT'',cast(order_id as char)) as order_id,
		0 as line_id,
		999 as option_id,
		charge_id as attr_id,
		type,
		descrip,
		amount
		FROM orderCharges
		where type <> ''TAX'' and order_id in (SELECT id FROM orders where batch_id = 2)')
		
	update order_options
	set option_id = 420
	where (opt_code like 'Shipping:%'
	or opt_code like '%gate%'
	or opt_code like '%Arrival Notification%'
	or opt_code like '%residential fee%')
	and option_id <> 420
	
	/* Verbage Fix */
	update order_hdr
	set shipmethod = 'Shipping: Free Shipping on Select Items'
	where shipmethod = 'Shipping: Free Shipping'
	
	/* Coupon Fix */
	update order_options
	set option_id = 490
	where attr_code = 'COUPON'
	
/* Comments */
DECLARE comCursor CURSOR FOR 

	SELECT * FROM openquery(KRACK, '
		SELECT CONCAT(''KT'',CAST(orderID AS CHAR)) AS order_id,
		COMMENT,
		0 as price
		FROM orderComments
		WHERE orderID IN (SELECT id FROM orders WHERE batch_id = 2) 
		and comment <> '''' 
		')

	OPEN comCursor

	FETCH NEXT FROM comCursor INTO @orderid, @comment, @price
	
	WHILE @@FETCH_STATUS = 0
	
	BEGIN
	
	SET @lenstring = LEN(@comment)
	
	SET @start = 0
	SET @LINE = 8000
	

	
	print @lenstring
		while @lenstring > 50
			begin
				set @subcomment = (substring(@comment,@start, 50))
				SET @lenstring = @lenstring-50
				SET @start = @start+50
				SET @LINE = @LINE+1
				
				INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)
				values (@orderid, 0, 0, @line, 'COMMENT', @subcomment, @price)
				
			end
			
			SET @comment = (substring(@comment,@start, 50))
			
				IF LEN(@comment) < 50
				SET @LINE = @LINE+1
					BEGIN 
						INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)
						values (@orderid, 0, 0, @line, 'COMMENT', @comment, @price)
					END

	
	FETCH NEXT FROM comCursor INTO @orderid, @comment, @price

	END

CLOSE comCursor

DEALLOCATE comCursor

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (KRACK, 'SELECT * FROM orders s where batch_id = 2') 
		SET batch_id = '1';

/*Begins the loop to pull down and parse payment information
	DECLARE @Order varchar(10)
	DECLARE @Country varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo, shiptocountry FROM order_hdr WHERE exported = 0 and shiptocountry <> 'XX'

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @Country

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparse @Order
		
		/* International Order Handling */		
		IF @Country NOT IN ('CA', 'US', 'XX')
			BEGIN
				Update order_hdr
				set shiptocity = (shiptocity+', '+shiptostate),
					shiptostate = shiptocountry,
					selltocity = (selltocity+', '+selltostate),
					selltostate = shiptocountry,
					shiptocountry = 'XX'
				where customerpo = @Order
			
				/*insert into order_items([order_id], [line_id], [product_id], [code],[name], [price], [weight], [taxable], [upsold], [quantity])
				values (@Order, 1, 999999, '', 'INTERNATIONAL ORDER', '0.00', '0', 1, 0, 0)*/
			END
							
		FETCH NEXT FROM DemoCursor INTO @Order, @Country
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor

exec CvcImport*/

UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)


--Test Order Handlers  TS1024962
update order_hdr
set customerpo = replace(customerpo, 'KT', 'TS')
where respcode = 99

update order_items
set order_id = replace(order_id, 'KT', 'TS')
where order_id in (select 'KT'+right(customerpo, 7) from order_hdr where respcode = 99)

update order_options
set order_id = replace(order_id, 'KT', 'TS')
where order_id in (select 'KT'+right(customerpo, 7) from order_hdr where respcode = 99)

insert into order_options(order_id, line_id, attr_id, attr_code, option_id, opt_code, price)
select customerpo, 0, 8999, 'COMMENT', 0, 'TEST ORDER DO NOT PROCESS', 0 from order_hdr where respcode = 99
and customerpo not in (select order_id from order_options where opt_code = 'TEST ORDER DO NOT PROCESS')

--Pilot specifications update
update order_hdr
set orderplacedby = 'PI',
paymenttermscode = 'NET 30',
CustomerSource = 'S',
selltoemail = 'NA',
selltophone = '8655887488',
customerpo = REPLACE(customerpo, 'KT', 'PI'),
CustomerPO2 = shiptoaddress2,
shiptoaddress2 = ''
where shiptocustomername = 'PILOT'
and orderplacedby <> 'PI'

update order_items
set order_id = replace(order_id, 'KT', 'PI')
where order_id in (select order_id from order_hdr where customerpo = 'PI'+RIGHT(order_id,6) or customerpo = 'PI'+RIGHT(order_id,7))

update order_hdr
set exported = 1
where customerpo in (
select order_id-- ,line_id, count(*) 
from order_items
where order_id in (
select customerpo from order_hdr
where exported = 0
)
group by order_id, line_id
having count(*) > 1
)

update order_hdr
set exported = 1
where customerpo in (
select order_id-- attr_id, count(*)
from order_options
where order_id in (
select customerpo from order_hdr
where exported = 0
)
group by order_id, attr_id
having count(*) > 1
)

--Shipping Method syntax fix added 10-17-12 MS
update order_hdr
set shipmethod = replace(shipmethod, 'Shipping: ', '')
where shipmethod not in (
'Shipping: UPS Next Day Air',
'Shipping: UPS Ground',
'Shipping: UPS 3 Day Select',
'Shipping: UPS 2nd Day Air',
'Shipping: Free Shipping on Select Items'
)
and shipmethod like '%Shipping: %'

update order_hdr
set shipmethod = 'FREIGHT TRUCK'
where shipmethod = 'FREIGHT'

update order_hdr
set shipmethod = 'TO BE DETERMINED'
where shipmethod = 'TBD'

update order_hdr
set shipmethod = 'UPS Standard Canada'
where shipmethod = 'UPS Standard'

update order_hdr
set shipmethod = 'UPS Expedited'
where shipmethod = 'UPS Worldwide Expedited'

END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportKatomDEV]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImportKatomDEV]
AS
BEGIN

declare @lenstring int
declare @orderid varchar(50)
declare @start int
declare @line int
declare @subcomment varchar(50)
declare @comment varchar(2000)	
declare @price decimal(10,2)

--SELECT * FROM OPENQUERY (KTDEV, 'SELECT * FROM orders s where batch_id = 0') 

--Fix for LL expiration year
UPDATE OPENQUERY (KTDEV, 'SELECT exp_date FROM orders s where exp_date like ''%ll%''') 
		SET exp_date = replace(exp_date, 'll', '11');


UPDATE OPENQUERY (KTDEV, 'SELECT * FROM orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, shiptoaddress, shiptoaddress2, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltoaddress2, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, selltocountry, selltophone, CustomerPO2, shipmethod, shipamount, pnref, respcode, ccnum, AmountSubmitted,avsaddr, avszip, cvv2match, ccexpmo, ccexpyr)

--shipmethod, shipamount,
/*		(SELECT descrip FROM orderCharges where order_id = o.id
         and type = ''SHIPPING'' limit 1) as method,
		(SELECT amount FROM orderCharges where order_id = o.id
		  limit 1) as amount,*/

SELECT * FROM openquery(KTDEV, '
		SELECT  concat(''KTX'',cast(o.id as char)) as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		'' '' as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_addr2) as shiptoaddress2,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (o.bill_comp <> '''', upper(o.bill_comp), upper(concat(o.bill_fname,'' '',o.bill_lname)))  as selltocustomername,
		email as selltoemail,
		left(upper(concat(o.bill_fname,'' '',o.bill_lname)),50) as selltocontact,
		upper(o.bill_addr) as selltoaddress,
		upper(o.bill_addr2) as selltoaddress2,
		upper(o.bill_city) as selltocity,
		upper(o.bill_state) as selltostate,
		o.bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		 o.bill_cntry,
		 o.bill_phone,
		 '''' as po2,
		 (SELECT descrip FROM orderCharges where order_id = o.id
         and type = ''SHIPPING'' limit 1) as method,
		(SELECT amount FROM orderCharges where order_id = o.id
		  limit 1) as amount,
		 /*,
		(select purchaseordernum from cxmlxref where orderid = o.id limit 1) as po2*/
		pay_secdat,
		resp_code,
		REPLACE(card_num, ''*'', '''') as ccnum,
		total,
		avsaddr, 
		avszip, 
		cvv2match,
		LEFT(exp_date, 2) AS expmo, 
		CONCAT(''20'', RIGHT(exp_date, 2)) AS expyear
		FROM dev.orders o 
		where batch_id = 2')
  
--  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
  
--  UPDATE [KatomDev].[dbo].[order_hdr] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
   
UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

SELECT * FROM openquery(KTDEV, '
		SELECT
		concat(''KTX'',cast(order_id as char)) as order_id,
		lineID,
		product_id,
		code,
		name,
		price,
		weight,
		1 as taxable,
		0 as upsold,
		quantity	
		FROM orderItems
		where order_id in (SELECT id FROM orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

SELECT * FROM openquery(KTDEV, '
		SELECT
		concat(''KTX'',cast(order_id as char)) as order_id,
		charge_id as charge_id,
		0 as module_id,
		descrip as type,
		descrip,
		amount,
		amount as disp_amt,
		tax_exempt
		FROM orderCharges
		where order_id in (SELECT id FROM orders where batch_id = 2)
		and type <> ''SHIPPING''')
		


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(KTDEV, '
		SELECT
		CONCAT(''KTX'',cast(orderid as char)) as orderid,
		lineid,
		attrid,
		a.code as attr_code,
		cast(ifnull(s.id, o.attrid) as char) as option_id,
		0 as attmpat_id,
		ifnull(LEFT(CAST(CONCAT(a.prompt, '': '' ,s.code, '' $'',s.price) AS CHAR),50),concat(a.prompt, '': '' ,value)) AS opt_code,
		s.price as price,
		0 as weight,
		'''' as data,
		'''' as data_long	
		FROM orderOptions o
		LEFT OUTER JOIN s01_Options s
		ON o.value = s.id
		LEFT OUTER JOIN s01_Attributes a
		ON a.id = attrid
		where orderid in (SELECT id FROM orders where batch_id = 2)
		')
		
	UPDATE
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(KTDEV, '
		SELECT concat(''KTX'',cast(order_id as char)) as order_id,
		0 as line_id,
		999 as option_id,
		charge_id as attr_id,
		type,
		descrip,
		amount
		FROM orderCharges
		where type <> ''TAX'' and order_id in (SELECT id FROM orders where batch_id = 2)')
		
	update order_options
	set option_id = 420
	where opt_code like 'Shipping:%'
	
/* Comments */
DECLARE comCursor CURSOR FOR 

	SELECT * FROM openquery(KTDEV, '
		SELECT CONCAT(''KTX'',CAST(orderID AS CHAR)) AS order_id,
		COMMENT,
		0 as price
		FROM orderComments
		WHERE orderID IN (SELECT id FROM orders WHERE batch_id = 2) 
		and comment <> '''' 
		')

	OPEN comCursor

	FETCH NEXT FROM comCursor INTO @orderid, @comment, @price
	
	WHILE @@FETCH_STATUS = 0
	
	BEGIN
	
	SET @lenstring = LEN(@comment)
	
	SET @start = 0
	SET @LINE = 8000
	

	
	print @lenstring
		while @lenstring > 50
			begin
				set @subcomment = (substring(@comment,@start, 50))
				SET @lenstring = @lenstring-50
				SET @start = @start+50
				SET @LINE = @LINE+1
				
				INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)
				values (@orderid, 0, 0, @line, 'COMMENT', @subcomment, @price)
				
			end
			
			SET @comment = (substring(@comment,@start, 50))
			
				IF LEN(@comment) < 50
				SET @LINE = @LINE+1
					BEGIN 
						INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)
						values (@orderid, 0, 0, @line, 'COMMENT', @comment, @price)
					END

	
	FETCH NEXT FROM comCursor INTO @orderid, @comment, @price

	END

CLOSE comCursor

DEALLOCATE comCursor

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (KTDEV, 'SELECT * FROM orders s where batch_id = 2') 
		SET batch_id = '1';

/*Begins the loop to pull down and parse payment information
	DECLARE @Order varchar(10)
	DECLARE @Country varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo, shiptocountry FROM order_hdr WHERE exported = 0 and shiptocountry <> 'XX'

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @Country

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparse @Order
		
		/* International Order Handling */		
		IF @Country NOT IN ('CA', 'US', 'XX')
			BEGIN
				Update order_hdr
				set shiptocity = (shiptocity+', '+shiptostate),
					shiptostate = shiptocountry,
					selltocity = (selltocity+', '+selltostate),
					selltostate = shiptocountry,
					shiptocountry = 'XX'
				where customerpo = @Order
			
				/*insert into order_items([order_id], [line_id], [product_id], [code],[name], [price], [weight], [taxable], [upsold], [quantity])
				values (@Order, 1, 999999, '', 'INTERNATIONAL ORDER', '0.00', '0', 1, 0, 0)*/
			END
							
		FETCH NEXT FROM DemoCursor INTO @Order, @Country
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor

exec CvcImport*/

UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)

--Pilot specifications update
update order_hdr
set orderplacedby = 'PI',
paymenttermscode = 'NET 30',
CustomerSource = 'S',
selltoemail = 'NA',
customerpo = REPLACE(customerpo, 'KT', 'PI')
where shiptocustomername = 'PILOT'
and orderplacedby <> 'PI'

update order_items
set order_id = replace(order_id, 'KT', 'PI')
where order_id in (select order_id from order_hdr where customerpo = 'PI'+RIGHT(order_id,6))



END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportFAB]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImportFAB]
AS
BEGIN

--See what's Coming
--SELECT * FROM OPENQUERY (RDN, 'SELECT * FROM FA_Pending s where sent = 0 and approved =''A'' and FAmemo <> ''''') 


--Batch Unsent Files
UPDATE OPENQUERY (RDN, 'SELECT * FROM FA_Pending s where sent = 0 and approved =''A'' and FAmemo <> ''''') 
SET sent = '2';


/* Imports the Order Headers based on the un-batched headers */
		INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, 
		shiptoaddress, shiptoaddress2, shiptocity, shiptostate, shiptozip, shiptocountry, 
		selltocustomername, selltoemail, selltocontact, selltoaddress, selltoaddress2, 
		selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, 
		selltocountry, selltophone, CustomerPO2, shipmethod, shipamount, 
		pnref, respcode, ccnum, AmountSubmitted,avsaddr, avszip, cvv2match, ccexpmo, ccexpyr, paymenttermscode, CustomerSource, orderplacedby)


SELECT * FROM openquery(RDN, '
		SELECT concat(''FA'',cast(b.basket_id as char)) AS customerpo, '''' AS shiptocontact, Email AS shiptoemail,  ship_comp AS shiptocustomername, billphone AS phoneno, '''' AS faxno, 
		ship_addr AS shiptoaddress, ''''as shiptoaddress2, ship_city AS shiptocity, ship_state AS shiptostate, ship_zip AS shiptozip, ship_cntry AS shiptocountry, 
		CompanyName AS selltocustomername, Email AS selltoemail, login AS selltocontact, Address1 AS selltoaddress, '''' as selltoaddress2, 
		City AS selltocity, State AS selltostate, Zip AS selltozip, NOW() AS ordertimestamp, NOW() AS batchtimestamp, 
		''US'' AS selltocountry, billphone AS selltophone, memberPO AS CustomerPO2,
		(SELECT method FROM FA_BasketCharges c WHERE b.basket_id = c.basket_id LIMIT 1) AS shipmethod, 
		(SELECT cost FROM FA_BasketCharges c WHERE b.basket_id = c.basket_id LIMIT 1) AS shipamount,
		'''' AS pnref, 0 AS respcode, 1 AS ccnum, 0 AS AmountSubmitted, '''' as avsaddr, '''' as avszip, '''' as cvv2match,
		1 as ccexpmo, 1 as ccexpyr, ''NET 30'' as paymenttermscode, ''S'' as CustomerSource, ''FA'' as orderplacedby
		FROM FA_Pending p
		JOIN FAmembers m
		ON memberid = m.id
		JOIN FA_Baskets b
		ON CAST(p.ponum AS SIGNED) = CAST(b.ponum AS SIGNED)
		JOIN FAapprovals a
		ON m.memberGroup = a.memberGroup
		WHERE approved = ''A'' and sent = 2
		and b.basket_id not in (''66812'')
		')
		order by customerpo

  
	UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
	  
	UPDATE [KatomDev].[dbo].[order_hdr] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
	   
	UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
	  
	UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(RDN, '
		SELECT CONCAT(''FA'',CAST(b.`basket_id` AS CHAR)) AS order_id, 
		line_id, product_id, CODE, NAME, price, weight, taxable, upsold, quantity
		FROM FA_BasketItems i
		JOIN FA_Baskets b
		ON b.basket_id = i.basket_id
		WHERE i.basket_id IN (SELECT b.`basket_id` FROM FA_Pending p JOIN FA_Baskets b ON CAST(p.ponum AS SIGNED) = CAST(b.ponum AS SIGNED) WHERE sent = 2)
		')
		
/* Imports the Order Charges based on the un-batched headers 
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(RDN, '
		SELECT
		concat(''BB'',cast(order_id as char)) as order_id,
		0 as charge_id,
		0 as module_id,
		''SHIPPING'' as type,
		concat(''Shipping: '',method) as descrip,
		cost as amount,
		cost as disp_amt,
		'''' as tax_exempt
		FROM orderCharges
		where order_id in (SELECT id FROM orders where batch_id = 2)')
		*/

/*Pulls down the option information based on un-batched order headers
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(RDN, '
		SELECT
		concat(''BB'',cast(order_id as char)) as order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM orderOptions
		where order_id in (SELECT id FROM orders where batch_id = 2 and attr_code <> ''recip_email'')')

		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
*/		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(RDN, '
		SELECT concat(''FA'',cast(basket_id as char)) as order_id,
		0 as line_id,
		420 as option_id,
		id as attr_id,
		''SHIPPING'' as attr_code,
		concat(''Shipping: '', method) as descrip,
		cost as price
		FROM FA_BasketCharges c
		WHERE c.basket_id IN (SELECT b.`basket_id` FROM FA_Pending p JOIN FA_Baskets b ON CAST(p.ponum AS SIGNED) = CAST(b.ponum AS SIGNED) WHERE sent = 2)')
		
	update order_options
	set option_id = 420
	where opt_code like 'Shipping:%'

/*Begins the loop to add comments and match products*/
--Insert Standard Comments
	DECLARE @ordernumber varchar(100)
	
	DECLARE faCursor CURSOR FOR 

	select * from openquery(RDN, 'SELECT CONCAT(''FA'',CAST(b.basket_id AS CHAR)) AS customerpo
		FROM FA_Pending p
		JOIN FA_Baskets b
		ON CAST(p.ponum AS SIGNED) = CAST(b.ponum AS SIGNED)
		WHERE approved = ''A'' AND sent = 2')

	OPEN faCursor

	FETCH NEXT FROM faCursor INTO @ordernumber
	
	WHILE @@FETCH_STATUS = 0
		BEGIN		
	
		insert into order_options (order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price)
		select @ordernumber, 0, 111, 'COMMENT', 999, null, 'BRING TO BOBBIEA', 0
		UNION ALL
		select @ordernumber, 0, 112, 'COMMENT', 999, null, 'BLIND SHIPMENT', 0
		UNION ALL
		select @ordernumber, 0, 113, 'COMMENT', 999, null, 'NO INVOICE NO FLYER', 0
		UNION ALL
		select @ordernumber, 0, 114, 'COMMENT', 999, null, 'NO KATOM BOX', 0
		UNION ALL
		select @ordernumber, 0, 115, 'COMMENT', 999, null, '***CHARGE SHIPPING AS ESTIMATED***', 0
		UNION ALL
		select @ordernumber, 0, 116, 'COMMENT', 999, null, 'DO NOT INVOICE BRING TO CASEY', 0
		UNION ALL
		select @ordernumber, 0, 117, 'COMMENT', 999, null, 'ONLY 1 INVOICE PER ORDER', 0
		
				--Product / Price Check
				DECLARE @incprice varchar(50)
				DECLARE @faprice varchar(50)
				DECLARE @ordercode varchar(50)
				DECLARE @prodcode varchar(50)
				DECLARE @message varchar(max)
				DECLARE @subject1 varchar(100)
				--DECLARE @ordernumber varchar(max)
				--SET @ordernumber = 'FA21730290'
				
				--if o.price <> p.fa_price = send an email
				--if p.code is null = send an email

				DECLARE ProdCursor CURSOR FOR 
				select o.code as OrderCode, p.code as ProdCode, o.price as IncPrice, p.fa_price as FAPrice
				from order_items o
				left outer join products p
				on o.code = p.code or RIGHT(p.code, len(p.code)-4) = o.code
				where product_id is null and order_id = @ordernumber
				--where order_id = 'FA21730290'

				OPEN ProdCursor

				print 'begin'
				SET @message = ''
				
				FETCH NEXT FROM ProdCursor INTO  @ordercode, @prodcode, @incprice, @faprice

					WHILE @@FETCH_STATUS = 0
					BEGIN
					
						print @incprice
						print @faprice
						print @ordercode
						print @prodcode
												
						/* Update Item Code */		
						IF @prodcode is not null 
							BEGIN
								print 'code found'
								Update order_items
								set code = @prodcode
								where code = @ordercode AND order_id = @ordernumber
							END
						
						IF @faprice <> @incprice
							BEGIN
								print 'price mismatch'
								SET @message += '<P>House Order for Merchants on Navision Order #'+@ordernumber+' has a price variance:<br/>'
								SET @message += @prodcode+' came in with price of '+@incprice+' while FAprice is set at '+@faprice+'<br/>'
						
							END
						
						IF @prodcode is null
							BEGIN
								print 'nullcode'
								SET @message += '<P>House Order for Merchants on Navision Order #'+@ordernumber+' has a product number issue:<br/>'
								SET @message += 'Product '+@ordercode+' does not exist<br/>'
								
								Update order_hdr
								set exported = 1
								where customerpo = @ordernumber
							END
						
						FETCH NEXT FROM ProdCursor INTO @ordercode, @prodcode, @incprice, @faprice
					END

				CLOSE ProdCursor

				DEALLOCATE ProdCursor
		
			IF @message <> ''
			BEGIN
				SET @subject1 = 'Attn: Bobbie - Order Issue for '+@ordernumber
				EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients='bids@katom.com; mike@katom.com; dgower@bnbequip.com', @subject=@subject1, @body=@message, @body_format ='HTML'
			END
	
	FETCH NEXT FROM faCursor INTO @ordernumber

	END

	CLOSE faCursor

	DEALLOCATE faCursor

--exec CvcImport

UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)

--Pilot specifications update
update order_hdr
set orderplacedby = 'PI',
paymenttermscode = 'NET 30',
CustomerSource = 'S',
selltoemail = 'NA'
where ccname = 'Pilot'

update order_items
set order_id = replace(order_id, 'KT', 'PI')
where order_id in (select order_id from order_hdr where customerpo = 'PI'+RIGHT(order_id,6))

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (RDN, 'SELECT * FROM FA_Pending s where sent = 2') 
	SET sent = '1';


END


/*
select * from order_items
where order_id in (select customerpo from order_hdr
where exported = 0)

select order_id, o.code as OrderCode, p.code as ProdCode, o.name as OrdName, p.name as ProdName, o.price as IncPrice, p.fa_price as FAPrice
from order_items o
left outer join products p
on o.code = p.code or RIGHT(p.code, len(p.code)-4) = o.code
where product_id is null

select * from order_hdr
where selltocustomername like '%sweet%'

select * from order_hdr
where customerpo = 'FA21730290'
order by id desc

update order_hdr
set exported = 1 where id = 108044

select * from order_items
where order_id = 'FA21730290'

select * from order_options
where order_id = 'FA21730290'

*/
GO
/****** Object:  StoredProcedure [dbo].[products_equivalent_sp]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[products_equivalent_sp]
AS
BEGIN
	truncate table products_equivalent
	insert into products_equivalent(code, equivGroup)
	SELECT CODE, EquivGrp
	FROM products
	WHERE active = 0 and len(isnull(EquivGrp, '')) > 0 and price > 500

	truncate table prodTemp
	insert into prodTemp([Equivalent Grp_], Blocked)
	select distinct equivGroup, (select COUNT(*) from products where active = 1 and EquivGrp = e.equivGroup)
	from products_equivalent e

	--REMOVING ALL EQUIVALENT PRODUCTS WHERE THERE IS NO EQUIVALENT
	delete from products_equivalent
	where equivGroup in (select [Equivalent Grp_] from prodTemp where Blocked = 0)


	--SET THE EQUIVALENT TO PRODUCT WITH ONLY ONE EQUIVALENT
	UPDATE e
	SET e.eCode = p.CODE
	FROM prodTemp pt join products p on pt.[Equivalent Grp_] = p.EquivGrp 
					 join products_equivalent e on pt.[Equivalent Grp_] = e.equivGroup
	WHERE pt.Blocked = 1 and p.ACTIVE = 1


	--SET EQUIVALENT TO THE REST OF THE PRODUCTS
	DECLARE @equivGroup VARCHAR(10), @code VARCHAR(100)

	DECLARE eCursor CURSOR FOR 
	SELECT DISTINCT equivGroup FROM products_equivalent WHERE ecode IS NULL

	OPEN eCursor
	FETCH NEXT FROM eCursor INTO @equivGroup

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SELECT TOP 1 @code = code FROM products WHERE EquivGrp = @equivGroup AND ACTIVE = 1 ORDER BY sales_last_24MO
		
		UPDATE products_equivalent SET eCode = @code WHERE equivGroup = @equivGroup
		
		FETCH NEXT FROM eCursor INTO @equivGroup
	   END

	CLOSE eCursor
	DEALLOCATE eCursor

END
GO
/****** Object:  StoredProcedure [dbo].[product_leadTime_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_leadTime_SP]
AS
BEGIN
	-- SETTING LEAD TIME FOR EACH PRODUCTS 
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([No_], [UnitPrice])
	SELECT il.[No_],
			CASE 
				WHEN ih.[Shipment Method Code] = 'PICK UP' THEN DATEDIFF(DAY, ih.[Order Date], ih.[Posting Date])
				WHEN LEN(ISNULL(u.[Pickup Date], '')) > 0 THEN DATEDIFF(DAY, ih.[Order Date], u.[Pickup Date])
				WHEN t.[Ship Date] IS NOT NULL THEN DATEDIFF(DAY, ih.[Order Date], t.[Ship Date])
				ELSE DATEDIFF(DAY, ih.[Order Date], ih.[Posting Date])
			END leadTime
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il ON  ih.[No_] = il.[Document No_]
		LEFT JOIN upsWorldShip u ON u.[Tracking Number] = ih.[Package Tracking No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN trackingInfo t ON t.[Tracking Number] = ih.[Package Tracking No_] COLLATE Latin1_General_CS_AS
	WHERE DATEDIFF(DAY, ih.[Order Date], GETDATE()) BETWEEN 3 AND 91
		AND DATEDIFF(DAY, ih.[Posting Date], GETDATE()) > 0
		AND DATEDIFF(DAY, ih.[Order Date], ih.[Posting Date]) > -1
		AND [Source Code] <> 'DELETE'
		AND LEN(il.[No_]) > 3
		AND il.[Quantity] > 0
		AND LEFT(il.[No_], 3) <> '100'
	ORDER BY 1

	INSERT INTO prodTemp([No_], [UnitPrice2])
	SELECT [No_], AVG([UnitPrice])
	FROM prodTemp
	GROUP BY [No_]

	DELETE FROM prodTemp WHERE [UnitPrice2] IS NULL
	
	--RESET PROD LEADTIME TO NULL IF THE LAST UPDATE IS OVER 30 DAYS
	UPDATE products
	SET leadTime = NULL
	WHERE active = 1 
		AND DATEDIFF(DAY, leadTimeLastUpdate, GETDATE()) > 30
		AND leadTime IS NOT NULL

	UPDATE p
	SET p.avgLeadTime = [UnitPrice2],	
		p.leadTime = 
			CASE
			 WHEN qtyOnHand > 0 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span> '
			 WHEN [unitPrice2] < 3 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span> '
			 WHEN [unitPrice2] BETWEEN 3 AND 6.99 THEN 'Typically ships within <span class="bold"> 3 - 6 business days</span> ' 
			 WHEN [unitPrice2] BETWEEN 7 AND 13.99 THEN 'Typically ships within <span class="bold"> 7 - 13 business days</span> ' 
			 ELSE 'Extended Lead Time (<span class="bold">14+ days</span>)'
			END,
		p.leadTimeLastUpdate = GETDATE()	
	FROM products p join prodTemp pt on p.CODE = pt.[No_]

	-- PULLING FULFILLMENT TIME FOR SHIP DIRECT
	DELETE FROM purchase_order_history WHERE DATEDIFF(DAY, orderDT, GETDATE()) > 91
	DELETE FROM purchase_order_history WHERE confirmed = 0

	INSERT INTO purchase_order_history
	SELECT p.[No_], p.[Buy-from Vendor No_], i.[Order Date], 
			CASE
				WHEN CHARINDEX('|', p.[Vendor Authorization No_]) > 0 THEN 
					CASE
						WHEN ISDATE(RIGHT(p.[Vendor Authorization No_], LEN(p.[Vendor Authorization No_])-CHARINDEX('|', p.[Vendor Authorization No_]))) = 1
								THEN RIGHT(p.[Vendor Authorization No_], LEN(p.[Vendor Authorization No_])-CHARINDEX('|', p.[Vendor Authorization No_]) )
						ELSE p.[Order Date]
					END
				ELSE p.[Order Date]
			END, 
			CASE
				WHEN CHARINDEX('|', p.[Vendor Authorization No_]) > 0 THEN 
					CASE
						WHEN ISDATE(RIGHT(p.[Vendor Authorization No_], LEN(p.[Vendor Authorization No_])-CHARINDEX('|', p.[Vendor Authorization No_]))) = 1 THEN 1 
						ELSE 0
					END
				ELSE 0
			END
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i ON p.[sales Order No_] = i.[Order No_]
	WHERE p.[Document Type] = 1 AND [Vendor Authorization No_] <> 'CANCEL'
		AND p.[Ship-to Name] NOT IN ('WAREHOUSE FACILITY')
		AND DATEDIFF(DAY, i.[Order Date], GETDATE()) BETWEEN 3 AND 91
		AND DATEDIFF(DAY, i.[Posting Date], GETDATE()) > 0
		AND p.[No_] NOT IN (SELECT poNum FROM purchase_order_history)
		
	INSERT INTO purchase_order_history
	SELECT p.[Order No_], p.[Buy-from Vendor No_], i.[Order Date], i.[Posting Date], 0
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i ON p.[sales Order No_] = i.[Order No_] 
	WHERE p.[Source Code] NOT IN ('DELETE') AND p.[Ship-to Name] NOT IN ('WAREHOUSE FACILITY')
		AND DATEDIFF(DAY, i.[Order Date], GETDATE()) BETWEEN 3 AND 91
		AND DATEDIFF(DAY, i.[Posting Date], GETDATE()) > 0
		AND p.[Order No_] NOT IN (SELECT poNum FROM purchase_order_history)

	DELETE FROM purchase_order_history WHERE orderDT = '1900-01-01 00:00:00.000' OR shippedDT = '1900-01-01 00:00:00.000'
	DELETE FROM purchase_order_history WHERE DATEDIFF(DAY, orderDT, shippedDT) > 180 -- ASSUMING BAD DATA
	DELETE FROM purchase_order_history WHERE DATEDIFF(DAY, orderDT, shippedDT) < 0 -- ASSUMING BAD DATA

	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([No_], [UnitPrice])
	SELECT mfgID, 
		CASE 
			WHEN STDEV(DATEDIFF(DAY, orderDT, shippedDT)) IS NULL THEN AVG(DATEDIFF(DAY, orderDT, shippedDT))
			ELSE STDEV(DATEDIFF(DAY, orderDT, shippedDT))
		END
	FROM purchase_order_history
	GROUP BY mfgid

	UPDATE m
	SET m.avgLeadTime = [unitPrice],
		m.leadTime = 
			CASE
			 WHEN [unitPrice] < 3 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span> '
			 WHEN [unitPrice] BETWEEN 3 AND 6.99 THEN 'Typically ships within <span class="bold"> 3 - 6 business days</span> '
			 WHEN [unitPrice] BETWEEN 7 AND 13.99 THEN 'Typically ships within <span class="bold"> 7 - 13 business days</span> '
			 ELSE 'Extended Lead Time (<span class="bold">14+ days</span>)'
			END,
		m.leadTimeLastUpdate = GETDATE()	
	FROM mfg m join prodTemp pt on m.mfgID = pt.[No_]
	
	
	--CALCULATING PURCHASING CYCLE
	DECLARE @vendorID VARCHAR(3), @date DATETIME, @vendID VARCHAR(3), @previousDT DATETIME

	TRUNCATE TABLE prodTemp
		
	DECLARE catCursor CURSOR FOR 
	SELECT [Buy-from Vendor No_]
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p
	WHERE p.[Source Code] NOT IN ('DELETE') 
		AND p.[Ship-to Name] IN ('WAREHOUSE FACILITY')
		AND LEN([Buy-from Vendor No_]) = 3
		AND DATEDIFF(DAY, [Posting Date], GETDATE()) < 91
	GROUP BY [Buy-from Vendor No_]
	HAVING COUNT(*) > 2

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @vendorID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @previousDT = '1/1/2000'
		
		DECLARE cCursor CURSOR FOR 
		SELECT DISTINCT [Buy-from Vendor No_], [Order Date]
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p
		WHERE p.[Source Code] NOT IN ('DELETE') 
			AND p.[Ship-to Name] IN ('WAREHOUSE FACILITY')
			AND [Buy-from Vendor No_] = @vendorID
			AND DATEDIFF(DAY, [Order Date], GETDATE()) < 91
		ORDER BY [Order Date] ASC
		
		OPEN cCursor
		FETCH NEXT FROM cCursor INTO @vendID, @date
		
		WHILE @@FETCH_STATUS = 0
		   BEGIN
			IF @previousDT <> '1/1/2000'
			   BEGIN
				INSERT INTO prodTemp([No_], UnitPrice) VALUES(@vendID, DATEDIFF(DAY, @previousDT, @date))
			   END
			
			SET @previousDT = @date	
	   
			FETCH NEXT FROM cCursor INTO @vendID, @date
		   END

		CLOSE cCursor
		DEALLOCATE cCursor	
	   
		FETCH NEXT FROM catCursor INTO @vendorID
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	INSERT INTO prodTemp([No_], UnitPrice2)
	SELECT [No_], AVG([UnitPrice])
	FROM prodTemp p JOIN mfg m on p.[No_] = m.mfgID
	GROUP BY [No_], shipDirect, leadTime

	UPDATE m
	SET m.avgPurchasingCycle = UnitPrice2,
		m.purchasingCycle = 
			CASE
			 WHEN p.UnitPrice2 < 3 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span> '
			 WHEN p.UnitPrice2 BETWEEN 3 AND 6.99 THEN 'Typically ships within <span class="bold"> 3 - 6 busines days</span> '
			 WHEN p.UnitPrice2 BETWEEN 7 AND 13.99 THEN 'Typically ships within <span class="bold"> 7 - 13 business days</span> '
			 ELSE 'Extended Lead Time (<span class="bold">14+ days</span>)'
			END,
		m.purchasingCycleDT = GETDATE()
	FROM prodTemp p JOIN mfg m on p.[No_] = m.mfgID
	WHERE p.UnitPrice2 IS NOT NULL
	
	--ADDING MFG LEADTIME INFO INTO THE PRODUCTS TABLE
	UPDATE p
	SET p.leadTime_mfg =
		CASE 
			WHEN p.specialOrder = 1 THEN  m.purchasingCycle
			WHEN m.shipDirect = 1 AND m.dropShipCapable = 1 THEN m.leadTime
			WHEN m.shipDirect = 0 AND m.dropShipCapable = 1 THEN
				CASE
					WHEN p.cost > m.dropShipMin THEN m.leadTime
					ELSE m.purchasingCycle
				END
			ELSE m.purchasingCycle
		END	
	FROM mfg m JOIN products p on m.mfgID = p.mfgID 
	where p.active = 1
	
	-- IF A VENDOR LEADTIME EXIST IN THE VENDOR TABLE.  OVERWRITE ALL MFG LEADTIME
	UPDATE p
	SET p.leadTime_mfg =	
		CASE
		 WHEN CAST(REPLACE([Lead Time Calculation], '', '') AS DECIMAL(10, 2)) < 3 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span> '
		 WHEN CAST(REPLACE([Lead Time Calculation], '', '') AS DECIMAL(10, 2)) BETWEEN 3 AND 6.99 THEN 'Typically ships within <span class="bold"> 3 - 6 business days</span> ' 
		 WHEN CAST(REPLACE([Lead Time Calculation], '', '') AS DECIMAL(10, 2)) BETWEEN 7 AND 13.99 THEN 'Typically ships within <span class="bold"> 7 - 13 business days</span> ' 
		 ELSE 'Extended Lead Time (<span class="bold">14+ days</span>)'
		END
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v 
		JOIN products p ON v.[No_] = p.mfgid COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE LEN([Lead Time Calculation]) > 0
	
	-- OVERWRITE ALL LEADTIME WITH LEADTIME PROVIDED BY MFG
	UPDATE p
	SET p.leadTime = 
				CASE p2.leadtimeID
					WHEN 1 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span> '
					WHEN 2 THEN 'Typically ships within <span class="bold"> 3 - 6 business days</span> '
					WHEN 3 THEN 'Typically ships within <span class="bold"> 7 - 13 business days</span> '
					ELSE 'Extended Lead Time (<span class="bold">14+ days</span>)'
				END
	FROM products p JOIN product_leadtime_tmp p2 ON p.CODE = p2.code
	
	UPDATE products 
	SET leadTime = 'Typically ships within <span class="bold"> 1 - 2 business days</span>'
	WHERE qtyOnHand > 0
	
	-- TEMPORARY FIX FOR LIBBEY, SET ALL LIBBEY ITEMS NOT IN STOCK TO 14+ EFFECTIVE 9/28/2012 RUN FOR 30 DAYS
	UPDATE products
	SET leadTime = 'Extended Lead Time (<span class="bold">14+ days</span>)'
	WHERE qtyOnHand = 0
		AND mfgID = 634
		AND DATEDIFF(DAY, '9/28/2012', GETDATE()) < 60;
	
	
END
GO
/****** Object:  StoredProcedure [dbo].[product_featured_HP_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_featured_HP_SP]
AS
BEGIN
	DECLARE @supercatList VARCHAR(100), @supercat VARCHAR(25)
	DECLARE @today DATETIME, @lastyear DATETIME, @sSQL VARCHAR(2000)

	SET @sSQL = ''
	SET @today = GETDATE()
	SET @lastyear = DATEADD(YEAR, -1, @today)
	SET @supercatList = 'Restaurant Equipment|Countertop|Kitchen Supplies|Residential|Janitorial|Tabletop|'

	TRUNCATE TABLE featuredProducts_HP

	WHILE CHARINDEX('|', @supercatList) > 0
	   BEGIN
		SET @supercat = LEFT(@supercatList, CHARINDEX('|', @supercatList)-1)
		SET @supercatList = RIGHT(@supercatList, LEN(@supercatList)-CHARINDEX('|', @supercatList))
		
		SET @sSQL = 'INSERT INTO featuredProducts_HP(prodCode)
					SELECT TOP ' +
						CASE @supercat
							WHEN 'Restaurant Equipment' THEN '2'
							WHEN 'Countertop' THEN '2'
							ELSE '1'
						END + ' p.CODE
					FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
						JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il ON ih.[No_]  = il.[Document No_]
						JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
						LEFT JOIN categories c on p.primaryCatCode = c.CODE AND c.primaryCat = 1
					WHERE ih.[Order Date] BETWEEN DATEADD(DAY, -45, ''' + CAST(@lastyear AS VARCHAR(11)) + ''') AND DATEADD(DAY, 45, ''' + CAST(@lastyear AS VARCHAR(11)) + ''')
						AND ih.[Source Code] = ''SALES''
						AND LEN(ISNULL(ih.[Customer Source], '''')) > 0
						AND p.ACTIVE = 1 and p.isWeb = 1
						AND LEN(ih.[Web Order No_]) > 0
						AND c.superCat = ''' + @supercat + '''
					GROUP BY p.CODE
					ORDER BY CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)) DESC'
		
		EXEC(@sSQL)
	   END	
END
GO
/****** Object:  StoredProcedure [dbo].[salesByProducts_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by products in the last 30 days
-- =============================================
CREATE PROCEDURE [dbo].[salesByProducts_SP]
AS
BEGIN
	UPDATE products
	SET sales30 = 0, sales60 = 0, sales90 = 0, sales180 = 0, sales_last_24MO = 0
	
	--CALCULATING 30 DAYS SALES DATA
	TRUNCATE TABLE products_Sales
	
	INSERT INTO products_Sales
	SELECT l.[No_], SUM(ISNULL(l.[Quantity], 0))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE DATEDIFF(DAY, h.[Posting Date], GETDATE()) < 31
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
			AND h.[Customer Source] = 'I'
	GROUP BY l.[No_]
	ORDER BY 2 DESC
	
	UPDATE p
	SET p.sales30 = ps.sales
	FROM products p join products_Sales ps on p.CODE = ps.code
	WHERE ps.sales > 0
	
	--CALCULATING 60 DAYS SALES DATA
	TRUNCATE TABLE products_Sales
	
	INSERT INTO products_Sales
	SELECT l.[No_], SUM(ISNULL(l.[Quantity], 0))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE DATEDIFF(DAY, h.[Posting Date], GETDATE()) < 61
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
			AND h.[Customer Source] = 'I'
	GROUP BY l.[No_]
	ORDER BY 2 DESC
	
	UPDATE p
	SET p.sales60 = ps.sales
	FROM products p join products_Sales ps on p.CODE = ps.code
	WHERE ps.sales > 0
	
	--CALCULATING 90 DAYS SALES DATA
	TRUNCATE TABLE products_Sales
	
	INSERT INTO products_Sales
	SELECT l.[No_], SUM(ISNULL(l.[Quantity], 0))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE DATEDIFF(DAY, h.[Posting Date], GETDATE()) < 91
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
			AND h.[Customer Source] = 'I'
	GROUP BY l.[No_]
	ORDER BY 2 DESC
	
	UPDATE p
	SET p.sales90 = ps.sales
	FROM products p join products_Sales ps on p.CODE = ps.code
	WHERE ps.sales > 0
	
	--CALCULATING 180 DAYS SALES DATA
	TRUNCATE TABLE products_Sales
	
	INSERT INTO products_Sales
	SELECT l.[No_], SUM(ISNULL(l.[Quantity], 0))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE DATEDIFF(DAY, h.[Posting Date], GETDATE()) < 181
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
			AND h.[Customer Source] = 'I'
	GROUP BY l.[No_]
	ORDER BY 2 DESC
	
	UPDATE p
	SET p.sales180 = ps.sales
	FROM products p join products_Sales ps on p.CODE = ps.code
	WHERE ps.sales > 0
	--CALCULATING 24 MONTHS SALES DATA
	TRUNCATE TABLE products_Sales
	
	INSERT INTO products_Sales
	SELECT l.[No_], SUM(ISNULL(l.[Quantity], 0))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE DATEDIFF(MONTH, h.[Posting Date], GETDATE()) < 25
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
			AND h.[Customer Source] = 'I'
	GROUP BY l.[No_]
	ORDER BY 2 DESC
	
	UPDATE p
	SET p.sales_last_24MO = ps.sales
	FROM products p join products_Sales ps on p.CODE = ps.code
	WHERE ps.sales > 0
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMFG_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMFG_SP]
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @startingYear smallint, @endingWeek tinyint,
			@mfgID varchar(3), @wk int, @sales money, @sql varchar(max), @customer varchar(20)

	SET @today = GETDATE()
	SET @weekDay = DATEPART(WEEKDAY, @today)
	SET @endDT = DATEADD(DAY, -@weekday, @today)
	SET @startDT = DATEADD(DAY, -7, DATEADD(WEEK, -8, @endDT))
	SET @startingWeek = DATEPART(WEEK, @startDT)
	SET @startingYear = DATEPART(WEEK, @startDT)
	SET @endingWeek = DATEPART(WEEK, @endDT)
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @day = DAY(@today)
	
	TRUNCATE TABLE salesByMFG
	INSERT INTO salesByMFG(MFGid, mfgName, salesGroup)
	SELECT LEFT(l.[No_], 3), v.[Name], h.[Customer Source]
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v on v.[No_] = LEFT(l.[No_], 3)
	WHERE h.[Posting Date] BETWEEN @startDT AND @endDT
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
	GROUP BY LEFT(l.[No_], 3), v.[Name], h.[Customer Source]
	ORDER BY 1, 3 ASC
	
	DECLARE catCursor CURSOR FOR  
	SELECT LEFT(l.[No_], 3), h.[Customer Source],
			DATEPART(WEEK, h.[Posting Date]) weekOfYear,
			CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2)) salesTT
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE h.[Posting Date] BETWEEN @startDT AND @endDT
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
	GROUP BY DATEPART(WEEK, h.[Posting Date]), dbo.getfirstDateOfWeek(DATEPART(WEEK, h.[Posting Date])), LEFT(l.[No_], 3), h.[Customer Source]
	ORDER BY 1, 3 ASC
	
	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @mfgID, @customer, @wk, @sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @sql = 'UPDATE salesByMFG SET wk' + CAST((@wk-@startingWeek) AS VARCHAR(2)) 
			+ ' = ' + CAST(@sales AS VARCHAR(20)) + ', hasData = 1 WHERE mfgID = ''' + @mfgID + ''' and salesGroup = ''' + @customer + ''''

		EXEC (@sql)
			
		FETCH NEXT FROM catCursor INTO @mfgID, @customer, @wk, @sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	DECLARE catCursor CURSOR FOR  
	SELECT LEFT(l.[No_], 3), h.[Customer Source],
			@year,
			CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE h.[Posting Date] BETWEEN '1/1/' + CAST(@year as varchar(4)) AND DATEADD(DAY, -1, @today)
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
	GROUP BY LEFT(l.[No_], 3), h.[Customer Source]
	UNION
	SELECT LEFT(l.[No_], 3), h.[Customer Source],
			@year-1,
			CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE h.[Posting Date] BETWEEN '1/1/' + CAST((@year-1) as varchar(4)) AND DATEADD(YEAR, -1, DATEADD(DAY, -1, @today))
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
	GROUP BY LEFT(l.[No_], 3), h.[Customer Source]
	UNION
	SELECT LEFT(l.[No_], 3), h.[Customer Source],
			@year+1,
			CAST(SUM(ISNULL(l.[Quantity], 0)*ISNULL(l.[Unit Price], 0)) as decimal(10, 2))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON l.[Document No_] = h.[No_]
	WHERE YEAR(h.[Posting Date]) = @year-1
			AND h.[Source Code] = 'SALES'
			AND LEN(ISNULL(h.[Customer Source], '')) > 0
			AND charindex('-', l.[No_]) > 0
			AND l.[No_] not like '100-%'
	GROUP BY LEFT(l.[No_], 3), h.[Customer Source]
	ORDER BY 1, 2 ASC
	
	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @mfgID, @customer, @wk, @sales

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		
		SET @sql = 'UPDATE salesByMFG SET ' + 
						CASE @wk
							WHEN (@year-1) THEN 'LYTD = ' + CAST(@sales AS VARCHAR(20)) 
							WHEN (@year+1) THEN 'LastYear = ' + CAST(@sales AS VARCHAR(20)) 
							ELSE 'YTD = ' + CAST(@sales AS VARCHAR(20)) 
						END + ', hasData = 1 WHERE mfgID = ''' + @mfgID + ''' and salesGroup = ''' + @customer + ''''

		EXEC (@sql)
			
		FETCH NEXT FROM catCursor INTO @mfgID, @customer, @wk, @sales
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	DELETE FROM salesByMFG WHERE hasData = 0
	UPDATE salesByMFG 
	SET delta = 
			CASE 
				WHEN LYTD > 0 THEN (YTD/LYTD)-1
				ELSE 100
			END,
		salesTracking = 52*YTD/@endingWeek 
	WHERE hasData = 1
	
END
GO
/****** Object:  StoredProcedure [dbo].[salesByMFG_RPT]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		David Lu
-- Create date: 03/28/2011
-- Description:	Pulling Sales Data by category or Mfg
-- =============================================
CREATE PROCEDURE [dbo].[salesByMFG_RPT]
	@orderBy varchar(255), @salesGroup varchar(50)
AS
BEGIN
	DECLARE @today datetime, @startDT datetime, @endDT datetime, @weekDay tinyint,
			@year Smallint, @month tinyint, @day tinyint, @startingWeek tinyint, @endingWeek tinyint,
			@sql VARCHAR(MAX)

	SET @today = GETDATE()
	SET @weekDay = DATEPART(WEEKDAY, @today)
	SET @endDT = DATEADD(DAY, -@weekday, @today)
	SET @startDT = DATEADD(DAY, -7, DATEADD(WEEK, -8, @endDT))
	SET @startingWeek = DATEPART(WEEK, @startDT)
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @day = DAY(@today)
		
	SELECT DATEPART(WEEK, [Posting Date]) weekOfYear, CAST(dbo.getfirstDateOfWeek(DATEPART(WEEK, [Posting Date])) AS VARCHAR(11)) dt
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]
	WHERE [Posting Date] BETWEEN @startDT AND @endDT
			AND [Source Code] = 'SALES'
			AND LEN(ISNULL([Customer Source], '')) > 0
			AND [Customer Source] = 'I'
	GROUP BY DATEPART(WEEK, [Posting Date]), dbo.getfirstDateOfWeek(DATEPART(WEEK, [Posting Date]))	
	
	SET @sql = 'SELECT mfgID, mfgName, 
				SUM(ISNULL(wk1, 0)) wk1, SUM(ISNULL(wk2, 0)) wk2, SUM(ISNULL(wk3, 0)) wk3, 
				SUM(ISNULL(wk4, 0)) wk4, SUM(ISNULL(wk5, 0)) wk5, SUM(ISNULL(wk6, 0)) wk6, 
				SUM(ISNULL(wk7, 0)) wk7, SUM(ISNULL(wk8, 0)) wk8, SUM(ISNULL(wk9, 0)) wk9,  
				SUM(ISNULL(YTD, 0)) YTD, SUM(ISNULL(LYTD, 0)) LYTD, SUM(ISNULL(lASTYEAR, 0)) lASTYEAR
			FROM salesByMFG
			WHERE salesGroup in (''' + REPLACE(@salesGroup, ', ', ''', ''') + ''')
			GROUP BY mfgID, mfgName
			'
	
	IF LEN(@orderBy) > 0
	   BEGIN
			SET @sql = @sql + 'ORDER BY YTD desc'
	   END
	
	EXEC(@sql)
END
GO
/****** Object:  StoredProcedure [dbo].[Email_trackingNotImportedToNAV]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[Email_trackingNotImportedToNAV]
AS
BEGIN
	DECLARE @date datetime, @count INT

	DECLARE @body1 VARCHAR(MAX), @email1 VARCHAR(500), @subject1 varchar(150), @bgcolor VARCHAR(500), @counter TINYINT, @subBody VARCHAR(MAX)
	 
	IF EXISTS(SELECT CAST(CAST(lastUpdateDT AS VARCHAR(11)) AS DATETIME), COUNT(*)
				FROM trackingInfo  
				WHERE NAVImported = 0
				GROUP BY CAST(CAST(lastUpdateDT AS VARCHAR(11)) AS DATETIME))
	   BEGIN
		--INITIATE TABLE
		SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
			"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
			<html xmlns="http://www.w3.org/1999/xhtml">
			<head>
			<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
			<title></title>

			<style type="text/css">
			body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
			</style>

			</head>
			<body>
			<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">	
			  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
				<td colspan="6">Products Active on Website (MIVA) but not active according to NAV</td>
			  </tr>	
			  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
				<td style="text-align:center; width: 100px;">Date</td>
				<td style="text-align:center; width: 150px;">Number of Tracking</td>
			  </tr>'
		  
		DECLARE sCursor CURSOR FOR 	
		SELECT CAST(CAST(lastUpdateDT AS VARCHAR(11)) AS DATETIME), COUNT(*)
		FROM trackingInfo  
		WHERE NAVImported = 0
		GROUP BY CAST(CAST(lastUpdateDT AS VARCHAR(11)) AS DATETIME)
		ORDER BY 1

		OPEN sCursor
		FETCH NEXT FROM sCursor INTO @date, @count

		WHILE @@FETCH_STATUS = 0
		   BEGIN	
						
			IF @counter = 1
			   BEGIN
				SET @counter = 2
				SET @bgcolor = '#FFFFFF'
			   END
			ELSE
			   BEGIN
				SET @counter = 1
				SET @bgcolor = '#bed6e9'
			   END
			
			SET @body1 = @body1 + '<tr style="background-color:' + @bgcolor + ';">
				<td align="center" >' + CAST(ISNULL(@date, '') AS VARCHAR(100)) + '</td>
				<td align="center" >' + CAST(ISNULL(@count, 0) AS VARCHAR(100)) + '</td>
			  </tr>' 		
			FETCH NEXT FROM sCursor INTO @date, @count
		   END

		CLOSE sCursor
		DEALLOCATE sCursor
					
		SET @body1 = @body1

		-- PREPPING THE EMAIL TO SEND
		SET @email1 = 'itsupport@katom.com; charley@katom.com'
		--SET @email1 = 'david@katom.com'
		SET @subject1 = 'Number of Trackings that did not get imported into NAV'

		EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	
	   END
END
GO
/****** Object:  StoredProcedure [dbo].[DUP_trakingNumberCleanup]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[DUP_trakingNumberCleanup]
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	DECLARE @trackingNum VARCHAR(100), @id int, @position varchar(100)

SET @position = ''

DECLARE lagCursor CURSOR FOR 
select Id, [Tracking Number]
from trackingInfo
where [Tracking Number] in
(select [Tracking Number] from trackingInfo group by [Tracking Number] having COUNT(*) > 1)
order by 2, 1

OPEN lagCursor
FETCH NEXT FROM lagCursor INTO @id, @trackingNum

WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @position = @trackingNum
	   begin
		delete from trackingInfo where Id = @id
	   end
	ELSE
	   BEGIN
		set @position = @trackingNum
	   END
	FETCH NEXT FROM lagCursor INTO @id, @trackingNum
   END

CLOSE lagCursor
DEALLOCATE lagCursor
	
END
GO
/****** Object:  StoredProcedure [dbo].[FrostyTrackingMailer]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[FrostyTrackingMailer] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

/*Begins the loop to pull down and parse payment information*/
	DECLARE @OuterOrder varchar(50)
	DECLARE @Order varchar(50)
	DECLARE @email varchar(50)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoadd varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @billtoname varchar(30)
	DECLARE @billtoadd varchar(30)
	DECLARE @billtocity varchar(30)
	DECLARE @billtostate varchar(10)
	DECLARE @billtozip varchar(10)
	DECLARE @phone varchar(20)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)
	DECLARE @delivereddate varchar(255)
	DECLARE @shipdate varchar(255)
	DECLARE @delivered varchar(255)
	DECLARE @emailupdate bit
	DECLARE @trackingscan varchar(255)
	DECLARE @signby varchar(255)
	DECLARE @company varchar(255)
	DECLARE @FAmemo varchar(255)
	DECLARE @FAemail varchar(255)
	
	DECLARE OuterEmailCursor CURSOR FOR
	
	select top 100 [Order No_]
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[trackingInfo] s
	on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
	left outer join [KatomDev].[dbo].shipurl x
	on x.[shipping agent code] = s.carrier
	where katomorderid <> ''
	and NOT ([Delivered] = 'True' and emailUpdate = 0)
	and emailupdate = 1
	and datediff(d, getdate(), [ship date]) > -14
	and [Bill-to Name] like 'FROSTY ACRES%'
	group by [Order No_]
	order by [Order No_] desc
		
	OPEN OuterEmailCursor
	
	FETCH NEXT FROM OuterEmailCursor INTO @OuterOrder

	WHILE @@FETCH_STATUS = 0
	BEGIN

			DECLARE DemoCursor CURSOR FOR 
			
			select top 1 [Order No_], i.[E-mail], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to county], [Ship-to post Code], 
			[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to county], [Sell-to post Code], [phone No_], 
			x.Carrier, webAddress, [tracking URL], [Delivered Date], [Ship Date], Delivered, 
			emailupdate, [tracking scan], [sign by], [Shortcut Dimension 2 Code], [Your Reference]
			FROM [KatomDev].[dbo].[invoice_backup] i
			join [KatomDev].[dbo].[trackingInfo] s
			on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
			left outer join [KatomDev].[dbo].shipurl x
			on x.[shipping agent code] = s.carrier
			where [Order No_] = @OuterOrder
			order by [Order No_] desc

			OPEN DemoCursor

			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
			@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @carrier, @webadd, @trackURL, @delivereddate,
			@shipdate, @delivered, @emailupdate, @trackingscan, @signby, @company, @FAmemo

			WHILE @@FETCH_STATUS = 0
			BEGIN
			
			
					print @Order
					print @email
					SET @email1 = @email
					IF @delivered = 'FALSE' BEGIN SET @subject1 = 'Order #'+@order+' Shipment Notification'	END
					ELSE IF @delivered = 'TRUE' BEGIN SET @subject1 = 'Order #'+@order+' Delivery Notification'	END
					ELSE IF @delivered is null BEGIN SET @subject1 = 'Order #'+@order+' Tracking Notification'	END
					ELSE BEGIN SET @subject1 = 'X' END
					print @delivered+' '+cast(@emailupdate as varchar(1))+' = '+@subject1
					
					SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
									"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
									<html xmlns="http://www.w3.org/1999/xhtml">
									<head>
									<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
									<title>E-Mail</title>

									<style type="text/css">
									html{font-family:Lucida Grande;}
									</style>

									</head>
									<body>'
					IF @company = 'KATOM' 
							BEGIN 
								SET @body1=@body1+'<a href="http://www.katom.com">
									<img width="194" height="60" title="KaTom Restaurant Supply Inc." alt="KaTom Restaurant Supply Inc." src="http://www.katom.com/Merchant2/css/sterile/seasonallogo.gif" border="0"><br />
									<span style="
									font-family:Arial;
									font-size:11px;
									font-variant:small-caps;
									font-weight:400;
									left:4px;
									letter-spacing:2px;
									margin:0;
									padding:0 0 0 1px;
									position:relative;
									top:-1px;
									text-decoration:underline
									">
									RESTAURANT SUPPLY, INC.
									</span>
									</a>' 
									
							END
					SET @body1=@body1+'<table border="0" width="632" style="font-family:Lucida Grande; font-weight:100; background:#585757;color:#fff;" cellpadding="2">
									<tr>
									<td width="10px;"></td>
									<td colspan="2">
									<br />'
			
			IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">ON ITS WAY...</span>'
			IF @delivered = 'TRUE' and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">CONGRATULATIONS...</span>'
			
					SET @body1 = @body1+'</td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td>'
						
			IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 and @company = 'KATOM' SET @body1 = @body1+'			
						<span style="color:#e9ba20; font-size:30px; font-weight:600px">Good news &mdash; your package has shipped.</span>
						<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package from <a href="http://www.katom.com" style="color:#FFF">Katom Restaurant Supply</a> is on its way.  Here''s your shipping confirmation:</p>'

			IF @delivered = 'TRUE' and @emailupdate = 1 and @company = 'KATOM' SET @body1 = @body1+'			
						<span style="color:#e9ba20; font-size:18px; font-weight:600px">The carrier has indicated that your package has been delivered.</span>'
			
			IF (@signby <> 'N/A' and @signby is not null) and @company = 'KATOM' SET @body1 = @body1+'			
						<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package was signed for by: '+@signby+'</p>'
						
					SET @body1 = @body1+'
						</td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td colspan="2"><span style="color:#e9ba20;
						font-family:lucida grande;
						font-weight:600;">ORDER NUMBER.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+@order+'</span></td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td colspan="2"><span style="color:#e9ba20;
						font-family:lucida grande;
						font-weight:600;">SHIPPING DATE.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+convert(varchar,datepart(mm,@shipdate)) + '.' + convert(varchar,datepart(dd,@shipdate)) + '.' + convert(varchar,datepart(yyyy,@shipdate))+'</span></td>
						</tr>'
						
							DECLARE TrackingCursor CURSOR FOR
							
							select [Tracking Number], [tracking url] from trackingInfo i
							left outer join [KatomDev].[dbo].shipurl x
							on x.[shipping agent code] = i.carrier
							where KatomOrderID = @order
							
							OPEN TrackingCursor
							
							FETCH NEXT FROM TrackingCursor INTO @trackno, @trackURL

							WHILE @@FETCH_STATUS = 0
							BEGIN
							
							print @order+'-'+@trackno
								
							SET @body1 = @body1+'<tr>
								<td width="10px;"></td>
								<td colspan="2"><span style="color:#e9ba20;
								font-family:lucida grande;
								font-weight:600;">TRACKING NUMBER.</span> <a href="'+REPLACE(@trackurl, '<%trackingNum%>', @trackno)+'" style="color:#FFF">'+@trackno+'</a>
								</td>
								</tr>'
								
							IF @subject1 <> 'X' Update trackingInfo set emailUpdate = 0 where [Tracking Number] = @trackno

							FETCH NEXT FROM TrackingCursor INTO @trackno, @trackurl

							END

							CLOSE TrackingCursor

							DEALLOCATE TrackingCursor
						
						
						
					SET @body1 = @body1+'</table>
						<table cellspacing="0">
						<tr height="8">
						<td>
						</td>
						</tr>
						<table>
						<tr>
						<td height="4px">
						</td>
						</tr>
						</table>
						</table>
						<table width="625" style="border-color:#000; border-style:solid; border-width:1px;">
						<tr>
						<td>
						<table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr>
						<td width="9px" style="background:#999; font-weight:600; color:#666">
						</td>
						<td colspan="2" style="background:#999; font-weight:600; color:#666; font-size:14px">
						ORDER INFORMATION
						</td>
						</tr>
						<tr>
						<td height="9px">
						</td>
						</tr>
						<tr>
						<td width="9px"></td>
						<td style="font-size:12px; font-weight:600">
						BILLING INFORMATION:
						</td>
						<td style="font-size:12px; font-weight:600">
						SHIPPING INFORMATION:
						</td>
						</tr>
						<tr>
						<td width="9px"></td>
						<td>
						<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr><td>'+@billtoname+'</td></tr>
						<tr><td>'+@billtoadd+'</td></tr>
						<tr><td>'+@billtocity+', '+@billtostate+' '+@billtozip+'</td></tr>
						<tr><td>Primary Phone: '+@phone+'</td></tr>
						<tr><td>Email: '+@email+'</td></tr>
						</table>
						</td>
						<td valign="top">
						<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr><td>'+@shiptoname+'</td></tr>
						<tr><td>'+@shiptoadd+'</td></tr>
						<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
						</table>
						</td>
						</tr>
						</table>
						</td>
						</tr>
						</tr>
						<tr>
						<td height="4px" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						Note:  Tracking information may not be available for up to 48 hours after an item is shipped.  Please do not reply to this email as it is delivered from an unmonitored address. '
						
						IF @company = 'KATOM' SET @body1 = @body1+'If you need further assistance, please <a href="http://www.katom.com/trackmyorder.php">click here</a> for help.'
						
						SET @body1 = @body1+'</td>
						</tr>
						</table>
						</body>
						</html>'
					
			print @subject1

			select top 1 @email1 = approval from openquery(RDN, 'SELECT Email, approval, FAmemo, memberPO
												FROM FA_Pending p
												JOIN FAmembers m
												ON memberid = m.id
												JOIN FAapprovals a
												ON m.membergroup = a.membergroup')
							where FAmemo = @FAmemo
							or memberPO = @FAmemo
				
			IF @billtoname like '%merchants%' BEGIN SET @email1 = 'tchandler@merchantsfoodservice.com' END
	
			IF @subject1 <> 'X' and @body1 <> ''
				BEGIN
						IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 and @company = 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'First Email sent' END
						IF upper(@delivered) = 'TRUE' and @emailupdate = 1 and @company = 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Delivered status Email Sent' END
						IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 and @company <> 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='B&B', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'First Email sent' END
						IF upper(@delivered) = 'TRUE' and @emailupdate = 1 and @company <> 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='B&B', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Delivered status Email Sent' END
					ELSE print 'no update'
				END
			
			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
			@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @carrier, @webadd, @trackURL, @delivereddate,
			@shipdate, @delivered, @emailupdate, @trackingscan, @signby, @company, @FAmemo

			END

			CLOSE DemoCursor

			DEALLOCATE DemoCursor
	
	FETCH NEXT FROM OuterEmailCursor INTO @OuterOrder

	END

	CLOSE OuterEmailCursor

	DEALLOCATE OuterEmailCursor

END
GO
/****** Object:  StoredProcedure [dbo].[fedExTracking_SP2]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[fedExTracking_SP2]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('FEDEXTracking', GETDATE())
	SET @jobID = @@identity

	--DATA CLEAN UP
	delete w
	from fedExWorktable2 w join fedExFile f on f.[Tracking Number] = REPLACE(w.[Tracking Number], '"', '')
										AND REPLACE(w.[reference], '"', '') = f.orderID
	
	INSERT INTO fedExFile([tracking Number], orderID, [timeStamp])
	SELECT DISTINCT REPLACE([Tracking Number], '"', ''), REPLACE([reference], '"', ''), GETDATE()
	FROM fedExWorktable2 
	where Delivered IS NULL
			and REPLACE([Tracking Number], '"', '') NOT IN (select [tracking Number] from fedExFile)
	ORDER BY 1
		
	TRUNCATE TABLE fedExWorktable2
		
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

END
GO
/****** Object:  StoredProcedure [dbo].[fedExTracking_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[fedExTracking_SP]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('FEDEXTracking', GETDATE())
	SET @jobID = @@identity

	DECLARE @trackingNum VARCHAR(100), @Delivered BIT, @DeliveredDT DATETIME, @Company VARCHAR(100)
	DECLARE @signBy VARCHAR(100), @shipDT DATETIME, @city VARCHAR(100), @state VARCHAR(100), @zip VARCHAR(100)
	DECLARE @reference VARCHAR(100)

	--DATA CLEAN UP

	DECLARE catCursor CURSOR FOR 
	SELECT [Tracking Number] FROM fedExWorktable GROUP BY [Tracking Number] HAVING COUNT(*) > 1

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @trackingNum

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		DELETE FROM fedExWorktable
		WHERE [Tracking Number] = @trackingNum 
			AND id <> (select max(id) from fedExWorktable where [Tracking Number] = @trackingNum)

		FETCH NEXT FROM catCursor INTO @trackingNum
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	DELETE FROM FedexTracking WHERE [Ship Date] IS NULL
	
	--UPDATING FEDEX TRACKING TABLE
	UPDATE t
	SET t.[Delivered] = w.[Delivered], 
		t.[Ship Date] = w.[Ship Date], 
		t.[Delivered Date] = w.[Delivered Date], 
		t.[Service Type] = w.[Service Type], 
		t.[Sign by] = w.[Sign by], 
		t.[Company Code] = w.[Company Code], 
		t.[Company] = w.[Company], 
		t.[Contact] = w.[Contact], 
		t.[Address 1] = w.[Address 1], 
		t.[Address 2] = w.[Address 2], 
		t.[City] = w.[City], 
		t.[State] = w.[State], 
		t.[Zip] = w.[Zip], 
		t.[Country] = w.[Country], 
		t.[Phone] = w.[Phone], 
		t.[E-Mail] = w.[E-Mail], 
		t.[Reference] = w.[Reference], 
		t.[PO Number] = w.[PO Number], 
		t.[Invoice Number] = w.[Invoice Number], 
		t.[Weight] = w.[Weight], 
		t.[Length] = w.[Length], 
		t.[Width] = w.[Width], 
		t.[Height] = w.[Height], 
		t.[Net Charge] = w.[Net Charge], 
		t.[List Charge] = w.[List Charge], 
		t.[Total Surcharge] = w.[Total Surcharge], 
		t.[Tracking Scan] = w.[Tracking Scan], 
		t.[COD Surcharge] = w.[COD Surcharge], 
		t.[Declared Value Surcharge] = w.[Declared Value Surcharge], 
		t.[Fuel Surcharge] = w.[Fuel Surcharge], 
		t.[Delivery Area Surcharge] = w.[Delivery Area Surcharge], 
		t.[Residential Surcharge] = w.[Residential Surcharge], 
		t.[Saturday Delivery Surcharge] = w.[Saturday Delivery Surcharge], 
		t.[Signature Surcharge] = w.[Signature Surcharge], 
		t.[Last Scan Code] = w.[Last Scan Code], 
		t.[Delivery Attempts] = w.[Delivery Attempts], 
		t.[lastUpdateDT] = GETDATE(),  
		t.[emailUpdate] =		
		CASE 
			WHEN t.[Delivered] = 'False' AND w.[Delivered] = 'True' THEN 1
			WHEN t.[Tracking Scan] like '%On FedEx vehicle for delivery%' THEN 1
			ELSE 0
		END
	FROM FedexTracking t JOIN fedExWorktable w ON t.[Tracking Number] = w.[Tracking Number]
	WHERE t.[Tracking Scan] <> w.[Tracking Scan]
		and t.[Tracking Scan] <> w.[Tracking Scan]
		
	UPDATE t
	SET t.[Reference] = w.[Reference],
		t.[PO Number] = w.[PO Number]
	FROM FedexTracking t JOIN fedExWorktable w ON t.[Tracking Number] = w.[Tracking Number]
	WHERE (t.[Reference] <> w.[Reference] OR t.[PO Number] = w.[PO Number])
			AND t.katomOrderId is NULL

	--INSERT NEW TRACKING RECORD
	INSERT INTO FedexTracking ([Tracking Number], [Delivered], [Ship Date], [Delivered Date], [Service Type], 
	[Sign by], [Company Code], [Company], [Contact], [Address 1], [Address 2], [City], [State], 
	[Zip], [Country], [Phone], [E-Mail], [Reference], [PO Number], [Invoice Number], [Weight], 
	[Length], [Width], [Height], [Net Charge], [List Charge], [Total Surcharge], [Tracking Scan], 
	[COD Surcharge], [Declared Value Surcharge], [Fuel Surcharge], [Delivery Area Surcharge], 
	[Residential Surcharge], [Saturday Delivery Surcharge], [Signature Surcharge], [Last Scan Code], 
	[Delivery Attempts], [lastUpdateDT], [stopEmailRequest], [emailUpdate])
	SELECT [Tracking Number], [Delivered], [Ship Date], [Delivered Date], [Service Type], 
	[Sign by], [Company Code], [Company], [Contact], [Address 1], [Address 2], [City], [State], 
	[Zip], [Country], [Phone], [E-Mail], [Reference], [PO Number], [Invoice Number], [Weight], 
	[Length], [Width], [Height], [Net Charge], [List Charge], [Total Surcharge], [Tracking Scan], 
	[COD Surcharge], [Declared Value Surcharge], [Fuel Surcharge], [Delivery Area Surcharge], 
	[Residential Surcharge], [Saturday Delivery Surcharge], [Signature Surcharge], [Last Scan Code], 
	[Delivery Attempts], GETDATE(), 0, 1
	FROM fedExWorktable
	WHERE [Tracking Number] NOT IN (SELECT [Tracking Number] FROM FedexTracking)

	--MATCHING WITH ORDER ID FROM NAVISION
	UPDATE f
	SET f.KatomOrderID = i.[Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i 
		ON f.[Reference] = i.[No_] COLLATE Latin1_General_CS_AS
	WHERE f.KatomOrderID IS NULL and toKatom = 0

	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f 
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p 
				ON f.[PO Number]= p.[Order No_] COLLATE Latin1_General_CS_AS
							AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]
	WHERE f.KatomOrderID IS NULL AND LEN(P.[Sales Order No_]) > 0 and toKatom = 0

	UPDATE f
	SET f.KatomOrderID = i.[Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i 
		ON f.[Reference] = i.[Order No_] COLLATE Latin1_General_CS_AS
				AND LEFT(f.[Zip], 5) = LEFT(i.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
	WHERE f.KatomOrderID IS NULL and toKatom = 0

	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f 
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p 
				ON f.[PO Number]= p.[Order No_] COLLATE Latin1_General_CS_AS
							AND LEFT(f.[Company], 5) = LEFT(p.[Ship-to Name], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]
	WHERE f.KatomOrderID IS NULL AND LEN(P.[Sales Order No_]) > 0 and toKatom = 0

	UPDATE f
	SET f.KatomOrderID = i.[Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i 
		ON f.[Reference] = i.[Order No_] COLLATE Latin1_General_CS_AS
				AND LEFT(f.[Company], 5) = LEFT(i.[Ship-to Name], 5) COLLATE Latin1_General_CS_AS
	WHERE f.KatomOrderID IS NULL and toKatom = 0
			
	UPDATE f
	SET f.KatomOrderID = i.[Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f 
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			ON f.[PO Number] = i.[Order No_] Collate Latin1_General_CS_AS
				AND LEFT(f.[Zip], 5) = LEFT(i.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
	WHERE f.KatomOrderID IS NULL and toKatom = 0
	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f 
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p 
			ON f.[PO Number]= p.[No_] COLLATE Latin1_General_CS_AS
					AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			ON P.[Sales Order No_] = i.[Order No_]
	WHERE f.KatomOrderID IS NULL AND LEN(P.[Sales Order No_]) > 0 and toKatom = 0
	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM FedexTracking f 
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p 
			ON f.[Reference]= p.[No_] COLLATE Latin1_General_CS_AS
					AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			ON P.[Sales Order No_] = i.[Order No_]
	WHERE f.KatomOrderID IS NULL AND LEN(P.[Sales Order No_]) > 0 and toKatom = 0
	
	UPDATE f
	SET f.KatomOrderID = i.[Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1
	FROM fedexTracking f join fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			ON i.[Order No_] = RIGHT(Reference, 6) COLLATE SQL_Latin1_General_CP1_CI_AS
					AND LEFT(f.[Zip], 5) = LEFT(i.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS				
	WHERE ISNUMERIC(RIGHT(reference, 6)) = 1 
			AND CHARINDEX(' ', Reference) > 0
			and katomorderid is null and toKatom = 0
	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM fedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p 
				ON RIGHT(Reference, 6)= p.[Order No_] COLLATE Latin1_General_CS_AS
							AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]							
	WHERE ISNUMERIC(RIGHT(reference, 6)) = 1 
			AND CHARINDEX(' ', Reference) > 0
			and katomorderid is null and toKatom = 0
	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM fedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p
				ON RIGHT(Reference, 6)= p.[No_] COLLATE Latin1_General_CS_AS
							AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]							
	WHERE ISNUMERIC(RIGHT(reference, 6)) = 1 
			AND CHARINDEX(' ', Reference) > 0
			and katomorderid is null and toKatom = 0
	truncate table fedExWorktable
	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM fedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p 
		ON p.[Order No_] = REPLACE(f.Reference, 'PO#', '') COLLATE SQL_Latin1_General_CP1_CI_AS
				AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]	
	WHERE ISNUMERIC(RIGHT(reference, 6)) = 1 
			AND CHARINDEX('PO#', Reference) > 0
			AND f.KatomOrderID IS NULL AND toKatom = 0	
	
	UPDATE f
	SET f.KatomOrderID = P.[Sales Order No_],
		f.KatomInvoiceID = i.[No_],
		f.[lastUpdateDT] = GETDATE(),
		f.[emailUpdate] = 1	
	FROM fedexTracking f JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p 
		ON p.[No_] = REPLACE(f.Reference, 'PO#', '') COLLATE SQL_Latin1_General_CP1_CI_AS
				AND LEFT(f.[Zip], 5) = LEFT(p.[Ship-to Post Code], 5) COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
				ON P.[Sales Order No_] = i.[Order No_]	
	WHERE ISNUMERIC(RIGHT(reference, 6)) = 1 
			AND CHARINDEX('PO#', Reference) > 0
			AND f.KatomOrderID IS NULL AND toKatom = 0			
		
		
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

END
GO
/****** Object:  StoredProcedure [dbo].[feedGooglebase_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[feedGooglebase_SP]
	@actionType TINYINT
AS
BEGIN


IF @actionType = 1
	BEGIN
		DECLARE @jobID INT
		INSERT INTO jobHistory(jobName, startdT) values('GOOGLEBASE_NEW_FEED', GETDATE())
		SET @jobID = @@identity

		TRUNCATE TABLE feed_googlebase

		INSERT INTO feed_googlebase ([id], [title], [description], [google_product_category], [link], [image_link], 
									 [condition], [price], [sale_price], [brand], [mpn], [shipping], [shipping_weight], 
									 [adWords_grouping], [adwords_labels], [adwords_redirect], [product_type], 
									 [expiration_date], [Code])
		SELECT LOWER(REPLACE([dbo].[RemoveNonAlphaNumericCharacters](m.mfgShortName), ' ', '') + '-' + RIGHT(p.code, LEN(p.code)-4)) id,
			ISNULL(m.mfgShortName, '') + ' ' + ISNULL(p.mpn, '') + ' ' + ISNULL(p.name, '') [title],
			CASE 
				WHEN LEN(ISNULL(extendedDescription, '')) = 0 THEN CAST(p.prodDesc AS VARCHAR(MAX))
				ELSE extendedDescription
			END + ' (' + '%CODE%' + ')' [description],	
			dbo.cleaner(ISNULL(ce.google, 'Home & Garden > Kitchen & Dining')) [google_product_category],
			'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '.html?CID=GoogleBase3&amp;utm_source=googlebase3&amp;utm_medium=CSE&amp;utm_campaign=CSE&amp;zmam=29342707&amp;zmas=1&amp;zmac=1&amp;zmap=' + p.code [link],
			'http://' + p.mfgid + '.katomcdn.com/' + LOWER(p.image) + '_large.jpg'  [image_link],
			'New' Condition,
			p.listPrice price,		
			CASE
				WHEN ISNULL(p.map, 0) = 1 THEN 
					CASE 
						WHEN ISNULL(p.feedMap, 0) = 1 THEN 
							CASE
								WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN CAST(p.price AS DECIMAL(10, 2))
								ELSE CAST(p.map_price AS DECIMAL(10, 2))
							END
						ELSE CAST(p.price AS DECIMAL(10, 2))
					END
				ELSE CAST(p.price AS DECIMAL(10, 2))
			END [sale_price],
			dbo.cleaner(ISNULL(m.mfgName, '')) [brand],
			REPLACE(dbo.[googleBaseMPNcleaner](p.mpn), '&', '-') mpn,
			CASE p.freeshipping
				WHEN '1' THEN 1 
				WHEN 'T' THEN 1 
				ELSE 0 
			END [shipping],
			p.weight [weight],
			dbo.cleaner(ISNULL(c.superCat, 'uncat')) [Adwords_Grouping], 
			dbo.cleaner(ISNULL(c.CATNAME, 'uncat')) [adwords_labels],
			'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '?utm_source=googlebase3&amp;utm_medium=Adwords&amp;utm_campaign=CSE&amp;CID=GoogleBase3&amp;zmam=29342707&amp;zmas=1&amp;zmac=32&amp;zmap=' + p.code [adwords_redirect],
			ISNULL(dbo.cleaner(c.breadcrumb), 'Restaurant Supplies') [product_type],	
			CAST(MONTH(DATEADD(DAY, 14, GETDATE())) AS VARCHAR(2)) + '/' + 
			CAST(DAY(DATEADD(DAY, 14, GETDATE())) AS VARCHAR(2)) + '/' + 
			CAST(YEAR(DATEADD(DAY, 14, GETDATE())) AS VARCHAR(4)) [expiration_date],
			p.CODE
		FROM products p JOIN mfg m ON p.mfgID = m.mfgID
						LEFT JOIN categories c ON c.CODE = p.primaryCatCode AND c.primaryCat = 1
						LEFT JOIN cseCatMapping ce ON ce.catCode = p.primaryCatCode
		WHERE p.ACTIVE = 1 
			AND p.isWeb = 1 
			AND p.mfgid NOT IN ('599')
			AND ISNULL(MAP_Program, '') NOT IN ('X')
			AND ISNULL(feedMAP, 1) NOT IN (3) 
			AND ISNULL(p.price, 0) > 0 
			
		--ADDING SUPPLEMENT PROD
		INSERT INTO feed_googlebase ([id], [title], [description], [google_product_category], [link], [image_link], 
									 [condition], [price], [sale_price], [brand], [mpn], [shipping], [shipping_weight], 
									 [adWords_grouping], [adwords_labels], [adwords_redirect], [product_type], 
									 [expiration_date], [Code])
		SELECT DISTINCT
			cast(p.mfgid as varchar(10)) + '-' + [dbo].[googleBaseMPNcleaner](p.mpn) [id],		
			g.title [title],
			CAST(p.prodDesc AS VARCHAR(MAX)) + ' (' + '%CODE%' + ')' [description],
			g.google_product_category [google_product_category],
			'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '.html?CID=GoogleBase2&amp;utm_source=googlebase2&amp;utm_medium=CSE&amp;utm_campaign=CSE&amp;zmam=29342707&amp;zmas=1&amp;zmac=1&amp;zmap=' + p.code [link],
			g.image_link  [image_link],		
			'New' [condition],	
			g.sale_price [price],
			NULL [sale_price],	
			g.brand [brand],	
			dbo.cleaner(REPLACE(REPLACE(ISNULL(m.mfgShortName, ''), ' ', '-'), '.', ''))
				+ '-' + REPLACE(dbo.[googleBaseMPNcleaner](p.mpn), '&', '-') [mpn],
			g.shipping [shipping],
			g.shipping_weight [weight],
			g.adWords_grouping [Adwords_Grouping], 
			g.adwords_labels [adwords_labels],
			'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '?utm_source=googlebase2&amp;utm_medium=Adwords&amp;utm_campaign=CSE&amp;CID=GoogleBase2&amp;zmam=29342707&amp;zmas=1&amp;zmac=32&amp;zmap=' + p.code [adwords_redirect],
			g.product_type [product_type],	
			g.expiration_date [expiration_date],
			p.code
		FROM products p JOIN feed_googlebase g on p.CODE = g.Code
						LEFT JOIN mfg m ON p.mfgid = m.mfgid
		WHERE (CHARINDEX('-', p.mpn) > 0 
					OR CHARINDEX('.', p.mpn) > 0 
					OR CHARINDEX(' ', p.mpn) > 0 
					OR CHARINDEX('&', p.mpn) > 0 
					OR CHARINDEX('/', p.mpn) > 0)

		UPDATE feed_googlebase 
		SET id = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(id, '(', ''), ')', ''), '/', ''), '&', ''), ' ', '-')

		DELETE FROM feed_googlebase 
		WHERE id IN 
			(
			SELECT id FROM feed_googlebase
			GROUP BY id
			HAVING COUNT(*) > 1
			)

		-- SHRINKING TITLE TO 70 CHARACTERS & MOVING ORIGINAL TITLE TO PROD DESC
		UPDATE feed_googlebase 
		SET [description] = title + '. ' + [description] ,
			title = LTRIM(RTRIM(LEFT(title, 70))), 
			titleChange = 1 
		WHERE LEN(title) > 70

		WHILE EXISTS(SELECT id FROM feed_googlebase WHERE titlechange = 1 AND LEN(title) > 70 AND dbo.isAlphaNumberic(RIGHT(title, 1)) = 0 )	
			BEGIN
				UPDATE feed_googlebase 
				SET title = RTRIM(LEFT(title, LEN(title)-1))
				WHERE LEN(title) > 70 
					AND dbo.isAlphaNumberic(RIGHT(title, 1) ) = 0
					AND titlechange = 1 
			END

		-- UPDATE ATTRIBUTE INFORMATION FOR CLOTHING
		UPDATE g
		SET g.size = pa.value
		FROM feed_googlebase g JOIN products_Attributes_Supplement pa ON g.Code = pa.code
		WHERE pa.name = 'size'

		UPDATE g
		SET g.color = pa.value
		FROM feed_googlebase g JOIN products_Attributes_Supplement pa ON g.Code = pa.code
		WHERE pa.name = 'color'

		UPDATE g
		SET g.age_group = pa.value
		FROM feed_googlebase g JOIN products_Attributes_Supplement pa ON g.Code = pa.code
		WHERE pa.name = 'age_group'

		UPDATE g
		SET g.gender = pa.value
		FROM feed_googlebase g JOIN products_Attributes_Supplement pa ON g.Code = pa.code
		WHERE pa.name = 'gender'

		UPDATE feed_googlebase SET [description] = dbo.[googleBasecleaner]([description]) WHERE [description] like '%<%'

		UPDATE feed_googlebase SET [description] = REPLACE([description], '%CODE%', brand + ' ' + MPN), title = dbo.cleaner(title)

		UPDATE feed_googlebase SET [description] = dbo.cleaner([description])

		UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
	END
ELSE
	BEGIN
		SELECT id, title, [description], google_product_category, link, image_link, condition, 
				price, sale_price, brand, MPN, shipping, shipping_weight, adwords_grouping, adwords_labels, 
				adwords_redirect, product_type, expiration_date, size, color, age_group, gender
		FROM feed_googlebase
		ORDER BY id 
	END
END
GO
/****** Object:  StoredProcedure [dbo].[hourly_open_order_status_old]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[hourly_open_order_status_old]
AS
BEGIN
	DECLARE @salesTT_SD MONEY, @orderTT_SD INT, @salesTT MONEY, @orderTT INT,
		@salesTT_SD_Miva MONEY, @orderTT_SD_Miva INT, @salesTT_Miva MONEY, @orderTT_Miva INT,
		@salesTT_SD_Printed MONEY, @orderTT_SD_Printed INT, @salesTT_Printed MONEY, @orderTT_Printed INT,
		@salesTT_SD_CCDeclined MONEY, @orderTT_SD_CCDeclined INT, @salesTT_CCDeclined MONEY, @orderTT_CCDeclined INT,
		@salesTT_PO MONEY, @orderTT_PO INT,
		@salesTT_SD_INV MONEY, @orderTT_SD_INV INT, @salesTT_INV MONEY, @orderTT_INV INT, @today DATETIME
	
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150), @fontColor varchar(50)
	
	SET @today = GETDATE()
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>E-Mail</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 12px; vertical-align: top; }
	</style>

	</head>
	<body>
	<H2>Internet Open Orders as of ' + CONVERT(VARCHAR(20), @today, 0) + '</H2>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		   <td width="75">&nbsp;</td>
		<td style="text-align:center; width: 100px;">Orders</td>
		<td style="text-align:center; width: 100px;">from MIVA</td>
		<td style="text-align:center; width: 100px;">Printed</td>
		<td style="text-align:center; width: 100px;">PO Created</td>
		<td style="text-align:center; width: 100px;">CC Declined</td>
		<td style="text-align:center; width: 100px;">Invoiced</td>
	  </tr>'
	  		
	--Ship Direct
	SELECT 
		--@salesTT_SD = CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		@salesTT_SD = CAST(ISNULL(SUM(il.[Line Amount]), 0) as decimal(10, 2)),
		@orderTT_SD = COUNT(distinct ISNULL(x.[No_], 0))		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, [Order Date], @today) = 0
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEN(il.[No_]) > 0
		AND LEFT(il.[No_], 3) IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)
		AND il.[No_] NOT IN (
					select [No_]
					from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					)
		
	--non-ship Direct
	SELECT 
		--@salesTT =CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		@salesTT = CAST(ISNULL(SUM(il.[Line Amount]), 0) as decimal(10, 2)),
		@orderTT = COUNT(distinct ISNULL(x.[No_], 0))		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, [Order Date], @today) = 0
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEN(il.[No_]) > 0
		AND (LEFT(il.[No_], 3) NOT IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)	
			OR il.[No_] IN (
					select [No_]
					from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					))
	
	--miva import - Ship Direct orders
	select @salesTT_SD_Miva = ISNULL(SUM(price*quantity), 0), 
		   @orderTT_SD_Miva = COUNT(distinct customerpo) 
	from order_hdr o JOIN order_items i ON o.customerpo = i.order_id 
	where DATEDIFF(day, ordertimestamp, @today) = 0
		AND LEFT(i.code, 3) IN (select mfgid from mfg where Active = 1 and shipDirect = 1)		
		AND i.code NOT IN (
					select [No_] collate SQL_Latin1_General_CP1_CI_AS
					from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					)
							
	--miva import - non ship direct orders
	select @salesTT_Miva = ISNULL(SUM(price*quantity), 0), 
		   @orderTT_Miva = COUNT(distinct customerpo) 
	from order_hdr o JOIN order_items i ON o.customerpo = i.order_id 
	where DATEDIFF(day, ordertimestamp, @today) = 0
		AND (LEFT(i.code, 3) NOT IN (select mfgid from mfg where Active = 1 and shipDirect = 1)
			OR i.code IN (
					select [No_] collate SQL_Latin1_General_CP1_CI_AS
					from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					))
					
	--printed ticket - Ship Direct
	SELECT 
		--@salesTT_SD_Printed = CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		@salesTT_SD_Printed = CAST(ISNULL(SUM(il.[Line Amount]), 0) as decimal(10, 2)),
		@orderTT_SD_Printed = COUNT(distinct ISNULL(x.[No_], 0))		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, [Order Date], @today) = 0
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND ih.[Customer Source] = 'I'
		AND ih.[No_ Printed] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEFT(il.[No_], 3) IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)		
		AND LEN(il.[No_]) > 0
		AND il.[No_] NOT IN (
					select [No_]
					from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					)
					
	--printed ticket
	SELECT 
		--@salesTT_Printed = CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		@salesTT_Printed = CAST(ISNULL(SUM(il.[Line Amount]), 0) as decimal(10, 2)),
		@orderTT_Printed = COUNT(distinct ISNULL(x.[No_], 0))		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, [Order Date], @today) = 0
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND ih.[Customer Source] = 'I'
		AND ih.[No_ Printed] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEN(il.[No_]) > 0
		AND (LEFT(il.[No_], 3) NOT IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)	
			OR il.[No_] IN (
					select [No_]
					from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					))
		
	--PO Processed
	select @orderTT_PO = count(distinct h.[No_]), @salesTT_PO = ISNULL(sum(distinct l.Amount), 0)
	from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] h
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Line] l ON h.[No_] = l.[Document No_]
	where h.[Ship-to Name] <> 'WAREHOUSE FACILITY' and LEN(ISNULL(l.[No_], '')) > 0 
			and l.Amount > 0 and l.[No_] not in ('555', '540', '205')
			and DATEDIFF(day, h.[Order Date], @today) = 0
	
	IF @orderTT_SD_Printed < @orderTT_SD
		SET @fontColor = 'style="color:#FF0000; font-weight: bold;"'
	ELSE 
		SET @fontColor = ''
	
	SET @body1 = @body1 + ' <tr>
		<td>Ship Direct</td>
		<td align="center" >' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT_SD, 0), 1), CHARINDEX('.', @salesTT_SD)) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT_SD, 0), 1) + ')</td>
		<td align="center" >' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT_SD_Miva, 0), 1), CHARINDEX('.', @salesTT_SD_Miva)) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT_SD_Miva, 0), 1) + ')</td>
		<td align="center" ' + @fontColor + '>' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT_SD_Printed, 0), 1), CHARINDEX('.', @salesTT_SD_Printed)) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT_SD_Printed, 0), 1) + ')</td>
		<td align="center" >' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT_PO, 0), 1), CHARINDEX('.', @salesTT_PO)) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT_PO, 0), 1) + ')</td>
		<td align="center" >N/A</td>
		<td align="center" >N/A</td>
	</tr>'
	
	IF @orderTT_Printed < @orderTT
		SET @fontColor = 'style="color:#FF0000; font-weight: bold;"'
	ELSE 
		SET @fontColor = ''
		
	SET @body1 = @body1 + '<tr>
		<td>All Others</td>
		<td align="center" >' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT, 0), 1), CHARINDEX('.', @salesTT)) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT, 0), 1) + ')</td>
		<td align="center" >' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT_Miva, 0), 1), CHARINDEX('.', @salesTT_Miva)) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT_Miva, 0), 1) + ')</td>
		<td align="center" ' + @fontColor + '>' + '$' + LEFT(CONVERT(varchar(50), ROUND(@salesTT_Printed, 0), 1), CHARINDEX('.', @salesTT_Printed))  + ' (' + CONVERT(varchar(50), ISNULL(@orderTT_Printed, 0), 1) + ')</td>
		<td align="center" >0</td>
		<td align="center" >N/A</td>
		<td align="center" >N/A</td>
	</tr></table>'
	
	SET @body1 = @body1 + '<H2>Overall Performance</H2>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		   <td width="100">&nbsp;</td>
		<td style="text-align:center; width: 120px;">Invoiced</td>
		<td style="text-align:center; width: 120px;">Open</td>
	  </tr>'
	
	DECLARE @iInvoiced VARCHAR(50), @iSales VARCHAR(50), @cInvoiced VARCHAR(50), @cSales VARCHAR(50),
			@sInvoiced VARCHAR(50), @sSales VARCHAR(50), @bInvoiced VARCHAR(50), @bSales VARCHAR(50),
			@gInvoiced VARCHAR(50), @gSales VARCHAR(50), @uInvoiced VARCHAR(50), @uSales VARCHAR(50),
			@tInvoiced VARCHAR(50), @tSales VARCHAR(50)
	
	SELECT @iInvoiced = ISNULL([InternetInvoiced], '0 (0)'), 
			@iSales = ISNULL([InternetSales], '0 (0)'), 
			@cInvoiced = ISNULL([CatalogInvoiced], '0 (0)'), 
			@cSales = ISNULL([CatalogSales], '0 (0)'), 
			@sInvoiced = ISNULL([SalesmenInvoiced], '0 (0)'), 
			@sSales = ISNULL([SalesmenSales], '0 (0)'), 
			@bInvoiced = ISNULL([BidInvoiced], '0 (0)'), 
			@bSales = ISNULL([BidSales], '0 (0)'), 
			@gInvoiced = ISNULL([GSAInvoiced], '0 (0)'), 
			@gSales = ISNULL([GSASales], '0 (0)'), 
			@uInvoiced = ISNULL([UnknownInvoiced], '0 (0)'), 
			@uSales = ISNULL([UnknownSales], '0 (0)'), 
			@tInvoiced = ISNULL([TotalInvoiced], '0 (0)'), 
			@tSales = ISNULL([TotalSales], '0 (0)')
	FROM salesStat30Days
	WHERE DATEDIFF(DAY, [Date], GETDATE()) = 0
	
	SET @body1 = @body1 + '
	  <tr>
		<td width="75">Internet</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@iInvoiced, charindex('(', @iInvoiced)-1) AS MONEY), 0), 1), charindex('.', @iInvoiced)) + right(@iInvoiced, len(@iInvoiced)-charindex('(', @iInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@iSales, charindex('(', @iSales)-1) AS MONEY), 0), 1), charindex('.', @iSales)) + right(@iSales, len(@iSales)-charindex('(', @iSales)+2) + '</td>
	  </tr>
	  <tr>
		<td width="75">Catalog</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@cInvoiced, charindex('(', @cInvoiced)-1) AS MONEY), 0), 1), charindex('.', @cInvoiced)) + right(@cInvoiced, len(@cInvoiced)-charindex('(', @cInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@cSales, charindex('(', @cSales)-1) AS MONEY), 0), 1), charindex('.', @cSales)) + right(@cSales, len(@cSales)-charindex('(', @cSales)+2) + '</td>
	  </tr>
	  <tr>
		<td width="75">Outside Sales</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@sInvoiced, charindex('(', @sInvoiced)-1) AS MONEY), 0), 1), charindex('.', @sInvoiced)) + right(@sInvoiced, len(@sInvoiced)-charindex('(', @sInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@sSales, charindex('(', @sSales)-1) AS MONEY), 0), 1), charindex('.', @sSales)) + right(@sSales, len(@sSales)-charindex('(', @sSales)+2) + '</td>
	  </tr>
	  <tr>
		<td width="75">Bid</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@bInvoiced, charindex('(', @bInvoiced)-1) AS MONEY), 0), 1), charindex('.', @bInvoiced)) + right(@bInvoiced, len(@bInvoiced)-charindex('(', @bInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@bSales, charindex('(', @bSales)-1) AS MONEY), 0), 1), charindex('.', @bSales)) + right(@bSales, len(@bSales)-charindex('(', @bSales)+2) + '</td>
	  </tr>
	  <tr>
		<td width="75">GSA</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@gInvoiced, charindex('(', @gInvoiced)-1) AS MONEY), 0), 1), charindex('.', @gInvoiced)) + right(@gInvoiced, len(@gInvoiced)-charindex('(', @gInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@gSales, charindex('(', @gSales)-1) AS MONEY), 0), 1), charindex('.', @gSales)) + right(@gSales, len(@gSales)-charindex('(', @gSales)+2) + '</td>
	  </tr>
	  <tr>
		<td width="75">Unknown</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@uInvoiced, charindex('(', @uInvoiced)-1) AS MONEY), 0), 1), charindex('.', @uInvoiced)) + right(@uInvoiced, len(@uInvoiced)-charindex('(', @uInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@uSales, charindex('(', @uSales)-1) AS MONEY), 0), 1), charindex('.', @uSales)) + right(@uSales, len(@uSales)-charindex('(', @uSales)+2) + '</td>
	  </tr>
	  <tr>
		<td width="75">Total</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@tInvoiced, charindex('(', @tInvoiced)-1) AS MONEY), 0), 1), charindex('.', @tInvoiced)) + right(@tInvoiced, len(@tInvoiced)-charindex('(', @tInvoiced)+2) + '</td>
		<td style="text-align:center; width: 120px;">$' + LEFT(CONVERT(varchar(50), ROUND(CAST(Left(@tSales, charindex('(', @tSales)-1) AS MONEY), 0), 1), charindex('.', @tSales)) + right(@tSales, len(@tSales)-charindex('(', @tSales)+2) + '</td>
	  </tr></table>'	
	
	SET @body1 = @body1 + '</body></html>'
	 
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'dlu@katom.com; pbible@katom.com; pchesworth@katom.com; cbible@katom.com; jrogers@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Internet Open Orders as of ' + CONVERT(VARCHAR(20), @today, 0) --Stat For '  + CAST(@mm AS VARCHAR(2)) + '/' + CAST(@dd AS VARCHAR(2)) + '/' + CAST(@yyyy AS VARCHAR(4))

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[hourly_open_order_status]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[hourly_open_order_status]
AS
BEGIN
	DECLARE @INDEX INT

	SET @INDEX = 13

	TRUNCATE TABLE salesStat10days

	WHILE (@INDEX > -1)
	   BEGIN
		INSERT INTO salesStat10days(orderDT)
		SELECT DATEADD(DAY, -@INDEX, GETDATE())
		WHERE DATEPART(WEEKDAY, DATEADD(DAY, -@INDEX, GETDATE())) NOT IN (1, 7)
		SET @INDEX = @INDEX - 1
	   END
	
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150), @fontColor varchar(50)
	
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>E-Mail</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 12px; vertical-align: top; }
	</style>

	</head>
	<body>
	<H3>Daily Sales Performance as of ' + CONVERT(VARCHAR(20), GETDATE(), 0) + '</H3>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="text-align:left; width: 100px;">Date</td>
		<td style="text-align:center; width: 100px;">Invoiced</td>
		<td style="text-align:center; width: 100px;">Open</td>
		<td style="text-align:center; width: 100px;">Ready To Import</td>
		<td style="text-align:center; width: 100px;">Total Sales<br />Performance</td>
		<td style="text-align:center; width: 100px;">Invoiced<br />Posting Date</td>
	  </tr>'
		  				
	--INVOICED LAST 10 DAYS	
	TRUNCATE TABLE salesStat10days_Worktable		

	INSERT INTO salesStat10days_Worktable(orderDT, orderCount, sales)	 	
	SELECT [Order Date], 
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE DATEDIFF(DAY, [Order Date], GETDATE()) BETWEEN 0 AND 13
		AND [Source code] = 'SALES'
		AND l.[Unit Price] > 0
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY [Order Date]
	ORDER BY 1

	UPDATE s
	SET s.iOrderCount = pt.orderCount,
		s.iSales = pt.sales
	FROM salesStat10days s JOIN salesStat10days_Worktable pt ON DATEDIFF(DAY, pt.orderDT, s.orderDT) = 0

	--INVOICED LAST 10 DAYS - POSTING DATE AND NOT SALES DATE
	TRUNCATE TABLE salesStat10days_Worktable		

	INSERT INTO salesStat10days_Worktable(orderDT, orderCount, sales)	
	SELECT i.[Posting Date], 
		COUNT(distinct i.[No_]), SUM(CAST([Quantity]*[Unit Price] AS DECIMAL(10, 2)))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l ON i.[No_] = l.[Document No_]
	WHERE DATEDIFF(DAY, i.[Posting Date], GETDATE()) BETWEEN 0 AND 13
		AND [Source code] = 'SALES'
		AND l.[Unit Price] > 0
		AND l.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY i.[Posting Date]
	ORDER BY 1

	UPDATE s
	SET s.iOrderCount_actual = pt.orderCount,
		s.iSales_actual = pt.sales
	FROM salesStat10days s JOIN salesStat10days_Worktable pt ON DATEDIFF(DAY, pt.orderDT, s.orderDT) = 0

	--OPEN SALES LAST 10 DAYS
	TRUNCATE TABLE salesStat10days_Worktable		

	INSERT INTO salesStat10days_Worktable(orderDT, orderCount, sales, notinvoicedSales)	 
	SELECT [Order Date],
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT	, 
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)) as decimal(10, 2)),
		CAST(SUM(ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2))
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE DATEDIFF(DAY, [Order Date], GETDATE()) BETWEEN 0 AND 13
		AND ih.[Document Type] = 1
		AND il.[Unit Price] > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY [Order Date]
	ORDER BY 1

	UPDATE s
	SET s.sOrderCount = pt.orderCount,
		s.sSales = pt.sales,
		s.notinvoicedSales = pt.notinvoicedSales
	FROM salesStat10days s JOIN salesStat10days_Worktable pt ON DATEDIFF(DAY, pt.orderDT, s.orderDT) = 0
		
	--NOT YET IMPORTED LAST 10 DAYS
	TRUNCATE TABLE salesStat10days_Worktable

	INSERT INTO salesStat10days_Worktable(orderDT, orderCount, sales, oldestBatch, lastBatched)
	select cast(cast(ordertimestamp as varchar(11)) as datetime), 
		count(customerPO), sum(AmountSubmitted), MIN(batchtimestamp), MAX(batchtimestamp)
	from order_hdr 
	group by cast(cast(ordertimestamp as varchar(11)) as datetime)

	UPDATE s
	SET s.wOrderCount = pt.orderCount,
		s.wSales = pt.sales,
		s.oldestOrder = pt.oldestBatch,
		s.lastBatched = pt.lastBatched
	FROM salesStat10days s JOIN salesStat10days_Worktable pt ON DATEDIFF(DAY, pt.orderDT, s.orderDT) = 0
	
	--CREATE EMAIL REPORT
	DECLARE @orderDT DATETIME, @iOrderCount INT, @iSales MONEY,  @iOrderCount_actual INT, @iSales_actual MONEY,
			@sOrderCount INT, @sSales MONEY, @wOrderCount INT, @wSales MONEY, @orderCountTT INT, 
			@salesTT MONEY, @oldestOrder DATETIME, @counter INT, @bgcolor VARCHAR(50)
					
	DECLARE sCursor CURSOR FOR 
	SELECT orderDT, 
		ISNULL(iOrderCount, 0) iOrderCount, 
		ISNULL(iSales, 0) iSales,
		ISNULL(iOrderCount_actual, 0) iOrderCount_actual, 
		ISNULL(iSales_actual, 0) iSales_actual,
		ISNULL(sOrderCount, 0) sOrderCount, 
		ISNULL(sSales, 0) + ISNULL(notinvoicedSales, 0)  sSales,
		ISNULL(wOrderCount, 0) wOrderCount, 
		ISNULL(wSales, 0) wSales,
		ISNULL(iOrderCount, 0) + ISNULL(sOrderCount, 0) + ISNULL(wOrderCount, 0) orderCountTT,
		ISNULL(iSales, 0) + ISNULL(sSales, 0) + ISNULL(wSales, 0) salesTT,
		oldestOrder
	FROM salesStat10days ORDER BY orderDT DESC
		
	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @orderDT, @iOrderCount, @iSales, @iOrderCount_actual, @iSales_actual,
					@sOrderCount, @sSales, @wOrderCount, @wSales, @orderCountTT, @salesTT, @oldestOrder

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + CAST(@orderDT AS VARCHAR(11)) + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@iSales AS MONEY), 1) + '<BR />(' + CAST(@iOrderCount AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@sSales AS MONEY), 1) + '<BR />(' + CAST(@sOrderCount AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@wSales AS MONEY), 1) + '<BR />(' + CAST(@wOrderCount AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@salesTT AS MONEY), 1) + '<BR />(' + CAST(@orderCountTT AS VARCHAR(100)) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), CAST(@iSales_actual AS MONEY), 1) + '<BR />(' + CAST(@iOrderCount_actual AS VARCHAR(100)) + ')</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @orderDT, @iOrderCount, @iSales, @iOrderCount_actual, @iSales_actual,
					@sOrderCount, @sSales, @wOrderCount, @wSales, @orderCountTT, @salesTT, @oldestOrder
	   END

	CLOSE sCursor
	DEALLOCATE sCursor
	
	SET @body1 = @body1 + '</body></html>'
	
	print  @body1
	
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'dlu@katom.com; pbible@katom.com; pchesworth@katom.com; cbible@katom.com; jrogers@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Daily Sales Performance as of ' + CONVERT(VARCHAR(20), GETDATE(), 0)

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	
END
GO
/****** Object:  StoredProcedure [dbo].[dailyStat_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[dailyStat_SP]
AS
BEGIN
	DECLARE @year Smallint, @month tinyint, @weekday tinyint, @day tinyint, 
		@salesTT money, @orderTT int, @today datetime

	SET @today = GETDATE()
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @weekday = DATEPART(WEEKDAY, @today)
	SET @day = DAY(@today)

	TRUNCATE TABLE dailyStat

	--POPULATING YTD DATA
	INSERT INTO dailyStat(orderType, orderTypeID, YTDSale, YTDOrder)
	SELECT
		CASE ih.[Customer Source]
			WHEN 'G' THEN 'GSA'
			WHEN 'I' THEN 'Internet'
			WHEN 'S' THEN 'Oustide Sales'
			WHEN 'C' THEN 'Catalog'
			WHEN 'B' THEN 'Bid'
			WHEN 'U' THEN 'Uncategorized'
			WHEN 'E' THEN 'eBay'
			WHEN 'FA' THEN 'Frosty Acres'
		END [Customer Source], ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE YEAR(ih.[Posting Date]) = @year
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY [Customer Source], ih.[Customer Source]
	ORDER BY 1 ASC

	--POPULATING LAST YTD DATA
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE ih.[Posting Date] BETWEEN '01/01/' + CAST((@year-1) AS VARCHAR(4)) 
								AND DATEADD(YEAR, -1, @today)	
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.lastYTDSale = ISNULL(w.salesTT, 0),
		d.lastYTDOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	SELECT @salesTT = SUM(salesTT), @orderTT = SUM(orderTT) 
	FROM dailystatworktable  
	WHERE orderTypeID NOT IN (SELECT orderTypeID from dailystat WHERE orderTypeID <> 'U')

	UPDATE dailyStat 
	SET lastYTDSale = @salesTT,
		lastYTDOrder = @orderTT
	WHERE orderTypeID = 'U' 

	--POPULATING MTD DATA
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(x.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE YEAR(ih.[Posting Date]) = @year AND MONTH(ih.[Posting Date]) = @month
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.MTDSale = ISNULL(w.salesTT, 0),
		d.MTDOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	--POPULATING LAST MTD DATA	
	DECLARE @lastMO tinyint, @lastYR smallint
	
	IF @month = 1
	   BEGIN
		SET @lastMO = 12
	   END
	ELSE
	   BEGIN
		SET @lastMO = @month-1
	   END
	   
	IF @lastMO > @month
	   BEGIN
		SET @lastYR = @year-1
	   END
	ELSE
	   BEGIN
		SET @lastYR = @year
	   END
	   	
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE ih.[Posting Date] BETWEEN CAST(@lastMO AS VARCHAR(10)) + '/01/' + CAST(@lastYR AS VARCHAR(10)) 
								AND DATEADD(MONTH, -1, @today)	
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.lastMTDSale = ISNULL(w.salesTT, 0),
		d.lastMTDOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	--POPULATING WTD DATA
	DECLARE @STARWK INT, @ENDWK INT

	SET @STARWK = datepart(week, @today)

	IF @STARWK < 5
	   BEGIN
		SET @ENDWK = datepart(week, '12/01/' + CAST(@year-1 AS VARCHAR(4)))-(5-@STARWK)
	   END
	ELSE
	   BEGIN
		SET @ENDWK = @STARWK-5
	   END
	   
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE datepart(week, ih.[Posting Date]) = @STARWK AND YEAR(ih.[Posting Date]) = @year
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.WTDSale = ISNULL(w.salesTT, 0),
		d.WTDOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	--POPULATING LAST WTD DATA
	DECLARE @LASTWK INT
	
	SET @LASTWK = datepart(week, DATEADD(DAY, -7, @today))
	
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE datepart(week, ih.[Posting Date]) = datepart(week, DATEADD(DAY, -7, GETDATE())) AND YEAR(ih.[Posting Date]) = YEAR(DATEADD(DAY, -7, GETDATE()))
		AND datepart(weekday, ih.[Posting Date]) BETWEEN 1 AND datepart(weekday, @today)
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.lastWTDSale = ISNULL(w.salesTT, 0),
		d.lastWTDOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	--POPULATING TODAY DATA
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE DATEDIFF(DAY, ih.[Posting Date], @today) = 0
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.todaySale = ISNULL(w.salesTT, 0),
		d.todayOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	--POPULATING LAST WEEK SAME DAY DATA
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE DATEDIFF(DAY, ih.[Posting Date], @today) = 7
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY [Customer Source], ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.lastweekSale = ISNULL(w.salesTT, 0),
		d.lastweekOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID

	--POPULATING TODAY OPEN SALE DATA
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE DATEDIFF(DAY, [Order Date], @today) = 0
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY ih.[Customer Source]
	ORDER BY 1 ASC

	UPDATE d
	SET d.openSale = ISNULL(w.salesTT, 0),
		d.openOrder = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID


	--POPULATING 6 WEEK AVG DATA	   
	TRUNCATE TABLE dailyStatWorktable
	INSERT INTO dailyStatWorktable(orderTypeID, orderDT, salesTT, orderTT)
	SELECT
		ih.[Customer Source],
		ih.[Posting Date],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
	WHERE ih.[Posting Date] BETWEEN DATEADD(Week, -6, @today) AND @today
		AND datepart(weekday, ih.[Posting Date]) = datepart(weekday, @today)
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY [Customer Source], ih.[Posting Date]
	ORDER BY 1, 2 ASC

	INSERT INTO dailyStatWorktable(orderTypeID, salesTT, orderTT)
	select ordertypeID, 
			AVG(salesTT),
			AVG(orderTT)
	from dailystatworktable
	group by ordertypeID

	UPDATE d
	SET d.[6weekAvgSale] = ISNULL(w.salesTT, 0),
		d.[6weeksAvgOrder] = ISNULL(w.orderTT, 0)
	FROM dailyStat d JOIN dailyStatWorktable w ON d.orderTypeID = w.orderTypeID
	WHERE w.orderDT IS NULL

	truncate table dailyStatWorktable
	
	--POPULATING MFG SALES STAT
	TRUNCATE TABLE mfgWorktable
	UPDATE mfg SET sales30 = 0, order30 = 0, order3060 = 0, sales3060 = 0

	INSERT INTO mfgWorktable
	SELECT CAST(LEFT(il.[No_], 3) AS VARCHAR(3)), SUM(il.[Quantity]), SUM(il.[Amount])
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		LEFT JOIN mfg m ON m.mfgID = LEFT(il.[No_], 3) COLLATE Latin1_General_CS_AS
	WHERE datediff(day, i.[Order Date], getdate()) < 31
		AND il.[No_] in (SELECT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)	
	GROUP BY LEFT(il.[No_], 3)

	UPDATE m
	SET m.sales30 = w.salesTT,
		m.order30 = w.orderTT
	FROM mfg m JOIN mfgWorktable w ON m.mfgID = w.mfgid

	TRUNCATE TABLE mfgWorktable

	INSERT INTO mfgWorktable
	SELECT CAST(LEFT(il.[No_], 3) AS VARCHAR(3)), SUM(il.[Quantity]), SUM(il.[Amount])
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		LEFT JOIN mfg m ON m.mfgID = LEFT(il.[No_], 3) COLLATE Latin1_General_CS_AS
	WHERE datediff(day, i.[Order Date], getdate()) between 31 AND 60
		AND il.[No_] in (SELECT [No_] FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)	
	GROUP BY LEFT(il.[No_], 3)

	UPDATE m
	SET m.sales3060 = w.salesTT,
		m.order3060 = w.orderTT
	FROM mfg m JOIN mfgWorktable w ON m.mfgID = w.mfgid
	
	TRUNCATE TABLE mfgWorktable
END
GO
/****** Object:  StoredProcedure [dbo].[dailyStat_Email]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- DESCriptiON:	<DESCriptiON,,>
-- =============================================
CREATE PROCEDURE [dbo].[dailyStat_Email]
AS
BEGIN
	DECLARE @OrderType VARCHAR(50), @todaySale MONEY, @todayOrder INT, @openSale MONEY, @openOrder INT, 
		@lastweekSale MONEY, @lastweekOrder INT, @6weekAvgSale MONEY, @6weeksAvgOrder INT,
		@WTDSale MONEY, @WTDOrder INT, @lastWTDSale MONEY, @lastWTDOrder INT,
		@MTDSale MONEY, @MTDOrder INT, @lastMTDSale MONEY, @lastMTDOrder INT,
		@YTDSale MONEY, @YTDOrder INT, @lastYTDSale MONEY, @lastYTDOrder INT,
		@todaySaleTT MONEY, @todayOrderTT INT, @openSaleTT MONEY, @openOrderTT INT, 
		@openSales_SD MONEY, @openOrders_SD INT,
		@lastweekSaleTT MONEY, @lastweekOrderTT INT, @6weekAvgSaleTT MONEY, @6weeksAvgOrderTT INT, 
		@WTDSaleTT MONEY, @WTDOrderTT INT, @lastWTDSaleTT MONEY, @lastWTDOrderTT INT, 
		@MTDSaleTT MONEY, @MTDOrderTT INT, @lastMTDSaleTT MONEY, @lastMTDOrderTT INT, 
		@YTDSaleTT MONEY, @YTDOrderTT INT, @lastYTDSaleTT MONEY, @lastYTDOrderTT INT,
		@today DATETIME, @yyyy SMALLINT, @dd TINYINT, @mm TINYINT,
		@dow VARCHAR(20), @wok TINYINT, @COUNTer SMALLINT, @bgcolor VARCHAR(50)
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150)
					
	SET @todaySaleTT = 0
	SET @todayOrderTT = 0
	SET @openSaleTT = 0
	SET @openOrderTT = 0
	SET @lastweekSaleTT = 0
	SET @lastweekOrderTT = 0
	SET @6weekAvgSaleTT = 0
	SET @6weeksAvgOrderTT = 0
	SET @WTDSaleTT = 0
	SET @WTDOrderTT = 0
	SET @lastWTDSaleTT = 0
	SET @lastWTDOrderTT = 0
	SET @MTDSaleTT = 0
	SET @MTDOrderTT = 0
	SET @lastMTDSaleTT = 0
	SET @lastMTDOrderTT = 0
	SET @YTDSaleTT = 0
	SET @YTDOrderTT = 0
	SET @lastYTDSaleTT = 0
	SET @lastYTDOrderTT = 0
	SET @COUNTer = 1
	SET @bgcolor = '#bed6e9'

	--INITIATING DATE
	SET @today = GETDATE()
	SET @yyyy = YEAR(@today)
	SET @mm = MONTH(@today)
	SET @dd = DAY(@today)
	SET @dow = DATENAME(WEEKDAY, @today)
	SET @wok = DATEPART(WEEK, @today)

	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 TransitiONal//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitiONal.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="CONtent-Type" cONtent="text/html; charset=UTF-8" />
	<title>E-Mail</title>

	<style type="text/css">
	body,td,th {fONt-family: Arial, Helvetica, sans-serif;fONt-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
		   <td width="75">&nbsp;</td>
		<td style="text-align:center; width: 100px;">' + @dow + '</td>
		<td style="text-align:center; width: 100px;">Open Orders</td>
		<td style="text-align:center; width: 100px;">Last ' + @dow + '</td>
		<td style="text-align:center; width: 100px;">6 Weeks Avg</td>
		<td style="text-align:center; width: 100px;">WTD<BR />Invoiced</td>
		<td style="text-align:center; width: 100px;">Last WTD<BR />Invoiced</td>
		<td style="text-align:center; width: 100px;">MTD<BR />' + DATENAME(MONTH, @today) + '</td>
		<td style="text-align:center; width: 100px;">MTD<BR />' + DATENAME(MONTH, DATEADD(MONTH, -1, @today)) + '</td>
		<td style="text-align:center; width: 130px;">YTD<BR />'+ CAST(@yyyy AS VARCHAR(4)) + '</td>
		<td style="text-align:center; width: 130px;">YTD<BR />'+ CAST((@yyyy-1) AS VARCHAR(4)) + '</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT [OrderType], 
		ISNULL([todaySale], 0) [todaySale], ISNULL([todayOrder], 0) [todayOrder], 
		ISNULL([openSale], 0) [openSale], ISNULL([openOrder], 0) [openOrder], 
		ISNULL([lastweekSale], 0) [lastweekSale], ISNULL([lastweekOrder], 0) [lastweekOrder], 
		ISNULL([6weekAvgSale], 0) [6weekAvgSale], ISNULL([6weeksAvgOrder], 0) [6weeksAvgOrder], 
		ISNULL([WTDSale], 0) [WTDSale], ISNULL([WTDOrder], 0) [WTDOrder], 
		ISNULL([lastWTDSale], 0) [lastWTDSale], ISNULL([lastWTDOrder], 0) [lastWTDOrder], 
		ISNULL([MTDSale], 0) [MTDSale], ISNULL([MTDOrder], 0) [MTDOrder], 
		ISNULL([lastMTDSale], 0) [lastMTDSale], ISNULL([lastMTDOrder], 0) [lastMTDOrder], 
		ISNULL([YTDSale], 0) [YTDSale], ISNULL([YTDOrder], 0) [YTDOrder], 
		ISNULL([lastYTDSale], 0) [lastYTDSale], ISNULL([lastYTDOrder], 0) [lastYTDOrder]
	FROM dailyStat
	WHERE [OrderType] IS NOT NULL

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @OrderType, @todaySale, @todayOrder, 
								 @openSale, @openOrder, @lastweekSale, @lastweekOrder, 
								 @6weekAvgSale, @6weeksAvgOrder, @WTDSale, @WTDOrder, 
								 @lastWTDSale, @lastWTDOrder, @MTDSale, @MTDOrder, 
								 @lastMTDSale, @lastMTDOrder, @YTDSale, @YTDOrder, 
								 @lastYTDSale, @lastYTDOrder

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @todaySaleTT = @todaySaleTT + @todaySale
		SET @todayOrderTT = @todayOrderTT + @todayOrder
		SET @openSaleTT = @openSaleTT + @openSale
		SET @openOrderTT = @openOrderTT + @openOrder
		SET @lastweekSaleTT = @lastweekSaleTT + @lastweekSale
		SET @lastweekOrderTT = @lastweekOrderTT + @lastweekOrder
		SET @6weekAvgSaleTT = @6weekAvgSaleTT + @6weekAvgSale
		SET @6weeksAvgOrderTT = @6weeksAvgOrderTT + @6weeksAvgOrder
		SET @WTDSaleTT = @WTDSaleTT + @WTDSale
		SET @WTDOrderTT = @WTDOrderTT + @WTDOrder
		SET @lastWTDSaleTT = @lastWTDSaleTT + @lastWTDSale
		SET @lastWTDOrderTT = @lastWTDOrderTT + @lastWTDOrder
		SET @MTDSaleTT = @MTDSaleTT + @MTDSale
		SET @MTDOrderTT = @MTDOrderTT + @MTDOrder
		SET @lastMTDSaleTT = @lastMTDSaleTT + @lastMTDSale
		SET @lastMTDOrderTT = @lastMTDOrderTT + @lastMTDOrder
		SET @YTDSaleTT = @YTDSaleTT + @YTDSale
		SET @YTDOrderTT = @YTDOrderTT + @YTDOrder
		SET @lastYTDSaleTT = @lastYTDSaleTT + @lastYTDSale
		SET @lastYTDOrderTT = @lastYTDOrderTT + @lastYTDOrder
		
		IF @COUNTer = 1
		   BEGIN
			SET @COUNTer = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @COUNTer = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @OrderType + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@todaySale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@todayOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@openSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@openOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@lastweekSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastweekOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@6weekAvgSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@6weeksAvgOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@WTDSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@WTDOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@lastWTDSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastWTDOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@MTDSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@MTDOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@lastMTDSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastMTDOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@YTDSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@YTDOrder, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@lastYTDSale, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastYTDOrder, 0), 1) + ')</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @OrderType, @todaySale, @todayOrder, 
									 @openSale, @openOrder, @lastweekSale, @lastweekOrder, 
									 @6weekAvgSale, @6weeksAvgOrder, @WTDSale, @WTDOrder, 
									 @lastWTDSale, @lastWTDOrder, @MTDSale, @MTDOrder, 
									 @lastMTDSale, @lastMTDOrder, @YTDSale, @YTDOrder, 
									 @lastYTDSale, @lastYTDOrder
	   END


	CLOSE sCursor
	DEALLOCATE sCursor

	SET @body1 = @body1 + ' <tr style="background-color:#dddddd; fONt-weight: bold;">
		<td >Total</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@todaySaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@todayOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@openSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@openOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@lastweekSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastweekOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@6weekAvgSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@6weeksAvgOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@WTDSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@WTDOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@lastWTDSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastWTDOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@MTDSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@MTDOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@lastMTDSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastMTDOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@YTDSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@YTDOrderTT, 0), 1) + ')</td>
		<td align="center">' + '$' + CONVERT(varchar(50), ISNULL(@lastYTDSaleTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@lastYTDOrderTT, 0), 1) + ')</td>
	  </tr>
	</table>'

	--POPULATING SHIP DIRECT DATA	
	TRUNCATE TABLE dailyStat_shipdirect
	INSERT INTO dailyStat_shipdirect([date], orderNum, sales)
	SELECT h.[Order Date], COUNT(DISTINCT h.[No_]), sum(DISTINCT l.Amount)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Line] l ON h.[No_] = l.[Document No_]
	WHERE h.[Ship-to Name] NOT IN ('WAREHOUSE FACILITY' , 'FULFILLMENT CENTER', 'FULFILLMENT FACILITY CENTER')
			AND LEN(ISNULL(l.[No_], '')) > 0 
			AND l.Amount > 0 AND l.[No_] NOT IN ('555', '540', '205')
			AND DATEDIFF(day, h.[Order Date], getdate()) < 15
	GROUP BY h.[Order Date]
	ORDER BY h.[Order Date] DESC

	INSERT INTO dailyStatWorktable(orderDT, orderTT, salesTT)
	SELECT [Order Date], COUNT(DISTINCT h.[No_]), sum(l.Amount)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Line] l ON h.[No_] = l.[Document No_]
	WHERE h.[Ship-to Name] NOT IN ('WAREHOUSE FACILITY' , 'FULFILLMENT CENTER', 'FULFILLMENT FACILITY CENTER')
			AND LEN(ISNULL(l.[No_], '')) > 0 
			AND l.Amount > 0 AND l.[No_] NOT IN ('555', '540', '205')
			AND DATEDIFF(day, [Order Date], getdate()) < 15
	GROUP BY [Order Date]
	ORDER BY [Order Date] DESC

	UPDATE s
	SET s.orderNum = ISNULL(s.orderNum, 0) + w.orderTT,
		s.sales = ISNULL(s.sales, 0) + w.salesTT
	FROM dailyStat_shipdirect s JOIN dailyStatWorktable w ON s.[date] = w.orderDT

	TRUNCATE TABLE dailyStatWorktable
	
	INSERT INTO dailyStatWorktable(orderDT, salesTT, orderTT)
	SELECT	ih.[Order Date],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) AS DECIMAL(10, 2)),
		COUNT(DISTINCT ISNULL(x.[No_], 0))		
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, [Order Date], GETDATE()) < 20
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEN(il.[No_]) > 0
		AND LEFT(il.[No_], 3) IN (SELECT mfgid collate SQL_Latin1_General_CP1_CI_AS FROM mfg WHERE Active = 1 AND shipDirect = 1)
		AND il.[No_] NOT IN (
					SELECT [No_]
					FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					WHERE [Maximum Inventory] > 0
					)
	GROUP BY ih.[Order Date]

	UPDATE s
	SET s.openOrders = w.orderTT,
		s.openSales = w.salesTT
	FROM dailyStat_shipdirect s JOIN dailyStatWorktable w ON s.[date] = w.orderDT

	TRUNCATE TABLE dailyStatWorktable

	SET @COUNTer = 1
	SET @body1 = @body1 + '<br />
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	<tr>
	<td>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
	<td colspan="6" style="fONt-size:12px;">Order Status In The Last 10 Business Days</td>
  </tr>  
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
    <td style="text-align:center; width: 75px;">&nbsp;</td>
    <td style="text-align:center; width: 100px;">Ship Direct</td>
    <td style="text-align:center; width: 100px;">Invoiced</td>
    <td style="text-align:center; width: 100px;">Open</td>
    <td style="text-align:center; width: 100px;">Open Internet</td>
    <td style="text-align:center; width: 100px;">Open Ship Direct</td>
  </tr>'
	
	DECLARE @orderDT varchar(20), @SalesShipDirect mONey, @orderShipDirect int, 
			@salesTT varchar(20), @orderTT varchar(10), @openSalesTT varchar(20), @openOrderTT2 varchar(10),
			@internetSalesTT varchar(20), @internetOrderTT varchar(10)
			
	DECLARE sCursor CURSOR FOR 
	SELECT CONVERT(VARCHAR(10), d.[date], 101),  d.orderNum, d.Sales, 
		'$' + CONVERT(varchar(50), CAST(LEFT(s.TotalInvoiced, CHARINDEX('(', s.totalinvoiced)-2) AS MONEY), 1) salesTT, 
		RIGHT(s.totalinvoiced, LEN(s.totalinvoiced)-CHARINDEX('(', s.totalinvoiced)+1) orderTT, 
		'$' + CONVERT(varchar(50), CAST(LEFT(s.totalSales, CHARINDEX('(', s.totalSales)-2) AS MONEY), 1) openSalesTT, 
		RIGHT(s.totalSales, LEN(s.totalSales)-CHARINDEX('(', s.totalSales)+1) openOrdersTT, 
		'$' + CONVERT(varchar(50), CAST(LEFT(s.InternetSales, CHARINDEX('(', s.InternetSales)-2) AS MONEY), 1) InternetSalesTT, 
		RIGHT(s.InternetSales, LEN(s.InternetSales)-CHARINDEX('(', s.InternetSales)+1) InternetOrdersTT,
		d.openSales, d.openOrders
	FROM dailyStat_shipdirect d JOIN salesStat30Days s ON DATEDIFF(DAY, d.[date], s.[Date]) = 0
	ORDER BY d.[date] DESC

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @orderDT, @orderShipDirect, @SalesShipDirect, @salesTT, @orderTT, 
								 @openSalesTT, @openOrderTT2, @internetSalesTT, @internetOrderTT,
								 @openSales_SD, @openOrders_SD
	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @COUNTer = 1
		   BEGIN
			SET @COUNTer = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @COUNTer = 1
			SET @bgcolor = '#bed6e9'
		   END
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td align="center" >' + @orderDT + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@SalesShipDirect, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@orderShipDirect, 0), 1) + ')</td>
		<td align="center" >' + @salesTT + ' ' + @orderTT + '</td>
		<td align="center" >' + @openSalesTT + ' ' + @openOrderTT2 + '</td>
		<td align="center" >' + @internetSalesTT + ' ' + @internetOrderTT + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@openSales_SD, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@openOrders_SD, 0), 1) + ')</td>
	  </tr>'
	  	
		FETCH NEXT FROM sCursor INTO @orderDT, @orderShipDirect, @SalesShipDirect, @salesTT, @orderTT, 
								 @openSalesTT, @openOrderTT2, @internetSalesTT, @internetOrderTT,
								 @openSales_SD, @openOrders_SD
	   END
	CLOSE sCursor
	DEALLOCATE sCursor
	
	SET @body1 = @body1 + '</TABLE></td><td>
			<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
		  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
			<td colspan="6" style="fONt-size:12px;">Open Order Status In The Last 10 Business Days</td>
		  </tr>  
		  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
			<td style="text-align:center; width: 75px;">&nbsp;</td>
			<td style="text-align:center; width: 100px;">UNPRINTED ORDERS</td>
			<td style="text-align:center; width: 100px;">PRINTED ORDERS</td>
			<td style="text-align:center; width: 100px;">TOTAL ORDERS</td>
		  </tr>'
	
	DECLARE @unprintC INT, @unprintS DECIMAL(10, 2), @printC INT, @printS DECIMAL(10, 2)
	
	DECLARE sCursor CURSOR FOR 
	SELECT * FROM dailyStat_openOrder

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @orderDT, @unprintC, @unprintS, @printC, @printS, @orderTT, @salesTT
	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @COUNTer = 1
		   BEGIN
			SET @COUNTer = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @COUNTer = 1
			SET @bgcolor = '#bed6e9'
		   END
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td align="center" >' + REPLACE(@orderDT, ' 12:00AM', '') + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@unprintS, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@unprintC, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@printS, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@printC, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@salesTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT, 0), 1) + ')</td>
	  </tr>'
	
		FETCH NEXT FROM sCursor INTO @orderDT, @unprintC, @unprintS, @printC, @printS, @orderTT, @salesTT
	   END
	CLOSE sCursor
	DEALLOCATE sCursor
		
	SET @body1 = @body1 + '</TABLE></td></tr></table>'
	
	--TOP 10 MFG DATA
	SET @COUNTer = 1
	SET @body1 = @body1 + '<table border="0" cellspacing=""="0" cellpadding="3">
  <tr>
    <td><table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
	<td colspan="5" style="fONt-size:12px;">Top 10 Mfg By Web Sales - Last 30 days</td>
  </tr>  
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
    <td style="text-align:center; width: 150px;">Manufacturers</td>
    <td style="text-align:center; width: 70px;">Sales</td>
  </tr>'
  
	DECLARE @mfgID VARCHAR(3), @mfgName varchar(20), @orderTT2 INT, @salesTT2 MONEY, @perc FLOAT, @fONtColor VARCHAR(7)
  
	DECLARE sCursor CURSOR FOR 	
	SELECT TOP 10 mfgID, mfgName, ROUND(sales30, 0), 
		CASE 
			WHEN sales3060 > 0 THEN ROUND(100*((sales30/(CAST(sales3060 AS FLOAT)))-1), 0)
			ELSE 0
		END
	FROM mfg 
	WHERE Active = 1
	ORDER BY sales30 DESC
	
	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @mfgID, @mfgName, @salesTT2, @perc

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @COUNTer = 1
		   BEGIN
			SET @COUNTer = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @COUNTer = 1
			SET @bgcolor = '#bed6e9'
		   END
		   
		IF @perc > 0
			SET @fONtColor = '#000000'
		ELSE
			SET @fONtColor = '#CC0000'
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @mfgName + ' (' + @mfgID + ')</td>
		<td align="center" style="color:' + @fONtColor + ';">' + '$' + LEFT(CONVERT(varchar(50), ISNULL(@salesTT2, 0), 1), CHARINDEX('.', @salesTT2)) + ' (' + CAST(@perc AS VARCHAR(100)) + '%)</td>
	  </tr>'
	  	
		FETCH NEXT FROM sCursor INTO @mfgID, @mfgName, @salesTT2, @perc
	   END
	CLOSE sCursor
	DEALLOCATE sCursor
		
	SET @body1 = @body1 + '</TABLE></td>'
	
	SET @COUNTer = 1
	SET @body1 = @body1 + '<td><table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
	<td colspan="5" style="fONt-size:12px;">Top 10 Mfg By Qty Sold - Last 30 days</td>
  </tr>  
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
    <td style="width: 150px;">Manufacturers</td>
    <td style="text-align:center; width: 70px;">Qty Sold</td>
  </tr>'    
	
	DECLARE sCursor CURSOR FOR 	
	SELECT TOP 10 mfgID, mfgName, order30, ROUND(100*((order30/(CAST(order3060 AS FLOAT)))-1), 0)
	FROM mfg 
	WHERE Active = 1
	ORDER BY order30 DESC
	
	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @mfgID, @mfgName, @orderTT2, @perc

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @COUNTer = 1
		   BEGIN
			SET @COUNTer = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @COUNTer = 1
			SET @bgcolor = '#bed6e9'
		   END
		   
		IF @perc > 0
			SET @fONtColor = '#000000'
		ELSE
			SET @fONtColor = '#CC0000'
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td lign="top">' + @mfgName + ' (' + @mfgID + ')</td>
		<td align="center" style="color:' + @fONtColor + ';">' + CAST(@orderTT2 AS VARCHAR(10)) + ' (' + CAST(@perc AS VARCHAR(100)) + '%)</td>
	  </tr>'
	  	  	
		FETCH NEXT FROM sCursor INTO @mfgID, @mfgName, @orderTT2, @perc
	   END
	CLOSE sCursor
	DEALLOCATE sCursor
		
	SET @body1 = @body1 + '</TABLE></td>'


	--POPULATING WITH MISSING TRACKING
	SET @body1 = @body1 + '<td><table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
	<td colspan="5" style="fONt-size:12px;">TOP 10 Mfg with Missing Tracking</td>
  </tr>  
  <tr style="background-color:#446fb7; color:#FFFFFF; fONt-weight: bold;">
    <td style="width: 150px;">Manufacturers</td>
    <td style="text-align:center; width: 70px;">Num Orders</td>
  </tr>' 

	DECLARE sCursor CURSOR FOR 	
	SELECT TOP 10 CAST(LEFT(il.[No_], 3) AS VARCHAR(3)), mfgName, COUNT(DISTINCT i.[No_])	
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		JOIN mfg m ON m.mfgID = LEFT(il.[No_], 3) COLLATE Latin1_General_CS_AS
	WHERE datediff(day, i.[Order Date], getdate()) BETWEEN 3 AND 60
		AND il.[No_] in (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)	
		AND LEN(ISNULL(i.[Package Tracking No_], '')) = 0		
		AND i.[Shipment Method Code] <> 'PICK UP'
		AND CAST(LEFT(il.[No_], 3) AS VARCHAR(3)) <> '100'
	GROUP BY LEFT(il.[No_], 3), mfgName
	ORDER BY 3 DESC
	
	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @mfgID, @mfgName,@orderTT2

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @COUNTer = 1
		   BEGIN
			SET @COUNTer = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @COUNTer = 1
			SET @bgcolor = '#bed6e9'
		   END
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @mfgName + ' (' + @mfgID + ')</td>
		<td align="center">' + CAST(@orderTT2 AS VARCHAR(10)) + '</td>
	  </tr>'
	  	
		FETCH NEXT FROM sCursor INTO @mfgID, @mfgName,@orderTT2
	   END
	CLOSE sCursor
	DEALLOCATE sCursor  	
  	  	
	SET @body1 = @body1 + '</table></td></tr></table>'
	
	SET @body1 = @body1 + '	</body>
	</html>'
	
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'dlu@katom.com; pbible@katom.com; pchesworth@katom.com; cbible@katom.com; jchesworth@katom.com; jrogers@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Daily Stat For '  + CAST(@mm AS VARCHAR(2)) + '/' + CAST(@dd AS VARCHAR(2)) + '/' + CAST(@yyyy AS VARCHAR(4))

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[CvcImporttest]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[CvcImporttest]

AS
BEGIN
/*
load data local infile 'H:/file.txt'
into table test.info
FIELDS TERMINATED BY '~~~'
lines terminated by '~!~!'
ignore 1 lines
;*/
/*
delete from filetest

BULK
INSERT filetest
from 'C:\sqljobs\file.txt'
WITH
(
FIELDTERMINATOR = '~/~/',
ROWTERMINATOR = '~!~!'
)

select * from filetest
/*
INSERT OPENQUERY(MYSQLLOCAL, 'select refnum, secnum from test.info')
select refnum, SecNum 
from filetest
--where refnum is null
*/
*/

insert
into filetestx (refnum, secnum)
select * from openquery(MySQL, 'select refnum, secnum from ordersec')
where secnum not in (select secnum from filetestx)

update order_hdr
set cvc = refnum
from filetestx join order_hdr
on secnum = customerpo
where cvc = '1'


END
GO
/****** Object:  StoredProcedure [dbo].[CvcImport]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[CvcImport]

AS
BEGIN
/*
load data local infile 'H:/file.txt'
into table test.info
FIELDS TERMINATED BY '~~~'
lines terminated by '~!~!'
ignore 1 lines
;*/
/*
delete from filetest

BULK
INSERT filetest
from 'C:\sqljobs\file.txt'
WITH
(
FIELDTERMINATOR = '~/~/',
ROWTERMINATOR = '~!~!'
)

select * from filetest
/*
INSERT OPENQUERY(MYSQLLOCAL, 'select refnum, secnum from test.info')
select refnum, SecNum 
from filetest
--where refnum is null
*/
*/

insert
into filetestx (refnum, secnum)
select * from openquery(MySQL, 'select refnum, secnum from ordersec')
where secnum not in (select secnum from filetestx)

update order_hdr
set cvc = refnum
from filetestx join order_hdr
on secnum = customerpo
where cvc = '1'


END
GO
/****** Object:  StoredProcedure [dbo].[cseClick_Stat]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[cseClick_Stat]
AS
BEGIN
	DECLARE @numClick INT
	
	SET @numClick = 9
	
	DELETE FROM cseclick WHERE DATEDIFF(DAY, insertDT, GETDATE()) > 90
			
	TRUNCATE TABLE prodTemp
	
	INSERT INTO prodTemp([No_], [Product Name], Blocked, UnitPrice, stockItem)
	SELECT sku, dbo.[returnCSEName]([channel_Name]),
		SUM(CAST(clicks AS INT)) clickCount, 
		SUM(CAST(click_cost AS DECIMAL(10, 2))) costTT, 
		SUM(CAST(qty_sold AS INT)) soldQTY
	FROM cseClick_worktable
	GROUP BY sku, dbo.[returnCSEName]([channel_Name])
	HAVING SUM(CAST(clicks AS INT)) > @numClick
	
	DELETE pt FROM prodTemp pt JOIN cseClick c ON pt.[No_] = c.SKU AND pt.[Product Name] = c.Channel_Name
	
	INSERT INTO cseclick (SKU, CHANNEL_NAME, CLICKS, CLICK_COST, QTY_SOLD)
	SELECT [No_], [Product Name], Blocked, UnitPrice, stockItem
	FROM prodTemp
	WHERE [Product Name] NOT IN ('Bing', 'Google Shopping PLA')
	
	UPDATE c
	SET c.profit = 
		CASE 
			WHEN p.price < 250 THEN c.qty_sold*(p.price - p.cost)
			ELSE p.sales30*(p.price - p.cost)
		END, 
		c.price = p.price
	FROM cseclick c JOIN products p ON c.sku = p.CODE
	WHERE DATEDIFF(DAY, insertDT, GETDATE()) = 0
		
	DELETE FROM cseclick WHERE profit >= Click_Cost

END
GO
/****** Object:  StoredProcedure [dbo].[FA_HouseItems_Process]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[FA_HouseItems_Process]
AS
BEGIN	
	
	DECLARE @sql VARCHAR(2000), @year SMALLINT, @month TINYINT, @CODE varchar(500), @qtySold INT, @cYear SMALLINT
	
	DECLARE @body1 VARCHAR(MAX), @email1 VARCHAR(500), @subject1 varchar(150), @bgcolor VARCHAR(500), @counter TINYINT, @subBody VARCHAR(MAX)
	 
	SET @sql = ''
	SET @cYear = YEAR(GETDATE())

	UPDATE FA_HouseOrderItems
	SET [1] = NULL, [2] = NULL, [3] = NULL, [4] = NULL, [5] = NULL, [6] = NULL, 
		[7] = NULL, [8] = NULL, [9] = NULL, [10] = NULL, [11] = NULL, [12] = NULL, 
		[13] = NULL, [3MOAVG] = NULL, [6MOAVG] = NULL, [APO_6MO] = NULL

	DECLARE catCursor CURSOR FOR 
	select YEAR([Order Date]), MONTH([Order Date]), l.[No_], ISNULL(SUM(l.[Quantity]), 0)
	from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l on h.[No_] = l.[Document No_]
		join FA_HouseOrderItems t on t.code = l.[No_] collate Latin1_General_CS_AS
	where [Bill-to Name] = 'FROSTY ACRES BRANDS'
		and datediff(month, [Order Date], getdate()) < 13
	group by YEAR([Order Date]), MONTH([Order Date]), l.[No_]
	order by l.[No_], YEAR([Order Date]), MONTH([Order Date])

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @year, @month, @CODE, @qtySold

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @sql = 'UPDATE FA_HouseOrderItems SET ['
		
		IF @year < @cYear
		   BEGIN
			SET @sql = @sql + CAST((@month-8) AS VARCHAR(10))
		   END
		ELSE
		   BEGIN
			SET @sql = @sql + CAST((@month+4) AS VARCHAR(10))
		   END
		
		SET @sql = @sql + '] = ' + CAST(@qtySold AS VARCHAR(20)) + ' WHERE code = ''' + @CODE + ''''
		
		EXEC(@sql)
		
		FETCH NEXT FROM catCursor INTO @year, @month, @CODE, @qtySold
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	set @body1 = 'Your report is ready, <A HREF="http://www.katom.local/fa_houseitems.asp">Please Click here to view it!</A>'
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'pbible@katom.com;'
	--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Frosty Acres House Item Stock'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[FA_HouseItems]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[FA_HouseItems]
AS
BEGIN
	SELECT T.CODE, 
		ISNULL([1], 0) [MO1],
		ISNULL([2], 0) [MO2],
		ISNULL([3], 0) [MO3],
		ISNULL([4], 0) [MO4],
		ISNULL([5], 0) [MO5],
		ISNULL([6], 0) [MO6],
		ISNULL([7], 0) [MO7],
		ISNULL([8], 0) [MO8],
		ISNULL([9], 0) [MO9],
		ISNULL([10], 0) [MO10],
		ISNULL([11], 0) [MO11],
		ISNULL([12], 0) [MO12],
		ISNULL([12], 0) [MO13],
		ISNULL([13], 0) cMonth,
		(ISNULL([10], 0) + ISNULL([11], 0) + ISNULL([12], 0))/3 [3MOAVG], 
		(ISNULL([7], 0) + ISNULL([8], 0) + ISNULL([9], 0) + ISNULL([10], 0) + ISNULL([11], 0) + ISNULL([12], 0))/6 [6MOAVG],
		p.qtyOnHand 
	FROM FA_HouseOrderItems t join products p on t.code = p.CODE
	ORDER BY t.code	
END
GO
/****** Object:  StoredProcedure [dbo].[Email_prodError]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[Email_prodError]
AS
BEGIN
	DECLARE @code VARCHAR(100), @name SMALLINT, @image SMALLINT, @mpn SMALLINT,
		@price SMALLINT, @listprice SMALLINT, @prodDesc SMALLINT, 
		@uom SMALLINT, @weight SMALLINT, @vendorID SMALLINT, @discountGRP SMALLINT,
		@tname SMALLINT, @timage SMALLINT, @tmpn SMALLINT,
		@tprice SMALLINT, @tlistprice SMALLINT, @tprodDesc SMALLINT, 
		@tuom SMALLINT, @tweight SMALLINT, @tvendorID SMALLINT, @tdiscountGRP SMALLINT

	DECLARE @body1 VARCHAR(MAX), @email1 VARCHAR(500), @subject1 varchar(150), @bgcolor VARCHAR(500), @counter TINYINT, @subBody VARCHAR(MAX)
	 
	SET @tname = 0 
	SET @timage = 0 
	SET @tmpn = 0 
	SET @tprice = 0 
	SET @tlistprice = 0 
	SET @tprodDesc = 0 
	SET @tuom = 0 
	SET @tweight = 0 
	SET @tvendorID = 0 
	SET @tdiscountGRP = 0
	SET @subBody = ''

	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Error Report</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT [Code], 
		CASE 
			WHEN LEN(ISNULL([NAME], '')) = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL([IMAGE], '')) = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL([mpn], '')) = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL([price], '')) = 0 THEN 1
			WHEN [price] = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL([listPrice], '')) = 0 THEN 1
			WHEN [listPrice] = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(CAST(ISNULL([prodDesc], '') AS VARCHAR(MAX))) = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL([UOM], '')) = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL([WEIGHT], '')) = 0 THEN 1
			WHEN [WEIGHT] = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL(vendorID, '')) = 0 THEN 1
			ELSE 0
		END,
		CASE 
			WHEN LEN(ISNULL(ICDiscountGrp, '')) = 0 THEN 1
			ELSE 0
		END
	FROM products
	WHERE active = 1 AND isWeb = 1
		AND CHARINDEX('-PART', ICDiscountGrp) = 0 and
		(LEN(ISNULL([IMAGE] , '')) = 0 OR
			LEN(ISNULL([listPrice] , '')) = 0 OR
			[listPrice] = 0 OR
			LEN(ISNULL([mpn] , '')) = 0 OR
			LEN(ISNULL([NAME] , '')) = 0 OR
			LEN(ISNULL([price] , '')) = 0 OR
			[price] = 0 OR
			LEN(ISNULL(CAST([prodDesc] AS VARCHAR(MAX)), '')) = 0 OR
			LEN(ISNULL([UOM] , '')) = 0 OR
			LEN(ISNULL([WEIGHT] , '')) = 0 OR
			[WEIGHT] = 0 OR
			LEN(ISNULL(vendorID, '')) = 0 OR
			LEN(ISNULL(ICDiscountGrp, '')) = 0)
	ORDER BY code

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @code, @name, @image, @mpn, @price, @listprice, @prodDesc, @uom, @weight, @vendorID, @discountGRP

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		SET @tname = @tname + @name 
		SET @timage = @timage + @image 
		SET @tmpn = @tmpn + @mpn
		SET @tprice = @tprice + @price 
		SET @tlistprice = @tlistprice + @listprice 
		SET @tprodDesc = @tprodDesc + @prodDesc 
		SET @tuom = @tuom + @uom 
		SET @tweight = @tweight + @weight 
		SET @tvendorID = @tvendorID + @vendorID 
		SET @tdiscountGRP = @tdiscountGRP + @discountGRP
				
		FETCH NEXT FROM sCursor INTO @code, @name, @image, @mpn, @price, @listprice, @prodDesc, @uom, @weight, @vendorID, @discountGRP
	   END

	CLOSE sCursor
	DEALLOCATE sCursor

	IF @tname > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing PRODNAME: ' + CAST(@tname AS VARCHAR(10)) + '<BR />'
	   END
	IF @timage > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing IMG: ' + CAST(@timage AS VARCHAR(10)) + '<BR />'
	   END
	IF @tmpn > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing MPN: ' + CAST(@tmpn AS VARCHAR(10)) + '<BR />'
	   END
	IF @tprice > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing PRICE: ' + CAST(@tprice AS VARCHAR(10)) + '<BR />'
	   END
	IF @tlistprice > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing LISTPRICE: ' + CAST(@tlistprice AS VARCHAR(10)) + '<BR />'
	   END
	IF @tprodDesc > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing PRODDESC: ' + CAST(@tprodDesc AS VARCHAR(10)) + '<BR />'
	   END
	IF @tuom > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing UOM: ' + CAST(@tuom AS VARCHAR(10)) + '<BR />'
	   END
	IF @tweight > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing WEIGHT: ' + CAST(@tweight AS VARCHAR(10)) + '<BR />'
	   END
	IF @tvendorID > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing VENDORID: ' + CAST(@tvendorID AS VARCHAR(10)) + '<BR />'
	   END
	IF @tdiscountGRP > 0 
	   BEGIN
		SET @subBody = @subBody + 'The number of products with missing DISC_GRP: ' + CAST(@tdiscountGRP AS VARCHAR(10)) + '<BR />'
	   END
		
	IF LEN(@subBody) > 0 
	   BEGIN
		SET @subBody = @subBody + '<BR /><A HREF="http://www.katom.local/producterrorreport.asp">Go to report!</A>'
	   END
		
	SET @body1 = @body1 + @subBody

	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'groberts@katom.com;'
	--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'PRODUCT ERROR REPORT'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[Email_ProccessedOrderFromWarehouse_charley]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[Email_ProccessedOrderFromWarehouse_charley]
AS
BEGIN
	DECLARE @postingDT DATETIME, @SalesTT DECIMAL(10, 2), @orderTT INT

	DECLARE @body1 VARCHAR(MAX), @email1 VARCHAR(500), @subject1 varchar(150), @bgcolor VARCHAR(500), @counter TINYINT
	
	SET @counter = 1
	SET @bgcolor = '#bed6e9'
	 
	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Error Report</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		   <td width="200">Date</td>
		<td style="text-align:center; width: 100px;">Sales Total</td>
		<td style="text-align:center; width: 100px;">Order Total</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT ih.[Posting Date], CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
			COUNT(distinct ISNULL(ih.[No_], 0)) orderTT	
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		/**
		LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] p 
			ON ih.[Order No_] = p.[Sales Order No_]	
		LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] p2 
			ON ih.[Order No_] = p2.[Sales Order No_]
		**/
	WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < 30
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')		
		AND ih.[Order Reason] IN ('WAREHOUSE', 'SENT TO WAREHOUSE!!')
		--and p.[Sales Order No_] is null
		--and p2.[Sales Order No_] is null
	GROUP BY ih.[Posting Date]
	ORDER BY 1 DESC

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @postingDT, @SalesTT, @orderTT

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + 
			' <tr style="background-color:' + @bgcolor + ';">
				<td>' + CAST(@postingDT AS VARCHAR(11)) + '</td>
				<td align="center" >' + '$' + CONVERT(varchar(50), CAST(ISNULL(@SalesTT, 0) AS MONEY), 1) + '</td>
				<td align="center" >' + CONVERT(varchar(50), ISNULL(@orderTT, 0), 1) + '</td>
			</tr>'
		
				
		FETCH NEXT FROM sCursor INTO @postingDT, @SalesTT, @orderTT
	   END

	CLOSE sCursor
	DEALLOCATE sCursor

	SET @body1 = @body1 + '</table></body></html>'

	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'cbible@katom.com; jrogers@katom.com; pchesworth@katom.com; dlu@katom.com'
--	SET @email1 = 'dlu@katom.com'	
	SET @subject1 = 'NUMBER OF ORDERS PROCESSED THROUGH THE WAREHOUSE'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[Email_ActiveProductsOrNot]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[Email_ActiveProductsOrNot]
AS
BEGIN
	DECLARE @code VARCHAR(100), @blocked BIT, @webitem BIT, @active BIT, @status VARCHAR(25), @qtyOnHand INT, @counter INT
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150), @bgcolor VARCHAR(500)
	
	SET @counter = 1
	--PRODUCTS SHOWING ACTIVE ON MIVA BUT NOT IN NAVISION
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([No_])
	SELECT code FROM ProductsMIVA WHERE active = 1

	DELETE FROM prodTemp
	WHERE [No_] in (SELECT [No_] COLLATE Latin1_General_CS_AS 
					 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] 
					 WHERE [Blocked] = 0 AND [Web Item] = 1 AND [Web Active] = 1 AND [Status] <> 2)
						 
	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Backorder Item</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">	
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td colspan="6">Products Active on Website (MIVA) but not active according to NAV</td>
	  </tr>	
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="text-align:center; width: 100px;">Product Code</td>
		<td style="text-align:center; width: 100px;">Blocked</td>
		<td style="text-align:center; width: 100px;">Web Item</td>
		<td style="text-align:center; width: 100px;">Web Active</td>
		<td style="text-align:center; width: 100px;">Status</td>
		<td style="text-align:center; width: 100px;">Qty On Hand</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT t.[No_], i.[Blocked], i.[Web Item], i.[Web Active], 
		CASE i.[Status]
			WHEN 2 THEN 'Discontinued'
			ELSE 'Active'
		END [Status], 
		p.qtyOnHand
	FROM prodTemp t LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item]  i on t.[No_] = i.[No_] COLLATE Latin1_General_CS_AS
					LEFT JOIN products p on p.CODE = t.[No_]
	WHERE p.qtyOnHand = 0

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @code, @blocked, @webitem, @active, @status, @qtyOnHand

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + ISNULL(@code, '') + '</td>'
		
		IF @blocked IS NULL
		   BEGIN
			SET @body1 = @body1 + '<td align="center" >NOT IN NAV</td>'
		   END
		ELSE
		   BEGIN
			SET @body1 = @body1 + '<td align="center" >' + CAST(ISNULL(@blocked, '') AS VARCHAR(100))  + '</td>'		   
		   END
		SET @body1 = @body1 + '<td align="center" >' + CAST(ISNULL(@webitem, '') AS VARCHAR(100)) + '</td>
			<td align="center" >' + CAST(ISNULL(@active, '') AS VARCHAR(100)) + '</td>
			<td align="center" >' + CAST(ISNULL(@status, '') AS VARCHAR(100)) + '</td>
			<td align="center" >' + CAST(ISNULL(@qtyOnHand, '') AS VARCHAR(11)) + '</td>
		  </tr>' 
				
		FETCH NEXT FROM sCursor INTO @code, @blocked, @webitem, @active, @status, @qtyOnHand
	   END

	CLOSE sCursor
	DEALLOCATE sCursor

	SET @body1 = @body1 + '</table><br /><br />
	  <table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">	
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td>Products NOT Active on Website (MIVA) but should be active according to NAV</td>
	  </tr>'

	--PRODUCTS SHOWING ACTIVE ON NAV BUT NOT IN MIVA
	truncate table prodTemp
	insert into prodTemp([No_], [Blocked])
	select [No_], [Status]
	from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] 
	where [Blocked] = 0 and [Web Item] = 1 and [Web Active] = 1

	DELETE FROM prodTemp WHERE [No_] IN (SELECT code COLLATE Latin1_General_CS_AS FROM ProductsMIVA WHERE active = 1)

	DELETE FROM prodTemp WHERE [No_] IN
	(
	SELECT [No_]
	FROM prodTemp t JOIN products p on t.[No_] = p.CODE
	where qtyOnHand > 0 and [Blocked] = 2
	)

	DECLARE sCursor CURSOR FOR 	
	SELECT [No_] FROM prodTemp WHERE [Blocked] <> 2

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @code

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @code + '</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @code
	   END

	CLOSE sCursor
	DEALLOCATE sCursor

	SET @body1 = @body1 + '</table>'

	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'smosley@katom.com; david@katom.com; paula@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Products: Active or Not?'
EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[ebayOrderImport]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[ebayOrderImport] 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

--Fire the DTS package that pulls any text files into the ebay orders table

/*Begins the loop to pull down and parse payment information*/
	DECLARE @ebayOrder varchar(20)
	
	DECLARE ebayCursor CURSOR FOR 
	select distinct([invoice id]) from ebayorders where imported <> 1

	OPEN ebayCursor

	FETCH NEXT FROM ebayCursor INTO @ebayOrder

	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	print @ebayOrder
	
	--Insert Header
	insert order_hdr
	([customerpo],[CustomerPO2],[selltoemail],[shiptoaddress],[shiptocity],[shiptostate],[shiptozip],
	[shiptocountry],[selltocustomername],[selltophone],[shipamount],[shiptocontact],[shiptoemail],[shiptocustomername],
	[phoneno],[faxno],[avsaddr],[avszip],[cvv2match],[respcode],
	[orderplacedby],[paymenttermscode],[CustomerSource], [importValidated], [exported], [batchtimestamp],
	ccnum, ccname, ccexpmo, ccexpyr, cvc,
	[selltocontact],[selltoaddress],[selltocity],[selltostate],[selltozip],[shipmethod],[ordertimestamp],[selltocountry], [shiptoaddress2], pnref, AmountSubmitted
	)
	select top 1 [invoice id], [site auction id], [buyer e-mail address], [shipping addr 1],
	[shipping city], [shipping region], [shipping postal code], [shipping country], [buyer first name]+' '+[buyer last name] as buyername, 
	[buyer day phone],[Shipping Cost], [buyer first name]+' '+[buyer last name] as shiptocontact,[buyer e-mail address], 
	[buyer first name]+' '+[buyer last name] as shiptocustmername, [buyer day phone] as phoneno, '' as faxno, 
	null as avsaddr, null as avszip, null as cvv2match, 0 as respcode, 
	'EB' as orderplacedby, CASE when [external Payment transaction id] <> '' THEN 'PP' ELSE 'CC' END as paymenttermscode, 'E' as customersource, 0 as [importValidated], 0 as exported,
	getdate() as batchtimestamp, null as [ccnum], 1 as [ccname], 1 as [ccexpmo], 2011 as [ccexpyr], 1 as [cvc],
	[buyer first name]+' '+[buyer last name] as selltocontact, [shipping addr 1] as selltoaddress,
	[shipping city] as selltocity, [shipping region] as selltostate, [shipping postal code] as selltozip,
	'Shipping: '+[Shipping Carrier]+' '+[Shipping Class Code] as shipmethod, [Invoice Date],
	[shipping country] as selltocountry, [shipping addr 2] as shippingaddress2, [External Payment Transaction ID] as pnref, [Order Total] as amount
	from ebayOrders
	where [invoice id] = @ebayOrder
	
	
	--Insert Items
	insert order_items (order_id, code, name, quantity, price, taxable, upsold, line_id, product_id, weight)
	select [invoice ID], sku, Title, Quantity, [Unit Price], 1 as taxable, 0 as upsold,
	right([Site Auction ID],5) as line_id,
	(select mivaprodid from products p where p.CODE = e.sku) as product_id,
	(select weight from products p where p.CODE = e.sku) as weight
	from ebayOrders e
	where [invoice id] = @ebayOrder
	
	--Insert Shipping Charge		
	insert into order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)
	select top 1 [invoice id] as order_id, [invoice id] as charge_id, '160' as module_id, 'SHIPPING' as type, 'Shipping: '+[shipping carrier]+' '+[shipping class] as descrip, [shipping cost] as amount, [shipping cost] as disp_amt, 0 as tax_exempt  from ebayOrders
	where [invoice id] = @ebayOrder
	
	insert into order_options(order_id, line_id, attr_id, attr_code, opt_code, price, option_id, attmpat_id,  weight, data, data_long)
	select top 1 [invoice id] as order_id, 0 as line_id, '160' as attr_id, 'SHIPPING' as attr_code, 'Shipping: '+[shipping carrier]+' '+[shipping class] as opt_code, [shipping cost] as amount, '420', null, null, null, null
		 from ebayOrders
	where [invoice id] = @ebayOrder
	
	--Set imported value to 1
	update ebayorders 
	set imported = 1
	where [invoice id] = @ebayOrder
	
	
				
	FETCH NEXT FROM ebayCursor INTO @ebayOrder
	END

	CLOSE ebayCursor

	DEALLOCATE ebayCursor
	
	UPDATE order_hdr set ccexpmo = 1, ccexpyr = 2011 where orderplacedby = 'EB' and paymenttermscode = 'CC'

END
GO
/****** Object:  StoredProcedure [dbo].[MFG_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[MFG_SP]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('MFG_UPD', GETDATE())
	SET @jobID = @@identity

	--TODAY LOGIC IS LIMITTING THE MFGID TO 3 DIGITS AND IT IS RECYCLABLE. 
	INSERT INTO  mfg(mfgID, navName, mfgName, mfgShortName, shipDirect, ebay, isWeb, Active, addedDT)
	SELECT [No_], Name, [Name 2], [Name 2], [Drop Ship Only], 0, 0, 0, GETDATE()
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] 
	WHERE LEN([No_]) = 3 
		AND [No_] NOT IN (SELECT mfgid COLLATE SQL_Latin1_General_CP1_CI_AS FROM mfg)

	--COUNTING THE NUMBER OF ACTIVE PRODUCTS
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Mfg ID], Blocked)
	SELECT mfgid, COUNT(*) FROM products WHERE active = 1 GROUP BY mfgid

	UPDATE m
	SET m.activeProdCount = p.Blocked
	FROM mfg m join prodTemp p on m.mfgID = p.[Mfg ID]

	UPDATE mfg
	SET isWeb = 1, Active = 1
	WHERE DATEDIFF(DAY, GETDATE(), addedDT) = 0 AND activeProdCount > 0

	--REMOVE MFG INFO WHERE IT DOES NOT EXIST IN NAV
	DELETE FROM mfg WHERE mfgID NOT IN (SELECT [No_] COLLATE Latin1_General_CS_AS FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] )

	--UPDATING MFG INFO
	UPDATE m
	SET m.NAVName = LTRIM(RTRIM(v.Name))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v JOIN mfg m on v.[No_] = m.mfgID COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE m.NAVName <> LTRIM(RTRIM(v.Name)) COLLATE SQL_Latin1_General_CP1_CI_AS

	UPDATE m
	SET m.mfgName = LTRIM(RTRIM(v.[Name 2]))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v JOIN mfg m on v.[No_] = m.mfgID COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE m.mfgName <> LTRIM(RTRIM(v.[Name 2])) COLLATE SQL_Latin1_General_CP1_CI_AS

	UPDATE m
	SET m.shipDirect = LTRIM(RTRIM(v.[Drop Ship Only])),
		m.dropShipCapable = LTRIM(RTRIM(v.[Drop Ship Capable])),
		m.dropShipMin = LTRIM(RTRIM([Min_ Amount to Drop Ship]))
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v JOIN mfg m on v.[No_] = m.mfgID COLLATE SQL_Latin1_General_CP1_CI_AS

	TRUNCATE TABLE prodTemp
		
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

END
GO
/****** Object:  StoredProcedure [dbo].[keywordImport]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[keywordImport] 
AS
BEGIN
	
	INSERT INTO keywordSearched(searchDT, keyword, ipaddress)
	SELECT * FROM openquery(MYSQL, '
	SELECT *
	FROM katom_mm5.SLISearchTerm
	WHERE DATEDIFF(date, now()) = -1')

	DECLARE @newkeyword int, @sqlCommand varchar(max)

	set @sqlCommand = ''
	set @newkeyword = 0
	truncate table keywordWorktable
	
	insert into keywordWorktable(keyword, numSearched)
	select dbo.keywordCleaner(replace(replace(replace(replace(keyword, '/', '-'), '@', '-'), '(', ''), ')', '')), count(*)
	from keywordSearched
	where isnull(ipAddress, '') not in (select ipAddress from iplookup)
		and LEN(ltrim(rtrim(keyword))) > 2
		and DATEDIFF(day, searchDT, GETDATE()) = 1
		and (ltrim(rtrim(keyword)) not like '%katom%'
				and ltrim(rtrim(keyword)) not like '%return%')
		and keyword not in (select keyword from keywordSearched where LEN(ltrim(rtrim(keyword))) = 3 and ISNUMERIC(keyword) = 1)		
		and keyword not in (select keyword from keywordNegative)
	group by dbo.keywordCleaner(replace(replace(replace(replace(keyword, '/', '-'), '@', '-'), '(', ''), ')', ''))
	order by 2 desc

	update s
	set s.timeSearched = s.timeSearched + kw.numSearched,
		s.updatedt = GETDATE()
	from keywordWorktable kw join searchTerm s on kw.keyword = s.keyword

	insert into searchTerm
	select *, 0 
	from keywordWorktable 
	where keyword not in (select keyword from searchTerm)

	--select @newkeyword =
	--		CASE 
	--			WHEN COUNT(*) > 2499 THEN 0
	--			ELSE 2500-COUNT(*) 
	--		END 
	--from searchTerm where DATEDIFF(day, updatedt, GETDATE()) = 0 and addToMap = 0


	--IF @newkeyword > 0 
	--   BEGIN
	--	update searchTerm
	--	set addToMap = 1
	--	where addToMap = 0 and DATEDIFF(day, updatedt, GETDATE()) = 0 and timeSearched > 9

	--	SET @sqlCommand = 'update searchTerm
	--						set addToMap = 1
	--						where addToMap = 0
	--								AND keyword in (select top ' + cast(@newkeyword as varchar(10)) + ' keyword 
	--												from searchterm where  where timeSearched > 9 and addtoMap = 0 order by timesearched desc' 
	--	exec (@sqlCommand)
	--   END
	   
	--truncate table keywordWorktable
	--set @newkeyword = 0
	--set @sqlCommand = ''
	
END
GO
/****** Object:  StoredProcedure [dbo].[InvoiceEmailer_OldNav]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InvoiceEmailer_OldNav] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


/*Begins the loop to pull down and parse payment information*/
	DECLARE @selltoname varchar(30)
	DECLARE @selltoaddress varchar(30)
	DECLARE @selltoaddress2 varchar(30)
	DECLARE @selltocity varchar(30)
	DECLARE @selltostate varchar(10)
	DECLARE @selltozip varchar(10)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoaddress varchar(30)
	DECLARE @shiptoaddress2 varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @orderdate varchar(255)
	DECLARE @shipmethod varchar(200)
	DECLARE @phone varchar(20)
	DECLARE @email varchar(50)
	DECLARE @confnum varchar(20)
	DECLARE @ponum varchar(20)
	DECLARE @email1 varchar(500)
	DECLARE @Navorder varchar(500)
	DECLARE @order varchar(500)
	DECLARE @subject1 varchar(150)
	DECLARE @body1 varchar(MAX)
	
	DECLARE @prodcode varchar(50)
	DECLARE @prodqty varchar(50)
	DECLARE @prodimg varchar(100)
	DECLARE @prodname varchar(200)
	DECLARE @prodprice varchar(100)
	DECLARE @prodtotal varchar(100)
	DECLARE @total varchar(100)
	DECLARE @shipping varchar(100)
	DECLARE @tax varchar(100)
	DECLARE @ordertotal varchar(100)
/*
	DECLARE @email varchar(50)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)
	DECLARE @delivereddate varchar(255)
	DECLARE @shipdate varchar(255)
	DECLARE @delivered varchar(255)
	DECLARE @emailupdate bit
	DECLARE @trackingscan varchar(255)
*/

	DECLARE OrderCursor CURSOR FOR 
	
	select
	--*,
		h.No_ as NavOrdNo, 
		[sell-to customer name] as selltoname, 
		[sell-to address] as selltoaddress, 
		[sell-to address 2] as selltoaddress2, 
		[sell-to city] as selltocity, 
		[sell-to state] as selltostate, 
		[sell-to zip code] as selltozip, 
		[ship-to name] as shiptoname, 
		[Ship-to Address] as shiptoaddress, 
		[Ship-to Address 2] as shiptoaddress2, 
		[Ship-to City] as shiptocity, 
		[ship-to state] as shiptostate, 
		[ship-to zip code] as shiptozip, 
		[order date] as orderdate, 
		[Shipment Method Code] as shipmethod, 
		[Phone No_] as phone, 
		[e-mail] as email, 
		h.No_ as confnum,
		[your reference] as ponum,
		(select cast(sum(quantity*[unit price]) as decimal(8,2))
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = h.No_) as total,
		(SELECT cast(sum(amount ) as decimal(8,2))
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
		where [Document No_] = h.No_ 
		and No_ in ('420', '100-SHIPPING', '100-FREIGHT')) as shipping,
		Tax =
		CASE [Tax Area Code]
		WHEN 'TN TAXABLE' THEN
		(select cast(sum([amount including tax])-sum(amount) as decimal(8,2))
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
					--where [Document No_] = the order
					where [Document No_] = h.No_)
		ELSE 0
		END
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		where [cust__Item Disc_ Gr_] = 'KATOM'
		--and CONVERT(varchar(11), [order date], 101) = '08/24/2010'
		and h.No_ not in (select confno COLLATE Latin1_General_CI_AS from invconfxref)
		and [e-mail] like '%@%'
		and [no_ printed] > 0
		and (SELECT COUNT(*)
					FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = h.No_
					and No_ not in ('', '420', '100-SHIPPING')) > 0
					and [No_ Series] <> 'S-QUO'
		order by h.No_ desc

	OPEN OrderCursor

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @ponum, @total, @shipping, @tax
	
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
			print @selltoname
			print @confnum
			SET @orderdate = CONVERT(varchar(11), @orderdate, 101)
			IF @orderdate like '%1753%' SET @orderdate = CONVERT(varchar(11), getdate(), 101)
			SET @ordertotal = cast(@total as decimal(8,2)) + cast(@shipping as decimal(8,2)) + cast(@tax as decimal(8,2))
			SET @email1 = @email
			--SET @subject1 = 'KaTom.com Order #'+@confnum+' Invoice'
			SET @subject1 = 'KaTom.com Order #'+@confnum
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
							"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
							<title>E-Mail</title>

							<style type="text/css">
							html{font-family:Lucida Grande;}
							</style>

							</head>
<body>

<table width="710" border="0" style="font-family:sans-serif;background-color:#fff;">
  <tr>
    <td colspan="3"><p style="color:#aaaaaa;font-size:12px;">
<!--Are you having difficulty viewing our HTML email? <a title="View this email in a browser window" href="http://www.katom.com/Merchant2/email_price_browser_window.php?a=$a">View this email in a browser window</a>-->
</p>
</td>
  </tr>
  <tr>
    <td colspan="3">
	<h1><a href="http://www.katom.com" title="KaTom Restaurant Supply"><img src="http://www.katom.com/Merchant2/images/KaTom_Seasonal_Logo_FNL_72dpi.jpg" 	width="200" height="75"	border="none" alt="KaTom Restaurant Supply Inc." title="KaTom Restaurant Supply Inc."/></a></h1>
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/Restaurant-equipment.html" title="Restauant-Equipment">Restaurant Equipment</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/countertop.html" title="Countertop">Countertop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/janitorial.html" title="Janitorial">Janitorial</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/kitchen-supplies.html" title="Kitchen Supplies">Kitchen Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/tabletop.html" title="Tabletop">Tabletop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/furniture.html" title="Furniture">Furniture</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/bar-supplies.html" title="Bar-Supplies">Bar Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #a91c20;font-weight:bold;text-decoration: none;" href="http://www.katom.com/clearance-sale.html"  title="clearance-sale">Clearance Sale</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #025eaa;font-weight:bold;text-decoration: none;" href="http://www.katom.com/residential.html"  title="Residential">Residential</a>

	
</td>
  </tr>
<tr>
	<td colspan="4">
    <table width="710" border="0" style="border-width: 1px;
	padding: 1px;
	border-style:solid;
	border-color: gray;">
  <tr>
		<td colspan="5" bgcolor="#2E59CB" height="29" align="center">
            <span style="font-size:36px; color:#FFF; font-weight:bold">HOORAY!!!</span>
            </td>
          </tr>

          <tr>
			  <td width="10" colspan="1"></td>
              <td width="429" colspan="1">
                    <span style="font-family:Tahoma, Geneva, sans-serif; font-size:18px; color:#06C">Dear '+@selltoname+'</span>
              </td>
                <td width="349" colspan="2" align="right" valign="middle">
                    <img src="http://www.katom.com/images/mailericons/processed.png" alt="Processed" border="none" align="absmiddle" title="Order Processed"/>
              </td>
              <td>
              </td>
          </tr>
          <tr>
            <td width="10" colspan="1"></td>
          	<td colspan="3">
            <span style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;" >
              <p>Thank you for shopping at KaTom Restaurant Supply.              </p>
              <p>We are pleased to inform you that your order has processed and it is being sent to our warehouse for the Coup De Grace.<br/>
			
			We greatly appreciate your business and patience.
              </p>
              <p>If you have any questions, you can reach our Customer Appreciation Team through email at sales@katom.com, Live Chat with us, 
                or call us at 1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm.                </p>
              <p>Order Confirmation Number: <span style="font-size:12px; font-weight:bold;">'+@confnum+'</span><br />
                Sales Order Date: <span style="font-size:12px; font-weight:bold;">'+@orderdate+' </span></p>
			</span>
            </td>
            <td>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Contact Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td height="103" colspan="4" valign="top" align="left">
            <table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr>
				<td height="9px">
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td style="font-size:12px; font-weight:600">
				&nbsp;Billing Address:
				</td>
				<td style="font-size:12px; font-weight:600">
				Shipping Address:
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td>
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>&nbsp;'+@selltoname+'</td></tr>
				<tr><td>&nbsp;'+@selltoaddress+'</td></tr>
				<tr><td>&nbsp;'+@selltocity+', '+@selltostate+' '+@selltozip+'</td></tr>
				<tr><td>&nbsp;Primary Phone: '+@phone+'</td></tr>
				<tr><td>&nbsp;Email: '+@email+'</td></tr>
				</table>
				</td>
				<td valign="top">
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>'+@shiptoname+'</td></tr>
				<tr><td>'+@shiptoaddress+'</td></tr>
				<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
				</table>
				</td>
				</tr>
				</table>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
         	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Order Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
   	  <td colspan="4" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">
            	<p>&nbsp;Order Confirmation Number: '+@confnum+'<br />'

            	IF @ponum <> '' SET @body1= @body1+'&nbsp;Customer PO Number: '+@ponum+'<br />'

            	SET @body1=@body1+'
                &nbsp;Order Date: '+@orderdate+'<br />
                <!--&nbsp;&nbsp;Shipping Preference:<br />
                &nbsp;&nbsp;Payment Method:<br />-->
                <br/>
                <br/>
           	  <table width="100%" cellpadding="0" cellspacing="0" >
               	  <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:14px; font-weight:600">
               		  <td width="10" colspan="1"></td>
                   	  <td colspan="2" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;" >
                		&nbsp;&nbsp;Product
                      </td>
                      <td width="67" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;">
                      <div align="center">Qty </div></td>
                      <td width="118" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;">
                      <div align="right">Price &nbsp;&nbsp;</div></td>
                  </tr>
                  <tr>
					<td>
						&nbsp;
					</td>
				  </tr>
                  <!-- Begin Loop for Products -->'
			DECLARE ItemCursor CURSOR FOR 
			
                  SELECT No_ as code, cast(quantity as decimal(8,0)) as quantity, 'http://www.katom.com/Merchant2/products/'+left(image,3)+'/'+replace(lower(image),'.jpg','')+'_th.jpg' as image, NAME, [unit price], cast(([unit price]*quantity)as decimal(8,2)) as prodtotal
					FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = @Navorder
					and No_ not in ('', '420', '100-SHIPPING')

            OPEN ItemCursor

				FETCH NEXT FROM ItemCursor INTO @prodcode, @prodqty, @prodimg, @prodname, @prodprice, @prodtotal
				
				
				WHILE @@FETCH_STATUS = 0
				BEGIN      
                
                SET @body1 = @body1+'<tr valign="top" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                  				<td width="10" colspan="1"></td>
                  				<td>&nbsp;<img src="'+@prodimg+'" width="100" /></td>
								<td><a href="http://www.katom.com/'+@prodcode+'.html">'+@prodname+'</a><br />
								<strong>Product Code: '+@prodcode+'</strong>
								</td>
								<td align="center">'+@prodqty+'</td>
								<td align="right">'+@prodtotal+'&nbsp;&nbsp;</td>
							</tr>'
                  
                 	FETCH NEXT FROM ItemCursor INTO @prodcode, @prodqty, @prodimg, @prodname, @prodprice, @prodtotal

				END

				CLOSE ItemCursor

				DEALLOCATE ItemCursor
              
    SET @body1 = @body1+'<!-- End Loop for Products -->
                  </table>
            </td>
          </tr>
          <tr>
			<td colspan="4" align="right" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">'
	IF @tax <> '0.00' SET @body1 = @body1+'Tax: '+@tax+'&nbsp;&nbsp;</br>'
	
	SET @body1 = @body1+'</td>
		  </tr>
		  <tr>
			<td colspan="4" align="right" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">
				Shipping: '+@shipping+'&nbsp;&nbsp;</br>
			</td>
		  </tr>
		  <tr>
			<td width="10" colspan="1"></td>
         	<td colspan="4" bgcolor="#2E59CB" height="29" align="right">
            <span style="font-size:16px; color:#FFF; font-weight:bold">Order Total: $'+(@ordertotal)+'&nbsp;&nbsp;</span>
            </td>
          </tr>
          <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
          	<td width="10" colspan="1"></td>
          	<td colspan="4">
				At KaTom Restaurant Supply, we believe Its About You.  Our dedicated team thrives to ensure that your shopping experience at KaTom.com should be awesome!<br /><br />
				Please <a href="mailto:sales@katom.com">let us know</a> if we can make your shopping experience any better!<br /><br />
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:800">
            	Contact The KaTom Customer Appreciation Team:<br />
            </td>
          </tr>
          <tr>
				<td width="10" colspan="1"></td>
                <td colspan="3">
                    <Table style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                        <tr>
                            <td style="font-weight:600">
                                Email:
                            </td>
                            <td>
                                sales@katom.com
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;
                                
                            </td>
                            <td>
                                Live Chat Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Phone
                            </td>
                            <td>
                                1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Website
                            </td>
                            <td>
                                http://www.katom.com
                        	</td>
                        </tr>
   		           </Table>
              </td>
          </tr>
		</table>
    </td>
</tr>
</table>
</body>
				</html>'

	
	PRINT @Navorder+'on '+@orderdate
	
	IF @body1 <> '' BEGIN Insert into invconfxref (confno, orderdate) values (@Navorder, @orderdate) PRINT 'Confirmation Email sent' END

	IF @body1 <> '' EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

	
	
	--print @order

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @ponum, @total, @shipping, @tax

	END

	CLOSE OrderCursor

	DEALLOCATE OrderCursor

/*Reset
select * from shipxref where trackno = '053260560918289 '
delete from shipxref where id = 15628
*/

END
GO
/****** Object:  StoredProcedure [dbo].[InvoiceEmailer]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InvoiceEmailer] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


/*Begins the loop to pull down and parse payment information*/
	DECLARE @selltoname varchar(30)
	DECLARE @selltoaddress varchar(30)
	DECLARE @selltoaddress2 varchar(30)
	DECLARE @selltocity varchar(30)
	DECLARE @selltostate varchar(10)
	DECLARE @selltozip varchar(10)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoaddress varchar(30)
	DECLARE @shiptoaddress2 varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @orderdate varchar(255)
	DECLARE @shipmethod varchar(200)
	DECLARE @phone varchar(20)
	DECLARE @email varchar(50)
	DECLARE @confnum varchar(20)
	DECLARE @ponum varchar(20)
	DECLARE @webnum varchar(20)
	DECLARE @email1 varchar(500)
	DECLARE @Navorder varchar(500)
	DECLARE @order varchar(500)
	DECLARE @subject1 varchar(150)
	DECLARE @body1 varchar(MAX)	
	DECLARE @prodcode varchar(50)
	DECLARE @prodqty varchar(50)
	DECLARE @prodimg varchar(100)
	DECLARE @prodname varchar(200)
	DECLARE @prodprice varchar(100)
	DECLARE @prodtotal varchar(100)
	DECLARE @total varchar(100)
	DECLARE @shipping varchar(100)
	DECLARE @tax varchar(100)
	DECLARE @ordertotal varchar(100)

	DECLARE OrderCursor CURSOR FOR 
	
	select 
		h.No_ as NavOrdNo, 
		[sell-to customer name] as selltoname, 
		[sell-to address] as selltoaddress, 
		[sell-to address 2] as selltoaddress2, 
		[sell-to city] as selltocity, 
		[sell-to county] as selltostate, 
		[sell-to post code] as selltozip, 
		[ship-to name] as shiptoname, 
		[Ship-to Address] as shiptoaddress, 
		[Ship-to Address 2] as shiptoaddress2, 
		[Ship-to City] as shiptocity, 
		[ship-to county] as shiptostate, 
		[ship-to post code] as shiptozip, 
		[order date] as orderdate, 
		[Shipment Method Code] as shipmethod, 
		[Phone No_] as phone, 
		[e-mail] as email, 
		h.No_ as confnum,
		[your reference] as ponum,
		[Web Order No_] as webnum,
		(select cast(sum(quantity*li.[unit price]) as decimal(8,2))
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line] li
					left join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
					on i.No_ = li.No_
					where [Document No_] = h.No_) as total,  --Products/Item Total
		(SELECT isnull(cast(sum(amount ) as decimal(8,2)),'0.00')
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
		where [Document No_] = h.No_ 
		and No_ in ('420', '100-SHIPPING')) as shipping,  --Shipping Amount from these 2 accounts, are there more?
		(select cast(sum([Amount Including VAT])-sum(amount) as decimal(8,2))
		FROM fs1.[Katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
					--where [Document No_] = the order
					where [Document No_] = h.No_) as tax
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] h
		where [Shortcut Dimension 2 Code] = 'KATOM'  --Katom Customers Only
		and h.No_ not in (select confno COLLATE Latin1_General_CI_AS from invconfxref)  --Prevents duplicate emails
		and [e-mail] like '%@%' and [e-mail] <> 'CHARLES.GRIFFIN@pilottravelcenters.com'  --Pilot Exclusion
		--and [no_ printed] > 0 --Disabled due to questionable relevance
		and [No_ Series] <> 'S-QUO'  --Excludes Quotes
		and (SELECT COUNT(*)
					FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line] l
					where [Document No_] = h.No_
					) > 0  --Insures that the document is not empty
		and datediff(d, getdate(), [posting date]) > -30  --examines only documents from the past 2 weeks
		and [Source Code] <> 'DELETE' --Insures no deleted documents
		order by h.No_ desc

	OPEN OrderCursor

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @ponum, @webnum, @total, @shipping, @tax
	
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
			SET @orderdate = CONVERT(varchar(11), @orderdate, 101)
			IF @orderdate like '%1753%' SET @orderdate = CONVERT(varchar(11), getdate(), 101)
			IF @tax is null SET @tax = 0
			SET @ordertotal = cast(@total as decimal(8,2)) + cast(@tax as decimal(8,2))
			SET @email1 = @email
			
			IF len(@webnum) > 0 SET @subject1 = 'KaTom.com Order #'+@webnum+' Invoice'
			ELSE SET @subject1 = 'KaTom.com Order '+@confnum+' Invoice'
			
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
							"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
							<title>E-Mail</title>

							<style type="text/css">
							html{font-family:Lucida Grande;}
							</style>

							</head>
<body>

<table width="710" border="0" style="font-family:sans-serif;background-color:#fff;">
  <tr>
    <td colspan="3"><p style="color:#aaaaaa;font-size:12px;">
</p>
</td>
  </tr>
  <tr>
    <td colspan="3">
	<h1><a href="http://www.katom.com" title="KaTom Restaurant Supply"><img src="https://www.katom.com/bimages/katom.png" 	width="200" height="75"	border="none" alt="KaTom Restaurant Supply Inc." title="KaTom Restaurant Supply Inc."/></a></h1>
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/Restaurant-equipment.html" title="Restauant-Equipment">Restaurant Equipment</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/countertop.html" title="Countertop">Countertop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/janitorial.html" title="Janitorial">Janitorial</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/kitchen-supplies.html" title="Kitchen Supplies">Kitchen Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/tabletop.html" title="Tabletop">Tabletop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/furniture.html" title="Furniture">Furniture</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/bar-supplies.html" title="Bar-Supplies">Bar Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #a91c20;font-weight:bold;text-decoration: none;" href="http://www.katom.com/clearance-sale.html"  title="clearance-sale">Clearance Sale</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #025eaa;font-weight:bold;text-decoration: none;" href="http://www.katom.com/residential.html"  title="Residential">Residential</a>

	
</td>
  </tr>
<tr>
	<td colspan="4">
    <table width="710" border="0" style="border-width: 1px;
	padding: 1px;
	border-style:solid;
	border-color: gray;">
  <tr>
		<td colspan="5" bgcolor="#2E59CB" height="29" align="center">
            <span style="font-size:36px; color:#FFF; font-weight:bold">HOORAY!!!</span>
            </td>
          </tr>

          <tr>
			  <td width="10" colspan="1"></td>
              <td width="429" colspan="1">
                    <span style="font-family:Tahoma, Geneva, sans-serif; font-size:18px; color:#06C">Dear '+@selltoname+'</span>
              </td>
                <td width="349" colspan="2" align="right" valign="middle">
                    <img src="http://www.katom.com/images/mailericons/processed.png" alt="Processed" border="none" align="absmiddle" title="Order Processed"/>
              </td>
              <td>
              </td>
          </tr>
          <tr>
            <td width="10" colspan="1"></td>
          	<td colspan="3">
            <span style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;" >
              <p>Thank you for shopping at KaTom Restaurant Supply.              </p>
              <p>We are pleased to inform you that your order has processed and it is being sent to our warehouse for processing.<br/>
			Tracking information will be sent to you as soon as possible once your order ships.<br/>
			We greatly appreciate your business and patience.
              </p>
              <p>If you have any questions, you can reach our Customer Appreciation Team through email at sales@katom.com, Live Chat with us, 
                or call us at 1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm.                </p>
              <p>Order Invoice Number: <span style="font-size:12px; font-weight:bold;">'+@webnum+'</span><br />
                Sales Order Date: <span style="font-size:12px; font-weight:bold;">'+@orderdate+' </span></p>
			</span>
            </td>
            <td>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Contact Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td height="103" colspan="4" valign="top" align="left">
            <table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr>
				<td height="9px">
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td style="font-size:12px; font-weight:600">
				&nbsp;Billing Address:
				</td>
				<td style="font-size:12px; font-weight:600">
				Shipping Address:
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td>
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>&nbsp;'+@selltoname+'</td></tr>
				<tr><td>&nbsp;'+@selltoaddress+'</td></tr>
				<tr><td>&nbsp;'+@selltocity+', '+@selltostate+' '+@selltozip+'</td></tr>
				<tr><td>&nbsp;Primary Phone: '+@phone+'</td></tr>
				<tr><td>&nbsp;Email: '+@email+'</td></tr>
				</table>
				</td>
				<td valign="top">
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>'+@shiptoname+'</td></tr>
				<tr><td>'+@shiptoaddress+'</td></tr>
				<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
				</table>
				</td>
				</tr>
				</table>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
         	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Order Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
   	  <td colspan="4" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">
            	<p>&nbsp;Order Invoice Number: '+@confnum+'<br />'

            	IF @ponum <> '' SET @body1= @body1+'&nbsp;Customer PO Number: '+@ponum+'<br />'

            	SET @body1=@body1+'
                &nbsp;Order Date: '+@orderdate+'<br />
                <!--&nbsp;&nbsp;Shipping Preference:<br />
                &nbsp;&nbsp;Payment Method:<br />-->
                <br/>
                <br/>
           	  <table width="100%" cellpadding="0" cellspacing="0" >
               	  <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:14px; font-weight:600">
               		  <td width="10" colspan="1"></td>
                   	  <td colspan="2" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;" >
                		&nbsp;&nbsp;Product
                      </td>
                      <td width="67" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;">
                      <div align="center">Qty </div></td>
                      <td width="118" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;">
                      <div align="right">Price &nbsp;&nbsp;</div></td>
                  </tr>
                  <tr>
					<td>
						&nbsp;
					</td>
				  </tr>
                  <!-- Begin Loop for Products -->'
			DECLARE ItemCursor CURSOR FOR 
			
                  SELECT li.No_ as code, cast(quantity as decimal(8,0)) as quantity, 'http://www.katom.com/products/'+left([Image File Name],3)+'/'+replace(lower([Image File Name]),'.jpg','')+'.jpg' as image, li.[Description] as NAME, li.[unit price], cast((li.[unit price]*quantity)as decimal(8,2)) as prodtotal
					FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line] li
					left join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
					on i.No_ = li.No_
					where [Document No_] = @Navorder
					and li.No_ not in ('', '420', '100-SHIPPING', '205', 'MSG', '/"', '250')

            OPEN ItemCursor

				FETCH NEXT FROM ItemCursor INTO @prodcode, @prodqty, @prodimg, @prodname, @prodprice, @prodtotal
				
				
				WHILE @@FETCH_STATUS = 0
				BEGIN      
                
                SET @body1 = @body1+'<tr valign="top" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                  				<td width="10" colspan="1"></td>
                  				<td>&nbsp;'
                  				
				IF @prodimg IS NOT NULL SET @body1 = @body1+'<img src="'+@prodimg+'" width="100" />'
                  				
				SET @body1 = @body1+'</td><td>'
				
				IF @prodimg IS NOT NULL SET @body1 = @body1+'<a href="http://www.katom.com/'+@prodcode+'.html">'+@prodname+'</a><br /><strong>Product Code: '+@prodcode+'</strong>'
				ELSE SET @body1 = @body1+@prodname+'<br />'
				
				SET @body1 = @body1+'</td>
								<td align="center">'+@prodqty+'</td>
								<td align="right">'+@prodtotal+'&nbsp;&nbsp;</td>
							</tr>'
															
                 	FETCH NEXT FROM ItemCursor INTO @prodcode, @prodqty, @prodimg, @prodname, @prodprice, @prodtotal

				END

				CLOSE ItemCursor

				DEALLOCATE ItemCursor
				
    SET @body1 = @body1+'<!-- End Loop for Products -->
                  </table>
            </td>
          </tr>
          <tr>
			<td colspan="4" align="right" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">'
	IF @tax <> '0.00' SET @body1 = @body1+'Tax: '+@tax+'&nbsp;&nbsp;</br>'
	
	SET @body1 = @body1+'</td>
		  </tr>
		  <tr>
			<td colspan="4" align="right" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">
				Shipping: '+@shipping+'&nbsp;&nbsp;</br>
			</td>
		  </tr>
		  <tr>
			<td width="10" colspan="1"></td>
         	<td colspan="4" bgcolor="#2E59CB" height="29" align="right">
            <span style="font-size:16px; color:#FFF; font-weight:bold">Order Total: $'+(@ordertotal)+'&nbsp;&nbsp;</span>
            </td>
          </tr>
          <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
          	<td width="10" colspan="1"></td>
          	<td colspan="4">
				At KaTom Restaurant Supply, we believe Its About You.  Our dedicated team thrives to ensure that your shopping experience at KaTom.com should be awesome!<br /><br />
				Please <a href="mailto:sales@katom.com">let us know</a> if we can make your shopping experience any better!<br /><br />
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:800">
            	Contact The KaTom Customer Appreciation Team:<br />
            </td>
          </tr>
          <tr>
				<td width="10" colspan="1"></td>
                <td colspan="3">
                    <Table style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                        <tr>
                            <td style="font-weight:600">
                                Email:
                            </td>
                            <td>
                                sales@katom.com
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;
                                
                            </td>
                            <td>
                                Live Chat Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Phone
                            </td>
                            <td>
                                1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Website
                            </td>
                            <td>
                                http://www.katom.com
                        	</td>
                        </tr>
   		           </Table>
              </td>
          </tr>
		</table>
    </td>
</tr>
</table>
</body>
				</html>'
	
	PRINT @Navorder+'on '+@orderdate
	
	--PRINT @body1
	
	IF @body1 <> '' BEGIN Insert into invconfxref (confno, orderdate, insertdate) values (@Navorder, @orderdate, GETDATE()) PRINT 'Invoice Email sent' END

	IF @body1 <> '' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML', @blind_copy_recipients='katom.archive@gmail.com' END
		
	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @ponum, @webnum, @total, @shipping, @tax

	END

	CLOSE OrderCursor

	DEALLOCATE OrderCursor


END
GO
/****** Object:  StoredProcedure [dbo].[order_cache_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[order_cache_SP]
AS
	BEGIN	
		--INSERTING NEW WEB ORDER
	INSERT INTO orderInfo_cache(webOrderID, orderDT, customerName, shiptozip, shiptocity, shiptostate, webShippingCharge)
	SELECT customerpo, batchtimestamp, shiptocustomername, shiptozip, shiptocity, shiptostate, c.amount webEstimate
	FROM order_hdr o JOIN order_charges c ON c.order_id = o.customerpo
	WHERE DATEDIFF(HOUR, batchtimestamp, GETDATE()) < 2
		--YEAR(batchtimestamp) = 2011
		AND c.type = 'SHIPPING'
		AND customerpo NOT IN (SELECT webOrderID FROM orderInfo_cache)
	GROUP BY customerpo, batchtimestamp, shiptocustomername, shiptozip, shiptocity, shiptostate, c.amount

	--MATCHING OPEN ORDER TO WEB ORDER 
	UPDATE c
	SET c.NAVOrderID = ih.[No_],
		c.orderDT = ih.[Order Date],
		c.salesPerson = ih.[Salesperson Code],
		c.orderMedium = ih.[Order Medium],
		c.paymentType = ih.[Payment Terms Code],
		c.orderStatus = ih.[Order Status],
		c.printed = 
			CASE 
				WHEN ih.[No_ Printed] > 0 THEN 1
				ELSE 0
			END		
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
				ON c.weborderID = ih.[Web Order No_] COLLATE Latin1_General_CS_AS
	WHERE c.NAVOrderID IS NULL		 

	--MATCHING INVOICED ORDER TO WEB ORDER	 
	UPDATE c
	SET c.invoiceID = ih.[No_],
		c.invoiceDT = ih.[Posting Date],
		c.NAVOrderID = 
			CASE 
				WHEN c.NAVOrderID IS NULL THEN ih.[Order No_] COLLATE Latin1_General_CS_AS
				ELSE c.NAVOrderID
			END,
		c.orderDT = 
			CASE 
				WHEN c.orderDT IS NULL THEN ih.[Shipment Date]	
				ELSE c.orderDT
			END,
		c.shipped = 
			CASE 
				WHEN LEN(ih.[Package Tracking No_]) > 0 THEN 1
				ELSE 0
			END
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
				ON c.weborderID = ih.[Web Order No_] COLLATE Latin1_General_CS_AS
	WHERE c.invoiceID IS NULL

	----INSERTING MISSING ORDERS TO THE ORDER RPT
	--INSERT INTO orderInfo_cache(webOrderID, NAVOrderID, orderDT, InvoiceID, invoiceDT, customerName, ShipToZip, shipToCity, shipToState, 
	--	webShippingCharge, NAVShippingCharge, actuallShippingCharge, CostTT, salesTT, accessorialCharge, itemCount, salesPerson, 
	--	orderMedium, paymentType, printed, shipped, orderStatus, cancelled, ccDeclined)
	--SELECT [Web Order No_], [Order No_], [Shipment Date], [No_], [Posting Date], [Ship-to Name], 
	--	[Ship-to Post Code], [Ship-to City], [Ship-to County], NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
	--	[Salesperson Code], [Catalog Version Code], [Payment Terms Code],		
	--		1, 
	--		CASE 
	--			WHEN LEN([Package Tracking No_]) > 0 THEN 1
	--			ELSE 0
	--		END, 'Invoiced', 0, 0
	--FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] 
	--WHERE [No_] NOT IN (SELECT ISNULL(invoiceID, '') COLLATE SQL_Latin1_General_CP1_CI_AS FROM orderInfo_cache)
	--	AND YEAR([Shipment Date]) = 2011

	--MARKING CANCEL ORDER
	UPDATE c
	SET c.cancelled = 1 
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
				ON c.invoiceID = il.[Document No_] COLLATE Latin1_General_CS_AS
	WHERE il.[Description] = 'Deleted Document' AND c.cancelled = 0

	--INSERTING OPEN ORDERS FOR ORDERS THAT WERE NOT IMPORTED FROM WEB
	INSERT INTO orderInfo_cache(webOrderID, NAVOrderID, orderDT, InvoiceID, invoiceDT, customerName, ShipToZip, shipToCity, shipToState, 
		webShippingCharge, NAVShippingCharge, actuallShippingCharge, CostTT, salesTT, accessorialCharge, itemCount, salesPerson, 
		orderMedium, paymentType, printed, shipped, orderStatus, cancelled, ccDeclined)
	SELECT [Web Order No_], [No_], [Order Date], NULL, NULL, [Ship-to Name], [Ship-to Post Code], [Ship-to City], [Ship-to County], 
			NULL, NULL, NULL, NULL, NULL, NULL, NULL, [Salesperson Code], [Order Medium], [Payment Terms Code],		
			CASE 
				WHEN [No_ Printed] > 0 THEN 1
				ELSE 0
			END, 0, [Order Status], 0, 0
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] 
	WHERE [Document Type] = 1
			AND [No_] NOT IN (SELECT ISNULL(NAVOrderID, '') COLLATE SQL_Latin1_General_CP1_CI_AS FROM orderInfo_cache)
		 

	--CALCULATING ACTUAL CHARGED IN NAV
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp ([No_], UnitPrice)
	SELECT c.invoiceID, SUM([Quantity]*[Unit Price]) 
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
				ON c.invoiceID = il.[Document No_] COLLATE Latin1_General_CS_AS		
	WHERE [No_] IN ('100-FREIGHT', '420')
	GROUP BY c.invoiceID

	UPDATE c
	SET NAVShippingCharge = p.UnitPrice
	FROM orderInfo_cache c JOIN prodTemp p ON c.invoiceID = p.[No_] COLLATE Latin1_General_CS_AS	
	WHERE NAVShippingCharge IS NULL

	--CALCULATING PRODUCT MARGIN FROM OPEN ORDER
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp ([No_], UnitPrice, UnitPrice2, UnitPrice1)
	SELECT c.NAVOrderID, SUM([Quantity]*[Unit Price]) salesTT, SUM([Quantity]*[realCost]) salesTT, COUNT(*) 
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
				ON c.NAVOrderID = il.[Document No_] COLLATE Latin1_General_CS_AS
						   JOIN products_Price_Worktable p ON p.code = il.[No_] COLLATE Latin1_General_CS_AS		
	WHERE LEFT([No_], 3) NOT IN ('100-FREIGHT', '420')
	GROUP BY c.NAVOrderID

	UPDATE c
	SET salesTT = p.UnitPrice, costTT = p.UnitPrice2, itemCount = CAST(UnitPrice1 AS SMALLINT)
	FROM orderInfo_cache c JOIN prodTemp p ON c.NAVOrderID = p.[No_] COLLATE Latin1_General_CS_AS	
	WHERE costTT IS NULL

	--CALCULATING PRODUCT MARGIN FROM INVOICED ORDER
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp ([No_], UnitPrice, UnitPrice2, UnitPrice1)
	SELECT c.invoiceID, SUM(il.[Quantity]*il.[Unit Price]), SUM(il.[Quantity]*p.[Direct Unit Cost]), COUNT(*) 
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
				ON c.invoiceID = il.[Document No_] COLLATE Latin1_General_CS_AS
						   JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Price] p ON p.[Item No_] = il.[No_]		
	WHERE LEFT([No_], 3) <> '100'
		AND c.invoiceDT BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
				REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
	GROUP BY c.invoiceID

	UPDATE c
	SET salesTT = p.UnitPrice, costTT = p.UnitPrice2, itemCount = CAST(UnitPrice1 AS SMALLINT)
	FROM orderInfo_cache c JOIN prodTemp p ON c.invoiceID = p.[No_] COLLATE Latin1_General_CS_AS	
	WHERE CAST(ISNULL(costTT, -1) AS DECIMAL(10, 2)) <>  CAST(p.UnitPrice2 AS DECIMAL(10, 2))

	--TEMP FIX, DELETE WHEN LIVE 
	UPDATE c
	SET c.salesPerson = ih.[Salesperson Code],
		c.paymentType = ih.[Payment Terms Code],
		c.orderMedium = [Catalog Version Code],
		c.orderStatus = 'Invoiced',
		c.printed = 1
	FROM orderInfo_cache c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
				ON c.weborderID = ih.[Web Order No_] COLLATE Latin1_General_CS_AS
	WHERE c.salesPerson IS NULL
END
GO
/****** Object:  StoredProcedure [dbo].[openPORpt_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[openPORpt_SP]
	@pageNum int, @pageSize int, @filterBy varchar(50)

AS
BEGIN
	DECLARE @startRowIndex INT, @recTT INT
	
	select vendor, COUNT(*) orderTT from openporpt group by vendor order by vendor
	
	
	IF @pageNum = 1
		SET @startRowIndex = @pageNum
	ELSE
		SET @startRowIndex = (@pageSize*(@pageNum-1)) + 1
	
	
	IF @filterBy = 'all'
	   BEGIN		
		SELECT @recTT = COUNT(*) FROM openporpt
		
		SELECT *, @recTT recTT FROM (select o.*, c.notes, c.id, ROW_NUMBER() OVER (order by o.poNum) AS RowNum 
		from openporpt o LEFT JOIN comment c ON o.prodNum = c.prodNum COLLATE SQL_Latin1_General_CP1_CI_AS
				and o.PONum = c.documentNum COLLATE SQL_Latin1_General_CP1_CI_AS and c.documentType = 'PO') AS openPO
		WHERE RowNum BETWEEN @startRowIndex AND (@pageNum*@pageSize)
		ORDER BY 1 ASC
	   END
	ELSE
	   BEGIN		
		SELECT o.*, ISNULL(c.notes, '') notes, c.id
		FROM openporpt o LEFT JOIN comment c ON o.prodNum = c.prodNum COLLATE SQL_Latin1_General_CP1_CI_AS
				and o.PONum = c.documentNum COLLATE SQL_Latin1_General_CP1_CI_AS and c.documentType = 'PO'
		WHERE vendor = @filterBy
		ORDER BY 1, 4 ASC
	   END
	/**	
	SELECT @recTT = COUNT(*) 
	FROM  fs1.katomdev.dbo.[B&B Equipment & Supply Inc_$Purchase Line] pl
			LEFT JOIN fs1.katomdev.dbo.[B&B Equipment & Supply Inc_$Purchase Header] ph ON pl.[Document No_] = ph.[No_]
			LEFT JOIN fs1.katomdev.dbo.[B&B Equipment & Supply Inc_$Sales Line] sl ON sl.[No_] = pl.[No_]
			left join Comment c on c.prodNum = pl.[No_] collate Latin1_General_CS_AS and c.documentNum = ph.[No_] collate Latin1_General_CS_AS and c.documentType = 'PO'
	WHERE pl.[Document Type] = 1
			AND ph.[Document Type] = 1
			AND pl.[Quantity] <> (pl.[Quantity Invoiced] + pl.[Qty_ to Invoice])
			AND DATEDIFF(DAY, ph.[Order Date], GETDATE()) > 3
	GROUP BY ph.[Order Date], pl.[Document No_], pl.[No_], pl.[Quantity],pl.[Qty_ to Invoice], pl.[Quantity Invoiced], 
			pl.[Expected Receipt Date], c.backorder, c.notes) AS openPO
	
	SELECT *, @recTT recTT FROM (
		SELECT ph.[Order Date] PODT, 
			DATEDIFF(DAY, ph.[Order Date], GETDATE()) numDays,
			pl.[Document No_] PONum, pl.[No_] prodNum, pl.[Quantity] qtyOrder, pl.[Qty_ to Invoice] qtyReceived, 
			pl.[Quantity Invoiced] qtyInvoiced, 
			CASE 
				WHEN DATEDIFF(DAY, pl.[Expected Receipt Date], ph.[Order Date]) = 0 THEN NULL
				ELSE pl.[Expected Receipt Date]
			END  ETA,
			COUNT(sl.[No_]) numOfOrder, ISNULL(SUM(sl.[Quantity]), 0) qtyCustomerOrder,	c.backorder, c.notes, 
			ROW_NUMBER() OVER (order by ph.[Order Date]) AS RowNum
		FROM  fs1.katomdev.dbo.[B&B Equipment & Supply Inc_$Purchase Line] pl
				LEFT JOIN fs1.katomdev.dbo.[B&B Equipment & Supply Inc_$Purchase Header] ph ON pl.[Document No_] = ph.[No_]
				LEFT JOIN fs1.katomdev.dbo.[B&B Equipment & Supply Inc_$Sales Line] sl ON sl.[No_] = pl.[No_]
				left join Comment c on c.prodNum = pl.[No_] collate Latin1_General_CS_AS and c.documentNum = ph.[No_] collate Latin1_General_CS_AS and c.documentType = 'PO'
		WHERE pl.[Document Type] = 1
				AND ph.[Document Type] = 1
				AND pl.[Quantity] <> (pl.[Quantity Invoiced] + pl.[Qty_ to Invoice])
				AND DATEDIFF(DAY, ph.[Order Date], GETDATE()) > 3
		GROUP BY ph.[Order Date], pl.[Document No_], pl.[No_], pl.[Quantity],pl.[Qty_ to Invoice], pl.[Quantity Invoiced], 
				pl.[Expected Receipt Date], c.backorder, c.notes) AS openPO
	WHERE RowNum BETWEEN @startRowIndex AND (@pageNum*@pageSize)
    ORDER BY 1 ASC
    **/

END
GO
/****** Object:  StoredProcedure [dbo].[openOrderRPT_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[openOrderRPT_SP]
	@pageNum INT, @pageSize INT, @filterBy VARCHAR(50), @toRemove VARCHAR(100), @orderType varchar(10)
AS
BEGIN
	DECLARE @startRowIndex INT, @recTT INT, @query VARCHAR(MAX), @queryToAdd VARCHAR(MAX)
	
	SELECT salesperson, COUNT(*) orderTT
	FROM openOrder
	GROUP BY salesperson
		
	IF @pageNum = 1
		SET @startRowIndex = @pageNum
	ELSE
		SET @startRowIndex = (@pageSize*(@pageNum-1)) + 1
	
	IF @filterBy = 'all'
	   BEGIN
		SET @queryToAdd = ''
		
		IF @toRemove = 'backorder'
		   BEGIN
			SELECT @recTT = COUNT(*) FROM openOrder WHERE (LOWER(orderStatus) <> 'backorder' OR CHARINDEX('b/o', LOWER(orderStatus)) > 0)			
			SET @queryToAdd = ' WHERE (LOWER(orderStatus) <> ''backorder'' OR CHARINDEX(''b/o'', LOWER(orderStatus)) > 0) '
		   END 		  
		   
		IF @toRemove = 'backorder, ccd'
		   BEGIN
			SELECT @recTT = COUNT(*) 
			FROM openOrder 
			WHERE (LOWER(orderStatus) <> 'backorder' OR CHARINDEX('b/o', LOWER(orderStatus)) > 0) 
					AND (paymentType = 'CC' AND CCAprObtained = 1)
			SET @queryToAdd = ' WHERE (LOWER(orderStatus) <> ''backorder'' OR CHARINDEX(''b/o'', LOWER(orderStatus)) > 0) 
									AND (paymentType = ''CC'' AND CCAprObtained = 1) '
		   END
		   
		IF @toRemove = 'ccd'
		   BEGIN
			SELECT @recTT = COUNT(*) FROM openOrder WHERE (paymentType = 'CC' AND CCAprObtained = 1) 
			SET @queryToAdd = ' WHERE (paymentType = ''CC'' AND CCAprObtained = 1) '
		   END
		   
		IF LEN(@toRemove) = 0
			SELECT @recTT = COUNT(*) FROM openOrder
			
		SET @query = 'SELECT *, ' + CAST(@recTT AS VARCHAR(10)) + ' recTT 
					  FROM (select o.*, ROW_NUMBER() OVER (order by ticketPrinted asc, salesTT desc) AS RowNum 
							from openOrder o' + @queryToAdd + ') as openOrder
					  WHERE RowNum BETWEEN ' + CAST(@startRowIndex AS VARCHAR(10)) + ' AND ' + CAST((@pageNum*@pageSize) AS VARCHAR(10))		
	   END 	
	ELSE
	   BEGIN
		SET @query = 'SELECT * FROM openOrder WHERE '
		SET @queryToAdd = 'Salesperson = ''' + @filterBy + ''' '
		
		IF @filterBy = 'shipDirect'
		   SET @queryToAdd = 'shipDirect = 1 '
		
		IF @filterBy = 'unprinted'
		   SET @queryToAdd = 'ticketPrinted = 0 '
		   		     
		IF @filterBy = 'ready2ship'
		   SET @queryToAdd = 'ReadyToShip = 1 '
		   
		IF @filterBy = 'intl'
		   SET @queryToAdd = 'orderStatus = ''International'' OR INTL = 1'
		   
		IF @filterBy = 'ccd'
		   SET @queryToAdd = '(paymentType = ''CC'' AND CCAprObtained = 0 AND CHARINDEX(''-'', orderNum) = 0) '
		   
		IF CHARINDEX('backorder', @toRemove) > 0
		   SET @queryToAdd = @queryToAdd + 'AND (LOWER(orderStatus) <> ''backorder'' OR CHARINDEX(''b/o'', LOWER(orderStatus)) > 0) '
		   
		IF CHARINDEX('ccd', @toRemove) > 0
		   SET @queryToAdd = @queryToAdd + 'AND (paymentType = ''CC'' AND CCAprObtained = 1) '
		   
		IF CHARINDEX('julianne', @toRemove) > 0
		   SET @queryToAdd = @queryToAdd + 'AND (paymentType = ''CC'' AND CCAprObtained = 1) ' +
					'AND orderStatus IN (''CANCEL B/O TOO LONG'', ''Cancelled'', ''IN PROGRESS'', ' +
					'''Items on Backorder'', ''Must Go Today'', ''Ready to Ship'', ''Ship Direct'', ' +
					'''Ship What We Have'', ''Waiting for Info.'', ''Waiting on Customer'', ' +
					'''Waiting on Freight'', ''Waiting on Taxes'')'
		   
		SET @query = @query + @queryToAdd
	   END 	
	   
	IF @orderType = 'dt'
		SET @query = @query + 'ORDER BY orderDT ASC'
	ELSE
		SET @query = @query + 'ORDER BY salesTT DESC'
				
	EXEC(@query)
END
GO
/****** Object:  StoredProcedure [dbo].[openOrderRpt]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[openOrderRpt]
AS
BEGIN
	--POPULATING OPEN PO DATA
	TRUNCATE TABLE openporpt

	INSERT INTO openporpt
	SELECT ph.[Order Date] PODT, 
		DATEDIFF(DAY, ph.[Order Date], GETDATE()) numDays,
		pl.[Document No_] PONum, pl.[No_] prodNum, ph.[Buy-from Vendor Name], 
		pl.[Quantity] qtyOrder, pl.[Qty_ to Invoice] qtyReceived, 
		pl.[Quantity Invoiced] qtyInvoiced, 
		CASE 
			WHEN DATEDIFF(DAY, pl.[Expected Receipt Date], ph.[Order Date]) = 0 THEN NULL
			ELSE pl.[Expected Receipt Date]
		END  ETA,
		COUNT(ISNULL(sl.[No_], 0)) numOfOrder, SUM(ISNULL(sl.[Quantity], 0)) qtyCustomerOrder
	FROM  fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Line] pl
			LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] ph ON pl.[Document No_] = ph.[No_]
			LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] sl ON sl.[No_] = pl.[No_]
	WHERE pl.[Document Type] = 1
			AND ph.[Document Type] = 1
			AND pl.[Quantity] <> (pl.[Quantity Invoiced] + pl.[Qty_ to Invoice])
			AND DATEDIFF(DAY, ph.[Order Date], GETDATE()) > 3
	GROUP BY ph.[Order Date], pl.[Document No_], ph.[Buy-from Vendor Name], pl.[No_], pl.[Quantity],pl.[Qty_ to Invoice], pl.[Quantity Invoiced], 
			pl.[Expected Receipt Date]
	order by  ph.[Buy-from Vendor Name], pl.[Document No_]
			
	DELETE FROM comment 
	WHERE documentNum NOT IN (SELECT [No_] COLLATE SQL_Latin1_General_CP1_CI_AS
								FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header])
			AND documentType = 'PO'
			
	--POPULATING OPEN ORDER DATA
	TRUNCATE TABLE openOrder
	
	INSERT INTO openOrder
	select  
		  CAST(h.[No_] AS NVARCHAR(255)) orderNum, 
		  CAST(h.[Bill-to Name] AS NVARCHAR(255)) [Name], 
		  CAST(h.[Bill-to Address] AS NVARCHAR(255)) [Address], 
		  CAST(h.[Bill-to City] AS NVARCHAR(255)) [City], 
		  h.[Order Date] orderDT, 
		  CAST(h.[Payment Terms Code] AS NVARCHAR(255)) PaymentType, 
		  h.[Due Date] dueDT, 
		  CAST(h.[Shipment Method Code] AS NVARCHAR(255)) [ShipmentType],  
		  CASE h.[Salesperson Code]
				WHEN 'CHRISTY' THEN CAST('LIBBY' AS NVARCHAR(255))
				ELSE CAST(h.[Salesperson Code] AS NVARCHAR(255))
		  END [Salesperson], 
		  CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)) salesTT,
		  COUNT(il.[No_]) NumItems,
		  CASE 
			WHEN h.[No_ Printed] = 0 THEN 0
			ELSE 1
		  END ticketPrinted,
		  [Order Status] orderStatus, [Credit Card Info Sent] CCSent, [Credit Approval Obtained] CCAprObtained,
		  LEFT([Ship-to Post Code], 5) zipCode,
		  CASE	
			WHEN LEFT([Ship-to Post Code], 5) IN (SELECT zipcode COLLATE SQL_Latin1_General_CP1_CI_AS FROM zipcodetable) THEN 0
			ELSE 1
		 END INTL,
		 CASE h.[Customer Source]
			WHEN 'G' THEN 'GSA'
			WHEN 'I' THEN 'Internet'
			WHEN 'E' THEN 'Ebay'
			WHEN 'S' THEN 'Oustide Sales'
			WHEN 'C' THEN 'Catalog'
			WHEN 'B' THEN 'Bid'
			WHEN 'U' THEN 'Uncategorized'
		END [CustomerSource], 0, 0
	from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
				LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il ON h.[No_]  = il.[Document No_]
	where --charindex('-', h.[No_]) = 0
			h.[Document Type] = 1
			AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
			AND LEN(il.[No_]) > 0
			/**
			AND (LEFT(il.[No_], 3) NOT IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)	
				OR il.[No_] IN (
						select [No_]
						from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
						where [Maximum Inventory] > 0
						))
			**/
			AND h.[Order Status] <> 'CANCEL'
	group by h.[No_], h.[Bill-to Name], h.[Bill-to Address], h.[Bill-to City], h.[Order Date], 
				 h.[Payment Terms Code], h.[Due Date], h.[Shipment Method Code],  h.[Salesperson Code],
				 h.[No_ Printed], [Order Status], [Credit Card Info Sent], [Credit Approval Obtained], [Ship-to Post Code], h.[Customer Source]
	order by salesTT desc, h.[Order Date] asc
	
	UPDATE openOrder 
	SET shipDirect = 1
	WHERE orderNum IN (SELECT DISTINCT ih.[No_]
						FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
							JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
								ON ih.[No_]  = il.[Document No_]
						WHERE LEN(ISNULL(ih.[Customer Source], '')) > 0
							AND ih.[Document Type] = 1
							AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
							AND LEN(il.[No_]) > 0
							AND ih.[Order Status] NOT IN ('Bring In Here')
							AND LEFT(il.[No_], 3) IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)
							AND il.[No_] NOT IN (
										select [No_]
										from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item]
										where [Maximum Inventory] > 0
										))
	UPDATE openOrder SET shipDirect = 0 WHERE (orderStatus = 'International' OR INTL = 1) AND shipDirect = 1
	
	--MARK AN ORDER AS READY2SHIP									
	DECLARE @orderNum varchar(20), @numItems smallint, @numitemsInstock smallint

	DECLARE catCursor CURSOR FOR 
	select orderNum, numitems 
	from openOrder
	where shipDirect = 0
		AND PaymentType = 'CC'
		AND ticketPrinted = 1
		AND CCAprObtained = 1
		
	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @orderNum, @numItems

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		TRUNCATE TABLE openOrderW1
		
		INSERT INTO openOrderW1
		SELECT l.[Document No_]
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] l LEFT JOIN products p on p.CODE = l.[No_] collate Latin1_General_CS_AS
		WHERE [No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
			AND LEN([No_]) > 0
			AND [Document No_] = @orderNum
		GROUP BY l.[Document No_], l.[No_], p.[thresholdMin], p.[qtyonhand]
		HAVING SUM(l.[Quantity]) <= qtyOnHand	
		
		IF EXISTS(SELECT * FROM openOrderW1)
		   BEGIN
			SELECT @numitemsInstock = COUNT(*) FROM openOrderW1
			TRUNCATE TABLE openOrderW1
			
			IF ISNULL(@numitemsInstock, 0) = @numItems
			   BEGIN
				UPDATE openOrder SET ReadyToShip = 1 WHERE orderNum = @orderNum
			   END
		   END
		   
		FETCH NEXT FROM catCursor INTO @orderNum, @numItems
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
END
GO
/****** Object:  StoredProcedure [dbo].[openOrder_Email]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[openOrder_Email]
AS
BEGIN
	DECLARE @OrderType VARCHAR(50), @todaySale MONEY, @todayOrder INT, @openSale MONEY, @openOrder INT, 
		@lastweekSale MONEY, @lastweekOrder INT, @6weekAvgSale MONEY, @6weeksAvgOrder INT,
		@WTDSale MONEY, @WTDOrder INT, @lastWTDSale MONEY, @lastWTDOrder INT,
		@MTDSale MONEY, @MTDOrder INT, @lastMTDSale MONEY, @lastMTDOrder INT,
		@YTDSale MONEY, @YTDOrder INT, @lastYTDSale MONEY, @lastYTDOrder INT,
		@todaySaleTT MONEY, @todayOrderTT INT, @openSaleTT MONEY, @openOrderTT INT, 
		@openSales_SD MONEY, @openOrders_SD INT,
		@lastweekSaleTT MONEY, @lastweekOrderTT INT, @6weekAvgSaleTT MONEY, @6weeksAvgOrderTT INT, 
		@WTDSaleTT MONEY, @WTDOrderTT INT, @lastWTDSaleTT MONEY, @lastWTDOrderTT INT, 
		@MTDSaleTT MONEY, @MTDOrderTT INT, @lastMTDSaleTT MONEY, @lastMTDOrderTT INT, 
		@YTDSaleTT MONEY, @YTDOrderTT INT, @lastYTDSaleTT MONEY, @lastYTDOrderTT INT,
		@today DATETIME, @yyyy SMALLINT, @dd TINYINT, @mm TINYINT,
		@dow VARCHAR(20), @wok TINYINT, @counter SMALLINT, @bgcolor VARCHAR(50)
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150)
					
	SET @todaySaleTT = 0
	SET @todayOrderTT = 0
	SET @openSaleTT = 0
	SET @openOrderTT = 0
	SET @lastweekSaleTT = 0
	SET @lastweekOrderTT = 0
	SET @6weekAvgSaleTT = 0
	SET @6weeksAvgOrderTT = 0
	SET @WTDSaleTT = 0
	SET @WTDOrderTT = 0
	SET @lastWTDSaleTT = 0
	SET @lastWTDOrderTT = 0
	SET @MTDSaleTT = 0
	SET @MTDOrderTT = 0
	SET @lastMTDSaleTT = 0
	SET @lastMTDOrderTT = 0
	SET @YTDSaleTT = 0
	SET @YTDOrderTT = 0
	SET @lastYTDSaleTT = 0
	SET @lastYTDOrderTT = 0
	SET @counter = 1
	SET @bgcolor = '#bed6e9'

	--INITIATING DATE
	SET @today = GETDATE()
	SET @yyyy = YEAR(@today)
	SET @mm = MONTH(@today)
	SET @dd = DAY(@today)
	SET @dow = DATENAME(WEEKDAY, @today)
	SET @wok = DATEPART(WEEK, @today)

	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>E-Mail</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>'

	--POPULATING SHIP DIRECT DATA	
	TRUNCATE TABLE dailyStat_shipdirect
	INSERT INTO dailyStat_shipdirect([date], orderNum, sales)
	select h.[Order Date], count(distinct h.[No_]), sum(distinct l.Amount)
	from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Line] l ON h.[No_] = l.[Document No_]
	where h.[Ship-to Name] <> 'WAREHOUSE FACILITY' and LEN(ISNULL(l.[No_], '')) > 0 
			and l.Amount > 0 and l.[No_] not in ('555', '540', '205')
			and DATEDIFF(day, h.[Order Date], getdate()) < 15
	group by h.[Order Date]
	order by h.[Order Date] desc

	INSERT INTO dailyStatWorktable(orderDT, orderTT, salesTT)
	select [Order Date], count(distinct h.[No_]), sum(l.Amount)
	from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] h
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Line] l ON h.[No_] = l.[Document No_]
	where h.[Ship-to Name] <> 'WAREHOUSE FACILITY' and LEN(ISNULL(l.[No_], '')) > 0 
			and l.Amount > 0 and l.[No_] not in ('555', '540', '205')
			and DATEDIFF(day, [Order Date], getdate()) < 15
	group by [Order Date]
	order by [Order Date] desc

	UPDATE s
	SET s.orderNum = ISNULL(s.orderNum, 0) + w.orderTT,
		s.sales = ISNULL(s.sales, 0) + w.salesTT
	FROM dailyStat_shipdirect s JOIN dailyStatWorktable w on s.[date] = w.orderDT

	TRUNCATE TABLE dailyStatWorktable
	
	INSERT INTO dailyStatWorktable(orderDT, salesTT, orderTT)
	SELECT	ih.[Order Date],
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(x.[No_], 0))		
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN (SELECT DISTINCT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]) as X 
			ON X.[No_] = ih.[No_]
	WHERE DATEDIFF(DAY, [Order Date], GETDATE()) < 20
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Document Type] = 1
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
		AND LEN(il.[No_]) > 0
		AND LEFT(il.[No_], 3) IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)
		AND il.[No_] NOT IN (
					select [No_]
					from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item]
					where [Maximum Inventory] > 0
					)
	GROUP BY ih.[Order Date]

	UPDATE s
	SET s.openOrders = w.orderTT,
		s.openSales = w.salesTT
	FROM dailyStat_shipdirect s JOIN dailyStatWorktable w on s.[date] = w.orderDT

	TRUNCATE TABLE dailyStatWorktable

	SET @counter = 1
	SET @body1 = @body1 + '<br />
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	<tr>
	<td>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
	<td colspan="6" style="font-size:12px;">Order Status In The Last 10 Business Days</td>
  </tr>  
  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
    <td style="text-align:center; width: 75px;">&nbsp;</td>
    <td style="text-align:center; width: 100px;">Ship Direct</td>
    <td style="text-align:center; width: 100px;">Invoiced</td>
    <td style="text-align:center; width: 100px;">Open</td>
    <td style="text-align:center; width: 100px;">Open Internet</td>
    <td style="text-align:center; width: 100px;">Open Ship Direct</td>
  </tr>'
	
	DECLARE @orderDT varchar(20), @SalesShipDirect money, @orderShipDirect int, 
			@salesTT varchar(20), @orderTT varchar(10), @openSalesTT varchar(20), @openOrderTT2 varchar(10),
			@internetSalesTT varchar(20), @internetOrderTT varchar(10)
			
	DECLARE sCursor CURSOR FOR 
	SELECT CONVERT(VARCHAR(10), d.[date], 101),  d.orderNum, d.Sales, 
		'$' + CONVERT(varchar(50), CAST(LEFT(s.TotalInvoiced, CHARINDEX('(', s.totalinvoiced)-2) AS MONEY), 1) salesTT, 
		right(s.totalinvoiced, LEN(s.totalinvoiced)-CHARINDEX('(', s.totalinvoiced)+1) orderTT, 
		'$' + CONVERT(varchar(50), CAST(LEFT(s.totalSales, CHARINDEX('(', s.totalSales)-2) AS MONEY), 1) openSalesTT, 
		right(s.totalSales, LEN(s.totalSales)-CHARINDEX('(', s.totalSales)+1) openOrdersTT, 
		'$' + CONVERT(varchar(50), CAST(LEFT(s.InternetSales, CHARINDEX('(', s.InternetSales)-2) AS MONEY), 1) InternetSalesTT, 
		right(s.InternetSales, LEN(s.InternetSales)-CHARINDEX('(', s.InternetSales)+1) InternetOrdersTT,
		d.openSales, d.openOrders
	FROM dailyStat_shipdirect d JOIN salesStat30Days s on DATEDIFF(DAY, d.[date], s.[Date]) = 0
	ORDER BY d.[date] desc

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @orderDT, @orderShipDirect, @SalesShipDirect, @salesTT, @orderTT, 
								 @openSalesTT, @openOrderTT2, @internetSalesTT, @internetOrderTT,
								 @openSales_SD, @openOrders_SD

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td align="center" >' + @orderDT + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@SalesShipDirect, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@orderShipDirect, 0), 1) + ')</td>
		<td align="center" >' + @salesTT + ' ' + @orderTT + '</td>
		<td align="center" >' + @openSalesTT + ' ' + @openOrderTT2 + '</td>
		<td align="center" >' + @internetSalesTT + ' ' + @internetOrderTT + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@openSales_SD, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@openOrders_SD, 0), 1) + ')</td>
	  </tr>'
	  	
		FETCH NEXT FROM sCursor INTO @orderDT, @orderShipDirect, @SalesShipDirect, @salesTT, @orderTT, 
								 @openSalesTT, @openOrderTT2, @internetSalesTT, @internetOrderTT,
								 @openSales_SD, @openOrders_SD
	   END
	CLOSE sCursor
	DEALLOCATE sCursor
	
	SET @body1 = @body1 + '</TABLE></td><td>
			<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
		  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
			<td colspan="6" style="font-size:12px;">Open Order Status In The Last 10 Business Days</td>
		  </tr>  
		  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
			<td style="text-align:center; width: 75px;">&nbsp;</td>
			<td style="text-align:center; width: 100px;">UNPRINTED ORDERS</td>
			<td style="text-align:center; width: 100px;">PRINTED ORDERS</td>
			<td style="text-align:center; width: 100px;">TOTAL ORDERS</td>
		  </tr>'
	
	DECLARE @unprintC INT, @unprintS DECIMAL(10, 2), @printC INT, @printS DECIMAL(10, 2)
	
	DECLARE sCursor CURSOR FOR 
	SELECT * FROM dailyStat_openOrder

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @orderDT, @unprintC, @unprintS, @printC, @printS, @orderTT, @salesTT
	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
			
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td align="center" >' + REPLACE(@orderDT, ' 12:00AM', '') + '</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@unprintS, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@unprintC, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@printS, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@printC, 0), 1) + ')</td>
		<td align="center" >' + '$' + CONVERT(varchar(50), ISNULL(@salesTT, 0), 1) + ' (' + CONVERT(varchar(50), ISNULL(@orderTT, 0), 1) + ')</td>
	  </tr>'
	
		FETCH NEXT FROM sCursor INTO @orderDT, @unprintC, @unprintS, @printC, @printS, @orderTT, @salesTT
	   END
	CLOSE sCursor
	DEALLOCATE sCursor
		
	SET @body1 = @body1 + '</TABLE></td></tr></table>'
		
	SET @body1 = @body1 + '	</body>
	</html>'
	
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'alice@katom.com; betty@katom.com; charley@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Open Orders and Ship Direct Stat For '  + CAST(@mm AS VARCHAR(2)) + '/' + CAST(@dd AS VARCHAR(2)) + '/' + CAST(@yyyy AS VARCHAR(4))

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[negativeInventory_Email]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[negativeInventory_Email]
AS
BEGIN
	DECLARE @CODE VARCHAR(50), @INVENTORYCOUNT FLOAT, @counter SMALLINT, @bgcolor VARCHAR(50)
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150)
	
	IF EXISTS(SELECT [CODE], qtyonhand FROM products
				WHERE active = 1 
					AND isnull(qtyonhand, 10) < 0
					AND thresholdMin > 0  )
	   BEGIN			
		--INITIATE TABLE
		SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		<html xmlns="http://www.w3.org/1999/xhtml">
		<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>E-Mail</title>

		<style type="text/css">
		body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
		</style>

		</head>
		<body>
		<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
		  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
			<td width="100">Product Code</td>
			<td style="text-align:center; width: 100px;">Inventory Count</td>
		  </tr>'
		  
		DECLARE sCursor CURSOR FOR 
		SELECT [CODE], qtyonhand 
		FROM products
		WHERE active = 1 
			AND isnull(qtyonhand, 10) < 0
			AND thresholdMin > 0
		ORDER BY 2 ASC, 1 ASC

		OPEN sCursor
		FETCH NEXT FROM sCursor INTO @CODE, @INVENTORYCOUNT

		WHILE @@FETCH_STATUS = 0
		   BEGIN
			
			IF @counter = 1
			   BEGIN
				SET @counter = 2
				SET @bgcolor = '#FFFFFF'
			   END
			ELSE
			   BEGIN
				SET @counter = 1
				SET @bgcolor = '#bed6e9'
			   END
			
			SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
			<td>' + @code + '</td>
			<td align="center" >' + CAST(@INVENTORYCOUNT AS VARCHAR(10)) + '</td>
		  </tr>'
					
			FETCH NEXT FROM sCursor INTO @CODE, @INVENTORYCOUNT
		   END


		CLOSE sCursor
		DEALLOCATE sCursor

		SET @body1 = @body1 + '</table>'
		
		SET @body1 = @body1 + '	</body>
		</html>'
		
		-- PREPPING THE EMAIL TO SEND
		SET @email1 = 'mmeade@katom.com; pbible@katom.com'
	--	SET @email1 = 'david@katom.com'
		SET @subject1 = 'Products with NEGATIVE inventory'

		EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	
	   END
END
GO
/****** Object:  StoredProcedure [dbo].[PilotInvoicing_SP_OldNav]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PilotInvoicing_SP_OldNav]
AS
BEGIN
	/*Upload header information for associated invoices*/
	INSERT OPENQUERY(MYSQL,
	'select invoicenum, selltoname, selltoaddress, selltocity, selltostate, selltozipcode,  shiptocontact, shiptoaddress, shiptocity, shiptostate, shiptozipcode, shipdate, duedate, trackingcode, shippingagent, orderid, email, weborderid, orderamount, trackingnum from katom_mm5.cXMLinvoiceheader')
	--selltocountry,

	SELECT --convert(varchar(20),shipmentdt,100)
	top 100
	No_ as InvoiceNo,
	[Sell-to Customer Name] as selltoname, [Sell-to Address] as selltoaddress, [Sell-to City] as selltocity, [Sell-to State] as selltostate, [Sell-to ZIP Code] as selltozipcode,
	[Ship-to Contact] as shiptocontact, [Ship-to Address] as shiptoaddress, [Ship-to City] as shiptocity, [Ship-to State] as shiptostate, [Ship-to ZIP Code] as shiptozipcode, [Shipment Date], [Due Date], [Package Tracking No_] as trackingcode, [Shipping Agent Code] as shippingagentcode, [Your Reference] as orderid,
	[E-mail] as email, CASE WHEN (CharINDEX('/', [Your Reference])-2) > 0 THEN left([your reference],CharINDEX('/', [your reference])-2) ELSE [your reference] END as weborderid, [Amount Authorized] as orderamount, [Package Tracking No_] as trackingnum
	FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] a
	where [sell-to customer no_] = '270665'
	and no_ COLLATE Latin1_General_CI_AS  not in (select id from pilotxref)
	order by a.[Shipment Date] desc

	/*Upload items for associated invoices*/
	INSERT OPENQUERY(MYSQL, 
	'select invoicenum, linenum, code, description, uom, quantity, unitprice, subtotal
	from katom_mm5.cXMLinvoiceline')

	SELECT [Document No_], [Line No_], No_ , Description, [Unit of Measure], cast(Quantity as float) as qty, cast([Unit Price] as float) as unitprice, cast(Amount as float) as amount
	  FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
	  where [Document No_] in(
	 
	SELECT No_
	FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] a
	where [sell-to customer no_] = '270665'
	and no_ COLLATE Latin1_General_CI_AS  not in (select id from pilotxref)
	 )

	/*Update cross reference table so that these are not uploaded again*/
	insert into pilotxref
	select no_, [your reference]
	from fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] a
	where [sell-to customer no_] = '270665' and
		no_ COLLATE Latin1_General_CI_AS  not in (select id from pilotxref)


END
GO
/****** Object:  StoredProcedure [dbo].[PilotInvoicing_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PilotInvoicing_SP]
AS
BEGIN
	/*Upload header information for associated invoices*/
	INSERT OPENQUERY(KRACK,
	'select invoicenum, selltoname, selltoaddress, selltocity, selltostate, selltozipcode,  shiptocontact, shiptoaddress, shiptocity, shiptostate, shiptozipcode, shipdate, duedate, trackingcode, shippingagent, orderid, email, weborderid, orderamount, trackingnum from cXMLinvoiceheader')
	--selltocountry,

	SELECT --convert(varchar(20),shipmentdt,100)
	top 100
	No_ as InvoiceNo,
	[Sell-to Customer Name] as selltoname, [Sell-to Address] as selltoaddress, [Sell-to City] as selltocity, [Sell-to County] as selltostate, [Sell-to Post Code] as selltozipcode,
	[Ship-to Contact] as shiptocontact, [Ship-to Address] as shiptoaddress, [Ship-to City] as shiptocity, [Ship-to County] as shiptostate, [Ship-to Post Code] as shiptozipcode, [Shipment Date], [Due Date], [Package Tracking No_] as trackingcode, [Shipping Agent Code] as shippingagentcode, [Your Reference] as orderid,
	[E-mail] as email, CASE WHEN (CharINDEX('/', [Your Reference])-2) > 0 THEN left([your reference],CharINDEX('/', [your reference])-2) ELSE [your reference] END as weborderid, [Amount Authorized] as orderamount, [Package Tracking No_] as trackingnum
	FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] a
	where [sell-to customer no_] = '270665'
	and no_ COLLATE Latin1_General_CI_AS  not in (select * from openquery(KRACK, 'select invoicenum from cXMLinvoiceheader'))
	and ([Package Tracking No_] <> ''
	or datediff(d, [Shipment Date], getdate()) > 4)
	
	order by a.[Shipment Date] desc

	/*Upload items for associated invoices*/
	INSERT OPENQUERY(KRACK, 
	'select invoicenum, linenum, code, description, uom, quantity, unitprice, subtotal
	from cXMLinvoiceline')

	SELECT [Document No_], [Line No_], No_ , Description, [Unit of Measure], cast(Quantity as float) as qty, cast([Unit Price] as float) as unitprice, cast(Amount as float) as amount
	  FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line]
	  where [Document No_] in(
	 
	SELECT No_
	FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] a
	where [sell-to customer no_] = '270665'
	and no_ COLLATE Latin1_General_CI_AS  not in (select * from openquery(KRACK, 'select invoicenum from cXMLinvoiceline'))
	and ([Package Tracking No_] <> ''
	or datediff(d, [Shipment Date], getdate()) > 4)
	 )

	/*Update cross reference table so that these are not uploaded again*/
	insert into pilotxref
	select no_, [your reference]
	from fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] a
	where [sell-to customer no_] = '270665' and	no_ COLLATE Latin1_General_CI_AS  not in (select id from pilotxref)
	and ([Package Tracking No_] <> ''
	or datediff(d, [Shipment Date], getdate()) > 4)
		
		---This section inserts orders into the table on KRACK to be processed by the cronjob
		BEGIN

		DECLARE @pilotOrder varchar(30)
		DECLARE @pilotOrders varchar(MAX)


		DECLARE pilotCursor CURSOR FOR 

				SELECT No_ FROM fs1.[KaTom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header]
				where [Bill-to Name] = 'PILOT'
				and datediff(d, getdate(), [Posting Date]) > -14
				and No_ collate SQL_Latin1_General_CP1_CI_AS not in (
				select * from openquery(KRACK, 'select invoicenum from cXMLinvoicetest'))
				and ([Package Tracking No_] <> ''
				or datediff(d, [Shipment Date], getdate()) > 4)

		OPEN pilotCursor

		FETCH NEXT FROM pilotCursor INTO @pilotOrder
			

			WHILE @@FETCH_STATUS = 0

			BEGIN
			
			IF @pilotOrders <> '' 
				BEGIN 
					SET @pilotOrders = @pilotOrders+','+@pilotOrder 
				END
			ELSE 
				BEGIN
					SET @pilotOrders = @pilotOrder
				END
				
			FETCH NEXT FROM pilotCursor INTO @pilotOrder
			
			END

			CLOSE pilotCursor

			DEALLOCATE pilotCursor
			
			print @pilotOrders


		insert into openquery(KRACK, 'select invoicenum from cXMLinvoicetest')
		SELECT No_ FROM fs1.[KaTom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header]
		where [Bill-to Name] = 'PILOT'
		and datediff(d, getdate(), [Shipment Date]) > -14
		and No_ collate SQL_Latin1_General_CP1_CI_AS not in (
		select * from openquery(KRACK, 'select invoicenum from cXMLinvoicetest'))
		and ([Package Tracking No_] <> '' or datediff(d, [Shipment Date], getdate()) > 4)


		EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients='mike@katom.com', @subject='Pilot Invoices Inserted', @body=@pilotOrders, @body_format ='HTML'

		END

		---

END
GO
/****** Object:  StoredProcedure [dbo].[PaymentParseTest]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

      You can use the information below to quickly parse out a delimited string through T-SQL into a temp table.

      This informaton was modeled after a solution you will find if you follow the link in the

      External Links section of this article.

*/
CREATE procedure [dbo].[PaymentParseTest]
	@Order varchar(10)
AS
 

DECLARE @Delimiter Char(1)

DECLARE @Delimiter2 Char(1)

DECLARE @StringToParse VarChar(MAX) 

DECLARE @ParseName VarChar(MAX) 

DECLARE @CharactersLeftToParse INT

DECLARE @LoopCounter INT

DECLARE @ParsedString VarChar(100)

DECLARE @ParsedIndex INT

--DECLARE @Order INT

--DECLARE @sql_str nvarchar (4000)
 

SET @Delimiter = '='

SET @Delimiter2 = ','

--SET @Order = '528090'

---------------------------------


CREATE TABLE #TEMPORD 
(
	value1 VARCHAR(132)
)

DECLARE @sql_str nvarchar (4000)

--SET @Order = '528308'

SET @sql_str = 'select pay_secdat from katom_mm5.s01_Orders where id = ''' + @Order + ''''

SET @sql_str = N'insert into #TEMPORD select pay_secdat from OPENQUERY(MYSQL, ''' + REPLACE(@sql_str, '''', '''''') + ''')'

PRINT @sql_str

EXEC (@sql_str)


---------------------------------

SET @StringToParse = (SELECT * FROM #TEMPORD)

SET @CharactersLeftToParse =Len(@StringToParse) 

SET @ParsedIndex = 0

SET @LoopCounter = 1


CREATE TABLE #ParsedValuesTable

(
      ParsedValue VarChar(50),
      ParsedIndex VarChar(50)
)
/*Handler for any fields without delimiter*/
IF (CHARINDEX(@Delimiter, @StringToParse,1) = 0)

      PRINT @StringToParse

/*Detects presence of delimiters*/
WHILE (CHARINDEX(@Delimiter, @StringToParse,1) <> 0)  

      BEGIN 

            IF @LoopCounter = 1 

			/*SET @ParsedString = SUBSTRING(@StringToParse, @LoopCounter, CHARINDEX(@Delimiter,@StringToParse,1) - 1)*/
                IF (CHARINDEX(@Delimiter2, @StringToParse,1) <> 0)
                
                SET @ParsedString = SUBSTRING(@StringToParse, CHARINDEX(@Delimiter,@StringToParse,1)+1, (CHARINDEX(@Delimiter2,@StringToParse,1)- 1)-(CHARINDEX(@Delimiter,@StringToParse,1)))
                
                ELSE 
                
                SET @ParsedString = SUBSTRING(@StringToParse, CHARINDEX(@Delimiter,@StringToParse,1)+1, Len(@StringToParse)-CHARINDEX(@Delimiter,@StringToParse,1))

			SET @ParsedIndex = @ParsedIndex+1
			
			IF @ParsedIndex = 1 
				SET @ParseName = 'EXPMO'
			ELSE IF @ParsedIndex = 2
				SET @ParseName = 'EXPYR'
			ELSE IF @ParsedIndex = 3
				SET @ParseName = 'NAME'
			ELSE IF @ParsedIndex = 4
				SET @ParseName = 'CCNUM'
			
			
			
            INSERT INTO #ParsedValuesTable (ParsedValue, ParsedIndex) VALUES (@ParsedString, @ParseName)

			IF (CHARINDEX(@Delimiter2, @StringToParse,1) <> 0)
            SET @StringToParse = SUBSTRING(@StringToParse, CHARINDEX(@Delimiter2,@StringToParse,1)+1, Len(@StringToParse))
			ELSE
			SET @StringToParse = ''
			--print @stringtoparse

            SET @CharactersLeftToParse = @CharactersLeftToParse - 1
            --print @CharactersLeftToParse

	
      END

update order_hdrtest
set 
ccnum = (select parsedvalue from #ParsedValuesTable where ParsedIndex = 'CCNUM'),
ccname = (select replace(parsedvalue, '+', ' ') from #ParsedValuesTable where ParsedIndex = 'NAME'),
ccexpmo = (select parsedvalue from #ParsedValuesTable where ParsedIndex = 'EXPMO'),
ccexpyr = (select parsedvalue from #ParsedValuesTable where ParsedIndex = 'EXPYR')
where customerpo = @Order


select * from #ParsedValuesTable

DROP TABLE #ParsedValuesTable

DROP TABLE #TEMPORD




/*

DECLARE @Delimiter Char(1)

DECLARE @Delimiter2 Char(1)

DECLARE @StringToParse VarChar(MAX) 

 

SET @Delimiter = '='

SET @Delimiter2 = ','

SET @StringToParse = (select pay_secdat from openquery (MYSQL, 'select pay_secdat from katom_mm5.s01_Orders where id = 525524'))

PRINT SUBSTRING(@StringToParse, CHARINDEX(@Delimiter,@StringToParse,1)+1, (CHARINDEX(@Delimiter2,@StringToParse,1)- 1)-(CHARINDEX(@Delimiter,@StringToParse,1)))
 */
GO
/****** Object:  StoredProcedure [dbo].[PaymentParse]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*

      You can use the information below to quickly parse out a delimited string through T-SQL into a temp table.

      This informaton was modeled after a solution you will find if you follow the link in the

      External Links section of this article.

*/
CREATE procedure [dbo].[PaymentParse]
	@Order varchar(10)
AS
 

DECLARE @Delimiter Char(1)

DECLARE @Delimiter2 Char(1)

DECLARE @StringToParse VarChar(MAX) 

DECLARE @ParseName VarChar(MAX) 

DECLARE @CharactersLeftToParse INT

DECLARE @LoopCounter INT

DECLARE @ParsedString VarChar(100)

DECLARE @ParsedIndex INT

--DECLARE @Order INT

--DECLARE @sql_str nvarchar (4000)
 

SET @Delimiter = '='

SET @Delimiter2 = ','

--SET @Order = '528090'

---------------------------------


CREATE TABLE #TEMPORD 
(
	value1 VARCHAR(200)
)

DECLARE @sql_str nvarchar (4000)

--SET @Order = '528308'

SET @sql_str = 'select pay_secdat from katom_mm5.s01_Orders where id = ''' + @Order + ''''

SET @sql_str = N'insert into #TEMPORD select pay_secdat from OPENQUERY(MYSQL, ''' + REPLACE(@sql_str, '''', '''''') + ''')'

PRINT @sql_str

EXEC (@sql_str)


---------------------------------

SET @StringToParse = (SELECT * FROM #TEMPORD)

SET @CharactersLeftToParse =Len(@StringToParse) 

SET @ParsedIndex = 0

SET @LoopCounter = 1


CREATE TABLE #ParsedValuesTable

(
      ParsedValue VarChar(100),
      ParsedIndex VarChar(100)
)
/*Handler for any fields without delimiter*/
IF (CHARINDEX(@Delimiter, @StringToParse,1) = 0)

      PRINT @StringToParse

/*Detects presence of delimiters*/
WHILE (CHARINDEX(@Delimiter, @StringToParse,1) <> 0)  

      BEGIN 

            IF @LoopCounter = 1 

			/*SET @ParsedString = SUBSTRING(@StringToParse, @LoopCounter, CHARINDEX(@Delimiter,@StringToParse,1) - 1)*/
                IF (CHARINDEX(@Delimiter2, @StringToParse,1) <> 0)
                
                SET @ParsedString = SUBSTRING(@StringToParse, CHARINDEX(@Delimiter,@StringToParse,1)+1, (CHARINDEX(@Delimiter2,@StringToParse,1)- 1)-(CHARINDEX(@Delimiter,@StringToParse,1)))
                
                ELSE 
                
                SET @ParsedString = SUBSTRING(@StringToParse, CHARINDEX(@Delimiter,@StringToParse,1)+1, Len(@StringToParse)-CHARINDEX(@Delimiter,@StringToParse,1))

			SET @ParsedIndex = @ParsedIndex+1
			
			IF @ParsedIndex = 1 
				SET @ParseName = 'EXPMO'
			ELSE IF @ParsedIndex = 2
				SET @ParseName = 'EXPYR'
			ELSE IF @ParsedIndex = 3
				SET @ParseName = 'NAME'
			ELSE IF @ParsedIndex = 4
				SET @ParseName = 'CCNUM'
			
			
			
            INSERT INTO #ParsedValuesTable (ParsedValue, ParsedIndex) VALUES (@ParsedString, @ParseName)

			IF (CHARINDEX(@Delimiter2, @StringToParse,1) <> 0)
            SET @StringToParse = SUBSTRING(@StringToParse, CHARINDEX(@Delimiter2,@StringToParse,1)+1, Len(@StringToParse))
			ELSE
			SET @StringToParse = ''
			--print @stringtoparse

            SET @CharactersLeftToParse = @CharactersLeftToParse - 1
            --print @CharactersLeftToParse

	
      END

update order_hdr 
set 
ccnum = (select parsedvalue from #ParsedValuesTable where ParsedIndex = 'CCNUM'),
ccname = (select replace(parsedvalue, '+', ' ') from #ParsedValuesTable where ParsedIndex = 'NAME'),
ccexpmo = (select parsedvalue from #ParsedValuesTable where ParsedIndex = 'EXPMO'),
ccexpyr = (select parsedvalue from #ParsedValuesTable where ParsedIndex = 'EXPYR')
where customerpo = @Order


DROP TABLE #ParsedValuesTable

DROP TABLE #TEMPORD




/*

DECLARE @Delimiter Char(1)

DECLARE @Delimiter2 Char(1)

DECLARE @StringToParse VarChar(MAX) 

 

SET @Delimiter = '='

SET @Delimiter2 = ','

SET @StringToParse = (select pay_secdat from openquery (MYSQL, 'select pay_secdat from katom_mm5.s01_Orders where id = 525524'))

PRINT SUBSTRING(@StringToParse, CHARINDEX(@Delimiter,@StringToParse,1)+1, (CHARINDEX(@Delimiter2,@StringToParse,1)- 1)-(CHARINDEX(@Delimiter,@StringToParse,1)))
 */
GO
/****** Object:  StoredProcedure [dbo].[OrderTotalUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[OrderTotalUpdate]

AS

BEGIN

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('MIVA_TBL', GETDATE())
SET @jobID = @@identity

DECLARE @day INT

SET @day = -1

/* Update SQL Table based on Miva Sales Information */
insert into order_totalarchive
select
order_id, total, orderdate
from
 openquery(MYSQL, '
		SELECT order_id, sum(price*quantity) as total, from_unixtime(orderdate) as orderdate
		FROM katom_mm5.s01_Orders o
		join katom_mm5.s01_OrderItems i
		on o.id = i.order_id
		group by order_id	
		')
where order_id not in (select order_id from order_totalarchive)

/* Update Miva Totals */
INSERT OPENQUERY(MYSQL, 'select orderdate, range1, range2, range3, range4, range5, range6, range7, range8, range9  from katom_mm5.ordertotalarchive')
SELECT distinct(CONVERT(VARCHAR(10), orderdate, 110)), 
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total < 250) as range1,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total < 501 and total > 250) as range2,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total < 1001 and total > 500) as range3,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total < 2001 and total > 1000) as range4,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, -@day, GETDATE()), 110)
and total < 3001 and total > 2000) as range5,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total < 5001 and total > 3000) as range6,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total > 5000) as range7,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total < 10000 and total > 7000) as range8,
(select COUNT(*)
from order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)
and total >= 10000) as range9
FROM order_totalarchive
where CONVERT(VARCHAR(10), orderdate, 110) = CONVERT(VARCHAR(10), dateadd(dd, @day, GETDATE()), 110)

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

END
GO
/****** Object:  StoredProcedure [dbo].[OrderStatusUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[OrderStatusUpdate]
	-- Add the parameters for the stored procedure here
AS
BEGIN
	
	delete from order_status

	insert into order_status ([Web Order No_], status)
	select
	[Web Order No_],
	CASE
	WHEN [Source Code] = 'DELETE' THEN 'X'
	WHEN [Delivered] = 'True' THEN 'D'
	WHEN [Delivered] = 'False' THEN 'S'
	WHEN [Tracking Number] IS NULL THEN 'W'
	WHEN [Delivered] IS NULL THEN 'S'
	END as status
	from invoice_backup
	left outer join trackingInfo
	on [Order No_] COLLATE Latin1_General_CS_AS = KatomOrderID
	where [Web Order No_] like 'KT%'
	
	insert into order_status ([Web Order No_], status)
	select [Web Order No_], 'P' from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header]
	where [Web Order No_] like 'KT%'
	and [Web Order No_] not in (select [Web Order No_] from invoice_backup)


END
GO
/****** Object:  StoredProcedure [dbo].[PowerReviewsFollowup_SP_OldNav]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PowerReviewsFollowup_SP_OldNav] 

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

DELETE FROM powerreviewsfollowup

INSERT INTO powerreviewsfollowup
SELECT [Document No_], i.[No_], replace(h.name, ',', ''), replace(h.name, ',', ''), h.[e-mail]
FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line] i
JOIN fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Customer] h
ON h.[No_] = i.[Sell-to Customer No_]
WHERE i.No_ NOT LIKE '100%' AND i.No_ NOT LIKE '420' and i.No_ like '%-%'
AND CONVERT(nvarchar(50), i.[shipment date],3) = CONVERT(nvarchar(50), dateadd(week, -3, getdate()), 3)
AND [e-mail] LIKE '%@%'
AND [e-mail] <> 'CHARLES.GRIFFIN@PILOTTRAVELCENTERS.COM'
AND i.[Project Code] = 'KATOM'
ORDER BY i.No_

Select * FROM powerreviewsfollowup

END
GO
/****** Object:  StoredProcedure [dbo].[PowerReviewsFollowup_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PowerReviewsFollowup_SP] 

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

DELETE FROM powerreviewsfollowup

INSERT INTO powerreviewsfollowup
SELECT [Document No_], i.[No_], replace(h.[Ship-to Name], ',', ''), replace(h.[Ship-to Name], ',', ''), h.[e-mail]
FROM fs1.[Katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Line] i
JOIN fs1.[Katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header] h
ON h.[No_] = i.[Document No_]
join trackingInfo
on h.[Package Tracking No_] collate Latin1_General_CS_AS = [Tracking Number] 
WHERE i.No_ NOT LIKE '100%' AND i.No_ NOT LIKE '420' and i.No_ like '%-%'
AND h.[e-mail] LIKE '%@%'
AND h.[e-mail] <> 'CHARLES.GRIFFIN@PILOTTRAVELCENTERS.COM'
AND i.[Shortcut Dimension 2 Code] = 'KATOM'
AND (CONVERT(nvarchar(50), i.[Posting Date],101) = CONVERT(nvarchar(50), dateadd(week, -3, getdate()), 101)
)
and h.[Web Order No_] like 'KT%'
--and Delivered = 'True'
ORDER BY i.No_

END
GO
/****** Object:  StoredProcedure [dbo].[feedHistory_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[feedHistory_SP]
 @cse VARCHAR(100) -- MIN  VALUE WE WANT TO INCLUDE IN THE FEED
AS
BEGIN
	DECLARE @prodCount INT, @price MONEY
	
	IF @cse = 'Amazon'
	   BEGIN
	    SET @price = 49.99
	    
		SELECT @prodCount = COUNT(CODE)
		FROM products p LEFT JOIN cseCatMapping c ON p.primaryCatCode = c.catCode
		WHERE p.active = 1 AND p.isWeb = 1 AND p.price > @price AND p.image NOT LIKE '%logo'
			AND p.CODE NOT IN (select [No_] COLLATE Latin1_General_CS_AS from backOrder_item where DATEDIFF(day, [OldestOrderdt], getdate()) > 15 and price < 250)   
	   END
	   
	INSERT INTO feedHistory(cseName, numProd, feedDT)  VALUES(@cse, @prodCount, GETDATE())
END
GO
/****** Object:  StoredProcedure [dbo].[prodCatAssignment]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[prodCatAssignment]
AS
BEGIN
	update products 
	set categories = NULL, catCode = NULL

	UPDATE p
	SET p.categories = c.CATNAME,
		p.catCode = c.CODE
	from MIVACatXProd cx join categories c on cx.cat_id = c.ID
						 join products p on p.mivaProdID = cx.product_id	
	where product_id in 
		   (select product_id	
			from MIVACatXProd			 
			group by product_id
			having COUNT(*) = 1)

	DECLARE @prodCode VARCHAR(255), @catCode VARCHAR(255), @catName VARCHAR(255)

	DECLARE catCursor CURSOR FOR 
	select p.code, c.CODE, c.CATNAME
	from MIVACatXProd cx join categories c on cx.cat_id = c.ID
						 join products p on p.mivaProdID = cx.product_id	
	where product_id in 
		   (select product_id	
			from MIVACatXProd			 
			group by product_id
			having COUNT(*) > 1)
	order by p.CODE, c.id

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @prodCode, @catCode, @catName

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		UPDATE products
		SET categories = 
			CASE 
				WHEN categories IS NULL THEN @catName
				ELSE categories + '|' + @catName
			END ,
			catCode = 
			CASE 
				WHEN catCode IS NULL THEN @catCode
				ELSE catCode + ', ' + @catCode
			END
		WHERE CODE = @prodCode
	   
		FETCH NEXT FROM catCursor INTO @prodCode, @catCode, @catName
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
END
GO
/****** Object:  StoredProcedure [dbo].[productActiveStat]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[productActiveStat]
AS
BEGIN
	TRUNCATE TABLE productStat
	TRUNCATE TABLE productStat_worktable

	-- TOTAL PRODUCTS
	INSERT INTO productStat(mfgid, mfgName, numProdInNAV)
	SELECT LEFT(i.[No_], 3), v.[Name], COUNT(*)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v ON LEFT(i.[No_], 3) = v.[No_]
	WHERE [Vendor Posting Group] IN ('AP-DIST', 'AP-MAN')
	GROUP BY LEFT(i.[No_], 3), v.[Name]

	--TOTAL DISCONTINUED PRODUCTS
	INSERT INTO productStat_worktable
	SELECT v.[No_], COUNT(*)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v ON LEFT(i.[No_], 3) = v.[No_]
	WHERE [Status] = 2
		AND [Vendor Posting Group] IN ('AP-DIST', 'AP-MAN')
	GROUP BY v.[No_]

	UPDATE t
	SET t.discontinuedNAV = ISNULL(t2.total, 2)
	FROM productStat t JOIN productStat_worktable t2 ON t.mfgid = t2.mfgid

	TRUNCATE TABLE productStat_worktable

	--TOTAL DISCONTINUED PRODUCTS
	INSERT INTO productStat_worktable
	SELECT mfgid, COUNT(*)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
		JOIN products p ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
	WHERE [Status] = 2
		AND qtyOnHand > 0
	GROUP BY mfgid

	UPDATE t
	SET t.discontinuedButActive = ISNULL(t2.total, 2)
	FROM productStat t JOIN productStat_worktable t2 ON t.mfgid = t2.mfgid

	TRUNCATE TABLE productStat_worktable

	--TOTAL [WEB ITEM] = 1 PRODUCTS
	INSERT INTO productStat_worktable
	SELECT v.[No_], COUNT(*)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Vendor] v ON LEFT(i.[No_], 3) = v.[No_]
	WHERE [Status] <> 2 AND [Web Item] = 1
		AND [Vendor Posting Group] IN ('AP-DIST', 'AP-MAN')
	GROUP BY v.[No_]

	UPDATE t
	SET t.webItemNAV = ISNULL(t2.total, 2)
	FROM productStat t JOIN productStat_worktable t2 ON t.mfgid = t2.mfgid

	TRUNCATE TABLE productStat_worktable

	--TOTAL liveOnWeb PRODUCTS
	INSERT INTO productStat_worktable
	SELECT mfgid, COUNT(*)
	FROM products
	WHERE ACTIVE = 1 AND isWeb = 1
	GROUP BY mfgid

	UPDATE t
	SET t.liveOnWeb = ISNULL(t2.total, 2)
	FROM productStat t JOIN productStat_worktable t2 ON t.mfgid = t2.mfgid

	TRUNCATE TABLE productStat_worktable

	--TOTAL notCatNAV PRODUCTS
	INSERT INTO productStat_worktable
	SELECT LEFT([No_], 3), COUNT(*)
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item]
	WHERE [No_] IN (SELECT [Item No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes])
	GROUP BY LEFT([No_], 3)

	UPDATE t
	SET t.notCatNAV = numProdInNAV - ISNULL(t2.total, 2)
	FROM productStat t JOIN productStat_worktable t2 ON t.mfgid = t2.mfgid

	TRUNCATE TABLE productStat_worktable

	--TOTAL NOT CATEGORIZED
	INSERT INTO productStat_worktable
	SELECT mfgid, COUNT(*)
	FROM products
	WHERE ACTIVE = 1 
		and [isWeb] = 1
		and primaryCatCode is null
	GROUP BY mfgid, mfgname
	ORDER BY mfgid

	UPDATE t
	SET t.notCatOnWEB = ISNULL(t2.total, 2)
	FROM productStat t JOIN productStat_worktable t2 ON t.mfgid = t2.mfgid

	TRUNCATE TABLE productStat_worktable
END
GO
/****** Object:  StoredProcedure [dbo].[product_relatedItems_Cleanup_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_relatedItems_Cleanup_SP]
	@type VARCHAR(20)
AS
BEGIN
	DECLARE @code VARCHAR(255), @r VARCHAR(1000), @code2 VARCHAR(255), @r2 VARCHAR(1000), 
			@sSQL VARCHAR(MAX), @sSQL2 VARCHAR(MAX)

	SET @sSQL = ''
	SET @sSQL2 = ''
	
	IF @type = 'FULL'
	   BEGIN		
		DECLARE catCursor CURSOR FOR 
		SELECT code, REPLACE(relateditems, ', ', ''', ''')
		FROM products 
		WHERE ACTIVE = 1 AND LEN(ISNULL(relateditems, '')) > 0
		order by code
	   END
	ELSE
	   BEGIN
		DECLARE catCursor CURSOR FOR 
		SELECT code, REPLACE(relateditems, ', ', ''', ''')
		FROM products 
		WHERE ACTIVE = 1 AND LEN(ISNULL(relateditems, '')) > 0
			AND DATEDIFF(DAY, updatedt, GETDATE()) BETWEEN 0 AND 1
		order by code
	   END

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @code, @r

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @r2 = ''
		SET @sSQL = 'DECLARE pCursor CURSOR FOR
					 SELECT code FROM products WHERE ACTIVE = 1 AND isWeb = 1 AND CODE IN (''' + @r + ''')'
		EXEC(@sSQL)
		   
		OPEN pCursor
		FETCH NEXT FROM pCursor INTO @code2

		WHILE @@FETCH_STATUS = 0
		   BEGIN
			SET @r2 = @r2 + CASE WHEN LEN(@r2) > 0 THEN ', ' ELSE '' END + @code2
			FETCH NEXT FROM pCursor INTO  @code2
		   END
		
		CLOSE pCursor
		DEALLOCATE pCursor	

		UPDATE products
		SET relatedItems = @r2
		WHERE CODE = @code
		
		FETCH NEXT FROM catCursor INTO @code, @r
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
END
GO
/****** Object:  StoredProcedure [dbo].[product_Pricing_Update_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_Pricing_Update_SP]
AS
BEGIN
DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_PRICING', GETDATE())
SET @jobID = @@identity

INSERT INTO products_Price_Worktable(code, uom, updatedt)
SELECT [No_], [Base Unit Of Measure], GETDATE()
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item]
WHERE [No_] NOT IN (SELECT code COLLATE SQL_Latin1_General_CP1_CI_AS FROM products_Price_Worktable)

--UPDATE DISCOUNT GROUP
UPDATE pt
SET pt.discountGroup = i.[Item Disc_ Group]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
		ON pt.code = i.[No_] COLLATE Latin1_General_CS_AS
WHERE ISNULL(pt.discountGroup, '') <> i.[Item Disc_ Group] COLLATE Latin1_General_CS_AS

--UPDATE UOM
UPDATE pt
SET pt.UOM = i.[Base Unit Of Measure]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i
		ON pt.code = i.[No_] COLLATE Latin1_General_CS_AS
WHERE ISNULL(pt.UOM, '') <> i.[Base Unit Of Measure] COLLATE Latin1_General_CS_AS

--UPDATING MANUAL PRICING FLAG
UPDATE pt
SET pt.manualPricingBB = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'BB'
	AND pt.manualPricingBB <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  

UPDATE pt
SET pt.manualPricingRealCost = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE pt.manualPricingRealCost <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 

UPDATE pt
SET pt.manualPricingCost = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'STD_COST'
	AND pt.manualPricingCost <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 

UPDATE pt
SET pt.manualPricingKAT = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'KATOM'
	AND pt.manualPricingKAT <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 

UPDATE pt
SET pt.manualPricingMAP = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'MAP'
	AND pt.manualPricingMAP <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 

UPDATE pt
SET pt.manualPricingGSA = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'GSA'
	AND pt.manualPricingGSA <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 

UPDATE pt
SET pt.manualPricingFA = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'FROSTY'
	AND pt.manualPricingFA <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 			
					
UPDATE pt
SET pt.manualPricingLP = p.[Manual Pricing]
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 2
	AND pt.manualPricingLP <> p.[Manual Pricing]
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 

--UPDATING COST
UPDATE pt
SET pt.cost = CAST(p.[Unit Price] AS DECIMAL(10, 4))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'STD_COST'
	AND CAST(p.[Unit Price] AS DECIMAL(10, 4)) <> CAST(ISNULL(pt.cost, 0) AS DECIMAL(10, 4))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  
			
UPDATE pt
SET pt.realCost = CAST(p.[Direct Unit Cost] AS DECIMAL(10, 4))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE CAST(p.[Direct Unit Cost] AS DECIMAL(10, 4)) <> CAST(ISNULL(pt.realCost, -1) AS DECIMAL(10, 4))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE())) 
					
			
--UPDATING BB SELLING PRICE			
UPDATE pt
SET pt.bbprice = CAST(p.[Unit Price] AS DECIMAL(10, 2))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'BB'
	AND CAST(p.[Unit Price] AS DECIMAL(10, 2)) <> CAST(ISNULL(pt.bbprice, 0) AS DECIMAL(10, 2))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))

--UPDATING KATOM PRICE
UPDATE pt
SET pt.price = CAST(p.[Unit Price] AS DECIMAL(10, 2))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'KATOM'
	AND CAST(p.[Unit Price] AS DECIMAL(10, 2)) <> CAST(ISNULL(pt.price, 0) AS DECIMAL(10, 2))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  

--UPDATING LIST PRICE			
UPDATE pt
SET pt.listprice = CAST(p.[Unit Price] AS DECIMAL(10, 2))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 2
	AND LEN([Sales Code]) = 0
	AND CAST(p.[Unit Price] AS DECIMAL(10, 2)) <> CAST(ISNULL(pt.listprice, 0) AS DECIMAL(10, 2))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  
			
--UPDATING MAP PRICE	
UPDATE pt
SET pt.mapPrice = CAST(p.[Unit Price] AS DECIMAL(10, 2))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'MAP'
	AND CAST(p.[Unit Price] AS DECIMAL(10, 2)) <> CAST(ISNULL(pt.mapPrice, 0) AS DECIMAL(10, 2))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  
			
--UPDATING GSA PRICE	
UPDATE pt
SET pt.gsaPrice = CAST(p.[Unit Price] AS DECIMAL(10, 2))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'GSA'
	AND CAST(p.[Unit Price] AS DECIMAL(10, 2)) <> CAST(ISNULL(pt.mapPrice, 0) AS DECIMAL(10, 2))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  

	
--UPDATING FROSTY ACRES PRICE	
UPDATE pt
SET pt.faPrice = CAST(p.[Unit Price] AS DECIMAL(10, 2))
FROM products_Price_Worktable pt JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		ON pt.code = p.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	   AND pt.uom = p.[Unit of Measure Code] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Sales Code] = 'FROSTY'
	AND CAST(p.[Unit Price] AS DECIMAL(10, 2)) <> CAST(ISNULL(pt.mapPrice, 0) AS DECIMAL(10, 2))
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  



--UPDATE PRICING ON THE PRODUCTS TABLE
UPDATE p
SET p.cost = pw.cost,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.cost, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.cost, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.price = pw.price,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.price, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.price, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.BBPrice = pw.bbprice,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.BBPrice, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.bbprice, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.gsaPrice = pw.gsaPrice,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.gsaPrice, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.gsaPrice, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.fa_Price= pw.faPrice,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.fa_Price, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.faPrice, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.MAP_Price = pw.mapPrice,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.MAP_Price, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.mapPrice, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.listPrice = pw.listprice,
	p.updateDT = GETDATE()	
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.listPrice, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.listPrice, 0) AS DECIMAL(10, 2))

UPDATE p
SET p.true_Cost = CAST(pw.realCost AS DECIMAL(10, 2)),
	p.updateDT = GETDATE()
FROM products_Price_Worktable pw JOIN products p on p.CODE = pw.code
WHERE CAST(ISNULL(p.true_Cost, 0) AS DECIMAL(10, 2)) <> CAST(ISNULL(pw.realCost, 0) AS DECIMAL(10, 2))

--UPDATING DISCOUNT GROUP
UPDATE p
SET p.icdiscountGrp = pp.discountGroup
FROM products p join  products_Price_Worktable pp on p.CODE = pp.code
WHERE ISNULL(icdiscountGrp, '') <> discountGroup

--SET ALL SALES PRODUCTS
UPDATE p
SET p.clearance = 1
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] sp 
	LEFT JOIN products p on sp.[Item No_] = p.CODE COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE [Sales Type] = 1
	AND [Manual Price Reason Code] = 'SALE_KATOM' 
	AND [Sales Code] = 'KATOM'
	AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
			REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			
UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[product_categorization_holiday_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_categorization_holiday_SP]
AS
BEGIN
	DECLARE @pCode VARCHAR(1000), @cName VARCHAR(1000), @cCode VARCHAR(1000)

	UPDATE p
	SET p.catCode = NULL, p.categories = NULL
	FROM products p
	WHERE CODE in (select prodcode from catxProd where catID in (10754, 10755, 10756))
		
	DECLARE cCursor CURSOR FOR 
	SELECT prodCode, catCode
	FROM catxProd 
	WHERE prodcode in (select code from products where active = 1 and catcode is null)
	GROUP BY prodCode, catCode
	ORDER BY prodCode

	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @pCode, @cCode

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SELECT @cName = CATNAME FROM categories WHERE code = @cCode
		
		UPDATE products
		SET catCode = 
				CASE	
					WHEN catCode IS NULL THEN @cCode
					ELSE catCode + ', ' + @cCode
				END,
			categories = 
				CASE	
					WHEN categories IS NULL THEN @cName
					ELSE categories + '|' + @cName
				END
		WHERE CODE = @pCode	
	   
		FETCH NEXT FROM cCursor INTO @pCode, @cCode
	   END
	   
	CLOSE cCursor
	DEALLOCATE cCursor
END
GO
/****** Object:  StoredProcedure [dbo].[product_categorization_FULL_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_categorization_FULL_SP]
AS
BEGIN
	DECLARE @pCode VARCHAR(1000), @cName VARCHAR(1000), @cCode VARCHAR(1000)

	UPDATE p
	SET p.catCode = NULL, p.categories = NULL
	FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS

	DECLARE cCursor CURSOR FOR 
	SELECT prodCode, catCode
	FROM catxProd cx JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON cx.prodCode = i.[No_] COLLATE Latin1_General_CS_AS
	GROUP BY prodCode, catCode
	ORDER BY prodCode

	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @pCode, @cCode

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SELECT @cName = CATNAME FROM categories WHERE code = @cCode
		
		UPDATE products
		SET catCode = 
				CASE	
					WHEN catCode IS NULL THEN @cCode
					ELSE catCode + ', ' + @cCode
				END,
			categories = 
				CASE	
					WHEN categories IS NULL THEN @cName
					ELSE categories + '|' + @cName
				END
		WHERE CODE = @pCode	
	   
		FETCH NEXT FROM cCursor INTO @pCode, @cCode
	   END
	   
	CLOSE cCursor
	DEALLOCATE cCursor
END
GO
/****** Object:  StoredProcedure [dbo].[product_categorization_clearance_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_categorization_clearance_SP]
AS
BEGIN
	DECLARE @pCode VARCHAR(1000), @cName VARCHAR(1000), @cCode VARCHAR(1000)

	UPDATE p
	SET p.catCode = NULL, p.categories = NULL
	FROM products p
	WHERE catCode LIKE '%clearance%'
		
	DECLARE cCursor CURSOR FOR 
	SELECT prodCode, catCode
	FROM catxProd 
	WHERE prodcode in (select code from products where active = 1 and catcode is null)
	GROUP BY prodCode, catCode
	ORDER BY prodCode

	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @pCode, @cCode

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SELECT @cName = CATNAME FROM categories WHERE code = @cCode
		
		UPDATE products
		SET catCode = 
				CASE	
					WHEN catCode IS NULL THEN @cCode
					ELSE catCode + ', ' + @cCode
				END,
			categories = 
				CASE	
					WHEN categories IS NULL THEN @cName
					ELSE categories + '|' + @cName
				END
		WHERE CODE = @pCode	
	   
		FETCH NEXT FROM cCursor INTO @pCode, @cCode
	   END
	   
	CLOSE cCursor
	DEALLOCATE cCursor
END
GO
/****** Object:  StoredProcedure [dbo].[processOpenOrder]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[processOpenOrder]
	@action tinyint
AS
BEGIN

IF @action = 1 
   BEGIN
	/**
	delete from openSalesWorktable
	where cast(isnull(navOrderID, '') as varchar(50)) not in (select [No_] from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header])
	**/
	
	DELETE FROM openOrderWorktable WHERE [shipDate] is null and Notes is null and processor is null
	
	update os
	set os.shipDT = ow.[shipDate],
		  os.notes = ow.Notes,
		  os.processor = ow.processor,
		  os.lastupdateDT = GETDATE()
	from openSalesWorktable os join openOrderWorktable ow on os.navOrderID = ow.[Nav Order ID]

	insert into openSalesWorktable
	select [Nav Order ID], shipDaTe, Notes, processor, GETDATE()
	from openOrderWorktable
	where isnull([Nav Order ID], 0) not in (select isnull(navOrderID, '') from openSalesWorktable)
		and [Nav Order ID] is not null
	
	DELETE FROM [openSalesWorktable] WHERE shipDT is null and Notes is null
   END
ELSE IF @action = 2 -- ALL OPEN SALES ORDERS THAT IS NOT INTL, FAILED CC OR SHIP DIRECT
   BEGIN
	select  
		  CAST(h.[No_] AS NVARCHAR(255)) [No_], 
		  CAST(h.[Bill-to Name] AS NVARCHAR(255)) [Name], 
		  CAST(h.[Bill-to Address] AS NVARCHAR(255)) [Address], 
		  CAST(h.[Bill-to City] AS NVARCHAR(255)) [City], 
		  h.[Order Date], 
		  CAST(h.[Payment Terms Code] AS NVARCHAR(255)) [Payment Terms Code], 
		  h.[Due Date], 
		  CAST(h.[Shipment Method Code] AS NVARCHAR(255)) [Shipment Method Code],  
		  CASE h.[Salesperson Code]
				WHEN 'CHRISTY' THEN CAST('LIBBY' AS NVARCHAR(255))
				ELSE CAST(h.[Salesperson Code] AS NVARCHAR(255))
		  END [Salesperson Code], 
		  CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)) salesTT,
		  w.shipDT, CAST(ISNULL(w.notes, '') AS NVARCHAR(255)) [notes],
		  CASE h.[No_ Printed]
				WHEN 0 THEN 'NO'
				ELSE 'YES'
		  END ticketPrinted,
		  w.processor
	from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
				LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
					  ON h.[No_]  = il.[Document No_]
				LEFT JOIN openSalesWorktable w ON CAST(w.navOrderID AS NVARCHAR(25)) = h.[No_] COLLATE Latin1_General_CS_AS
	where charindex('-', h.[No_]) = 0
	 --     and datediff(day, h.[Order Date], getdate()) =0
			and DATEDIFF(DAY, GETDATE(), ISNULL(w.shipDT, GETDATE())) < 1
			and h.[Document Type] = 1
			AND LEFT([Bill-to Post Code], 5) IN (SELECT zipcode COLLATE SQL_Latin1_General_CP1_CI_AS FROM zipcodetable)
			AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
			AND LEN(il.[No_]) > 0
			AND (LEFT(il.[No_], 3) NOT IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)	
				OR il.[No_] IN (
						select [No_]
						from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
						where [Maximum Inventory] > 0
						))
	group by h.[No_], h.[Bill-to Name], h.[Bill-to Address], h.[Bill-to City], h.[Order Date], 
				 h.[Payment Terms Code], h.[Due Date], h.[Shipment Method Code],  h.[Salesperson Code],
				 w.shipDT, w.notes, h.[No_ Printed], w.processor      
	order by w.shipDT desc, salesTT desc, h.[Order Date] asc
   END
ELSE IF @action = 3 --SHIP DIRECT ORDERS
   BEGIN
	select  
		  CAST(h.[No_] AS NVARCHAR(255)) [No_], 
		  CAST(h.[Bill-to Name] AS NVARCHAR(255)) [Name], 
		  CAST(h.[Bill-to Address] AS NVARCHAR(255)) [Address], 
		  CAST(h.[Bill-to City] AS NVARCHAR(255)) [City], 
		  h.[Order Date], 
		  CAST(h.[Payment Terms Code] AS NVARCHAR(255)) [Payment Terms Code], 
		  h.[Due Date], 
		  CAST(h.[Shipment Method Code] AS NVARCHAR(255)) [Shipment Method Code],  
		  CASE h.[Salesperson Code]
				WHEN 'CHRISTY' THEN CAST('LIBBY' AS NVARCHAR(255))
				ELSE CAST(h.[Salesperson Code] AS NVARCHAR(255))
		  END [Salesperson Code], 
		  CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)) salesTT,
		  w.shipDT, CAST(ISNULL(w.notes, '') AS NVARCHAR(255)) [notes],
		  CASE h.[No_ Printed]
				WHEN 0 THEN 'NO'
				ELSE 'YES'
		  END ticketPrinted,
		  w.processor
	from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
				LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
					  ON h.[No_]  = il.[Document No_]
				LEFT JOIN openSalesWorktable w ON CAST(w.navOrderID AS NVARCHAR(25)) = h.[No_] COLLATE Latin1_General_CS_AS
	where datediff(day, h.[Order Date], getdate()) > 0
			AND DATEDIFF(DAY, GETDATE(), ISNULL(w.shipDT, GETDATE())) < 1
			AND h.[Document Type] = 1
			AND LEFT([Bill-to Post Code], 5) IN (SELECT zipcode COLLATE SQL_Latin1_General_CP1_CI_AS FROM zipcodetable)
			AND LEFT(il.[No_], 3) IN (select mfgid collate SQL_Latin1_General_CP1_CI_AS from mfg where Active = 1 and shipDirect = 1)
			AND il.[No_] NOT IN (
						select [No_]
						from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Item]
						where [Maximum Inventory] > 0
						)
	group by h.[No_], h.[Bill-to Name], h.[Bill-to Address], h.[Bill-to City], h.[Order Date], 
				 h.[Payment Terms Code], h.[Due Date], h.[Shipment Method Code],  h.[Salesperson Code],
				 w.shipDT, w.notes, h.[No_ Printed], w.processor      
	UNION
	select  
		  CAST(h.[No_] AS NVARCHAR(255)) [No_], 
		  CAST(h.[Bill-to Name] AS NVARCHAR(255)) [Name], 
		  CAST(h.[Bill-to Address] AS NVARCHAR(255)) [Address], 
		  CAST(h.[Bill-to City] AS NVARCHAR(255)) [City], 
		  h.[Order Date], 
		  CAST(h.[Payment Terms Code] AS NVARCHAR(255)) [Payment Terms Code], 
		  h.[Due Date], 
		  CAST(h.[Shipment Method Code] AS NVARCHAR(255)) [Shipment Method Code],  
		  CASE h.[Salesperson Code]
				WHEN 'CHRISTY' THEN CAST('LIBBY' AS NVARCHAR(255))
				ELSE CAST(h.[Salesperson Code] AS NVARCHAR(255))
		  END [Salesperson Code], 
		  CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)) salesTT,
		  w.shipDT, CAST(ISNULL(w.notes, '') AS NVARCHAR(255)) [notes],
		  CASE h.[No_ Printed]
				WHEN 0 THEN 'NO'
				ELSE 'YES'
		  END ticketPrinted,
		  w.processor
	from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
				LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
					  ON h.[No_]  = il.[Document No_]
				LEFT JOIN openSalesWorktable w ON CAST(w.navOrderID AS NVARCHAR(25)) = h.[No_] COLLATE Latin1_General_CS_AS
	where datediff(day, h.[Order Date], getdate()) > 0
		  AND DATEDIFF(DAY, GETDATE(), ISNULL(w.shipDT, GETDATE())) < 1
		  AND h.[Document Type] = 1
		  AND (il.[Description] like '%ship%' and il.[Description] like '%direct%')
		  AND LEFT([Bill-to Post Code], 5) IN (SELECT zipcode COLLATE SQL_Latin1_General_CP1_CI_AS FROM zipcodetable)
	group by h.[No_], h.[Bill-to Name], h.[Bill-to Address], h.[Bill-to City], h.[Order Date], 
				 h.[Payment Terms Code], h.[Due Date], h.[Shipment Method Code],  h.[Salesperson Code],
				 w.shipDT, w.notes, h.[No_ Printed], w.processor  	
	order by w.shipDT desc, salesTT desc, h.[Order Date] asc	
   END
ELSE IF @action = 4 --OPEN POs
   BEGIN
	SELECT ph.[Order Date] PODT, 
		pl.[Document No_] PONum, pl.[No_] prodNum, pl.[Quantity] qtyOrder, pl.[Qty_ to Invoice] qtyReceived, 
		pl.[Quantity Invoiced] qtyInvoiced, 
		CASE 
			WHEN DATEDIFF(DAY, pl.[Expected Receipt Date], ph.[Order Date]) = 0 THEN NULL
			ELSE pl.[Expected Receipt Date]
		END  ETA,
		COUNT(sl.[No_]) numOfOrder, ISNULL(SUM(sl.[Quantity]), 0) qtyCustomerOrder,	c.backorder, c.notes
	FROM  fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Line] pl
			LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] ph ON pl.[Document No_] = ph.[No_]
			LEFT JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] sl ON sl.[No_] = pl.[No_]
			left join Comment c on c.prodNum = pl.[No_] collate Latin1_General_CS_AS and c.documentNum = ph.[No_] collate Latin1_General_CS_AS and c.documentType = 'PO'
	WHERE pl.[Document Type] = 1
			AND ph.[Document Type] = 1
			AND pl.[Quantity] <> (pl.[Quantity Invoiced] + pl.[Qty_ to Invoice])
			AND DATEDIFF(DAY, ph.[Order Date], GETDATE()) > 3
	GROUP BY ph.[Order Date], pl.[Document No_], pl.[No_], pl.[Quantity],pl.[Qty_ to Invoice], pl.[Quantity Invoiced], 
			pl.[Expected Receipt Date], c.backorder, c.notes
	order by 1 asc
   END
ELSE IF @action = 5 --PROCESS OPEN PO SS
   BEGIN
	UPDATE c
	SET c.backOrder = cw.backOrder,
		c.notes = cw.notes,
		c.updateDT = GETDATE(),
		c.userID = cw.userID 
	FROM commentWorktable cw JOIN comment c on cw.prodNum = c.prodNum and cw.documentNum = c.documentNum
	WHERE c.documentType = 'PO' 
	
	DELETE FROM commentWorktable
	WHERE id IN (SELECT c.id 
				 FROM commentWorktable cw JOIN comment c on cw.prodNum = c.prodNum and cw.documentNum = c.documentNum
				 WHERE c.documentType = 'PO')
				 
	INSERT INTO comment
	SELECT prodNum, documentNum, backorder, notes, 'PO', GETDATE(), userID
	FROM commentWorktable
	WHERE LEN(ISNULL(backorder, '')) > 0 OR LEN(ISNULL(notes, '')) > 0
	
	DELETE FROM comment WHERE backorder is null and notes is null
	
	TRUNCATE TABLE commentWorktable
	
   END
END
GO
/****** Object:  StoredProcedure [dbo].[cat_and_mfg_weekly_stat]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[cat_and_mfg_weekly_stat]
AS
BEGIN
	--UPDATE THIS WEEK MFG PERFORMANCE	
	UPDATE mfg SET week2 = NULL
	UPDATE mfg SET week2 = week1
	UPDATE mfg SET week1 = NULL
		
	TRUNCATE TABLE mfgWorktable
	INSERT INTO mfgWorktable(mfgid, salesTT)
	SELECT CAST(LEFT(il.[No_], 3) AS VARCHAR(3)), SUM(il.[Amount])
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		LEFT JOIN mfg m ON m.mfgID = LEFT(il.[No_], 3) COLLATE Latin1_General_CS_AS
	WHERE datepart(week, getdate()) = datepart(week, i.[Order Date])
		AND YEAR(i.[Order Date]) = YEAR(getdate())	
		AND il.[No_] in (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
	GROUP BY LEFT(il.[No_], 3)

	UPDATE m
	SET m.week1 = w.salesTT
	FROM mfg m JOIN mfgworktable w on m.mfgid = w.mfgid

	--CALCULATING THIS WEEK CAT STAT 
	UPDATE categories SET week2 = NULL
	UPDATE categories SET week2 = week1
	UPDATE categories SET week1 = NULL
	
	Declare @total money
			
	TRUNCATE TABLE mfgworktable 
	INSERT INTO mfgworktable(mfgid, salesTT)
	SELECT CASE 
				WHEN p.primaryCatcode IS NULL THEN 'uncat'
				ELSE p.primaryCatcode
			END catCode, 
			SUM(il.[Amount])
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		LEFT JOIN products p ON p.code = il.[No_] COLLATE Latin1_General_CS_AS
	WHERE datepart(week, i.[Order Date]) = datepart(week, getdate())
		AND year(i.[Order Date]) = YEAR(getdate())	
		AND il.[No_] in (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
	GROUP BY p.primaryCatcode
	ORDER BY 1
	
	SELECT @total = SUM(il.[Amount])
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
				ON i.[No_]  = il.[Document No_]
		WHERE datepart(week, i.[Order Date]) = datepart(week, getdate())
			AND year(i.[Order Date]) = YEAR(getdate())	
			AND il.[No_] IN (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
			AND il.[No_] NOT IN (SELECT code COLLATE SQL_Latin1_General_CP1_CI_AS FROM products)	

	UPDATE mfgworktable
	SET salesTT = ISNULL(salesTT, 0) + @total	
	WHERE mfgid = 'uncat'

	UPDATE c
	SET c.week1 = m.salesTT
	FROM categories c JOIN mfgworktable m ON c.CODE = m.mfgid

	SET @total = 0
	TRUNCATE TABLE mfgworktable 
	INSERT INTO mfgworktable(mfgid, salesTT)
	SELECT CASE 
				WHEN p.primaryCatcode IS NULL THEN 'uncat'
				ELSE p.primaryCatcode
			END catCode, 
			SUM(il.[Amount])
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		LEFT JOIN products p ON p.code = il.[No_] COLLATE Latin1_General_CS_AS
	WHERE DATEDIFF(DAY, i.[Order Date], GETDATE()) <31
		AND il.[No_] in (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
	GROUP BY p.primaryCatcode
	ORDER BY 1

	SELECT @total = SUM(il.[Amount])
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
				ON i.[No_]  = il.[Document No_]
		WHERE DATEDIFF(DAY, i.[Order Date], GETDATE()) <31
			AND il.[No_] IN (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
			AND il.[No_] NOT IN (SELECT code COLLATE SQL_Latin1_General_CP1_CI_AS FROM products)	

	UPDATE mfgworktable
	SET salesTT = ISNULL(salesTT, 0) + @total	
	WHERE mfgid = 'uncat'

	UPDATE c
	SET c.sales30 = m.salesTT
	FROM categories c JOIN mfgworktable m ON c.CODE = m.mfgid
	
	SET @total = 0
	TRUNCATE TABLE mfgworktable 
	INSERT INTO mfgworktable(mfgid, salesTT)
	SELECT CASE 
				WHEN p.primaryCatcode IS NULL THEN 'uncat'
				ELSE p.primaryCatcode
			END catCode, 
			SUM(il.[Amount])
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
			ON i.[No_]  = il.[Document No_]
		LEFT JOIN products p ON p.code = il.[No_] COLLATE Latin1_General_CS_AS
	WHERE DATEDIFF(DAY, i.[Order Date], GETDATE()) BETWEEN 31 AND 60
		AND il.[No_] in (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
	GROUP BY p.primaryCatcode
	ORDER BY 1

	SELECT @total = SUM(il.[Amount])
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il 
				ON i.[No_]  = il.[Document No_]
		WHERE DATEDIFF(DAY, i.[Order Date], GETDATE()) BETWEEN 31 AND 60
			AND il.[No_] IN (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE LEN(ISNULL([No_], '')) > 3)
		AND il.[No_] NOT LIKE '100-%'
			AND il.[No_] NOT IN (SELECT code COLLATE SQL_Latin1_General_CP1_CI_AS FROM products)	

	UPDATE mfgworktable
	SET salesTT = ISNULL(salesTT, 0) + @total	
	WHERE mfgid = 'uncat'

	UPDATE c
	SET c.sales3060 = m.salesTT
	FROM categories c JOIN mfgworktable m ON c.CODE = m.mfgid

END
GO
/****** Object:  StoredProcedure [dbo].[addNewCategory]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[addNewCategory]
AS
BEGIN	
	DECLARE @ID INT, @code varchar(500), @parentCode varchar(500), @catName varchar(500), @parent_id INT, @isPrimary INT, @parentID INT

	SELECT @ID = MAX(id) FROM categories 

	DELETE FROM catTemp WHERE catCode IS NULL
	
	--REMOVE NEW SUBMITTED CAT THAT ALREADY EXIST
	DELETE ct 
	FROM catTemp ct join categories c on ct.catCode = c.CODE
	WHERE c.ACTIVE = 1
	
	UPDATE ct
	SET ct.parent_id = c.id 
	FROM catTemp ct JOIN categories c ON ct.[parentCode] = code AND ACTIVE = 1
	
	DECLARE catCursor CURSOR FOR 
	SELECT ltrim(rtrim(catCode)), ltrim(rtrim(parentCode)), ltrim(rtrim(catName)), primaryCat, parent_ID 
	FROM catTemp ORDER BY parentCode

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @code, @parentCode, @catName, @isPrimary, @parentID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF NOT EXISTS(SELECT * FROM categories WHERE CODE = @code AND primaryCat = @isPrimary and PARENT_ID = @parentID)
		   BEGIN   
			SET @ID = @ID + 1
			IF @parentCode = NULL 
			   BEGIN 
				  SET @parent_id = 0
			   END
			ELSE
			   BEGIN 
				IF @parentID = NULL
				   BEGIN
					SELECT @parentID = id FROM categories WHERE CODE = @parentCode
				   END
			   END
			
			INSERT INTO categories(ID, PARENT_ID, CODE, CATNAME, endleaf, primaryCat, ACTIVE)
			VALUES(@ID, @parentID, @code, @catName, 0, @isPrimary, 1)				   
		   END
		   
		FETCH NEXT FROM catCursor INTO @code, @parentCode, @catName, @isPrimary, @parentID
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	--FORCE AN ACTIVE CATEGORY TO WORK IF IT IS ASSIGNED TO THE SPECIAL CAT
	UPDATE c
	SET c.PARENT_ID = 10751 
	FROM catTemp ct JOIN categories c ON ct.[catCode] = c.CODE AND ct.parentCode = 'special'
	WHERE c.PARENT_ID IS NULL

	-- ASSIGN PARENT_ID IN CASE IT WAS NOT ASSIGNED THROUGH THE FIRST PASS
	DELETE FROM catTemp WHERE ISNUMERIC(parent_id) = 1
	
	UPDATE ct
	SET ct.parent_id = c.id 
	FROM catTemp ct JOIN categories c ON ct.[parentCode] = c.CODE AND ACTIVE = 1
	
	UPDATE c
	SET c.parent_id = ct.parent_id 
	FROM categories c JOIN catTemp ct on c.CODE = ct.catCode
	WHERE c.PARENT_ID IS NULL AND c.ACTIVE = 1 AND ct.parent_id IS NOT NULL
	
	TRUNCATE TABLE catTemp
	
	UPDATE categories SET ACTIVE = 0 WHERE ACTIVE = 1 AND parent_id IS NULL
	
	
	--REMOVE DUP CATEGORIES
	DECLARE catCursor CURSOR FOR 
	SELECT CODE
	FROM categories 
	GROUP BY CODE
	HAVING COUNT(*) > 1

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @code

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SELECT @id = ID FROM categories WHERE CODE = @code AND primaryCat = 1
		
		UPDATE categories 
		SET ID = @id 
		WHERE CODE = @code AND primaryCat = 0
		
		FETCH NEXT FROM catCursor INTO @code
	   END

	CLOSE catCursor
	DEALLOCATE catCursor	
	
	--ASSIGNING MFGID FOR ALL CAT WHERE PARENT_ID = 5844 (SHOP BY VENDOR)
	UPDATE c
	SET c.mfgid = m.mfgid
	FROM categories c JOIN mfg m ON c.CATNAME = m.mfgName
	WHERE c.mfgID IS NULL
END
GO
/****** Object:  StoredProcedure [dbo].[addComment]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[addComment]
	@code varchar(100),
	@poNum varchar(100),
	@notes varchar(max),
	@docType varchar(100)
AS
BEGIN	
	DECLARE @currentNotes varchar(max), @id int	

    IF EXISTS(SELECT * FROM comment WHERE prodNum=@code AND documentNum = @poNum AND documentType=@docType)
	  BEGIN	
		SELECT @currentNotes = UPPER(LTRIM(RTRIM(ISNULL(notes, '')))), @id = id
		FROM comment
		WHERE prodNum=@code AND documentNum = @poNum AND documentType=@docType
		
		IF UPPER(LTRIM(RTRIM(@notes))) <> @currentNotes
		  BEGIN
			UPDATE comment SET notes = @currentNotes + 
				CASE 
					WHEN LEN(@currentNotes) > 0 THEN '<BR />' 
				END 
				+ UPPER(@notes)
			WHERE id = @id
		  END		
	  END
	 ELSE
	  BEGIN	
	   INSERT INTO comment(prodNum, documentNum, notes, documentType)
					VALUES(@code, @poNum, @notes, @docType)
	  END
	 
	 SELECT notes FROM comment WHERE prodNum=@code AND documentNum = @poNum AND documentType=@docType
END
GO
/****** Object:  StoredProcedure [dbo].[categories_SuperCat]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_SuperCat]
AS
BEGIN
	UPDATE categories SET superCat = NULL, superCatID = NULL

	UPDATE categories SET superCat = CATNAME, superCatID = ID WHERE PARENT_ID = 0

	WHILE EXISTS(SELECT * FROM categories WHERE superCat IS NULL and ACTIVE = 1)
	   BEGIN
			UPDATE c
			SET c.superCat = c2.superCat,
				c.superCatID = c2.superCatID
			FROM categories c JOIN categories c2 ON c.PARENT_ID = c2.ID AND c.primaryCat = c2.primaryCat
			WHERE c.superCat IS NULL AND c2.superCat IS NOT NULL
			
			UPDATE c
			SET c.superCat = c2.superCat,
				c.superCatID = c2.superCatID
			FROM categories c JOIN categories c2 ON c.PARENT_ID = c2.ID
			WHERE c.superCat IS NULL AND c2.superCat IS NOT NULL
	   END
	   
END
GO
/****** Object:  StoredProcedure [dbo].[categories_topMfg_SP]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_topMfg_SP]
AS
BEGIN
	DECLARE @id INT, @code VARCHAR(255), @sSQL VARCHAR(MAX)

	TRUNCATE TABLE categories_topMfg
	DECLARE catCursor CURSOR FOR 
	SELECT id, code
	FROM categories 
	WHERE primaryCat = 1 AND ACTIVE = 1	AND PARENT_ID <> 5844 AND endleaf = 0
	ORDER BY PARENT_ID, id

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @id, @code

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		TRUNCATE TABLE prodTemp
		
		SET @sSQL = 'INSERT INTO prodTemp([Mfg ID], [Product Name], [UnitPrice])
					 SELECT p.mfgid, p.mfgName, sum(p.sales30*price)
					 FROM products p JOIN categories c ON c.id = p.primaryCatID
					 WHERE breadcrumb LIKE ''%' + @code + '%'' OR categories LIKE ''%' + @code + '%'' 
					 GROUP BY p.mfgid, p.mfgName
					 ORDER BY 3 DESC'

		EXEC(@sSQL)
		
		INSERT INTO categories_topMfg(cid, mfgID, mfgName, insertDT)
		SELECT @id, [Mfg ID], [Product Name], GETDATE() FROM prodTemp ORDER BY UnitPrice DESC
		
		FETCH NEXT FROM catCursor INTO @id, @code
	   END

	CLOSE catCursor
	DEALLOCATE catCursor


END
GO
/****** Object:  StoredProcedure [dbo].[category_categorized_uncat_vendor_products]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- Modified: 4-14-2011 by Mike S., Removed references to Merchant2 per Beau D.


CREATE PROCEDURE [dbo].[category_categorized_uncat_vendor_products]
AS
BEGIN
	DECLARE @id INT, @catName VARCHAR(500), @numProd INT, @children INT, @prodCat INT, @mfgid VARCHAR(3)

	DECLARE catCursor CURSOR FOR 
	SELECT ID, catname, mfgid,
		(SELECT COUNT(*) FROM products WHERE ACTIVE = 1 and mfgid = c.mfgID) numProd,
		(SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 and PARENT_ID = c.ID) children,
		(SELECT COUNT(*) FROM products WHERE ACTIVE = 1 and CHARINDEX(isnull(c.catname, ''), categories) > 0) prodCat
	FROM categories c
	WHERE ACTIVE = 1 AND PARENT_ID = 5844
		AND (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 and PARENT_ID = c.ID) = 0

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @id, @catName, @mfgid, @numProd, @children, @prodCat

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		
		UPDATE products
		SET categories = 
				CASE 
					WHEN LEN(ISNULL(categories, '')) = 0 THEN @catName
					ELSE categories + '|' + @catName
				END
		WHERE ACTIVE = 1 AND mfgID = @mfgid
			AND CHARINDEX(@catName, ISNULL(categories, '')) = 0   
	   
		FETCH NEXT FROM catCursor INTO @id, @catName, @mfgid, @numProd, @children, @prodCat
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

END
GO
/****** Object:  StoredProcedure [dbo].[category_catxprod_sales]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- Modified: 4-14-2011 by Mike S., Removed references to Merchant2 per Beau D.


CREATE PROCEDURE [dbo].[category_catxprod_sales]
AS
BEGIN
	--REMOVE ALL PRODUCTS CATEGORIZED UNDER THE CLEARANCE AND NAFED DEAL
	DELETE c
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] s 
			JOIN catxprod c ON c.prodCode = s.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE [Manual Pricing] = 1
		AND [Sales Type] = 1
		AND [Sales Code] = 'KATOM'
		AND [Manual Price Reason Code] IN ('SALE_KATOM', 'SALE_NAFED')
		AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
				REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  
		AND (c.catCode LIKE '%clearance%' OR c.catCode = 'quarterly-specials')

	--ADDING SALES PRODUCTS TO THE CLEARANCE / SALES	
	INSERT INTO catxProd (catID, catCode, prodID, prodCode, primaryCat, nav)
	SELECT NULL,
			CASE c.superCat
				WHEN 'Pizza Equipment' THEN 'clearance-equipment'
				WHEN 'Kitchen Supplies' THEN 'clearance-residential'
				WHEN 'Countertop' THEN 'clearance-countertop'			
				WHEN 'Furniture' THEN 'clearance-furniture'
				WHEN 'Catering / Buffet' THEN 'clearance-residential'
				WHEN 'Janitorial' THEN 'clearance-janitorial'
				WHEN 'Tabletop' THEN 'clearance-tabletop'						
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'clearance-miscellaneous'
				WHEN 'Restaurant Equipment' THEN 'clearance-equipment'
				WHEN 'Bar Supplies' THEN 'clearance-residential'
				WHEN 'Residential' THEN 'clearance-residential'
				WHEN 'KaTom Kids' THEN 'clearance-miscellaneous'
				ELSE 'clearance-miscellaneous'
			END, 
			p.prodid, p.code,  
			CASE
				WHEN c.superCat IS NULL THEN 1
				ELSE 0
			END, 0
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] s 
			JOIN products p ON p.code = s.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
			LEFT JOIN categories c ON c.CODE = p.primaryCatCode and c.primaryCat = 1
	WHERE [Manual Pricing] = 1
		AND [Sales Type] = 1
		AND [Sales Code] = 'KATOM'
		AND [Manual Price Reason Code] IN ('SALE_KATOM', 'SALE_NAFED')
		AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
				REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  

	--ADDING NAFED SALES PRODUCTS TO THE QTRLY SALES CAT
	INSERT INTO catxProd (catID, catCode, prodID, prodCode, primaryCat, nav)
	SELECT NULL, 'quarterly-specials', p.prodid, p.code, 0, 0
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] s 
			JOIN products p ON p.code = s.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE [Manual Pricing] = 1
		AND [Sales Type] = 1
		AND [Sales Code] = 'KATOM'
		AND [Manual Price Reason Code] IN ('SALE_NAFED')
		AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
				REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))  

	--UPDATE CATID WHERE IT IS NULL
	UPDATE cx
	SET cx.catID = c.id
	FROM catxProd cx JOIN categories c ON cx.catCode = c.CODE
	WHERE cx.catID IS NULL	
END
GO
/****** Object:  StoredProcedure [dbo].[category_catxprod_cleanUp]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[category_catxprod_cleanUp]
AS
BEGIN
	--DELETE DUPLICATE CATXPROD ENTRY
	DECLARE @catid INT, @prodid INT, @primarycat BIT, @id INT

	DECLARE cCursor CURSOR FOR  	
	SELECT catid, prodid, primarycat
	FROM catxprod
	GROUP BY catid, prodid, primarycat
	HAVING COUNT(*) > 1
		
	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @catid, @prodid, @primarycat

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @id = ''
		
		SELECT TOP 1 @id = id
		FROM catxprod
		WHERE catid = @catid AND prodid = @prodid AND primaryCat = @primarycat
		ORDER BY id ASC
		
		DELETE FROM catxprod
		WHERE catid = @catid 
			AND prodid = @prodid 
			AND primaryCat = @primarycat 
			AND id <> @id

		FETCH NEXT FROM cCursor INTO @catid, @prodid, @primarycat
	   END

	CLOSE cCursor
	DEALLOCATE cCursor
				
	--ASSIGNED PRIMARYCAT IF THEY ARE ONLY 1 CATEGORIZATION AND IF IT IS SET PRIMARYCAT = 0	
	--UTILIZING PRODUCTTMP TABLE TO PROCESS DATA
	--MIVAPRODID = PRODID
	TRUNCATE TABLE productTMP	

	INSERT INTO productTMP(mivaProdID)
	SELECT prodid
	FROM catxprod
	GROUP BY prodid
	HAVING COUNT(*) = 1

	DELETE t
	FROM productTMP t JOIN catxProd cx ON t.mivaProdID = cx.prodID
	WHERE cx.primaryCat = 1

	UPDATE cx
	SET cx.primaryCat = 1
	FROM productTMP t JOIN catxProd cx ON t.mivaProdID = cx.prodID

	TRUNCATE TABLE productTMP
END
GO
/****** Object:  StoredProcedure [dbo].[backorderItem_Email]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[backorderItem_Email]
AS
BEGIN
	DECLARE @code VARCHAR(100), @thresholdMin INT, @ThresholdMax INT, @qtyOnHand INT, 
			@numOfOrder INT, @numItem INT, @OldestOrderDT DATETIME, @counter INT, @availToSale INT
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150), @bgcolor VARCHAR(500)
		
	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Backorder Item</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="text-align:center; width: 100px;">Product Code</td>
		<td style="text-align:center; width: 100px;">Min</td>
		<td style="text-align:center; width: 100px;">Max</td>
		<td style="text-align:center; width: 100px;">Qty On Hand</td>
		<td style="text-align:center; width: 100px;">Number of<BR />Open Orders</td>
		<td style="text-align:center; width: 100px;">Number of Item<BR />on Open Orders</td>
		<td style="text-align:center; width: 100px;">Available to Sale</td>
		<td style="text-align:center; width: 100px;">Oldest Open Order</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT [No_], thresholdMin, ThresholdMax, isnull(qtyOnHand, 0) qtyOnHand, 
			numOfOrder, numItem, availToSale, OldestOrderDT
	FROM backOrder_item
	WHERE DATEDIFF(day, [OldestOrderdt], getdate()) > 3
	ORDER BY [OldestOrderdt] ASC;

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @code, @thresholdMin, @ThresholdMax, @qtyOnHand, @numOfOrder, @numItem, @availToSale, @OldestOrderDT

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @code + '</td>
		<td align="center" >' + CAST(@thresholdMin AS VARCHAR(100)) + '</td>
		<td align="center" >' + CAST(@ThresholdMax AS VARCHAR(100))  + '</td>
		<td align="center" >' + CAST(@qtyOnHand AS VARCHAR(100)) + '</td>
		<td align="center" >' + CAST(@numOfOrder AS VARCHAR(100)) + '</td>
		<td align="center" >' + CAST(@numItem AS VARCHAR(100)) + '</td>
		<td align="center" >' + CAST(@availToSale AS VARCHAR(100)) + '</td>
		<td align="center" >' + CAST(@OldestOrderDT AS VARCHAR(11)) + '</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @code, @thresholdMin, @ThresholdMax, @qtyOnHand, @numOfOrder, @numItem, @availToSale, @OldestOrderDT
	   END


	CLOSE sCursor
	DEALLOCATE sCursor

	SET @body1 = @body1 + '</table>'

	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'patricia@katom.com; mmeade@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Daily Backorder Item Report'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[categories_reAssignProdCat_FA]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_reAssignProdCat_FA]
	@numProdPerCat INT
AS
BEGIN
	DECLARE @parent_ID INT, @parentCode VARCHAR(100)

	DECLARE catCursor CURSOR FOR 
	SELECT parent_id
	FROM CATEGORIES_FA c
	WHERE endleaf = 1 AND PARENT_ID NOT IN (0, 5844)
		AND (SELECT COUNT(*) FROM CATEGORIES_FA WHERE PARENT_ID = c.PARENT_ID AND endleaf = 0 ) < 1
	GROUP BY parent_id
	HAVING SUM(numProd) < (@numProdPerCat+1)

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @parent_ID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF NOT EXISTS(SELECT id FROM categories_FA WHERE PARENT_ID = @parent_ID AND endleaf = 0)
		   BEGIN   
			SELECT @parentCode = code FROM categories_FA WHERE ID = @parent_ID
		   
			UPDATE cx
			SET cx.catID = @parent_ID, 
				cx.catCode = @parentCode
			FROM catxprod_FA cx JOIN categories_FA c ON cx.catID = c.ID
			WHERE c.PARENT_ID = @parent_ID
			
			UPDATE categories_FA SET endleaf = 1 WHERE ID = @parent_ID
			DELETE FROM categories_FA WHERE PARENT_ID = @parent_ID	
		   END
			
		FETCH NEXT FROM catCursor INTO @parent_ID
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
END
GO
/****** Object:  StoredProcedure [dbo].[categories_numProd_FA_BK]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_numProd_FA_BK]
AS
BEGIN
	DECLARE @counter TINYINT
	
	SET @counter = 1

	UPDATE FAcategories set numProd = 0, numProdUpdated = 0, sales30 = 0 

	TRUNCATE TABLE FAcategoryWorktable

	INSERT INTO FAcategoryWorktable
	SELECT COUNT(*), c.ID, c.CODE, c.ACTIVE, NULL, SUM(p.price*ISNULL(p.sales30, 0))
	FROM catxprod m JOIN categories c ON m.catcode = c.code
						join products p on p.code = m.prodCode
	WHERE c.ACTIVE = 1 and p.ACTIVE = 1 and c.primaryCat = 1 and p.fa = 1
	group by c.ID, c.CODE, c.ACTIVE

	UPDATE c
	SET c.numProd = cw.tCounter, numProdUpdated = 1, c.sales30 = cw.tSales
	FROM facategories c join FAcategoryWorktable cw on c.CODE = cw.tCode

	WHILE EXISTS (
					SELECT PARENT_ID, superCat
					FROM FAcategories
					WHERE ACTIVE = 1 AND numprod > 0 and numProdUpdated = @counter and PARENT_ID > 0 
					GROUP BY PARENT_ID, superCat
				 )
	   BEGIN
		TRUNCATE TABLE FAcategoryWorktable

		INSERT INTO FAcategoryWorktable(tCounter, tCode, tCatName, tSales)
		SELECT SUM(numprod), PARENT_ID, superCat, SUM(sales30)
		FROM FAcategories
		WHERE ACTIVE = 1 and numProd > 0 and numProdUpdated = @counter and PARENT_ID > 0
		GROUP BY PARENT_ID, superCat
		order by PARENT_ID	
		
		SET @counter = @counter + 1
			
		UPDATE c
		SET c.numProd = c.numProd + cw.tCounter, numProdUpdated = @counter, c.sales30 = cw.tSales
		FROM FAcategories c join FAcategoryWorktable cw on c.id = cw.tCode --and cw.tCatName = c.superCat	
	   END

		delete openquery (RDN, 'select * from fa_cat_prods')

		insert openquery(RDN, 'select catcode, numprods from fa_cat_prods')
		SELECT f.code, f.numprod FROM FAcategories f

END
GO
/****** Object:  StoredProcedure [dbo].[categories_numProd_FA]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_numProd_FA]
AS
BEGIN
	DECLARE @counter TINYINT

	SET @counter = 1

	UPDATE CATEGORIES_FA set numProd = 0, numProdUpdated = 0

	TRUNCATE TABLE categoryWorktable

	--COUNT NUMBER OF PRODUCTS FOR ENDLEAF
	INSERT INTO categoryWorktable(tCatname, tCounter)
	SELECT c.id, COUNT(cx.prodid)
	FROM CATEGORIES_FA c LEFT JOIN catxProd_FA cx ON c.id = cx.catid
	WHERE endleaf = 1
	GROUP BY c.ID

	UPDATE c
	SET c.numProd = ct.tCounter, numProdUpdated = 1
	FROM CATEGORIES_FA c JOIN categoryWorktable ct ON c.id = ct.tCatname


	--THE PRODCOUNT IS NOT ACCURATE AS YOU MOVE UP THE TREE.  
	--IT'S DOUBLE COUNTING ENDLEAF PRODCOUNT IF A COMBINATION OF ENDLEAF AND NONE ENDLEAF CAT BELONG TO A PARENT CAT...
	WHILE EXISTS (
					SELECT PARENT_ID, superCat
					FROM CATEGORIES_FA
					WHERE ACTIVE = 1 AND numprod > 0 and numProdUpdated = @counter
					GROUP BY PARENT_ID, superCat
				 )
	   BEGIN
		TRUNCATE TABLE categoryWorktable

		INSERT INTO categoryWorktable(tCounter, tCode, tCatName, tSales)
		SELECT SUM(numprod), PARENT_ID, superCat, COUNT(id)
		FROM CATEGORIES_FA
		WHERE ACTIVE = 1 and numProd > 0 and numProdUpdated = @counter and PARENT_ID > 0
		GROUP BY PARENT_ID, superCat
		order by PARENT_ID	
		
		SET @counter = @counter + 1
			
		UPDATE c
		SET c.numProd = c.numProd + cw.tCounter, numProdUpdated = @counter
		FROM CATEGORIES_FA c join categoryWorktable cw on c.id = cw.tCode
	   END	   
	
	--DELETING ANY CATEGORIES WITH NO PRODUCTS 
	DELETE FROM CATEGORIES_FA WHERE numProd = 0
END
GO
/****** Object:  StoredProcedure [dbo].[categories_numProd]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_numProd]
AS
BEGIN
	DECLARE @counter TINYINT
	
	SET @counter = 1

	UPDATE categories set numProd = 0, numProdUpdated = 0, sales30 = 0 

	TRUNCATE TABLE categoryWorktable

	INSERT INTO categoryWorktable
	SELECT COUNT(*), c.ID, c.CODE, c.ACTIVE, NULL, SUM(p.price*ISNULL(p.sales30, 0))
	FROM catxprod m JOIN categories c ON m.catcode = c.code
						join products p on p.code = m.prodCode
	WHERE c.ACTIVE = 1 and p.ACTIVE = 1 and c.primaryCat = 1
	group by c.ID, c.CODE, c.ACTIVE

	UPDATE c
	SET c.numProd = cw.tCounter, numProdUpdated = 1, c.sales30 = cw.tSales
	FROM categories c join categoryWorktable cw on c.CODE = cw.tCode

	WHILE EXISTS (
					SELECT PARENT_ID, superCat
					FROM categories
					WHERE ACTIVE = 1 AND numprod > 0 and numProdUpdated = @counter and PARENT_ID > 0
					GROUP BY PARENT_ID, superCat
				 )
	   BEGIN
		TRUNCATE TABLE categoryWorktable

		INSERT INTO categoryWorktable(tCounter, tCode, tCatName, tSales)
		SELECT SUM(numprod), PARENT_ID, superCat, SUM(sales30)
		FROM categories
		WHERE ACTIVE = 1 and numProd > 0 and numProdUpdated = @counter and PARENT_ID > 0
		GROUP BY PARENT_ID, superCat
		order by PARENT_ID	
		
		SET @counter = @counter + 1
			
		UPDATE c
		SET c.numProd = c.numProd + cw.tCounter, numProdUpdated = @counter, c.sales30 = cw.tSales
		FROM categories c join categoryWorktable cw on c.id = cw.tCode --and cw.tCatName = c.superCat	
	   END
END
GO
/****** Object:  StoredProcedure [dbo].[catPerformanceWeekly_EMAIL]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[catPerformanceWeekly_EMAIL]
AS
BEGIN
	DECLARE @catname VARCHAR(50), @w1 MONEY, @w2 MONEY, @w3 MONEY, @w4 MONEY, @w5 MONEY, @w6 MONEY, 
			@o1 INT, @o2 INT, @o3 INT, @o4 INT, @o5 INT, @o6 INT, 
			@wa MONEY, @wao INT, @m MONEY, @mo INT, @mp MONEY, @l MONEY, @lo INT,
			@w1tt MONEY, @w2tt MONEY, @w3tt MONEY, @w4tt MONEY, @w5tt MONEY, @w6tt MONEY, 
			@o1tt INT, @o2tt INT, @o3tt INT, @o4tt INT, @o5tt INT, @o6tt INT, @prodcountTT INT,
			@watt MONEY, @waott INT, @mtt MONEY, @mott INT, @mptt MONEY, @prodcount INT, @startDT datetime,
			@today DATETIME, @yyyy SMALLINT, @dd TINYINT, @mm TINYINT, @counter SMALLINT, @bgcolor VARCHAR(50), @fontcolor VARCHAR(50)
			
	DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150)
				
	SET @w1tt = 0 
	SET @w2tt = 0 
	SET @w3tt = 0 
	SET @w4tt = 0 
	SET @w5tt = 0 
	SET @w6tt = 0 
	SET @o1tt = 0
	SET @o2tt = 0
	SET @o3tt = 0
	SET @o4tt = 0
	SET @o5tt = 0
	SET @o6tt = 0
	SET @watt = 0
	SET @waott = 0
	SET @mtt = 0
	SET @mott = 0
	SET @mptt = 0	
	SET @prodcountTT = 0		
	
	SET @counter = 1
	SET @bgcolor = '#bed6e9'

	--INITIATING DATE
	SET @today = GETDATE()
	SET @yyyy = YEAR(@today)
	SET @mm = MONTH(@today)
	SET @dd = DAY(@today)
	SET @startDT = CAST(CAST(DATEADD(DAY, -6-DATEPART(WEEKDAY, @today), @today) AS VARCHAR(11)) AS DATETIME)

	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>E-Mail</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="width: 100px;">catname</td>
		<td style="text-align:center; width: 100px;">ProdCount</td>
		<td style="text-align:center; width: 140px;" colspan="2">'+ CAST(DATEADD(WEEK, -5, @startDT) AS VARCHAR(11)) + '</td>
		<td style="text-align:center; width: 140px;" colspan="2">'+ CAST(DATEADD(WEEK, -4, @startDT) AS VARCHAR(11)) + '</td>
		<td style="text-align:center; width: 140px;" colspan="2">'+ CAST(DATEADD(WEEK, -3, @startDT) AS VARCHAR(11)) + '</td>
		<td style="text-align:center; width: 140px;" colspan="2">'+ CAST(DATEADD(WEEK, -2, @startDT) AS VARCHAR(11)) + '</td>
		<td style="text-align:center; width: 140px;" colspan="2">'+ CAST(DATEADD(WEEK, -1, @startDT) AS VARCHAR(11)) + '</td>
		<td style="text-align:center; width: 140px;" colspan="2">'+ CAST(@startDT AS VARCHAR(11)) + '</td>
		<td style="text-align:center; width: 140px;" colspan="2">6 WK AVG</td>
		<td style="text-align:center; width: 140px;" colspan="2">MTD</td>
		<td style="text-align:center; width: 70px;">Monthly Goal</td>
	  </tr>
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="text-align:center; width: 100px;">&nbsp;</td>
		<td style="text-align:center; width: 100px;">&nbsp;</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">Sales</td>
		<td style="text-align:center; width: 70px;">Order</td>
		<td style="text-align:center; width: 70px;">&nbsp;</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT * FROM catPerformance_RPT WHERE catName <> 'Others'

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @catName, @prodcount, @w1,  @o1, @w2, @o2, @w3, @o3, @w4, @o4, @w5, @o5, @w6, @o6, @wa, @wao, @m, @mo, @mp, @l, @lo

	WHILE @@FETCH_STATUS = 0
	   BEGIN		
		SET @w1tt =  @w1tt + @w1
		SET @w2tt =  @w2tt + @w2
		SET @w3tt =  @w3tt + @w3
		SET @w4tt =  @w4tt + @w4
		SET @w5tt =  @w5tt + @w5
		SET @w6tt =  @w6tt + @w6
		SET @o1tt =  @o1tt + @o1
		SET @o2tt =  @o2tt + @o2
		SET @o3tt =  @o3tt + @o3
		SET @o4tt =  @o4tt + @o4
		SET @o5tt =  @o5tt + @o5
		SET @o6tt =  @o6tt + @o6
		SET @watt = @watt + @wa
		SET @waott = @waott + @wao
		SET @mtt = @mtt + @m
		SET @mott = @mott + @mo
		SET @mptt = @mptt + @mp
		SET @prodcountTT = @prodcountTT + @prodcount
		
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @catName + '</td>
		<td align="center" >' + cast(@prodcount as varchar(100)) + '</td>'
		IF (@w1) < @wa
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@w1, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@o1, 0), 1) + '</font></td>'
		IF (@w2) < @wa
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@w2, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@o2, 0), 1) + '</font></td>'
		IF (@w3) < @wa
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@w3, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@o3, 0), 1) + '</font></td>'
		IF (@w4) < @wa
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@w4, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@o4, 0), 1) + '</font></td>'
		IF (@w5) < @wa
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@w5, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@o5, 0), 1) + '</font></td>'
		IF (@w6) < @wa
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@w6, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@o6, 0), 1) + '</font></td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@wa, 0), 1) + '</td>
		<td align="center">' + CONVERT(varchar(50), ISNULL(@wao, 0), 1) + '</td>
		'
		IF (@w6+@w5+@w4+@w3) < @mp
		   BEGIN
			SET @fontcolor = '#FF0000'
		   END
		ELSE
		   BEGIN
			SET @fontcolor = '#000000'
		   END
		
		SET @body1 = @body1 + '<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@m, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@mo, 0), 1) + '</font></td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@mp, 0), 1) + '</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @catName, @prodcount, @w1, @o1, @w2, @o2, @w3, @o3, @w4, @o4, @w5, @o5, @w6, @o6, @wa, @wao, @m, @mo, @mp, @l, @lo
	   END

	CLOSE sCursor
	DEALLOCATE sCursor
	
	IF (@w6tt+@w5tt+@w4tt+@w3tt) < @mptt
	   BEGIN
		SET @fontcolor = '#FF0000'
	   END
	ELSE
	   BEGIN
		SET @fontcolor = '#000000'
	   END
	
	SET @body1 = @body1 + ' <tr style="background-color:#cccccc; font-weight: bold;">
		<td>Total</td>
		<td align="center" >' + CAST(@prodcountTT AS VARCHAR(100)) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@w1tt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@o1tt, 0), 1) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@w2tt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@o2tt, 0), 1) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@w3tt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@o3tt, 0), 1) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@w4tt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@o4tt, 0), 1) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@w5tt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@o5tt, 0), 1) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@w6tt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@o6tt, 0), 1) + '</td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@watt, 0), 1) + '</td>
		<td align="center" >' + CONVERT(varchar(50), ISNULL(@waott, 0), 1) + '</td>
		<td align="center" ><font color="' + @fontcolor + '">$' + CONVERT(varchar(50), ISNULL(@mtt, 0), 1) + '</font></td>
		<td align="center" ><font color="' + @fontcolor + '">' + CONVERT(varchar(50), ISNULL(@mott, 0), 1) + '</font></td>
		<td align="center" >$' + CONVERT(varchar(50), ISNULL(@mptt, 0), 1) + '</td>
	  </tr>'	

	SET @body1 = @body1 + '</table>'
	
	SET @body1 = @body1 + '	</body>
	</html>'
	
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'dlu@katom.com; pchesworth@katom.com; sara@roirevolution.com; matt@roirevolution.com; pbible@katom.comdlu@katom.com; pbible@katom.com; pchesworth@katom.com; cbible@katom.com; jchesworth@katom.com; jrogers@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'Weekly Sales Performance'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[catPerformanceWeekly]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[catPerformanceWeekly]
AS
BEGIN
	DECLARE @year Smallint, @month TINYINT, @weekday TINYINT, @day TINYINT, @week TINYINT, @startDT datetime, @endDT datetime, 
	@salesTT money, @orderTT int, @today datetime, @sSQL VARCHAR(MAX), @position TINYINT, @lMonth TINYINT, @lMonthy SMALLINT,
	@yyyy SMALLINT, @w TINYINT, @catname VARCHAR(100), @sales MONEY, @order INT, @variance INT, @LP TINYINT, @currentCat VARCHAR(100),
	@salesP MONEY

	SET @today = GETDATE()
	SET @year = YEAR(@today)
	SET @month = MONTH(@today)
	SET @weekday = DATEPART(WEEKDAY, @today)
	SET @week = DATEPART(WEEK, @today)
	SET @day = DAY(@today)
	SET @startDT = CAST(CAST(DATEADD(DAY, -6-DATEPART(WEEKDAY, @today), @today) AS VARCHAR(11)) AS DATETIME)
	SET @endDT = CAST(CAST(DATEADD(DAY, -DATEPART(WEEKDAY, @today), @today) AS VARCHAR(11)) AS DATETIME)
	SET @variance = DATEPART(WEEK, DATEADD(WEEK, -5, @startDT))-1
	SET @LP = 0
	SET @sSQL = ''
	SET @currentCat = ''


	IF @month = 1
	   BEGIN
		SET @lMonth = 12
		SET @lMonthy = @year-1
	   END
	ELSE
	   BEGIN
		SET @lMonth = @month-1
		SET @lMonthy = @year   
	   END

	--INITIATE TABLE
	TRUNCATE TABLE catPerformance_RPT
	INSERT INTO catPerformance_RPT
	SELECT 
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END, COUNT(*), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
	FROM products p LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE p.ACTIVE = 1
	GROUP BY CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	ORDER BY 1 ASC

	--INSERT FIRST SIX WEEKS SALES FROM INVOICE TABLE
	DECLARE sCursor CURSOR FOR 
	SELECT 
		YEAR(ih.[Order Date]), DATEPART(WEEK, ih.[Order Date]),
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END,
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE ih.[Order Date] BETWEEN DATEADD(WEEK, -5, @startDT) AND @endDT
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY YEAR(ih.[Order Date]), DATEPART(WEEK, ih.[Order Date]), 
			CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	UNION
	SELECT 
		YEAR(ih.[Order Date]), DATEPART(WEEK, ih.[Order Date]),
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END,
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE ih.[Order Date] BETWEEN DATEADD(WEEK, -5, @startDT) AND @endDT
		AND ih.[Document Type] = 1
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY YEAR(ih.[Order Date]), DATEPART(WEEK, ih.[Order Date]), 
			CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	ORDER BY 3, 1, 2 ASC

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @yyyy, @w, @catname, @sales, @order

	WHILE @@FETCH_STATUS = 0
	   BEGIN   
		IF LEN(@currentCat) = 0
		   BEGIN
			SET @currentCat = @catname
		   END
		   
		IF @currentCat <> @catname
		   BEGIN
			SET @currentCat = @catname
			SET @variance = DATEPART(WEEK, DATEADD(WEEK, -5, @startDT))-1
		   END   
	   
		IF (@w-@variance) < 1
		   BEGIN
			SET @variance = @LP
			SET @position = @w+@variance
		   END
		ELSE
		   BEGIN
			SET @LP = @w-@variance
			SET @position = @w-@variance
		   END	
		   
		SET @sSQL = 'UPDATE catPerformance_RPT
					 SET W' + CAST(@position AS VARCHAR(5)) + ' = W' + CAST(@position AS VARCHAR(5)) + ' + ' + CAST(@sales AS VARCHAR(20)) + ', 
						 O' + CAST(@position AS VARCHAR(5)) + ' = O' + CAST(@position AS VARCHAR(5)) + ' + ' + CAST(@order AS VARCHAR(20)) + '
					 WHERE catName = ''' + @catname + ''''
						
		
		exec (@sSQL)	
			
		FETCH NEXT FROM sCursor INTO @yyyy, @w, @catname, @sales, @order
	   END

	CLOSE sCursor
	DEALLOCATE sCursor


	--6 WEEKS AVG	
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Product Name], [UnitPrice], [UnitPrice2])
	SELECT catName, (W1+W2+W3+W4+W5+W6)/6, (O1+O2+O3+O4+O5+O6)/6
	FROM catPerformance_RPT

	UPDATE c
	SET c.W_AVG = [UnitPrice],
		c.W_AVG_O = [UnitPrice2]
	FROM catPerformance_RPT c JOIN prodTemp p ON c.catName = p.[Product Name]	

	--CALCULATING MONTHLY SALES
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Product Name], [UnitPrice], [UnitPrice2])
	SELECT 
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END,
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE ih.[Order Date] BETWEEN CAST(@month AS VARCHAR(2)) + '/01/' + CAST(@year AS VARCHAR(4)) AND @endDT
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	ORDER BY 1 ASC	
		
	UPDATE c
	SET c.MTD = [UnitPrice],
		c.MTDO = [UnitPrice2]
	FROM catPerformance_RPT c JOIN prodTemp p ON c.catName = p.[Product Name]

	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Product Name], [UnitPrice], [UnitPrice2])
	SELECT 
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END,
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE ih.[Order Date] BETWEEN CAST(@month AS VARCHAR(2)) + '/01/' + CAST(@year AS VARCHAR(4)) AND @endDT
		AND ih.[Document Type] = 1
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	ORDER BY 1 ASC	
		
	UPDATE c
	SET c.MTD = c.MTD + [UnitPrice],
		c.MTDO = c.MTDO + [UnitPrice2]
	FROM catPerformance_RPT c JOIN prodTemp p ON c.catName = p.[Product Name]


	--CALCULATING LAST MONTHL SALES
	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Product Name], [UnitPrice], [UnitPrice2])
	SELECT 
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END,
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE MONTH(ih.[Order Date]) = @lMonth AND YEAR(ih.[Order Date]) = @lMonthy
		AND ih.[Source Code] = 'SALES'
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	ORDER BY 1 ASC	
		
	UPDATE c
	SET c.LM = [UnitPrice],
		c.LMO = [UnitPrice2]
	FROM catPerformance_RPT c JOIN prodTemp p ON c.catName = p.[Product Name]

	TRUNCATE TABLE prodTemp

	INSERT INTO prodTemp([Product Name], [UnitPrice], [UnitPrice2])
	SELECT 
		CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'	
				ELSE ISNULL(c.superCat, 'UNCAT')
			END,
		CAST(SUM(ISNULL(il.[Outstanding Amount], 0)+ISNULL(il.[Shipped Not Invoiced], 0)) as decimal(10, 2)),
		COUNT(distinct ISNULL(ih.[No_], 0)) orderTT		
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p ON p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
		LEFT JOIN categories c on p.primaryCatID = c.ID AND primaryCat = 1
	WHERE MONTH(ih.[Order Date]) = @lMonth AND YEAR(ih.[Order Date]) = @lMonthy
		AND ih.[Document Type] = 1
		AND LEN(ISNULL(ih.[Customer Source], '')) > 0
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY CASE ISNULL(c.superCat, 'Others')
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN 'Others'
				WHEN 'KaTom Kids' THEN 'Others'
				WHEN 'Shop By Vendor' THEN 'UNCAT'
				WHEN 'Special' THEN 'Others'			
				ELSE ISNULL(c.superCat, 'UNCAT')
			  END
	ORDER BY 1 ASC	
		
	UPDATE c
	SET c.LM = c.LM + [UnitPrice],
		c.LMO = c.LMO + [UnitPrice2]
	FROM catPerformance_RPT c JOIN prodTemp p ON c.catName = p.[Product Name]

	--PROJECTING SALES FOR THIS MONTH
	SELECT @salesTT = SUM(LM) FROM catPerformance_RPT
	SELECT @salesP = sales FROM salesProjection WHERE YYYY = YEAR(@endDT) AND MM = MONTH(@endDT)

	TRUNCATE TABLE prodTemp

	IF @salesP < @salesTT
	   BEGIN
		INSERT INTO prodTemp([Product Name], [UnitPrice])
		SELECT CATNAME, (1.03*@salesTT*LM)/@salesTT FROM catPerformance_RPT   
	   END
	ELSE
	   BEGIN
		INSERT INTO prodTemp([Product Name], [UnitPrice])
		SELECT CATNAME, (@salesP*LM)/@salesTT FROM catPerformance_RPT     
	   END

	UPDATE c
	SET c.MTD_PROJ = [UnitPrice]
	FROM catPerformance_RPT c JOIN prodTemp p ON c.catName = p.[Product Name]
END
GO
/****** Object:  StoredProcedure [dbo].[categoryVirtual_SP]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- Modified: 4-14-2011 by Mike S., Removed references to Merchant2 per Beau D.


CREATE PROCEDURE [dbo].[categoryVirtual_SP]
AS
BEGIN
	--REMOVE ALL CATEGORIES WHERE IT IS NO LONGER ACTIVE
	DELETE FROM MIVAVirtualCat WHERE subcat_id NOT IN (SELECT id FROM categories2 WHERE ACTIVE = 1)

	--REMOVE ALL CATEGORIES WHERE PARENT_CAT IS NO LONGER ACTIVE
	DELETE FROM MIVAVirtualCat WHERE parent_id NOT IN (SELECT id FROM categories2 WHERE ACTIVE = 1)

	--COPYING ACTIVE CATEGORIES TO WORKTABLE
	TRUNCATE TABLE categoryVirtualWorktable

	INSERT INTO categoryVirtualWorktable
	SELECT parent_ID, subcat_id, 0 FROM MIVAVirtualCat

	--SETTING REMOVE FLAG EQUAL TO 1 WHERE THE RELATIONSHIP ALREADY EXIST IN THE CATEGORY TABLE
	UPDATE m SET remove = 1 FROM categoryVirtualWorktable m JOIN categories c ON m.subcat_id = c.ID and m.parent_id = c.PARENT_ID

	DELETE categoryVirtualWorktable WHERE remove = 1

	INSERT INTO categories(ID, PARENT_ID, CODE, CATNAME, catDescription, catOrder, metaDescription, url, endleaf, featuredProd1, featuredProd2, ACTIVE, primaryCat)
	SELECT v.subcat_id, v.parent_ID, c.CODE,c.CATNAME, c.catDescription, v.subcat_id, 
			c.metaDescription, c.url, c.endleaf, c.featuredProd1, c.featuredProd2, ACTIVE, 0
	FROM categoryVirtualWorktable v JOIN categories2 c on v.subcat_id = c.ID
END
GO
/****** Object:  StoredProcedure [dbo].[categoryDuplicateCleanup_SP]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categoryDuplicateCleanup_SP]
AS
BEGIN
	DECLARE @id INT, @parent_ID INT, @code VARCHAR(500), @catCode VARCHAR(500), @uniqueID INT

	--REMOVING DUPLICATE ENTRY IN CATEGORIES TABLE
	DECLARE cCursor CURSOR FOR 
	SELECT ID, PARENT_ID
	FROM categories
	GROUP BY ID, PARENT_ID
	HAVING COUNT(*) > 1

	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @id, @parent_ID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @uniqueID = ''
		
		SELECT @uniqueID = unique_ID
		FROM categories
		WHERE ID = @id AND PARENT_ID = @parent_ID 
		ORDER BY active DESC
		
		DELETE FROM categories
		WHERE ID = @id AND PARENT_ID = @parent_ID AND unique_ID <> @uniqueID

		FETCH NEXT FROM cCursor INTO @id, @parent_ID
	   END

	CLOSE cCursor
	DEALLOCATE cCursor

	--REMOVING DUPLICATE ENTRY IN CATXPROD TABLE
	DECLARE cCursor CURSOR FOR 
	SELECT catcode, prodCode
	FROM catxprod
	GROUP BY catcode, prodCode
	HAVING COUNT(*) > 1

	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @catCode, @code

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @uniqueID = ''
		
		SELECT @uniqueID = ID
		FROM catxprod
		WHERE catCode = @catCode AND prodCode = @code
		
		DELETE FROM catxprod
		WHERE catCode = @catCode AND prodCode = @code AND ID <> @uniqueID

		FETCH NEXT FROM cCursor INTO @catCode, @code
	   END

	CLOSE cCursor
	DEALLOCATE cCursor
END
GO
/****** Object:  StoredProcedure [dbo].[category_holiday]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- Modified: 4-14-2011 by Mike S., Removed references to Merchant2 per Beau D.


CREATE PROCEDURE [dbo].[category_holiday]
AS
BEGIN
	DELETE FROM catxprod WHERE catID IN (10754, 10755, 10756)
	
	INSERT INTO catxprod(catID, catCode, prodID, prodCode, primaryCat)		
	SELECT 10754, 'gift-ideas-for-the-ones-you-love', prodid, code, 0 
	FROM products
	WHERE mfgid in('449', '103', '174', '165', '194', '645', '168', '261', '164', '063', '177', '416', '579', 
					'317', '141', '186', '162', '075')
		and active = 1
		and price > 250
		and qtyonhand > 0
	UNION
	SELECT 10755, 'gift-ideas-for-the-ones-you-like', prodid, code, 0
	FROM  products
	WHERE mfgid in('449', '103', '174', '165', '194', '645', '168', '261', '164', '063', '177', '416', '579', 
					'317', '141', '186', '162', '075')
		and active = 1
		and price between 50 and 249.99	
		and qtyonhand > 0
	UNION
	SELECT 10756, 'stocking-ideas', prodid, code, 0
	FROM  products
	WHERE mfgid in('449', '103', '174', '165', '194', '645', '168', '261', '164', '063', '177', '416', '579', 
					'317', '141', '186', '162', '075')
		and active = 1
		and price < 50
		and qtyonhand > 0	
END
GO
/****** Object:  StoredProcedure [dbo].[category_featuredProducts]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[category_featuredProducts]
AS
BEGIN
	DECLARE @catID INT, @cID INT, @code VARCHAR(50), @counter TINYINT, @endleaf INT, 
			@catCode VARCHAR(100), @sSQL VARCHAR(MAX), @superCat INT

	SET @sSQL = ''
		
	UPDATE categories SET featuredProd1 = NULL, featuredProd2 = NULL

	DECLARE catCursor CURSOR FOR 
	SELECT distinct id, code, endleaf, superCatID
	FROM categories
	WHERE ACTIVE = 1 

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @catID, @catCode, @endleaf, @superCat

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @counter = 1	
	   
		IF @endleaf = 1
		   BEGIN
			SET @sSQL = 'DECLARE pCursor CURSOR FOR 
						SELECT TOP 2 m.catid, p.code
						FROM catxprod m JOIN categories c ON m.catid = c.ID
											JOIN products p ON m.prodid = p.prodID
						WHERE c.ACTIVE = 1 AND p.ACTIVE = 1 AND m.catid = ' + CAST(@catID AS VARCHAR(10)) + 
						' AND c.primaryCat = 1 AND superCatID = ' + CAST(@superCat AS VARCHAR(10)) + ' ORDER BY price*SALES90 DESC, p.qtyonhand DESC'
		   END
		ELSE
		   BEGIN
			SET @sSQL = 'DECLARE pCursor CURSOR FOR 
						SELECT top 2 ' + CAST(@catID AS VARCHAR(10)) + ', code
						FROM products
						WHERE ProdID IN 
							(
							SELECT prodid
							FROM categories c JOIN catxprod m ON c.ID = m.catid
							WHERE slibreadcrumb LIKE ' + 
								CASE 
									WHEN @catCode = 'shop-by-vendor' THEN '''%brands.A-C.1.html%'''
									ELSE '''%' + @catCode + '.html%'''
								END  
						--	+ ' AND superCatID = ' + CAST(@superCat AS VARCHAR(10)) + ' AND endleaf = 1
							+ ' AND endleaf = 1
							)
						ORDER BY price*SALES90 DESC, qtyonhand DESC'
		   END
		   
		EXEC(@sSQL)
		   
		OPEN pCursor
		FETCH NEXT FROM pCursor INTO @cID, @code

		WHILE @@FETCH_STATUS = 0
		   BEGIN
			IF @counter = 1
			   BEGIN
				SET @counter = 2
				UPDATE categories SET featuredProd1 = @code WHERE ID = @cID
			   END
			ELSE
			   BEGIN
				SET @counter = 1
				UPDATE categories SET featuredProd2 = @code WHERE ID = @cID		   
			   END
			   
			FETCH NEXT FROM pCursor INTO  @cID, @code
		   END

		CLOSE pCursor
		DEALLOCATE pCursor	
		
		FETCH NEXT FROM catCursor INTO @catID, @catCode, @endleaf, @superCat
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

END
GO
/****** Object:  StoredProcedure [dbo].[CopyEbayOrderToTest]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[CopyEbayOrderToTest]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

DECLARE @ORDERID varchar(50)

SET @ORDERID = '13151350'

	insert into order_hdrtest(
	[customerpo]
      ,[shiptocontact]
      ,[shiptoemail]
      ,[shiptocustomername]
      ,[phoneno]
      ,[faxno]
      ,[shiptoaddress]
      ,[shiptoaddress2]
      ,[shiptocity]
      ,[shiptostate]
      ,[shiptozip]
      ,[shiptocountry]
      ,[selltocustomername]
      ,[selltoemail]
      ,[selltocontact]
      ,[selltoaddress]
      ,[selltoaddress2]
      ,[selltocity]
      ,[selltostate]
      ,[selltozip]
      ,[ccnum]
      ,[ccname]
      ,[ccexpmo]
      ,[ccexpyr]
      ,[cvc]
      ,[exported]
      ,[shipmethod]
      ,[shipamount]
      ,[ordertimestamp]
      ,[batchtimestamp]
      ,[importValidated]
      ,[avsaddr]
      ,[avszip]
      ,[cvv2match]
      ,[pnref]
      ,[respcode]
      ,[selltocountry]
      ,[sellto1]
      ,[selltophone]
      ,[orderplacedby]
      ,[paymenttermscode]
      ,[CustomerPO2]
      ,[CustomerSource]
      ,[AmountSubmitted])
      select [customerpo]
      ,[shiptocontact]
      ,[shiptoemail]
      ,[shiptocustomername]
      ,[phoneno]
      ,[faxno]
      ,[shiptoaddress]
      ,[shiptoaddress2]
      ,[shiptocity]
      ,[shiptostate]
      ,[shiptozip]
      ,[shiptocountry]
      ,[selltocustomername]
      ,[selltoemail]
      ,[selltocontact]
      ,[selltoaddress]
      ,[selltoaddress2]
      ,[selltocity]
      ,[selltostate]
      ,[selltozip]
      ,[ccnum]
      ,[ccname]
      ,[ccexpmo]
      ,[ccexpyr]
      ,[cvc]
      ,[exported]
      ,[shipmethod]
      ,[shipamount]
      ,[ordertimestamp]
      ,[batchtimestamp]
      ,[importValidated]
      ,[avsaddr]
      ,[avszip]
      ,[cvv2match]
      ,[pnref]
      ,[respcode]
      ,[selltocountry]
      ,[sellto1]
      ,[selltophone]
      ,[orderplacedby]
      ,[paymenttermscode]
      ,[CustomerPO2]
      ,[CustomerSource]
      ,[AmountSubmitted] from order_hdr where customerpo = @ORDERID
	

	update order_hdrtest
	set paymenttermscode = 'PP',
	 exported = 0
	where customerpo = @ORDERID

insert into order_itemstest(
	  [order_id]
      ,[line_id]
      ,[product_id]
      ,[code]
      ,[name]
      ,[price]
      ,[weight]
      ,[taxable]
      ,[upsold]
      ,[quantity])
      select 
      [order_id]
      ,[line_id]
      ,[product_id]
      ,[code]
      ,[name]
      ,[price]
      ,[weight]
      ,[taxable]
      ,[upsold]
      ,[quantity]
  FROM [KatomDev].[dbo].[order_items]
	where order_id = @ORDERID

insert into order_chargestest(
      [charge_id]
      ,[module_id]
      ,[type]
      ,[descrip]
      ,[amount]
      ,[disp_amt]
      ,[tax_exempt])
select [charge_id]
      ,[module_id]
      ,[type]
      ,[descrip]
      ,[amount]
      ,[disp_amt]
      ,[tax_exempt] from order_charges
where order_id = @ORDERID

insert into order_optionstest
      ([order_id]
      ,[line_id]
      ,[attr_id]
      ,[attr_code]
      ,[option_id]
      ,[attmpat_id]
      ,[opt_code]
      ,[price]
      ,[weight]
      ,[data]
      ,[data_long])
select [order_id]
      ,[line_id]
      ,[attr_id]
      ,[attr_code]
      ,[option_id]
      ,[attmpat_id]
      ,[opt_code]
      ,[price]
      ,[weight]
      ,[data]
      ,[data_long]
      from order_options
where order_id = @ORDERID
      
END
GO
/****** Object:  StoredProcedure [dbo].[ConfirmationEmailerbkp12-4-11]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ConfirmationEmailerbkp12-4-11] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


/*Begins the loop to pull down and parse payment information*/
	DECLARE @selltoname varchar(30)
	DECLARE @selltoaddress varchar(30)
	DECLARE @selltoaddress2 varchar(30)
	DECLARE @selltocity varchar(30)
	DECLARE @selltostate varchar(10)
	DECLARE @selltozip varchar(10)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoaddress varchar(30)
	DECLARE @shiptoaddress2 varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @orderdate varchar(255)
	DECLARE @shipmethod varchar(200)
	DECLARE @phone varchar(20)
	DECLARE @email varchar(50)
	DECLARE @confnum varchar(20)
	DECLARE @email1 varchar(500)
	DECLARE @Navorder varchar(500)
	DECLARE @order varchar(500)
	DECLARE @subject1 varchar(150)
	DECLARE @body1 varchar(MAX)
	DECLARE @prodcode varchar(50)
	DECLARE @prodqty varchar(50)
	DECLARE @prodimg varchar(100)
	DECLARE @prodname varchar(200)
	DECLARE @prodprice varchar(100)
	DECLARE @prodtotal varchar(100)
	DECLARE @total varchar(100)
	DECLARE @shipping varchar(100)
	DECLARE @tax varchar(100)
	DECLARE @ordertotal varchar(100)

	
	DECLARE OrderCursor CURSOR FOR 
	
	select
		h.No_ as NavOrdNo, 
		[sell-to customer name] as selltoname, 
		[sell-to address] as selltoaddress, 
		[sell-to address 2] as selltoaddress2, 
		[sell-to city] as selltocity, 
		[sell-to county] as selltostate, 
		[sell-to post code] as selltozip, 
		[ship-to name] as shiptoname, 
		[Ship-to Address] as shiptoaddress, 
		[Ship-to Address 2] as shiptoaddress2, 
		[Ship-to City] as shiptocity, 
		[ship-to county] as shiptostate, 
		[ship-to post code] as shiptozip, 
		[order date] as orderdate, 
		[Shipment Method Code] as shipmethod, 
		[Phone No_] as phone, 
		[e-mail] as email, 
			Confnum = 
			CASE [Web Order No_]
				WHEN '' THEN 'NAV-'+h.No_
				ELSE [Web Order No_]
			END,
		(select cast(sum(quantity*[unit price]) as decimal(8,2))
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = h.No_) as total,
		(SELECT cast(sum(amount ) as decimal(8,2))
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
		where [Document No_] = h.No_ 
		and No_ in ('420', '100-SHIPPING')) as shipping,
		Tax =
		CASE [Tax Area Code]
		WHEN 'TN TAXABLE' THEN
		(select cast(sum([amount including VAT])-sum(amount) as decimal(8,2))
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					--where [Document No_] = the order
					where [Document No_] = h.No_)
		ELSE 0
		END
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Header] h
		where [shortcut dimension 2 code] = 'KATOM'
		and h.No_ not in (select confno COLLATE Latin1_General_CI_AS from ordconfxref)
		and [e-mail] like '%@%'
		and [no_ printed] > 0
		--and [web order no_] = ''
		and (SELECT COUNT(*)
					FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = h.No_
					and No_ not in ('', '420', '100-SHIPPING')) > 0
					and [No_ Series] <> 'S-QUO'
					and h.No_ not like '%-%'
		AND [e-mail] <> 'mccolunga@novanthealth.org'
		order by h.No_ desc

	OPEN OrderCursor

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @total, @shipping, @tax
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
			print @selltoname
			print @confnum
			SET @orderdate = CONVERT(varchar(11), @orderdate, 101)
			IF @orderdate like '%1753%' SET @orderdate = CONVERT(varchar(11), getdate(), 101)
			SET @ordertotal = cast(@total as decimal(8,2)) + cast(@shipping as decimal(8,2)) + cast(@tax as decimal(8,2))
			SET @email1 = @email
			SET @subject1 = 'KaTom.com Order #'+@confnum+' Confirmation'	
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
							"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
							<title>E-Mail</title>

							<style type="text/css">
							html{font-family:Lucida Grande;}
							</style>

							</head>
<body>

<table width="710" border="0" style="font-family:sans-serif;background-color:#fff;">
  <tr>
    <td colspan="3"><p style="color:#aaaaaa;font-size:12px;">
<!--Are you having difficulty viewing our HTML email? <a title="View this email in a browser window" href="http://www.katom.com/Merchant2/email_price_browser_window.php?a=$a">View this email in a browser window</a>-->
</p>
</td>
  </tr>
  <tr>
    <td colspan="3">
	<h1><a href="http://www.katom.com" title="KaTom Restaurant Supply"><img src="http://www.katom.com/Merchant2/images/KaTom_Seasonal_Logo_FNL_72dpi.jpg" 	width="200" height="75"	border="none" alt="KaTom Restaurant Supply Inc." title="KaTom Restaurant Supply Inc."/></a></h1>
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/Restaurant-equipment.html" title="Restauant-Equipment">Restaurant Equipment</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/countertop.html" title="Countertop">Countertop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/janitorial.html" title="Janitorial">Janitorial</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/kitchen-supplies.html" title="Kitchen Supplies">Kitchen Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/tabletop.html" title="Tabletop">Tabletop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/furniture.html" title="Furniture">Furniture</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/bar-supplies.html" title="Bar-Supplies">Bar Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #a91c20;font-weight:bold;text-decoration: none;" href="http://www.katom.com/clearance-sale.html"  title="clearance-sale">Clearance Sale</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #025eaa;font-weight:bold;text-decoration: none;" href="http://www.katom.com/residential.html"  title="Residential">Residential</a>

	
</td>
  </tr>
<tr>
	<td colspan="4">
    <table width="710" border="0" style="border-width: 1px;
	padding: 1px;
	border-style:solid;
	border-color: gray;">
          <tr>
			  <td width="10" colspan="1"></td>
              <td width="429" colspan="1">
                    <span style="font-family:Tahoma, Geneva, sans-serif; font-size:18px; color:#06C">Dear '+@selltoname+'</span>
              </td>
                <td width="349" colspan="2" align="right" valign="middle">
                    <img src="http://www.katom.com/images/mailericons/confirmation.png" alt="Confirmation" border="none" align="absmiddle" title="Order Confirmed"/>
              </td>
              <td>
              </td>
          </tr>
          <tr>
            <td width="10" colspan="1"></td>
          	<td colspan="3">
            <span style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;" >
              <p>Thank you for shopping at KaTom Restaurant Supply.              </p>
              <p>We have received your order.  Please allow 24 - 48 hours to have it processed.  We greatly appreciate your business and patience.  
                Please keep a copy for your Records.            </p>
              <p>If you have any questions, you can reach our Customer Appreciation Team through email at sales@katom.com, Live Chat with us, 
                or call us at 1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm.                </p>
              <p>Order Confirmation Number: <span style="font-size:12px; font-weight:bold;">'+@confnum+'</span><br />
                Sales Order Date: <span style="font-size:12px; font-weight:bold;">'+@orderdate+' </span></p>
			</span>
            </td>
            <td>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Contact Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td height="103" colspan="4" valign="top" align="left">
            <table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr>
				<td height="9px">
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td style="font-size:12px; font-weight:600">
				&nbsp;Billing Address:
				</td>
				<td style="font-size:12px; font-weight:600">
				Shipping Address:
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td>
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>&nbsp;'+@selltoname+'</td></tr>
				<tr><td>&nbsp;'+@selltoaddress+'</td></tr>
				<tr><td>&nbsp;'+@selltocity+', '+@selltostate+' '+@selltozip+'</td></tr>
				<tr><td>&nbsp;Primary Phone: '+@phone+'</td></tr>
				<tr><td>&nbsp;Email: '+@email+'</td></tr>
				</table>
				</td>
				<td valign="top">
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>'+@shiptoname+'</td></tr>
				<tr><td>'+@shiptoaddress+'</td></tr>
				<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
				</table>
				</td>
				</tr>
				</table>
            </td>
          </tr>
          
          <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
          	<td width="10" colspan="1"></td>
          	<td colspan="4">
				At KaTom Restaurant Supply, we believe Its About You.  Our dedicated team thrives to ensure that your shopping experience at KaTom.com should be awesome!<br /><br />
				Please <a href="mailto:sales@katom.com">let us know</a> if we can make your shopping experience any better!<br /><br />
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:800">
            	Contact The KaTom Customer Appreciation Team:<br />
            </td>
          </tr>
          <tr>
				<td width="10" colspan="1"></td>
                <td colspan="3">
                    <Table style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                        <tr>
                            <td style="font-weight:600">
                                Email:
                            </td>
                            <td>
                                sales@katom.com
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;
                                
                            </td>
                            <td>
                                Live Chat Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Phone
                            </td>
                            <td>
                                1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Website
                            </td>
                            <td>
                                http://www.katom.com
                        	</td>
                        </tr>
   		           </Table>
              </td>
          </tr>
		</table>
    </td>
</tr>
</table>
</body>
				</html>'

	
	PRINT @Navorder+'on '+@orderdate
	
	IF @body1 <> '' BEGIN Insert into ordconfxref (confno, orderdate, [type]) values (@Navorder, @orderdate, 'NAV') PRINT 'Confirmation Email sent-------' END

	IF @body1 <> '' EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @total, @shipping, @tax

	END

	CLOSE OrderCursor

	DEALLOCATE OrderCursor

END
GO
/****** Object:  StoredProcedure [dbo].[ConfirmationEmailer_OldNav]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[ConfirmationEmailer_OldNav] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


/*Begins the loop to pull down and parse payment information*/
	DECLARE @selltoname varchar(30)
	DECLARE @selltoaddress varchar(30)
	DECLARE @selltoaddress2 varchar(30)
	DECLARE @selltocity varchar(30)
	DECLARE @selltostate varchar(10)
	DECLARE @selltozip varchar(10)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoaddress varchar(30)
	DECLARE @shiptoaddress2 varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @orderdate varchar(255)
	DECLARE @shipmethod varchar(200)
	DECLARE @phone varchar(20)
	DECLARE @email varchar(50)
	DECLARE @confnum varchar(20)
	DECLARE @email1 varchar(500)
	DECLARE @Navorder varchar(500)
	DECLARE @order varchar(500)
	DECLARE @subject1 varchar(150)
	DECLARE @body1 varchar(MAX)
	
	DECLARE @prodcode varchar(50)
	DECLARE @prodqty varchar(50)
	DECLARE @prodimg varchar(100)
	DECLARE @prodname varchar(200)
	DECLARE @prodprice varchar(100)
	DECLARE @prodtotal varchar(100)
	DECLARE @total varchar(100)
	DECLARE @shipping varchar(100)
	DECLARE @tax varchar(100)
	DECLARE @ordertotal varchar(100)
/*
	DECLARE @email varchar(50)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)
	DECLARE @delivereddate varchar(255)
	DECLARE @shipdate varchar(255)
	DECLARE @delivered varchar(255)
	DECLARE @emailupdate bit
	DECLARE @trackingscan varchar(255)
*/

	DECLARE OrderCursor CURSOR FOR 
	
	select
		h.No_ as NavOrdNo, 
		[sell-to customer name] as selltoname, 
		[sell-to address] as selltoaddress, 
		[sell-to address 2] as selltoaddress2, 
		[sell-to city] as selltocity, 
		[sell-to state] as selltostate, 
		[sell-to zip code] as selltozip, 
		[ship-to name] as shiptoname, 
		[Ship-to Address] as shiptoaddress, 
		[Ship-to Address 2] as shiptoaddress2, 
		[Ship-to City] as shiptocity, 
		[ship-to state] as shiptostate, 
		[ship-to zip code] as shiptozip, 
		[order date] as orderdate, 
		[Shipment Method Code] as shipmethod, 
		[Phone No_] as phone, 
		[e-mail] as email, 
			Confnum = 
			CASE [Web Order No_]
				WHEN '' THEN 'NAV-'+h.No_
				ELSE [Web Order No_]
			END,
		(select cast(sum(quantity*[unit price]) as decimal(8,2))
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = h.No_) as total,
		(SELECT cast(sum(amount ) as decimal(8,2))
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
		where [Document No_] = h.No_ 
		and No_ in ('420', '100-SHIPPING')) as shipping,
		Tax =
		CASE [Tax Area Code]
		WHEN 'TN TAXABLE' THEN
		(select cast(sum([amount including tax])-sum(amount) as decimal(8,2))
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					--where [Document No_] = the order
					where [Document No_] = h.No_)
		ELSE 0
		END
		FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Header] h
		where [cust__Item Disc_ Gr_] = 'KATOM'
		and h.No_ not in (select confno COLLATE Latin1_General_CI_AS from ordconfxref)
		and [e-mail] like '%@%'
		and [no_ printed] > 0
		--and [web order no_] = ''
		and (SELECT COUNT(*)
					FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = h.No_
					and No_ not in ('', '420', '100-SHIPPING')) > 0
					and [No_ Series] <> 'S-QUO'
					and h.No_ not like '%-%'
		order by h.No_ desc

	OPEN OrderCursor

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @total, @shipping, @tax
	
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
			print @selltoname
			print @confnum
			SET @orderdate = CONVERT(varchar(11), @orderdate, 101)
			IF @orderdate like '%1753%' SET @orderdate = CONVERT(varchar(11), getdate(), 101)
			SET @ordertotal = cast(@total as decimal(8,2)) + cast(@shipping as decimal(8,2)) + cast(@tax as decimal(8,2))
			SET @email1 = @email
			SET @subject1 = 'KaTom.com Order #'+@confnum+' Confirmation'	
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
							"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
							<title>E-Mail</title>

							<style type="text/css">
							html{font-family:Lucida Grande;}
							</style>

							</head>
<body>

<table width="710" border="0" style="font-family:sans-serif;background-color:#fff;">
  <tr>
    <td colspan="3"><p style="color:#aaaaaa;font-size:12px;">
<!--Are you having difficulty viewing our HTML email? <a title="View this email in a browser window" href="http://www.katom.com/Merchant2/email_price_browser_window.php?a=$a">View this email in a browser window</a>-->
</p>
</td>
  </tr>
  <tr>
    <td colspan="3">
	<h1><a href="http://www.katom.com" title="KaTom Restaurant Supply"><img src="http://www.katom.com/Merchant2/images/KaTom_Seasonal_Logo_FNL_72dpi.jpg" 	width="200" height="75"	border="none" alt="KaTom Restaurant Supply Inc." title="KaTom Restaurant Supply Inc."/></a></h1>
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/Restaurant-equipment.html" title="Restauant-Equipment">Restaurant Equipment</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/countertop.html" title="Countertop">Countertop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/janitorial.html" title="Janitorial">Janitorial</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/kitchen-supplies.html" title="Kitchen Supplies">Kitchen Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/tabletop.html" title="Tabletop">Tabletop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/furniture.html" title="Furniture">Furniture</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/bar-supplies.html" title="Bar-Supplies">Bar Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #a91c20;font-weight:bold;text-decoration: none;" href="http://www.katom.com/clearance-sale.html"  title="clearance-sale">Clearance Sale</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #025eaa;font-weight:bold;text-decoration: none;" href="http://www.katom.com/residential.html"  title="Residential">Residential</a>

	
</td>
  </tr>
<tr>
	<td colspan="4">
    <table width="710" border="0" style="border-width: 1px;
	padding: 1px;
	border-style:solid;
	border-color: gray;">
          <tr>
			  <td width="10" colspan="1"></td>
              <td width="429" colspan="1">
                    <span style="font-family:Tahoma, Geneva, sans-serif; font-size:18px; color:#06C">Dear '+@selltoname+'</span>
              </td>
                <td width="349" colspan="2" align="right" valign="middle">
                    <img src="http://www.katom.com/images/mailericons/confirmation.png" alt="Confirmation" border="none" align="absmiddle" title="Order Confirmed"/>
              </td>
              <td>
              </td>
          </tr>
          <tr>
            <td width="10" colspan="1"></td>
          	<td colspan="3">
            <span style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;" >
              <p>Thank you for shopping at KaTom Restaurant Supply.              </p>
              <p>We have received your order.  Please allow 24 - 48 hours to have it processed.  We greatly appreciate your business and patience.  
                Please keep a copy for your Records.            </p>
              <p>If you have any questions, you can reach our Customer Appreciation Team through email at sales@katom.com, Live Chat with us, 
                or call us at 1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm.                </p>
              <p>Order Confirmation Number: <span style="font-size:12px; font-weight:bold;">'+@confnum+'</span><br />
                Sales Order Date: <span style="font-size:12px; font-weight:bold;">'+@orderdate+' </span></p>
			</span>
            </td>
            <td>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Contact Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td height="103" colspan="4" valign="top" align="left">
            <table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr>
				<td height="9px">
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td style="font-size:12px; font-weight:600">
				&nbsp;Billing Address:
				</td>
				<td style="font-size:12px; font-weight:600">
				Shipping Address:
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td>
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>&nbsp;'+@selltoname+'</td></tr>
				<tr><td>&nbsp;'+@selltoaddress+'</td></tr>
				<tr><td>&nbsp;'+@selltocity+', '+@selltostate+' '+@selltozip+'</td></tr>
				<tr><td>&nbsp;Primary Phone: '+@phone+'</td></tr>
				<tr><td>&nbsp;Email: '+@email+'</td></tr>
				</table>
				</td>
				<td valign="top">
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>'+@shiptoname+'</td></tr>
				<tr><td>'+@shiptoaddress+'</td></tr>
				<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
				</table>
				</td>
				</tr>
				</table>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
         	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Order Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
   	  <td colspan="4" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">
            	<p>&nbsp;Order Confirmation Number: '+@confnum+'<br />
                &nbsp;Order Date: '+@orderdate+'<br />
                <!--&nbsp;&nbsp;Shipping Preference:<br />
                &nbsp;&nbsp;Payment Method:<br />-->
                <br/>
                <br/>
           	  <table width="100%" cellpadding="0" cellspacing="0" >
               	  <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:14px; font-weight:600">
               		  <td width="10" colspan="1"></td>
                   	  <td colspan="2" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;" >
                		&nbsp;&nbsp;Product
                      </td>
                      <td width="67" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;">
                      <div align="center">Qty </div></td>
                      <td width="118" style="border-bottom:thin; border-bottom-color:#000; border-width: 1px;">
                      <div align="right">Price &nbsp;&nbsp;</div></td>
                  </tr>
                  <tr>
					<td>
						&nbsp;
					</td>
				  </tr>
                  <!-- Begin Loop for Products -->'
			DECLARE ItemCursor CURSOR FOR 
			
                  SELECT No_ as code, cast(quantity as decimal(8,0)) as quantity, 'http://www.katom.com/Merchant2/products/'+left(image,3)+'/'+replace(lower(image),'.jpg','')+'_th.jpg' as image, NAME, [unit price], cast(([unit price]*quantity)as decimal(8,2)) as prodtotal
					FROM fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					--where [Document No_] = the order
					where [Document No_] = @Navorder
					and No_ not in ('', '420', '100-SHIPPING')

            OPEN ItemCursor

				FETCH NEXT FROM ItemCursor INTO @prodcode, @prodqty, @prodimg, @prodname, @prodprice, @prodtotal
				
				
				WHILE @@FETCH_STATUS = 0
				BEGIN      
                
                SET @body1 = @body1+'<tr valign="top" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                  				<td width="10" colspan="1"></td>
                  				<td>&nbsp;<img src="'+@prodimg+'" width="100" /></td>
								<td><a href="http://www.katom.com/'+@prodcode+'.html">'+@prodname+'</a><br />
								<strong>Product Code: '+@prodcode+'</strong>
								</td>
								<td align="center">'+@prodqty+'</td>
								<td align="right">'+@prodtotal+'&nbsp;&nbsp;</td>
							</tr>'
                  
                 	FETCH NEXT FROM ItemCursor INTO @prodcode, @prodqty, @prodimg, @prodname, @prodprice, @prodtotal

				END

				CLOSE ItemCursor

				DEALLOCATE ItemCursor
              
    SET @body1 = @body1+'<!-- End Loop for Products -->
                  </table>
            </td>
          </tr>
          <tr>
			<td colspan="4" align="right" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">'
	IF @tax <> '0.00' SET @body1 = @body1+'Tax: '+@tax+'&nbsp;&nbsp;</br>'
	
	SET @body1 = @body1+'</td>
		  </tr>
		  <tr>
			<td colspan="4" align="right" style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:600">
				Shipping: Actual Shipping Will Be Determined At Processing &nbsp;&nbsp;</br>
			</td>
		  </tr>
		  <tr>
			<td width="10" colspan="1"></td>
         	<td colspan="4" bgcolor="#2E59CB" height="29" align="right">
            <span style="font-size:16px; color:#FFF; font-weight:bold">Preliminary Order Total: $'+(@ordertotal)+'&nbsp;&nbsp;</span>
            </td>
          </tr>
          <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
          	<td width="10" colspan="1"></td>
          	<td colspan="4">
				At KaTom Restaurant Supply, we believe Its About You.  Our dedicated team thrives to ensure that your shopping experience at KaTom.com should be awesome!<br /><br />
				Please <a href="mailto:sales@katom.com">let us know</a> if we can make your shopping experience any better!<br /><br />
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:800">
            	Contact The KaTom Customer Appreciation Team:<br />
            </td>
          </tr>
          <tr>
				<td width="10" colspan="1"></td>
                <td colspan="3">
                    <Table style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                        <tr>
                            <td style="font-weight:600">
                                Email:
                            </td>
                            <td>
                                sales@katom.com
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;
                                
                            </td>
                            <td>
                                Live Chat Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Phone
                            </td>
                            <td>
                                1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Website
                            </td>
                            <td>
                                http://www.katom.com
                        	</td>
                        </tr>
   		           </Table>
              </td>
          </tr>
		</table>
    </td>
</tr>
</table>
</body>
				</html>'

	
	PRINT @Navorder+'on '+@orderdate
	
	IF @body1 <> '' BEGIN Insert into ordconfxref (confno, orderdate, [type]) values (@Navorder, @orderdate, 'NAV') PRINT 'Confirmation Email sent-------' END

	IF @body1 <> '' EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

	
--select * from ordconfxref

	
	
	--print @order

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @total, @shipping, @tax

	END

	CLOSE OrderCursor

	DEALLOCATE OrderCursor

/*Reset
select * from shipxref where trackno = '053260560918289 '
delete from shipxref where id = 15628
*/

END
GO
/****** Object:  StoredProcedure [dbo].[ConfirmationEmailer]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ConfirmationEmailer] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


/*Begins the loop to pull down and parse payment information*/
	DECLARE @selltoname varchar(30)
	DECLARE @selltoaddress varchar(30)
	DECLARE @selltoaddress2 varchar(30)
	DECLARE @selltocity varchar(30)
	DECLARE @selltostate varchar(10)
	DECLARE @selltozip varchar(10)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoaddress varchar(30)
	DECLARE @shiptoaddress2 varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @orderdate varchar(255)
	DECLARE @shipmethod varchar(200)
	DECLARE @phone varchar(20)
	DECLARE @email varchar(50)
	DECLARE @confnum varchar(20)
	DECLARE @email1 varchar(500)
	DECLARE @Navorder varchar(500)
	DECLARE @order varchar(500)
	DECLARE @subject1 varchar(150)
	DECLARE @body1 varchar(MAX)
	DECLARE @prodcode varchar(50)
	DECLARE @prodqty varchar(50)
	DECLARE @prodimg varchar(100)
	DECLARE @prodname varchar(200)
	DECLARE @prodprice varchar(100)
	DECLARE @prodtotal varchar(100)
	DECLARE @total varchar(100)
	DECLARE @shipping varchar(100)
	DECLARE @tax varchar(100)
	DECLARE @ordertotal varchar(100)

	

	DECLARE OrderCursor CURSOR FOR 
	
	select
		h.No_ as NavOrdNo, 
		[sell-to customer name] as selltoname, 
		[sell-to address] as selltoaddress, 
		[sell-to address 2] as selltoaddress2, 
		[sell-to city] as selltocity, 
		[sell-to county] as selltostate, 
		[sell-to post code] as selltozip, 
		[ship-to name] as shiptoname, 
		[Ship-to Address] as shiptoaddress, 
		[Ship-to Address 2] as shiptoaddress2, 
		[Ship-to City] as shiptocity, 
		[ship-to county] as shiptostate, 
		[ship-to post code] as shiptozip, 
		[order date] as orderdate, 
		[Shipment Method Code] as shipmethod, 
		[Phone No_] as phone, 
		[e-mail] as email, 
			Confnum = 
			CASE [Web Order No_]
				WHEN '' THEN 'NAV-'+h.No_
				ELSE [Web Order No_]
			END, --Web Order Number or Navision Order Number for Reference
		(select cast(sum(quantity*[unit price]) as decimal(8,2))
			FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
			join products
			on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
			where [Document No_] = h.No_) as total, --Product Total
		(SELECT cast(sum(amount ) as decimal(8,2))
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
		where [Document No_] = h.No_ 
		and No_ in ('420', '100-SHIPPING')) as shipping, -- Shipping Amount (based on 420 and 100-Shipping Ledger Codes)
		Tax =
		CASE [Tax Area Code]
			WHEN 'TN TAXABLE' THEN
			(select cast(sum([amount including VAT])-sum(amount) as decimal(8,2))
			FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
						where [Document No_] = h.No_)
			ELSE 0
		END
		FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Header] h --Tax Amount or 0 if none
		where [shortcut dimension 2 code] = 'KATOM' -- Katom Customers Only
		and h.No_ not in (select confno COLLATE Latin1_General_CI_AS from ordconfxref) -- Eliminates confirmation redundancy
		and [e-mail] like '%@%'  -- Validates an actual Email Address
		and [no_ printed] > 0 -- Necessary?
		and [web order no_] = '' --Eliminates redundancy of web confirmation
		and (SELECT COUNT(*)
					FROM fs1.[katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Line]
					join products
					on No_ COLLATE SQL_Latin1_General_CP1_CI_AS = code COLLATE SQL_Latin1_General_CP1_CI_AS
					where [Document No_] = h.No_
					and No_ not in ('', '420', '100-SHIPPING')) > 0
					and [No_ Series] <> 'S-QUO'
					and h.No_ not like '%-%' --Validates that Products exist
		AND [e-mail] <> 'mccolunga@novanthealth.org' --Isolated Email Exclusion
		order by h.No_ desc

	OPEN OrderCursor

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @total, @shipping, @tax
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
			print @selltoname
			print @confnum
			SET @orderdate = CONVERT(varchar(11), @orderdate, 101)
			IF @orderdate like '%1753%' SET @orderdate = CONVERT(varchar(11), getdate(), 101)
			SET @ordertotal = cast(@total as decimal(8,2)) + cast(@shipping as decimal(8,2)) + cast(@tax as decimal(8,2))
			SET @email1 = @email
			SET @subject1 = 'KaTom.com Order #'+@confnum+' Confirmation'	
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
							"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
							<title>E-Mail</title>

							<style type="text/css">
							html{font-family:Lucida Grande;}
							</style>

							</head>
<body>

<table width="710" border="0" style="font-family:sans-serif;background-color:#fff;">
  <tr>
    <td colspan="3"><p style="color:#aaaaaa;font-size:12px;">
</p>
</td>
  </tr>
  <tr>
    <td colspan="3">
	<h1><a href="http://www.katom.com" title="KaTom Restaurant Supply"><img src="https://www.katom.com/bimages/katom.png" 	width="200" height="75"	border="none" alt="KaTom Restaurant Supply Inc." title="KaTom Restaurant Supply Inc."/></a></h1>
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/Restaurant-equipment.html" title="Restauant-Equipment">Restaurant Equipment</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/countertop.html" title="Countertop">Countertop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/janitorial.html" title="Janitorial">Janitorial</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/kitchen-supplies.html" title="Kitchen Supplies">Kitchen Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/tabletop.html" title="Tabletop">Tabletop</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/furniture.html" title="Furniture">Furniture</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: black;font-weight:bold;text-decoration: none;" href="http://www.katom.com/bar-supplies.html" title="Bar-Supplies">Bar Supplies</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #a91c20;font-weight:bold;text-decoration: none;" href="http://www.katom.com/clearance-sale.html"  title="clearance-sale">Clearance Sale</a>&nbsp;|&nbsp;
	<a style="font-size:10px;color: #025eaa;font-weight:bold;text-decoration: none;" href="http://www.katom.com/residential.html"  title="Residential">Residential</a>

	
</td>
  </tr>
<tr>
	<td colspan="4">
    <table width="710" border="0" style="border-width: 1px;
	padding: 1px;
	border-style:solid;
	border-color: gray;">
          <tr>
			  <td width="10" colspan="1"></td>
              <td width="429" colspan="1">
                    <span style="font-family:Tahoma, Geneva, sans-serif; font-size:18px; color:#06C">Dear '+@selltoname+'</span>
              </td>
                <td width="349" colspan="2" align="right" valign="middle">
                    <img src="http://www.katom.com/images/mailericons/confirmation.png" alt="Confirmation" border="none" align="absmiddle" title="Order Confirmed"/>
              </td>
              <td>
              </td>
          </tr>
          <tr>
            <td width="10" colspan="1"></td>
          	<td colspan="3">
            <span style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;" >
              <p>Thank you for shopping at KaTom Restaurant Supply.              </p>
              <p>We have received your order.  Please allow 24 - 48 hours to have it processed.  We greatly appreciate your business and patience.  
                Please keep a copy for your Records.            </p>
              <p>If you have any questions, you can reach our Customer Appreciation Team through email at sales@katom.com, Live Chat with us, 
                or call us at 1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm.                </p>
              <p>Order Confirmation Number: <span style="font-size:12px; font-weight:bold;">'+@confnum+'</span><br />
                Sales Order Date: <span style="font-size:12px; font-weight:bold;">'+@orderdate+' </span></p>
			</span>
            </td>
            <td>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td colspan="4" bgcolor="#2E59CB" height="29">
            <span style="font-size:16px; color:#FFF; font-weight:bold">&nbsp;Contact Information</span>
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td height="103" colspan="4" valign="top" align="left">
            <table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr>
				<td height="9px">
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td style="font-size:12px; font-weight:600">
				&nbsp;Billing Address:
				</td>
				<td style="font-size:12px; font-weight:600">
				Shipping Address:
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td>
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>&nbsp;'+@selltoname+'</td></tr>
				<tr><td>&nbsp;'+@selltoaddress+'</td></tr>
				<tr><td>&nbsp;'+@selltocity+', '+@selltostate+' '+@selltozip+'</td></tr>
				<tr><td>&nbsp;Primary Phone: '+@phone+'</td></tr>
				<tr><td>&nbsp;Email: '+@email+'</td></tr>
				</table>
				</td>
				<td valign="top">
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:12px">
				<tr><td>'+@shiptoname+'</td></tr>
				<tr><td>'+@shiptoaddress+'</td></tr>
				<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
				</table>
				</td>
				</tr>
				</table>
            </td>
          </tr>
          
          <tr style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
          	<td width="10" colspan="1"></td>
          	<td colspan="4">
				At KaTom Restaurant Supply, we believe Its About You.  Our dedicated team thrives to ensure that your shopping experience at KaTom.com should be awesome!<br /><br />
				Please <a href="mailto:sales@katom.com">let us know</a> if we can make your shopping experience any better!<br /><br />
            </td>
          </tr>
          <tr>
			<td width="10" colspan="1"></td>
          	<td style="font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:800">
            	Contact The KaTom Customer Appreciation Team:<br />
            </td>
          </tr>
          <tr>
				<td width="10" colspan="1"></td>
                <td colspan="3">
                    <Table style="font-family:Tahoma, Geneva, sans-serif; font-size:12px;">
                        <tr>
                            <td style="font-weight:600">
                                Email:
                            </td>
                            <td>
                                sales@katom.com
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;
                                
                            </td>
                            <td>
                                Live Chat Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Phone
                            </td>
                            <td>
                                1-800-541-8683 Monday - Friday, 8:00 am - 8:00 pm
                        	</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600">
                                Website
                            </td>
                            <td>
                                http://www.katom.com
                        	</td>
                        </tr>
   		           </Table>
              </td>
          </tr>
		</table>
    </td>
</tr>
</table>
</body>
				</html>'

	
	PRINT @Navorder+'on '+@orderdate
	
	IF @body1 <> '' BEGIN Insert into ordconfxref (confno, orderdate, [type]) values (@Navorder, @orderdate, 'NAV') PRINT 'Confirmation Email sent-------' END

	IF @body1 <> '' EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

	FETCH NEXT FROM OrderCursor INTO @Navorder, @selltoname, @selltoaddress, @selltoaddress2, @selltocity, @selltostate, @selltozip, @shiptoname, 
		@shiptoaddress, @shiptoaddress2, @shiptocity, @shiptostate, @shiptozip, @orderdate, @shipmethod, @phone, @email, @confnum, @total, @shipping, @tax

	END

	CLOSE OrderCursor

	DEALLOCATE OrderCursor

END
GO
/****** Object:  StoredProcedure [dbo].[clearanceUpdate]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Beau Dierman>
-- Create date: <1/13/2011>
-- Description:	<Update clearance items>
-- =============================================
CREATE PROCEDURE [dbo].[clearanceUpdate] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

INSERT OPENQUERY(MYSQL, 'select code,clearance,salesPrice  from katom_mm5.clearance_copy')
/****** Script for SelectTopNRows command from SSMS  ******/
SELECT [CODE]
      ,[clearance]
      ,[salesPrice]
  FROM [KatomDev].[dbo].[products] WHERE clearance = '1';
END
GO
/****** Object:  StoredProcedure [dbo].[CJProdFeed]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[CJProdFeed]
AS
	BEGIN
		TRUNCATE TABLE cjFeed

		INSERT INTO cjFeed
		SELECT
			dbo.cleaner(p.NAVDesc),
			dbo.cleaner(p.NAVDesc) [Keywords],
			/**
			CASE 
				WHEN LEN(ISNULL(CAST(p.prodDesc AS VARCHAR(MAX)), '')) = 0 THEN p.[Name]
				ELSE dbo.cleaner(p.prodDesc)
			END [DESCRIPTION],				
			**/
			dbo.cleaner(p.NAVDesc)[DESCRIPTION],
			p.code [SKU],
			'http://www.katom.com/' + p.CODE + '.html' [BUYURL],
			'YES' [AVAILABLE],
			-- 'http://www.katom.com/largeproducts/' + LEFT(p.CODE, 3) + '/' + [image] + '.jpg',
			NULL,
			CAST(p.price as decimal(10, 2))[PRICE],
			CAST(p.listprice as decimal(10, 2)) [RETAILPRICE],
			CASE c.superCat
				WHEN 'Shop By Vendor' THEN
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'Related Items' THEN
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'Go Green! Shop to Save Energy and Money.' THEN
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'Catering / Buffet' THEN
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'KaTom Kids' THEN
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'Special' THEN 
					CASE
						WHEN P.PRICE < 500 THEN 'KitchenSupplies'
						ELSE 'RestaurantEquipment'
					END
				WHEN 'Restaurant Equipment' THEN 'RestaurantEquipment'
				WHEN 'Bar Supplies' THEN 'BarSupplies'
				WHEN 'Kitchen Supplies' THEN 'KitchenSupplies'
				WHEN 'Pizza Equipment' THEN 'RestaurantEquipment'
				WHEN 'Clearance Sale' THEN 'CLEARANCESALE'
				ELSE ISNULL(c.superCat, 'RestaurantEquipment')
			END	[ADVERTISER CATEGORY],
			CASE p.freeShipping
				WHEN 1 THEN 'FREE SHIPPING'
				ELSE ''
			END [PROMOTIONAL TEXT],
			m.mfgName [MANUFACTURER],
			p.mpn [MANUFACTURERID],
			'NO' [SPECIAL], --yes/no value
			'New' [CONDITION],
			'' [AUTHOR] --use to indicate top seller
		FROM products p LEFT JOIN mfg m on p.mfgID = m.mfgID 
						LEFT JOIN categories c on p.primaryCatID = c.ID
		WHERE p.ACTIVE = 1
			and c.primaryCat = 1
			AND p.price > 0
		
		--MAP POLICY
		UPDATE g
		SET g.price = 		
				CASE
					WHEN ISNULL(p.map, 0) = 1 THEN 
						CASE 
							WHEN ISNULL(p.feedMap, 0) = 1 THEN 
								CASE
									WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN cast(p.price as decimal(10, 2))
									ELSE CAST(p.map_price AS DECIMAL(10, 2))
								END
							ELSE cast(p.price as decimal(10, 2))
						END
					--WHEN ISNULL(P.clearance, 0) = 1 THEN cast(p.salesPrice as decimal(10, 2))
					ELSE cast(p.price as decimal(10, 2))
				END, 
				[SPECIAL] = 'YES'
		FROM cjFeed g join products p on g.sku = p.code
			
		--SET CLEARANCE ITEMS TO BE SPECIAL ITEMS	
		UPDATE cj
		SET [SPECIAL] = 'YES'
		FROM cjFeed cj JOIN products p ON cj.sku = p.code
					   JOIN categories c ON c.id = p.primaryCatID
		WHERE p.active = 1 AND c.ACTIVE = 1
			AND c.supercat = 'Clearance Sale'
			AND [SPECIAL] = 'NO'
			
		TRUNCATE TABLE cjTopSeller
		INSERT INTO cjTopSeller
		SELECT top 500 l.[No_], COUNT(DISTINCT h.[No_]), SUM(l.[Amount])
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h ON l.[Document No_] = h.[No_]
		WHERE DATEDIFF(day, h.[Order Date], GeTDATE()) < 91 AND LEN(l.[No_]) > 0 AND ISNUMERIC(l.[No_]) = 0
					and	l.[No_] not like '100-%'
		group by l.[No_]
		order by COUNT(DISTINCT h.[No_]) DESC

		UPDATE cjFeed
		SET author = 'TOP SELLER'
		WHERE SKU IN (SELECT code FROM cjTopSeller)

		TRUNCATE TABLE cjTopSeller
		INSERT INTO cjTopSeller
		SELECT top 500 l.[No_], COUNT(DISTINCT h.[No_]), SUM(l.[Amount])
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h ON l.[Document No_] = h.[No_]
		WHERE DATEDIFF(day, h.[Order Date], GeTDATE()) < 91 AND LEN(l.[No_]) > 0 AND ISNUMERIC(l.[No_]) = 0
					and	l.[No_] not like '100-%'
		group by l.[No_]
		order by SUM(l.[Amount]) DESC

		UPDATE cjFeed
		SET author = 'TOP SELLER'
		WHERE SKU IN (SELECT code FROM cjTopSeller)
		
		delete from cjFeed where price is null
				
		SELECT * FROM cjFeed
	END
GO
/****** Object:  StoredProcedure [dbo].[category_catxprod_supplement_email]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[category_catxprod_supplement_email]
AS
BEGIN
	DECLARE @catCode VARCHAR(100), @prodCode VARCHAR(100), @primarycat VARCHAR(100), 
		    @action VARCHAR(100), @bgcolor VARCHAR(100), @counter TINYINT
	
	DECLARE @body1 VARCHAR(MAX), @email1 VARCHAR(500), @subject1 VARCHAR(150)
			
	SET @counter = 1
	SET @bgcolor = '#bed6e9'

	--INITIATING DATE
	--INITIATE TABLE
	SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>PRODUCT CATEGORIZATION ERROR REPORT</title>

	<style type="text/css">
	body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
	</style>

	</head>
	<body>
	<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">
	  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
		<td style="width: 100px;">catname</td>
		<td style="width: 100px;">CATEGORY</td>
		<td style="width: 100px;">PRODUCT</td>
		<td style="width: 100px;">PRIMARY CAT</td>
		<td style="width: 250px;">STATUS</td>
	  </tr>'
	  
	DECLARE sCursor CURSOR FOR 
	SELECT catCode, prodCode, [primarycat], 
		CASE [action]
			WHEN 'P' THEN 'DID NOT IMPORTED: PRODUCT NOT ACTIVE ONLINE'
			WHEN 'C' THEN 'DID NOT IMPORTED: CATEGORY NOT ACTIVE ONLINE'
			WHEN 'D' THEN 'DID NOT IMPORTED: PRODUCT IS ALREADY ASSIGNED TO THE CATEGORY'
			WHEN 'X' THEN 'IMPORTED: PRIMARY CAT ALREADY EXIST.  CATEGORIZATION REASSIGNED TO SECONDARY'
		END [action]
	FROM catxprodTemp 	
	WHERE [action] <> 'I'
	ORDER BY [action], prodCode

	OPEN sCursor
	FETCH NEXT FROM sCursor INTO @catCode, @prodCode, @primarycat,  @action

	WHILE @@FETCH_STATUS = 0
	   BEGIN				
		IF @counter = 1
		   BEGIN
			SET @counter = 2
			SET @bgcolor = '#FFFFFF'
		   END
		ELSE
		   BEGIN
			SET @counter = 1
			SET @bgcolor = '#bed6e9'
		   END
		
		SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
		<td>' + @catCode + '</td>
		<td>' + @prodCode + '</td>
		<td>' + @primarycat + '</td>
		<td>' + @action + '</td>
	  </tr>'
				
		FETCH NEXT FROM sCursor INTO @catCode, @prodCode, @primarycat,  @action
	   END

	CLOSE sCursor
	DEALLOCATE sCursor
		
	SET @body1 = @body1 + '</table></body>
	</html>'
	
	-- PREPPING THE EMAIL TO SEND
	SET @email1 = 'groberts@katom.com'
--	SET @email1 = 'david@katom.com'
	SET @subject1 = 'PRODUCT CATEGORIZATION ERROR REPORT'

	EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	

END
GO
/****** Object:  StoredProcedure [dbo].[check_ups_autoload_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Michael Shell
-- Create date: Jan 24, 2013
-- Description:	This job will check for 0 records inserted from UPS Autoload, indicating that Dev 1 Autoload process shouldb e restarted
-- =============================================
CREATE PROCEDURE [dbo].[check_ups_autoload_SP]
AS

DECLARE @records varchar(10)
DECLARE @body1 varchar(255)

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SET @records = (SELECT COUNT(*) from upsFile)
	SET @body1 = @records + ' records are in the upsfile table'
		
	IF @records = 0 BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients='itsupport@katom.com',	@subject='UPS File Import Count',	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Email Sent' END
END
GO
/****** Object:  StoredProcedure [dbo].[check_pricing_variance]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[check_pricing_variance]
AS
BEGIN	
	drop table ProductsMIVA
	select * into ProductsMIVA from openquery(MYSQL, 'select * from katom_mm5.s01_Products')

	truncate table prodTemp

	insert into prodTemp([No_], [UnitPrice])
	select code, PRICE
	from ProductsMIVA 
	where active = 1

	delete from prodTemp
	where [No_] in
	(
	select code
	from prodTemp t join products p on t.[No_] = p.CODE
	where CAST([UnitPrice] as decimal(10, 2)) = CAST(p.price as decimal(10, 2))
	)

	delete from prodTemp
	where [No_] in
	(
	select code
	from prodTemp t join products p on t.[No_] = p.CODE
	where clearance = 1 and active = 1
	)
	
	IF exists(select [No_] from prodTemp t join products p on t.[No_] = p.CODE
										   left join trueSuperTrailer s on s.code = p.CODE
										   join CAFeed c on p.CODE = c.Model)
	   BEGIN	
		DECLARE @No VARCHAR(100), @mivaPrice money, @katomPrice money, @bbPrice money, @MAP bit, @mapProgram varchar(10), 
				@sellingPrice money
			
		DECLARE @body1 VARCHAR(MAX), @email1 varchar(500), @subject1 varchar(150), @bgcolor VARCHAR(500), @counter int
		
		SET @counter = 1	
		
		--INITIATE TABLE
		SET @body1 = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		<html xmlns="http://www.w3.org/1999/xhtml">
		<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Backorder Item</title>

		<style type="text/css">
		body,td,th {font-family: Arial, Helvetica, sans-serif;font-size: 10px; vertical-align: top; }
		</style>

		</head>
		<body>
		<table border="0" cellspacing="0" cellpadding="3" style="border:solid 1px #000000;">	
		  <tr style="background-color:#446fb7; color:#FFFFFF; font-weight: bold;">
			<td style="text-align:center; width: 100px;">Product Code</td>
			<td style="text-align:center; width: 100px;">MIVA KaTom Price</td>
			<td style="text-align:center; width: 100px;">NAV KaTom Price</td>
			<td style="text-align:center; width: 100px;">NAV BB Price</td>
			<td style="text-align:center; width: 100px;">MAP Item</td>
			<td style="text-align:center; width: 100px;">MAP Program</td>
			<td style="text-align:center; width: 100px;">Selling Price<BR />TrueSuperTrailer</td>
		  </tr>'	

		DECLARE pCursor CURSOR FOR 
		select [No_], [UnitPrice] mivaPrice, p.price, p.BBPrice, p.MAP, p.MAP_Program, s.sellingPrice PriceInTrueSuperTrailer
		from prodTemp t join products p on t.[No_] = p.CODE
						left join trueSuperTrailer s on s.code = p.CODE
						join CAFeed c on p.CODE = c.Model
		order by 1
		
		OPEN pCursor
		FETCH NEXT FROM pCursor INTO @No, @mivaPrice, @katomPrice, @bbPrice, @MAP, @mapProgram, @sellingPrice

		WHILE @@FETCH_STATUS = 0
		   BEGIN		
			IF @counter = 1
			   BEGIN
				SET @counter = 2
				SET @bgcolor = '#FFFFFF'
			   END
			ELSE
			   BEGIN
				SET @counter = 1
				SET @bgcolor = '#bed6e9'
			   END
			
			SET @body1 = @body1 + ' <tr style="background-color:' + @bgcolor + ';">
			<td>' + @No + '</td>
			<td align="center" >' + CAST(ISNULL(@mivaPrice, '-1') AS VARCHAR(100))  + '</td>
			<td align="center" >' + CAST(ISNULL(@katomPrice, '-1') AS VARCHAR(100)) + '</td>
			<td align="center" >' + CAST(ISNULL(@bbPrice, '-1') AS VARCHAR(100)) + '</td>
			<td align="center" >' + CAST(ISNULL(@MAP, '') AS VARCHAR(100)) + '</td>
			<td align="center" >' + ISNULL(@mapProgram, '') + '</td>
			<td align="center" >' + CAST(ISNULL(@sellingPrice, '') AS VARCHAR(11)) + '</td>
		  </tr>'		
			
			FETCH NEXT FROM pCursor INTO @No, @mivaPrice, @katomPrice, @bbPrice, @MAP, @mapProgram, @sellingPrice
		   END
		   
		SET @body1 = @body1 + '</table>'
		
		CLOSE pCursor
		DEALLOCATE pCursor
		
		
		-- PREPPING THE EMAIL TO SEND
		SET @email1 = 'mike@katom.com; david@katom.com; paula@katom.com; beau@katom.com'
	--	SET @email1 = 'david@katom.com'
		SET @subject1 = 'Out of Synch Pricing'

		EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	
	   END	
END
GO
/****** Object:  StoredProcedure [dbo].[channelAdvisorFeed_SP2]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- Modified: 4-14-2011 by Mike S., Removed references to Merchant2 per Beau D.


CREATE PROCEDURE [dbo].[channelAdvisorFeed_SP2]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('CA_FEED', GETDATE())
	SET @jobID = @@identity

	TRUNCATE TABLE CAFeed

	INSERT INTO CAFeed
	SELECT 
		'http://www.katom.com/' + ltrim(rtrim(code)) + '.html', NULL, NULL, NULL, NULL, NULL, ltrim(rtrim(code)), '1', NULL, NULL, 
		NULL, NULL, NULL, NULL, 0, NULL, NULL, NULL, NULL, 'http://www.katom.com/pdfspecs/' + code + '.pdf', 
		NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, [id], NULL, 0, 1, 1, 0, NULL, 1, 1, 1, 1, 1
	FROM productsmiva
	WHERE active = 1
	ORDER BY code 

	UPDATE ca
	SET ca.[OfferName] = ISNULL(m.mfgName, '') + ' ' + p.mpn + ' - ' + p.[Name],
		ca.[OfferDescription] = cast(dbo.cleaner(p.[prodDesc]) as varchar(max)) + ' ( ' + isnull(m.mfgName, '') + ' - ' + p.mpn  + ' )',
		ca.[ReferenceImageURL] = 'http://www.katom.com/products/' + p.mfgid + '/' + LOWER(p.image) + '.jpg',		
		ca.[RegularPrice] = cast(p.listprice as decimal(10, 2)),
		ca.[CurrentPrice] = 
				CASE
					WHEN ISNULL(p.map, 0) = 1 THEN 
						CASE 
							WHEN ISNULL(p.feedMap, 0) = 1 THEN 
								CASE
									WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN cast(p.price as decimal(10, 2))
									ELSE CAST(p.map_price AS DECIMAL(10, 2))
								END
							ELSE cast(p.price as decimal(10, 2))
						END
					WHEN ISNULL(P.clearance, 0) = 1 THEN cast(p.salesPrice as decimal(10, 2))
					ELSE cast(p.price as decimal(10, 2))
				END,
		ca.[Brand] = ISNULL(m.mfgName, ''),
		ca.[MerchantCategory] = c.[Name],
		ca.[Manufacturer] = m.mfgName,
		ca.[ManufacturerModel] = p.mpn,
		ca.[PromotionalText] = 
			CASE isnull(p.freeShipping, 0)
				WHEN '1' THEN 'Free Shipping! Call 1-800-541-8683 for great customer service!'
				WHEN 'T' THEN 'Free Shipping! Call 1-800-541-8683 for great customer service!'
				ELSE 'Call 1-800-541-8683 for great customer service!'
			END,
		ca.[Weight] = 
			CASE 
				WHEN  p.freightOnly = 0 AND (p.prodL*p.prodH*p.prodW)/166 > p.[Weight] THEN CAST((prodL*prodH*prodW)/166 AS DECIMAL(10, 2))+5
				ELSE cast(p.weight as decimal(10, 2))
			END,
		ca.[Keywords] = p.keywords,
		ca.[Custom1] = p.prodH,
		ca.[Custom2] = p.prodL,
		ca.[Custom3] = p.prodW,
		ca.[productCost] = cast(p.cost as decimal(10, 2)),
		ca.[Custom6] = p.freeshipping,
		ca.[Custom7] = p.[Name],
		ca.[Custom11] =
		CASE
			WHEN CHARINDEX('.jpg', LOWER(p.image)) > 0 THEN 'http://www.katom.com/largeproducts/' + p.mfgid + '/' + LOWER(p.image)
			ELSE 'http://www.katom.com/largeproducts/' + p.mfgid + '/' + LOWER(p.image) + '.jpg'
		END,
		ca.profitData = 
			CASE 
				WHEN p.mfgID = '598' THEN CAST((p.price-.8*p.true_cost)*p.sales30 AS DECIMAL(10, 2))
				ELSE CAST((p.price-p.true_cost)*p.sales30 AS DECIMAL(10, 2))
			END,
		ca.[lastProcessed] = GETDATE()
	FROM CAFeed ca JOIN products p ON ca.[Model] = p.code
				   LEFT JOIN Mivacategories c ON p.primaryCatID = c.id
				   LEFT JOIN mfg m ON p.mfgid = m.mfgid
	
	--POPULATING [MerchantCategory] WITH CUSTOM FIELD VALUE
	UPDATE c
	SET c.[MerchantCategory] = f.value,
		c.[custom12] = f.value
	FROM CAFeed c JOIN MIVAProdFieldsValue f ON c.prodID = f.product_ID
	WHERE f.field_ID = 31 --Category

	UPDATE c
	SET c.[custom5] = f.value
	FROM CAFeed c JOIN MIVAProdFieldsValue f ON c.prodID = f.product_ID
	where field_id = 1515 --Residential

	UPDATE c
	SET c.[custom10] = f.value
	FROM CAFeed c JOIN MIVAProdFieldsValue f ON c.prodID = f.product_ID
	WHERE field_id = 152 --Type

	UPDATE c
	SET c.[custom10] = f.value
	FROM CAFeed c JOIN MIVAProdFieldsValue f ON c.prodID = f.product_ID
	WHERE field_id = 34 --Color

	--IMAGES EXTENSION CLEANING
	UPDATE cafeed
	SET ReferenceImageURL = replace(ReferenceImageURL, '.jpg.jpg', '.jpg')
	WHERE ReferenceImageURL like '%.jpg.jpg%' 

	UPDATE cafeed
	SET ReferenceImageURL = replace(custom11, '.jpg.jpg', '.jpg')
	WHERE custom11 like '%.jpg.jpg%' 
	
	--SETTING NEW LISTPRICE IF LISTPRICE < PRICE
	UPDATE cafeed
	SET [RegularPrice] = CAST(2*[CurrentPrice] AS DECIMAL(10, 2))
	WHERE CAST([RegularPrice] AS DECIMAL(10, 2)) < CAST([CurrentPrice] AS DECIMAL(10, 2))

	--TAKING CARE OF DUPLICATE MPN
	DECLARE @MPN varchar(100), @mfgID varchar(100), @tmp varchar(100), @code varchar(100)
	
	DECLARE mCursor CURSOR FOR 
	select Left(Model, 3), ManufacturerModel
	from cafeed
	group by Left(Model, 3), ManufacturerModel 
	having count(*) > 1

	OPEN mCursor
	FETCH NEXT FROM mCursor INTO @mfgID, @MPN

	WHILE @@FETCH_STATUS = 0
	   BEGIN
			DECLARE pCursor CURSOR FOR 
			select Model
			from cafeed
			Where Left(Model, 3) = @mfgID and ManufacturerModel = @MPN

			OPEN pCursor
			FETCH NEXT FROM pCursor INTO @code

			WHILE @@FETCH_STATUS = 0
			   BEGIN
				SET @tmp = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@MPN, ')', ''), '(', ''), '-', ''), ' ', ''), '/', ''), '.', '')
				
				UPDATE cafeed
				SET ManufacturerModel = @MPN + ' ' + REPLACE(RIGHT(@CODE, LEN(@CODE)-4), @TMP, '')
				WHERE MODEL = @CODE
	
				SET @tmp = ''
				FETCH NEXT FROM pCursor INTO @code
			   END

			CLOSE pCursor
			DEALLOCATE pCursor		


		FETCH NEXT FROM mCursor INTO @mfgID, @MPN
	   END

	CLOSE mCursor
	DEALLOCATE mCursor
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')
	WHERE CHARINDEX('', [OfferDescription]) > 0

	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '  ', '')	
	WHERE CHARINDEX('  ', [OfferDescription]) > 0
		
	delete from cafeed where LEN(ISNULL(offername, '')) = 0
	
	delete from CAFeed where Model LIKE '%599-%'
	
	--REMOVE ALL ITEMS THAT ARE BACKORDERS
	UPDATE CAFeed
	SET listproduct = 0
	WHERE Model IN (select [No_] COLLATE Latin1_General_CS_AS from backOrder_item where DATEDIFF(day, [OldestOrderdt], getdate()) > 15 and price < 250)

	--USE ANALYTICS TO MANAGE
	--UPDATE CAFeed
	--SET apex = 1
	--WHERE Model in 
	--	(			
	--	SELECT p.code
	--	FROM categories c JOIN products p ON c.CODE = p.primaryCatCode
	--	WHERE (c.superCat IN ('Residential', 'Janitorial')
	--			AND c.ACTIVE = 1 and p.active = 1
	--			AND price < 500)
	--			OR price < 250				
	--	 )
		
	--MARK AN ITEMT O BE LISTED AT PRICE + .01 FOR AMAZON ONLY
	UPDATE CAFeed
	SET amazon = 0 
	where model in (select code from products where active = 1 and isnull(feedMAP, 0) = 1 and isnull(MAP_Program, 'K') = 'E' and MAP = 1)
	
	UPDATE c
	SET c.map_price = CAST(p.map_price AS DECIMAL(10, 2))
	FROM products p JOIN cafeed c ON p.CODE = c.Model
	WHERE active = 1 
		AND ISNULL(MAP, 0) = 1
		AND ISNULL(map_program, '') = 'A'
		AND ISNULL(feedMAP, 0) = 0

	--REMOVING PRODUCTS THAT WE HAVENT SOLD IN THE LAST 24 MONTH
	UPDATE CAFeed
	SET listproduct = 0
	WHERE Model IN (SELECT CODE 
					FROM products 
					WHERE sales_last_24MO = 0 
						AND DATEDIFF(MONTH, addedDT, GETDATE()) > 11
					)
	--REMOVING PRODUCTS FROM CSE IF WE ARE SPENDING MORE THAN WE ARE MAKING MONEY
	TRUNCATE TABLE cseclick
	
	INSERT INTO cseclick (SKU, CHANNEL_NAME, CLICKS, CLICK_COST, QTY_SOLD)
	select sku, dbo.[returnCSEName]([channel_Name]),
		sum(CAST(clicks AS INT)), 
		sum(CAST(click_cost AS DECIMAL(10, 2))), 
		SUM(CAST(qty_sold AS INT))
	from cseClick_worktable
	group by sku, dbo.[returnCSEName]([channel_Name])
	
	UPDATE c
	SET c.profit = 
		CASE 
			WHEN p.price < 250 THEN c.qty_sold*(p.price - p.cost)
			ELSE p.sales30*(p.price - p.cost)
		END, 
		c.price = p.price
	FROM cseclick c JOIN products p ON c.sku = p.CODE

	--DISABLING PRODUCTS FROM NEXTAG
	UPDATE c
	SET c.nextag = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.clicks > 24 
		AND cc.profit < cc.click_cost
		AND cc.Channel_Name LIKE '%NexTag%'

	--DISABLING PRODUCTS FROM AMAZON
	UPDATE c
	SET c.amazon = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.clicks > 24 
		AND cc.profit < cc.click_cost
		AND cc.Channel_Name LIKE '%Amazon%'

	--DISABLING PRODUCTS FROM SHOPZILLA
	UPDATE c
	SET c.shopzilla = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.clicks > 24 
		AND cc.profit < cc.click_cost	
--		AND (cc.profit-cc.click_cost)+(c.CurrentPrice-c.productCost) < 0
		AND cc.Channel_Name LIKE '%Shopzilla%'

	--DISABLING PRODUCTS FROM PRICEGRABBER
	UPDATE c
	SET c.pricegrabber = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.clicks > 24 
		AND cc.profit < cc.click_cost
		AND cc.Channel_Name LIKE '%PriceGrabber%'
		
	--DISABLING PRODUCTS FROM SHOPPING.COM
	UPDATE c
	SET c.shopping = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.clicks > 24 
		AND cc.profit < cc.click_cost
		AND cc.Channel_Name LIKE '%Shopping%'
		
	--DISABLING PRODUCTS FROM BECOME.COM
	UPDATE c
	SET c.become = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.clicks > 24 
		AND cc.profit < cc.click_cost
		AND cc.Channel_Name LIKE '%Become%'
	
	--TEMPORARY REMOVAL OF 449-KPEX
	UPDATE c
	SET c.become = 0, c.shopping = 0, c.pricegrabber = 0, c.shopzilla = 0, c.amazon = 0, c.nextag = 0 
	FROM CAFeed c JOIN products p ON c.Model = p.CODE
	WHERE p.qtyOnHand < 1 and p.CODE = '449-KPEX'
	
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[channelAdvisorFeed_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[channelAdvisorFeed_SP]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('CA_FEED', GETDATE())
	SET @jobID = @@identity

	TRUNCATE TABLE CAFeed

	INSERT INTO CAFeed
	SELECT 'http://www.katom.com/' + ltrim(rtrim(p.CODE)) + '.html' [ActionURL], ISNULL(p.mfgName, '') + ' ' + p.mpn + ' - ' + dbo.cleaner(p.[Name]),
		cast(dbo.cleaner(p.[prodDesc]) as varchar(max)) + ' ( ' + isnull(p.mfgName, '') + ' - ' + p.mpn  + ' )',
		'http://' + p.mfgid + '.katomcdn.com/' + LOWER(p.image) + '_large.jpg', 
		cast(p.listprice as decimal(10, 2)),
		CASE
			WHEN ISNULL(p.map, 0) = 1 THEN 
				CASE 
					WHEN ISNULL(p.feedMap, 0) = 1 THEN 
						CASE
							WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN cast(p.price as decimal(10, 2))
							ELSE CAST(p.map_price AS DECIMAL(10, 2))
						END
					ELSE cast(p.price as decimal(10, 2))
				END
			WHEN ISNULL(P.clearance, 0) = 1 THEN cast(p.salesPrice as decimal(10, 2))
			ELSE cast(p.price as decimal(10, 2))
		END, ltrim(rtrim(p.code)), '1', ISNULL(p.mfgName, ''), NULL [MerchantCategory], p.mfgName, p.mpn,
		CASE isnull(p.freeShipping, 0)
			WHEN 1 THEN 'Free Shipping! Call 1-800-541-8683 for great customer service!'
			ELSE 'Call 1-800-541-8683 for great customer service!'
		END,
		CASE 
			WHEN  p.freightOnly = 0 AND (p.prodL*p.prodH*p.prodW)/166 > p.[Weight] THEN CAST((prodL*prodH*prodW)/166 AS DECIMAL(10, 2))+5
			ELSE cast(p.weight as decimal(10, 2))
		END, 0, p.keywords, p.prodH, p.prodL, p.prodW, 'http://www.katom.com/pdfspecs/' + p.code + '.pdf', NULL [custom5],
		cast(p.cost as decimal(10, 2)), p.freeshipping, p.[Name], NULL [custom8], NULL [custom9], NULL [custom10],
		CASE
			WHEN CHARINDEX('.jpg', LOWER(p.image)) > 0 THEN 'http://www.katom.com/largeproducts/' + p.mfgid + '/' + LOWER(p.image)
			ELSE 'http://www.katom.com/largeproducts/' + p.mfgid + '/' + LOWER(p.image) + '.jpg'
		END, NULL [custom12], prodID, GETDATE(), 0, 1, 1, 
		CASE 
			WHEN p.mfgID = '598' THEN CAST((p.price-.8*p.true_cost)*p.sales30 AS DECIMAL(10, 2))
			ELSE CAST((p.price-p.true_cost)*p.sales30 AS DECIMAL(10, 2))
		END, NULL [profitData], 1, 1, 1, 1, 1, NULL, NULL, NULL, NULL, NULL
	FROM products p
	WHERE p.active = 1 AND ISNULL(p.price, 0) > 0  AND p.isWeb = 1
	ORDER BY p.code 

	--POPULATING THE MERCHANTCATEGORY WITH THE REFINABLE CATEGORY IF IT EXISTS ELSE WITH THE PRIMARY CAT INFO
	UPDATE c
	SET c.MerchantCategory = 
			CASE 
				WHEN LEN(ISNULL(i.[Refinable Value], '')) > 0 THEN i.[Refinable Value]
				ELSE c2.catName
			END,
		c.[custom12] = i.[Refinable Value]
	FROM CAFeed c join products p on c.Model = p.CODE
				left join categories c2 on p.primaryCatCode = c2.code and c2.primarycat = 1
				LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] i on i.[Item No_] = c.Model COLLATE SQL_Latin1_General_CP1_CI_AS AND i.[Refinable No_] = 'CATEGORY'
			
	--MARK AN ITEM TO BE RESIDENTIAL BASED ON THE REFINABLE VALUE OF NAV (NOT USE ANYMORE - DATA IS JUNK)
	UPDATE c
	SET c.[custom5] = i.[Refinable Value]
	FROM CAFeed c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] i on i.[Item No_] = c.Model COLLATE SQL_Latin1_General_CP1_CI_AS AND i.[Refinable No_] = 'RESIDENTIAL'

	--POPULATE CUSTOM10 WITH THE TYPE VALUE FROM NAVISION REFINABLE
	UPDATE c
	SET c.[custom10] = i.[Refinable Value]
	FROM CAFeed c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] i on i.[Item No_] = c.Model COLLATE SQL_Latin1_General_CP1_CI_AS AND i.[Refinable No_] = 'TYPE'

	UPDATE c
	SET c.[custom10] = i.[Refinable Value]
	FROM CAFeed c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] i on i.[Item No_] = c.Model COLLATE SQL_Latin1_General_CP1_CI_AS AND i.[Refinable No_] = 'COLOR'
	WHERE c.[custom10] IS NULL
		
	--SETTING NEW LISTPRICE IF LISTPRICE < PRICE
	UPDATE cafeed
	SET [RegularPrice] = CAST(2*[CurrentPrice] AS DECIMAL(10, 2))
	WHERE CAST([RegularPrice] AS DECIMAL(10, 2)) < CAST([CurrentPrice] AS DECIMAL(10, 2))

	--TAKING CARE OF DUPLICATE MPN
	DECLARE @MPN varchar(100), @mfgID varchar(100), @tmp varchar(100), @code varchar(100)
	
	DECLARE mCursor CURSOR FOR 
	select Left(Model, 3), ManufacturerModel
	from cafeed
	group by Left(Model, 3), ManufacturerModel 
	having count(*) > 1

	OPEN mCursor
	FETCH NEXT FROM mCursor INTO @mfgID, @MPN

	WHILE @@FETCH_STATUS = 0
	   BEGIN
			DECLARE pCursor CURSOR FOR 
			select Model
			from cafeed
			Where Left(Model, 3) = @mfgID and ManufacturerModel = @MPN

			OPEN pCursor
			FETCH NEXT FROM pCursor INTO @code

			WHILE @@FETCH_STATUS = 0
			   BEGIN
				SET @tmp = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@MPN, ')', ''), '(', ''), '-', ''), ' ', ''), '/', ''), '.', '')
				
				UPDATE cafeed
				SET ManufacturerModel = @MPN + ' ' + REPLACE(RIGHT(@CODE, LEN(@CODE)-4), @TMP, '')
				WHERE MODEL = @CODE
	
				SET @tmp = ''
				FETCH NEXT FROM pCursor INTO @code
			   END

			CLOSE pCursor
			DEALLOCATE pCursor	

		FETCH NEXT FROM mCursor INTO @mfgID, @MPN
	   END

	CLOSE mCursor
	DEALLOCATE mCursor
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')
	WHERE CHARINDEX('', [OfferDescription]) > 0

	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '', '')	
	WHERE CHARINDEX('', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [OfferDescription] = REPLACE([OfferDescription], '  ', '')	
	WHERE CHARINDEX('  ', [OfferDescription]) > 0
	
	UPDATE cafeed
	SET [custom7] = REPLACE([custom7], char(10), '')	
	WHERE CHARINDEX(char(10), [custom7]) > 0
		
	UPDATE cafeed
	SET [custom7] = REPLACE([custom7], char(13), '')	
	WHERE CHARINDEX(char(10), [custom3]) > 0	
	
	delete from cafeed where LEN(ISNULL(offername, '')) = 0
	
	delete from CAFeed where Model LIKE '%599-%'
	
	--REMOVE ALL ITEMS THAT ARE BACKORDERS
	UPDATE CAFeed
	SET listproduct = 0
	WHERE Model IN (select [No_] COLLATE Latin1_General_CS_AS from backOrder_item where DATEDIFF(day, [OldestOrderdt], getdate()) > 15 and price < 250)

	--USE ANALYTICS TO MANAGE
	--UPDATE CAFeed
	--SET apex = 1
	--WHERE Model in 
	--	(			
	--	SELECT p.code
	--	FROM categories c JOIN products p ON c.CODE = p.primaryCatCode
	--	WHERE (c.superCat IN ('Residential', 'Janitorial')
	--			AND c.ACTIVE = 1 and p.active = 1
	--			AND price < 500)
	--			OR price < 250				
	--	 )
		
	--MARK AN ITEMT O BE LISTED AT PRICE + .01 FOR AMAZON ONLY
	UPDATE CAFeed
	SET amazon = 0 
	where model in (select code from products where active = 1 and isnull(feedMAP, 0) = 1 and isnull(MAP_Program, 'K') = 'E' and MAP = 1)
	
	UPDATE c
	SET c.map_price = CAST(p.map_price AS DECIMAL(10, 2))
	FROM products p JOIN cafeed c ON p.CODE = c.Model
	WHERE active = 1 
		AND ISNULL(MAP, 0) = 1
		AND ISNULL(map_program, '') = 'A'
		AND ISNULL(feedMAP, 0) = 0

	--REMOVING PRODUCTS THAT WE HAVENT SOLD IN THE LAST 24 MONTH
	UPDATE CAFeed
	SET listproduct = 0
	WHERE Model IN (SELECT CODE 
					FROM products 
					WHERE sales_last_24MO = 0 
						AND DATEDIFF(MONTH, addedDT, GETDATE()) > 11
					)
	--REMOVING PRODUCTS FROM CSE IF WE ARE SPENDING MORE THAN WE ARE MAKING MONEY
	EXEC [dbo].[cseClick_Stat]
	
	--DISABLING ANY PRODUCTS UNDER $50	
	UPDATE CAFeed
	SET shopzilla = 0, nextag = 0, amazon = 0, pricegrabber = 0, shopping = 0, become = 0
	WHERE CurrentPrice < 25

	--DISABLING PRODUCTS FROM PAID CSE CHANNELS
	UPDATE c
	SET c.nextag = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.Channel_Name LIKE '%NexTag%'

	--DISABLING PRODUCTS FROM AMAZON
	UPDATE c
	SET c.amazon = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.Channel_Name LIKE '%Amazon%'

	--DISABLING PRODUCTS FROM SHOPZILLA
	UPDATE c
	SET c.shopzilla = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.Channel_Name LIKE '%Shopzilla%'
	
	/**			
	UPDATE CAFeed
	SET shopzilla = 0
	WHERE LEFT(model, 3) IN ('017', '095', '284', '261', '075', '158', '166', '229', '002', '290', '225', '037', '383')
	**/	
	--DISABLING PRODUCTS FROM PRICEGRABBER
	UPDATE c
	SET c.pricegrabber = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.Channel_Name LIKE '%PriceGrabber%'
		
	--DISABLING PRODUCTS FROM SHOPPING.COM
	UPDATE c
	SET c.shopping = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE Channel_Name LIKE '%Shopping%'
		
	--DISABLING PRODUCTS FROM BECOME.COM
	UPDATE c
	SET c.become = 0
	FROM CAFeed c JOIN cseclick cc ON c.Model = cc.sku
	WHERE cc.Channel_Name LIKE '%Become%'
	
	--REMOVE ALL PRODUCTS WHERE FEED MAP = 3
	DELETE FROM CAFeed WHERE model IN
	(SELECT code FROM products WHERE active = 1 AND feedMAP = 3)
	
	--REMOVE ALL PRODUCTS WHERE MAP PROGRAM = X
	DELETE FROM CAFeed WHERE model IN
	(SELECT code FROM products WHERE active = 1 AND MAP_Program = 'X')
	
	-- GOOGLE CATEGORIES
	UPDATE c
	SET c.googleCat = cse.google,
		c.amazonCat = cse.amazon	
	FROM CAFeed c JOIN products p on c.Model = p.CODE			
				JOIN cseCatMapping cse ON cse.catCode = p.primaryCatCode	
	
	UPDATE CAFeed 
	SET googleCat = 'Home & Garden > Kitchen & Dining'
	WHERE googleCat IS NULL

	UPDATE CAFeed 
	SET amazonCat = 289814
	WHERE amazonCat IS NULL
	
	UPDATE g
	SET g.product_type = ISNULL(dbo.breadcrumb(p.primaryCatCode), 'Restaurant Supplies'),
		g.adwords_label = ISNULL(p.primaryCatCode, 'uncat')
	FROM CAFeed g JOIN products p ON g.model = p.CODE
	
	UPDATE c
	SET c.adwords_label = ISNULL(c2.catname, 'uncat'), 
		c.adwords_grouping = ISNULL(c2.superCat, 'uncat')
	FROM cafeed c JOIN categories c2 on c.adwords_label = c2.CODE AND c2.primaryCat = 1 
				
	UPDATE CAFeed
	SET product_type = dbo.cleaner(product_type),
		adwords_label = dbo.cleaner(adwords_label),
		adwords_grouping = dbo.cleaner(adwords_grouping)
		
	UPDATE CAFeed 
	SET adwords_grouping = 'uncat'
	WHERE adwords_grouping IS NULL
	
	UPDATE CAFeed SET MerchantCategory = 'Kitchen' WHERE MerchantCategory IS NULL
	
	--REMOVING ALL PRODUCTS FROM MAJOR CSE WITH 14+ DAYS LEAD TIME
	UPDATE c
	SET c.amazon = 0,
		c.shopping = 0,
		c.shopzilla = 0,
		c.nextag = 0,
		c.pricegrabber = 0,
		c.become = 0
	FROM products p JOIN CAFeed c ON p.CODE = c.Model
	WHERE active = 1 AND isWeb = 1
	AND price < 100
	AND avgLeadTime > 13
	AND qtyOnHand < 1
	
	UPDATE c
	SET c.amazon = 0,
		c.shopping = 0,
		c.shopzilla = 0,
		c.nextag = 0,
		c.pricegrabber = 0,
		c.become = 0
	FROM products p JOIN CAFeed c ON p.CODE = c.Model
	WHERE active = 1 AND isWeb = 1
	AND price < 100
	AND avgLeadTime is null 
	AND qtyOnHand < 1
	and leadTime_mfg like '%14+%'
	
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[category_catxprod_supplement]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[category_catxprod_supplement]
AS
BEGIN
	--INITIATE CATXPRODTEMP
	TRUNCATE TABLE catxprodTemp

	--INSERTING PRODUCT CATEGORIES INTO A TEMP TABLE
	INSERT INTO catxprodTemp(prodCode, catCode, primaryCat, [action])
	select code, category1, 1, 'I' 
	from catxprodWorktable 
	where len(category1) > 0

	INSERT INTO catxprodTemp(prodCode, catCode, primaryCat, [action])
	select code, category2, 0, 'I' 
	from catxprodWorktable
	where len(category2) > 0

	INSERT INTO catxprodTemp(prodCode, catCode, primaryCat, [action])
	select code, category3, 0, 'I' 
	from catxprodWorktable
	where len(category3) > 0

	INSERT INTO catxprodTemp(prodCode, catCode, primaryCat, [action])
	select code, category4, 0, 'I' 
	from catxprodWorktable
	where len(category4) > 0

	--MARK CATEGORIZATION NOT TO IMPORTED FOR EMAILED PURPOSE
	--DON'T IMPORT PRODUCTS THAT ARE NOT ACTIVE
	UPDATE catxprodTemp
	set [action] = 'P'
	WHERE prodCode NOT IN (SELECT code FROM products WHERE active = 1 and isWeb = 1)

	--MARK CATEGORIZATION NOT TO IMPORTED FOR EMAILED PURPOSE
	--DON'T IMPORT PRODUCTS THAT ARE NOT ASSIGNED TO A NON-ACTIVE CATEGORY
	UPDATE catxprodTemp
	set [action] = 'C'
	WHERE catcode NOT IN (SELECT code FROM categories WHERE active = 1 and endleaf = 1)

	--MARK CATEGORIZATION NOT TO IMPORTED FOR EMAILED PURPOSE
	--DON'T IMPORT DUPLICATE CATEGORIZED PROD
	UPDATE cx
	SET cx.[action] = 'D'
	FROM catxprodTemp cx JOIN catxProd c ON cx.catCode = c.catCode AND cx.prodCode = c.prodCode

	--SET ALL CURRENT CATEGORIZATION IN CATXPROD TO PRIMARY = 0
	UPDATE cx
	SET cx.primaryCat = 0
	FROM catxprod cx JOIN catxprodTemp ct ON cx.prodCode = ct.prodCode AND cx.catCode = ct.catCode 
	WHERE ct.primaryCat = 1
	
	--ADDED THE PROD CATEGORIZATION INTO CATXPROD
	INSERT INTO catxProd (catCode, prodCode, [primarycat], nav)
	SELECT catCode, prodCode, [primarycat], 0
	FROM catxprodTemp 
	WHERE [action] IN ('I', 'X')

	-- HOUSE CLEANING
	TRUNCATE TABLE catxprodWorktable 
	
	IF EXISTS(SELECT * FROM catxprodTemp WHERE [action] <>'I')
	   BEGIN
		EXEC dbo.[category_catxprod_supplement_email]
	   END	
	
	TRUNCATE TABLE catxprodTemp
END
GO
/****** Object:  StoredProcedure [dbo].[category_catxprod_vendor]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[category_catxprod_vendor]
AS
BEGIN
	--CREATING THE LIST OF MFG WITH ACTIVE PRODUCTS TO WORK WITH
	--productTMP FIELDS DEFINITION
	--mfgID = MFGID
	--mfgName = MFGNAME
	--active = CATID ASSOCIATED TO THE MFG
	--primaryCatID = IDENTIFY IF THE CATEOGRY EXISTS FOR THE DESIGNATED MFGID
	--mivaProdID = NUMBER OF PRODUCTS FOR THE DESIGNATED MFG
	TRUNCATE TABLE productTMP

	INSERT INTO productTMP(mfgID, mfgName, active, primaryCatID, mivaProdID)
	SELECT p.mfgID, p.mfgName, 
			CASE 
				WHEN c.catname IS NULL THEN 0
				ELSE 1
			END, c.id, COUNT(DISTINCT p.CODE) 
	FROM products p LEFT JOIN categories c ON c.mfgid = p.mfgid AND c.ACTIVE = 1
	WHERE p.active = 1 
		AND p.isWeb = 1
	GROUP BY p.mfgID, p.mfgName, 
			CASE 
				WHEN c.catname IS NULL THEN 0
				ELSE 1
			END, c.id

	--EXCLUDE ALL MFG CATEGORIES WITH CHILDREN
	DELETE FROM productTMP
	WHERE primaryCatID IN 
			(
			SELECT ct.primaryCatID
			FROM productTMP ct JOIN categories c on ct.primaryCatID = c.PARENT_ID
			GROUP BY ct.primaryCatID
			)
			
	--REMOVE ALL MFG WHERE THEY HAVE FULLY BEEN CATEGORIZED 
	DELETE ct
	FROM productTMP ct JOIN categories c on ct.primaryCatID = c.ID 
	WHERE ct.active = 1
		AND ct.mivaProdID = c.numProd

	--CREATING NEW CATEGORY FOR VENDOR WITH NO CATEGORIZATION
	TRUNCATE TABLE catTemp

	INSERT INTO catTemp
	SELECT dbo.RemoveNonAlphaNumericCharacters(mfgName), 'shop-by-vendor', mfgName, 1, 5844
	FROM productTMP 
	WHERE active = 0

	EXEC dbo.addNewCategory

	UPDATE p
	SET p.primaryCatID = c.id,
		p.ACTIVE = 1
	FROM productTMP p JOIN categories c ON p.mfgName = c.CATNAME
	WHERE p.primaryCatID IS NULL

	--ADDING CATEGORIZATION FOR VENDOR CAT INTO CATXPROD
	INSERT INTO catxprod(catID, catCode, prodID, prodCode, primaryCat, nav)
	SELECT pt.primaryCatID, c.CODE, p.prodid, p.CODE, 0, 0
	FROM productTMP pt JOIN products p ON pt.mfgID = p.mfgID
						JOIN categories c ON c.ID = pt.primaryCatID AND c.primaryCat = 1
						LEFT JOIN catxprod cp ON cp.catID = pt.primaryCatID AND cp.prodID = p.prodid
	WHERE p.active = 1 
		AND p.isWeb = 1
		AND cp.catID IS NULL
END
GO
/****** Object:  StoredProcedure [dbo].[categories_FA_SP]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[categories_FA_SP]
AS
BEGIN
	DECLARE @numProdPerCat INT

	--SET THE NUMBER OF PRODUCTS PER CATEGORY YOU WANT TO HAVE.  ALWAYS ADD 1 TO WHAT YOU WANT.
	--FOR EXAMPLE: IF YOU WANT TO HAVE 36 PRODUCTS PER CATEGORY THEN SET IT TO 36+1 = 37
	SET @numProdPerCat = 37

	TRUNCATE TABLE catxProd_FA
	TRUNCATE TABLE CATEGORIES_FA

	--ONLY COPY FA PRODUCTS CATEGORIZATION
	INSERT INTO catxProd_FA 
	SELECT DISTINCT cx.id, cx.catID, cx.catCode, cx.prodID, cx.prodCode, cx.primaryCat 
	FROM catxProd cx JOIN products p ON cx.prodcode = p.code 
	WHERE p.active = 1 AND isweb = 1 AND fa = 1

	--ONLY COPY MAIN AND ACTIVE CATEGORIES
	INSERT INTO CATEGORIES_FA ([ID], [PARENT_ID], [CODE], [CATNAME], [superCat], [endleaf], [catDescription], 
					[metaDescription], [sisterCat], [sisterCatID], [numProd], [ACTIVE], [primaryCat], 
					[numProdUpdated], [superCatID], [mfgID])
	SELECT id, parent_ID, code, catname, superCat, endleaf, catDescription, metaDescription, sisterCat, sisterCatID,
			numProd, active, primaryCat, numProdUpdated, superCatID, mfgID
	FROM CATEGORIES 
	WHERE supercatid NOT IN (5612, 5837, 8406, 10135, 10751, 10836) 
		AND active = 1
		AND primaryCat = 1

	--DELETING ALL ENDLEAF WHERE THERE IS NO PRODUCT
	DELETE FROM CATEGORIES_FA
	WHERE id IN (
				SELECT c.id
				FROM CATEGORIES_FA c LEFT JOIN catxProd_FA cx ON c.id = cx.catid
				WHERE endleaf = 1
				GROUP BY c.id
				HAVING COUNT(cx.prodCode) = 0
				)
		
	--RECOUNT NUMBER OF PRODUCTS PER CATEGORY FOR FA
	EXEC dbo.[categories_numProd_FA]

	--LOOP THROUGH CATEGORIES TO REASSIGNED PRODUCTS UP THE TREE IF THE NUMBER OF PRODUCTS PER PARENT CAT IS UNDER 37
	WHILE EXISTS(SELECT parent_id
				FROM CATEGORIES_FA c
				WHERE endleaf = 1 AND PARENT_ID NOT IN (0, 5844)
					AND (SELECT COUNT(*) FROM CATEGORIES_FA WHERE PARENT_ID = c.PARENT_ID AND endleaf = 0 ) < 1
				GROUP BY parent_id
				HAVING SUM(numProd) < @numProdPerCat)
	   BEGIN
		EXEC dbo.[categories_reAssignProdCat_FA] @numProdPerCat
		EXEC dbo.[categories_numProd_FA]
	   END
	   
	--CLEAN UP PROCESS
	DELETE cx 
	FROM catxprod_FA cx LEFT JOIN categories_FA c ON cx.catID = c.ID
	WHERE c.ID IS NULL
	EXEC dbo.[categories_numProd_FA]

	--SET URL
	UPDATE CATEGORIES_FA
	SET url = 'www.fabeqsupply.com/cat/' + LOWER(REPLACE(REPLACE(supercat, '/ ', ''), ' ', '-')) + '/' + code + '.html'

	--DETERMINING BREADCRUMB
	DECLARE @parentid INT, @catname VARCHAR(2000), @vendor BIT, @id INT, @code VARCHAR(255),
		@result VARCHAR(MAX), @tParentID INT, @tcatname VARCHAR(2000), 
		@tcode VARCHAR(1000), @tActive BIT, @turl VARCHAR(2000), @counter INT,
		@url VARCHAR(500)

	SET @counter = 0
	SET @tParentID = 0
		
	TRUNCATE TABLE categoryWorktable 

	DECLARE catCursor CURSOR FOR 
	SELECT ID, PARENT_ID, CODE, CATNAME, url
	FROM CATEGORIES_FA
	WHERE ACTIVE = 1 and primarycat = 1
	ORDER BY id asc

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @ID, @parentid, @code, @catName, @url

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @result = '<div class="breadcrumb"><a href="http://www.fabeqsupply.com" title="FAB EQ Supply">FAB EQ Supply</a>'
		
		IF @parentID > 0 
		   BEGIN
			INSERT INTO categoryWorktable VALUES(@counter, @catName, @code, 1, @url, null)
			SET @tParentID = @parentID		

			WHILE @tParentID > 0 
			   BEGIN
				IF EXISTS(SELECT parent_ID FROM categories_FA WHERE ID = @tParentID AND ACTIVE = 1)
				   BEGIN
					SET @counter = @counter + 1
					
					SELECT @tParentID = parent_ID, @tCatName = catName, @tCode = code, @tActive = ACTIVE, @turl = url 
					FROM categories_FA WHERE ID = @tParentID AND ACTIVE = 1 AND primaryCat = 1					
					
					INSERT INTO categoryWorktable VALUES(@counter, @tCatName, @tCode, @tActive, @turl, null)
				   END
				ELSE
				   BEGIN
					SET @tParentID = 0
				   END				
			   END
		
			IF @tParentID = 0 
			   BEGIN			
				DECLARE bread_cursor CURSOR FOR
				SELECT tCatName, tCode, tURL FROM categoryWorktable WHERE tActive = 1 ORDER BY tCounter desc

				OPEN bread_cursor
				FETCH NEXT FROM bread_cursor INTO @tCatName, @tCode, @tURL

				WHILE @@FETCH_STATUS = 0
				   BEGIN									
					IF @tCode <> @code
					   BEGIN
						SET @result = @result + '&nbsp;>&nbsp;<a href="' + @turl + '" title="' + @tCatName + '">' + @tCatName + '</a>'					
					   END
					ELSE
					   BEGIN
						SET @result = @result + '&nbsp;>&nbsp;<strong>' + @tCatName + '</strong></div>'
					   END
					FETCH NEXT FROM bread_cursor INTO @tCatName, @tCode, @tURL
				   END

				CLOSE bread_cursor
				DEALLOCATE bread_cursor
	        
				SET @counter = 0
				TRUNCATE TABLE categoryWorktable
			   END
		   END
		ELSE
		   BEGIN
			SET @result = @result + '&nbsp;>&nbsp;<strong>' + @catName + '</strong></div>'
			--SET @url = 'http://www.katom.com/cat/'  + @tCode + '.html'
		   END
		
		UPDATE categories_FA
		SET breadcrumb = @result
		WHERE ID = @ID  	

		FETCH NEXT FROM catCursor INTO @ID, @parentid, @code, @catName, @url  
	   END
	   
	CLOSE catCursor
	DEALLOCATE catCursor	   
	
	--DETERMINING SISTER categories
	DECLARE @sisterCat VARCHAR(MAX), @sisterCatID VARCHAR(MAX)
	
	UPDATE categories_FA SET sisterCat = null, sisterCatID = null

	DECLARE pCursor CURSOR FOR 
	SELECT parent_ID
	FROM categories_FA
	WHERE ACTIVE = 1 AND PARENT_ID > 0
	GROUP BY PARENT_ID
	HAVING COUNT(*) > 1
	
	OPEN pCursor
	FETCH NEXT FROM pCursor INTO @parentID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		
		SET @sisterCat = ''
		SET @sisterCatID = ''
			   
		DECLARE dCursor CURSOR FOR 
		SELECT code, catName
		FROM categories_FA
		WHERE active = 1 AND parent_ID = @parentID AND primaryCat = 1
		ORDER BY ID
		
		OPEN dCursor
		FETCH NEXT FROM dCursor INTO @code, @catName

		WHILE @@FETCH_STATUS = 0
		   BEGIN
		   
			IF LEN(@sisterCat) > 0 
			   BEGIN
				SET @sisterCat = @sisterCat + '|' + @catName
				SET @sisterCatID = @sisterCatID + '|' + @code
			   END
			ELSE 
			   BEGIN
				SET @sisterCat = @catName
				SET @sisterCatID = @code
			   END
			
			FETCH NEXT FROM dCursor INTO @code, @catName
		   END
		   
		UPDATE categories_FA
		SET sisterCat = @sisterCat,
			sisterCatID = @sisterCatID
		WHERE PARENT_ID = @parentID
		
		CLOSE dCursor
		DEALLOCATE dCursor
		   
		FETCH NEXT FROM pCursor INTO @parentID
	   END

	CLOSE pCursor
	DEALLOCATE pCursor		
	
END
GO
/****** Object:  StoredProcedure [dbo].[processNewNAVProd_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[processNewNAVProd_SP]
AS
BEGIN
DECLARE @tmpString varchar(50)
DECLARE @CODE VARCHAR(100), @shortDesc VARCHAR(30), @katomUOM VARCHAR(25), 
		@vendorID VARCHAR(100), @mpn VARCHAR(100), @WEIGHT FLOAT, @shipAlone VARCHAR(1), 
		@freightOnly VARCHAR(1), @freeShipping VARCHAR(1), @prodL FLOAT, @prodW FLOAT, @prodH FLOAT, 
		@cost MONEY, @listPrice MONEY, @ACTIVE BIT, @isWeb BIT, @IMAGE VARCHAR(255),  
	    @NAME VARCHAR(255), @keywords VARCHAR(255), @prodDesc VARCHAR(MAX), @UPC float, @handlingCharge MONEY,
		@discountGroup varchar(255), @equivGroup varchar(255), @stockItem bit, @orderMin smallint, @orderMax smallint,
		@reorderQty smallint, @status tinyint, @binLocation varchar(50), @RelatedItems varchar(1000)

DECLARE @counter tinyint, @SQL VARCHAR(MAX)

SET @tmpString = NULL
SET @status = 0

TRUNCATE TABLE dbo.NAVProductImport

DECLARE lagCursor CURSOR FOR 
SELECT [CODE], [NAVDesc], [katomUOM], [vendorID], [mpn], [WEIGHT], [shipAlone], [freightOnly], 
	   [freeShipping], [prodL], [prodW], [prodH], [cost], [listprice], CASE [ACTIVE] WHEN 1 THEN 0 ELSE 1 END, [isWeb], [IMAGE],  
	   [NAME], [keywords], [prodDesc], CASE WHEN [UPC] is Null THEN 0 ELSE [UPC] END as [UPC], [handlingCharge], [ICDiscountGrp], [EquivGrp], [stockItem], [thresholdMin], [thresholdMax],
	   [reorderQty], [binLocation], [RelatedItems]
FROM products_w
WHERE DATEDIFF(DAY, GETDATE(), addedDT) = 0

OPEN lagCursor
FETCH NEXT FROM lagCursor INTO @CODE,@shortDesc,@katomUOM,@vendorID,@mpn,@WEIGHT,@shipAlone,@freightOnly,
	   @freeShipping,@prodL,@prodW,@prodH,@cost,@listPrice,@ACTIVE,@isWeb,@IMAGE,
	   @NAME,@keywords,@prodDesc,@UPC,@handlingCharge, @discountGroup, @equivGroup, @stockItem, @orderMin, @orderMax,
	   @reorderQty, @binLocation, @RelatedItems

WHILE @@FETCH_STATUS = 0
   BEGIN
	SET @prodDesc = ltrim(rtrim(@prodDesc))
	SET @prodDesc = REPLACE(@prodDesc,'''','&#39;')

	IF (@stockItem = 1)
		SET @status = 1
	ELSE
		SET @status = 0

	IF NOT EXISTS (SELECT * FROM NAVProductImport WHERE [No] = @code)
	   BEGIN
		INSERT INTO NAVProductImport([No], [Description], [Base Unit of Measure], [Vendor No], [Vendor Item No], 
			[Gross Weight], [Ship Alone], [Freight Only], [Free Shipping], [Length], [Width], [Height], 
			[Last Direct Cost], [List Price 1], [List Price 2], [Blocked], [Web Item], [Image File Name], 
			[Product Name], [Keywords], [SKU], [UPC], [Add Handling Charge], [Item/Cust Disc Gr], [Equivalent Group], [Status], 
			[Reorder Point], [Maximum Inventory], [Reorder Quantity], [Shelf/Bin No.], [Costing Method], [Related Items])
		VALUES(@CODE, @shortDesc, @katomUOM, @vendorID, @mpn, @WEIGHT, @shipAlone, @freightOnly,
			   @freeShipping, @prodL, @prodW, @prodH, @cost, @listPrice, @listPrice, @ACTIVE, @isWeb, @IMAGE,
			   @NAME, @keywords, @MPN, @UPC,@handlingCharge,@discountGroup,@equivGroup, @status, @orderMin, @orderMax, @reorderQty, @binLocation, 3, @RelatedItems)
		
		--COST METHOD IS SET TO 3 FOR AVERAGE
		
		SET @counter = 1
		WHILE LEN(@prodDesc) > 0
		   BEGIN
			SET @tmpString = LEFT(@prodDesc, 50)
			
			IF LEN(@prodDesc) > 50
			   BEGIN
				IF RIGHT(@tmpString, 1) <> ' '
					BEGIN
						IF dbo.RCHARINDEX(' ', @tmpString, 1) > 0
							BEGIN
								SET @tmpString = LTRIM(RTRIM(LEFT(@tmpString, dbo.RCHARINDEX(' ', @tmpString, 1))))
							END
						SET @prodDesc = LTRIM(RIGHT(@prodDesc, LEN(@prodDesc)-LEN(@tmpString)))
					END
				ELSE
					BEGIN
						SET @tmpString = LTRIM(RTRIM(@tmpString))
						SET @prodDesc = RIGHT(@prodDesc, LEN(@prodDesc)-50)
					END
			   END
			ELSE
			   BEGIN
				SET @prodDesc = ''
			   END
			
			SET @SQL = ''
			SET @SQL = 'UPDATE NAVProductImport SET [Extended Description ' + CAST(@counter AS VARCHAR(10))
						+ '] = ''' + @tmpString + ''' WHERE [No] = ''' + @CODE + ''''
			EXEC (@SQL)
			SET @counter = @counter + 1
		   END
	   END
	FETCH NEXT FROM lagCursor INTO @CODE,@shortDesc,@katomUOM,@vendorID,@mpn,@WEIGHT,@shipAlone,@freightOnly,
	   @freeShipping,@prodL,@prodW,@prodH,@cost,@listPrice,@ACTIVE,@isWeb,@IMAGE,
	   @NAME,@keywords,@prodDesc,@UPC,@handlingCharge, @discountGroup, @equivGroup, @stockItem, @orderMin, @orderMax,
	   @reorderQty, @binLocation, @RelatedItems
   END

CLOSE lagCursor
DEALLOCATE lagCursor
END
GO
/****** Object:  StoredProcedure [dbo].[priceDiscrepancyRpt]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[priceDiscrepancyRpt]
	@refreshPrice BIT, @reportType TINYINT
AS
BEGIN
	
	IF @refreshPrice = 1 
	   BEGIN
		EXEC dbo.product_Pricing_Update_SP

		IF LEN(@reportType) = 0 
		   BEGIN
			EXEC dbo.[priceDiscrepancyRpt] 0, 1
		   END
		ELSE
		   BEGIN
			EXEC dbo.[priceDiscrepancyRpt] 0, @reportType		   
		   END	   
	   END
	
	TRUNCATE TABLE prodTemp
	
	IF @reportType = 1 --MAP PRICE
	   BEGIN
		INSERT INTO prodTemp([No_], [Gross Weight])
		SELECT d.[Code], 
			(SELECT [Line Discount %] 
			 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line Discount] 
			 WHERE [Code] = d.[Code] AND [Sales Code] = 'MAP' 
					AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			)
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] d
		WHERE MAP = 1

		SELECT p.code, p.discountGroup, pt.[Gross Weight] discountPerc, p.listprice, p.mapPrice, 
				CAST(listprice*(100-pt.[Gross Weight])/100 AS DECIMAL(10, 2)) CalculatedValue, p.manualPricingMAP
		FROM products_Price_Worktable p JOIN prodTemp pt on p.discountGroup  = pt.[No_]
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on i.[No_] = p.code COLLATE SQL_Latin1_General_CP1_CI_AS
		WHERE p.mapPrice <> CAST(ISNULL(listprice*(100-pt.[Gross Weight])/100, 0) AS DECIMAL(10, 2))
			AND p.manualPricingMAP = 0
			and i.[Status] <> 2
	   END
	ELSE IF @reportType = 2 --KATOM PRICE
	   BEGIN
		INSERT INTO prodTemp([No_], [Gross Weight])
		SELECT d.[Code], 
			(SELECT [Line Discount %] 
			 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line Discount] 
			 WHERE [Code] = d.[Code] AND [Sales Code] = 'KATOM' 
					AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			)
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] d


		SELECT p.code, p.discountGroup, pt.[Gross Weight] discountPerc, p.listprice, p.price, 
				CAST(listprice*(100-pt.[Gross Weight])/100 AS DECIMAL(10, 2)) CalculatedValue, p.manualPricingKAT
		FROM products_Price_Worktable p JOIN prodTemp pt on p.discountGroup  = pt.[No_]
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on i.[No_] = p.code COLLATE SQL_Latin1_General_CP1_CI_AS
		WHERE p.price <> CAST(ISNULL(listprice*(100-pt.[Gross Weight])/100, 0) AS DECIMAL(10, 2))
			AND p.manualPricingKAT = 0
			and i.[Status] <> 2
	   END
	ELSE IF @reportType = 3 --BB PRICE
	   BEGIN
		INSERT INTO prodTemp([No_], [Gross Weight])
		SELECT d.[Code], 
			(SELECT [Line Discount %] 
			 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line Discount] 
			 WHERE [Code] = d.[Code] AND [Sales Code] = 'BB' 
					AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			)
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] d

		SELECT p.code, p.discountGroup, pt.[Gross Weight] discountPerc, p.listprice, p.bbprice, 
				CAST(listprice*(100-pt.[Gross Weight])/100 AS DECIMAL(10, 2)) CalculatedValue, p.manualPricingBB
		FROM products_Price_Worktable p JOIN prodTemp pt on p.discountGroup  = pt.[No_]
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on i.[No_] = p.code COLLATE SQL_Latin1_General_CP1_CI_AS
		WHERE p.bbprice <> CAST(ISNULL(listprice*(100-pt.[Gross Weight])/100, 0) AS DECIMAL(10, 2))
			AND p.manualPricingBB = 0
			and i.[Status] <> 2
	   END
	ELSE IF @reportType = 4 --STD_COST 
	   BEGIN
		INSERT INTO prodTemp([No_], [Gross Weight])
		SELECT d.[Code], 
			(SELECT [Line Discount %] 
			 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line Discount] 
			 WHERE [Code] = d.[Code] AND [Sales Code] = 'STD_COST' 
					AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			)
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] d

		SELECT p.code, p.discountGroup, pt.[Gross Weight] discountPerc, p.listprice, p.cost, 
				CAST(listprice*(100-pt.[Gross Weight])/100 AS DECIMAL(10, 4)) CalculatedValue, p.manualPricingCost
		FROM products_Price_Worktable p JOIN prodTemp pt on p.discountGroup  = pt.[No_]
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on i.[No_] = p.code COLLATE SQL_Latin1_General_CP1_CI_AS
		WHERE p.cost <> CAST(ISNULL(listprice*(100-pt.[Gross Weight])/100, 0) AS DECIMAL(10, 2))
			AND p.manualPricingCost = 0
			and i.[Status] <> 2
	   END
	ELSE IF @reportType = 5 -- REAL COST
	   BEGIN
		INSERT INTO prodTemp([No_], [Gross Weight])
		SELECT d.[Code], 
			(SELECT [Line Discount %] 
			 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line Discount] 
			 WHERE [Code] = d.[Code] AND [Sales Code] = '_COST' 
					AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			)
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] d

		SELECT p.code, p.discountGroup, pt.[Gross Weight] discountPerc, p.listprice, p.realcost, 
				CAST(listprice*(100-pt.[Gross Weight])/100 AS DECIMAL(10, 4)) CalculatedValue, p.manualPricingRealCost
		FROM products_Price_Worktable p JOIN prodTemp pt on p.discountGroup  = pt.[No_]
				JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on i.[No_] = p.code COLLATE SQL_Latin1_General_CP1_CI_AS
		WHERE p.realcost <> CAST(ISNULL(listprice*(100-pt.[Gross Weight])/100, 0) AS DECIMAL(10, 2))
			AND manualPricingRealCost = 0
			and i.[Status] <> 2
	   END
	ELSE IF @reportType = 6 --MULTIPLE ACTIVE COSTS
	   BEGIN		
		SELECT [Item No_], [Unit of Measure Code], COUNT(*) 
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Price] p 
		WHERE GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			 AND [Item No_] NOT IN (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE [Status] = 2)
		group by [Item No_], [Unit of Measure Code]
		having COUNT(*) > 1
	   END
	ELSE IF @reportType = 7 --MULTIPLE ACTIVE PRICES
	   BEGIN		
		SELECT [Item No_], [Sales Code], [Unit of Measure Code], COUNT(*) 
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] p 
		WHERE GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
			 AND [Item No_] NOT IN (SELECT [No_] FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] WHERE [Status] = 2)
		group by [Item No_], [Sales Code], [Unit of Measure Code]
		having COUNT(*) > 1
	   END
END
GO
/****** Object:  StoredProcedure [dbo].[PilotOrderImportTest]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[PilotOrderImportTest]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdrtest_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdrtest
*/

--SELECT * FROM order_hdrtest_bkp
--DELETE FROM order_hdrtest_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdrtest

UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 3') 
	SET batch_id = '4';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdrtest (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount, selltocountry, selltophone)

SELECT * FROM openquery(MYSQL, '
		SELECT  id as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		ship_email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		ship_fax as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		upper(bill_email) as selltoemail,
		left(upper(concat(bill_fname,'' '',bill_lname)),50) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM katom_mm5.s01_OrderCharges where order_id = customerpo
         and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as method,
		(SELECT amount FROM katom_mm5.s01_OrderCharges where order_id = customerpo
		 and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as amount,
		 bill_cntry,
		 bill_phone
		FROM katom_mm5.s01_Orders where batch_id = 4')

  
  UPDATE [KatomDev].[dbo].[order_hdrtest] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdrtest] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
   
  UPDATE [KatomDev].[dbo].[order_hdrtest] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdrtest] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_itemstest

	INSERT INTO order_itemstest(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		upsold,
		quantity	
		FROM katom_mm5.s01_OrderItems
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 4)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_chargestest

	INSERT INTO order_chargestest(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount,
		disp_amt,
		tax_exempt
		FROM katom_mm5.s01_OrderCharges
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 4)')


/*Pulls down the option information based on un-batched order headers*/
--delete from order_optionstest

	INSERT INTO order_optionstest(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM katom_mm5.s01_OrderOptions
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 4 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_optionstest]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_optionstest(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(MYSQL, '
		SELECT order_id,
		charge_id as line_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount
		FROM katom_mm5.s01_OrderCharges
		where module_id in (1001, 186)
		and order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 4)')
	

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 4') 
	SET batch_id = '1';

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(10)
	DECLARE @Country varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo, shiptocountry FROM order_hdrtest WHERE exported = 0 and shiptocountry <> 'XX'

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @Country

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparsetest @Order
		
		/* International Order Handling */		
		IF @Country NOT IN ('XX', 'US')
			BEGIN
				Update order_hdrtest
				set shiptocity = (shiptocity+', '+shiptostate),
					shiptostate = shiptocountry,
					selltocity = (selltocity+', '+selltostate),
					selltostate = shiptocountry,
					shiptocountry = 'XX'
				where customerpo = @Order
			
				/*insert into order_itemstest([order_id], [line_id], [product_id], [code],[name], [price], [weight], [taxable], [upsold], [quantity])
				values (@Order, 1, 999999, '', 'INTERNATIONAL ORDER', '0.00', '0', 1, 0, 0)*/
			END
							
		FETCH NEXT FROM DemoCursor INTO @Order, @Country
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor
/*Display the gathered header information*/
SELECT * FROM order_hdrtest

/*Display the gathered line item information with customer info*/
SELECT * FROM order_hdrtest
join order_itemstest
ON order_id = customerpo
order by order_id

select name, attr_code, opt_code from order_optionstest o
join order_itemstest i 
on i.order_id = o.order_id and i.line_id = o.line_id

--exec CvcImport

UPDATE [KatomDev].[dbo].[order_hdrtest] SET ccnum = dbo.StripNonNumeric(ccnum)

END
GO
/****** Object:  StoredProcedure [dbo].[InvoiceBackupCopy_OldNav]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InvoiceBackupCopy_OldNav] 
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
insert into [invoice_backup]([No_]
      ,[Sell-to Customer No_]
      ,[Bill-to Customer No_]
      ,[Name]
      ,[Name 2]
      ,[Address]
      ,[Address 2]
      ,[City]
      ,[Contact]
      ,[Your Reference]
      ,[Ship-to Code]
      ,[Ship-to Name]
      ,[Ship-to Name 2]
      ,[Ship-to Address]
      ,[Ship-to Address 2]
      ,[Ship-to City]
      ,[Ship-to Contact]
      ,[Order Date]
      ,[Posting Date]
      ,[Shipment Date]
      ,[Posting Description]
      ,[Payment Terms Code]
      ,[Due Date]
      ,[Payment Discount %]
      ,[Pmt_ Discount Date]
      ,[Shipment Method Code]
      ,[Location Code]
      ,[Department Code]
      ,[Project Code]
      ,[Customer Posting Group]
      ,[Currency Code]
      ,[Currency Factor]
      ,[Price Group Code]
      ,[Prices Including Tax]
      ,[Allow Quantity Disc_]
      ,[Invoice Disc_ Code]
      ,[Cust__Item Disc_ Gr_]
      ,[Language Code]
      ,[Salesperson Code]
      ,[Order No_]
      ,[No_ Printed]
      ,[On Hold]
      ,[Applies-to Doc_ Type]
      ,[Applies-to Doc_ No_]
      ,[Bal_ Account No_]
      ,[Job No_]
      ,[VAT Registration No_]
      ,[Reason Code]
      ,[Gen_ Bus_ Posting Group]
      ,[EU 3-Party Trade]
      ,[Transaction Type]
      ,[Transport Method]
      ,[VAT Country Code]
      ,[Sell-to Customer Name]
      ,[Sell-to Customer Name 2]
      ,[Sell-to Address]
      ,[Sell-to Address 2]
      ,[Sell-to City]
      ,[Sell-to Contact]
      ,[ZIP Code]
      ,[State]
      ,[Country Code]
      ,[Sell-to ZIP Code]
      ,[Sell-to State]
      ,[Sell-to Country Code]
      ,[Ship-to ZIP Code]
      ,[Ship-to State]
      ,[Ship-to Country Code]
      ,[Bal_ Account Type]
      ,[Exit Point]
      ,[Correction]
      ,[Document Date]
      ,[External Document No_]
      ,[Area]
      ,[Transaction Specification]
      ,[Payment Method Code]
      ,[Shipping Agent Code]
      ,[Package Tracking No_]
      ,[Pre-Assigned No_ Series]
      ,[No_ Series]
      ,[Order No_ Series]
      ,[Pre-Assigned No_]
      ,[User ID]
      ,[Source Code]
      ,[Tax Area Code]
      ,[Tax Liable]
      ,[Tax Bus_ Posting Group]
      ,[VAT Base Discount %]
      ,[Ship-to UPS Zone]
      ,[Tax Exemption No_]
      ,[New Customer]
      ,[Phone No_]
      ,[Fax No_]
      ,[E-Mail]
      ,[Home Page]
      ,[Pager_Cell No_]
      ,[Ext_]
      ,[Credit Card Comp_]
      ,[Credit Card Holder]
      ,[Credit Card No_]
      ,[Credit Card Exp_ Month]
      ,[Credit Card Exp_ Year]
      ,[Picker]
      ,[Packer]
      ,[Customer Source]
      ,[Credit Card Info Sent]
      ,[Amount Submitted]
      ,[Amount Approved]
      ,[Credit Approval Obtained]
      ,[Amount Declined]
      ,[Amount Authorized]
      ,[Catalog Version Code]
      ,[Order Medium]
      ,[Web Order No_])
      
select [No_]
      ,[Sell-to Customer No_]
      ,[Bill-to Customer No_]
      ,[Name]
      ,[Name 2]
      ,[Address]
      ,[Address 2]
      ,[City]
      ,[Contact]
      ,[Your Reference]
      ,[Ship-to Code]
      ,[Ship-to Name]
      ,[Ship-to Name 2]
      ,[Ship-to Address]
      ,[Ship-to Address 2]
      ,[Ship-to City]
      ,[Ship-to Contact]
      ,[Order Date]
      ,[Posting Date]
      ,[Shipment Date]
      ,[Posting Description]
      ,[Payment Terms Code]
      ,[Due Date]
      ,[Payment Discount %]
      ,[Pmt_ Discount Date]
      ,[Shipment Method Code]
      ,[Location Code]
      ,[Department Code]
      ,[Project Code]
      ,[Customer Posting Group]
      ,[Currency Code]
      ,[Currency Factor]
      ,[Price Group Code]
      ,[Prices Including Tax]
      ,[Allow Quantity Disc_]
      ,[Invoice Disc_ Code]
      ,[Cust__Item Disc_ Gr_]
      ,[Language Code]
      ,[Salesperson Code]
      ,[Order No_]
      ,[No_ Printed]
      ,[On Hold]
      ,[Applies-to Doc_ Type]
      ,[Applies-to Doc_ No_]
      ,[Bal_ Account No_]
      ,[Job No_]
      ,[VAT Registration No_]
      ,[Reason Code]
      ,[Gen_ Bus_ Posting Group]
      ,[EU 3-Party Trade]
      ,[Transaction Type]
      ,[Transport Method]
      ,[VAT Country Code]
      ,[Sell-to Customer Name]
      ,[Sell-to Customer Name 2]
      ,[Sell-to Address]
      ,[Sell-to Address 2]
      ,[Sell-to City]
      ,[Sell-to Contact]
      ,[ZIP Code]
      ,[State]
      ,[Country Code]
      ,[Sell-to ZIP Code]
      ,[Sell-to State]
      ,[Sell-to Country Code]
      ,[Ship-to ZIP Code]
      ,[Ship-to State]
      ,[Ship-to Country Code]
      ,[Bal_ Account Type]
      ,[Exit Point]
      ,[Correction]
      ,[Document Date]
      ,[External Document No_]
      ,[Area]
      ,[Transaction Specification]
      ,[Payment Method Code]
      ,[Shipping Agent Code]
      ,[Package Tracking No_]
      ,[Pre-Assigned No_ Series]
      ,[No_ Series]
      ,[Order No_ Series]
      ,[Pre-Assigned No_]
      ,[User ID]
      ,[Source Code]
      ,[Tax Area Code]
      ,[Tax Liable]
      ,[Tax Bus_ Posting Group]
      ,[VAT Base Discount %]
      ,[Ship-to UPS Zone]
      ,[Tax Exemption No_]
      ,[New Customer]
      ,[Phone No_]
      ,[Fax No_]
      ,[E-Mail]
      ,[Home Page]
      ,[Pager_Cell No_]
      ,[Ext_]
      ,[Credit Card Comp_]
      ,[Credit Card Holder]
      ,[Credit Card No_]
      ,[Credit Card Exp_ Month]
      ,[Credit Card Exp_ Year]
      ,[Picker]
      ,[Packer]
      ,[Customer Source]
      ,[Credit Card Info Sent]
      ,[Amount Submitted]
      ,[Amount Approved]
      ,[Credit Approval Obtained]
      ,[Amount Declined]
      ,[Amount Authorized]
      ,[Catalog Version Code]
      ,[Order Medium]
      ,[Web Order No_]
	from fs1.[KatomDev].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header]
	where No_ not in (select No_ from [KatomDev].[dbo].[invoice_backup])
	
	insert into ship_backup
	select * from shiptracking.dbo.TrackingArchive
	where trackingno not in (select trackingno from ship_backup)
	
END
GO
/****** Object:  StoredProcedure [dbo].[InvoiceBackupCopy]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[InvoiceBackupCopy] 
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
	delete from invoice_backup

	insert into invoice_backup ([No_]
		  ,[Sell-to Customer No_]
		  ,[Bill-to Customer No_]
		  ,[Bill-to Name]
		  ,[Bill-to Name 2]
		  ,[Bill-to Address]
		  ,[Bill-to Address 2]
		  ,[Bill-to City]
		  ,[Bill-to Contact]
		  ,[Your Reference]
		  ,[Ship-to Code]
		  ,[Ship-to Name]
		  ,[Ship-to Name 2]
		  ,[Ship-to Address]
		  ,[Ship-to Address 2]
		  ,[Ship-to City]
		  ,[Ship-to Contact]
		  ,[Order Date]
		  ,[Posting Date]
		  ,[Shipment Date]
		  ,[Posting Description]
		  ,[Payment Terms Code]
		  ,[Due Date]
		  ,[Payment Discount %]
		  ,[Pmt_ Discount Date]
		  ,[Shipment Method Code]
		  ,[Location Code]
		  ,[Shortcut Dimension 1 Code]
		  ,[Shortcut Dimension 2 Code]
		  ,[Customer Posting Group]
		  ,[Currency Code]
		  ,[Currency Factor]
		  ,[Customer Price Group]
		  ,[Prices Including VAT]
		  ,[Invoice Disc_ Code]
		  ,[Customer Disc_ Group]
		  ,[Language Code]
		  ,[Salesperson Code]
		  ,[Order No_]
		  ,[No_ Printed]
		  ,[On Hold]
		  ,[Applies-to Doc_ Type]
		  ,[Applies-to Doc_ No_]
		  ,[Bal_ Account No_]
		  ,[VAT Registration No_]
		  ,[Reason Code]
		  ,[Gen_ Bus_ Posting Group]
		  ,[EU 3-Party Trade]
		  ,[Transaction Type]
		  ,[Transport Method]
		  ,[VAT Country_Region Code]
		  ,[Sell-to Customer Name]
		  ,[Sell-to Customer Name 2]
		  ,[Sell-to Address]
		  ,[Sell-to Address 2]
		  ,[Sell-to City]
		  ,[Sell-to Contact]
		  ,[Bill-to Post Code]
		  ,[Bill-to County]
		  ,[Bill-to Country_Region Code]
		  ,[Sell-to Post Code]
		  ,[Sell-to County]
		  ,[Sell-to Country_Region Code]
		  ,[Ship-to Post Code]
		  ,[Ship-to County]
		  ,[Ship-to Country_Region Code]
		  ,[Bal_ Account Type]
		  ,[Exit Point]
		  ,[Correction]
		  ,[Document Date]
		  ,[External Document No_]
		  ,[Area]
		  ,[Transaction Specification]
		  ,[Payment Method Code]
		  ,[Shipping Agent Code]
		  ,[Package Tracking No_]
		  ,[Pre-Assigned No_ Series]
		  ,[No_ Series]
		  ,[Order No_ Series]
		  ,[Pre-Assigned No_]
		  ,[User ID]
		  ,[Source Code]
		  ,[Tax Area Code]
		  ,[Tax Liable]
		  ,[VAT Bus_ Posting Group]
		  ,[VAT Base Discount %]
		  ,[Ship-to UPS Zone]
		  ,[Tax Exemption No_]
		  ,[New Customer]
		  ,[Phone No_]
		  ,[Fax No_]
		  ,[E-Mail]
		  ,[Home Page]
		  ,[Pager_Cell No_]
		  ,[Ext_]
		  ,[Credit Card Comp_]
		  ,[Credit Card Holder]
		  ,[Credit Card No_]
		  ,[Credit Card Exp_ Month]
		  ,[Credit Card Exp_ Year]
		  ,[Picker]
		  ,[Packer]
		  ,[Customer Source]
		  ,[Credit Card Info Sent]
		  ,[Amount Submitted]
		  ,[Amount Approved]
		  ,[Credit Approval Obtained]
		  ,[Amount Declined]
		  ,[Amount Authorized]
		  ,[Catalog Version Code]
		  ,[Order Medium]
		  ,[Web Order No_]
		  ,[Campaign No_]
		  ,[Sell-to Contact No_]
		  ,[Bill-to Contact No_]
		  ,[Responsibility Center]
		  ,[Service Mgt_ Document]
		  ,[Allow Line Disc_]
		  ,[Get Shipment Used]
		  ,[Date Sent]
		  ,[Time Sent]
		  ,[BizTalk Sales Invoice]
		  ,[Customer Order No_]
		  ,[BizTalk Document Sent]
		  ,[Prepayment No_ Series]
		  ,[Prepayment Invoice]
		  ,[Prepayment Order No_]
		  ,[Quote No_]
		  ,[STE Transaction ID]
		  ,[Ship Complete]
		  ,[Order Reason])
	select [No_]
		  ,[Sell-to Customer No_]
		  ,[Bill-to Customer No_]
		  ,[Bill-to Name]
		  ,[Bill-to Name 2]
		  ,[Bill-to Address]
		  ,[Bill-to Address 2]
		  ,[Bill-to City]
		  ,[Bill-to Contact]
		  ,[Your Reference]
		  ,[Ship-to Code]
		  ,[Ship-to Name]
		  ,[Ship-to Name 2]
		  ,[Ship-to Address]
		  ,[Ship-to Address 2]
		  ,[Ship-to City]
		  ,[Ship-to Contact]
		  ,[Order Date]
		  ,[Posting Date]
		  ,[Shipment Date]
		  ,[Posting Description]
		  ,[Payment Terms Code]
		  ,[Due Date]
		  ,[Payment Discount %]
		  ,[Pmt_ Discount Date]
		  ,[Shipment Method Code]
		  ,[Location Code]
		  ,[Shortcut Dimension 1 Code]
		  ,[Shortcut Dimension 2 Code]
		  ,[Customer Posting Group]
		  ,[Currency Code]
		  ,[Currency Factor]
		  ,[Customer Price Group]
		  ,[Prices Including VAT]
		  ,[Invoice Disc_ Code]
		  ,[Customer Disc_ Group]
		  ,[Language Code]
		  ,[Salesperson Code]
		  ,[Order No_]
		  ,[No_ Printed]
		  ,[On Hold]
		  ,[Applies-to Doc_ Type]
		  ,[Applies-to Doc_ No_]
		  ,[Bal_ Account No_]
		  ,[VAT Registration No_]
		  ,[Reason Code]
		  ,[Gen_ Bus_ Posting Group]
		  ,[EU 3-Party Trade]
		  ,[Transaction Type]
		  ,[Transport Method]
		  ,[VAT Country_Region Code]
		  ,[Sell-to Customer Name]
		  ,[Sell-to Customer Name 2]
		  ,[Sell-to Address]
		  ,[Sell-to Address 2]
		  ,[Sell-to City]
		  ,[Sell-to Contact]
		  ,[Bill-to Post Code]
		  ,[Bill-to County]
		  ,[Bill-to Country_Region Code]
		  ,[Sell-to Post Code]
		  ,[Sell-to County]
		  ,[Sell-to Country_Region Code]
		  ,[Ship-to Post Code]
		  ,[Ship-to County]
		  ,[Ship-to Country_Region Code]
		  ,[Bal_ Account Type]
		  ,[Exit Point]
		  ,[Correction]
		  ,[Document Date]
		  ,[External Document No_]
		  ,[Area]
		  ,[Transaction Specification]
		  ,[Payment Method Code]
		  ,[Shipping Agent Code]
		  ,[Package Tracking No_]
		  ,[Pre-Assigned No_ Series]
		  ,[No_ Series]
		  ,[Order No_ Series]
		  ,[Pre-Assigned No_]
		  ,[User ID]
		  ,[Source Code]
		  ,[Tax Area Code]
		  ,[Tax Liable]
		  ,[VAT Bus_ Posting Group]
		  ,[VAT Base Discount %]
		  ,[Ship-to UPS Zone]
		  ,[Tax Exemption No_]
		  ,[New Customer]
		  ,[Phone No_]
		  ,[Fax No_]
		  ,[E-Mail]
		  ,[Home Page]
		  ,[Pager_Cell No_]
		  ,[Ext_]
		  ,[Credit Card Comp_]
		  ,[Credit Card Holder]
		  ,[Credit Card No_]
		  ,[Credit Card Exp_ Month]
		  ,[Credit Card Exp_ Year]
		  ,[Picker]
		  ,[Packer]
		  ,[Customer Source]
		  ,[Credit Card Info Sent]
		  ,[Amount Submitted]
		  ,[Amount Approved]
		  ,[Credit Approval Obtained]
		  ,[Amount Declined]
		  ,[Amount Authorized]
		  ,[Catalog Version Code]
		  ,[Order Medium]
		  ,[Web Order No_]
		  ,[Campaign No_]
		  ,[Sell-to Contact No_]
		  ,[Bill-to Contact No_]
		  ,[Responsibility Center]
		  ,[Service Mgt_ Document]
		  ,[Allow Line Disc_]
		  ,[Get Shipment Used]
		  ,[Date Sent]
		  ,[Time Sent]
		  ,[BizTalk Sales Invoice]
		  ,[Customer Order No_]
		  ,[BizTalk Document Sent]
		  ,[Prepayment No_ Series]
		  ,[Prepayment Invoice]
		  ,[Prepayment Order No_]
		  ,[Quote No_]
		  ,[STE Transaction ID]
		  ,[Ship Complete]
		  ,[Order Reason]
	from fs1.[Katom2009].[dbo].[B&B Equipment & Supply Inc_$Sales Invoice Header]
	where [Document Date] > DATEADD(m, -12, GETDATE())
	
	insert into ship_backup
	select * from shiptracking.dbo.TrackingArchive
	where trackingno not in (select trackingno from ship_backup)
	
END
GO
/****** Object:  StoredProcedure [dbo].[ebayListing]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ebayListing] 
AS
BEGIN
	TRUNCATE TABLE ebayProdListing
	
	INSERT INTO ebayProdListing
	SELECT c.[ActionURL], c.[OfferName], ISNULL(c.[OfferDescription], c.[OfferName]) [OfferDescription], c.[ReferenceImageURL], c.[RegularPrice], 
		CASE 
			WHEN Custom6 = 0 AND p.freightOnly = '1' THEN 
				CASE
					WHEN ISNULL(p.clearance, 0) = 1 THEN
						CASE
							WHEN p.[salesPrice] BETWEEN 0 AND 500 THEN [CurrentPrice] + 150 
							WHEN p.[salesPrice] > 500 THEN [CurrentPrice] + 200
							ELSE p.[salesPrice]
						END
					WHEN c.[CurrentPrice] BETWEEN 0 AND 500 THEN [CurrentPrice] + 150
					WHEN c.[CurrentPrice] > 500 THEN [CurrentPrice] + 200
					ELSE c.[CurrentPrice]
				END				
			ELSE c.[CurrentPrice]
		END [CurrentPrice], 
		c.[Model], 
		CASE c.[InStock]
			WHEN 1 THEN '1 '
			ELSE '0 '
		END [InStock], 
		c.[Brand], c.[MerchantCategory], c.[Manufacturer], c.[ManufacturerModel], 
		[PromotionalText], 
		CASE 
			WHEN (prodL*prodH*prodW)/166 > c.[Weight] AND p.freightOnly = '0' THEN CAST((prodL*prodH*prodW)/166 AS DECIMAL(10, 2))+5
			ELSE c.[Weight]
		END [Weight], 
		c.[Condition], c.[Keywords], c.[Custom1], 
		c.[Custom2], c.[Custom3], c.[Custom4], c.[Custom5], c.[productCost], 
		CASE 
			WHEN Custom6 = 0 AND p.freightOnly = '1' AND c.[CurrentPrice] > 99.99 THEN 1
			ELSE c.[Custom6]
		END [Custom6], 
		c.[Custom7], c.[Custom8], c.[Custom9], c.[Custom10], 
		c.[Custom11], c.[custom12], 
		CASE 
			WHEN p.qtyOnHand = 0 THEN 1
			WHEN p.qtyOnHand > 5 THEN 5
			ELSE p.qtyOnHand
		END qtyonHand,
		uom, s.color, s.material, p.freightOnly,
		p.price [Offer Price], 0 --unlimitted
	FROM CAFeed c JOIN products p ON c.[Model] = p.CODE
				LEFT JOIN SLIFeed s ON s.[Product Number] = c.[Model]
	WHERE p.mfgID IN (SELECT mfgID FROM mfg WHERE ebay = 1 AND ACTIVE = 1)
		  AND CAST(c.[CurrentPrice] AS DECIMAL(10, 2)) > 25
	UNION
	SELECT c.[ActionURL], c.[OfferName], ISNULL(c.[OfferDescription], c.[OfferName]) [OfferDescription], c.[ReferenceImageURL], 
		c.[RegularPrice] + 25, 
		CASE 
			WHEN c.[CurrentPrice] < 10 THEN c.[CurrentPrice] + 10
			ELSE c.[CurrentPrice] + 15
		END , 
		c.[Model], '1 ' [InStock], c.[Brand], c.[MerchantCategory], 
		c.[Manufacturer], c.[ManufacturerModel], [PromotionalText], 
		CASE 
			WHEN (prodL*prodH*prodW)/166 > c.[Weight] AND p.freightOnly = '0' THEN CAST((prodL*prodH*prodW)/166 AS DECIMAL(10, 2))+5
			ELSE c.[Weight]
		END [Weight], 
		c.[Condition], c.[Keywords], c.[Custom1], c.[Custom2], c.[Custom3], c.[Custom4], c.[Custom5], c.[productCost],
		'1' [Custom6], c.[Custom7], c.[Custom8], c.[Custom9], c.[Custom10], c.[Custom11], c.[custom12],  
		CASE 
			WHEN p.qtyOnHand = 0 THEN 1
			WHEN p.qtyOnHand > 5 THEN 5
			ELSE p.qtyOnHand
		END qtyonHand,
		uom, s.color, s.material, p.freightOnly,
		p.price [Offer Price], 0 --unlimitted
	FROM CAFeed c JOIN products p ON c.[Model] = p.CODE
				LEFT JOIN SLIFeed s ON s.[Product Number] = c.[Model]
				LEFT JOIN products_Clearance cp ON p.code = cp.code
	WHERE p.qtyOnHand > 0
			  AND CAST(c.[CurrentPrice] AS DECIMAL(10, 2)) BETWEEN 0 AND 25
			  AND p.freightOnly = '0'
	UNION
	SELECT c.[ActionURL], c.[OfferName], ISNULL(c.[OfferDescription], c.[OfferName]) [OfferDescription], c.[ReferenceImageURL], c.[RegularPrice], 
		CASE 
			WHEN Custom6 = 0 AND p.freightOnly = '1' THEN 
				CASE
					WHEN ISNULL(p.clearance, 0) = 1 THEN
						CASE
							WHEN p.[salesPrice] BETWEEN 0 AND 500 THEN [CurrentPrice] + 150 
							WHEN p.[salesPrice] > 500 THEN [CurrentPrice] + 200
							ELSE p.[salesPrice]
						END
					WHEN c.[CurrentPrice] BETWEEN 0 AND 500 THEN [CurrentPrice] + 150
					WHEN c.[CurrentPrice] > 500 THEN [CurrentPrice] + 200
					ELSE c.[CurrentPrice]
				END				
			ELSE c.[CurrentPrice]
		END [CurrentPrice], 
		c.[Model], 
		CASE c.[InStock]
			WHEN 1 THEN '1 '
			ELSE '0 '
		END [InStock], 
		c.[Brand], c.[MerchantCategory], c.[Manufacturer], c.[ManufacturerModel], 
		[PromotionalText], 
		CASE 
			WHEN (prodL*prodH*prodW)/166 > c.[Weight] AND p.freightOnly = '0' THEN CAST((prodL*prodH*prodW)/166 AS DECIMAL(10, 2))+5
			ELSE c.[Weight]
		END [Weight], 
		c.[Condition], c.[Keywords], c.[Custom1], 
		c.[Custom2], c.[Custom3], c.[Custom4], c.[Custom5], c.[productCost], 
		CASE 
			WHEN Custom6 = 0 AND p.freightOnly = '1' AND c.[CurrentPrice] > 99.99 THEN 1
			ELSE c.[Custom6]
		END [Custom6], 
		c.[Custom7], c.[Custom8], c.[Custom9], c.[Custom10], 
		c.[Custom11], c.[custom12],  
		CASE 
			WHEN p.qtyOnHand = 0 THEN 1
			WHEN p.qtyOnHand > 5 THEN 5
			ELSE p.qtyOnHand
		END qtyonHand,
		uom, s.color, s.material, p.freightOnly,
		p.price [Offer Price], 0 --unlimitted
	FROM CAFeed c JOIN products p ON c.[Model] = p.CODE
				LEFT JOIN SLIFeed s ON s.[Product Number] = c.[Model]
				LEFT JOIN products_Clearance cp ON p.code = cp.code
	WHERE p.qtyOnHand > 0
		  AND CAST(c.[CurrentPrice] AS DECIMAL(10, 2)) > 25
	order by 1

	UPDATE e
	SET e.currentPrice = cast(p.MAP_Price as decimal(10, 2))
	from ebayprodlisting e join products p ON p.code = e.Model
	WHERE ISNULL(feedMAP, 0) = 1 AND  e.currentPrice > 24.99
		
	--REMOVE ALL SPECIAL ORDER 141
	DELETE FROM ebayprodlisting
	WHERE Model IN (select CODE	from products where ICDiscountGrp in ('141-NRA','141-PRO','141-SPEC') and qtyOnHand = 0)
	
	/**
	--SETTING FREIGHT ITEM TO FREE SHIPPING AND ADDING SHIPPING COST TO ITEMS ACCORDING TO THE VALUE OF THE SELLING PRICE
	update e
	set e.currentprice = 
			CASE 
				WHEN ISNULL(p.clearance, 0) = 1 THEN
					CASE
						WHEN p.[salesPrice] BETWEEN 0 AND 500 THEN [salesPrice] + 150 
						WHEN p.[salesPrice] > 500 THEN [salesPrice] + 200
						ELSE p.[salesPrice]
					END
				WHEN p.price BETWEEN 0 AND 500 THEN price + 150 
				WHEN p.price BETWEEN 500 AND 1500 THEN price + 200
				WHEN p.price > 1500 THEN price + 250 
				ELSE price
			END, 
		e.custom6 = 1
	from ebayProdListing e join products p on p.CODE = e.Model
	where p.freightOnly = '1' and freeShipping = 0

	update e
	set e.currentprice = 
			CASE 
				WHEN p.freeShipping = 1 THEN t.sellingPrice
				ELSE
					CASE	
						WHEN t.sellingPrice BETWEEN 0 AND 500 THEN t.sellingPrice + 150 
						WHEN t.sellingPrice BETWEEN 500 AND 1500 THEN t.sellingPrice + 200
						WHEN t.sellingPrice > 1500 THEN t.sellingPrice + 250 
						ELSE t.sellingPrice 
					END
				END,
		e.custom6 = 1
	from ebayProdListing e join trueSuperTrailer t on e.Model = t.code
							join products p on p.CODE = t.code
	where t.feedMAP = 0
	
	update e
	set e.currentprice = 
			CASE 
				WHEN p.freeShipping = 1 THEN t.displayPrice
				ELSE
					CASE	
						WHEN t.displayPrice BETWEEN 0 AND 500 THEN t.displayPrice + 150 
						WHEN t.displayPrice BETWEEN 500 AND 1500 THEN t.displayPrice + 200
						WHEN t.displayPrice > 1500 THEN t.displayPrice + 250 
						ELSE t.displayPrice 
					END
				END,
		e.custom6 = 1
	from ebayProdListing e join trueSuperTrailer t on e.Model = t.code
							join products p on p.CODE = t.code
	where t.feedMAP = 1
	**/
	
	UPDATE ebayProdListing SET regularPrice = CAST(2*currentPrice AS DECIMAL(10, 2)) WHERE regularPrice < CurrentPrice
	
	--SET WEIGHT TO 1 LB IF FREE FREIGHT
	UPDATE 	ebayprodlisting
	SET weight = 1
	WHERE custom6 = 1
	
	delete from ebayProdListing where Model like '599-%'
	
	delete from ebayProdListing where Model like '194-%'
	
	--REMOVE ALL BACKORDER PRODUCTS
	DELETE FROM ebayProdListing WHERE Model IN (select [No_] COLLATE Latin1_General_CS_AS from backOrder_item where DATEDIFF(day, [OldestOrderdt], getdate()) > 15 and price < 250)

	--REMOVE ALL VOLLRATH ITEMS WHERE COST < 100
	DELETE FROM ebayProdListing WHERE Model IN (SELECT CODE FROM products WHERE ACTIVE = 1 and mfgID = '175' and cost < 100 and qtyOnHand = 0)
	
	--LIMITTING OFFERNAME LENGTH TO 88 CHARACTERS AND CUT AT THE NEAREST SPACE
	UPDATE ebayProdListing
	SET offername = rtrim(left(offername, dbo.RCHARINDEX(' ', left(offername, 80), 0)))
	WHERE len(offername) > 88
	
	--SET LISTING TO NEVER EXPIRED IF THEY HAVE BEEN SALES WITHIN 180
	UPDATE e
	SET e.unlimitted = 1 
	FROM ebayProdListing e JOIN products p ON e.Model = p.CODE
	WHERE p.sales180 > 0	
	
	UPDATE e
	SET e.MerchantCategory = c.superCat
	FROM ebayProdListing e JOIN products p ON e.Model = p.CODE
						JOIN categories c ON c.CODE = p.primaryCatCode 
						
	--REMOVE ALL TUUCI PRODUCTS
	DELETE FROM CAFeed WHERE LEFT(model, 3) = '198'	
	DELETE FROM ebayProdListing WHERE LEFT(model, 3) = '198'
	
	--REMOVING ALL PRODUCTS THAT WE DON'T STOCK
	DELETE FROM ebayProdListing
	WHERE model IN (SELECT code FROM products WHERE active = 1 and qtyOnHand < 1);
	
END
GO
/****** Object:  StoredProcedure [dbo].[googleFeed_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[googleFeed_SP]
AS
BEGIN

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('GOOGLEBASE_FEED', GETDATE())
SET @jobID = @@identity

TRUNCATE TABLE googleBaseFeed

INSERT INTO googleBaseFeed
SELECT DISTINCT
	'New' [condition],
	CASE cast(p.prodDesc as varchar(max)) 
			WHEN NULL THEN ''
			WHEN '' THEN ''
			WHEN '#NAME?' THEN ''
			ELSE cast(p.prodDesc as varchar(max))
	END + ' ( ' + UPPER(dbo.cleaner(isnull(m.mfgName, ''))) + ' - ' + '%CODE%' + ' ) ' [description],
	REPLACE(REPLACE(isnull(m.mfgShortName, ''), ' ', '-'), '.', '') 
		+ '-' + REPLACE(dbo.[googleBaseMPNcleaner](p.mpn), '&', '-') [id],
	'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '.html' [link],
	cast(p.price as decimal(10, 2)) [price],
	dbo.cleaner(isnull(m.mfgShortName, '')) + ' ' + 
		CASE 
			WHEN CHARINDEX(' ', mpn) > 0 THEN dbo.[googleBaseMPNcleaner](LEFT(p.mpn, CHARINDEX(' ', mpn)-1))
			ELSE dbo.[googleBaseMPNcleaner](replace(p.mpn, '&', '-'))
		END + ' - ' + dbo.cleaner(p.Name) [title],
	dbo.cleaner(isnull(m.mfgName, '')) [brand],
	'http://' + p.mfgid + '.katomcdn.com/' + LOWER(p.image) + '_large.jpg'  [image_link],
	dbo.cleaner(REPLACE(REPLACE(isnull(m.mfgShortName, ''), ' ', '-'), '.', ''))
		+ '-' + REPLACE(dbo.[googleBaseMPNcleaner](p.mpn), '&', '-') [mpn],
	'' [product_type],
	p.weight [weight],
	cast(month(dateadd(day, 14, getdate())) as varchar(2)) + '/' + 
	cast(day(dateadd(day, 14, getdate())) as varchar(2)) + '/' + 
	cast(year(dateadd(day, 14, getdate())) as varchar(4)) [expiration_date],
	CASE p.freeshipping
		WHEN '1' THEN 1 
		WHEN 'T' THEN 1 
		ELSE 0 
	END [shipping],
	dbo.cleaner(p.keywords) [keywords],
	p.code, p.upc, 
	dbo.cleaner(isnull(c.superCat, 'uncat')) [Adwords_Grouping], 
	dbo.cleaner(ISNULL(c.CATNAME, 'uncat')) [adwords_labels],
	dbo.cleaner(isnull(c2.google, 'Home & Garden > Kitchen & Dining')) [google_product_category],
	'true' [adwords_publish],
	'' [adwords_redirect]	
FROM products p left join mfg m on p.mfgid = m.mfgid
				left join categories c on c.CODE = p.primaryCatCode AND c.primaryCat = 1
				left join cseCatMapping c2 on c.CODE = c2.catCode
WHERE p.active = 1 
	AND ISNULL(p.price, 0) > 0 
	AND p.feedMAP <> 3 
	AND ISNULL(p.MAP_Program, 'A') <> 'X'
	AND ISNULL(webactive, 0) = 1
	AND (CHARINDEX('-', p.mpn) > 0 
			OR CHARINDEX('.', p.mpn) > 0 
			OR CHARINDEX(' ', p.mpn) > 0 
			OR CHARINDEX('&', p.mpn) > 0 
			OR CHARINDEX('/', p.mpn) > 0)
UNION
SELECT DISTINCT
	'New' [condition],
	CASE cast(p.prodDesc as varchar(max)) 
			WHEN NULL THEN ''
			WHEN '' THEN ''
			WHEN '#NAME?' THEN ''
			ELSE cast(p.prodDesc as varchar(max))
	END + ' ( ' + UPPER(dbo.cleaner(isnull(m.mfgName, ''))) + ' - ' + '%CODE%' + ' ) ' [description],
	cast(p.mfgid as varchar(10)) + '-' + [dbo].[googleBaseMPNcleaner](p.mpn) [id],
	'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '.html' [link],
	cast(p.price as decimal(10, 2)) [price],
	dbo.cleaner(isnull(m.mfgShortName, '')) + ' ' + 
		CASE 
			WHEN CHARINDEX(' ', mpn) > 0 THEN dbo.[googleBaseMPNcleaner](LEFT(p.mpn, CHARINDEX(' ', mpn)-1))
			ELSE dbo.[googleBaseMPNcleaner](replace(p.mpn, '&', '-'))
		END + ' - ' + dbo.cleaner(p.Name) [title],
	dbo.cleaner(isnull(m.mfgName, '')) [brand],
	'http://' + p.mfgid + '.katomcdn.com/' + LOWER(p.image) + '_large.jpg' [image_link],
	cast(p.mfgid as varchar(10)) + '-' + [dbo].[googleBaseMPNcleaner](p.mpn) [mpn],
	'' [product_type],
	p.weight [weight],
	cast(month(dateadd(day, 14, getdate())) as varchar(2)) + '/' + 
	cast(day(dateadd(day, 14, getdate())) as varchar(2)) + '/' + 
	cast(year(dateadd(day, 14, getdate())) as varchar(4)) [expiration_date],
	CASE p.freeshipping
		WHEN '1' THEN 1 
		WHEN 'T' THEN 1 
		ELSE 0 
	END [shipping],
	dbo.cleaner(p.keywords) [keywords],
	p.code, p.upc, 
	dbo.cleaner(isnull(c.superCat, 'uncat')) [Adwords_Grouping], 
	dbo.cleaner(ISNULL(c.CATNAME, 'uncat')) [adwords_labels],
	dbo.cleaner(isnull(c2.google, 'Home & Garden > Kitchen & Dining')) [google_product_category],
	'true' [adwords_publish],
	'' [adwords_redirect]	
FROM products p left join mfg m on p.mfgid = m.mfgid
				left join categories c on c.CODE = p.primaryCatCode AND c.primaryCat = 1
				left join cseCatMapping c2 on c.CODE = c2.catCode
WHERE p.active = 1 
	AND ISNULL(p.price, 0) > 0 
	AND p.feedMAP <> 3 
	AND ISNULL(p.MAP_Program, 'A') <> 'X'
	AND ISNULL(webactive, 0) = 1
	AND (CHARINDEX('-', p.mpn) > 0 
			OR CHARINDEX('.', p.mpn) > 0 
			OR CHARINDEX(' ', p.mpn) > 0 
			OR CHARINDEX('&', p.mpn) > 0 
			OR CHARINDEX('/', p.mpn) > 0)
UNION
SELECT DISTINCT
	'New' [condition],
	CASE cast(p.prodDesc as varchar(max)) 
			WHEN NULL THEN ''
			WHEN '' THEN ''
			WHEN '#NAME?' THEN ''
			ELSE cast(p.prodDesc as varchar(max))
	END + ' ( ' + UPPER(dbo.cleaner(isnull(m.mfgName, ''))) + ' - ' + '%CODE%' + ' ) ' [description],
	dbo.[googleBaseMPNcleaner](REPLACE(cp.[mpn], '&', '-')) [id],
	'http://www.katom.com/' + LTRIM(RTRIM(p.code)) + '.html' [link],
	cast(p.price as decimal(10, 2)) [price],
	dbo.cleaner(isnull(m.mfgShortName, '')) + ' ' + 
		CASE 
			WHEN CHARINDEX(' ', p.mpn) > 0 THEN dbo.[googleBaseMPNcleaner](LEFT(p.mpn, CHARINDEX(' ', p.mpn)-1))
			ELSE dbo.[googleBaseMPNcleaner](replace(p.mpn, '&', '-'))
		END + ' - ' + dbo.cleaner(p.Name) [title],
	dbo.cleaner(isnull(m.mfgName, '')) [brand],
	'http://' + p.mfgid + '.katomcdn.com/' + LOWER(p.image) + '_large.jpg' [image_link],
	dbo.[googleBaseMPNcleaner](REPLACE(cp.[mpn], '&', '-')) [mpn],
	'' [product_type],
	p.weight [weight],
	cast(month(dateadd(day, 14, getdate())) as varchar(2)) + '/' + 
	cast(day(dateadd(day, 14, getdate())) as varchar(2)) + '/' + 
	cast(year(dateadd(day, 14, getdate())) as varchar(4)) [expiration_date],
	CASE p.freeshipping
		WHEN '1' THEN 1 
		WHEN 'T' THEN 1 
		ELSE 0 
	END [shipping],
	dbo.cleaner(p.keywords) [keywords],
	p.code, p.upc, 
	dbo.cleaner(isnull(c.superCat, 'uncat')) [Adwords_Grouping], 
	dbo.cleaner(ISNULL(c.CATNAME, 'uncat')) [adwords_labels],
	dbo.cleaner(isnull(c2.google, 'Home & Garden > Kitchen & Dining')) [google_product_category],
	'true' [adwords_publish],
	'' [adwords_redirect]
FROM products p left join mfg m on p.mfgid = m.mfgid
				left join categories c on c.CODE = p.primaryCatCode AND c.primaryCat = 1
				left join cseCatMapping c2 on c.CODE = c2.catCode
				join competitorRelatedProduct cp on cp.code = p.code
WHERE p.active = 1 
	AND ISNULL(p.price, 0) > 0 
	AND p.feedMAP <> 3 
	AND ISNULL(p.MAP_Program, 'A') <> 'X'
	AND ISNULL(webactive, 0) = 1

-- CLEAN UP BAD CONTENTS
DELETE FROM googlebasefeed WHERE [description] IS NULL
DELETE FROM googleBaseFeed WHERE id IS NULL
DELETE FROM googleBaseFeed WHERE link LIKE '%599-%'
DELETE FROM googleBaseFeed WHERE CHARINDEX(' ', link) > 0

UPDATE googleBaseFeed 
SET id = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(id, '(', ''), ')', ''), '/', ''), '&', ''), ' ', '-')

UPDATE googleBaseFeed 
SET [description] = Replace([description], dbo.returnHTMLTagWrapper([description], '<iframe'), '')
WHERE CHARINDEX('<iframe', [description]) > 0

UPDATE googleBaseFeed 
SET [description] = dbo.cleaner(REPLACE([description], '%CODE%', [mpn]))
WHERE CHARINDEX('%CODE%', [description]) > 0

UPDATE googleBaseFeed 
SET [description] = RTRIM(REPLACE(REPLACE([description], '&AMP', '&amp;'), ';;', ';')) 

WHILE exists(SELECT * FROM googleBaseFeed WHERE CHARINDEX('  ', title) > 0)
   BEGIN
	UPDATE googleBaseFeed SET title = REPLACE(title, '  ', ' ') WHERE CHARINDEX('  ', title) > 0
   END

WHILE exists(SELECT * FROM googleBaseFeed WHERE CHARINDEX('  ', description) > 0)
   BEGIN
    UPDATE googleBaseFeed SET description = REPLACE(description, '  ', ' ') where CHARINDEX('  ', description) > 0
   END

--ADDING DUP PROD WITH DIFF VARIATION OF PROD ID

UPDATE googleBaseFeed
SET id = RTRIM(id) + ' ' + REPLACE(
		REPLACE(REPLACE(REPLACE(link, 'http://www.katom.com/', ''), '.html', ''), '-', ''),
		REPLACE(REPLACE(id, '-', ''), ' ', ''),
		'')
WHERE id IN 
	(
	SELECT id FROM googlebasefeed
	GROUP BY id
	HAVING COUNT(*) > 1
	)

DELETE FROM googleBaseFeed 
WHERE id IN 
	(
	SELECT id FROM googlebasefeed
	GROUP BY id
	HAVING COUNT(*) > 1
	)

--MAP POLICY
UPDATE g
SET g.price = 		
		CASE
			WHEN ISNULL(p.map, 0) = 1 THEN 
				CASE 
					WHEN ISNULL(p.feedMap, 0) = 1 THEN 
						CASE
							WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN cast(p.price as decimal(10, 2))
							ELSE CAST(p.map_price AS DECIMAL(10, 2))
						END
					ELSE cast(p.price as decimal(10, 2))
				END
			--WHEN ISNULL(P.clearance, 0) = 1 THEN cast(p.salesPrice as decimal(10, 2))
			ELSE cast(p.price as decimal(10, 2))
		END
FROM googleBaseFeed g join products p on g.Code = p.code

UPDATE googleBaseFeed
SET  description = REPLACE(REPLACE(replace(description, '21-30 day lead time.', ''), '14-21 day lead time.', ''), '(3 WEEK SHIP)', '')
where CHARINDEX('day lead time.', description) > 0

--POPULATING PRODUCT_TYPE
UPDATE g
SET g.product_type = ISNULL(dbo.breadcrumb(p.primaryCatCode), 'Restaurant Supplies')
FROM googleBaseFeed g JOIN products p ON g.Code = p.CODE

UPDATE googleBaseFeed
SET product_type = dbo.cleaner(product_type)

--REMOVING ALL PRODUCTS WITH BAD PRODUCT CODE
DELETE FROM  googleBaseFeed
WHERE dbo.isAlphaNumberic(REPLACE(REPLACE(REPLACE(link, 'http://www.katom.com/', ''), '.html', ''), '-', '')) = 0

--ADD TAGGING TO NATURAL AND REDIRECT URL
UPDATE googleBaseFeed
SET link = link + '?CID=GoogleBase2&amp;utm_source=googlebase2&amp;utm_medium=CSE&amp;utm_campaign=CSE&amp;zmam=29342707&amp;zmas=1&amp;zmac=1&amp;zmap=' + code,
	adwords_redirect = link + '?utm_source=googlebase2&amp;utm_medium=Adwords&amp;utm_campaign=CSE&amp;CID=googlebase2&amp;zmam=29342707&amp;zmas=1&amp;zmac=32&amp;zmap=' + code

--delete from googleBaseFeed where link like '%http://www.katom.com/598-T49.html%'
delete from googleBaseFeed where id = 'TRUE-Refrigeration-T-49'

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[feedAmazon_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[feedAmazon_SP]
 @price money -- MIN  VALUE WE WANT TO INCLUDE IN THE FEED
AS
BEGIN	
	SELECT ISNULL(dbo.breadcrumb(primarycatcode), 'Kitchen Supply & Equipment') category,
		p.mfgName + ' ' + p.mpn + ' ' + p.Name + ', ' + p.uom title,
		'http://www.katom.com/' + p.CODE 
			+ '.html?CID=Amazon&utm_source=Amazon& utm_medium=CSE& utm_campaign=CSE&zmam=29342707&zmas=1&zmac=9&zmap=' 
			+ p.CODE link,
		p.CODE sku, 		
		CASE
			WHEN ISNULL(p.map, 0) = 1 THEN 
				CASE 
					WHEN ISNULL(p.feedMap, 0) = 1 THEN 
						CASE
							WHEN ISNULL(p.MAP_Program, 'K') = 'K' THEN CAST(p.price AS DECIMAL(10, 2))
							ELSE CAST(p.map_price AS DECIMAL(10, 2))
						END
					ELSE CAST(p.price AS DECIMAL(10, 2))
				END
			ELSE CAST(p.price AS DECIMAL(10, 2))
		END price,
		p.mfgName Brand,
		'http://' + p.mfgid + '.katomcdn.com/' + LOWER(p.image) + '_large.jpg' [image],
		REPLACE(REPLACE(CAST(p.prodDesc AS VARCHAR(MAX)), CHAR(10), ''), CHAR(13), '') [description],
		p.mfgName manufacturer,
		p.mpn [mfr part number],
		CASE 
			WHEN p.freeShipping = 1 THEN CAST(0 AS VARCHAR(1))
			ELSE ''
		END [shipping cost],
		p.mfgName + ' ' + p.mpn + ' ' + p.NAME [bullet point1],
		CAST(p.prodH AS DECIMAL(10, 2)) Height,		
		CASE 
			WHEN p.uom = 'each' THEN 1
			WHEN p.uom = 'Set' THEN 1
			WHEN p.uom = 'Pair' THEN 1
			WHEN p.uom = 'Pack' THEN 1
			WHEN p.uom = 'Bag' THEN 1
			WHEN p.uom = 'Box' THEN 1
			WHEN p.uom = 'Roll' THEN 1
			WHEN p.uom = 'Case' THEN 1
			WHEN p.uom = 'bottle' THEN 1
			WHEN p.uom = 'dozen' THEN 12
			WHEN p.uom LIKE '%Gallon' THEN 1
			WHEN p.uom LIKE '%each' THEN CAST(REPLACE(p.uom, 'each', '') AS INT)
			WHEN p.uom LIKE '%set' THEN CAST(REPLACE(p.uom, 'set', '') AS INT)
			WHEN p.uom LIKE '%Pair' THEN CAST(REPLACE(p.uom, 'Pair', '') AS INT)
			WHEN p.uom LIKE '%Roll' THEN CAST(REPLACE(p.uom, 'Roll', '') AS INT)
			WHEN p.uom LIKE '%Pack' THEN CAST(REPLACE(p.uom, 'Pack', '') AS INT)
			WHEN p.uom LIKE '%bottle' THEN CAST(REPLACE(p.uom, 'bottle', '') AS INT)
			WHEN p.uom LIKE 'case of%' THEN CAST(REPLACE(p.uom, 'case of', '') AS INT)
			WHEN p.uom LIKE 'pack of%' THEN CAST(REPLACE(p.uom, 'pack of', '') AS INT)
			WHEN p.uom LIKE 'set of%' THEN CAST(REPLACE(p.uom, 'set of', '') AS INT)
			WHEN p.uom LIKE 'box of%' THEN CAST(REPLACE(p.uom, 'box of', '') AS INT)
			WHEN p.uom LIKE '%dozen' THEN CAST(REPLACE(p.uom, 'dozen', '') AS INT)*12
			WHEN p.uom LIKE '%pack of%'
				THEN LEFT(REPLACE(p.uom, 'pack of', ''), CHARINDEX(' ', REPLACE(p.uom, 'pack of', ''))) 
					* CAST(RIGHT(REPLACE(p.uom, 'pack of', ''), LEN(REPLACE(p.uom, 'pack of', '')) - CHARINDEX(' ', REPLACE(p.uom, 'pack of', ''))) AS INT)		
			WHEN p.uom LIKE '%box of%'
				THEN LEFT(REPLACE(p.uom, 'box of', ''), CHARINDEX(' ', REPLACE(p.uom, 'box of', ''))) 
					* CAST(RIGHT(REPLACE(p.uom, 'box of', ''), LEN(REPLACE(p.uom, 'box of', '')) - CHARINDEX(' ', REPLACE(p.uom, 'box of', ''))) AS INT)		
			WHEN p.uom LIKE '%set of%'
				THEN LEFT(REPLACE(p.uom, 'set of', ''), CHARINDEX(' ', REPLACE(p.uom, 'set of', ''))) 
					* CAST(RIGHT(REPLACE(p.uom, 'set of', ''), LEN(REPLACE(p.uom, 'set of', '')) - CHARINDEX(' ', REPLACE(p.uom, 'set of', ''))) AS INT)				
			ELSE 1
		END [Item package quantity],
		LEFT(p.keywords, 50) Keywords1,
		CAST(p.prodL AS DECIMAL(10, 2)) [Length],
		ISNULL(c.amazon, 289814) [Recommended Browse Node],
		CAST(p.WEIGHT AS DECIMAL(10, 2)) [Shipping Weight],
		p.prodW [Width]		
	FROM products p LEFT JOIN cseCatMapping c ON p.primaryCatCode = c.catCode
	WHERE p.active = 1 AND p.isWeb = 1 AND p.price > @price AND p.image NOT LIKE '%logo'
		AND p.CODE NOT IN (select [No_] COLLATE Latin1_General_CS_AS from backOrder_item where DATEDIFF(day, [OldestOrderdt], getdate()) > 15 and price < 250)
		AND ISNULL(MAP_Program, '') NOT IN ('X')
		AND p.IMAGE NOT LIKE '%logo'
		AND ISNULL(feedMAP, 1) NOT IN (3)
		AND p.CODE NOT IN (SELECT code 
							FROM products
							WHERE active = 1 AND isWeb = 1
								AND price < 100
								AND avgLeadTime is null 
								AND qtyOnHand < 1
								and leadTime_mfg like '%14+%'
							)
END
GO
/****** Object:  StoredProcedure [dbo].[productActiveStat_rpt]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[productActiveStat_rpt]
AS
BEGIN
	EXEC productActiveStat;
	
	SELECT ISNULL(numProdInNAV, 0) numProdInNAV, 
		ISNULL(discontinuedNAV, 0) discontinuedNAV,  
		ISNULL(webItemNAV, 0) webItemNAV,  
		ISNULL(notCatNAV, 0) notCatNAV,  
		ISNULL(liveOnWeb, 0) liveOnWeb,  
		ISNULL(discontinuedButActive, 0) discontinuedButActive,  
		ISNULL(notCatOnWEB, 0) notCatOnWEB, 
		ISNULL(webItemNAV+discontinuedButActive, 0) [webanddisc], 
		ISNULL(numProdInNAV-discontinuedNAV, 0) [activeProdNAV]
	FROM productStat  
	ORDER BY mfgid
END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportTestINTL]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImportTestINTL]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdr_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdr
*/

--SELECT * FROM order_hdr_bkp
--DELETE FROM order_hdr_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdr

UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail,shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount)

SELECT * FROM openquery(MYSQL, '
		SELECT  id as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		ship_email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		ship_fax as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		upper(bill_email) as selltoemail,
		upper(concat(bill_fname,'' '',bill_lname)) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM katom_mm5.s01_OrderCharges where order_id = customerpo
         and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as method,
		(SELECT amount FROM katom_mm5.s01_OrderCharges where order_id = customerpo
		 and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as amount		
		FROM katom_mm5.s01_Orders where batch_id = 2')

  
  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = RIGHT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		upsold,
		quantity	
		FROM katom_mm5.s01_OrderItems
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount,
		disp_amt,
		tax_exempt
		FROM katom_mm5.s01_OrderCharges
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM katom_mm5.s01_OrderOptions
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(MYSQL, '
		SELECT order_id,
		charge_id as line_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount
		FROM katom_mm5.s01_OrderCharges
		where module_id in (1001, 186)
		and order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')
	

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 2') 
	SET batch_id = '1';

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo FROM order_hdr WHERE exported = 0

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparse @Order	
		FETCH NEXT FROM DemoCursor INTO @Order
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor

/*Display the gathered header information*/
SELECT * FROM order_hdr

/*Display the gathered line item information with customer info*/
SELECT * FROM order_hdr
join order_items
ON order_id = customerpo
order by order_id

select name, attr_code, opt_code from order_options o
join order_items i 
on i.order_id = o.order_id and i.line_id = o.line_id

exec CvcImport

END
GO
/****** Object:  StoredProcedure [dbo].[product_categorization_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[product_categorization_SP]
	@type VARCHAR(20)
AS
BEGIN
	DECLARE @pCode VARCHAR(1000), @cName VARCHAR(1000), @cCode VARCHAR(1000)

	IF @type = 'INCREMENTAL'
	   BEGIN
		UPDATE p
		SET p.catCode = NULL, p.categories = NULL
		FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
		WHERE DATEDIFF(DAY, i.[Last Date Modified], GETDATE()) = 0

		DECLARE cCursor CURSOR FOR 
		SELECT prodCode, catCode
		FROM catxProd cx JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON cx.prodCode = i.[No_] COLLATE Latin1_General_CS_AS
		WHERE DATEDIFF(DAY, i.[Last Date Modified], GETDATE()) = 0
		GROUP BY prodCode, catCode
		ORDER BY prodCode

		OPEN cCursor
		FETCH NEXT FROM cCursor INTO @pCode, @cCode

		WHILE @@FETCH_STATUS = 0
		   BEGIN
			SELECT @cName = CATNAME FROM categories WHERE code = @cCode
			
			UPDATE products
			SET catCode = 
					CASE	
						WHEN catCode IS NULL THEN @cCode
						ELSE catCode + ', ' + @cCode
					END,
				categories = 
					CASE	
						WHEN categories IS NULL THEN @cName
						ELSE categories + '|' + @cName
					END
			WHERE CODE = @pCode	
		   
			FETCH NEXT FROM cCursor INTO @pCode, @cCode
		   END
		   
		CLOSE cCursor
		DEALLOCATE cCursor
	   END
	ELSE
	   BEGIN
		UPDATE p
		SET p.catCode = NULL, p.categories = NULL
		FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS

		DECLARE cCursor CURSOR FOR 
		SELECT prodCode, catCode
		FROM catxProd cx JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON cx.prodCode = i.[No_] COLLATE Latin1_General_CS_AS
		GROUP BY prodCode, catCode
		ORDER BY prodCode

		OPEN cCursor
		FETCH NEXT FROM cCursor INTO @pCode, @cCode

		WHILE @@FETCH_STATUS = 0
		   BEGIN
			SELECT @cName = CATNAME FROM categories WHERE code = @cCode
			
			UPDATE products
			SET catCode = 
					CASE	
						WHEN catCode IS NULL THEN @cCode
						ELSE catCode + ', ' + @cCode
					END,
				categories = 
					CASE	
						WHEN categories IS NULL THEN @cName
						ELSE categories + '|' + @cName
					END
			WHERE CODE = @pCode	
		   
			FETCH NEXT FROM cCursor INTO @pCode, @cCode
		   END
		   
		CLOSE cCursor
		DEALLOCATE cCursor
	   END
	   
	   EXEC dbo.[product_categorization_holiday_SP]
END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImportBKP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[RemoteOrderImportBKP]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdr_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdr
*/

--SELECT * FROM order_hdr_bkp
--DELETE FROM order_hdr_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdr

UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail,shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount)

SELECT * FROM openquery(MYSQL, '
		SELECT  id as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		ship_email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		ship_fax as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		upper(bill_email) as selltoemail,
		upper(concat(bill_fname,'' '',bill_lname)) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM katom_mm5.s01_OrderCharges where order_id = customerpo
         and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as method,
		(SELECT amount FROM katom_mm5.s01_OrderCharges where order_id = customerpo
		 and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as amount		
		FROM katom_mm5.s01_Orders where batch_id = 2')

  
  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = RIGHT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		upsold,
		quantity	
		FROM katom_mm5.s01_OrderItems
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount,
		disp_amt,
		tax_exempt
		FROM katom_mm5.s01_OrderCharges
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM katom_mm5.s01_OrderOptions
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(MYSQL, '
		SELECT order_id,
		charge_id as line_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount
		FROM katom_mm5.s01_OrderCharges
		where module_id in (1001, 186)
		and order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')
	

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 2') 
	SET batch_id = '1';

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo FROM order_hdr WHERE exported = 0

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparse @Order	
		FETCH NEXT FROM DemoCursor INTO @Order
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor

/*Display the gathered header information*/
SELECT * FROM order_hdr

/*Display the gathered line item information with customer info*/
SELECT * FROM order_hdr
join order_items
ON order_id = customerpo
order by order_id

select name, attr_code, opt_code from order_options o
join order_items i 
on i.order_id = o.order_id and i.line_id = o.line_id

exec CvcImport

END
GO
/****** Object:  StoredProcedure [dbo].[sitemap_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sitemap_SP]
AS
BEGIN

DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('SITEMAP_FEED', GETDATE())
SET @jobID = @@identity

DECLARE @code VARCHAR(100), @string VARCHAR(1000), @frequency VARCHAR(50), @date VARCHAR(16), @updateDT DATETIME, @counter INT, @page INT, @priority float
DECLARE @month VARCHAR(2), @day VARCHAR(2), @year VARCHAR(4), @type VARCHAR(20), @order INT, @target INT, @currentType VARCHAR(50), @url VARCHAR(255)

DECLARE @index VARCHAR(10), @count INT, @pageType VARCHAR(25), @dow INT, @pagenum INT

SET @counter = 0
SET @page = 1
SET @target = 50000
SET @currentType = 'David'
SET @dow = DATEPART(WEEKDAY, GETDATE())

--DELETING ENTRY FROM URLERROR IF IT IS OLDER THAN 7 DAYS
DELETE FROM urlError WHERE DATEDIFF(DAY, insertDT, GETDATE()) > 14

--IDENTIFYING THE NUMBER OF PAGES NEEDED FOR FULL PROD LIST
SELECT @pagenum = 
	CASE
	  WHEN COUNT(*)%50000 > 0 THEN 1 + COUNT(*)/50000
	  ELSE COUNT(*)/50000
	END
FROM products
WHERE active = 1 and isWeb = 1

TRUNCATE TABLE sitemap2

IF @dow BETWEEN 2 AND 6
   BEGIN
	SELECT @target = COUNT(*)/@pagenum + COUNT(*)%@pagenum FROM PRODUCTS WHERE active = 1 AND isWeb = 1 AND DATEDIFF(day, updateDT, GETDATE()) < 8			
	
	DECLARE sCursor CURSOR FOR 
	SELECT code, url, .5, 'CAT', 2 FROM categories WHERE active = 1 AND URL IS NOT NULL 
	UNION
	SELECT code, 'http://www.katom.com/' + code + '.html' url, 
			CASE
				WHEN DATEDIFF(DAY, updatedt, GETDATE()) < 30 THEN .9
				ELSE .7
			END, 'PROD', 1 
	FROM PRODUCTS WHERE active = 1 AND isWeb = 1 AND DATEDIFF(day, updateDT, GETDATE()) < 8
	UNION
	SELECT code, dbo.[asciiConverter](url), .9, 'OTHER', 3 FROM urlError
	ORDER BY 5, 3 desc
   END
ELSE
  BEGIN
	
	DECLARE sCursor CURSOR FOR 
	SELECT code, url, .5, 'CAT', 2 FROM categories WHERE active = 1 AND URL IS NOT NULL
	UNION
	SELECT code, 'http://www.katom.com/' + code + '.html' url, 
			CASE
				WHEN DATEDIFF(DAY, updatedt, GETDATE()) < 30 THEN .9
				ELSE .7
			END, 'PROD', 1 
	FROM PRODUCTS WHERE active = 1 AND isWeb = 1
	UNION
	SELECT code, dbo.[asciiConverter](url), .9, 'OTHER', 3 FROM urlError
	ORDER BY 5, 3 desc
  
  END
OPEN sCursor
FETCH NEXT FROM sCursor INTO @code, @url, @priority, @type, @order

WHILE @@FETCH_STATUS = 0
   BEGIN
	SET @string = '	<url>
		<loc>%CODE%</loc>
		<changefreq>%FREQUENCY%</changefreq>
		<lastmod>%DATE%</lastmod>
		<priority>%PRIORITY%</priority>
	</url>'
	SET @counter = @counter + 1
	IF (@currentType = 'David')
	   BEGIN
		SET @currentType = @type
	   END
	   
	IF @type = 'CAT' 
	   BEGIN
		SET @updateDT = DATEADD(DAY, -1, GETDATE())			
		SET @frequency = 'weekly'
	   END
	ELSE
	   BEGIN
		SELECT @updateDT = ISNULL(updateDT, DATEADD(DAY, -7, GETDATE())) FROM products WHERE code = @code
		SET @frequency = 'daily'
		
		IF DATEDIFF(DAY, @updateDT, getdate()) > 7
			SET @updateDT = DATEADD(DAY, -7, GETDATE())	
	   END
	
	SET @year = CAST(YEAR(@updateDT) AS VARCHAR(4))
		
	IF MONTH(@updateDT) < 10 
		SET @month = '0' + CAST(MONTH(@updateDT) AS VARCHAR(4))
	ELSE
		SET @month = CAST(MONTH(@updateDT) AS VARCHAR(4))
	
	IF DAY(@updateDT) < 10 
		SET @day = '0' + CAST(DAY(@updateDT) AS VARCHAR(4))
	ELSE
		SET @day = CAST(DAY(@updateDT) AS VARCHAR(4))	

	SET @date = @year + '-' + @month + '-' + @day

	SET @string = REPLACE(@string, '%CODE%', @url)
	SET @string = REPLACE(@string, '%FREQUENCY%', @frequency)
	SET @string = REPLACE(@string, '%DATE%', @date)
	SET @string = REPLACE(@string, '%PRIORITY%', @priority)
	
	/** 
	-- THIS IS TO ONLY LIMIT THE NUMBER OF LISTING PER FILE

	IF @type <> @currentType
		BEGIN
			SET @counter = 1
			SET @currentType = @type
			SET @page = 1			
		END
	ELSE 
		BEGIN
			IF @counter = @target 
			   BEGIN
				SET @counter = 1
				SET @page = @page + 1
			   END	
		END
	**/
	
	IF @type <> @currentType
		BEGIN
			SET @counter = 1
			SET @currentType = @type
			SET @page = 1			
		END
	ELSE 
	   BEGIN
		IF @type = 'PROD'
		   BEGIN
			IF @counter = @target 
			   BEGIN
				SET @counter = 1
				SET @page = @page + 1
			   END			
		   END 	   
	   END
	
	INSERT INTO sitemap2([content], pageNum, pagetype, priority) VALUES(@string, @page, @type, @order)

	FETCH NEXT FROM sCursor INTO @code, @url, @priority, @type, @order
   END

CLOSE sCursor
DEALLOCATE sCursor	

--REMOVING HENNY PENNY
DELETE FROM sitemap2 
WHERE pagetype = 'cat'
	AND [content] LIKE '%henny-penny%'

DELETE FROM sitemap2 
WHERE pagetype = 'Prod'
	AND [content] LIKE '%www.katom.com/540-%'

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

--SET PRIORITY TO 7 FOR FIRST SITEMAP PAGE
UPDATE sitemap2
SET [Content] = REPLACE([Content], '<priority>0.6</priority>', '<priority>0.7</priority>')
WHERE id < 5000

--SET PRIORITY TO 8 FOR ALL TRUE PAGES
UPDATE sitemap2
SET [Content] = REPLACE([Content], '<priority>0.6</priority>', '<priority>0.8</priority>')
WHERE [Content] LIKE '%http://www.katom.com/598-%'


--INSERTING OTHER PAGES
SET @updateDT = GETDATE()

TRUNCATE TABLE sitemapWorktable

INSERT INTO sitemapWorktable
SELECT LEFT([name], 1), 0, 'products'
FROM Products
WHERE active = 1 AND dbo.isAlphaNumberic(LEFT([name], 1)) = 1 AND isWeb = 1 AND LEN(LEFT([name], 1)) > 0
GROUP BY LEFT([name], 1)
UNION
SELECT LEFT(CATNAME, 1), COUNT(*), 'categories'
FROM categories
WHERE active = 1 AND isnumeric(LEFT(CATNAME, 1)) = 0 AND LEN(LEFT(CATNAME, 1)) > 0
GROUP BY LEFT(CATNAME, 1)
ORDER BY 3, 1

--SPECIAL CASE FOR CATEGORIES
INSERT INTO sitemapWorktable VALUES('0-9', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND ISNUMERIC(LEFT(CATNAME, 1)) = 1), 'categories')

--SPECIAL CASE FOR BRANDS
INSERT INTO sitemapWorktable VALUES('0-9', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND isnumeric(LEFT(CATNAME, 1)) = 1), 'brANDs')
INSERT INTO sitemapWorktable VALUES('A-C', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'A' AND 'C'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('D-F', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'D' AND 'F'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('G-I', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'G' AND 'I'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('J-L', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'J' AND 'L'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('M-O', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'M' AND 'O'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('P-R', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'P' AND 'R'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('S-U', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'S' AND 'U'), 'brANDs')
INSERT INTO sitemapWorktable VALUES('V-Z', (SELECT COUNT(*) FROM categories WHERE ACTIVE = 1 AND vendor = 1 AND PARENT_ID = 5844 AND LEFT(CATNAME, 1) BETWEEN 'V' AND 'Z'), 'brANDs')

/**
DECLARE catCursor CURSOR FOR 
select LEFT([name], 1), COUNT(*)
FROM Products
WHERE active = 1 AND isWeb = 1
group by LEFT([name], 1)
order by 1

OPEN catCursor
FETCH NEXT FROM catCursor INTO @index, @count

WHILE @@FETCH_STATUS = 0
   BEGIN
	
	IF dbo.isAlphaNumberic(@index) = 0
		UPDATE sitemapWorktable SET countTT = countTT + @count WHERE myIndex = '0'
		
	UPDATE sitemapWorktable SET countTT = countTT + @count WHERE myIndex = @index AND pageType = 'products'	
		
	FETCH NEXT FROM catCursor INTO @index, @count
   END

CLOSE catCursor
DEALLOCATE catCursor

DECLARE catCursor CURSOR FOR 
SELECT myIndex,
	CASE
		WHEN countTT%100 > 0 THEN (countTT/100)+1
		ELSE countTT/100
	END, pageType
FROM sitemapWorktable
WHERE countTT > 0
ORDER BY 3, 1

OPEN catCursor
FETCH NEXT FROM catCursor INTO @index, @count, @pageType

WHILE @@FETCH_STATUS = 0
   BEGIN
	SET @string = '	<url>
		<loc>%CODE%</loc>
		<changefreq>%FREQUENCY%</changefreq>
		<lastmod>%DATE%</lastmod>
		<priority>%PRIORITY%</priority>
	</url>'
	SET @year = CAST(YEAR(@updateDT) AS VARCHAR(4))
		
	IF MONTH(@updateDT) < 10 
		SET @month = '0' + CAST(MONTH(@updateDT) AS VARCHAR(4))
	ELSE
		SET @month = CAST(MONTH(@updateDT) AS VARCHAR(4))
	
	IF DAY(@updateDT) < 10 
		SET @day = '0' + CAST(DAY(@updateDT) AS VARCHAR(4))
	ELSE
		SET @day = CAST(DAY(@updateDT) AS VARCHAR(4))	

	SET @date = @year + '-' + @month + '-' + @day
	
	WHILE (@count > 0)
	   BEGIN
		SET @url = 'http://www.katom.com/' + @pageType + '.' + @index + '.' + cast(@count as VARCHAR(10)) + '.html'
		SET @count = @count - 1
		
		SET @string = REPLACE(@string, '%CODE%', @url)
		SET @string = REPLACE(@string, '%FREQUENCY%', 'daily')
		SET @string = REPLACE(@string, '%DATE%', @date)
		SET @string = REPLACE(@string, '%PRIORITY%', '.6')
		
		INSERT INTO sitemap2([content], pageNum, pagetype, priority) VALUES(@string, 1, 'OTHER', 3)
		
		SET @string = '	<url>
		<loc>%CODE%</loc>
		<changefreq>%FREQUENCY%</changefreq>
		<lastmod>%DATE%</lastmod>
		<priority>%PRIORITY%</priority>
	</url>'
	   END
		
    
	FETCH NEXT FROM catCursor INTO @index, @count, @pageType
   END

CLOSE catCursor
DEALLOCATE catCursor
**/
DELETE FROM sitemap2 WHERE content LIKE '%599-%'

END
GO
/****** Object:  StoredProcedure [dbo].[ups_tracking]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[ups_tracking]
AS
BEGIN
	DELETE FROM upsFile WHERE [Subscriber ID] = 'Subscriber ID'

	INSERT INTO upsworldship
	SELECT 
		[Tracking Number], [Query Begin Date], [Query End Date], [Record Type], [Shipper Number], [Shipper Name], 
		[Shipper City], [Shipper State Province], [Shipper Postal Code], [Shipper Country], [Ship To Attention], 
		[Ship To Phone], [Ship To Name], [Ship To Address Line 1], [Ship To Address Line 2], 
		[Ship To Address Line 3], [Ship To City], [Ship To State Province], [Ship To Postal Code], 
		[Ship To Country], 
		CASE 
			WHEN LEN([Shipment Reference Number Value 1]) > 0 THEN [Shipment Reference Number Value 1]
			ELSE [Package Reference Number Value 1]
		END	[Shipment Reference Number Value 1], 
		CASE 
			WHEN LEN([Shipment Reference Number Value 2]) > 0 THEN [Shipment Reference Number Value 2]
			ELSE [Package Reference Number Value 2]
		END	[Shipment Reference Number Value 2],
		[UPS Service], [Pickup Date], [Scheduled Delivery Date], [Scheduled Delivery Time], [Document Type], [Package Activity Date], 
		[Package Activity Time], [Package Count], [Package Dimensions Unit of Measurement], [Length], [Width], [Height], 
		[Package Dimensional Weight], [Package Weight], [Large Package], [Earliest Delivery Time], [Hold For Pickup], 
		[Saturday Delivery Indicator],[Special Instructions], [UPS Location], [UPS Location State Province], 
		[UPS Location Country], [Updated Ship To Name], [Updated Ship To Street Number], [Updated Ship To Street Prefix], 
		[Updated Ship To Street Name], [Updated Ship To Street Type], [Updated Ship To Street Suffix], [Updated Ship To Building Name], 
		[Updated Ship To Room Suite Floor], [Updated Ship To Political Division 3], [Updated Ship To City], [Updated Ship To State Province], 
		[Updated Ship To Country], [Updated Ship To Postal Code], [Exception Status Description], [Exception Reason Description], 
		[Exception Resolution Type], [Exception Resolution Description], [Rescheduled Delivery Date], [Rescheduled Delivery Time], 
		[Driver Release], [Delivery Location], [Delivery Name], [Delivery Street Number], [Delivery Street Prefix], [Delivery Street Name], 
		[Delivery Street Type], [Delivery Street Suffix], [Delivery Building Name], [Delivery Room Suite Floor], [Delivery Political Division 3], 
		[Delivery City], [Delivery State Province], [Delivery Country], [Delivery Postal Code], [Residential Address], [Signed For By],		
		CASE
			WHEN LEN([Shipment Reference Number Value 1]) > 0 
					THEN dbo.[tracking_orderNo]([Shipper Number], [Shipment Reference Number Value 1], [Shipment Reference Number Value 2])
			ELSE dbo.[tracking_orderNo]([Shipper Number], [Package Reference Number Value 1], [Package Reference Number Value 2])
		END,
		NULL, GETDATE(), [Driver Release], [Signed For By], 0,  
		CASE [Subscription Name]
			WHEN 'Outbound_Katom' THEN ''
			ELSE 
				CASE
					WHEN LEN([Shipment Reference Number Value 1]) > 0 
							THEN dbo.[tracking_PONo]([Shipper Number], [Shipment Reference Number Value 1], [Shipment Reference Number Value 2])
					ELSE dbo.[tracking_PONo]([Shipper Number], [Package Reference Number Value 1], [Package Reference Number Value 2])
				END			
		END
	FROM upsFile
	WHERE [record type] in ('M1', 'M2')
		AND [Tracking Number] NOT IN (SELECT [Tracking Number] FROM upsworldship)
				
	--REMOVE DUPLICATE
	DECLARE @ID int, @trackingNum varchar(100), @trackingNum2 varchar(100)

	SET @trackingNum2 = 'DAVIDLU'

	DECLARE catCursor CURSOR FOR 
	SELECT ID, [Tracking Number]
	FROM upsworldship
	WHERE [Tracking Number] IN 
		(SELECT [Tracking Number]
		FROM upsworldship
		GROUP BY [Tracking Number]
		HAVING COUNT(*) >1)
	ORDER BY [Tracking Number], id

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @ID, @trackingNum

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF @trackingNum2 = @trackingNum
		   BEGIN
			DELETE FROM upsworldship WHERE id = @ID
		   END   
		ELSE 
		  BEGIN
			SET @trackingNum2 = @trackingNum
		  END

		FETCH NEXT FROM catCursor INTO @ID, @trackingNum
	END

	CLOSE catCursor
	DEALLOCATE catCursor

	--REMOVE ALL THE NEW INSERTED RECORDS FROM UPSFILE TBL
	DELETE FROM upsfile 
	WHERE [record type] IN ('M1', 'M2') 
			AND [Tracking Number] IN (SELECT [Tracking Number] FROM upsworldship WHERE DATEDIFF(DAY, GETDATE(), UpdateDT) = 0) 

	--UPDATE CURRENT TRACKING INFO
	DECLARE catCursor CURSOR FOR 
	SELECT [Tracking Number]
	FROM upsFile
	WHERE [Tracking Number] IN (SELECT [Tracking Number] FROM upsworldship WHERE [record type] NOT IN ('D1', 'D2'))
	GROUP BY [Tracking Number]

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @trackingNum

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		TRUNCATE TABLE upsFileWorktable
		INSERT INTO upsFileWorktable
		SELECT TOP 1 * FROM upsFile WHERE [Tracking Number] = @trackingNum 
		ORDER BY [Package Activity Date] DESC, [Package Activity Time] DESC
		
		UPDATE w
		SET w.[Record Type]  = f.[Record Type] , 
			w.[Package Activity Date] = f.[Package Activity Date], 
			w.[Package Activity Time] = f.[Package Activity Time], 
			w.[UPS Location] = f.[UPS Location], 
			w.[UPS Location State Province] = f.[UPS Location State Province], 
			w.[UPS Location Country] = f.[UPS Location Country], 
			w.[Exception Status Description] = f.[Exception Status Description], 
			w.[Exception Resolution Description] = f.[Exception Resolution Description], 
			w.[Driver Released] = f.[Driver Release], 
			w.[Delivery Location] = f.[Delivery Location], 
			w.[Delivery Name] = f.[Delivery Name], 
			w.[Delivery Street Number] = f.[Delivery Street Number], 
			w.[Delivery street Prefix] = f.[Delivery street Prefix], 
			w.[Delivery Street Name] = f.[Delivery Street Name], 
			w.[Delivery Street Type] = f.[Delivery Street Type], 
			w.[Delivery City] = f.[Delivery City], 
			w.[Delivery State Province] = f.[Delivery State Province], 
			w.[Delivery Country] = f.[Delivery Country], 
			w.[Delivery Postal Code] = f.[Delivery Postal Code], 
			w.[Residential Address] = f.[Residential Address], 
			w.[Sign for By] = f.[Signed For By],
			w.updateTracking = 0,
			w.updateDT = GETDATE()
		FROM upsworldship w JOIN upsFileWorktable f ON w.[Tracking Number] = f.[Tracking Number]
		WHERE w.[Tracking Number] = @trackingNum		

		FETCH NEXT FROM catCursor INTO @trackingNum
	END

	CLOSE catCursor
	DEALLOCATE catCursor


	--REMOVE UPDATED TRACKING INFO FROM UPSFILE TBL		
	DELETE FROM upsFile WHERE [Tracking Number] IN (SELECT [Tracking Number] FROM upsWorldShip)

	--INSERT NEW TRACKING INFO WHERE THERE IS ONLY 1 INSTANCE		
	INSERT INTO upsworldship
	SELECT 
		[Tracking Number], [Query Begin Date], [Query End Date], [Record Type], [Shipper Number], [Shipper Name], 
		[Shipper City], [Shipper State Province], [Shipper Postal Code], [Shipper Country], [Ship To Attention], 
		[Ship To Phone], [Ship To Name], [Ship To Address Line 1], [Ship To Address Line 2], [Ship To Address Line 3], 
		[Ship To City], [Ship To State Province], [Ship To Postal Code], [Ship To Country], 
		CASE 
			WHEN LEN([Shipment Reference Number Value 1]) > 0 THEN [Shipment Reference Number Value 1]
			ELSE [Package Reference Number Value 1]
		END	[Shipment Reference Number Value 1], 
		CASE 
			WHEN LEN([Shipment Reference Number Value 2]) > 0 THEN [Shipment Reference Number Value 2]
			ELSE [Package Reference Number Value 2]
		END	[Shipment Reference Number Value 2],
		[UPS Service], [Pickup Date], [Scheduled Delivery Date], [Scheduled Delivery Time], [Document Type], [Package Activity Date], 
		[Package Activity Time], [Package Count], [Package Dimensions Unit of Measurement], [Length], [Width], [Height], 
		[Package Dimensional Weight], [Package Weight], [Large Package], [Earliest Delivery Time], [Hold For Pickup], 
		[Saturday Delivery Indicator],[Special Instructions], [UPS Location], [UPS Location State Province], 
		[UPS Location Country], [Updated Ship To Name], [Updated Ship To Street Number], [Updated Ship To Street Prefix], 
		[Updated Ship To Street Name], [Updated Ship To Street Type], [Updated Ship To Street Suffix], [Updated Ship To Building Name], 
		[Updated Ship To Room Suite Floor], [Updated Ship To Political Division 3], [Updated Ship To City], [Updated Ship To State Province], 
		[Updated Ship To Country], [Updated Ship To Postal Code], [Exception Status Description], [Exception Reason Description], 
		[Exception Resolution Type], [Exception Resolution Description], [Rescheduled Delivery Date], [Rescheduled Delivery Time], 
		[Driver Release], [Delivery Location], [Delivery Name], [Delivery Street Number], [Delivery Street Prefix], [Delivery Street Name], 
		[Delivery Street Type], [Delivery Street Suffix], [Delivery Building Name], [Delivery Room Suite Floor], [Delivery Political Division 3], 
		[Delivery City], [Delivery State Province], [Delivery Country], [Delivery Postal Code], [Residential Address], [Signed For By],		
		CASE
			WHEN LEN([Shipment Reference Number Value 1]) > 0 
					THEN dbo.[tracking_orderNo]([Shipper Number], [Shipment Reference Number Value 1], [Shipment Reference Number Value 2])
			ELSE dbo.[tracking_orderNo]([Shipper Number], [Package Reference Number Value 1], [Package Reference Number Value 2])
		END, 
		NULL, GETDATE(), [Driver Release], [Signed For By], 0, 
		CASE [Subscription Name]
			WHEN 'Outbound_Katom' THEN ''
			ELSE 
				CASE
					WHEN LEN([Shipment Reference Number Value 1]) > 0 
							THEN dbo.[tracking_PONo]([Shipper Number], [Shipment Reference Number Value 1], [Shipment Reference Number Value 2])
					ELSE dbo.[tracking_PONo]([Shipper Number], [Package Reference Number Value 1], [Package Reference Number Value 2])
				END			
		END
	FROM upsFile
	WHERE [tracking number] IN (SELECT [tracking number] FROM upsfile GROUP BY [tracking number] HAVING COUNT(*) = 1)
			AND [Tracking Number] NOT IN (SELECT [Tracking Number] FROM upsworldship)

	DELETE FROM upsFile WHERE [Tracking Number] IN (SELECT [Tracking Number] FROM upsWorldShip)

		
	--INSERTING THE REMAINING TRACKING
	DECLARE catCursor CURSOR FOR 
	SELECT DISTINCT [Tracking Number] FROM upsFile

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @trackingNum

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		INSERT INTO upsworldship
		SELECT TOP 1 
			[Tracking Number], [Query Begin Date], [Query End Date], [Record Type], [Shipper Number], [Shipper Name], 
			[Shipper City], [Shipper State Province], [Shipper Postal Code], [Shipper Country], [Ship To Attention], 
			[Ship To Phone], [Ship To Name], [Ship To Address Line 1], [Ship To Address Line 2], [Ship To Address Line 3], 
			[Ship To City], [Ship To State Province], [Ship To Postal Code], [Ship To Country], 
			CASE 
				WHEN LEN([Shipment Reference Number Value 1]) > 0 THEN [Shipment Reference Number Value 1]
				ELSE [Package Reference Number Value 1]
			END	[Shipment Reference Number Value 1], 
			CASE 
				WHEN LEN([Shipment Reference Number Value 2]) > 0 THEN [Shipment Reference Number Value 2]
				ELSE [Package Reference Number Value 2]
			END	[Shipment Reference Number Value 2],
			[UPS Service], [Pickup Date], [Scheduled Delivery Date], [Scheduled Delivery Time], [Document Type], [Package Activity Date], 
			[Package Activity Time], [Package Count], [Package Dimensions Unit of Measurement], [Length], [Width], [Height], 
			[Package Dimensional Weight], [Package Weight], [Large Package], [Earliest Delivery Time], [Hold For Pickup], 
			[Saturday Delivery Indicator],[Special Instructions], [UPS Location], [UPS Location State Province], 
			[UPS Location Country], [Updated Ship To Name], [Updated Ship To Street Number], [Updated Ship To Street Prefix], 
			[Updated Ship To Street Name], [Updated Ship To Street Type], [Updated Ship To Street Suffix], [Updated Ship To Building Name], 
			[Updated Ship To Room Suite Floor], [Updated Ship To Political Division 3], [Updated Ship To City], [Updated Ship To State Province], 
			[Updated Ship To Country], [Updated Ship To Postal Code], [Exception Status Description], [Exception Reason Description], 
			[Exception Resolution Type], [Exception Resolution Description], [Rescheduled Delivery Date], [Rescheduled Delivery Time], 
			[Driver Release], [Delivery Location], [Delivery Name], [Delivery Street Number], [Delivery Street Prefix], [Delivery Street Name], 
			[Delivery Street Type], [Delivery Street Suffix], [Delivery Building Name], [Delivery Room Suite Floor], [Delivery Political Division 3], 
			[Delivery City], [Delivery State Province], [Delivery Country], [Delivery Postal Code], [Residential Address], [Signed For By],		
			CASE
				WHEN LEN([Shipment Reference Number Value 1]) > 0 
						THEN dbo.[tracking_orderNo]([Shipper Number], [Shipment Reference Number Value 1], [Shipment Reference Number Value 2])
				ELSE dbo.[tracking_orderNo]([Shipper Number], [Package Reference Number Value 1], [Package Reference Number Value 2])
			END,
			NULL, GETDATE(), [Driver Release], [Signed For By], 0, 
			CASE [Subscription Name]
				WHEN 'Outbound_Katom' THEN ''
				ELSE 
					CASE
						WHEN LEN([Shipment Reference Number Value 1]) > 0 
								THEN dbo.[tracking_PONo]([Shipper Number], [Shipment Reference Number Value 1], [Shipment Reference Number Value 2])
						ELSE dbo.[tracking_PONo]([Shipper Number], [Package Reference Number Value 1], [Package Reference Number Value 2])
					END			
			END
		FROM upsFile
		WHERE [tracking number] = @trackingNum
		ORDER BY [Package Activity Date] DESC, [Package Activity Time] DESC
		
		FETCH NEXT FROM catCursor INTO @trackingNum
	END

	CLOSE catCursor
	DEALLOCATE catCursor

	TRUNCATE TABLE upsFile
	
	--UPDATE upsworldship
	--SET katomOrderID = dbo.tracking_orderNo([Tracking Number])
	--WHERE LEN(ISNULL(katomOrderID, '')) = 0 AND DATEDIFF(DAY, updateDT, GETDATE()) < 7
	

	--UPDATE TRACKING INFO WITH DELIVERED STATUS FROM UPSWORLDSHIP TBL
	UPDATE i
	SET i.Delivered = 'True',
		i.lastUpdatedt = getdate(),
		i.sendToWeb = 1,
		i.emailUpdate = 1
	from upsworldship u JOIN trackingInfo i on u.[tracking Number] = i.[tracking Number]
	where i.[carrier] = 'ups' and ISNULL(i.delivered, 'false') = 'false'
		and u.[Record Type] in ('D1', 'D2') and u.updateTracking = 0
		
	UPDATE u
	SET u.updateTracking = 1
	from upsworldship u JOIN trackingInfo i on u.[tracking Number] = i.[tracking Number]
	where i.[carrier] = 'ups' and u.[Record Type] in ('D1', 'D2') and u.updateTracking = 0

	UPDATE i
	SET i.Delivered = 'True',
		i.lastUpdatedt = getdate(),
		i.sendToWeb = 1,
		i.emailUpdate = 1
	from upsworldship u JOIN trackingInfo i on u.[tracking Number] = i.[tracking Number]
	where i.[carrier] = 'ups' and [Driver Released] = 'DRIVER RELEASED' and u.updateTracking = 0
		
	UPDATE u
	SET u.updateTracking = 1
	from upsworldship u JOIN trackingInfo i on u.[tracking Number] = i.[tracking Number]
	where i.[carrier] = 'ups' and [Driver Released] = 'DRIVER RELEASED' and u.updateTracking = 0

	UPDATE i
	SET i.Delivered = 'True',
		i.lastUpdatedt = getdate(),
		i.sendToWeb = 1,
		i.emailUpdate = 1
	from upsworldship u JOIN trackingInfo i on u.[tracking Number] = i.[tracking Number]
	where LEN(ISNULL([Sign For By], '')) > 0 AND updateTracking = 0
		
	UPDATE u
	SET u.updateTracking = 1
	from upsworldship u JOIN trackingInfo i on u.[tracking Number] = i.[tracking Number]
	where LEN(ISNULL([Sign For By], '')) > 0 AND updateTracking = 0
	
	UPDATE upsworldship
	SET katomorderid = NULL
	WHERE ISNUMERIC(katomorderid) = 0 AND CHARINDEX('-', katomorderid) = 0

	INSERT INTO trackingInfo
	SELECT [Tracking Number], katomOrderID, NULL, 'UPS', 
		CASE
			WHEN [Record Type] = 'D1' THEN 'True'
			WHEN [Record Type] = 'D2' THEN 'True'
			WHEN [Driver Released] = 'DRIVER RELEASED' THEN 'True'
			WHEN LEN(ISNULL([Sign For By], '')) > 0 THEN 'True'
			ELSE 'False'
		END,
		CASE 
			WHEN LEN([Pickup Date]) > 0 THEN CAST([Pickup Date] AS DATETIME)
			ELSE ''
		END,
		CASE 
			WHEN LEN([Scheduled Delivery Date]) > 0 THEN CAST([Scheduled Delivery Date] AS DATETIME)
			ELSE ''
		END
		, 'GROUND', [Sign For By], [Ship to Attention], [Ship to Name], [Ship to Address Line 1], [Ship to Address Line 2], 
		[Ship to City], [Ship to State Province], [Ship to Postal Code], [Ship to Country], [Ship to Phone], NULL,
		NULL, GETDATE(), 0, 1, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, NULL, NULL, NULL, NULL, 
		CASE
			WHEN ISNUMERIC(katomPONum) = 1 AND LEN(katomPONum) = 6 THEN katomPONum
			ELSE NULL
		END
	FROM upsWorldShip
	WHERE [Tracking Number] NOT IN (SELECT [Tracking Number] FROM trackingInfo WHERE carrier = 'UPS')
			AND LEN(ISNULL([katomOrderID], '')) > 0		
	
	update u
	set u.katomOrderID = v.katomOrderID,
		u.katomPONum = 
			CASE 
				WHEN ISNUMERIC(v.PONumber) = 1 THEN v.PONumber
				ELSE NULL
			END
	from vollrathTracking v join upsWorldShip u on v.trackingNo = u.[Tracking Number] 
	
	delete from trackingInfo 
	where isnumeric(KatomOrderID) = 0 and charindex('-', KatomOrderID) = 0
END
GO
/****** Object:  StoredProcedure [dbo].[stockCloseout]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[stockCloseout]
AS
BEGIN
	INSERT INTO closeout
	--ADDING ALL ITEMS IN WHICH WE HAVE NOT SOLD IN THE LAST 18 MONTH
	SELECT [Item No_], SUM([Quantity]) qtyOnHand, MAX([Posting Date]) lastSoldDT, NULL sellingPrice
			/**
			CASE 
				WHEN cost < 10 THEN CAST(cost/.9 as decimal(10, 2))
				WHEN cost BETWEEN 10 AND 100 THEN CAST(cost/.94 as decimal(10, 2))
				ELSE CAST(cost/.97 as decimal(10, 2))
			END sellingPrice, 
			**/
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] i
			JOIN products p ON p.CODE = i.[Item No_] collate Latin1_General_CS_AS
	WHERE CODE NOT LIKE '%-cat%'
		AND CODE NOT IN (SELECT CODE COLLATE Latin1_General_CS_AS FROM closeout)
	GROUP BY [Item No_]
	Having SUM([Quantity]) > 0 and DATEDIFF(MONTH, MAX([Posting Date]), GETDATE()) > 11
	UNION -- ADDING ALL DISCONTINUED ITEMS
	SELECT [Item No_], qtyonhand, MAX([Posting Date]) lastSoldDT, NULL sellingPrice
			/**
			CASE 
				WHEN cost < 10 THEN CAST(cost/.9 as decimal(10, 2))
				WHEN cost BETWEEN 10 AND 100 THEN CAST(cost/.94 as decimal(10, 2))
				ELSE CAST(cost/.97 as decimal(10, 2))
			END sellingPrice, 
			**/ 
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] i
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i2 ON i.[Item No_] = i2.[No_]
			JOIN products p ON p.CODE = i.[Item No_] collate Latin1_General_CS_AS
	WHERE i2.[Status] = 2 AND mfgID <> '599' AND clearance = 0 and qtyOnHand > 0
			AND CODE NOT IN (SELECT CODE COLLATE Latin1_General_CS_AS FROM closeout)
	GROUP BY [Item No_], qtyonhand

	--REMOVE ALL CLEARANCE PRODUCTS FROM CLOSEOUT TABLE IF QTY REACH 0
	DELETE FROM closeout WHERE code IN (SELECT code COLLATE SQL_Latin1_General_CP1_CI_AS FROM products WHERE clearance = 1 AND qtyOnHand < 1)

	UPDATE products SET clearance = 0, salesPrice = NULL, salesDT = NULL WHERE clearance = 1 AND qtyOnHand < 1

	UPDATE p
	SET p.clearance = 1,
		p.salesPrice = p.price,
		p.salesDT = GETDATE()
	FROM closeout c JOIN products p ON c.code = p.CODE COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE p.clearance = 0

	--CATEGORIZE ALL CLEARANCE PRODUCTS - THIS DATA IS NOT IN NAVISION
	DELETE FROM catxprod WHERE catID IN (SELECT id FROM categories WHERE superCat = 'Clearance Sale')

	INSERT INTO catxprod(catID, catCode, prodID, prodCode, primaryCat, nav)
	SELECT CASE c2.superCatID
				WHEN 4367 THEN 10759
				WHEN 5612 THEN 10757
				WHEN 4873 THEN 9024
				WHEN 5853 THEN 8923
				WHEN 5366 THEN 8920
				WHEN 4579 THEN 9025
				WHEN 5433 THEN 9024
				WHEN 7615 THEN 8968
				WHEN 5077 THEN 8924
				WHEN 4515 THEN 10760
				ELSE 10758
			END, 
			CASE c2.superCatID
				WHEN 4367 THEN 'clearance-bar-supplies'
				WHEN 5612 THEN 'clearance-residential'
				WHEN 4873 THEN 'clearance-equipment'
				WHEN 5853 THEN 'clearance-smallwares'
				WHEN 5366 THEN 'clearance-janitorial'
				WHEN 4579 THEN 'clearance-countertop'
				WHEN 5433 THEN 'clearance-equipment'
				WHEN 7615 THEN 'clearance-tabletop'
				WHEN 5077 THEN 'clearance-furniture'
				WHEN 4515 THEN 'clearance-catering-buffet'
				ELSE 'clearance-miscellaneous'
			END, p.prodid, p.code, 0, 1
	FROM closeout c JOIN products p ON c.code = p.CODE COLLATE SQL_Latin1_General_CP1_CI_AS
				LEFT JOIN categories c2 ON p.primaryCatCode = c2.CODE AND c2.primaryCat = 1
	WHERE p.CODE NOT IN 
		(
		SELECT [Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Price] 
		WHERE [Sales Type] = 1
			AND [Manual Price Reason Code] = 'SALE_KATOM' 
			AND [Sales Code] = 'KATOM'
			AND GETDATE() BETWEEN REPLACE([Starting Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, -1, GETDATE())) AND
					REPLACE([Ending Date], 'Jan  1 1753 12:00AM', DATEADD(YEAR, 1, GETDATE()))
		)
								
	EXEC dbo.[product_categorization_clearance_SP]
END
GO
/****** Object:  StoredProcedure [dbo].[RemoteOrderImport]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[RemoteOrderImport]
AS
BEGIN
/**/

/* Archives the existing header information - Non-functioning as table was modified.
INSERT
INTO order_hdr_bkp
SELECT *, GETDATE() as lastupdate FROM  order_hdr
*/

--SELECT * FROM order_hdr_bkp
--DELETE FROM order_hdr_bkp

/*Empties the table to receive a new batch */
--DELETE FROM order_hdr

UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 0') 
	SET batch_id = '2';

/* Imports the Order Headers based on the un-batched headers */
INSERT INTO order_hdr (customerpo, shiptocontact, shiptoemail, shiptocustomername, phoneno, faxno, shiptoaddress, shiptocity, shiptostate, shiptozip, shiptocountry, selltocustomername, selltoemail, selltocontact, selltoaddress, selltocity, selltostate, selltozip, ordertimestamp, batchtimestamp, shipmethod, shipamount, selltocountry, selltophone, CustomerPO2)

SELECT * FROM openquery(MYSQL, '
		SELECT  id as customerpo, 
		upper(concat(ship_fname,'' '',ship_lname)) as shiptocontact,
		ship_email as shiptoemail,
		if (ship_comp <> '''', upper(ship_comp), upper(concat(ship_fname,'' '',ship_lname)))  as shiptocustomername,
		ship_phone as phoneno, 
		ship_fax as faxno, 
		upper(ship_addr) as shiptoaddress,
		upper(ship_city) as shiptocity,
		upper(ship_state) as shiptostate,
		ship_zip as shiptozip,
		ship_cntry as shiptocountry,
		if (bill_comp <> '''', upper(bill_comp), upper(concat(bill_fname,'' '',bill_lname)))  as selltocustomername,
		upper(bill_email) as selltoemail,
		left(upper(concat(bill_fname,'' '',bill_lname)),50) as selltocontact,
		upper(bill_addr) as selltoaddress,
		upper(bill_city) as selltocity,
		upper(bill_state) as selltostate,
		bill_zip as selltozip,
		from_unixtime(orderdate) as ordertimestamp,
		now(),
		(SELECT descrip FROM katom_mm5.s01_OrderCharges where order_id = customerpo
         and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as method,
		(SELECT amount FROM katom_mm5.s01_OrderCharges where order_id = customerpo
		 and module_id <> ''90'' AND module_id <> ''1001'' AND module_id <> ''186'' limit 1) as amount,
		 bill_cntry,
		 bill_phone,
		(select purchaseordernum from cxmlxref where orderid = o.id limit 1) as po2
		FROM katom_mm5.s01_Orders o where batch_id = 2')

  
  UPDATE [KatomDev].[dbo].[order_hdr] SET phoneNo = LEFT(dbo.StripNonNumeric(phoneNo),10)
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltophone = LEFT(dbo.StripNonNumeric(selltophone),10)
   
  UPDATE [KatomDev].[dbo].[order_hdr] SET shiptoaddress = dbo.RemoveNonAlphaNumericCharacters([shiptoaddress])
  
  UPDATE [KatomDev].[dbo].[order_hdr] SET selltoaddress = dbo.RemoveNonAlphaNumericCharacters([selltoaddress])
		
/* Imports the Order Line Items based on the un-batched headers */
--delete from order_items

	INSERT INTO order_items(order_id, line_id, product_id, code, name, price, weight, taxable, upsold, quantity)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		product_id,
		code,
		name,
		price,
		weight,
		taxable,
		upsold,
		quantity	
		FROM katom_mm5.s01_OrderItems
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')

/* Imports the Order Charges based on the un-batched headers */
--delete from order_charges

	INSERT INTO order_charges(order_id, charge_id, module_id, type, descrip, amount, disp_amt, tax_exempt)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount,
		disp_amt,
		tax_exempt
		FROM katom_mm5.s01_OrderCharges
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')


/*Pulls down the option information based on un-batched order headers*/
--delete from order_options

	INSERT INTO order_options(order_id, line_id, attr_id, attr_code, option_id, attmpat_id, opt_code, price, weight, data, data_long)

	SELECT * FROM openquery(MYSQL, '
		SELECT
		order_id,
		line_id,
		attr_id,
		attr_code,
		option_id,
		attmpat_id,
		opt_code,
		price,
		weight,
		data,
		data_long	
		FROM katom_mm5.s01_OrderOptions
		where order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2 and attr_code <> ''recip_email'')')
		
		update
		[KatomDev].[dbo].[order_options]
		set opt_code = data, data = ''
		where LEN(data) > 1
		
/* Shipping and coupons */
	INSERT INTO order_options(order_id, line_id, option_id, attr_id, attr_code, opt_code, price)

	SELECT * FROM openquery(MYSQL, '
		SELECT order_id,
		charge_id as line_id,
		charge_id,
		module_id,
		type,
		descrip,
		amount
		FROM katom_mm5.s01_OrderCharges
		where module_id in (1001, 186)
		and order_id in (SELECT id FROM katom_mm5.s01_Orders where batch_id = 2)')
	

/*Changes Batch ID to indicate imported status*/
	UPDATE OPENQUERY (MYSQL, 'SELECT * FROM katom_mm5.s01_Orders s where batch_id = 2') 
	SET batch_id = '1';

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(10)
	DECLARE @Country varchar(10)

	DECLARE DemoCursor CURSOR FOR 
	SELECT customerpo, shiptocountry FROM order_hdr WHERE exported = 0 and shiptocountry <> 'XX'

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @Country

	WHILE @@FETCH_STATUS = 0
	BEGIN
		exec paymentparse @Order
		
		/* International Order Handling */		
		IF @Country NOT IN ('CA', 'US', 'XX')
			BEGIN
				Update order_hdr
				set shiptocity = (shiptocity+', '+shiptostate),
					shiptostate = shiptocountry,
					selltocity = (selltocity+', '+selltostate),
					selltostate = shiptocountry,
					shiptocountry = 'XX'
				where customerpo = @Order
			
				/*insert into order_items([order_id], [line_id], [product_id], [code],[name], [price], [weight], [taxable], [upsold], [quantity])
				values (@Order, 1, 999999, '', 'INTERNATIONAL ORDER', '0.00', '0', 1, 0, 0)*/
			END
							
		FETCH NEXT FROM DemoCursor INTO @Order, @Country
	END

CLOSE DemoCursor

DEALLOCATE DemoCursor
/*Display the gathered header information*/
--SELECT * FROM order_hdr

/*Display the gathered line item information with customer info*/
--SELECT * FROM order_hdr join order_items ON order_id = customerpo order by order_id

/*select name, attr_code, opt_code from order_options o
join order_items i 
on i.order_id = o.order_id and i.line_id = o.line_id*/

exec CvcImport

UPDATE [KatomDev].[dbo].[order_hdr] SET ccnum = dbo.StripNonNumeric(ccnum)

--Pilot specifications update
update order_hdr
set orderplacedby = 'PI',
paymenttermscode = 'NET 30',
CustomerSource = 'S',
selltoemail = 'NA'
where ccname = 'Pilot'

END
GO
/****** Object:  StoredProcedure [dbo].[trackingInfo_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[trackingInfo_SP]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('TrackingInfo', GETDATE())
	SET @jobID = @@identity

	--INSERTING FROM LOU DAILY FEDEX FILE - PACKAGE FROM WAREHOUSE ONLY
	INSERT INTO trackinginfo([Tracking Number], [katomOrderID], [carrier], [Ship Date], [Service Type], lastupdateDT, NAVImported, sendToWEB)
	SELECT [tracking Number], orderID, 'FXGROUND', GETDATE(), 'GROUND', GETDATE(), 0, 0
	FROM fedExFile
	WHERE [tracking Number] NOT IN (SELECT [Tracking Number] FROM trackinginfo)

	--INSERTING FROM ADAM INTRANET SYSTEM - FREIGHT AND TYPICALLY THIRD-PARTY
	INSERT INTO trackinginfo([Tracking Number], [katomOrderID], [carrier], [Ship Date], [Service Type], lastupdateDT, NAVImported, sendToWEB)
	SELECT  UPPER(TrackingNo), OrderNo, ShippingAgentCode, GETDATE(), ShipMethodCode, GETDATE(), 0, 1
	FROM ShipTracking.dbo.Tracking
	WHERE UPPER(TrackingNo) NOT IN (SELECT [Tracking Number] FROM trackinginfo)

	INSERT INTO ShipTracking.dbo.TrackingArchive
	SELECT * FROM ShipTracking.dbo.Tracking

	TRUNCATE TABLE ShipTracking.dbo.Tracking
	
	UPDATE trackinginfo
	SET [Service Type] = 'Ground'
	WHERE carrier = 'USMAIL'

	--INSERTING FROM FEDEX INSIGHT FILE
	UPDATE t
	SET t.[katomInvoiceID] = f.[katomInvoiceID], 
		t.[Delivered] = f.[Delivered], 
		t.[Ship Date] = f.[Ship Date], 
		t.[Delivered Date] = f.[Delivered Date], 
		t.[Service Type] = f.[Service Type], 
		t.[Sign by] = f.[Sign by], 
		t.[Company] = f.[Company], 
		t.[Contact] = f.[Contact], 
		t.[Address 1] = f.[Address 1], 
		t.[Address 2] = f.[Address 2], 
		t.[City] = f.[City], 
		t.[State] = f.[State], 
		t.[Zip] = f.[Zip], 
		t.[Country] = f.[Country], 
		t.[Phone] = f.[Phone], 
		t.[E-Mail] = f.[E-Mail], 
		t.[Tracking Scan] = f.[Tracking Scan], 
		t.[lastUpdateDT] = f.[lastUpdateDT], 
		t.[sendToWEB] = 1
	FROM trackinginfo t JOIN fedexTracking f on t.[Tracking Number] = f.[Tracking Number]
	WHERE t.[carrier] = 'FXGROUND' 
		AND (DATEDIFF(DAY, f.[lastUpdateDT], GETDATE()) = 0 OR t.[Zip] IS NULL)

	UPDATE t
	SET t.[KatomOrderID] = f.[KatomOrderID], 
		t.[lastUpdateDT] = GETDATE(), 
		t.[sendToWEB] = 1
	FROM trackinginfo t JOIN fedexTracking f on t.[Tracking Number] = f.[Tracking Number]
	WHERE t.[carrier] = 'FXGROUND' AND t.[KatomOrderID] IS NULL

	INSERT INTO trackinginfo ([Tracking Number], [katomOrderID], [katominvoiceid], [carrier], delivered, [Ship Date], [Delivered Date], [Service Type], [Sign by], company, contact, [Address 1], [Address 2], [City], [State], [Zip], [Country], [Phone], [E-Mail], [Tracking Scan], lastupdateDT, NAVImported, sendToWEB)
	SELECT [Tracking Number], [KatomOrderID], [katomInvoiceID], 'FXGROUND', [Delivered], [Ship Date], [Delivered Date], [Service Type], [Sign by], [Company], [Contact], [Address 1], [Address 2], [City], [State], [Zip], [Country], [Phone], [E-Mail], [Tracking Scan], [lastUpdateDT], 0, 1
	FROM fedexTracking
	WHERE [tracking Number] NOT IN (SELECT [Tracking Number] FROM trackinginfo)
		AND KatomOrderID IS NOT NULL

	--DONT IMPORT IF THE TRACKING INFO IS ALREADY IN NAV
	UPDATE t
	SET t.NAVImported = 1
	from fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		JOIN trackinginfo t on t.[katomOrderID] = i.[Order No_] COLLATE Latin1_General_CS_AS
							AND t.[Tracking Number] = i.[Package Tracking No_] COLLATE Latin1_General_CS_AS
	WHERE LEFT([No_], 1) = 'I' AND LEN([Package Tracking No_]) > 0 AND t.NAVImported = 0

	--IMPORT FROM UPS TABLE FROM KATOM WAREHOUSE	
	delete from UPSTracking
	where TrackingNumber in (
	select TrackingNumber from UPSTracking
	group by TrackingNumber
	having COUNT(*) > 1)

	INSERT INTO trackingInfo([Tracking Number], katomOrderID, carrier, Delivered, [Ship Date], 
								[Service Type], lastUpdateDT, NAVImported, SendToWeB)
	select TrackingNumber, Reference1, 'UPS', 'FALSE', UPDATEDT, 'UPS', GETDATE(), 0, 1
	from UPSTracking
	where TrackingNumber not in (SELECT [Tracking Number] FROM trackingInfo)
	and [Reference1] is not null
	and CHARINDEX('#', reference1) = 0
	and LEN(reference1) < 11

	DELETE FROM trackinginfo WHERE ISNUMERIC(katomorderid) = 0 AND CHARINDEX('-', katomorderid) = 0
	
	-- BEGIN --
	--INSERTING ITEM SHIPPED FOR ALL ORDERS SHIPPED FROM KATOM - ONLY STORING 60 DAYS WORTH OF DATA
	INSERT INTO trackingInfo_line_worktable
	SELECT h.[Order No_], l.[Document No_], l.[No_], l.[Description], CAST(l.Quantity AS DECIMAL(10, 0)), u.TrackingNumber  
	FROM upsTracking u join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] h 
					on u.[Reference1] = h.[Order No_] COLLATE Latin1_General_CS_AS
		join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] l on h.[No_] = l.[Document No_]
	WHERE l.[No_] NOT LIKE '100-%'
		AND l.[No_] NOT IN ('205','420','505','506','520','720')
		AND LEN(l.[No_]) > 0
		AND l.Quantity > 0
		AND DATEDIFF(DAY, h.[Posting Date], GETDATE()) < 60
	
	--INSERTING ITEM SHIPPED FOR ALL ORDERS FOR SHIP DIRECT FOR OPEN PO
	INSERT INTO trackingInfo_line_worktable
	SELECT ph.[Sales Order No_],
		ih.[No_],
		pl.[No_] prodNum,
		pl.[Description],
		CASE pl.[Quantity Invoiced]
			WHEN 0 THEN CAST(pl.[Quantity] AS DECIMAL(10, 0))
			ELSE CAST(pl.[Quantity Invoiced] AS DECIMAL(10, 0))
		END qtyShipped,
		u.[tracking Number]
	FROM upsWorldShip u JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Header] ph
					ON ISNULL(u.katomPONum, '') = ph.[No_] COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purchase Line] pl ON pl.[Document No_] = ph.[No_]
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih ON ph.[Sales Order No_] = ih.[Order No_]
	WHERE ph.[Ship-to Name] NOT IN ('B & B Equipment & Supply, Inc.', 'WAREHOUSE FACILITY', 'WAREHOUSER FACILITY', 'PILOT')	
			AND LEN(ph.[Sales Order No_]) > 0
			AND DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < 60
			AND LEN(pl.[No_]) > 0
	
	--INSERTING ITEM SHIPPED FOR ALL ORDERS FOR SHIP DIRECT FOR PAID PO		
	INSERT INTO trackingInfo_line_worktable
	SELECT ph.[Sales Order No_],
		ih.[No_],
		pl.[No_] prodNum,
		pl.[Description],
		CAST(pl.[Quantity] AS DECIMAL(10, 0)) qtyShipped,
		u.[tracking Number]
	FROM upsWorldShip u JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Header] ph
					ON ISNULL(u.katomPONum, '') = ph.[Order No_] COLLATE Latin1_General_CS_AS
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Purch_ Inv_ Line] pl ON pl.[Document No_] = ph.[No_]
			JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih ON ph.[Sales Order No_] = ih.[Order No_]
	WHERE ph.[Ship-to Name] NOT IN ('B & B Equipment & Supply, Inc.', 'WAREHOUSE FACILITY', 'WAREHOUSER FACILITY', 'PILOT')	
			AND LEN(ph.[Sales Order No_]) > 0
			AND DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < 60
			AND LEN(pl.[No_]) > 0
			AND pl.Quantity > 0

	DELETE w
	FROM trackingInfo_line_worktable w JOIN trackingInfo_line l 
			ON w.OrderNo = l.OrderNo AND w.InvoiceNo = l.InvoiceNo AND w.ItemNo = l.ItemNo AND w.trackingNo = l.trackingNo

	INSERT INTO trackingInfo_line (orderNo, InvoiceNo, ItemNo, itemDesc, qtyShipped, trackingNo, updatedt)
	SELECT *, GETDATE() FROM trackingInfo_line_worktable

	TRUNCATE TABLE trackingInfo_line_worktable
	DELETE trackingInfo_line WHERE DATEDIFF(DAY, updateDT, GETDATE()) > 61
	
	--RESET NAVIMPORTED FLAG TO 0 IF TRACKING NUMBER IS NOT PRESENT IN NAV INVOICE TABLE
	UPDATE u
	SET u.NAVImported = 0, lastUpdateDT = GETDATE()
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i
		LEFT JOIN trackingInfo u ON u.katomorderid = i.[Order No_] COLLATE Latin1_General_CS_AS
	WHERE LEN([Package Tracking No_]) = 0
		AND DATEDIFF(day, [Posting Date], getdate()) < 91
		AND NAVImported = 1

	UPDATE trackingInfo
	SET NAVImported = 1
	WHERE [Tracking Number] IN
		(
		SELECT [Package Tracking No_] COLLATE Latin1_General_CS_AS
		FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line]
		WHERE LEN([Package Tracking No_]) > 0
		) AND NAVImported = 0
		
	--REMOVE TRACKING DETAIL FOR ALL PILOT ORDERS (THEY DONT GET TRACKING)
	DELETE t
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] i	
			join trackingInfo_line t on i.[Order No_] = t.orderNo COLLATE SQL_Latin1_General_CP1_CI_AS
	WHERE [Bill-to Name] = 'PILOT'
	
	exec dbo.[ups_tracking]
	
	--REMOVE ALL INVALID KATOMORDERID
	DELETE FROM trackingInfo 
	WHERE ISNUMERIC(katomorderid) = 0 AND CHARINDEX('-', katomorderid) = 0
		
	--UPDATE TABLE TO INCLUDE WEB ORDER ID
	Update trackinginfo
	set weborderid = (select top 1 webnum = CASE [Web Order No_]
										WHEN '' THEN 'NA'
										ELSE [Web Order No_]
									  END
						from invoice_backup
						where katomorderid COLLATE Latin1_General_CS_AS = [Order No_]COLLATE Latin1_General_CS_AS
						),
		zip = (	select top 1 [ship-to post code]
						from invoice_backup
						where katomorderid COLLATE Latin1_General_CS_AS = [Order No_]COLLATE Latin1_General_CS_AS)
	where weborderid = '0' or weborderid is null or weborderid = ''
	
	--DELETING ALL TRACKING THAT IS OVER 90 DAYS		
	DELETE FROM trackinginfo WHERE DATEDIFF(DAY, ISNULL([Delivered Date], GETDATE()), GETDATE()) > 90
	DELETE FROM trackinginfo WHERE DATEDIFF(DAY, ISNULL(lastupdateDT, GETDATE()), GETDATE()) > 90

	--ARCHIVING FEDEXFILE TABLE OVER 45 DAYS
	INSERT INTO fedExFileArchive
	SELECT * FROM fedExFile WHERE DATEDIFF(DAY, ISNULL([timeStamp], GETDATE()), GETDATE()) > 45
	DELETE FROM fedExFile WHERE DATEDIFF(DAY, ISNULL([timeStamp], GETDATE()), GETDATE()) > 45

	--ARCHIVING FEDEXTRACKING TABLE OVER 45 DAYS
	INSERT INTO fedexTrackingArchive
	SELECT * FROM fedexTracking WHERE DATEDIFF(DAY, ISNULL(lastupdateDT, GETDATE()), GETDATE()) > 45
	DELETE FROM fedexTracking WHERE DATEDIFF(DAY, ISNULL(lastupdateDT, GETDATE()), GETDATE()) > 45
		
	--REMOVING TRACKING WITH BAD KATOM ORDER ID
	DELETE FROM trackinginfo
	WHERE ISNUMERIC(left(katomorderID, 2)) = 0 AND LEN(ISNULL(katomOrderID, '')) > 0
	
	DELETE FROM trackinginfo
	WHERE katomOrderID IS NULL
			AND DATEDIFF(DAY, [Ship Date], GETDATE()) > 3
	
	DELETE FROM trackinginfo
	WHERE LEN(katomOrderID) < 6
	
	EXEC DBO.[DUP_trakingNumberCleanup]

	--DELETING BAD KATOM ORDER ID TRACKING NUMBER
	DELETE FROM trackingInfo WHERE LEN(katomorderid) > 10

	DELETE from trackingInfo 
	where isnumeric(katomorderid)= 0 
			AND LEFT(katomorderid, 1) <> 'i'
			AND LEFT(RIGHT(katomorderid, 2), 1) <> '-'
	
	--UPLOAD TRACKING NUMBERS TO WEB FOR SEARCH --Added 3-4-11 MS
	--EXEC dbo.webtrackinginfo
			
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[ShipTrackingEmailerTest]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[ShipTrackingEmailerTest] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
/*select [Order No_], [Ship-to name], [Ship-to Address], [Ship-to City], [Ship-to ZIP Code],  TrackingNo, x.[Shipping Agent Code], Carrier, webAddress, [tracking URL]
FROM [KatomDev].[dbo].[invoice_backup] i
join [KatomDev].[dbo].[ship_backup] s
on [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
join shipurl x
on s.[ShippingAgentCode] = x.[Shipping Agent Code]
where [Order No_] <> ''
order by OrderNo desc


select * from shipurl

select * from [KatomDev].[dbo].[invoice_backup]
*/
/*
select top 100 * from [KatomDev].[dbo].[invoice_backup]
where [E-Mail] <> '' and [E-Mail] not in ('N/A', 'NA', '0')
*/

/*Copies information from FS1 DB and Shiptracking DB to WEBSQL db for use*/
exec invoicebackupcopy

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(20)
	DECLARE @email varchar(50)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoadd varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @billtoname varchar(30)
	DECLARE @billtoadd varchar(30)
	DECLARE @billtocity varchar(30)
	DECLARE @billtostate varchar(10)
	DECLARE @billtozip varchar(10)
	DECLARE @phone varchar(20)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)

	DECLARE DemoCursor CURSOR FOR 
	/*select [Order No_], [E-mail], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to state], [Ship-to ZIP Code], 
	[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to state], [Sell-to ZIP Code], [phone No_],
			TrackingNo, Carrier, webAddress, [tracking URL]*/
	SELECT [E-mail]		
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[ship_backup] s
	ON [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
	join [KatomDev].[dbo].shipurl x
	on s.[ShippingAgentCode] = x.[Shipping Agent Code]
	WHERE [Order No_] <> '' and [E-Mail] like '%@%'
	and TrackingNo not in (select trackno from [KatomDev].[dbo].shipxref r)
	GROUP BY [e-mail]

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @email
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	DECLARE DemoCursor2 CURSOR FOR
	
	select [Order No_], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to state], [Ship-to ZIP Code], 
	[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to state], [Sell-to ZIP Code], [phone No_],
			TrackingNo, Carrier, webAddress, [tracking URL]
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[ship_backup] s
	ON [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
	join [KatomDev].[dbo].shipurl x
	on s.[ShippingAgentCode] = x.[Shipping Agent Code]
	WHERE [Order No_] <> '' and [E-Mail] = @email
	and TrackingNo not in (select trackno from [KatomDev].[dbo].shipxref r)
	
	
	OPEN DemoCursor2
	
	FETCH NEXT FROM DemoCursor2 INTO @Order, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
	@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @trackno, @carrier, @webadd, @trackURL


	print @Order
	print @email


	WHILE @@FETCH_STATUS = 0
	BEGIN
			SET @email1 = 'clutchwow@gmail.com'
			SET @subject1 = 'KaTom.com Order #'+@order+' Shipment Notification'	
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>E-Mail</title>

<style type="text/css">
html{font-family:Lucida Grande;}
</style>

</head>
<body>
<a href="http://www.katom.com">
<img width="194" height="60" title="KaTom Restaurant Supply Inc." alt="KaTom Restaurant Supply Inc." src="http://www.katom.com/Merchant2/css/sterile/seasonallogo.gif" border="0"><br />
<span style="
font-family:Arial;
font-size:11px;
font-variant:small-caps;
font-weight:400;
left:4px;
letter-spacing:2px;
margin:0;
padding:0 0 0 1px;
position:relative;
top:-1px;
text-decoration:underline
">
RESTAURANT SUPPLY, INC.
</span>
</a>
<table border="0" width="632" style="font-family:Lucida Grande; font-weight:100; background:#585757;color:#fff;" cellpadding="2">
<tr>
<td width="10px;"></td>
<td colspan="2">
<br />
<span style="font-size:72px; color:#959595;">ON ITS WAY...</span>
</td>
</tr>
<tr>
<td width="10px;"></td>
<td>
<span style="color:#e9ba20; font-size:30px; font-weight:600px">Good news &mdash; your package has shipped.</span>
<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package from <a href="http://www.katom.com" style="color:#FFF">Katom Restaurant Supply</a> is on its way.  Here''s your shipping confirmation:</p>
</td>
</tr>
<tr>
<td width="10px;"></td>
<td colspan="2"><span style="color:#e9ba20;
font-family:lucida grande;
font-weight:600;">ORDER NUMBER.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+@order+'</span></td>
</tr>
<tr>
<td width="10px;"></td>
<td colspan="2"><span style="color:#e9ba20;
font-family:lucida grande;
font-weight:600;">SHIPPING DATE.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+convert(varchar,datepart(mm,getdate())) + '.' + convert(varchar,datepart(dd,getdate())) + '.' + convert(varchar,datepart(yyyy,getdate()))+'</span></td>
</tr>
<tr>
<td width="10px;"></td>
<td colspan="2"><span style="color:#e9ba20;
font-family:lucida grande;
font-weight:600;">TRACKING NUMBER.</span> <a href="'+REPLACE(@trackurl, '<%trackingNum%>', @trackno)+'" style="color:#FFF">'+@trackno+'</a>
<br />
<br />
</td>
</tr>
</table>
<table cellspacing="0">
<tr height="8">
<td>
</td>
</tr>
<tr>
<td>
<a href="http://www.katom.com/blog/of-interest/3767/katoms-having-a-recipe-contest">
<img src="http://www.katom.com/images/shunGiveaway.gif" />
</a>
</td>
<td width="9">
</td>
<td>
<a href="http://www.katom.com/vendor/shun.html?intcmp=trkeml">
<img src="http://www.katom.com/images/shunSpecial.gif" />
</a>
</td>
</tr>
<table>
<tr>
<td height="4px">
</td>
</tr>
</table>
</table>
<table width="625" style="border-color:#000; border-style:solid; border-width:1px;">
<tr>
<td>
<table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
<tr>
<td width="9px" style="background:#999; font-weight:600; color:#666">
</td>
<td colspan="2" style="background:#999; font-weight:600; color:#666; font-size:14px">
ORDER INFORMATION
</td>
</tr>
<tr>
<td height="9px">
</td>
</tr>
<tr>
<td width="9px"></td>
<td style="font-size:12px; font-weight:600">
BILLING INFORMATION:
</td>
<td style="font-size:12px; font-weight:600">
SHIPPING INFORMATION:
</td>
</tr>
<tr>
<td width="9px"></td>
<td>
<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
<tr><td>'+@billtoname+'</td></tr>
<tr><td>'+@billtoadd+'</td></tr>
<tr><td>'+@billtocity+', '+@billtostate+' '+@billtozip+'</td></tr>
<tr><td>Primary Phone: '+@phone+'</td></tr>
<tr><td>Email: '+@email+'</td></tr>
</table>
</td>
<td valign="top">
<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
<tr><td>'+@shiptoname+'</td></tr>
<tr><td>'+@shiptoadd+'</td></tr>
<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
</tr>
<tr>
<td height="4px" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
Note:  Tracking information may not be available for up to 48 hours after an item is shipped.  Please do not reply to this email as it is delivered from an unmonitored address.  If you need further assistance, please <a href="http://www.katom.com/trackmyorder.php">click here</a> for help.
</td>
</tr>
</table>
</body>
</html>'
			
			--SET @body1 = 'Click this '+@trackurl+REPLACE(@trackno, '<%trackingNum%>', @Order)
	/*		EXEC msdb.dbo.sp_send_dbmail @profile_name='katom',
				@recipients=@email2, --CHANGED FOR TEST
				@subject=@subject1,
				@body=@body1,
				@body_format ='HTML',
				@blind_copy_recipients='mike@katom.com'
				
			insert into shipxref (trackno, sent) values (@trackno, 1)
	*/
	
	FETCH NEXT FROM DemoCursor2 INTO @Order, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
	@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @trackno, @carrier, @webadd, @trackURL
	
	--Print @Order+' '+@shiptoname+' '+@shiptoadd+' '+@shiptocity+' '+@shiptostate+' '+@shiptozip+' '+
	--@billtoname+' '+@billtoadd+' '+@billtocity+' '+@billtostate+' '+@billtozip+' '+@phone+' '+@trackno+' '+
	--@carrier+' '+@webadd+' '+@trackURL

	END
	
	CLOSE DemoCursor2
	
	DEALLOCATE DemoCursor2
	
	FETCH NEXT FROM DemoCursor INTO @email

	END
	
	
	CLOSE DemoCursor

	
	
	DEALLOCATE DemoCursor

/*Reset
select * from shipxref where trackno = '053260560918289 '
delete from shipxref where id = 15628
*/
END
GO
/****** Object:  StoredProcedure [dbo].[ShipTrackingEmailer]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[ShipTrackingEmailer] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
/*select [Order No_], [Ship-to name], [Ship-to Address], [Ship-to City], [Ship-to ZIP Code],  TrackingNo, x.[Shipping Agent Code], Carrier, webAddress, [tracking URL]
FROM [KatomDev].[dbo].[invoice_backup] i
join [KatomDev].[dbo].[ship_backup] s
on [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
join shipurl x
on s.[ShippingAgentCode] = x.[Shipping Agent Code]
where [Order No_] <> ''
order by OrderNo desc


select * from shipurl

select * from [KatomDev].[dbo].[invoice_backup]
*/
/*
select top 100 * from [KatomDev].[dbo].[invoice_backup]
where [E-Mail] <> '' and [E-Mail] not in ('N/A', 'NA', '0')
*/

/*Copies information from FS1 DB and Shiptracking DB to WEBSQL db for use*/
exec invoicebackupcopy

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(20)
	DECLARE @email varchar(50)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoadd varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @billtoname varchar(30)
	DECLARE @billtoadd varchar(30)
	DECLARE @billtocity varchar(30)
	DECLARE @billtostate varchar(10)
	DECLARE @billtozip varchar(10)
	DECLARE @phone varchar(20)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)

	DECLARE DemoCursor CURSOR FOR 
	select [Order No_], [E-mail], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to state], [Ship-to ZIP Code], 
	[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to state], [Sell-to ZIP Code], [phone No_],
			TrackingNo, Carrier, webAddress, [tracking URL]
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[ship_backup] s
	on [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
	join [KatomDev].[dbo].shipurl x
	on s.[ShippingAgentCode] = x.[Shipping Agent Code]
	where [Order No_] <> '' and [E-Mail] <> '' and [E-Mail] not in ('N/A', 'NA', '0')
	and TrackingNo not in (select trackno from [KatomDev].[dbo].shipxref r)
	order by OrderNo desc

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
	@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @trackno, @carrier, @webadd, @trackURL

	WHILE @@FETCH_STATUS = 0
	BEGIN
			print @Order
			print @email
			SET @email1 = 'clutchwow@gmail.com'
			SET @subject1 = 'KaTom.com Order #'+@order+' Shipment Notification'	
			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>E-Mail</title>

<style type="text/css">
html{font-family:Lucida Grande;}
</style>

</head>
<body>
<a href="http://www.katom.com">
<img width="194" height="60" title="KaTom Restaurant Supply Inc." alt="KaTom Restaurant Supply Inc." src="http://www.katom.com/Merchant2/css/sterile/seasonallogo.gif" border="0"><br />
<span style="
font-family:Arial;
font-size:11px;
font-variant:small-caps;
font-weight:400;
left:4px;
letter-spacing:2px;
margin:0;
padding:0 0 0 1px;
position:relative;
top:-1px;
text-decoration:underline
">
RESTAURANT SUPPLY, INC.
</span>
</a>
<table border="0" width="632" style="font-family:Lucida Grande; font-weight:100; background:#585757;color:#fff;" cellpadding="2">
<tr>
<td width="10px;"></td>
<td colspan="2">
<br />
<span style="font-size:72px; color:#959595;">ON ITS WAY...</span>
</td>
</tr>
<tr>
<td width="10px;"></td>
<td>
<span style="color:#e9ba20; font-size:30px; font-weight:600px">Good news &mdash; your package has shipped.</span>
<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package from <a href="http://www.katom.com" style="color:#FFF">Katom Restaurant Supply</a> is on its way.  Here''s your shipping confirmation:</p>
</td>
</tr>
<tr>
<td width="10px;"></td>
<td colspan="2"><span style="color:#e9ba20;
font-family:lucida grande;
font-weight:600;">ORDER NUMBER.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+@order+'</span></td>
</tr>
<tr>
<td width="10px;"></td>
<td colspan="2"><span style="color:#e9ba20;
font-family:lucida grande;
font-weight:600;">SHIPPING DATE.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+convert(varchar,datepart(mm,getdate())) + '.' + convert(varchar,datepart(dd,getdate())) + '.' + convert(varchar,datepart(yyyy,getdate()))+'</span></td>
</tr>
<tr>
<td width="10px;"></td>
<td colspan="2"><span style="color:#e9ba20;
font-family:lucida grande;
font-weight:600;">TRACKING NUMBER.</span> <a href="'+REPLACE(@trackurl, '<%trackingNum%>', @trackno)+'" style="color:#FFF">'+@trackno+'</a>
<br />
<br />
</td>
</tr>
</table>
<table cellspacing="0">
<tr height="8">
<td>
</td>
</tr>
<tr>
<td>
<a href="http://www.katom.com/blog/of-interest/3767/katoms-having-a-recipe-contest">
<img src="http://www.katom.com/images/shunGiveaway.gif" />
</a>
</td>
<td width="9">
</td>
<td>
<a href="http://www.katom.com/vendor/shun.html?intcmp=trkeml">
<img src="http://www.katom.com/images/shunSpecial.gif" />
</a>
</td>
</tr>
<table>
<tr>
<td height="4px">
</td>
</tr>
</table>
</table>
<table width="625" style="border-color:#000; border-style:solid; border-width:1px;">
<tr>
<td>
<table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
<tr>
<td width="9px" style="background:#999; font-weight:600; color:#666">
</td>
<td colspan="2" style="background:#999; font-weight:600; color:#666; font-size:14px">
ORDER INFORMATION
</td>
</tr>
<tr>
<td height="9px">
</td>
</tr>
<tr>
<td width="9px"></td>
<td style="font-size:12px; font-weight:600">
BILLING INFORMATION:
</td>
<td style="font-size:12px; font-weight:600">
SHIPPING INFORMATION:
</td>
</tr>
<tr>
<td width="9px"></td>
<td>
<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
<tr><td>'+@billtoname+'</td></tr>
<tr><td>'+@billtoadd+'</td></tr>
<tr><td>'+@billtocity+', '+@billtostate+' '+@billtozip+'</td></tr>
<tr><td>Primary Phone: '+@phone+'</td></tr>
<tr><td>Email: '+@email+'</td></tr>
</table>
</td>
<td valign="top">
<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
<tr><td>'+@shiptoname+'</td></tr>
<tr><td>'+@shiptoadd+'</td></tr>
<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
</table>
</td>
</tr>
</table>
</td>
</tr>
</tr>
<tr>
<td height="4px" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
Note:  Tracking information may not be available for up to 48 hours after an item is shipped.  Please do not reply to this email as it is delivered from an unmonitored address.  If you need further assistance, please <a href="http://www.katom.com/trackmyorder.php">click here</a> for help.
</td>
</tr>
</table>
</body>
</html>'
			
			--SET @body1 = 'Click this '+@trackurl+REPLACE(@trackno, '<%trackingNum%>', @Order)
			EXEC msdb.dbo.sp_send_dbmail @profile_name='katom',
				@recipients=@email,
				@subject=@subject1,
				@body=@body1,
				@body_format ='HTML',
				@blind_copy_recipients='mike@katom.com'
				
			insert into shipxref (trackno, sent) values (@trackno, 1)
				
			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
	@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @trackno, @carrier, @webadd, @trackURL

	END

	CLOSE DemoCursor

	DEALLOCATE DemoCursor

/*Reset
select * from shipxref where trackno = '053260560918289 '
delete from shipxref where id = 15628
*/
END
GO
/****** Object:  StoredProcedure [dbo].[productsSynchNAVtoProducts11082012]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[productsSynchNAVtoProducts11082012]
AS
BEGIN
DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_NAV', GETDATE())
SET @jobID = @@identity

--DELETING ALL PRODUCTS WHERE IT DOES NOT EXIST IN NAVISION
DELETE p
FROM products p LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE i.[No_] IS NULL

--CREATING PRODUCTS LIST TO IMPORT
TRUNCATE TABLE prodTemp
INSERT INTO prodTemp
SELECT 
	LEFT(i.[No_], 3) [Mfg ID], i.[Vendor No_], i.[Web Item No_], i.[No_],
	i.[Product Name], i.[Description], LOWER(i.[Image File Name]) [Image File Name], 
	0 [Last Direct Cost], 
	0 [UnitPrice2], 
	0 [UnitPrice], 
	i.[Gross Weight], i.[Shipping Length], i.[Shipping Width], i.[Shipping Height], 
	CASE i.[Blocked]
		WHEN 0 THEN 1
		ELSE 1
	END [Blocked], [Web Item], i.[Freight Only], i.[Base Unit of Measure], i.[Free Shipping], 
	w.[Add Handling Charge], i.[Profit %], i.[Keywords], i.[Equivalent Grp_], 
	i.[Last Date Modified], i.[Last Date Modified] [AddedDT], i.[Ship Alone],  
	CASE	
		WHEN [Reorder Point] > 0 THEN 1
		ELSE 0
	END [stockItem], i.[Reorder Point], i.[Maximum Inventory], i.[Reorder Quantity], 
	i.[Shelf No_], w.[Priority], NULL, w.[UPC], i.[Web Active], 
	0 [UnitPrice1],
	0 [listPrice2],
	0 [activeLP]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Web Item] w ON i.[No_] = w.[No_]
WHERE [Blocked] = 0
		AND [Web Item] = 1 
		AND [Status] <> 2 
		AND LEN(i.[No_]) > 3

DELETE t FROM prodTemp t JOIN products p ON t.[No_] = p.code COLLATE SQL_Latin1_General_CP1_CI_AS

--INSERTING NEW PRODUCTS
INSERT INTO products
	([mfgID], [vendorID], [mpn], [CODE], [NAME], [NAVDesc], [IMAGE], [cost], [Price], [listPrice], [WEIGHT], [prodL], [prodW], 
	 [prodH], [ACTIVE], [isWeb], [freightOnly], [katomUOM], [freeShipping], [handlingCharge], [currentMargin], 
	 [keywords], [EquivGrp], [updateDT], [addedDT], [shipAlone], [stockItem], [thresholdMin], [thresholdMax], 
	 [reorderQty], [binLocation], [sitemapPriority], [ICDiscountGrp], [upc], [webActive], [BBPrice], [listprice2], [ActiveLP], quickShip)
SELECT *, 0 FROM prodTemp

UPDATE products SET relatedItems = NULL
--UPDATE ALL PRODUCTS MARKED AS CHANGED THROUGH THE DIRTY FLAG FIELD
UPDATE P
SET	p.[NAME] =i.[Product Name], 
	p.[NAVDesc] = i.[Description], 
	p.[IMAGE] = LOWER(i.[Image File Name]),
	p.weight = CAST(i.[Gross Weight] AS DECIMAL(10, 2)),
	p.[cube] = 0, --
	p.prodL = i.[Shipping Length], 
    p.prodW = i.[Shipping Width], 
	p.prodH = i.[Shipping Height],
	p.active = CASE i.[Blocked]
					WHEN 0 THEN 1
					ELSE 1
				END, 
	p.[isWeb] = i.[Web Item], 
	p.freightOnly = i.[Freight Only], 
	p.UOM = null,
	p.katomUOM = i.[Base Unit of Measure], 
	p.freeShipping = i.[Free Shipping], 
	p.[handlingCharge] = w.[Add Handling Charge],  
	p.[keywords] = i.[Keywords], 
	p.[EquivGrp] = i.[Equivalent Grp_],  
	p.updatedt = i.[Last Date Modified],
	p.[shipAlone] = i.[Ship Alone],   
	p.[stockItem] = CASE	
						WHEN [Reorder Point] > 0 THEN 1
						ELSE 0
					END,  
	p.[thresholdMin] = i.[Reorder Point],  
	p.[thresholdMax] = i.[Maximum Inventory],  
	p.[reorderQty] = i.[Reorder Quantity],  
	p.[binLocation] = i.[Shelf No_], 
	p.[sitemapPriority] = w.[Priority], 
	p.relatedItems = w.[related Products],  
	p.[upc] = w.[UPC],  
	p.[webActive] = i.[Web Active],
	p.mpn = i.[Web Item No_]
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i 
		left join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Web Item] w on i.[No_] = w.[No_]
		join products p on i.[No_] = p.code	collate Latin1_General_CS_AS 	
--Where i.[Dirty Flag] = 1

UPDATE p
SET p.vendorid = i.[Vendor No_]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i 
	join products p on i.[No_] = p.code	collate Latin1_General_CS_AS 
WHERE ISNULL(p.vendorid, '') <> i.[Vendor No_] collate Latin1_General_CS_AS 


--UPDATE proddesc WHERE [Dirty Flag] = 1
UPDATE p
set p.[prodDesc] = dbo.[prodDescriptionBuilder](CODE)
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE  [Dirty Flag] = 1 AND ACTIVE = 1

UPDATE products
set prodDesc = dbo.[prodDescriptionBuilder](CODE)
where LEN(ISNULL(CAST(prodDesc AS VARCHAR(MAX)), '')) = 0 and active = 1

--CUBE CALCULATION
update products 
set [cube] = cast((prodW*prodL*prodH)/1728 as decimal(10, 2))
where isnull([cube], 0) = 0

--UPDATE UOM
update p 
set p.katomUOM = u.[Code],
	p.uom = [dbo].[UOM_Conversation](u.[Description])
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Unit of Measure] u	
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON u.[Code] = i.[Base Unit of Measure]
		JOIN products p on p.CODE = i.[No_]	 COLLATE Latin1_General_CS_AS

--REMOVE ALL DUPLICATE ENTRIES
DELETE FROM products WHERE code IS NULL

DECLARE @CODE VARCHAR(100), @prodid int, @position varchar(100)

SET @position = ''

DECLARE lagCursor CURSOR FOR 
select prodid, code
from products p 
where code in (select code 
				from products where active = 1
				group by code
				having count(*) > 1)
ORDER BY code

OPEN lagCursor
FETCH NEXT FROM lagCursor INTO @prodid, @CODE

WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @position = @code
	   begin
		delete from products where prodid = @prodid
	   end
	ELSE
	   BEGIN
		set @position = @code
	   END
	FETCH NEXT FROM lagCursor INTO @prodid, @CODE
   END

CLOSE lagCursor
DEALLOCATE lagCursor

--UPDATING MFGNAME
UPDATE p
SET p.mfgname = m.mfgName
FROM products p JOIN mfg m ON p.mfgID = m.mfgID 

--UPDATING PRODUCTS WITH INVENTORY COUNT
TRUNCATE TABLE prodInventory

/**
ORIGINAL WAY I LOOKED AT INVENTORY
INSERT INTO prodInventory
SELECT [Item No_], SUM(CAST([Remaining Quantity] AS FLOAT))-
		ISNULL((SELECT sum(ISNULL([Quantity], 0)) FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line]
			WHERE [No_] = l.[Item No_] AND [Document Type] = 1), 0)
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] l
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[No_] = l.[Item No_]
WHERE [Drop Shipment] = 0 
			AND CHARINDEX('100-', [Item No_]) = 0 
			AND [Remaining Quantity] <> 0
GROUP BY [Item No_]
**/

INSERT INTO prodInventory
SELECT [Item No_], SUM(CAST([Quantity] AS FLOAT)) -
				(SELECT isnull(SUM(CAST([Quantity] AS FLOAT)), 0)
				 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line]
				 WHERE [No_] = l.[Item No_] AND [Document Type] = 1)
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] l
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[No_] = l.[Item No_]
WHERE CHARINDEX('100-', [Item No_]) = 0 
GROUP BY [Item No_]

UPDATE products SET qtyOnHand = 0

UPDATE p SET p.qtyOnHand = i.qty FROM products p JOIN prodInventory i ON p.code = i.code

UPDATE p SET ACTIVE = 0 
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE p.ACTIVE = 1 AND i.[Status] = 2 AND p.qtyonhand < 1

--CREATING BACKORDER ITEM LIST
TRUNCATE TABLE backOrder_item

INSERT INTO backOrder_item
select l.[No_], p.price, p.thresholdMin, p.ThresholdMax, 
	(SELECT ISNULL(SUM(CAST([Quantity] AS FLOAT)), 0) FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry]
		WHERE [Item No_] = l.[No_]) qtyOnHand, 
	COUNT(distinct  l.[Document No_]) numOfOrder, 
	sum(l.[Quantity]) numItem, p.qtyonhand, MIN(h.[Order Date]) [Oldest Order orderDT]
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] l
	JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
		ON l.[Document No_] = h.[No_]
	JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
where h.[Document Type] = 1
	and p.thresholdMin > 0
	and qtyOnHand < 1
group by l.[No_], p.price, p.thresholdMin, p.ThresholdMax, p.qtyonhand

--UPDATE MPN VARIANCE
UPDATE p
SET p.mpn = 
	CASE 
		WHEN LEN(i.[Web Item No_]) > 0 THEN i.[Web Item No_]
		ELSE i.[Vendor Item No_]
	END
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE p.mpn <> i.[Web Item No_] COLLATE Latin1_General_CS_AS

--UPDATE DISCOUNT GROUP VARIANCE
UPDATE p
SET	p.ICDiscountGrp = i.[Item Disc_ Group]
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE ISNULL(p.ICDiscountGrp, '') <> i.[Item Disc_ Group] COLLATE Latin1_General_CS_AS

--DELETE ALL 599 PRODUCTS FROM DB
UPDATE products
SET active = 0
WHERE LEFT(code, 3) = '599' AND ACTIVE = 1

/**
UPDATE MAP DATA TO DATA FEED
1. FEED MAP PRICE TO DATA FEED
2. FEED KATOM PRICE TO DATA FEED
3. DON'T FEED TO DATAFEED
**/
UPDATE products SET MAP_Program = NULL, feedMAP = 2, MAP_Price = NULL, MAP = 0

UPDATE p 
SET p.MAP = g.[MAP],
	p.MAP_Program =
		CASE g.[Map Program]
			WHEN 1 THEN 'K' --DISPLAY KATOM PRICE
			WHEN 2 THEN 'E' --EMAIL ME MY PRICE
			WHEN 3 THEN 'A' --ADD TO CART
			WHEN 4 THEN 'C' --CALL FOR INFORMATION
			WHEN 5 THEN 'X' --DON'T LIST
			ELSE 'K'
		END,
	p.feedMAP =   
	CASE 
		WHEN ISNULL(g.[Map Program], 1) = 1 THEN 2
		ELSE ISNULL(g.[Feed Rules], 2)
	END		
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] g
	join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[Item Disc_ Group] = g.Code
	join products p on p.code = i.[No_] COLLATE Latin1_General_CS_AS
where g.[MAP] = 1 AND p.active = 1

--SET PRODUCTS ACTIVE
UPDATE p
SET p.active = 0
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i JOIN products p ON i.[No_] = p.CODE collate Latin1_General_CS_AS 	
WHERE (i.[Status] = 2 OR i.[Web Item] = 0) AND p.qtyOnHand < 1 and p.active = 1

--MARK ITEM TO BE SPECIAL ORDER
UPDATE products
SET specialOrder = 0

UPDATE p
SET p.specialOrder = 1
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i JOIN products p ON i.[No_] = p.CODE collate Latin1_General_CS_AS 	
WHERE i.[Status] = 4 AND p.active = 1
 
--UPDATING PRICING
exec dbo.[product_Pricing_Update_SP]

--ASSIGNING CORRECT CATEGORY TO PRODUCTS
exec dbo.[product_categorization_SP]

-- MOVING PRODUCTS TO CLEARANCE BIN
exec dbo.[stockCloseout]

--COUNT THE NUMBER OF PRODUCTS PER CATEGORY
EXEC dbo.[categories_numProd]

--ASSIGNING CORRECT HOLIDAY CATEGORIES TO PRODUCTS
--exec dbo.[product_categorization_holiday_SP]

--MARK PRODUCTS TO LIST ON FROSTY ACRES SITE
UPDATE products SET fa = 0, NAME = LTRIM(RTRIM(NAME))

UPDATE products 
SET fa = 1 
WHERE qtyOnHand > 0 --OR thresholdMin > 0 

UPDATE p 
SET fa = 1 
FROM products p JOIN mfg m ON p.mfgID = m.mfgID
WHERE ISNULL(m.frostyacres, 0) = 1 AND fa = 0

UPDATE products
SET fa = 1  
where code = '175-40813'

--UPDATE QUICK SHIP FLAG
UPDATE p
SET p.quickShip = i.[Vendor Quick Ship],
	p.fa = 1,
	leadTime = 'Typically ships within <span class="bold">3 - 6 business days</span>'
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i JOIN products p ON i.[No_] = p.CODE collate Latin1_General_CS_AS 
	
UPDATE products 
SET quickShip = 
	CASE 
		WHEN qtyOnHand > 0 THEN 1
		ELSE 0
	END,
	leadTime = 
	CASE 
		WHEN qtyOnHand > 0 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span>'
		ELSE NULL
	END,	
	fa = 
	CASE 
		WHEN qtyOnHand > 0 THEN 1		
	END
Where quickShip = 0

--UPDATE PACK SIZE AND STACKABLE INFORMATION FROM EXTERNAL TABLE
UPDATE p
  SET p.packsize = s.packsize,
  p.stackable = s.stackable
  FROM products AS p
  INNER JOIN productpacksize AS s
  ON p.code = s.code;
  
  
  
--Update PDF/Spec information  
UPDATE products
SET specSheet = i.pdf
FROM products p, image_results2 i
WHERE p.code = i.code

UPDATE products
SET image_exists = i.image
FROM products p, image_results2 i
WHERE p.code = i.code

UPDATE products
SET large_image_exists = i.large_image
FROM products p, image_results2 i
WHERE p.code = i.code
 
-- REMOVE THE 2 PURPLE CAMBRO ITEMS WHICH ARE SPECIFIC FOR YOGURT MOUNTAIN
DELETE FROM products WHERE CODE in ('144-SPO10CW100', '144-TG6100')

--REMOVE ALL BLENDTEC RESIDENTIAL FROM BB SITE
UPDATE products SET bb = 0 WHERE mfgID ='579'

--SET EQUIVALENT INFORMATION FOR CORY DISCONTINUED PAGE 
EXEC [dbo].[products_equivalent_sp]

--INSERTING SPECIAL PROMOTION TEXT FOR THE WARING BLENDER
UPDATE products
SET extendedDescription = '<p>Waring offers mixing products of excellence and reliability in today''s growing restaurant supply world. Add these qualities to your own business with the Waring Margarita Madness Blender and you''ll never mix with anything else!</p><p>The Waring drink blender can handle anything from a colorful bar drink to the perfect margarita, but that''s not all. The Waring Margarita Madness drink blender features a 48 ounce clear polycarbonate container that is virtually unbreakable. For a quick, no wait mixing experience, this bar blender features a powerful 1 1/2 horsepower motor balanced to minimize vibration and built to last. With a smooth, rounded design this durable, blender is so easy to clean. For great versatility in drink preparation don''t overlook this Waring blender!</p>'
WHERE CODE = '141-MMB142' and qtyOnHand < 2

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[productsSynchNAVtoProducts_FULL]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[productsSynchNAVtoProducts_FULL]
AS
BEGIN
DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_NAV_FULL', GETDATE())
SET @jobID = @@identity

--DELETING ALL products WHERE IT DOES NOT EXIST IN NAVISION
DELETE p
FROM products p LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE i.[No_] IS NULL

--INSERT ALL PRODUCTS FROM NAV NOT IN THE PRODUCTS TABLE
INSERT INTO products
	([mfgID], [vendorID], [mpn], [CODE], [NAME], [NAVDesc], [IMAGE], [cost], [Price], [listPrice], [WEIGHT], [prodL], [prodW], 
	 [prodH], [ACTIVE], [isWeb], [freightOnly], [katomUOM], [freeShipping], [handlingCharge], [currentMargin], 
	 [keywords], [EquivGrp], [updateDT], [addedDT], [shipAlone], [stockItem], [thresholdMin], [thresholdMax], 
	 [reorderQty], [binLocation], [sitemapPriority], [ICDiscountGrp], [upc], quickShip, specialOrder)
SELECT 
	LEFT(i.[No_], 3) [Mfg ID], i.[Vendor No_], i.[Web Item No_], LTRIM(RTRIM(i.[No_])),
	LTRIM(RTRIM(REPLACE(i.[Product Name], CHAR(10), ''))), i.[Description], REPLACE(LOWER(REPLACE(REPLACE(i.[Image File Name], CHAR(13), ''), CHAR(10), '')), '.JPG', '') [Image File Name], 
	0 [Last Direct Cost], 
	0 [UnitPrice2], 
	0 [UnitPrice], 
	i.[Gross Weight], i.[Shipping Length], i.[Shipping Width], i.[Shipping Height], 
	CASE i.[Status]
		WHEN 2 THEN 0
		ELSE 1
	END [Status], [Web Item], i.[Freight Only], i.[Base Unit of Measure], i.[Free Shipping], 
	w.[Add Handling Charge], i.[Profit %], i.[Keywords], i.[Equivalent Grp_], 
	GETDATE(), GETDATE() [AddedDT], i.[Ship Alone],  
	CASE	
		WHEN [Reorder Point] > 0 THEN 1
		ELSE 0
	END [stockItem], i.[Reorder Point], i.[Maximum Inventory], i.[Reorder Quantity], 
	i.[Shelf No_], w.[Priority], NULL, w.[UPC], i.[Vendor Quick Ship],
	CASE i.[Status]
		WHEN 4 THEN 1
		ELSE 0
	END [Special Order]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i 
	LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Web Item] w ON i.[No_] = w.[No_]
	LEFT JOIN products p on p.code = i.[No_] COLLATE Latin1_General_CS_AS
WHERE [Blocked] = 0
		AND [Web Item] = 1 
		AND LEN(i.[No_]) > 3
		AND p.CODE is null
		AND i.[No_] NOT IN ('144-SPO10CW100', '144-TG6100') -- EXCLUDING THE PURPLE TONG FOR YOGURT MOUNTAIN

--UPDATE ALL products MARKED AS CHANGED THROUGH LAST MODIFIED DATE ON NAV
UPDATE P
SET	p.[NAME] = LTRIM(RTRIM(REPLACE(i.[Product Name], CHAR(10), ''))), 
	p.[NAVDesc] = i.[Description], 
	p.[IMAGE] = REPLACE(LOWER(REPLACE(REPLACE(i.[Image File Name], CHAR(10), ''), CHAR(13), '')), '.JPG', ''),
	p.weight = CAST(i.[Gross Weight] AS DECIMAL(10, 2)),
	p.prodL = i.[Shipping Length], 
    p.prodW = i.[Shipping Width], 
	p.prodH = i.[Shipping Height],
	P.[cube] = cast((i.[Shipping Length]*i.[Shipping Width]*i.[Shipping Height])/1728 as decimal(10, 2)),
	p.active = CASE i.[Status]
					WHEN 2 THEN 0
					ELSE 1
				END, 
	p.[isWeb] = i.[Web Item], 
	p.freightOnly = i.[Freight Only], 
	p.UOM = null,
	p.katomUOM = i.[Base Unit of Measure], 
	p.freeShipping = i.[Free Shipping], 
	p.[handlingCharge] = w.[Add Handling Charge],  
	p.[keywords] = i.[Keywords], 
	p.[EquivGrp] = i.[Equivalent Grp_],  
	p.updatedt = i.[Last Date Modified],
	p.[shipAlone] = i.[Ship Alone],   
	p.[stockItem] = CASE	
						WHEN [Reorder Point] > 0 THEN 1
						ELSE 0
					END,  
	p.[thresholdMin] = i.[Reorder Point],  
	p.[thresholdMax] = i.[Maximum Inventory],  
	p.[reorderQty] = i.[Reorder Quantity],  
	p.[binLocation] = i.[Shelf No_], 
	p.[sitemapPriority] = w.[Priority], 
	p.relatedItems = w.[related products],  
	p.[upc] = w.[UPC],  
	p.[webActive] = i.[Web Active],
	p.mpn = i.[Web Item No_],
	p.vendorid = i.[Vendor No_],
	p.specialOrder = CASE i.[Status]
							WHEN 4 THEN 1
							ELSE 0
						END,
	p.[prodDesc] = dbo.[prodDescriptionBuilder](CODE),
	p.quickShip = i.[Vendor Quick Ship]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i 
		LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Web Item] w on i.[No_] = w.[No_]
		JOIN products p ON LTRIM(RTRIM(i.[No_])) = p.code COLLATE Latin1_General_CS_AS 	
WHERE i.[No_] NOT IN ('144-SPO10CW100', '144-TG6100') -- EXCLUDING THE PURPLE TONG FOR YOGURT MOUNTAIN


WHILE EXISTS(SELECT * FROM products WHERE CHARINDEX('.jpg', [image]) > 0)
   BEGIN
	UPDATE products SET [image] = REPLACE(LOWER([image]), '.JPG', '') WHERE CHARINDEX('.jpg', [image]) > 0
   END
   
--UPDATE UOM
update p 
set p.katomUOM = u.[Code],
	p.uom = [dbo].[UOM_Conversion](u.[Description])
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Unit of Measure] u	
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON u.[Code] = i.[Base Unit of Measure]
		JOIN products p on p.CODE = LTRIM(RTRIM(i.[No_]))	 COLLATE Latin1_General_CS_AS

--REMOVE ALL DUPLICATE ENTRIES
DELETE FROM products WHERE code IS NULL

DECLARE @CODE VARCHAR(100), @prodid int, @position varchar(100)

SET @position = ''

DECLARE lagCursor CURSOR FOR 
select prodid, code
from products p 
where code in (select code 
				from products where active = 1
				group by code
				having count(*) > 1)
ORDER BY code

OPEN lagCursor
FETCH NEXT FROM lagCursor INTO @prodid, @CODE

WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @position = @code
	   begin
		delete from products where prodid = @prodid
	   end
	ELSE
	   BEGIN
		set @position = @code
	   END
	FETCH NEXT FROM lagCursor INTO @prodid, @CODE
   END

CLOSE lagCursor
DEALLOCATE lagCursor

--UPDATING MFGNAME
UPDATE p
SET p.mfgname = m.mfgName
FROM products p JOIN mfg m ON p.mfgID = m.mfgID 

--UPDATING products WITH INVENTORY COUNT
TRUNCATE TABLE prodInventory

INSERT INTO prodInventory
SELECT [Item No_], SUM(CAST([Quantity] AS FLOAT)) -
				(SELECT isnull(SUM(CAST([Quantity] AS FLOAT)), 0)
				 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line]
				 WHERE [No_] = l.[Item No_] AND [Document Type] = 1)
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] l
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[No_] = l.[Item No_]
WHERE CHARINDEX('100-', [Item No_]) = 0 
GROUP BY [Item No_]

UPDATE products SET qtyOnHand = 0

UPDATE p SET p.qtyOnHand = i.qty FROM products p JOIN prodInventory i ON p.code = i.code

--REMOVE DISCONTINUED PRODUCTS ADDED TODAY WITH NO INVENTORY AND ACTIVATE DISCONT. PROD W/ INVENTORY ON HAND 
DELETE FROM products WHERE qtyOnHand < 1 AND active = 0 AND DATEDIFF(DAY, addedDT, GETDATE()) = 0
UPDATE products SET active = 1, isWeb = 1 WHERE qtyOnHand > 0 AND active = 0

--INACTIVATE ALL CURRENT DISCONTINUED PRODUCTS WITH 0 INVENTORY
UPDATE p SET ACTIVE = 0 
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE p.ACTIVE = 1 AND i.[Status] = 2 AND p.qtyonhand < 1

--CREATING BACKORDER ITEM LIST
TRUNCATE TABLE backOrder_item

INSERT INTO backOrder_item
select l.[No_], p.price, p.thresholdMin, p.ThresholdMax, 
	(SELECT ISNULL(SUM(CAST([Quantity] AS FLOAT)), 0) FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry]
		WHERE [Item No_] = l.[No_]) qtyOnHand, 
	COUNT(distinct  l.[Document No_]) numOfOrder, 
	sum(l.[Quantity]) numItem, p.qtyonhand, MIN(h.[Order Date]) [Oldest Order orderDT]
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] l
	JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
		ON l.[Document No_] = h.[No_]
	JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
where h.[Document Type] = 1
	and p.thresholdMin > 0
	and qtyOnHand < 1
group by l.[No_], p.price, p.thresholdMin, p.ThresholdMax, p.qtyonhand

--DELETE ALL 599 products FROM DB
UPDATE products
SET active = 0
WHERE LEFT(code, 3) = '599' AND ACTIVE = 1

/**
UPDATE MAP DATA TO DATA FEED
1. FEED MAP PRICE TO DATA FEED
2. FEED KATOM PRICE TO DATA FEED
3. DON'T FEED TO DATAFEED
**/
UPDATE products SET MAP_Program = NULL, feedMAP = 2, MAP_Price = NULL, MAP = 0

UPDATE p 
SET p.MAP = g.[MAP],
	p.MAP_Program =
		CASE g.[Map Program]
			WHEN 1 THEN 'K' --DISPLAY KATOM PRICE
			WHEN 2 THEN 'E' --EMAIL ME MY PRICE
			WHEN 3 THEN 'A' --ADD TO CART
			WHEN 4 THEN 'C' --CALL FOR INFORMATION
			WHEN 5 THEN 'X' --DON'T LIST
			ELSE 'K'
		END,
	p.feedMAP =   
	CASE 
		WHEN ISNULL(g.[Map Program], 1) = 1 THEN 2
		ELSE ISNULL(g.[Feed Rules], 2)
	END		
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] g
	join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[Item Disc_ Group] = g.Code
	join products p on p.code = i.[No_] COLLATE Latin1_General_CS_AS
where g.[MAP] = 1 AND p.active = 1

--ADD MivaProdID WHERE NONE EXISTS  - added 1/11-2013 by MS - to be removed when FAB migrates
Update products SET mivaProdID = prodid + 1000000 where mivaProdID is null

--UPDATING PRICING
exec dbo.[product_Pricing_Update_SP]
	
-- MOVING products TO CLEARANCE BIN
exec dbo.[stockCloseout]

--ASSIGNING CORRECT CATEGORY TO products -- INCREMENTAL
exec dbo.[product_categorization_SP] 'FULL'

--SET EQUIVALENT INFORMATION FOR CORY DISCONTINUED PAGE 
EXEC [dbo].[products_equivalent_sp]

--MARK products TO LIST ON FROSTY ACRES SITE
UPDATE products SET fa = 0, NAME = LTRIM(RTRIM(NAME))

UPDATE products 
SET fa = 1 
WHERE qtyOnHand > 0 --OR thresholdMin > 0 

UPDATE p 
SET fa = 1 
FROM products p JOIN mfg m ON p.mfgID = m.mfgID
WHERE ISNULL(m.frostyacres, 0) = 1 AND fa = 0

UPDATE products
SET fa = 1  
where code = '175-40813'

--SET PRODUCTS TO QUICKSHIP IF QTYONHAND > 0
UPDATE products 
SET quickShip = 
	CASE 
		WHEN qtyOnHand > 0 THEN 1
		ELSE 0
	END,
	leadTime = 
	CASE 
		WHEN qtyOnHand > 0 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span>'
		ELSE NULL
	END
Where quickShip = 0

--UPDATE PACK SIZE AND STACKABLE INFORMATION FROM EXTERNAL TABLE
UPDATE p
SET p.packsize = s.packsize,
	p.stackable = s.stackable
FROM products p JOIN productpacksize s ON p.code = s.code


--POPULATE PRODUCTS ATTRIBUTES TABLE
TRUNCATE TABLE products_attributes

INSERT INTO products_attributes
SELECT ri.[Item No_], 
	r.[Description],
	ri.[Refinable Value]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] ri 
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Refinable] r ON  ri.[Refinable No_] = r.[No_]
		JOIN products p ON ri.[Item No_] = p.CODE COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE p.active = 1 
	AND p.isWeb = 1
	AND LEN(ri.[Refinable Value]) > 0	
	AND ri.[Refinable No_] NOT IN ('GSA')
ORDER BY code


--REMOVE ALL BLENDTEC RESIDENTIAL FROM BB SITE
UPDATE products SET bb = 0 WHERE mfgID ='579' AND bb = 1

--Update PDF/Spec information  
UPDATE products
SET specSheet = i.pdf,
	image_exists = i.image,
	large_image_exists = i.large_image
FROM products p JOIN image_results2 i ON p.code = i.code

--ACTIVATE ALL DISCONTINUED ITEMS WITH QTYONHAND > 0
UPDATE products
SET ACTIVE = 1, isWeb = 1
WHERE qtyOnHand > 0

--RELATEDITEMS CLEAN UP - REMOVE ALL NON-ACTIVE PRODUCTS
EXEC dbo.[product_relatedItems_Cleanup_SP] 'FULL'

--INSERTING SPECIAL PROMOTION TEXT FOR THE WARING BLENDER
UPDATE products
SET extendedDescription = '<p>Waring offers mixing products of excellence and reliability in today''s growing restaurant supply world. Add these qualities to your own business with the Waring Margarita Madness Blender and you''ll never mix with anything else!</p><p>The Waring drink blender can handle anything from a colorful bar drink to the perfect margarita, but that''s not all. The Waring Margarita Madness drink blender features a 48 ounce clear polycarbonate container that is virtually unbreakable. For a quick, no wait mixing experience, this bar blender features a powerful 1 1/2 horsepower motor balanced to minimize vibration and built to last. With a smooth, rounded design this durable, blender is so easy to clean. For great versatility in drink preparation don''t overlook this Waring blender!</p>'
WHERE CODE = '141-MMB142' and qtyOnHand < 2

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[productsSynchNAVtoProducts]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[productsSynchNAVtoProducts]
AS
BEGIN
DECLARE @jobID INT
INSERT INTO jobHistory(jobName, startdT) values('PROD_NAV', GETDATE())
SET @jobID = @@identity

--DELETING ALL products WHERE IT DOES NOT EXIST IN NAVISION
DELETE p
FROM products p LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i on p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE i.[No_] IS NULL

--INSERT ALL PRODUCTS FROM NAV NOT IN THE PRODUCTS TABLE
INSERT INTO products
	([mfgID], [vendorID], [mpn], [CODE], [NAME], [NAVDesc], [IMAGE], [cost], [Price], [listPrice], [WEIGHT], [prodL], [prodW], 
	 [prodH], [ACTIVE], [isWeb], [freightOnly], [katomUOM], [freeShipping], [handlingCharge], [currentMargin], 
	 [keywords], [EquivGrp], [updateDT], [addedDT], [shipAlone], [stockItem], [thresholdMin], [thresholdMax], 
	 [reorderQty], [binLocation], [sitemapPriority], [ICDiscountGrp], [upc], quickShip, specialOrder)
SELECT 
	LEFT(i.[No_], 3) [Mfg ID], i.[Vendor No_], i.[Web Item No_], LTRIM(RTRIM(i.[No_])),
	LTRIM(RTRIM(REPLACE(i.[Product Name], CHAR(10), ''))), i.[Description], REPLACE(LOWER(REPLACE(REPLACE(i.[Image File Name], CHAR(13), ''), CHAR(10), '')), '.JPG', '') [Image File Name], 
	0 [Last Direct Cost], 
	0 [UnitPrice2], 
	0 [UnitPrice], 
	i.[Gross Weight], i.[Shipping Length], i.[Shipping Width], i.[Shipping Height], 
	CASE i.[Status]
		WHEN 2 THEN 0
		ELSE 1
	END [Status], [Web Item], i.[Freight Only], i.[Base Unit of Measure], i.[Free Shipping], 
	w.[Add Handling Charge], i.[Profit %], i.[Keywords], i.[Equivalent Grp_], 
	GETDATE(), GETDATE() [AddedDT], i.[Ship Alone],  
	CASE	
		WHEN [Reorder Point] > 0 THEN 1
		ELSE 0
	END [stockItem], i.[Reorder Point], i.[Maximum Inventory], i.[Reorder Quantity], 
	i.[Shelf No_], w.[Priority], NULL, w.[UPC], i.[Vendor Quick Ship],
	CASE i.[Status]
		WHEN 4 THEN 1
		ELSE 0
	END [Special Order]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i 
	LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Web Item] w ON i.[No_] = w.[No_]
	LEFT JOIN products p on p.code = i.[No_] COLLATE Latin1_General_CS_AS
WHERE [Blocked] = 0
		AND [Web Item] = 1 
		AND LEN(i.[No_]) > 3
		AND p.CODE is null
		AND i.[No_] NOT IN ('144-SPO10CW100', '144-TG6100') -- EXCLUDING THE PURPLE TONG FOR YOGURT MOUNTAIN

--UPDATE ALL products MARKED AS CHANGED THROUGH LAST MODIFIED DATE ON NAV
UPDATE P
SET	p.[NAME] = LTRIM(RTRIM(REPLACE(i.[Product Name], CHAR(10), ''))), 
	p.[NAVDesc] = i.[Description], 
	p.[IMAGE] = REPLACE(LOWER(REPLACE(REPLACE(i.[Image File Name], CHAR(10), ''), CHAR(13), '')), '.JPG', ''),
	p.weight = CAST(i.[Gross Weight] AS DECIMAL(10, 2)),
	p.prodL = i.[Shipping Length], 
    p.prodW = i.[Shipping Width], 
	p.prodH = i.[Shipping Height],
	P.[cube] = cast((i.[Shipping Length]*i.[Shipping Width]*i.[Shipping Height])/1728 as decimal(10, 2)),
	p.active = CASE i.[Status]
					WHEN 2 THEN 0
					ELSE 1
				END, 
	p.[isWeb] = i.[Web Item], 
	p.freightOnly = i.[Freight Only], 
	p.UOM = null,
	p.katomUOM = i.[Base Unit of Measure], 
	p.freeShipping = i.[Free Shipping], 
	p.[handlingCharge] = w.[Add Handling Charge],  
	p.[keywords] = i.[Keywords], 
	p.[EquivGrp] = i.[Equivalent Grp_],  
	p.updatedt = i.[Last Date Modified],
	p.[shipAlone] = i.[Ship Alone],   
	p.[stockItem] = CASE	
						WHEN [Reorder Point] > 0 THEN 1
						ELSE 0
					END,  
	p.[thresholdMin] = i.[Reorder Point],  
	p.[thresholdMax] = i.[Maximum Inventory],  
	p.[reorderQty] = i.[Reorder Quantity],  
	p.[binLocation] = i.[Shelf No_], 
	p.[sitemapPriority] = w.[Priority], 
	p.relatedItems = w.[related products],
	p.[upc] = w.[UPC],  
	p.[webActive] = i.[Web Active],
	p.mpn = i.[Web Item No_],
	p.vendorid = i.[Vendor No_],
	p.specialOrder = CASE i.[Status]
							WHEN 4 THEN 1
							ELSE 0
						END,
	p.[prodDesc] = dbo.[prodDescriptionBuilder](CODE),
	p.quickShip = i.[Vendor Quick Ship]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i 
		LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Web Item] w on i.[No_] = w.[No_]
		JOIN products p ON LTRIM(RTRIM(i.[No_])) = p.code COLLATE Latin1_General_CS_AS 	
WHERE DATEDIFF(DAY, i.[Last Date Modified], GETDATE()) = 1


--SETTING DUKE OVENS TO DUKE MFG
UPDATE products
SET mfgID = '212'
WHERE mfgID = '066'

--UPDATE UOM
update p 
set p.katomUOM = u.[Code],
	p.uom = [dbo].[UOM_Conversion](u.[Description])
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Unit of Measure] u	
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON u.[Code] = i.[Base Unit of Measure]
		JOIN products p on p.CODE = LTRIM(RTRIM(i.[No_]))	 COLLATE Latin1_General_CS_AS
WHERE p.UOM IS NULL

--REMOVE ALL DUPLICATE ENTRIES
DELETE FROM products WHERE code IS NULL

DECLARE @CODE VARCHAR(100), @prodid int, @position varchar(100)

SET @position = ''

DECLARE lagCursor CURSOR FOR 
select prodid, code
from products p 
where code in (select code 
				from products where active = 1
				group by code
				having count(*) > 1)
ORDER BY code

OPEN lagCursor
FETCH NEXT FROM lagCursor INTO @prodid, @CODE

WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @position = @code
	   begin
		delete from products where prodid = @prodid
	   end
	ELSE
	   BEGIN
		set @position = @code
	   END
	FETCH NEXT FROM lagCursor INTO @prodid, @CODE
   END

CLOSE lagCursor
DEALLOCATE lagCursor

--UPDATING MFGNAME
UPDATE p
SET p.mfgname = m.mfgName
FROM products p JOIN mfg m ON p.mfgID = m.mfgID 
WHERE DATEDIFF(DAY, updatedt, GETDATE()) = 0


--UPDATING products WITH INVENTORY COUNT
TRUNCATE TABLE prodInventory

INSERT INTO prodInventory
SELECT [Item No_], SUM(CAST([Quantity] AS FLOAT)) -
				(SELECT isnull(SUM(CAST([Quantity] AS FLOAT)), 0)
				 FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line]
				 WHERE [No_] = l.[Item No_] AND [Document Type] = 1)
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry] l
			JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[No_] = l.[Item No_]
WHERE CHARINDEX('100-', [Item No_]) = 0 
GROUP BY [Item No_]

UPDATE products SET qtyOnHand = 0

UPDATE p SET p.qtyOnHand = i.qty FROM products p JOIN prodInventory i ON p.code = i.code

--REMOVE DISCONTINUED PRODUCTS ADDED TODAY WITH NO INVENTORY AND ACTIVATE DISCONT. PROD W/ INVENTORY ON HAND 
DELETE FROM products WHERE qtyOnHand < 1 AND active = 0 AND DATEDIFF(DAY, addedDT, GETDATE()) = 0
UPDATE products SET active = 1 WHERE qtyOnHand > 0 AND active = 0 AND DATEDIFF(DAY, addedDT, GETDATE()) = 0 

--INACTIVATE ALL CURRENT DISCONTINUED PRODUCTS WITH 0 INVENTORY
UPDATE p SET ACTIVE = 0 
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
WHERE p.ACTIVE = 1 AND i.[Status] = 2 AND p.qtyonhand < 1

--CREATING BACKORDER ITEM LIST
TRUNCATE TABLE backOrder_item

INSERT INTO backOrder_item
select l.[No_], p.price, p.thresholdMin, p.ThresholdMax, 
	(SELECT ISNULL(SUM(CAST([Quantity] AS FLOAT)), 0) FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Ledger Entry]
		WHERE [Item No_] = l.[No_]) qtyOnHand, 
	COUNT(distinct  l.[Document No_]) numOfOrder, 
	sum(l.[Quantity]) numItem, p.qtyonhand, MIN(h.[Order Date]) [Oldest Order orderDT]
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Line] l
	JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Sales Header] h
		ON l.[Document No_] = h.[No_]
	JOIN products p ON p.CODE = l.[No_] collate Latin1_General_CS_AS
where h.[Document Type] = 1
	and p.thresholdMin > 0
	and qtyOnHand < 1
group by l.[No_], p.price, p.thresholdMin, p.ThresholdMax, p.qtyonhand

--DELETE ALL 599 products FROM DB
UPDATE products
SET active = 0
WHERE LEFT(code, 3) = '599' AND ACTIVE = 1

/**
UPDATE MAP DATA TO DATA FEED
1. FEED MAP PRICE TO DATA FEED
2. FEED KATOM PRICE TO DATA FEED
3. DON'T FEED TO DATAFEED
**/
UPDATE products SET MAP_Program = NULL, feedMAP = 2, MAP_Price = NULL, MAP = 0

UPDATE p 
SET p.MAP = g.[MAP],
	p.MAP_Program =
		CASE g.[Map Program]
			WHEN 1 THEN 'K' --DISPLAY KATOM PRICE
			WHEN 2 THEN 'E' --EMAIL ME MY PRICE
			WHEN 3 THEN 'A' --ADD TO CART
			WHEN 4 THEN 'C' --CALL FOR INFORMATION
			WHEN 5 THEN 'X' --DON'T LIST
			ELSE 'K'
		END,
	p.feedMAP =   
	CASE 
		WHEN ISNULL(g.[Map Program], 1) = 1 THEN 2
		ELSE ISNULL(g.[Feed Rules], 2)
	END		
from fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Discount Group] g
	join fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[Item Disc_ Group] = g.Code
	join products p on p.code = i.[No_] COLLATE Latin1_General_CS_AS
where g.[MAP] = 1 AND p.active = 1

--UPDATING PRICING
exec dbo.[product_Pricing_Update_SP]

-- MOVING products TO CLEARANCE BIN
exec dbo.[stockCloseout]

--ASSIGNING CORRECT CATEGORY TO products -- INCREMENTAL
exec dbo.[product_categorization_SP] 'INCREMENTAL'

--SET EQUIVALENT INFORMATION FOR DISCONTINUED PAGE 
EXEC [dbo].[products_equivalent_sp]

--MARK products TO LIST ON FROSTY ACRES SITE
UPDATE products SET fa = 0, NAME = LTRIM(RTRIM(NAME))

--MARK AN ITEM IF IT IS GSA APPROVED
UPDATE products SET GSA = 0

UPDATE p
SET p.GSA = 
		CASE 
			WHEN ISNULL(r.[Refinable Value], 0) = 'Yes' THEN 1
			ELSE 0
		END
FROM products p JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] r ON p.CODE = r.[Item No_] COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE r.[Refinable No_] = 'GSA'


UPDATE products 
SET fa = 1 
WHERE qtyOnHand > 0 --OR thresholdMin > 0 

UPDATE p 
SET fa = 1 
FROM products p JOIN mfg m ON p.mfgID = m.mfgID
WHERE ISNULL(m.frostyacres, 0) = 1 AND fa = 0

UPDATE products
SET fa = 1  
where code = '175-40813'

--SET PRODUCTS TO QUICKSHIP IF QTYONHAND > 0
UPDATE products 
SET quickShip = 
	CASE 
		WHEN qtyOnHand > 0 THEN 1
		ELSE 0
	END,
	leadTime = 
	CASE 
		WHEN qtyOnHand > 0 THEN 'Typically ships within <span class="bold"> 1 - 2 business days</span>'
		ELSE NULL
	END
Where quickShip = 0

--UPDATE PACK SIZE AND STACKABLE INFORMATION FROM EXTERNAL TABLE
UPDATE p
SET p.packsize = s.packsize,
	p.stackable = s.stackable
FROM products p JOIN productpacksize s ON p.code = s.code


--POPULATE PRODUCTS ATTRIBUTES TABLE
TRUNCATE TABLE products_attributes

INSERT INTO products_attributes
SELECT ri.[Item No_], 
	r.[Description],
	ri.[Refinable Value]
FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Refinables] ri 
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Refinable] r ON  ri.[Refinable No_] = r.[No_]
		JOIN products p ON ri.[Item No_] = p.CODE COLLATE SQL_Latin1_General_CP1_CI_AS
WHERE p.active = 1 
	AND p.isWeb = 1
	AND LEN(ri.[Refinable Value]) > 0	
	AND ri.[Refinable No_] NOT IN ('GSA')
ORDER BY code

--ADD MivaProdID WHERE NONE EXISTS  - added 1/11-2013 by MS - to be removed when FAB migrates
Update products SET mivaProdID = prodid + 1000000 where mivaProdID is null

--REMOVE ALL BLENDTEC RESIDENTIAL FROM BB SITE
UPDATE products SET bb = 0 WHERE mfgID ='579' AND bb = 1

--Update PDF/Spec information  
UPDATE products
SET specSheet = i.pdf,
	image_exists = i.image,
	large_image_exists = i.large_image
FROM products p JOIN image_results2 i ON p.code = i.code

--INSERTING SPECIAL PROMOTION TEXT FOR THE WARING BLENDER
UPDATE products
SET extendedDescription = '<p>Waring offers mixing products of excellence and reliability in today''s growing restaurant supply world. Add these qualities to your own business with the Waring Margarita Madness Blender and you''ll never mix with anything else!</p><p>The Waring drink blender can handle anything from a colorful bar drink to the perfect margarita, but that''s not all. The Waring Margarita Madness drink blender features a 48 ounce clear polycarbonate container that is virtually unbreakable. For a quick, no wait mixing experience, this bar blender features a powerful 1 1/2 horsepower motor balanced to minimize vibration and built to last. With a smooth, rounded design this durable, blender is so easy to clean. For great versatility in drink preparation don''t overlook this Waring blender!</p>'
WHERE CODE = '141-MMB142' and qtyOnHand < 2

--ACTIVATE ALL DISCONTINUED ITEMS WITH QTYONHAND > 0
UPDATE products
SET ACTIVE = 1, isWeb = 1
WHERE qtyOnHand > 0

--RELATEDITEMS CLEAN UP - REMOVE ALL NON-ACTIVE PRODUCTS
EXEC dbo.[product_relatedItems_Cleanup_SP] 'PARTIAL'

--REMOVE ALL NON-ACTIVE PARTS FROM THE WEB
DELETE FROM products WHERE isWeb = 0 AND ICDiscountGrp LIKE '%-part%'

--REMOVE ALL TRUE S&D FROM SITE
DELETE FROM products WHERE LEFT(code, 3) = '599'

UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID
END
GO
/****** Object:  StoredProcedure [dbo].[products_FA_SP]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[products_FA_SP]
AS
BEGIN
	EXEC dbo.[categories_FA_SP]
	
	SELECT
		p.prodid, mfgID, mfgName, mpn, CODE, NAME, IMAGE,fa_price,listPrice, 
		ISNULL(metaDescription, '') metaDescription, prodDesc, 
		WEIGHT, prodL, prodW, prodH, CUBE,  freightOnly, UOM, 
		CASE
			WHEN leadTime IS NULL THEN leadTime_mfg
			ELSE leadTime
		END	leadTime, 
		ISNULL(energyStar, 0) energyStar, EquivGrp, shipAlone, 
		ISNULL(cx.catID, '') primaryCatID, ISNULL(cx.catCode, '') primaryCatCode,
		dbo.[getProdCateogrySLI](CODE, 'catCode') categories,
		ISNULL(relatedItems, '') relatedItems, 
		qtyOnHand, sales30, packsize, stackable, ISNULL(clearance,0) clearance,
		CASE
			--Modified 12-31 by MS - changed the null conditional from '' to a default breadcrumb
			WHEN cx.catCode IS NULL THEN '<div class="breadcrumb"><a href="http://www.fabeqsupply.com" title="FAB EQ Supply">FAB EQ Supply</a>&nbsp;>&nbsp;<strong>'+NAME+'</strong></div>'
			ELSE dbo.[getBreadcrumb](cx.catCode, NAME)
		END breadcrumb
	FROM products p LEFT JOIN catxprod_FA cx ON p.CODE = cx.prodCode AND cx.primaryCat = 1
	WHERE ACTIVE = 1 AND isWeb = 1 AND fa = 1
	
END
GO
/****** Object:  StoredProcedure [dbo].[FedexTrackingEmailerTEST]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
Create PROCEDURE [dbo].[FedexTrackingEmailerTEST] 
	-- Updated 11/16 - moved update for emailupdate flag into the email loop
AS
BEGIN

SET NOCOUNT ON;

-- Insert statements for procedure here
/*select [Order No_], [Ship-to name], [Ship-to Address], [Ship-to City], [Ship-to ZIP Code],  TrackingNo, x.[Shipping Agent Code], Carrier, webAddress, [tracking URL]
FROM [KatomDev].[dbo].[invoice_backup] i
join [KatomDev].[dbo].[ship_backup] s
on [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
join shipurl x
on s.[ShippingAgentCode] = x.[Shipping Agent Code]
where [Order No_] <> ''
order by OrderNo desc*/


/*Copies information from FS1 DB and Shiptracking DB to WEBSQL db for use*/
exec invoicebackupcopy
------------------------------------------------------------------------------------------*/
/*Begins the loop to pull down and parse payment information*/
	DECLARE @OuterOrder varchar(50)
	DECLARE @Order varchar(50)
	DECLARE @email varchar(50)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoadd varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @billtoname varchar(30)
	DECLARE @billtoadd varchar(30)
	DECLARE @billtocity varchar(30)
	DECLARE @billtostate varchar(10)
	DECLARE @billtozip varchar(10)
	DECLARE @phone varchar(20)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)
	DECLARE @delivereddate varchar(255)
	DECLARE @shipdate varchar(255)
	DECLARE @delivered varchar(255)
	DECLARE @emailupdate bit
	DECLARE @trackingscan varchar(255)
	DECLARE @signby varchar(255)
	DECLARE @company varchar(255)
	DECLARE @result varchar(255)

	
	DECLARE OuterEmailCursor CURSOR FOR
	
	select [Order No_]
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[trackingInfo] s
	on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
	left outer join [KatomDev].[dbo].shipurl x
	on x.[shipping agent code] = s.carrier
	where i.[E-Mail] <> '' and i.[E-Mail] like ('%@%')
	and NOT ([Delivered] = 'True' and emailUpdate = 0)
	and katomorderid <> ''
	and emailupdate = 1
	and datediff(d, getdate(), [ship date]) > -14
	and [Bill-to Name] not like 'FROSTY ACRES%'
	and [Sell-to Customer No_] not in ('12557','29909','79517','165938','240089')
	group by [Order No_]
	order by [Order No_] desc
	
	OPEN OuterEmailCursor
	
	FETCH NEXT FROM OuterEmailCursor INTO @OuterOrder

	WHILE @@FETCH_STATUS = 0
	BEGIN

			DECLARE DemoCursor CURSOR FOR 
			
			select top 1 [Order No_], i.[E-mail], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to county], [Ship-to post Code], 
			[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to county], [Sell-to post Code], [phone No_], 
			x.Carrier, webAddress, [tracking URL], [Delivered Date], [Ship Date], Delivered, 
			emailupdate, [tracking scan], [sign by], [Shortcut Dimension 2 Code]
				--select i.[E-Mail]	
			FROM [KatomDev].[dbo].[invoice_backup] i
			join [KatomDev].[dbo].[trackingInfo] s
			on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
			left outer join [KatomDev].[dbo].shipurl x
			on x.[shipping agent code] = s.carrier
			where [Order No_] = @OuterOrder
			--in ('963453', '963245', '963240', '963236', '963233')
			order by [Order No_] desc

			OPEN DemoCursor

			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
			@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @carrier, @webadd, @trackURL, @delivereddate,
			@shipdate, @delivered, @emailupdate, @trackingscan, @signby, @company

			WHILE @@FETCH_STATUS = 0
			BEGIN
			
			
					print @Order
					print @email
					SET @email1 = @email
					IF @delivered = 'FALSE' BEGIN SET @subject1 = 'Order #'+@order+' Shipment Notification'	END
					ELSE IF @delivered = 'TRUE' BEGIN SET @subject1 = 'Order #'+@order+' Delivery Notification'	END
					ELSE IF @delivered is null BEGIN SET @subject1 = 'Order #'+@order+' Tracking Notification'	END
					ELSE BEGIN SET @subject1 = 'X' END
					print @delivered+' '+cast(@emailupdate as varchar(1))+' = '+@subject1
					
					SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
									"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
									<html xmlns="http://www.w3.org/1999/xhtml">
									<head>
									<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
									<title>E-Mail</title>

									<style type="text/css">
									html{font-family:Lucida Grande;}
									</style>

									</head>
									<body>'
					IF @company = 'KATOM' 
							BEGIN 
								SET @body1=@body1+'<a href="http://www.katom.com">
									<img width="194" height="60" title="KaTom Restaurant Supply Inc." alt="KaTom Restaurant Supply Inc." src="http://www.katom.com/Merchant2/css/sterile/seasonallogo.gif" border="0"><br />
									<span style="
									font-family:Arial;
									font-size:11px;
									font-variant:small-caps;
									font-weight:400;
									left:4px;
									letter-spacing:2px;
									margin:0;
									padding:0 0 0 1px;
									position:relative;
									top:-1px;
									text-decoration:underline
									">
									RESTAURANT SUPPLY, INC.
									</span>
									</a>' 
									
							END
					SET @body1=@body1+'<table border="0" width="632" style="font-family:Lucida Grande; font-weight:100; background:#585757;color:#fff;" cellpadding="2">
									<tr>
									<td width="10px;"></td>
									<td colspan="2">
									<br />'
			
			IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">ON ITS WAY...</span>'
			IF @delivered = 'TRUE' and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">CONGRATULATIONS...</span>'
			
					SET @body1 = @body1+'</td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td>'
						
			IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 and @company = 'KATOM' SET @body1 = @body1+'			
						<span style="color:#e9ba20; font-size:30px; font-weight:600px">Good news &mdash; your package has shipped.</span>
						<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package from <a href="http://www.katom.com" style="color:#FFF">Katom Restaurant Supply</a> is on its way.  Here''s your shipping confirmation:</p>'

			IF @delivered = 'TRUE' and @emailupdate = 1 and @company = 'KATOM' SET @body1 = @body1+'			
						<span style="color:#e9ba20; font-size:18px; font-weight:600px">The carrier has indicated that your package has been delivered.</span>'
			
			IF (@signby <> 'N/A' and @signby is not null) and @company = 'KATOM' SET @body1 = @body1+'			
						<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package was signed for by: '+@signby+'</p>'
						
					SET @body1 = @body1+'
						</td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td colspan="2"><span style="color:#e9ba20;
						font-family:lucida grande;
						font-weight:600;">ORDER NUMBER.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+@order+'</span></td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td colspan="2"><span style="color:#e9ba20;
						font-family:lucida grande;
						font-weight:600;">SHIPPING DATE.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+convert(varchar,datepart(mm,@shipdate)) + '.' + convert(varchar,datepart(dd,@shipdate)) + '.' + convert(varchar,datepart(yyyy,@shipdate))+'</span></td>
						</tr>'
						
							DECLARE TrackingCursor CURSOR FOR
							
							select [Tracking Number], [tracking url] from trackingInfo i
							left outer join [KatomDev].[dbo].shipurl x
							on x.[shipping agent code] = i.carrier
							where KatomOrderID = @order		
							OPEN TrackingCursor
							
							FETCH NEXT FROM TrackingCursor INTO @trackno, @trackURL

							WHILE @@FETCH_STATUS = 0
							BEGIN
							
							print @order+'-'+@trackno
								
							SET @body1 = @body1+'<tr>
								<td width="10px;"></td>
								<td colspan="2"><span style="color:#e9ba20;
								font-family:lucida grande;
								font-weight:600;">TRACKING NUMBER.</span> <a href="'+REPLACE(@trackurl, '<%trackingNum%>', @trackno)+'" style="color:#FFF">'+@trackno+'</a>
								</td>
								</tr>'
								
							--IF @subject1 <> 'X' Update trackingInfo set emailUpdate = 0 where [Tracking Number] = @trackno

							FETCH NEXT FROM TrackingCursor INTO @trackno, @trackurl

							END

							CLOSE TrackingCursor

							DEALLOCATE TrackingCursor
						
						
						
					SET @body1 = @body1+'</table>
						<table cellspacing="0">
						<tr height="8">
						<td>
						</td>
						</tr>
						<table>
						<tr>
						<td height="4px">
						</td>
						</tr>
						</table>
						</table>
						<table width="625" style="border-color:#000; border-style:solid; border-width:1px;">
						<tr>
						<td>
						<table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr>
						<td width="9px" style="background:#999; font-weight:600; color:#666">
						</td>
						<td colspan="2" style="background:#999; font-weight:600; color:#666; font-size:14px">
						ORDER INFORMATION
						</td>
						</tr>
						<tr>
						<td height="9px">
						</td>
						</tr>
						<tr>
						<td width="9px"></td>
						<td style="font-size:12px; font-weight:600">
						BILLING INFORMATION:
						</td>
						<td style="font-size:12px; font-weight:600">
						SHIPPING INFORMATION:
						</td>
						</tr>
						<tr>
						<td width="9px"></td>
						<td>
						<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr><td>'+@billtoname+'</td></tr>
						<tr><td>'+@billtoadd+'</td></tr>
						<tr><td>'+@billtocity+', '+@billtostate+' '+@billtozip+'</td></tr>
						<tr><td>Primary Phone: '+@phone+'</td></tr>
						<tr><td>Email: '+@email+'</td></tr>
						</table>
						</td>
						<td valign="top">
						<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr><td>'+@shiptoname+'</td></tr>
						<tr><td>'+@shiptoadd+'</td></tr>
						<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
						</table>
						</td>
						</tr>
						</table>
						</td>
						</tr>
						</tr>
						<tr>
						<td height="4px" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						Note:  Tracking information may not be available for up to 48 hours after an item is shipped.  Please do not reply to this email as it is delivered from an unmonitored address. '
						
						IF @company = 'KATOM' SET @body1 = @body1+'If you need further assistance, please <a href="http://www.katom.com/trackmyorder.php">click here</a> for help.'
						
						SET @body1 = @body1+'</td>
						</tr>
						</table>
						</body>
						</html>'
					
			print @subject1
			
				
			IF @subject1 <> 'X' and @body1 <> ''
				BEGIN
					IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 and @company = 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'First Email sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'katom conf' END
					ELSE IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 and @company <> 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='B&B', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'First Email sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'bb conf' END
					ELSE IF upper(@delivered) = 'TRUE' and @emailupdate = 1 and @company = 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Delivered status Email Sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'katom deliv' END
					ELSE IF upper(@delivered) = 'TRUE' and @emailupdate = 1 and @company <> 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='B&B', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Delivered status Email Sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'katom deliv' END
					ELSE print 'no update'

					Insert trackxref (trackno, result, orderno) values (@trackno, @result, @OuterOrder)

				END
			
			--print @order
			
			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
			@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @carrier, @webadd, @trackURL, @delivereddate,
			@shipdate, @delivered, @emailupdate, @trackingscan, @signby, @company

			END

			CLOSE DemoCursor

			DEALLOCATE DemoCursor
	
	FETCH NEXT FROM OuterEmailCursor INTO @OuterOrder

	END

	CLOSE OuterEmailCursor

	DEALLOCATE OuterEmailCursor

END
GO
/****** Object:  StoredProcedure [dbo].[FedexTrackingEmailerBkp]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[FedexTrackingEmailerBkp] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
/*select [Order No_], [Ship-to name], [Ship-to Address], [Ship-to City], [Ship-to ZIP Code],  TrackingNo, x.[Shipping Agent Code], Carrier, webAddress, [tracking URL]
FROM [KatomDev].[dbo].[invoice_backup] i
join [KatomDev].[dbo].[ship_backup] s
on [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
join shipurl x
on s.[ShippingAgentCode] = x.[Shipping Agent Code]
where [Order No_] <> ''
order by OrderNo desc


select * from shipurl

select * from [KatomDev].[dbo].[invoice_backup]
*/
/*
select top 100 * from [KatomDev].[dbo].[invoice_backup]
where [E-Mail] <> '' and [E-Mail] not in ('N/A', 'NA', '0')
*/

/*Copies information from FS1 DB and Shiptracking DB to WEBSQL db for use*/
exec invoicebackupcopy

/*Begins the loop to pull down and parse payment information*/
	DECLARE @Order varchar(20)
	DECLARE @email varchar(50)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoadd varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @billtoname varchar(30)
	DECLARE @billtoadd varchar(30)
	DECLARE @billtocity varchar(30)
	DECLARE @billtostate varchar(10)
	DECLARE @billtozip varchar(10)
	DECLARE @phone varchar(20)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)
	DECLARE @delivereddate varchar(255)
	DECLARE @shipdate varchar(255)
	DECLARE @delivered varchar(255)
	DECLARE @emailupdate bit
	DECLARE @trackingscan varchar(255)
	DECLARE @signby varchar(255)
	

	DECLARE DemoCursor CURSOR FOR 
	
	select [Order No_], i.[E-mail], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to county], [Ship-to post Code], 
	[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to county], [Sell-to post Code], [phone No_],
			[Tracking Number], x.Carrier, webAddress, [tracking URL]
			,[Delivered Date], [Ship Date], Delivered, emailupdate, [tracking scan], [sign by]
	--select i.[E-Mail]	
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[trackingInfo] s
	on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
	left outer join [KatomDev].[dbo].shipurl x
	on x.[shipping agent code] = s.carrier
	where i.[E-Mail] <> '' and i.[E-Mail] like ('%@%')-- and stopEmailRequest <> 1
	and NOT ([Delivered] = 'True' and emailUpdate = 0)
	--and [tracking number] not in (select trackno from shipxref)
	and [Shortcut Dimension 2 Code] = 'KATOM'
	and katomorderid <> ''
	and emailupdate = 1
	and datediff(d, getdate(), [ship date]) > -14
	--or katomorderid = '927884'
--	group by i.[E-mail]
	--order by [Order No_] desc

	OPEN DemoCursor

	FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
	@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @trackno, @carrier, @webadd, @trackURL, @delivereddate,
	@shipdate, @delivered, @emailupdate, @trackingscan, @signby

	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	
			print @Order
			print @email
			SET @email1 = @email
			IF @delivered = 'FALSE' and @emailupdate = 1 SET @subject1 = 'KaTom.com Order #'+@order+' Shipment Notification'	
			IF @delivered = 'TRUE' and @emailupdate = 1 SET @subject1 = 'KaTom.com Order #'+@order+' Delivery Notification'	
			ELSE BEGIN SET @subject1 = 'X' END

			SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
							"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
							<html xmlns="http://www.w3.org/1999/xhtml">
							<head>
							<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
							<title>E-Mail</title>

							<style type="text/css">
							html{font-family:Lucida Grande;}
							</style>

							</head>
							<body>
							<a href="http://www.katom.com">
							<img width="194" height="60" title="KaTom Restaurant Supply Inc." alt="KaTom Restaurant Supply Inc." src="http://www.katom.com/Merchant2/css/sterile/seasonallogo.gif" border="0"><br />
							<span style="
							font-family:Arial;
							font-size:11px;
							font-variant:small-caps;
							font-weight:400;
							left:4px;
							letter-spacing:2px;
							margin:0;
							padding:0 0 0 1px;
							position:relative;
							top:-1px;
							text-decoration:underline
							">
							RESTAURANT SUPPLY, INC.
							</span>
							</a>
							<table border="0" width="632" style="font-family:Lucida Grande; font-weight:100; background:#585757;color:#fff;" cellpadding="2">
							<tr>
							<td width="10px;"></td>
							<td colspan="2">
							<br />'
	
	IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">ON ITS WAY...</span>'
	IF @delivered = 'TRUE' and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">CONGRATULATIONS...</span>'
	
			SET @body1 = @body1+'</td>
				</tr>
				<tr>
				<td width="10px;"></td>
				<td>'
				
	IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 SET @body1 = @body1+'			
				<span style="color:#e9ba20; font-size:30px; font-weight:600px">Good news &mdash; your package has shipped.</span>
				<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package from <a href="http://www.katom.com" style="color:#FFF">Katom Restaurant Supply</a> is on its way.  Here''s your shipping confirmation:</p>'

	IF @delivered = 'TRUE' and @emailupdate = 1 SET @body1 = @body1+'			
				<span style="color:#e9ba20; font-size:18px; font-weight:600px">The carrier has indicated that your package has been delivered.</span>'
	
	IF (@signby <> 'N/A' and @signby is not null)  SET @body1 = @body1+'			
				<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package was signed for by: '+@signby+'</p>'
				
			SET @body1 = @body1+'
				</td>
				</tr>
				<tr>
				<td width="10px;"></td>
				<td colspan="2"><span style="color:#e9ba20;
				font-family:lucida grande;
				font-weight:600;">ORDER NUMBER.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+@order+'</span></td>
				</tr>
				<tr>
				<td width="10px;"></td>
				<td colspan="2"><span style="color:#e9ba20;
				font-family:lucida grande;
				font-weight:600;">SHIPPING DATE.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+convert(varchar,datepart(mm,@shipdate)) + '.' + convert(varchar,datepart(dd,@shipdate)) + '.' + convert(varchar,datepart(yyyy,@shipdate))+'</span></td>
				</tr>
				<tr>
				<td width="10px;"></td>
				<td colspan="2"><span style="color:#e9ba20;
				font-family:lucida grande;
				font-weight:600;">TRACKING NUMBER.</span> <a href="'+REPLACE(@trackurl, '<%trackingNum%>', @trackno)+'" style="color:#FFF">'+@trackno+'</a>
				<br />
				<br />
				</td>
				</tr>
				</table>
				<table cellspacing="0">
				<tr height="8">
				<td>
				</td>
				</tr>
				<table>
				<tr>
				<td height="4px">
				</td>
				</tr>
				</table>
				</table>
				<table width="625" style="border-color:#000; border-style:solid; border-width:1px;">
				<tr>
				<td>
				<table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
				<tr>
				<td width="9px" style="background:#999; font-weight:600; color:#666">
				</td>
				<td colspan="2" style="background:#999; font-weight:600; color:#666; font-size:14px">
				ORDER INFORMATION
				</td>
				</tr>
				<tr>
				<td height="9px">
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td style="font-size:12px; font-weight:600">
				BILLING INFORMATION:
				</td>
				<td style="font-size:12px; font-weight:600">
				SHIPPING INFORMATION:
				</td>
				</tr>
				<tr>
				<td width="9px"></td>
				<td>
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
				<tr><td>'+@billtoname+'</td></tr>
				<tr><td>'+@billtoadd+'</td></tr>
				<tr><td>'+@billtocity+', '+@billtostate+' '+@billtozip+'</td></tr>
				<tr><td>Primary Phone: '+@phone+'</td></tr>
				<tr><td>Email: '+@email+'</td></tr>
				</table>
				</td>
				<td valign="top">
				<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
				<tr><td>'+@shiptoname+'</td></tr>
				<tr><td>'+@shiptoadd+'</td></tr>
				<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
				</table>
				</td>
				</tr>
				</table>
				</td>
				</tr>
				</tr>
				<tr>
				<td height="4px" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
				Note:  Tracking information may not be available for up to 48 hours after an item is shipped.  Please do not reply to this email as it is delivered from an unmonitored address.  If you need further assistance, please <a href="http://www.katom.com/trackmyorder.php">click here</a> for help.
				</td>
				</tr>
				</table>
				</body>
				</html>'
			
			
	IF @subject1 <> 'X' 
		BEGIN
			IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	Update trackingInfo set emailUpdate = 0 where [Tracking Number] = @trackno	PRINT 'First Email sent' END
			IF upper(@delivered) = 'TRUE' and @emailupdate = 1 BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com'	Update trackingInfo set emailUpdate = 0 where [Tracking Number] = @trackno	PRINT 'Delivered status Email Sent' END
			ELSE print 'no update'
		END
	
	--print @order
	
	FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
	@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @trackno, @carrier, @webadd, @trackURL, @delivereddate,
	@shipdate, @delivered, @emailupdate, @trackingscan, @signby

	END

	CLOSE DemoCursor

	DEALLOCATE DemoCursor

/*Reset
select * from shipxref where trackno = '053260560918289 '
delete from shipxref where id = 15628
*/
END
GO
/****** Object:  StoredProcedure [dbo].[FedexTrackingEmailer]    Script Date: 02/13/2013 14:41:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[FedexTrackingEmailer] 
	-- Updated 11/16 - moved update for emailupdate flag into the email loop
AS
BEGIN

SET NOCOUNT ON;

-- Insert statements for procedure here
/*select [Order No_], [Ship-to name], [Ship-to Address], [Ship-to City], [Ship-to ZIP Code],  TrackingNo, x.[Shipping Agent Code], Carrier, webAddress, [tracking URL]
FROM [KatomDev].[dbo].[invoice_backup] i
join [KatomDev].[dbo].[ship_backup] s
on [Order No_] COLLATE Latin1_General_CI_AS = [OrderNo] COLLATE Latin1_General_CI_AS
join shipurl x
on s.[ShippingAgentCode] = x.[Shipping Agent Code]
where [Order No_] <> ''
order by OrderNo desc*/


/*Copies information from FS1 DB and Shiptracking DB to WEBSQL db for use*/
exec invoicebackupcopy
------------------------------------------------------------------------------------------*/
/*Begins the loop to pull down and parse payment information*/
	DECLARE @OuterOrder varchar(50)
	DECLARE @Order varchar(50)
	DECLARE @email varchar(50)
	DECLARE @shiptoname varchar(30)
	DECLARE @shiptoadd varchar(30)
	DECLARE @shiptocity varchar(30)
	DECLARE @shiptostate varchar(10)
	DECLARE @shiptozip varchar(10)
	DECLARE @billtoname varchar(30)
	DECLARE @billtoadd varchar(30)
	DECLARE @billtocity varchar(30)
	DECLARE @billtostate varchar(10)
	DECLARE @billtozip varchar(10)
	DECLARE @phone varchar(20)
	DECLARE @trackno varchar(50)
	DECLARE @carrier varchar(50)
	DECLARE @webadd varchar(100)
	DECLARE @trackurl varchar(200)
	DECLARE @subject1 varchar(100)
	DECLARE @email1 varchar(500)
	DECLARE @body1 varchar(8000)
	DECLARE @delivereddate varchar(255)
	DECLARE @shipdate varchar(255)
	DECLARE @delivered varchar(255)
	DECLARE @emailupdate bit
	DECLARE @trackingscan varchar(255)
	DECLARE @signby varchar(255)
	DECLARE @company varchar(255)
	DECLARE @webnum varchar(255)
	DECLARE @result varchar(255)
	DECLARE @subjectorder varchar(255)

	
	DECLARE OuterEmailCursor CURSOR FOR
	
	select top 100 [Order No_]
	FROM [KatomDev].[dbo].[invoice_backup] i
	join [KatomDev].[dbo].[trackingInfo] s
	on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
	left outer join [KatomDev].[dbo].shipurl x
	on x.[shipping agent code] = s.carrier
	where i.[E-Mail] <> '' and i.[E-Mail] like ('%@%')
	and NOT ([Delivered] = 'True' and emailUpdate = 0)
	and katomorderid <> ''
	and emailupdate = 1
	and datediff(d, getdate(), [ship date]) > -14
	and [Bill-to Name] not like 'FROSTY ACRES%'
	and [Sell-to Customer No_] not in ('12557','29909','79517','165938','240089')
	group by [Order No_]
	order by [Order No_] desc
	
	OPEN OuterEmailCursor
	
	FETCH NEXT FROM OuterEmailCursor INTO @OuterOrder

	WHILE @@FETCH_STATUS = 0
	BEGIN

			DECLARE DemoCursor CURSOR FOR 
			
			select top 1 [Order No_], i.[E-mail], [Ship-to name], [Ship-to Address], [Ship-to City], [ship-to county], [Ship-to post Code], 
			[Sell-to customer name], [Sell-to Address], [Sell-to City], [sell-to county], [Sell-to post Code], [phone No_], 
			x.Carrier, webAddress, [tracking URL], [Delivered Date], [Ship Date], Delivered, 
			emailupdate, [tracking scan], [sign by], [Shortcut Dimension 2 Code], [webOrderID]
				--select i.[E-Mail]	
			FROM [KatomDev].[dbo].[invoice_backup] i
			join [KatomDev].[dbo].[trackingInfo] s
			on katomorderid COLLATE Latin1_General_CI_AS = [Order No_] COLLATE Latin1_General_CI_AS
			left outer join [KatomDev].[dbo].shipurl x
			on x.[shipping agent code] = s.carrier
			where [Order No_] = @OuterOrder
			--in ('963453', '963245', '963240', '963236', '963233')
			order by [Order No_] desc

			OPEN DemoCursor

			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
			@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @carrier, @webadd, @trackURL, @delivereddate,
			@shipdate, @delivered, @emailupdate, @trackingscan, @signby, @company, @webnum

			WHILE @@FETCH_STATUS = 0
			BEGIN
			
			
					print @Order
					print @email
					SET @email1 = @email
					SET @subjectorder = @Order
					IF @webnum <> '' AND @webnum <> 'NA' SET @subjectorder = @webnum
					IF @delivered = 'FALSE' BEGIN SET @subject1 = 'Order #'+@subjectorder+' Shipment Notification'	END
					ELSE IF @delivered = 'TRUE' BEGIN SET @subject1 = 'Order #'+@subjectorder+' Delivery Notification'	END
					ELSE IF @delivered is null BEGIN SET @subject1 = 'Order #'+@subjectorder+' Tracking Notification'	END
					ELSE BEGIN SET @subject1 = 'X' END
					print @delivered+' '+cast(@emailupdate as varchar(1))+' = '+@subject1
					
					SET @body1='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
									"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
									<html xmlns="http://www.w3.org/1999/xhtml">
									<head>
									<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
									<title>E-Mail</title>

									<style type="text/css">
									html{font-family:Lucida Grande;}
									</style>

									</head>
									<body>'
					IF @company = 'KATOM' 
							BEGIN 
								SET @body1=@body1+'<a href="http://www.katom.com">
									<img width="194" height="60" title="KaTom Restaurant Supply Inc." alt="KaTom Restaurant Supply Inc." src="https://www.katom.com/bimages/katom.png" border="0"><br />
									<span style="
									font-family:Arial;
									font-size:11px;
									font-variant:small-caps;
									font-weight:400;
									left:4px;
									letter-spacing:2px;
									margin:0;
									padding:0 0 0 1px;
									position:relative;
									top:-1px;
									text-decoration:underline
									">
									RESTAURANT SUPPLY, INC.
									</span>
									</a>' 
									
							END
					SET @body1=@body1+'<table border="0" width="632" style="font-family:Lucida Grande; font-weight:100; background:#585757;color:#fff;" cellpadding="2">
									<tr>
									<td width="10px;"></td>
									<td colspan="2">
									<br />'
			
			IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">ON ITS WAY...</span>'
			IF @delivered = 'TRUE' and @emailupdate = 1 SET @body1 = @body1+'<span style="font-size:72px; color:#959595;">CONGRATULATIONS...</span>'
			
					SET @body1 = @body1+'</td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td>'
						
			IF (@delivered = 'FALSE' or @delivered is null) and @emailupdate = 1 and @company = 'KATOM' SET @body1 = @body1+'			
						<span style="color:#e9ba20; font-size:30px; font-weight:600px">Good news &mdash; your package has shipped.</span>
						<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package from <a href="http://www.katom.com" style="color:#FFF">Katom Restaurant Supply</a> is on its way.  Here''s your shipping confirmation:</p>'

			IF @delivered = 'TRUE' and @emailupdate = 1 and @company = 'KATOM' SET @body1 = @body1+'			
						<span style="color:#e9ba20; font-size:18px; font-weight:600px">The carrier has indicated that your package has been delivered.</span>'
			
			IF (@signby <> 'N/A' and @signby is not null) and @company = 'KATOM' SET @body1 = @body1+'			
						<p style="color:#fff; font-size:10px; font-weight:100; font-family:verdana;">Your package was signed for by: '+@signby+'</p>'
						
					SET @body1 = @body1+'
						</td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td colspan="2"><span style="color:#e9ba20;
						font-family:lucida grande;
						font-weight:600;">ORDER NUMBER.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+@order+'</span></td>
						</tr>
						<tr>
						<td width="10px;"></td>
						<td colspan="2"><span style="color:#e9ba20;
						font-family:lucida grande;
						font-weight:600;">SHIPPING DATE.</span> <span style="color:#fff; font-size:12px; font-weight:100; font-family:verdana;">'+convert(varchar,datepart(mm,@shipdate)) + '.' + convert(varchar,datepart(dd,@shipdate)) + '.' + convert(varchar,datepart(yyyy,@shipdate))+'</span></td>
						</tr>'
						
							DECLARE TrackingCursor CURSOR FOR
							
							select [Tracking Number], [tracking url] from trackingInfo i
							left outer join [KatomDev].[dbo].shipurl x
							on x.[shipping agent code] = i.carrier
							where KatomOrderID = @order		
							OPEN TrackingCursor
							
							FETCH NEXT FROM TrackingCursor INTO @trackno, @trackURL

							WHILE @@FETCH_STATUS = 0
							BEGIN
							
							print @order+'-'+@trackno
								
							SET @body1 = @body1+'<tr>
								<td width="10px;"></td>
								<td colspan="2"><span style="color:#e9ba20;
								font-family:lucida grande;
								font-weight:600;">TRACKING NUMBER.</span> <a href="'+REPLACE(@trackurl, '<%trackingNum%>', @trackno)+'" style="color:#FFF">'+@trackno+'</a>
								</td>
								</tr>'
								
							--IF @subject1 <> 'X' Update trackingInfo set emailUpdate = 0 where [Tracking Number] = @trackno

							FETCH NEXT FROM TrackingCursor INTO @trackno, @trackurl

							END

							CLOSE TrackingCursor

							DEALLOCATE TrackingCursor
						
						
						
					SET @body1 = @body1+'</table>
						<table cellspacing="0">
						<tr height="8">
						<td>
						</td>
						</tr>
						<table>
						<tr>
						<td height="4px">
						</td>
						</tr>
						</table>
						</table>
						<table width="625" style="border-color:#000; border-style:solid; border-width:1px;">
						<tr>
						<td>
						<table width="625" border="0" cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr>
						<td width="9px" style="background:#999; font-weight:600; color:#666">
						</td>
						<td colspan="2" style="background:#999; font-weight:600; color:#666; font-size:14px">
						ORDER INFORMATION
						</td>
						</tr>
						<tr>
						<td height="9px">
						</td>
						</tr>
						<tr>
						<td width="9px"></td>
						<td style="font-size:12px; font-weight:600">
						BILLING INFORMATION:
						</td>
						<td style="font-size:12px; font-weight:600">
						SHIPPING INFORMATION:
						</td>
						</tr>
						<tr>
						<td width="9px"></td>
						<td>
						<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr><td>'+@billtoname+'</td></tr>
						<tr><td>'+@billtoadd+'</td></tr>
						<tr><td>'+@billtocity+', '+@billtostate+' '+@billtozip+'</td></tr>
						<tr><td>Primary Phone: '+@phone+'</td></tr>
						<tr><td>Email: '+@email+'</td></tr>
						</table>
						</td>
						<td valign="top">
						<table cellpadding="0" cellspacing="0" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						<tr><td>'+@shiptoname+'</td></tr>
						<tr><td>'+@shiptoadd+'</td></tr>
						<tr><td>'+@shiptocity+', '+@shiptostate+' '+@shiptozip+'</td></tr>
						</table>
						</td>
						</tr>
						</table>
						</td>
						</tr>
						</tr>
						<tr>
						<td height="4px" style="font-family:Verdana, Geneva, sans-serif; font-size:10px">
						Note:  Tracking information may not be available for up to 48 hours after an item is shipped.  Please do not reply to this email as it is delivered from an unmonitored address. '
						
						IF @company = 'KATOM' SET @body1 = @body1+'If you need further assistance, please <a href="http://www.katom.com/trackmyorder.php">click here</a> for help.'
						
						SET @body1 = @body1+'</td>
						</tr>
						</table>
						</body>
						</html>'
					
			print @subject1
			
				
			IF @subject1 <> 'X' and @body1 <> ''
				BEGIN
					IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 and @company = 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'First Email sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'katom conf' END
					ELSE IF (upper(@delivered) = 'FALSE' OR @delivered is null) and @emailupdate = 1 and @company <> 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='B&B', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'First Email sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'bb conf' END
					ELSE IF upper(@delivered) = 'TRUE' and @emailupdate = 1 and @company = 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='katom', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Delivered status Email Sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'katom deliv' END
					ELSE IF upper(@delivered) = 'TRUE' and @emailupdate = 1 and @company <> 'KATOM' BEGIN EXEC msdb.dbo.sp_send_dbmail @profile_name='B&B', @recipients=@email1,	@subject=@subject1,	@body=@body1, @body_format ='HTML',	@blind_copy_recipients='katom.archive@gmail.com' PRINT 'Delivered status Email Sent' Update trackingInfo set emailUpdate = 0 where KatomOrderID = @Order SET @result = 'katom deliv' END
					ELSE print 'no update'

					Insert trackxref (trackno, result, orderno) values (@trackno, @result, @OuterOrder)

				END
			
			--print @order
			
			FETCH NEXT FROM DemoCursor INTO @Order, @email, @shiptoname, @shiptoadd, @shiptocity, @shiptostate, @shiptozip,
			@billtoname, @billtoadd, @billtocity, @billtostate, @billtozip, @phone, @carrier, @webadd, @trackURL, @delivereddate,
			@shipdate, @delivered, @emailupdate, @trackingscan, @signby, @company, @webnum

			END

			CLOSE DemoCursor

			DEALLOCATE DemoCursor
	
	FETCH NEXT FROM OuterEmailCursor INTO @OuterOrder

	END

	CLOSE OuterEmailCursor

	DEALLOCATE OuterEmailCursor

END
GO
/****** Object:  StoredProcedure [dbo].[category_catxprod]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[category_catxprod]
AS
BEGIN
	TRUNCATE TABLE categoryWorktable
	
	INSERT INTO categoryWorktable(tCatName, tCode, tActive)
	SELECT CASE 
			WHEN c.[Description] IS NULL THEN 'DL-' + LOWER(ic.[Category Code])
			ELSE c.[Description]
		   END, ic.[Item No_], 
		   ic.[Primary Category]
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Category Code] c ON c.Code = ic.[Category Code]
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[No_] = ic.[Item No_]
	WHERE [Blocked] = 0
	UNION
	SELECT CASE 
			WHEN c.[Description] IS NULL THEN 'DL-' + LOWER(ic.[Category Code])
			ELSE c.[Description]
		   END, ic.[Item No_], 
		   ic.[Primary Category]
	FROM fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item Category Codes] ic
		LEFT JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Category Code] c ON c.Code = ic.[Category Code]
		JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Item] i ON i.[No_] = ic.[Item No_]
		JOIN products p on p.CODE = i.[No_] COLLATE Latin1_General_CS_AS
	WHERE p.qtyOnHand > 0

	UPDATE c
	SET c.tCatName = cc.[Description]
	FROM categoryWorktable c JOIN fs1.katom2009.dbo.[B&B Equipment & Supply Inc_$Category Codes] cc 
				ON LOWER(REPLACE(c.tCatName, 'DL-', '')) = LOWER(cc.Code) COLLATE Latin1_General_CS_AS
	WHERE LEFT(tCatName, 3) = 'DL-'

	UPDATE categoryWorktable 
	SET tCatName = REPLACE(tCatName, 'DL-', '')
	WHERE LEFT(tCatName, 3) = 'DL-'

	--DELETING ALL CATEGORIZATION FOR ALL NON ACTIVE CATEGORY
	DELETE FROM categoryWorktable
	WHERE tCatName NOT IN (SELECT code FROM categories WHERE ACTIVE = 1)

	--DELETING ALL CATEGORIZATION FOR ALL NON ACTIVE PRODUCTS
	DELETE FROM categoryWorktable
	WHERE tCode NOT IN (SELECT code FROM products)
	
	--REMOVE DUPLICATE CATEGORIZATION WHERE PRIMARYCAT FLAG SUPERSEDE ALL
	DECLARE @catName VARCHAR(1000), @prodCode VARCHAR(1000), @tID INT
	
	DECLARE cCursor CURSOR FOR  	
	SELECT tCatName, tCode
	FROM categoryWorktable
	GROUP BY tCatName, tCode
	HAVING COUNT(*) > 1
		
	OPEN cCursor
	FETCH NEXT FROM cCursor INTO @catName, @prodCode

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @tID = ''
		
		SELECT TOP 1 @tID = tID
		FROM categoryWorktable
		WHERE tCatName = @catName AND tCode = @prodCode 
		ORDER BY tActive DESC
		
		DELETE FROM categoryWorktable
		WHERE tCatName = @catName AND tCode = @prodCode AND tID <> @tID

		FETCH NEXT FROM cCursor INTO @catName, @prodCode
	   END

	CLOSE cCursor
	DEALLOCATE cCursor
	

	--DELETING ALL CATEGORIZATION FROM CATXPROD TABLE IF IT DOESNT EXIST IN NAV	
	DELETE cx
	FROM categoryWorktable cw RIGHT JOIN catxProd cx ON cw.tCatName = cx.catCode AND cw.tCode = cx.prodCode
	WHERE cw.tCatName IS NULL AND nav = 1
	
	--UPDATING PRIMARYCAT FLAG
	/**
	UPDATE cx
	SET cx.primaryCat = cw.tActive	
	FROM categoryWorktable cw JOIN catxProd cx ON cw.tCatName = cx.catCode AND cw.tCode = cx.prodCode
	WHERE cx.primaryCat <> cw.tActive AND nav = 1
	**/
	
	--DELETING ALL MATCHING RECORD BETWEEN CATEGORYWORKATBLE AND CATXPROD	
	DELETE cw
	FROM categoryWorktable cw JOIN catxProd cx ON cw.tCatName = cx.catCode AND cw.tCode = cx.prodCode
	
	--INSERTING NEW CATEGORIZATION INTO CATXPROD
	INSERT INTO catxProd(catCode, prodCode, primaryCat, nav)
	SELECT tCatName, tCode, tActive, 1 FROM categoryWorktable
	
	TRUNCATE TABLE categoryWorktable
	
	--HOLIDAY CATEGORIZATION
	--EXEC dbo.[category_holiday]
	
	--CATEGORIZATION OUTSIDE OF NAV
	EXEC [dbo].[category_catxprod_supplement]	
	
	--ADDING VENDOR CATEGORIZATION AT THE VENDOR LEVEL IF THEY ARE NOT CATEGORIZED
	EXEC [dbo].[category_catxprod_vendor]	
	
	--CATEGORIZATION FOR SALES AND NAFED PRODUCTS
	EXEC [dbo].[category_catxprod_sales]
	
	UPDATE cx
	SET cx.catID = c.id
	FROM catxProd cx JOIN categories c ON cx.catCode = c.CODE

	UPDATE cx
	SET cx.prodID = p.prodid
	FROM catxProd cx JOIN products p ON cx.prodCode = p.code
	
	--DELETE ALL CATEGORIZATION TO NONE ENDLEAF	
	DELETE FROM catxprod
	WHERE catCode IN (SELECT code FROM categories WHERE endleaf = 0)
	
	--CATXPROD CLEAN UP. 
	--1. REMOVING DUP ENTRY 
	--2. REASSIGNED PRIMARYCAT DESIGNATION IF PRIMARYCAT = 0 AND THERE IS ONLY 1 ENTRY
	EXEC dbo.[category_catxprod_cleanUp]
	
	--SETTING PRIMARY 
	UPDATE products SET primaryCatCode = NULL, primaryCatID = NULL

	UPDATE p 
	SET p.primaryCatCode = cp.catCode, p.primaryCatID = cp.catID
	FROM catxprod cp JOIN products p ON cp.prodCode = p.CODE
	WHERE cp.primarycat = 1
	
END
GO
/****** Object:  StoredProcedure [dbo].[categories2_SP]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories2_SP]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('CAT_UPD', GETDATE())
	SET @jobID = @@identity
	
	--DELETE ALL CATEGORIES WHERE IT DOESNT EXIST IN MIVA CAT TABLE
	--DELETE FROM categories WHERE CODE NOT IN (SELECT CODE FROM mivaCategories)

	--INACTIVATE ALL INACTIVE categories
	--UPDATE categories
	--SET active = 0
	--WHERE code NOT IN (SELECT code FROM mivacategories WHERE active = 1)
	--	AND active = 1
		
	--UPDATE c
	--SET c.active = m.active, c.updateinfo = 1
	--FROM categories c JOIN mivacategories m ON c.CODE = m.code
	--WHERE c.active <> m.active
	--	AND c.primaryCat = 1

	--INSERTING NEW categories
	--INSERT INTO categories(id, parent_id, code, catname, active, catOrder, updateinfo, primaryCat)
	--SELECT id, parent_id, code, [name], 1, disp_order, 1, 1
	--FROM mivacategories
	--WHERE code NOT IN (SELECT code FROM categories)
	--	AND active = 1

	--UPDATING CATID
	--UPDATE c
	--SET c.id = cm.id, c.updateinfo = 1
	--FROM categories c JOIN mivacategories cm ON c.code = cm.code
	--WHERE cm.active = 1 and c.id <> cm.id
	--	AND c.primaryCat = 1

	--UPDATING CATNAME
	--UPDATE c
	--SET c.catName = cm.Name, c.updateinfo = 1
	--FROM categories c JOIN mivacategories cm ON c.code = cm.code
	--WHERE cm.active = 1 and c.catName <> cm.Name
	--	AND c.primaryCat = 1

	--UPDATING DISPLAY ORDER
	--UPDATE c
	--SET c.catOrder = cm.disp_order, c.updateinfo = 1
	--FROM categories c JOIN mivacategories cm ON c.code = cm.code
	--WHERE cm.active = 1 and isnull(c.catOrder, -1) <> cm.disp_order
	--	AND c.primaryCat = 1

	--UPDATING PARENT ID
	--UPDATE c
	--SET c.PARENT_ID = cm.parent_id, c.updateinfo = 1
	--FROM categories c JOIN mivacategories cm ON c.code = cm.code
	--WHERE c.PARENT_ID <> cm.parent_id AND c.primaryCat = 1
	
	--RESET ALL COLUMNS
	UPDATE categories SET breadcrumb = null, supercat = null, endleaf = 0, sliBreadcrumb = null, URL = NULL, vendor = 0
			
	--CREATING VIRTUAL CAT INSTANCES...TO REVISE ONCE MIVA GOES AWAY
	--EXEC dbo.categoryVirtual_SP
	
	--CLEANING UP DUPLICATE CAT INSTANCES
	EXEC dbo.categoryDuplicateCleanup_SP
	
	--DELETE ALL CATEGORIES WHERE ID & PARENT_ID IS NOT IN MIVA TABLE
	--DELETE categories WHERE ID NOT IN (SELECT ID FROM mivaCategories)
	--DELETE categories WHERE PARENT_ID NOT IN (SELECT ID FROM categories) AND PARENT_ID > 0
	
	--DETERMINING BREADCRUMB, SUPERCAT, ENDLEAF, VENDOR	
	DECLARE @id INT, @endLeaf BIT

	SET @endLeaf = 0

	--IDENTIFYING ENDLEAF
	DECLARE catCursor CURSOR FOR 
	SELECT m.ID
	FROM categories m
	WHERE m.ACTIVE = 1 and m.id <> 99999
	ORDER BY id asc

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @ID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF EXISTS(SELECT * FROM categories WHERE PARENT_ID = @ID and ACTIVE = 1)
		   BEGIN
			SET @endLeaf = 0
		   END
		ELSE
		   BEGIN
			SET @endLeaf = 1
		   END
		   
		UPDATE categories
		SET endleaf = @endLeaf
		WHERE ID = @id
		
		FETCH NEXT FROM catCursor INTO @ID
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	--DETERMINING SUPERCAT, VENDOR
	EXEC dbo.[categories_SuperCat]
		   
	UPDATE categories SET vendor = 1 WHERE superCatID = 5844
	
	--SETTING URL LINK   
	UPDATE categories
	SET url =
		CASE
			WHEN ID = 5844 THEN 'http://www.katom.com/brands.A-C.1.html'
			WHEN PARENT_ID = 8788 THEN 'http://www.katom.com/buyer/' + CODE + '.html'
			WHEN endleaf = 1 THEN 'http://restaurant-supplies.katom.com/cat/' + CODE + '.html'
			WHEN PARENT_ID = 5844 THEN 'http://www.katom.com/vendor/' + CODE + '.html'
			ELSE 'http://www.katom.com/cat/' + CODE + '.html'
		END
	WHERE ACTIVE = 1
	
	DECLARE @code VARCHAR(255), @url VARCHAR(1000)

	DECLARE catCursor CURSOR FOR
	SELECT CODE
	FROM categories 
	WHERE ACTIVE = 1
	GROUP BY CODE
	HAVING COUNT(*) > 1

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @code

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @url = NULL
		SELECT @url = URL 
		FROM categories 
		WHERE ACTIVE = 1 AND primaryCat = 1 AND CODE = @code
		
		UPDATE  categories
		SET url = @url
		WHERE CODE = @code

		FETCH NEXT FROM catCursor INTO @code 
	   END
	   
	CLOSE catCursor
	DEALLOCATE catCursor

	--DETERMINING BREADCRUMB
	DECLARE @parentid INT, @catname VARCHAR(2000), @vendor BIT,
		@result VARCHAR(MAX), @sliResult VARCHAR(MAX), @tParentID INT, @tcatname VARCHAR(2000), 
		@tcode VARCHAR(1000), @tActive BIT, @turl VARCHAR(2000), @counter INT

	SET @counter = 0
	SET @tParentID = 0
		
	TRUNCATE TABLE categoryWorktable 

	DECLARE catCursor CURSOR FOR 
	SELECT ID, PARENT_ID, CODE, CATNAME, url
	FROM categories
	WHERE ACTIVE = 1 and id <> 99999 and primarycat = 1
	ORDER BY id asc

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @ID, @parentid, @code, @catName, @url

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @result = '<div class="breadcrumb"><a href="http://www.katom.com">Katom</a>'
		SET @sliResult = '<div class="breadcrumb"><a href="http://www.katom.com">Katom</a>'
		
		IF @parentID > 0 
		   BEGIN
			INSERT INTO categoryWorktable VALUES(@counter, @catName, @code, 1, @url)
			SET @tParentID = @parentID		

			WHILE @tParentID > 0 
			   BEGIN
				IF EXISTS(SELECT parent_ID FROM categories WHERE ID = @tParentID AND ACTIVE = 1)
				   BEGIN
					SET @counter = @counter + 1
					
					SELECT @tParentID = parent_ID, @tCatName = catName, @tCode = code, @tActive = ACTIVE, @turl = url 
					FROM categories WHERE ID = @tParentID AND ACTIVE = 1 AND primaryCat = 1					
					
					INSERT INTO categoryWorktable VALUES(@counter, @tCatName, @tCode, @tActive, @turl)
				   END
				ELSE
				   BEGIN
					SET @tParentID = 0
				   END				
			   END
		
			IF @tParentID = 0 
			   BEGIN			
				DECLARE bread_cursor CURSOR FOR
				SELECT tCatName, tCode, tURL FROM categoryWorktable WHERE tActive = 1 ORDER BY tCounter desc

				OPEN bread_cursor
				FETCH NEXT FROM bread_cursor INTO @tCatName, @tCode, @tURL

				WHILE @@FETCH_STATUS = 0
				   BEGIN									
					IF @tCode <> @code
					   BEGIN
						SET @result = @result + 
								CASE 
									WHEN @tCatName = 'Shop By Vendor' THEN '&nbsp;>&nbsp;<a href="brands.A-C.1.html">'
									ELSE '&nbsp;>&nbsp;<a href="' + REPLACE(@turl, 'http://www.katom.com/', '') + '">' 
								END + @tCatName + '</a>'
						SET @sliResult = @sliResult + 
								CASE 
									WHEN @tCatName = 'Shop By Vendor' THEN '&nbsp;>&nbsp;<a href="http://www.katom.com/brands.A-C.1.html">'
									ELSE '&nbsp;>&nbsp;<a href="' + @turl + '">' 
								END + @tCatName + '</a>'					
					   END
					ELSE
					   BEGIN
						SET @result = @result + '&nbsp;>&nbsp;<h2>' + @tCatName + '</h2></div>'
						SET @sliResult = @sliResult + '&nbsp;>&nbsp;<h2>' + @tCatName + '</h2></div>'
					   END
					FETCH NEXT FROM bread_cursor INTO @tCatName, @tCode, @tURL
				   END

				CLOSE bread_cursor
				DEALLOCATE bread_cursor
	        
				SET @counter = 0
				TRUNCATE TABLE categoryWorktable
			   END
		   END
		ELSE
		   BEGIN
			SET @result = @result + '&nbsp;>&nbsp;<h2>' + @catName + '</h2></div>'
			SET @sliResult = @sliResult + '&nbsp;>&nbsp;<h2>' + @catName + '</h2></div>'
			SET @url = 'http://www.katom.com/cat/'  + @tCode + '.html'
		   END
		
		UPDATE categories
		SET breadcrumb = @result, 
			sliBreadcrumb = @sliResult, 
			updateinfo = 0
		WHERE ID = @ID  	

		FETCH NEXT FROM catCursor INTO @ID, @parentid, @code, @catName, @url  
	   END
	   
	CLOSE catCursor
	DEALLOCATE catCursor	   
	
	--DETERMINING SISTER categories
	DECLARE @sisterCat VARCHAR(MAX), @sisterCatID VARCHAR(MAX)
	
	UPDATE categories SET sisterCat = null, sisterCatID = null

	DECLARE pCursor CURSOR FOR 
	SELECT parent_ID
	FROM categories
	WHERE ACTIVE = 1 AND PARENT_ID > 0
	GROUP BY PARENT_ID
	HAVING COUNT(*) > 1
	
	OPEN pCursor
	FETCH NEXT FROM pCursor INTO @parentID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		
		SET @sisterCat = ''
		SET @sisterCatID = ''
			   
		DECLARE dCursor CURSOR FOR 
		SELECT code, catName
		FROM categories
		WHERE active = 1 AND parent_ID = @parentID AND primaryCat = 1
		ORDER BY ID
		
		OPEN dCursor
		FETCH NEXT FROM dCursor INTO @code, @catName

		WHILE @@FETCH_STATUS = 0
		   BEGIN
		   
			IF LEN(@sisterCat) > 0 
			   BEGIN
				SET @sisterCat = @sisterCat + '|' + @catName
				SET @sisterCatID = @sisterCatID + '|' + @code
			   END
			ELSE 
			   BEGIN
				SET @sisterCat = @catName
				SET @sisterCatID = @code
			   END
			
			FETCH NEXT FROM dCursor INTO @code, @catName
		   END
		   
		UPDATE categories
		SET sisterCat = @sisterCat,
			sisterCatID = @sisterCatID
		WHERE PARENT_ID = @parentID
		
		CLOSE dCursor
		DEALLOCATE dCursor
		   
		FETCH NEXT FROM pCursor INTO @parentID
	   END

	CLOSE pCursor
	DEALLOCATE pCursor		
	
	--CLEAN UP BREADCRUMB URL FOR VENDORS
	DECLARE @replacingURL varchar(1000)

	SET @URL = ''
	SET @replacingURL = ''

	DECLARE catCursor CURSOR FOR 
	SELECT url 
	FROM categories 
	WHERE PARENT_ID = 5844 and active = 1 and CHARINDEX('restaurant-supplies.katom.com', url) = 0

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @url

	WHILE @@FETCH_STATUS = 0
	   BEGIN
	   
		SET @replacingURL = REPLACE(@url, '/vendor/', '/cat/')
		
		UPDATE categories
		SET breadcrumb = REPLACE(breadcrumb, REPLACE(@replacingURL, 'http://www.katom.com/', ''), REPLACE(@url, 'http://www.katom.com/', '')),
				slibreadcrumb = REPLACE(slibreadcrumb, @replacingURL, @url)
		WHERE PARENT_ID <> 5844 and active = 1 and vendor = 1
		
		FETCH NEXT FROM catCursor INTO @url
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	--CLEAN UP BREADCRUMB URL FOR SPECIAL CAT
	UPDATE categories
	SET url = 'http://www.katom.com/site/' + CODE + '.html'
	WHERE CODE in ('restaurant-equipment-leasing','demos-restaurant-buying-guide','patricia-chili-recipe',
					'WHICHFRYER','lodge-hotsellers','kitchenAid-hotsellers','anchor-hocking-hotsellers',
					'waring-hotsellers','star-hotsellers','john-boos-hotsellers','staub-recipes-dinner-idea')

	UPDATE categories
	SET url = 'http://www.katom.com/help/CATALOG.html'
	WHERE CODE = 'x-catalogrequest'

	UPDATE categories
	SET breadcrumb = REPLACE(breadcrumb, '&nbsp;>&nbsp;<a href="cat/HDN.html">Special</a>', ''),
		slibreadcrumb = REPLACE(slibreadcrumb, '&nbsp;>&nbsp;<a href="cat/HDN.html">Special</a>', '')
		
	EXEC [dbo].[category_catxprod]
	
	--COUNT THE NUMBER OF PRODUCTS PER CATEGORY
	EXEC dbo.[categories_numProd]
		
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

END
GO
/****** Object:  StoredProcedure [dbo].[categories_SP]    Script Date: 02/13/2013 14:41:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[categories_SP]
AS
BEGIN
	DECLARE @jobID INT
	INSERT INTO jobHistory(jobName, startdT) values('CAT_UPD', GETDATE())
	SET @jobID = @@identity
	--RESET ALL COLUMNS
	UPDATE categories SET breadcrumb = null, supercat = null, endleaf = 0, sliBreadcrumb = null, URL = NULL, vendor = 0
	
	--CLEANING UP DUPLICATE CAT INSTANCES
	EXEC dbo.categoryDuplicateCleanup_SP
	
	--DETERMINING BREADCRUMB, SUPERCAT, ENDLEAF, VENDOR	
	DECLARE @id INT, @endLeaf BIT

	SET @endLeaf = 0

	--IDENTIFYING ENDLEAF
	DECLARE catCursor CURSOR FOR 
	SELECT m.ID
	FROM categories m
	WHERE m.ACTIVE = 1 and m.id <> 99999
	ORDER BY id asc

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @ID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		IF EXISTS(SELECT id FROM categories WHERE PARENT_ID = @ID and ACTIVE = 1)
		   BEGIN
			SET @endLeaf = 0
		   END
		ELSE
		   BEGIN
			SET @endLeaf = 1
		   END
		   
		UPDATE categories
		SET endleaf = @endLeaf
		WHERE ID = @id
		
		FETCH NEXT FROM catCursor INTO @ID
	   END

	CLOSE catCursor
	DEALLOCATE catCursor

	--DETERMINING SUPERCAT, VENDOR
	EXEC dbo.[categories_SuperCat]
		   
	UPDATE categories SET vendor = 1 WHERE superCatID = 5844
	
	--SETTING URL LINK   
	UPDATE categories
	SET url =
		CASE
			WHEN endleaf = 1 THEN 'http://restaurant-supplies.katom.com/cat/' + CODE + '.html'
			WHEN ID = 5844 THEN 'http://www.katom.com/brands.A-C.1.html'
			WHEN PARENT_ID = 5844 THEN 'http://www.katom.com/vendor/' + CODE + '.html'
			ELSE 'http://www.katom.com/cat/' + CODE + '.html'
		END
	WHERE ACTIVE = 1
	
	DECLARE @code VARCHAR(255), @url VARCHAR(1000)

	DECLARE catCursor CURSOR FOR
	SELECT CODE
	FROM categories 
	WHERE ACTIVE = 1
	GROUP BY CODE
	HAVING COUNT(*) > 1

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @code

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @url = NULL
		SELECT @url = URL 
		FROM categories 
		WHERE ACTIVE = 1 AND primaryCat = 1 AND CODE = @code
		
		UPDATE  categories
		SET url = @url
		WHERE CODE = @code

		FETCH NEXT FROM catCursor INTO @code 
	   END
	   
	CLOSE catCursor
	DEALLOCATE catCursor

	--DETERMINING BREADCRUMB
	DECLARE @parentid INT, @catname VARCHAR(2000), @vendor BIT,
		@result VARCHAR(MAX), @sliResult VARCHAR(MAX), @tParentID INT, @tcatname VARCHAR(2000), 
		@tcode VARCHAR(1000), @tActive BIT, @turl VARCHAR(2000), @counter INT

	SET @counter = 0
	SET @tParentID = 0
		
	TRUNCATE TABLE categoryWorktable 

	DECLARE catCursor CURSOR FOR 
	SELECT ID, PARENT_ID, CODE, CATNAME, url
	FROM categories
	WHERE ACTIVE = 1 and id <> 99999 and primarycat = 1
	ORDER BY id asc

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @ID, @parentid, @code, @catName, @url

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SET @result =    ''
		SET @sliResult = '<div class="breadcrumb"><a href="http://www.katom.com" title="KaTom Restaurant Supply">KaTom Restaurant Supply</a>'
		
		IF @parentID > 0 
		   BEGIN
			INSERT INTO categoryWorktable VALUES(@counter, @catName, @code, 1, @url, null)
			SET @tParentID = @parentID		

			WHILE @tParentID > 0 
			   BEGIN
				IF EXISTS(SELECT parent_ID FROM categories WHERE ID = @tParentID AND ACTIVE = 1)
				   BEGIN
					SET @counter = @counter + 1
					
					SELECT @tParentID = parent_ID, @tCatName = catName, @tCode = code, @tActive = ACTIVE, @turl = url 
					FROM categories WHERE ID = @tParentID AND ACTIVE = 1 AND primaryCat = 1					
					
					INSERT INTO categoryWorktable VALUES(@counter, @tCatName, @tCode, @tActive, @turl, null)
				   END
				ELSE
				   BEGIN
					SET @tParentID = 0
				   END				
			   END
		
			IF @tParentID = 0 
			   BEGIN			
				DECLARE bread_cursor CURSOR FOR
				SELECT tCatName, tCode, tURL FROM categoryWorktable WHERE tActive = 1 ORDER BY tCounter desc

				OPEN bread_cursor
				FETCH NEXT FROM bread_cursor INTO @tCatName, @tCode, @tURL

				WHILE @@FETCH_STATUS = 0
				   BEGIN									
					IF @tCode <> @code
					   BEGIN
						SET @result = @result + 
							CASE 
								WHEN LEN(@result) > 0 THEN ' > ' 
								ELSE ''
							END + @tCatName
						SET @sliResult = @sliResult + 
								CASE 
									WHEN @tCatName = 'Shop By Vendor' THEN '&nbsp;>&nbsp;<a href="http://www.katom.com/brands.A-C.1.html" title="Shop By Vendor">'
									ELSE '&nbsp;>&nbsp;<a href="' + @turl + '" title="' + @tCatName + '">'  
								END + @tCatName + '</a>'					
					   END
					ELSE
					   BEGIN
						SET @result = @result + 
							CASE 
								WHEN LEN(@result) > 0 THEN ' > ' 
								ELSE ''
							END + @tCatName
						SET @sliResult = @sliResult + '&nbsp;>&nbsp;<strong>' + @tCatName + '</strong></div>'
					   END
					FETCH NEXT FROM bread_cursor INTO @tCatName, @tCode, @tURL
				   END

				CLOSE bread_cursor
				DEALLOCATE bread_cursor
	        
				SET @counter = 0
				TRUNCATE TABLE categoryWorktable
			   END
		   END
		ELSE
		   BEGIN
			SET @result = @result + 
				CASE 
					WHEN LEN(@result) > 0 THEN ' > ' 
					ELSE ''
				END + @tCatName
			SET @sliResult = @sliResult + '&nbsp;>&nbsp;<strong>' + @catName + '</strong></div>'
			SET @url = 'http://www.katom.com/cat/'  + @tCode + '.html'
		   END
		
		UPDATE categories
		SET breadcrumb = @result, 
			sliBreadcrumb = @sliResult, 
			updateinfo = 0
		WHERE ID = @ID  	

		FETCH NEXT FROM catCursor INTO @ID, @parentid, @code, @catName, @url  
	   END
	   
	CLOSE catCursor
	DEALLOCATE catCursor	   
	
	--DETERMINING SISTER categories
	DECLARE @sisterCat VARCHAR(MAX), @sisterCatID VARCHAR(MAX)
	
	UPDATE categories SET sisterCat = null, sisterCatID = null

	DECLARE pCursor CURSOR FOR 
	SELECT parent_ID
	FROM categories
	WHERE ACTIVE = 1 AND PARENT_ID > 0
	GROUP BY PARENT_ID
	HAVING COUNT(*) > 1
	
	OPEN pCursor
	FETCH NEXT FROM pCursor INTO @parentID

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		
		SET @sisterCat = ''
		SET @sisterCatID = ''
			   
		DECLARE dCursor CURSOR FOR 
		SELECT code, catName
		FROM categories
		WHERE active = 1 AND parent_ID = @parentID AND primaryCat = 1
		ORDER BY ID
		
		OPEN dCursor
		FETCH NEXT FROM dCursor INTO @code, @catName

		WHILE @@FETCH_STATUS = 0
		   BEGIN
		   
			IF LEN(@sisterCat) > 0 
			   BEGIN
				SET @sisterCat = @sisterCat + '|' + @catName
				SET @sisterCatID = @sisterCatID + '|' + @code
			   END
			ELSE 
			   BEGIN
				SET @sisterCat = @catName
				SET @sisterCatID = @code
			   END
			
			FETCH NEXT FROM dCursor INTO @code, @catName
		   END
		   
		UPDATE categories
		SET sisterCat = @sisterCat,
			sisterCatID = @sisterCatID
		WHERE PARENT_ID = @parentID
		
		CLOSE dCursor
		DEALLOCATE dCursor
		   
		FETCH NEXT FROM pCursor INTO @parentID
	   END

	CLOSE pCursor
	DEALLOCATE pCursor		
	
	--CLEAN UP BREADCRUMB URL FOR VENDORS
	DECLARE @replacingURL varchar(1000)

	SET @URL = ''
	SET @replacingURL = ''

	DECLARE catCursor CURSOR FOR 
	SELECT url 
	FROM categories 
	WHERE PARENT_ID = 5844 and active = 1 and CHARINDEX('restaurant-supplies.katom.com', url) = 0

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @url

	WHILE @@FETCH_STATUS = 0
	   BEGIN
	   
		SET @replacingURL = REPLACE(@url, '/vendor/', '/cat/')
		
		UPDATE categories
		SET breadcrumb = REPLACE(breadcrumb, REPLACE(@replacingURL, 'http://www.katom.com/', ''), REPLACE(@url, 'http://www.katom.com/', '')),
				slibreadcrumb = REPLACE(slibreadcrumb, @replacingURL, @url)
		WHERE PARENT_ID <> 5844 and active = 1 and vendor = 1
		
		FETCH NEXT FROM catCursor INTO @url
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
	
	UPDATE categories
	SET breadcrumb = REPLACE(breadcrumb, '&nbsp;>&nbsp;<a href="cat/HDN.html" title="special">Special</a>', ''),
		slibreadcrumb = REPLACE(slibreadcrumb, '&nbsp;>&nbsp;<a href="cat/HDN.html" title="special">Special</a>', '')
		
	EXEC [dbo].[category_catxprod]
	
	--INSERT PRODUCT TO SPECIAL HOLIDAY CATEGORIES...JUST FOR THE HOLIDAY.  TURN OFF ON 12/31/2011
	EXEC [dbo].[category_holiday]	
	
	--CATEGORIZING PRODUCTS UNDER THEIR ASSOCIATED VENDOR CATEGORY IF THEY ARE NO CHILDREN 
	--CATEGORIES ASSIGNED TO THE MAIN PARENT
	--EXEC [dbo].[category_categorized_uncat_vendor_products]
	
	--ASSIGNING FEATURED PRODUCTS
	EXEC dbo.[category_featuredProducts]
	
	UPDATE categories SET url = REPLACE(url, '/cat/', '/holiday/') WHERE PARENT_ID = 10836
	
	UPDATE categories 
	SET breadcrumb = REPLACE(breadcrumb, '&nbsp;>&nbsp;<a href="holiday/holiday.html" title="Holiday">Holiday</a>', '') 
	WHERE superCatID = 10836 
	
	UPDATE categories 
	SET slibreadcrumb = REPLACE(slibreadcrumb, '&nbsp;>&nbsp;<a href="http://www.katom.com/cat/holiday.html" title="Holiday">Holiday</a>', '') 
		WHERE superCatID = 10836
				
	--CALCULATING SALES FOR 30 AND 60 DAYS
	DECLARE @sales30 DECIMAL(10, 2), @sales3060 DECIMAL(10, 2)

	TRUNCATE TABLE prodTemp

	UPDATE categories SET sales30 = 0, sales3060 = 0

	INSERT INTO prodTemp(Keywords, [UnitPrice])
	SELECT p.primaryCatCode,
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2))	
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p on p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
	WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) < 31
		AND ih.[Source Code] = 'SALES'
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY p.primaryCatCode
		
	UPDATE c
	SET c.sales30 = t.[UnitPrice]
	FROM categories c JOIN prodTemp t on c.CODE = t.Keywords

	INSERT INTO prodTemp(Keywords, [UnitPrice])
	SELECT p.primaryCatCode,
		CAST(SUM(ISNULL(il.[Quantity], 0)*ISNULL(il.[Unit Price], 0)) as decimal(10, 2))	
	FROM fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Header] ih
		JOIN fs1.KaTom2009.dbo.[B&B Equipment & Supply Inc_$Sales Invoice Line] il
			ON ih.[No_]  = il.[Document No_]
		JOIN products p on p.CODE = il.[No_] COLLATE Latin1_General_CS_AS
	WHERE DATEDIFF(DAY, ih.[Posting Date], GETDATE()) between 31 and 60
		AND ih.[Source Code] = 'SALES'
		AND ih.[Customer Source] = 'I'
		AND il.[No_] NOT IN ('420', '100-FREIGHT', '100-TAXES', '100-SHIPPING')
	GROUP BY p.primaryCatCode
		
	UPDATE c
	SET c.sales3060 = t.[UnitPrice]
	FROM categories c JOIN prodTemp t on c.CODE = t.Keywords

	DECLARE catCursor CURSOR FOR 
	SELECT ID FROM categories WHERE ACTIVE = 1 AND sales30 = 0 AND endleaf = 0 order by parent_id desc, id desc

	OPEN catCursor
	FETCH NEXT FROM catCursor INTO @id

	WHILE @@FETCH_STATUS = 0
	   BEGIN
		SELECT @sales30 = sum(isnull(sales30, 0)), 
			   @sales3060 = sum(isnull(sales3060, 0))
		FROM categories 
		WHERE PARENT_ID = @id
		
		UPDATE categories SET sales30 = @sales30, sales3060 = @sales3060 WHERE ID = @id

		FETCH NEXT FROM catCursor INTO @id
	   END

	CLOSE catCursor
	DEALLOCATE catCursor
		
	--ASSIGNING MFGID FOR ALL CAT WHERE PARENT_ID = 5844 (SHOP BY VENDOR)
	UPDATE c
	SET c.mfgid = m.mfgid
	FROM categories c JOIN mfg m ON c.CATNAME = m.mfgName
	WHERE c.mfgID IS NULL			
	
	--Bandaid - added 10/11/12 by MS
	UPDATE categories
	SET vendor = 0
	WHERE vendor = 1 AND parent_id <> 5844
	
	UPDATE jobHistory SET endDT = GETDATE() WHERE jobID = @jobID

END
GO
